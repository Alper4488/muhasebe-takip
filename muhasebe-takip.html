<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muhasebe Takip Sistemi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --border: #e5e7eb;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .tabs {
            display: flex;
            background: var(--dark);
            border-bottom: 3px solid var(--primary);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 18px 20px;
            background: var(--dark);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 150px;
        }

        .tab:hover {
            background: #374151;
        }

        .tab.active {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-info {
            background: var(--info);
            color: var(--white);
        }

        .card {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .card h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: var(--primary);
            color: var(--white);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
        }

        tbody tr:hover {
            background: var(--light);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .stat-card h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .amount {
            font-size: 2em;
            font-weight: 700;
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .invoice-items {
            margin-top: 20px;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            background: var(--light);
        }

        .invoice-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--success);
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid var(--info);
        }

        .filters {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }

            .invoice-item {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                min-width: 100%;
            }
        }

        .company-selector {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .badge-success {
            background: var(--success);
            color: var(--white);
        }

        .badge-danger {
            background: var(--danger);
            color: var(--white);
        }

        .export-section {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üíº Muhasebe Takip Sistemi</h1>
            <p>Profesyonel Fatura ve Cari Hesap Y√∂netimi</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('companies')">üè¢ Firmalar</button>
            <button class="tab" onclick="showTab('accounts')">üë• Cari Hesaplar</button>
            <button class="tab" onclick="showTab('invoices')">üìÑ Faturalar</button>
            <button class="tab" onclick="showTab('reports')">üìà Raporlar</button>
            <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Ayarlar</button>
        </div>

        <div class="content">
            <!-- DASHBOARD TAB -->
            <div id="dashboard" class="tab-content active">
                <div class="company-selector">
                    <label>Aktif Firma:</label>
                    <select id="activeCompanySelect" onchange="changeActiveCompany()">
                        <option value="">Firma Se√ßiniz</option>
                    </select>
                </div>

                <div class="grid-3">
                    <div class="stat-card success">
                        <h4>Toplam Gelir</h4>
                        <div class="amount" id="totalIncome">0.00 ‚Ç∫</div>
                    </div>
                    <div class="stat-card danger">
                        <h4>Toplam Gider</h4>
                        <div class="amount" id="totalExpense">0.00 ‚Ç∫</div>
                    </div>
                    <div class="stat-card">
                        <h4>Net Kar/Zarar</h4>
                        <div class="amount" id="netProfit">0.00 ‚Ç∫</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="stat-card warning">
                        <h4>√ñdenecek KDV</h4>
                        <div class="amount" id="totalVAT">0.00 ‚Ç∫</div>
                    </div>
                    <div class="stat-card info" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                        <h4>Tahmini Kurumlar Vergisi (%20)</h4>
                        <div class="amount" id="corporateTax">0.00 ‚Ç∫</div>
                    </div>
                </div>

                <div class="card">
                    <h3>Son Faturalar</h3>
                    <table id="recentInvoices">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Fatura No</th>
                                <th>Cari</th>
                                <th>T√ºr</th>
                                <th>Tutar</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- COMPANIES TAB -->
            <div id="companies" class="tab-content">
                <div class="card">
                    <h3>Yeni Firma Ekle</h3>
                    <form id="companyForm">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Firma √únvanƒ± *</label>
                                <input type="text" id="companyName" required>
                            </div>
                            <div class="form-group">
                                <label>Vergi Numarasƒ± *</label>
                                <input type="text" id="companyTaxNo" required>
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Vergi Dairesi</label>
                                <input type="text" id="companyTaxOffice">
                            </div>
                            <div class="form-group">
                                <label>Telefon</label>
                                <input type="tel" id="companyPhone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Adres</label>
                            <textarea id="companyAddress" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">üíæ Firma Kaydet</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Kayƒ±tlƒ± Firmalar</h3>
                    <table id="companiesTable">
                        <thead>
                            <tr>
                                <th>√únvan</th>
                                <th>Vergi No</th>
                                <th>Vergi Dairesi</th>
                                <th>Telefon</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- ACCOUNTS TAB -->
            <div id="accounts" class="tab-content">
                <div class="card">
                    <h3>Yeni Cari Hesap Ekle</h3>
                    <form id="accountForm">
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Cari Adƒ± *</label>
                                <input type="text" id="accountName" required>
                            </div>
                            <div class="form-group">
                                <label>T√ºr *</label>
                                <select id="accountType" required>
                                    <option value="">Se√ßiniz</option>
                                    <option value="customer">M√º≈üteri</option>
                                    <option value="supplier">Tedarik√ßi</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>Vergi/TC No</label>
                                <input type="text" id="accountTaxNo">
                            </div>
                            <div class="form-group">
                                <label>Telefon</label>
                                <input type="tel" id="accountPhone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Adres</label>
                            <textarea id="accountAddress" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">üíæ Cari Kaydet</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Cari Hesaplar</h3>
                    <table id="accountsTable">
                        <thead>
                            <tr>
                                <th>Cari Adƒ±</th>
                                <th>T√ºr</th>
                                <th>Telefon</th>
                                <th>Bakiye</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- INVOICES TAB -->
            <div id="invoices" class="tab-content">
                <div class="card">
                    <h3>Yeni Fatura Ekle</h3>
                    <form id="invoiceForm">
                        <div class="grid-3">
                            <div class="form-group">
                                <label>Fatura T√ºr√º *</label>
                                <select id="invoiceType" required>
                                    <option value="">Se√ßiniz</option>
                                    <option value="sales">Satƒ±≈ü Faturasƒ±</option>
                                    <option value="purchase">Alƒ±≈ü Faturasƒ±</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Fatura No *</label>
                                <input type="text" id="invoiceNo" required>
                            </div>
                            <div class="form-group">
                                <label>Tarih *</label>
                                <input type="date" id="invoiceDate" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Cari Hesap *</label>
                            <select id="invoiceAccount" required>
                                <option value="">Se√ßiniz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>A√ßƒ±klama</label>
                            <textarea id="invoiceDescription" rows="2"></textarea>
                        </div>

                        <div class="invoice-items">
                            <h4 style="margin-bottom:15px;">Fatura Kalemleri</h4>
                            <div id="invoiceItemsList"></div>
                            <button type="button" class="btn btn-success" onclick="addInvoiceItem()">‚ûï Kalem Ekle</button>
                        </div>

                        <div class="grid-3" style="margin-top: 20px;">
                            <div class="stat-card">
                                <h4>Ara Toplam</h4>
                                <div class="amount" id="invoiceSubtotal">0.00 ‚Ç∫</div>
                            </div>
                            <div class="stat-card warning">
                                <h4>KDV</h4>
                                <div class="amount" id="invoiceVAT">0.00 ‚Ç∫</div>
                            </div>
                            <div class="stat-card success">
                                <h4>Genel Toplam</h4>
                                <div class="amount" id="invoiceTotal">0.00 ‚Ç∫</div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" style="margin-top: 20px;">üíæ Fatura Kaydet</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Fatura Listesi</h3>
                    <div class="filters">
                        <div class="grid-3">
                            <div class="form-group">
                                <label>Ba≈ülangƒ±√ß Tarihi</label>
                                <input type="date" id="filterStartDate">
                            </div>
                            <div class="form-group">
                                <label>Biti≈ü Tarihi</label>
                                <input type="date" id="filterEndDate">
                            </div>
                            <div class="form-group">
                                <label>Fatura T√ºr√º</label>
                                <select id="filterType">
                                    <option value="">T√ºm√º</option>
                                    <option value="sales">Satƒ±≈ü</option>
                                    <option value="purchase">Alƒ±≈ü</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-info" onclick="filterInvoices()">üîç Filtrele</button>
                        <button class="btn btn-warning" onclick="clearFilters()">üîÑ Filtreleri Temizle</button>
                    </div>
                    <table id="invoicesTable">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Fatura No</th>
                                <th>T√ºr</th>
                                <th>Cari</th>
                                <th>A√ßƒ±klama</th>
                                <th>Ara Toplam</th>
                                <th>KDV</th>
                                <th>Toplam</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTS TAB -->
            <div id="reports" class="tab-content">
                <div class="card">
                    <h3>Rapor Parametreleri</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Yƒ±l</label>
                            <select id="reportYear">
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ay</label>
                            <select id="reportMonth">
                                <option value="">T√ºm Yƒ±l</option>
                                <option value="01">Ocak</option>
                                <option value="02">≈ûubat</option>
                                <option value="03">Mart</option>
                                <option value="04">Nisan</option>
                                <option value="05">Mayƒ±s</option>
                                <option value="06">Haziran</option>
                                <option value="07">Temmuz</option>
                                <option value="08">Aƒüustos</option>
                                <option value="09">Eyl√ºl</option>
                                <option value="10">Ekim</option>
                                <option value="11">Kasƒ±m</option>
                                <option value="12">Aralƒ±k</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="generateReport()">üìä Rapor Olu≈ütur</button>
                        </div>
                    </div>
                </div>

                <div id="reportResults"></div>

                <div class="card">
                    <h3>Cari Ekstre</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Cari Se√ßiniz</label>
                            <select id="statementAccount">
                                <option value="">Se√ßiniz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ba≈ülangƒ±√ß Tarihi</label>
                            <input type="date" id="statementStartDate">
                        </div>
                        <div class="form-group">
                            <label>Biti≈ü Tarihi</label>
                            <input type="date" id="statementEndDate">
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="generateStatement()">üìã Ekstre G√∂r√ºnt√ºle</button>
                    <div id="statementResults"></div>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div id="settings" class="tab-content">
                <div class="card">
                    <h3>Veri Y√∂netimi</h3>
                    <div class="export-section">
                        <h4>üíæ Yedekleme ve Geri Y√ºkleme</h4>
                        <p>T√ºm verilerinizi yedekleyin veya √∂nceki bir yedekten geri y√ºkleyin.</p>
                        <button class="btn btn-success" onclick="exportData()">üì• Verileri Dƒ±≈üa Aktar (Yedekle)</button>
                        <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">üì§ Verileri ƒ∞√ße Aktar (Geri Y√ºkle)</button>
                        <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
                    </div>
                </div>

                <div class="card">
                    <h3>‚ö†Ô∏è Tehlikeli ƒ∞≈ülemler</h3>
                    <div class="alert alert-info">
                        <strong>Uyarƒ±:</strong> A≈üaƒüƒ±daki i≈ülemler geri alƒ±namaz. Devam etmeden √∂nce verilerinizi yedeklediƒüinizden emin olun.
                    </div>
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è T√ºm Verileri Sil</button>
                </div>

                <div class="card">
                    <h3>‚ÑπÔ∏è Hakkƒ±nda</h3>
                    <p><strong>Muhasebe Takip Sistemi</strong></p>
                    <p>Versiyon: 1.0.0</p>
                    <p>Tek dosya, tam √∂zellikli muhasebe ve fatura takip programƒ±</p>
                    <p>‚úÖ Veriler tarayƒ±cƒ±nƒ±zda LocalStorage'da g√ºvenle saklanƒ±r.</p>
                    <p>‚úÖ ƒ∞nternet baƒülantƒ±sƒ± gerektirmez (offline √ßalƒ±≈üƒ±r)</p>
                    <p>‚úÖ Firebase entegrasyonu i√ßin hazƒ±r</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GLOBAL DATA STORE
        let companies = JSON.parse(localStorage.getItem('companies')) || [];
        let accounts = JSON.parse(localStorage.getItem('accounts')) || [];
        let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
        let activeCompanyId = localStorage.getItem('activeCompanyId') || null;

        // INITIALIZATION
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            document.getElementById('invoiceDate').valueAsDate = new Date();
            
            loadCompanies();
            loadAccounts();
            loadInvoices();
            updateDashboard();
            populateSelects();
            
            addInvoiceItem();
            setupFormHandlers();
        }

        function setupFormHandlers() {
            document.getElementById('companyForm').addEventListener('submit', saveCompany);
            document.getElementById('accountForm').addEventListener('submit', saveAccount);
            document.getElementById('invoiceForm').addEventListener('submit', saveInvoice);
        }

        // TAB NAVIGATION
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // COMPANY FUNCTIONS
        function saveCompany(e) {
            e.preventDefault();
            
            const company = {
                id: Date.now().toString(),
                name: document.getElementById('companyName').value,
                taxNo: document.getElementById('companyTaxNo').value,
                taxOffice: document.getElementById('companyTaxOffice').value,
                phone: document.getElementById('companyPhone').value,
                address: document.getElementById('companyAddress').value,
                createdAt: new Date().toISOString()
            };

            companies.push(company);
            localStorage.setItem('companies', JSON.stringify(companies));
            
            if (!activeCompanyId) {
                activeCompanyId = company.id;
                localStorage.setItem('activeCompanyId', activeCompanyId);
            }

            document.getElementById('companyForm').reset();
            loadCompanies();
            populateSelects();
            updateDashboard();
            
            alert('‚úÖ Firma ba≈üarƒ±yla kaydedildi!');
        }

        function loadCompanies() {
            const tbody = document.querySelector('#companiesTable tbody');
            tbody.innerHTML = '';

            if (companies.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#6b7280;">Hen√ºz firma kaydƒ± yok. Yukarƒ±daki formu kullanarak firma ekleyebilirsiniz.</td></tr>';
                return;
            }

            companies.forEach(company => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${company.name}</strong></td>
                    <td>${company.taxNo}</td>
                    <td>${company.taxOffice || '-'}</td>
                    <td>${company.phone || '-'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteCompany('${company.id}')">üóëÔ∏è Sil</button>
                    </td>
                `;
            });
        }

        function deleteCompany(id) {
            if (confirm('Bu firmayƒ± silmek istediƒüinizden emin misiniz? Bu firmaya ait t√ºm cari hesaplar ve faturalar korunacaktƒ±r.')) {
                companies = companies.filter(c => c.id !== id);
                localStorage.setItem('companies', JSON.stringify(companies));
                
                if (activeCompanyId === id) {
                    activeCompanyId = companies.length > 0 ? companies[0].id : null;
                    localStorage.setItem('activeCompanyId', activeCompanyId);
                }
                
                loadCompanies();
                populateSelects();
                updateDashboard();
                loadAccounts();
                loadInvoices();
            }
        }

        function changeActiveCompany() {
            activeCompanyId = document.getElementById('activeCompanySelect').value;
            localStorage.setItem('activeCompanyId', activeCompanyId);
            updateDashboard();
            loadAccounts();
            loadInvoices();
            populateSelects();
        }

        // ACCOUNT FUNCTIONS
        function saveAccount(e) {
            e.preventDefault();

            if (!activeCompanyId) {
                alert('‚ö†Ô∏è L√ºtfen √∂nce bir firma se√ßin veya olu≈üturun!');
                return;
            }

            const account = {
                id: Date.now().toString(),
                companyId: activeCompanyId,
                name: document.getElementById('accountName').value,
                type: document.getElementById('accountType').value,
                taxNo: document.getElementById('accountTaxNo').value,
                phone: document.getElementById('accountPhone').value,
                address: document.getElementById('accountAddress').value,
                balance: 0,
                createdAt: new Date().toISOString()
            };

            accounts.push(account);
            localStorage.setItem('accounts', JSON.stringify(accounts));

            document.getElementById('accountForm').reset();
            loadAccounts();
            populateSelects();
            
            alert('‚úÖ Cari hesap ba≈üarƒ±yla kaydedildi!');
        }

        function loadAccounts() {
            const tbody = document.querySelector('#accountsTable tbody');
            tbody.innerHTML = '';

            const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);

            if (companyAccounts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#6b7280;">Hen√ºz cari hesap kaydƒ± yok. Yukarƒ±daki formu kullanarak cari hesap ekleyebilirsiniz.</td></tr>';
                return;
            }

            companyAccounts.forEach(account => {
                const row = tbody.insertRow();
                const typeText = account.type === 'customer' ? 'M√º≈üteri' : 'Tedarik√ßi';
                const balanceClass = account.balance >= 0 ? 'success' : 'danger';
                
                row.innerHTML = `
                    <td><strong>${account.name}</strong></td>
                    <td><span class="badge badge-${account.type === 'customer' ? 'success' : 'danger'}">${typeText}</span></td>
                    <td>${account.phone || '-'}</td>
                    <td style="color: var(--${balanceClass}); font-weight: 600; font-size:1.1em;">${formatCurrency(account.balance)}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteAccount('${account.id}')">üóëÔ∏è Sil</button>
                    </td>
                `;
            });
        }

        function deleteAccount(id) {
            const relatedInvoices = invoices.filter(inv => inv.accountId === id);
            if (relatedInvoices.length > 0) {
                if (!confirm(`Bu cari hesaba ait ${relatedInvoices.length} adet fatura bulunmaktadƒ±r. Yine de silmek istiyor musunuz?`)) {
                    return;
                }
            }

            accounts = accounts.filter(a => a.id !== id);
            localStorage.setItem('accounts', JSON.stringify(accounts));
            loadAccounts();
            populateSelects();
        }

        // INVOICE FUNCTIONS
        let invoiceItems = [];

        function addInvoiceItem() {
            const item = {
                id: Date.now() + Math.random(),
                description: '',
                quantity: 1,
                unitPrice: 0,
                vatRate: 20,
                amount: 0,
                vatAmount: 0
            };

            invoiceItems.push(item);
            renderInvoiceItems();
        }

        function renderInvoiceItems() {
            const container = document.getElementById('invoiceItemsList');
            container.innerHTML = '';

            invoiceItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'invoice-item';
                div.innerHTML = `
                    <div class="form-group">
                        <label>A√ßƒ±klama</label>
                        <input type="text" value="${item.description}" onchange="updateInvoiceItem(${index}, 'description', this.value)" required>
                    </div>
                    <div class="form-group">
                        <label>Miktar</label>
                        <input type="number" value="${item.quantity}" onchange="updateInvoiceItem(${index}, 'quantity', this.value)" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Birim Fiyat (‚Ç∫)</label>
                        <input type="number" value="${item.unitPrice}" onchange="updateInvoiceItem(${index}, 'unitPrice', this.value)" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>KDV %</label>
                        <select onchange="updateInvoiceItem(${index}, 'vatRate', this.value)">
                            <option value="0" ${item.vatRate == 0 ? 'selected' : ''}>%0</option>
                            <option value="1" ${item.vatRate == 1 ? 'selected' : ''}>%1</option>
                            <option value="8" ${item.vatRate == 8 ? 'selected' : ''}>%8</option>
                            <option value="10" ${item.vatRate == 10 ? 'selected' : ''}>%10</option>
                            <option value="18" ${item.vatRate == 18 ? 'selected' : ''}>%18</option>
                            <option value="20" ${item.vatRate == 20 ? 'selected' : ''}>%20</option>
                        </select>
                    </div>
                    <div>
                        <button type="button" class="btn btn-danger" onclick="removeInvoiceItem(${index})" ${invoiceItems.length === 1 ? 'disabled' : ''}>üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(div);
            });

            calculateInvoiceTotals();
        }

        function updateInvoiceItem(index, field, value) {
            invoiceItems[index][field] = field === 'description' ? value : parseFloat(value) || 0;
            calculateInvoiceTotals();
        }

        function removeInvoiceItem(index) {
            if (invoiceItems.length === 1) {
                alert('‚ö†Ô∏è En az bir fatura kalemi olmalƒ±dƒ±r!');
                return;
            }
            invoiceItems.splice(index, 1);
            renderInvoiceItems();
        }

        function calculateInvoiceTotals() {
            let subtotal = 0;
            let totalVAT = 0;

            invoiceItems.forEach(item => {
                item.amount = item.quantity * item.unitPrice;
                item.vatAmount = item.amount * (item.vatRate / 100);
                subtotal += item.amount;
                totalVAT += item.vatAmount;
            });

            const total = subtotal + totalVAT;

            document.getElementById('invoiceSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('invoiceVAT').textContent = formatCurrency(totalVAT);
            document.getElementById('invoiceTotal').textContent = formatCurrency(total);
        }

        function saveInvoice(e) {
            e.preventDefault();

            if (!activeCompanyId) {
                alert('‚ö†Ô∏è L√ºtfen √∂nce bir firma se√ßin!');
                return;
            }

            if (invoiceItems.length === 0 || !invoiceItems[0].description) {
                alert('‚ö†Ô∏è L√ºtfen en az bir fatura kalemi ekleyin!');
                return;
            }

            const subtotal = invoiceItems.reduce((sum, item) => sum + item.amount, 0);
            const vatAmount = invoiceItems.reduce((sum, item) => sum + item.vatAmount, 0);
            const total = subtotal + vatAmount;

            const invoice = {
                id: Date.now().toString(),
                companyId: activeCompanyId,
                type: document.getElementById('invoiceType').value,
                invoiceNo: document.getElementById('invoiceNo').value,
                date: document.getElementById('invoiceDate').value,
                accountId: document.getElementById('invoiceAccount').value,
                description: document.getElementById('invoiceDescription').value,
                items: JSON.parse(JSON.stringify(invoiceItems)),
                subtotal: subtotal,
                vatAmount: vatAmount,
                total: total,
                createdAt: new Date().toISOString()
            };

            invoices.push(invoice);
            localStorage.setItem('invoices', JSON.stringify(invoices));

            const account = accounts.find(a => a.id === invoice.accountId);
            if (account) {
                if (invoice.type === 'sales') {
                    account.balance += total;
                } else {
                    account.balance -= total;
                }
                localStorage.setItem('accounts', JSON.stringify(accounts));
            }

            document.getElementById('invoiceForm').reset();
            document.getElementById('invoiceDate').valueAsDate = new Date();
            invoiceItems = [];
            addInvoiceItem();
            loadInvoices();
            loadAccounts();
            updateDashboard();
            
            alert('‚úÖ Fatura ba≈üarƒ±yla kaydedildi!');
        }

        function loadInvoices() {
            const tbody = document.querySelector('#invoicesTable tbody');
            tbody.innerHTML = '';

            const companyInvoices = invoices
                .filter(inv => !activeCompanyId || inv.companyId === activeCompanyId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (companyInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px; color:#6b7280;">Hen√ºz fatura kaydƒ± yok.</td></tr>';
                updateRecentInvoices();
                return;
            }

            companyInvoices.forEach(invoice => {
                const account = accounts.find(a => a.id === invoice.accountId);
                const typeText = invoice.type === 'sales' ? 'üìó Satƒ±≈ü' : 'üìï Alƒ±≈ü';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(invoice.date)}</td>
                    <td><strong>${invoice.invoiceNo}</strong></td>
                    <td>${typeText}</td>
                    <td>${account ? account.name : '<span style="color:#ef4444;">Silinmi≈ü</span>'}</td>
                    <td>${invoice.description || '-'}</td>
                    <td>${formatCurrency(invoice.subtotal)}</td>
                    <td>${formatCurrency(invoice.vatAmount)}</td>
                    <td><strong style="font-size:1.1em;">${formatCurrency(invoice.total)}</strong></td>
                    <td>
                        <button class="btn btn-info" onclick="viewInvoice('${invoice.id}')">üëÅÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteInvoice('${invoice.id}')">üóëÔ∏è</button>
                    </td>
                `;
            });

            updateRecentInvoices();
        }

        function viewInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            const account = accounts.find(a => a.id === invoice.accountId);
            const company = companies.find(c => c.id === invoice.companyId);
            const typeText = invoice.type === 'sales' ? 'SATI≈û FATURASI' : 'ALI≈û FATURASI';
            
            let itemsHtml = '<table style="width:100%; margin-top:20px; border-collapse: collapse;"><thead><tr style="background:#2563eb; color:white;"><th style="padding:10px; border:1px solid #ddd;">A√ßƒ±klama</th><th style="padding:10px; border:1px solid #ddd;">Miktar</th><th style="padding:10px; border:1px solid #ddd;">Birim Fiyat</th><th style="padding:10px; border:1px solid #ddd;">KDV %</th><th style="padding:10px; border:1px solid #ddd;">Tutar</th></tr></thead><tbody>';
            
            invoice.items.forEach(item => {
                itemsHtml += `
                    <tr>
                        <td style="padding:10px; border:1px solid #ddd;">${item.description}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:center;">${item.quantity}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right;">${formatCurrency(item.unitPrice)}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:center;">%${item.vatRate}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right;"><strong>${formatCurrency(item.amount + item.vatAmount)}</strong></td>
                    </tr>
                `;
            });
            
            itemsHtml += '</tbody></table>';

            const content = `
                <div style="max-width: 900px; margin: 0 auto;">
                    <h2 style="color:#2563eb; border-bottom:3px solid #2563eb; padding-bottom:10px; margin-bottom:20px;">${typeText}</h2>
                    <div style="margin: 20px 0; padding: 20px; background: #f3f4f6; border-radius: 8px;">
                        <p style="margin:5px 0;"><strong>Firma:</strong> ${company ? company.name : '-'}</p>
                        <p style="margin:5px 0;"><strong>Fatura No:</strong> ${invoice.invoiceNo}</p>
                        <p style="margin:5px 0;"><strong>Tarih:</strong> ${formatDate(invoice.date)}</p>
                        <p style="margin:5px 0;"><strong>Cari:</strong> ${account ? account.name : 'Silinmi≈ü'}</p>
                        <p style="margin:5px 0;"><strong>A√ßƒ±klama:</strong> ${invoice.description || '-'}</p>
                    </div>
                    ${itemsHtml}
                    <div style="margin-top:30px; text-align:right; padding:20px; background:#f3f4f6; border-radius:8px;">
                        <p style="font-size:1.1em; margin:5px 0;"><strong>Ara Toplam:</strong> ${formatCurrency(invoice.subtotal)}</p>
                        <p style="font-size:1.1em; margin:5px 0;"><strong>KDV:</strong> ${formatCurrency(invoice.vatAmount)}</p>
                        <hr style="margin:15px 0; border:1px solid #d1d5db;">
                        <p style="font-size:2em; margin:15px 0 0 0; color:#2563eb;"><strong>GENEL TOPLAM:</strong> ${formatCurrency(invoice.total)}</p>
                    </div>
                </div>
            `;

            const win = window.open('', 'Fatura Detayƒ±', 'width=900,height=700');
            win.document.write(`
                <html>
                    <head>
                        <title>Fatura ${invoice.invoiceNo}</title>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: Arial, sans-serif; padding: 40px; background: white; }
                            @media print {
                                button { display: none !important; }
                            }
                        </style>
                    </head>
                    <body>
                        ${content}
                        <div style="text-align:center; margin-top:30px;">
                            <button onclick="window.print()" style="padding:12px 30px; background:#2563eb; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600;">üñ®Ô∏è Yazdƒ±r</button>
                            <button onclick="window.close()" style="padding:12px 30px; background:#6b7280; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; font-weight:600; margin-left:10px;">‚úñÔ∏è Kapat</button>
                        </div>
                    </body>
                </html>
            `);
        }

        function deleteInvoice(id) {
            if (!confirm('Bu faturayƒ± silmek istediƒüinizden emin misiniz?')) {
                return;
            }

            const invoice = invoices.find(inv => inv.id === id);
            
            if (invoice) {
                const account = accounts.find(a => a.id === invoice.accountId);
                if (account) {
                    if (invoice.type === 'sales') {
                        account.balance -= invoice.total;
                    } else {
                        account.balance += invoice.total;
                    }
                    localStorage.setItem('accounts', JSON.stringify(accounts));
                }
            }

            invoices = invoices.filter(inv => inv.id !== id);
            localStorage.setItem('invoices', JSON.stringify(invoices));
            
            loadInvoices();
            loadAccounts();
            updateDashboard();

            alert('‚úÖ Fatura ba≈üarƒ±yla silindi!');
        }

        function filterInvoices() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const type = document.getElementById('filterType').value;

            const tbody = document.querySelector('#invoicesTable tbody');
            tbody.innerHTML = '';

            let filtered = invoices.filter(inv => !activeCompanyId || inv.companyId === activeCompanyId);

            if (startDate) {
                filtered = filtered.filter(inv => inv.date >= startDate);
            }
            if (endDate) {
                filtered = filtered.filter(inv => inv.date <= endDate);
            }
            if (type) {
                filtered = filtered.filter(inv => inv.type === type);
            }

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px; color:#6b7280;">Filtrelere uygun fatura bulunamadƒ±.</td></tr>';
                return;
            }

            filtered.forEach(invoice => {
                const account = accounts.find(a => a.id === invoice.accountId);
                const typeText = invoice.type === 'sales' ? 'üìó Satƒ±≈ü' : 'üìï Alƒ±≈ü';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(invoice.date)}</td>
                    <td><strong>${invoice.invoiceNo}</strong></td>
                    <td>${typeText}</td>
                    <td>${account ? account.name : '<span style="color:#ef4444;">Silinmi≈ü</span>'}</td>
                    <td>${invoice.description || '-'}</td>
                    <td>${formatCurrency(invoice.subtotal)}</td>
                    <td>${formatCurrency(invoice.vatAmount)}</td>
                    <td><strong style="font-size:1.1em;">${formatCurrency(invoice.total)}</strong></td>
                    <td>
                        <button class="btn btn-info" onclick="viewInvoice('${invoice.id}')">üëÅÔ∏è</button>
                        <button class="btn btn-danger" onclick="deleteInvoice('${invoice.id}')">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function clearFilters() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterType').value = '';
            loadInvoices();
        }

        // DASHBOARD FUNCTIONS
        function updateDashboard() {
            const companyInvoices = invoices.filter(inv => !activeCompanyId || inv.companyId === activeCompanyId);

            const salesInvoices = companyInvoices.filter(inv => inv.type === 'sales');
            const purchaseInvoices = companyInvoices.filter(inv => inv.type === 'purchase');

            const totalIncome = salesInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
            const totalExpense = purchaseInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
            const netProfit = totalIncome - totalExpense;

            const salesVAT = salesInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
            const purchaseVAT = purchaseInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
            const totalVAT = salesVAT - purchaseVAT;

            const corporateTax = netProfit > 0 ? netProfit * 0.20 : 0;

            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('netProfit').textContent = formatCurrency(netProfit);
            document.getElementById('totalVAT').textContent = formatCurrency(totalVAT);
            document.getElementById('corporateTax').textContent = formatCurrency(corporateTax);
        }

        function updateRecentInvoices() {
            const tbody = document.querySelector('#recentInvoices tbody');
            tbody.innerHTML = '';

            const recentInvoices = invoices
                .filter(inv => !activeCompanyId || inv.companyId === activeCompanyId)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            if (recentInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#6b7280;">Hen√ºz fatura kaydƒ± yok</td></tr>';
                return;
            }

            recentInvoices.forEach(invoice => {
                const account = accounts.find(a => a.id === invoice.accountId);
                const typeText = invoice.type === 'sales' ? 'üìó Satƒ±≈ü' : 'üìï Alƒ±≈ü';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(invoice.date)}</td>
                    <td><strong>${invoice.invoiceNo}</strong></td>
                    <td>${account ? account.name : '<span style="color:#ef4444;">Silinmi≈ü</span>'}</td>
                    <td>${typeText}</td>
                    <td><strong style="font-size:1.1em;">${formatCurrency(invoice.total)}</strong></td>
                `;
            });
        }

        // REPORTS FUNCTIONS
        function generateReport() {
            const year = document.getElementById('reportYear').value;
            const month = document.getElementById('reportMonth').value;

            const companyInvoices = invoices.filter(inv => {
                if (activeCompanyId && inv.companyId !== activeCompanyId) return false;
                
                const invDate = new Date(inv.date);
                const invYear = invDate.getFullYear().toString();
                const invMonth = (invDate.getMonth() + 1).toString().padStart(2, '0');

                if (invYear !== year) return false;
                if (month && invMonth !== month) return false;

                return true;
            });

            const salesInvoices = companyInvoices.filter(inv => inv.type === 'sales');
            const purchaseInvoices = companyInvoices.filter(inv => inv.type === 'purchase');

            const totalIncome = salesInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
            const totalExpense = purchaseInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
            const netProfit = totalIncome - totalExpense;

            const salesVAT = salesInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
            const purchaseVAT = purchaseInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
            const totalVAT = salesVAT - purchaseVAT;

            const corporateTax = netProfit > 0 ? netProfit * 0.20 : 0;

            const periodText = month ? `${getMonthName(month)} ${year}` : `${year} Yƒ±lƒ±`;

            const html = `
                <div class="card">
                    <h3>üìä ${periodText} D√∂nemi Raporu</h3>
                    
                    <div class="grid-3">
                        <div class="stat-card success">
                            <h4>Satƒ±≈ü Geliri</h4>
                            <div class="amount">${formatCurrency(totalIncome)}</div>
                            <small>${salesInvoices.length} Fatura</small>
                        </div>
                        <div class="stat-card danger">
                            <h4>Alƒ±≈ü Gideri</h4>
                            <div class="amount">${formatCurrency(totalExpense)}</div>
                            <small>${purchaseInvoices.length} Fatura</small>
                        </div>
                        <div class="stat-card">
                            <h4>Net Kar/Zarar</h4>
                            <div class="amount">${formatCurrency(netProfit)}</div>
                        </div>
                    </div>

                    <div class="grid-2" style="margin-top:20px;">
                        <div class="stat-card warning">
                            <h4>Satƒ±≈ü KDV</h4>
                            <div class="amount">${formatCurrency(salesVAT)}</div>
                        </div>
                        <div class="stat-card warning">
                            <h4>Alƒ±≈ü KDV</h4>
                            <div class="amount">${formatCurrency(purchaseVAT)}</div>
                        </div>
                    </div>

                    <div class="grid-2" style="margin-top:20px;">
                        <div class="stat-card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <h4>√ñdenecek KDV</h4>
                            <div class="amount">${formatCurrency(totalVAT)}</div>
                            <small>Satƒ±≈ü KDV - Alƒ±≈ü KDV</small>
                        </div>
                        <div class="stat-card" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">
                            <h4>Tahmini Kurumlar Vergisi (%20)</h4>
                            <div class="amount">${formatCurrency(corporateTax)}</div>
                            <small>Net Kar x %20</small>
                        </div>
                    </div>

                    <div style="margin-top:30px;">
                        <h4>üìã Detaylƒ± Fatura Listesi</h4>
                        ${companyInvoices.length === 0 ? '<p style="text-align:center; padding:20px; color:#6b7280;">Bu d√∂nemde fatura kaydƒ± bulunamadƒ±.</p>' : `
                        <table>
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Fatura No</th>
                                    <th>T√ºr</th>
                                    <th>Cari</th>
                                    <th>Ara Toplam</th>
                                    <th>KDV</th>
                                    <th>Toplam</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${companyInvoices.sort((a, b) => new Date(a.date) - new Date(b.date)).map(inv => {
                                    const account = accounts.find(a => a.id === inv.accountId);
                                    const typeText = inv.type === 'sales' ? 'üìó Satƒ±≈ü' : 'üìï Alƒ±≈ü';
                                    return `
                                        <tr>
                                            <td>${formatDate(inv.date)}</td>
                                            <td><strong>${inv.invoiceNo}</strong></td>
                                            <td>${typeText}</td>
                                            <td>${account ? account.name : '<span style="color:#ef4444;">Silinmi≈ü</span>'}</td>
                                            <td>${formatCurrency(inv.subtotal)}</td>
                                            <td>${formatCurrency(inv.vatAmount)}</td>
                                            <td><strong>${formatCurrency(inv.total)}</strong></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        `}
                    </div>
                </div>
            `;

            document.getElementById('reportResults').innerHTML = html;
        }

        function generateStatement() {
            const accountId = document.getElementById('statementAccount').value;
            const startDate = document.getElementById('statementStartDate').value;
            const endDate = document.getElementById('statementEndDate').value;

            if (!accountId) {
                alert('‚ö†Ô∏è L√ºtfen bir cari hesap se√ßin!');
                return;
            }

            const account = accounts.find(a => a.id === accountId);
            if (!account) return;

            let accountInvoices = invoices.filter(inv => inv.accountId === accountId);

            if (startDate) {
                accountInvoices = accountInvoices.filter(inv => inv.date >= startDate);
            }
            if (endDate) {
                accountInvoices = accountInvoices.filter(inv => inv.date <= endDate);
            }

            accountInvoices.sort((a, b) => new Date(a.date) - new Date(b.date));

            let balance = 0;
            const rows = accountInvoices.map(inv => {
                const typeText = inv.type === 'sales' ? 'Satƒ±≈ü' : 'Alƒ±≈ü';
                const debit = inv.type === 'sales' ? inv.total : 0;
                const credit = inv.type === 'purchase' ? inv.total : 0;
                balance += (debit - credit);

                return `
                    <tr>
                        <td>${formatDate(inv.date)}</td>
                        <td>${inv.invoiceNo}</td>
                        <td>${typeText}</td>
                        <td>${inv.description || '-'}</td>
                        <td style="color: var(--success); font-weight:600;">${debit > 0 ? formatCurrency(debit) : '-'}</td>
                        <td style="color: var(--danger); font-weight:600;">${credit > 0 ? formatCurrency(credit) : '-'}</td>
                        <td style="font-weight:700;">${formatCurrency(balance)}</td>
                    </tr>
                `;
            }).join('');

            const html = `
                <div style="margin-top:20px;">
                    <h4>üìã ${account.name} - Cari Ekstre</h4>
                    <p><strong>D√∂nem:</strong> ${startDate ? formatDate(startDate) : 'Ba≈ülangƒ±√ß'} - ${endDate ? formatDate(endDate) : 'Bug√ºn'}</p>
                    <p><strong>G√ºncel Bakiye:</strong> <span style="color: ${balance >= 0 ? 'var(--success)' : 'var(--danger)'}; font-size:1.8em; font-weight:700;">${formatCurrency(balance)}</span></p>
                    
                    ${accountInvoices.length === 0 ? '<p style="text-align:center; padding:20px; color:#6b7280;">Bu d√∂nemde i≈ülem bulunamadƒ±.</p>' : `
                    <table>
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Fatura No</th>
                                <th>T√ºr</th>
                                <th>A√ßƒ±klama</th>
                                <th>Bor√ß</th>
                                <th>Alacak</th>
                                <th>Bakiye</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                    `}
                </div>
            `;

            document.getElementById('statementResults').innerHTML = html;
        }

        // DATA MANAGEMENT FUNCTIONS
        function exportData() {
            const data = {
                companies: companies,
                accounts: accounts,
                invoices: invoices,
                activeCompanyId: activeCompanyId,
                exportDate: new Date().toISOString(),
                version: '1.0.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `muhasebe-yedek-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Veriler ba≈üarƒ±yla dƒ±≈üa aktarƒ±ldƒ±!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.companies || !data.accounts || !data.invoices) {
                        alert('‚ö†Ô∏è Ge√ßersiz yedek dosyasƒ±!');
                        return;
                    }

                    if (confirm('‚ö†Ô∏è Mevcut t√ºm veriler silinecek ve yedekten geri y√ºklenecek. Devam etmek istiyor musunuz?')) {
                        companies = data.companies;
                        accounts = data.accounts;
                        invoices = data.invoices;
                        activeCompanyId = data.activeCompanyId;

                        localStorage.setItem('companies', JSON.stringify(companies));
                        localStorage.setItem('accounts', JSON.stringify(accounts));
                        localStorage.setItem('invoices', JSON.stringify(invoices));
                        localStorage.setItem('activeCompanyId', activeCompanyId);

                        initializeApp();
                        
                        alert('‚úÖ Veriler ba≈üarƒ±yla i√ße aktarƒ±ldƒ±!');
                    }
                } catch (error) {
                    alert('‚ùå Dosya okunamadƒ±! L√ºtfen ge√ßerli bir yedek dosyasƒ± se√ßin.');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è T√úM VERƒ∞LER Sƒ∞Lƒ∞NECEK! Bu i≈ülem geri alƒ±namaz. Devam etmek istiyor musunuz?')) {
                return;
            }

            if (!confirm('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è SON UYARI! T√ºm firmalar, cari hesaplar ve faturalar kalƒ±cƒ± olarak silinecek. EMƒ∞N Mƒ∞Sƒ∞Nƒ∞Z?')) {
                return;
            }

            localStorage.removeItem('companies');
            localStorage.removeItem('accounts');
            localStorage.removeItem('invoices');
            localStorage.removeItem('activeCompanyId');

            companies = [];
            accounts = [];
            invoices = [];
            activeCompanyId = null;

            initializeApp();

            alert('‚úÖ T√ºm veriler silindi!');
        }

        // UTILITY FUNCTIONS
        function populateSelects() {
            // Populate active company select
            const activeSelect = document.getElementById('activeCompanySelect');
            activeSelect.innerHTML = '<option value="">Firma Se√ßiniz</option>';
            companies.forEach(company => {
                const option = new Option(company.name, company.id);
                if (company.id === activeCompanyId) option.selected = true;
                activeSelect.add(option);
            });

            // Populate invoice account select
            const invoiceAccountSelect = document.getElementById('invoiceAccount');
            invoiceAccountSelect.innerHTML = '<option value="">Se√ßiniz</option>';
            const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
            companyAccounts.forEach(account => {
                const option = new Option(`${account.name} (${account.type === 'customer' ? 'M√º≈üteri' : 'Tedarik√ßi'})`, account.id);
                invoiceAccountSelect.add(option);
            });

            // Populate statement account select
            const statementAccountSelect = document.getElementById('statementAccount');
            statementAccountSelect.innerHTML = '<option value="">Se√ßiniz</option>';
            companyAccounts.forEach(account => {
                const option = new Option(`${account.name} (${account.type === 'customer' ? 'M√º≈üteri' : 'Tedarik√ßi'})`, account.id);
                statementAccountSelect.add(option);
            });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function getMonthName(month) {
            const months = {
                '01': 'Ocak',
                '02': '≈ûubat',
                '03': 'Mart',
                '04': 'Nisan',
                '05': 'Mayƒ±s',
                '06': 'Haziran',
                '07': 'Temmuz',
                '08': 'Aƒüustos',
                '09': 'Eyl√ºl',
                '10': 'Ekim',
                '11': 'Kasƒ±m',
                '12': 'Aralƒ±k'
            };
            return months[month] || month;
        }
    </script>
</body>
</html>