<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muhasebe Takip Sistemi v2.0</title>

<!-- Firebase SDK'larÄ± -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
<!-- JS KÃœTÃœPHANELERÄ° -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>

<!-- jsPDF ve autoTable CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
<!-- DejaVu font base64 (Ã¶rnek) -->
<script src="https://unpkg.com/jspdf@2.5.1/dist/font/dejavu.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Google API Client Library -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --border: #e5e7eb;
            --purple: #8b5cf6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .version-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: var(--dark);
            border-bottom: 3px solid var(--primary);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 18px 20px;
            background: var(--dark);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 140px;
        }

        .tab:hover {
            background: #374151;
        }

        .tab.active {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .content {
            padding: 30px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-info {
            background: var(--info);
            color: var(--white);
        }

        .btn-info:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: var(--white);
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .card {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .card h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: var(--primary);
            color: var(--white);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        tbody tr:hover {
            background: var(--light);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .stat-card h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .amount {
            font-size: 2em;
            font-weight: 700;
        }

        .stat-card small {
            opacity: 0.8;
            font-size: 0.85em;
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, var(--purple) 0%, #6d28d9 100%);
        }

        .invoice-items {
            margin-top: 20px;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            background: var(--light);
        }

        .invoice-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--success);
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid var(--info);
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--warning);
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--danger);
        }

        .filters {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .company-selector {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: var(--success);
            color: var(--white);
        }

        .badge-danger {
            background: var(--danger);
            color: var(--white);
        }

        .badge-warning {
            background: var(--warning);
            color: var(--white);
        }

        .badge-info {
            background: var(--info);
            color: var(--white);
        }

        .badge-secondary {
            background: #6b7280;
            color: var(--white);
        }

        .export-section {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h3 {
            color: var(--primary);
            margin: 0;
        }

        .close-modal {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }

        .payment-match-item {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .payment-match-item.matched {
            border-color: var(--success);
            background: #d1fae5;
        }

        .payment-match-item.unmatched {
            border-color: var(--warning);
            background: #fef3c7;
        }

        .file-upload-area {
            border: 3px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: var(--light);
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: #dbeafe;
        }

        .file-upload-area.drag-over {
            border-color: var(--success);
            background: #d1fae5;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }

            .invoice-item {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                min-width: 100%;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .version-badge {
                position: static;
                display: block;
                margin-top: 10px;
            }
        }

        .status-paid {
            color: var(--success);
            font-weight: 600;
        }

        .status-partial {
            color: var(--warning);
            font-weight: 600;
        }

        .status-unpaid {
            color: var(--danger);
            font-weight: 600;
        }

        .overdue {
            background: #fee2e2;
            color: var(--danger);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--light);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            transition: width 0.3s;
        }

/* ============================================
   PDF TEMPLATE - TAM DÃœZELTME (Tablo + Metin)
   ============================================ */

/* Ana Sayfa Container */
.pdf-page {
    width: 210mm;
    min-height: auto;
    max-width: 210mm;
    padding: 12mm 15mm;
    margin: 0;
    position: relative;
    background: white;
    page-break-after: always;
    page-break-inside: avoid;
    overflow: visible;
    box-sizing: border-box;
}

/* Son sayfada sayfa atlamayÄ± kaldÄ±r */
.pdf-page:last-child {
    page-break-after: avoid;
}

/* SAYFA Ã–ZEL YÃœKSEKLÄ°KLERÄ° - OPTÄ°MÄ°ZE */
.page-1 {
    min-height: 290mm;  /* âœ… Kapak - azalt */
    padding: 15mm 15mm;
}

.page-2 {
    min-height: 290mm;  /* âœ… Tablo - azalt */
    padding: 12mm 15mm;
}

.page-3, .page-4, .page-5, .page-6 {
    min-height: 290mm;  /* Ä°Ã§erik sayfalarÄ± */
}

/* ============================================
   TABLO STÄ°LLERÄ° - SAYFA Ä°Ã‡Ä°NDE KALSIN
   ============================================ */
/* TABLO STÄ°LLERÄ° - YAZILARI BÃœYÃœT */

.pdf-table {
    width: 100%;
    max-width: 100%;
    border-collapse: collapse;
    font-size: 9px;  /* âœ… 8px'den 9px'e Ã§Ä±kar */
    margin: 10px 0;
    table-layout: fixed;
}

.pdf-table th {
    background: #4472C4;
    color: white;
    border: 1px solid #000;
    padding: 7px 5px;  /* âœ… Padding artÄ±r */
    text-align: left;
    font-weight: bold;
    font-size: 9px;  /* âœ… 8px'den 9px'e Ã§Ä±kar */
    word-wrap: break-word;
}

.pdf-table td {
    border: 1px solid #000;
    padding: 5px 4px;  /* âœ… Padding artÄ±r */
    text-align: left;
    font-size: 9px;  /* âœ… 8px'den 9px'e Ã§Ä±kar */
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* SÃ¼tun geniÅŸlikleri - OPTÄ°MÄ°ZE */
#pdf-parameters-table th:nth-child(1),
#pdf-parameters-table td:nth-child(1) {
    width: 14%;  /* Kaynak AdÄ± */
}

#pdf-parameters-table th:nth-child(2),
#pdf-parameters-table td:nth-child(2) {
    width: 32%;  /* Ã–lÃ§Ã¼m Parametresi - biraz geniÅŸlet */
}

#pdf-parameters-table th:nth-child(3),
#pdf-parameters-table td:nth-child(3) {
    width: 22%;  /* Ã–lÃ§Ã¼m StandardÄ± */
}

#pdf-parameters-table th:nth-child(4),
#pdf-parameters-table td:nth-child(4) {
    width: 8%;  /* Adet */
    text-align: center;
}

#pdf-parameters-table th:nth-child(5),
#pdf-parameters-table td:nth-child(5) {
    width: 12%;  /* Birim Fiyat */
    text-align: right;
}

#pdf-parameters-table th:nth-child(6),
#pdf-parameters-table td:nth-child(6) {
    width: 12%;  /* Toplam */
    text-align: right;
}

/* ============================================
   FÄ°RMA BÄ°LGÄ° TABLOSU
   ============================================ */

.info-table {
    width: 100%;
    max-width: 100%;
    border-collapse: collapse;
    font-size: 9px;
    margin: 8px 0;  /* âœ… Azalt */
    table-layout: fixed;
}

.info-table td {
    border: 1px solid #000;
    padding: 4px;  /* âœ… Azalt */
    word-wrap: break-word;
}

.info-table td:first-child {
    font-weight: bold;
    width: 30%;
    background: #f0f0f0;
}

.info-table td:last-child {
    width: 70%;
}

/* ============================================
   BAÅLIK VE METÄ°N STÄ°LLERÄ°
   ============================================ */

.pdf-title {
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    margin: 12px 0;  /* âœ… Azalt */
    color: #333;
}

.pdf-subtitle {
    text-align: center;
    font-size: 10px;
    font-weight: normal;
    margin: 8px 0;
    color: #666;
}

.blue-header {
    background: #4472C4;
    color: white;
    text-align: center;
    padding: 8px;
    font-size: 11px;
    font-weight: bold;
    margin: 8px 0;  /* âœ… Azalt */
}

/* ============================================
   METÄ°N BLOKLARI - SAYFA Ä°Ã‡Ä°NDE KALSIN
   ============================================ */

.pdf-text {
    font-size: 9px;
    line-height: 1.4;  /* âœ… Azalt (1.5 -> 1.4) */
    text-align: justify;
    color: #333;
    word-wrap: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
}

.pdf-text p {
    margin: 5px 0;  /* âœ… Azalt (6px -> 5px) */
    page-break-inside: avoid;
}

/* ============================================
   HEADER & FOOTER
   ============================================ */

.pdf-header {
    margin-bottom: 8px;  /* âœ… Azalt */
}

.pdf-footer {
    position: absolute;
    bottom: 8mm;  /* âœ… Azalt */
    left: 15mm;
    right: 15mm;
    font-size: 8px;
    font-style: italic;
    color: #666;
}

.page-number {
    position: absolute;
    top: 8mm;  /* âœ… Azalt */
    right: 15mm;
    font-size: 8px;
    color: #666;
}

/* ============================================
   TUTARLAR BÃ–LÃœMÃœ
   ============================================ */

.pdf-totals {
    font-size: 9px;
    margin-top: 8px;  /* âœ… Azalt */
    font-weight: bold;
}

.pdf-totals div {
    margin: 3px 0;  /* âœ… Azalt */
}

/* ============================================
   BANKA TABLOSU
   ============================================ */

.bank-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 8px;
    margin: 10px 0;
}

.bank-table th {
    background: #4472C4;
    color: white;
    border: 1px solid #000;
    padding: 5px;
    text-align: center;
    font-size: 8px;
}

.bank-table td {
    border: 1px solid #000;
    padding: 5px;
    text-align: center;
    font-size: 8px;
}

/* ============================================
   PRINT MODU
   ============================================ */

@media print {
    body {
        margin: 0;
        padding: 0;
    }
    
    .pdf-page {
        page-break-after: always;
        page-break-inside: avoid;
        margin: 0;
        overflow: visible;
    }
    
    .pdf-page:last-child {
        page-break-after: avoid;
    }
    
    .pdf-table,
    .info-table,
    .pdf-text {
        page-break-inside: avoid;
    }
}

/* ============================================
   RESPONSIVE TABLO (Ã‡ok uzun iÃ§erik iÃ§in)
   ============================================ */

@page {
    size: A4;
    margin: 0;
}

/* Uzun metinleri kes */
.text-truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Kelime kÄ±rma */
.break-word {
    word-break: break-word;
    overflow-wrap: break-word;
}

    </style>
</head>
<body>

<!-- AUTH MODAL -->
<div id="authModal" class="modal active" style="display:flex;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
            <h3 id="authTitle">ğŸ” GiriÅŸ Yap</h3>
        </div>
        <div style="padding: 20px;">
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="ornek@mail.com" required>
                </div>
                <div class="form-group">
                    <label>Åifre</label>
                    <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <button class="btn btn-primary" onclick="loginUser()" style="width:100%; margin-bottom:10px;">
                    GiriÅŸ Yap
                </button>
                <button class="btn btn-primary" onclick="loginWithGoogle()" style="width:100%; margin-bottom:10px;">
    		    ğŸ”µ Google ile GiriÅŸ
		</button>
                <p style="text-align:center; margin-top:15px; color:#6b7280;">
                    HesabÄ±n yok mu? 
                    <a href="#" onclick="toggleAuthMode()" style="color:var(--primary);">KayÄ±t Ol</a>
                </p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" style="display:none;">
                <div class="form-group">
                    <label>Ad Soyad</label>
                    <input type="text" id="registerName" placeholder="Ahmet YÄ±lmaz" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="ornek@mail.com" required>
                </div>
                <div class="form-group">
                    <label>Åifre (min 6 karakter)</label>
                    <input type="password" id="registerPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                </div>
                <button class="btn btn-primary" onclick="registerUser()" style="width:100%; margin-bottom:10px;">
                    KayÄ±t Ol
                </button>
                <p style="text-align:center; margin-top:15px; color:#6b7280;">
                    HesabÄ±n var mÄ±? 
                    <a href="#" onclick="toggleAuthMode()" style="color:var(--primary);">GiriÅŸ Yap</a>
                </p>
            </div>
        </div>
    </div>
</div>



    <div class="container">
        <div class="header">
            <span class="version-badge">v2.0 Pro</span>
            <h1>ğŸ’¼ Muhasebe Takip Sistemi</h1>
            <p>Profesyonel Fatura, Cari ve Ã–deme YÃ¶netimi</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">ğŸ“Š Dashboard</button>
            <button class="tab" onclick="showTab('companies')">ğŸ¢ Firmalar</button>
            <button class="tab" onclick="showTab('accounts')">ğŸ‘¥ Cari Hesaplar</button>
	    <button class="tab" onclick="showTab('proposals')">ğŸ“‘ Teklifler</button>
            <button class="tab" onclick="showTab('invoices')">ğŸ“„ Faturalar</button>
    	    <button class="tab" onclick="showTab('purchases')">ğŸ’¸ AlÄ±ÅŸlar</button>
            <button class="tab" onclick="showTab('payments')">ğŸ’° Ã–demeler</button>
            <button class="tab" onclick="showTab('reports')">ğŸ“ˆ Raporlar</button>
	    <button class="tab" onclick="showTab('personnel')">ğŸ‘¥ Personel</button>
            <button class="tab" onclick="showTab('settings')">âš™ï¸ Ayarlar</button>
        </div>

        <div class="content">
            <!-- DASHBOARD TAB -->
            <div id="dashboard" class="tab-content active">
                <div class="company-selector">
                    <label>Aktif Firma:</label>
                    <select id="activeCompanySelect" onchange="changeActiveCompany()">
                        <option value="">Firma SeÃ§iniz</option>
                    </select>
                </div>

                <div class="grid-4">
                    <div class="stat-card success">
                        <h4>Toplam Gelir</h4>
                        <div class="amount" id="totalIncome">0.00 â‚º</div>
                    </div>
                    <div class="stat-card danger">
                        <h4>Toplam Gider</h4>
                        <div class="amount" id="totalExpense">0.00 â‚º</div>
                    </div>
                    <div class="stat-card">
                        <h4>Net Kar/Zarar</h4>
                        <div class="amount" id="netProfit">0.00 â‚º</div>
                    </div>
                    <div class="stat-card warning">
                        <h4>Tahsil Edilecek</h4>
                        <div class="amount" id="receivables">0.00 â‚º</div>
                    </div>
                </div>

                <div class="grid-3">
                    <div class="stat-card warning">
                        <h4>Ã–denecek KDV</h4>
                        <div class="amount" id="totalVAT">0.00 â‚º</div>
                    </div>
                    <div class="stat-card purple">
                        <h4>Kurumlar Vergisi (%20)</h4>
                        <div class="amount" id="corporateTax">0.00 â‚º</div>
                    </div>
                    <div class="stat-card info">
                        <h4>Toplam Ã–deme</h4>
                        <div class="amount" id="totalPayments">0.00 â‚º</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <h3>Son Faturalar</h3>
                        <table id="recentInvoices">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>No</th>
                                    <th>Cari</th>
                                    <th>Tutar</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div class="card">
                        <h3>Son Ã–demeler</h3>
                        <table id="recentPayments">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Cari</th>
                                    <th>Tutar</th>
                                    <th>Tip</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>


<!-- COMPANIES TAB - YENÄ° TASARIM -->
<div id="companies" class="tab-content">
    <!-- Ãœst BaÅŸlÄ±k ve Butonlar -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">ğŸ¢ Firmalar</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalCompaniesCount">0</strong> firma kayÄ±tlÄ±</p>
        </div>
        <button class="btn btn-primary" onclick="openAddCompanyModal()" style="font-size: 16px; padding: 12px 25px;">
            â• Yeni Firma Ekle
        </button>
    </div>

    <!-- Firma Listesi -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>ğŸ“Š KayÄ±tlÄ± Firmalar</h3>
            <input type="text" id="searchCompany" placeholder="ğŸ” Firma ara..." 
                   oninput="searchCompanies()" 
                   style="width: 300px; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
        </div>
        
        <table id="companiesTable">
            <thead>
                <tr>
                    <th>Ãœnvan</th>
                    <th>SektÃ¶r</th>
                    <th>Vergi No</th>
                    <th>Vergi Dairesi</th>
                    <th>Telefon</th>
                    <th>Cari SayÄ±sÄ±</th>
                    <th>DÃ¶kÃ¼man</th>
                    <th>Ä°ÅŸlemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- ACCOUNTS TAB - YENÄ° TASARIM -->
<div id="accounts" class="tab-content">
    <!-- Ãœst BaÅŸlÄ±k ve Butonlar -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">ğŸ‘¥ Cari Hesaplar</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalAccountsCount">0</strong> cari hesap kayÄ±tlÄ±</p>
        </div>
        <button class="btn btn-primary" onclick="openAddAccountModal()" style="font-size: 16px; padding: 12px 25px;">
            â• Yeni Cari Hesap Ekle
        </button>
	<button class="btn btn-success" onclick="openImportAccountsModal()" style="font-size: 16px; padding: 12px 25px;">
    	    ğŸ“¤ Cari HesaplarÄ± Excel'den Ekle
	</button>
	<button class="btn btn-success" onclick="showPassiveAccountsModal()" style="font-size: 16px; padding: 12px 25px;">
    	    ğŸ—ƒï¸ Pasif Cariler
	</button>
    </div>

    <!-- Cari Hesaplar Listesi -->
    <div class="card">
        <h3>ğŸ“‹ Cari Hesap Listesi</h3>
        
<!-- FÄ°LTRELER -->
<div class="filters">
    <div class="grid-4">
        <div class="form-group">
            <label>ğŸ¢ Firma</label>
            <select id="filterAccountCompany" onchange="filterAndSortAccounts()">
                <option value="">TÃ¼m Firmalar</option>
            </select>
        </div>
        <div class="form-group">
            <label>ğŸ‘¥ TÃ¼r</label>
            <select id="filterAccountType" onchange="filterAndSortAccounts()">
                <option value="">TÃ¼mÃ¼</option>
                <option value="customer">MÃ¼ÅŸteri</option>
                <option value="supplier">TedarikÃ§i</option>
            </select>
        </div>
        <div class="form-group">
            <label>ğŸ’° Bakiye Durumu</label>
            <select id="filterAccountBalance" onchange="filterAndSortAccounts()">
                <option value="">TÃ¼mÃ¼</option>
                <option value="positive">AlacaklÄ± (+)</option>
                <option value="negative">BorÃ§lu (-)</option>
                <option value="zero">SÄ±fÄ±r (0)</option>
            </select>
        </div>
        <div class="form-group">
            <label>ğŸ” Ara</label>
            <input type="text" id="searchAccount" placeholder="Cari adÄ±, vergi no, telefon..." oninput="filterAndSortAccounts()">
        </div>
    </div>
    
    <!-- SÄ±ralama ve Butonlar -->
    <div class="grid-4" style="margin-top: 15px;">
        <div class="form-group">
            <label>ğŸ“Š SÄ±rala</label>
            <select id="sortAccount" onchange="filterAndSortAccounts()">
                <option value="name-asc">Ä°sim (A-Z)</option>
                <option value="name-desc">Ä°sim (Z-A)</option>
                <option value="balance-desc">Bakiye (YÃ¼ksek â†’ DÃ¼ÅŸÃ¼k)</option>
                <option value="balance-asc">Bakiye (DÃ¼ÅŸÃ¼k â†’ YÃ¼ksek)</option>
                <option value="date-desc">Tarih (Yeni â†’ Eski)</option>
                <option value="date-asc">Tarih (Eski â†’ Yeni)</option>
            </select>
        </div>
        <div class="form-group" style="display: flex; align-items: flex-end; gap: 10px;">
            <button class="btn btn-info" onclick="filterAndSortAccounts()" style="flex: 1;">
                ğŸ” Filtrele
            </button>
            <button class="btn btn-warning" onclick="clearAccountFilters()" style="flex: 1;">
                ğŸ”„ Temizle
            </button>
        </div>
    </div>
</div>
        
<table id="accountsTable">
    <thead>
        <tr>
            <th onclick="sortAccountsBy('company')" style="cursor: pointer;">
                ğŸ¢ Firma <span id="sortCompany">â‡…</span>
            </th>
            <th onclick="sortAccountsBy('name')" style="cursor: pointer;">
                ğŸ‘¤ Cari AdÄ± <span id="sortName">â‡…</span>
            </th>
            <th onclick="sortAccountsBy('type')" style="cursor: pointer;">
                ğŸ·ï¸ TÃ¼r <span id="sortType">â‡…</span>
            </th>
            <th>ğŸ“ Telefon</th>
            <th onclick="sortAccountsBy('balance')" style="cursor: pointer;">
                ğŸ’° Bakiye <span id="sortBalance">â‡…</span>
            </th>
            <th>ğŸ“„ DÃ¶kÃ¼man</th>
            <th>âš™ï¸ Ä°ÅŸlemler</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
    </div>
</div>

<!-- FÄ°RMA EKLEME/DÃœZENLEME MODAL -->
<div id="companyFormModal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="companyFormModalTitle">â• Yeni Firma Ekle</h3>
            <button class="close-modal" onclick="closeCompanyFormModal()">âœ–</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="companyForm" enctype="multipart/form-data">
                <input type="hidden" id="companyId">
                
                <!-- Temel Bilgiler -->
                <div class="alert alert-info">
                    <strong>ğŸ“‹ Temel Bilgiler</strong>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Firma ÃœnvanÄ± *</label>
                        <input type="text" id="companyName" required placeholder="Ã–rn: ABC Ticaret Ltd. Åti.">
                    </div>
                    <div class="form-group">
                        <label>SektÃ¶r</label>
                        <select id="companySector">
                            <option value="">SeÃ§iniz</option>
                            <option value="Ä°nÅŸaat">Ä°nÅŸaat</option>
                            <option value="Ticaret">Ticaret</option>
                            <option value="Ãœretim">Ãœretim</option>
                            <option value="Hizmet">Hizmet</option>
                            <option value="DanÄ±ÅŸmanlÄ±k">DanÄ±ÅŸmanlÄ±k</option>
                            <option value="Lojistik">Lojistik</option>
                            <option value="GÄ±da">GÄ±da</option>
                            <option value="Teknoloji">Teknoloji</option>
                            <option value="EÄŸitim">EÄŸitim</option>
                            <option value="SaÄŸlÄ±k">SaÄŸlÄ±k</option>
                            <option value="DiÄŸer">DiÄŸer</option>
                        </select>
                    </div>
                </div>
                
                <!-- Vergi Bilgileri -->
                <div class="alert alert-warning" style="margin-top: 20px;">
                    <strong>ğŸ’¼ Vergi Bilgileri</strong>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Vergi NumarasÄ± *</label>
                        <input type="text" id="companyTaxNo" required placeholder="10 haneli vergi numarasÄ±" maxlength="10">
                    </div>
                    <div class="form-group">
                        <label>Vergi Dairesi *</label>
                        <input type="text" id="companyTaxOffice" required placeholder="Ã–rn: KadÄ±kÃ¶y Vergi Dairesi">
                    </div>
                </div>
                
                <!-- Ä°letiÅŸim Bilgileri -->
                <div class="alert alert-success" style="margin-top: 20px;">
                    <strong>ğŸ“ Ä°letiÅŸim Bilgileri</strong>
                </div>
                
                <div class="grid-3">
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="tel" id="companyPhone" placeholder="0XXX XXX XX XX">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="companyEmail" placeholder="info@firma.com">
                    </div>
                    <div class="form-group">
                        <label>Website</label>
                        <input type="url" id="companyWebsite" placeholder="https://www.firma.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Adres *</label>
                    <textarea id="companyAddress" rows="3" required placeholder="Tam adres bilgisi..."></textarea>
                </div>
                
                <!-- DÃ¶kÃ¼manlar -->
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>ğŸ“ DÃ¶kÃ¼manlar (Ä°steÄŸe BaÄŸlÄ±)</strong>
                    <p style="font-size: 0.9em; margin-top: 5px;">Ticaret Sicil Gazetesi, Ä°mza SirkÃ¼leri, Vergi LevhasÄ± vb.</p>
                </div>
                
                <div id="companyDocumentsList"></div>
                <button type="button" class="btn btn-success" onclick="addCompanyDocument()">
                    â• Yeni DÃ¶kÃ¼man Ekle
                </button>
                
                <!-- Log Bilgisi (DÃ¼zenleme modunda gÃ¶ster) -->
                <div id="companyLogInfo" style="display: none; margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px; font-size: 0.9em;">
                    <strong>ğŸ“ KayÄ±t Bilgileri:</strong>
                    <p id="companyCreatedInfo" style="margin: 5px 0;"></p>
                    <p id="companyUpdatedInfo" style="margin: 5px 0;"></p>
                </div>
                
                <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" class="btn btn-secondary" onclick="closeCompanyFormModal()">
                        âœ–ï¸ Ä°ptal
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveCompanyBtn">
                        ğŸ’¾ Firma Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Teklifler sekmesi -->
<div id="proposals" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">ğŸ“‘ Teklifler</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">BaÅŸvuru dokÃ¼manÄ±nÄ± yÃ¼kleyerek veya manuel teklif oluÅŸturabilirsiniz.</p>
        </div>
        <button class="btn btn-primary" onclick="openAddProposalModal()">
            â• Teklif OluÅŸtur
        </button>
    </div>
    <div class="card">
        <h3>ğŸ“‹ Teklif Listesi</h3>
        <table id="proposalsTable">
            <thead>
                <tr>
                    <th>Teklif No</th>
                    <th>Firma</th>
                    <th>BaÅŸvuru Tarihi</th>
                    <th>Tutar</th>
                    <th>Durum</th>
                    <th>Ä°ÅŸlemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Teklif ekleme/dÃ¼zenleme modalÄ± -->
<div id="proposalFormModal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="proposalFormModalTitle">â• Teklif OluÅŸtur</h3>
            <button class="close-modal" onclick="closeProposalFormModal()">âœ–</button>
        </div>
        <div style="padding: 20px;">
            <form id="proposalForm">
                <div class="alert alert-info">
                    <strong>BaÅŸvuru PDF veya GÃ¶rsel YÃ¼kle</strong>
                    <p style="font-size: 0.9em; margin-top: 5px;">BaÅŸvuru.pdf veya baÅŸvuru formunun gÃ¶rselini yÃ¼kleyin. Otomatik parse edilecek, eksik/hatalÄ± alanlar manuel dÃ¼zeltilebilir.</p>
                </div>
<div class="form-group">
    <label>PDF/GÃ¶rsel YÃ¼kle</label>
    <input type="file" id="proposalDocument" accept=".pdf,image/png,image/jpeg" onchange="handleDocumentUpload(event)">
    <div style="margin-top:10px;">
        <button type="button" class="btn btn-info btn-sm" onclick="parseWithPDFjs()">PDF.js ile Parse</button>
    </div>
</div>
                <div id="documentParseResult" style="margin-bottom: 15px;"></div>
                <div class="alert alert-success">
                    <strong>Teklif Bilgileri</strong>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Teklif No</label>
                        <input type="text" id="proposalNumber" placeholder="Ã–rn: 2025-Ã‡-127" required>
                    </div>
                    <div class="form-group">
                        <label>BaÅŸvuru No</label>
                        <input type="text" id="proposalApplicationNo" required>
                    </div>
                </div>

<!-- YENÄ°: Cari Hesap SeÃ§imi -->
<div class="form-group">
    <label>ğŸ‘¤ Cari Hesap SeÃ§ *</label>
    <select id="proposalCariAccount" onchange="fillFromCariAccount()" required>
        <option value="">Cari hesap seÃ§iniz...</option>
    </select>
    <small style="color: #6b7280; display: block; margin-top: 5px;">
        âœ¨ Cari seÃ§tiÄŸinizde firma bilgileri otomatik doldurulur
    </small>
</div>

<div class="alert alert-warning" style="margin-top: 20px;">
    <strong>ğŸ“‹ Firma Bilgileri</strong>
    <button type="button" class="btn btn-sm btn-secondary" style="float: right;" onclick="toggleFirmaDetay()">
        DetaylarÄ± GÃ¶ster/Gizle
    </button>
</div>

<div id="firmaDetaySection" style="display: none;">
    <div class="form-group">
        <label>Firma ÃœnvanÄ±</label>
        <input type="text" id="proposalCompany" placeholder="Ã–rn: ABC Sanayi Ltd. Åti." required>
    </div>
    
    <div class="form-group">
        <label>Firma Adresi</label>
        <textarea id="proposalAddress" rows="2" placeholder="Tam adres giriniz" required></textarea>
    </div>
<div class="form-group">
    <label>Yetkili KiÅŸi</label>
    <input type="text" id="proposalContactPerson" placeholder="Yetkili kiÅŸi adÄ±">
</div>    
    <div class="grid-2">
        <div class="form-group">
            <label>Telefon</label>
            <input type="text" id="proposalPhone" placeholder="0 XXX XXX XX XX">
        </div>
        <div class="form-group">
            <label>E-posta</label>
            <input type="email" id="proposalEmail" placeholder="ornek@firma.com">
        </div>
    </div>
    
    <div class="alert alert-info" style="margin-top: 20px;">
        <strong>ğŸ“„ Teklif Ä°Ã§erik Bilgileri</strong>
    </div>
    
    <div class="form-group">
        <label>Teklif TÃ¼rÃ¼</label>
        <select id="proposalType" required>
            <option value="Emisyon Ã–lÃ§Ã¼mÃ¼">Emisyon Ã–lÃ§Ã¼mÃ¼</option>
            <option value="Ä°misyon Ã–lÃ§Ã¼mÃ¼">Ä°misyon Ã–lÃ§Ã¼mÃ¼</option>
            <option value="Emisyon-Ä°misyon Ã–lÃ§Ã¼mÃ¼">Emisyon-Ä°misyon Ã–lÃ§Ã¼mÃ¼</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>Teklif Ä°Ã§eriÄŸi</label>
        <input type="text" id="proposalContent" value="Ä°misyon Ã–lÃ§Ã¼mÃ¼ Fiyat Teklifi">
    </div>
    
    <div class="grid-2">
        <div class="form-group">
            <label>Teklifi HazÄ±rlayan</label>
            <input type="text" id="proposalPreparedBy" value="GÃ¶knur YAÄAN" required>
        </div>
        <div class="form-group">
            <label>Ä°letiÅŸim</label>
            <input type="text" id="proposalContact" value="0 282 651 46 50" required>
        </div>
    </div>
</div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>BaÅŸvuru Tarihi</label>
                        <input type="text" id="proposalApplicationDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Cari Hesap SeÃ§</label>
                    <select id="proposalCari" onchange="checkCompanyMatch()">
                        <option value="">Cari seÃ§iniz</option>
                        <!-- JS ile cariler doldurulacak -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Laboratuvar</label>
                    <input type="text" id="proposalLab">
                </div>
                <div class="form-group">
                    <label>Parametreler <button type="button" class="btn btn-info btn-sm" onclick="addParameterRow()">â• Ekstra Parametre</button></label>
                    <table id="parametersTable" style="width:100%; margin-top:10px;">
                        <thead>
                            <tr>
                                <th>Parametre</th>
                                <th>Adet</th>
                                <th>Birim Fiyat</th>
                                <th>Toplam</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>KDV HariÃ§ Toplam</label>
                        <input type="text" id="proposalTotal">
                    </div>
                    <div class="form-group">
                        <label>Ä°ndirimli KDV HariÃ§ Toplam</label>
                        <input type="text" id="proposalDiscountedTotal">
                    </div>
                </div>
                <div class="form-group">
                    <label>AÃ§Ä±klamalar</label>
                    <textarea id="proposalNotes" rows="3"></textarea>
                </div>
		<button type="button" class="btn btn-success" onclick="createTeklifPDF()">
                    PDF OluÅŸtur 1
                </button>
		<button type="button" class="btn btn-success" onclick="createProfessionalTeklifPDF()">
                    PDF OluÅŸtur 2
                </button>
                <button type="button" class="btn btn-success" onclick="saveProposal()">
                    Kaydet
                </button>
            </form>
        </div>
    </div>
</div>

<!-- CARÄ° HESAP EKLEME/DÃœZENLEME MODAL -->
<div id="accountFormModal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="accountFormModalTitle">â• Yeni Cari Hesap Ekle</h3>
            <button class="close-modal" onclick="closeAccountFormModal()">âœ–</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="accountForm">
                <input type="hidden" id="accountId">
                <input type="hidden" id="accountCompanyId">
                
                <!-- Firma Bilgisi -->
                <div class="alert alert-info" id="accountCompanyInfo">
                    <strong>ğŸ¢ Firma:</strong> <span id="accountActiveCompanyName">SeÃ§iniz</span>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>ğŸ¢ Firma *</label>
                        <select id="accountCompany" required onchange="updateAccountCompanyInfo()">
                            <option value="">Firma SeÃ§iniz</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cari AdÄ± *</label>
                        <input type="text" id="accountName" required placeholder="Ã–rn: ABC Tedarik Ltd. Åti.">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>TÃ¼r *</label>
                        <select id="accountType" required>
                            <option value="">SeÃ§iniz</option>
                            <option value="customer">MÃ¼ÅŸteri</option>
                            <option value="supplier">TedarikÃ§i</option>
    			    <option value="personnel">Personel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vergi/TC No</label>
                        <input type="text" id="accountTaxNo" placeholder="10 veya 11 haneli">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="tel" id="accountPhone" placeholder="0XXX XXX XX XX">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="accountEmail" placeholder="info@cari.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Adres</label>
                    <textarea id="accountAddress" rows="3" placeholder="Adres bilgisi..."></textarea>
                </div>
                
                <!-- DÃ¶kÃ¼manlar -->
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>ğŸ“ DÃ¶kÃ¼manlar (Maks. 5 adet, Toplam 3 MB)</strong>
                    <p style="font-size: 0.9em; margin-top: 5px;">SÃ¶zleÅŸme, Fatura Ã¶rneÄŸi, Ã–n yazÄ±ÅŸmalar vb.</p>
                </div>
                
                <div id="accountDocumentsList"></div>
                <button type="button" class="btn btn-success" onclick="addAccountDocument()" id="addAccountDocBtn">
                    â• DÃ¶kÃ¼man Ekle (0/5)
                </button>
                
                <div id="accountDocSizeInfo" style="margin-top: 10px; font-size: 0.9em; color: #6b7280;">
                    Toplam boyut: <strong id="accountDocSize">0 KB</strong> / 3 MB
                </div>
                
                <!-- Log Bilgisi -->
                <div id="accountLogInfo" style="display: none; margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px; font-size: 0.9em;">
                    <strong>ğŸ“ KayÄ±t Bilgileri:</strong>
                    <p id="accountCreatedInfo" style="margin: 5px 0;"></p>
                    <p id="accountUpdatedInfo" style="margin: 5px 0;"></p>
                </div>
                
                <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" class="btn btn-secondary" onclick="closeAccountFormModal()">
                        âœ–ï¸ Ä°ptal
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveAccountBtn">
                        ğŸ’¾ Cari Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- PDF Template (gizli) -->
<div id="pdfTemplate" style="display: none;">
    <div class="pdf-page page-1">
        <!-- KAPAK SAYFASI -->
        <div class="pdf-header">
            <div style="text-align: right; font-size: 10px;">
                <div>Teklif NumarasÄ± | <span id="pdf-teklif-no"></span></div>
                <div>Tarih | <span id="pdf-tarih"></span></div>
            </div>
        </div>
        
        <div class="pdf-logo-section" style="text-align: center; margin: 20px 0;">
            <!-- Sol logo -->
            <img src="logo-sol.png" style="width: 80px; display: inline-block;">
            <!-- Orta logo (GÃ–ZDE) -->
            <img src="logo-gozde.png" style="width: 200px; display: inline-block; margin: 0 20px;">
            <!-- SaÄŸ logo (TÃœRKAK) -->
            <img src="logo-turkak.png" style="width: 80px; display: inline-block;">
        </div>
        
        <div style="text-align: center; margin: 10px 0;">
            <div style="font-weight: bold; font-size: 11px;">Yeterlilik Belge No</div>
            <div style="font-size: 11px;">Y-59/279/2021</div>
        </div>
        
        <h2 style="text-align: center; font-size: 12px; font-weight: bold;">
            GÃ–ZDE Ã‡EVRE Ä°Å GÃœVENLÄ°ÄÄ° Ã–LÃ‡ÃœM TEST<br>
            ANALÄ°Z LABORATUVAR SAN. VE TÄ°C. LTD. ÅTÄ°.
        </h2>
        
        <div style="text-align: center; font-size: 10px; margin: 10px 0;">
            Ã‡obanÃ§eÅŸme Mahallesi Atay Cad. No: 18 / B Ã‡orlu / TEKÄ°RDAÄ<br>
            Tel :+90 282 651 46 50<br>
            E-posta : bilgi@gozdeisglab.com / gozdecevrelaboratuvari@gmail.com<br>
            Website : www.gozdecevre.com
        </div>
        
        <h3 style="text-align: center; background: #4472C4; color: white; padding: 8px; font-size: 12px;">
            TEKLÄ°F FORMU
        </h3>
        
        <table style="width: 100%; border-collapse: collapse; font-size: 10px; margin: 15px 0;">
            <tr>
                <td style="border: 1px solid #000; padding: 5px; font-weight: bold; width: 30%;">Firma ÃœnvanÄ±</td>
                <td style="border: 1px solid #000; padding: 5px;" id="pdf-firma-unvan"></td>
            </tr>
            <tr>
                <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">Firma Adresi</td>
                <td style="border: 1px solid #000; padding: 5px;" id="pdf-firma-adres"></td>
            </tr>
            <tr>
                <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">Telefon</td>
                <td style="border: 1px solid #000; padding: 5px;">
                    <span id="pdf-telefon"></span> 
                    <span style="margin-left: 50px;">Mail</span>
                    <span id="pdf-mail"></span>
                </td>
            </tr>
            <tr>
                <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">Konu</td>
                <td style="border: 1px solid #000; padding: 5px;" id="pdf-konu"></td>
            </tr>
            <tr>
                <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">Ä°Ã§erik</td>
                <td style="border: 1px solid #000; padding: 5px;" id="pdf-icerik"></td>
            </tr>
            <tr>
                <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">Melbes BaÅŸvuru No</td>
                <td style="border: 1px solid #000; padding: 5px;" id="pdf-basvuru-no"></td>
            </tr>
        </table>
        
        <div style="font-size: 10px; margin: 15px 0; line-height: 1.6;">
            <p>SayÄ±n Yetkili,</p>
            <p>2025 YÄ±lÄ± Asgari Fiyat Tarifesine uygun olarak hazÄ±rlanan fiyat teklifidir...</p>
            <p>Ä°yi Ã‡alÄ±ÅŸmalar Dileriz.</p>
            <p>SaygÄ±larÄ±mÄ±zla,<br>GÃ¶zde Ã‡evre LaboratuvarÄ±</p>
        </div>
        
        <div style="font-size: 10px; margin: 20px 0;">
            <div>Teklifi HazÄ±rlayan</div>
            <div><strong><span id="pdf-hazirlayan"></span></strong></div>
            <div>Ä°letiÅŸim: <span id="pdf-iletisim"></span></div>
        </div>
        
        <div style="position: absolute; bottom: 20px; font-size: 9px; font-style: italic;">
            <div>Teklifimiz 30 GÃ¼n GeÃ§erlidir.</div>
            <div>Teklif imiz OnaylanmasÄ± Durumunda SÃ¶zleÅŸme NiteliÄŸindedir.</div>
            <div>FR 89 / 08.01.2024-10</div>
        </div>
    </div>
    
<!-- SAYFA 2: PARAMETRELER TABLOSU -->
<div class="pdf-page page-2">
    <div class="page-number">
        <div>Teklif NumarasÄ± | <span class="pdf-teklif-no-copy"></span></div>
        <div>Tarih | <span class="pdf-tarih-copy"></span></div>
    </div>
    
    <h3 class="pdf-title">
        <span id="pdf-baslik-tur"></span> Fiyat Teklifi
    </h3>
    
<!-- âœ… DÃœZELTÄ°LMÄ°Å PARAMETRELER TABLOSU -->
<table class="pdf-table" id="pdf-parameters-table">
    <thead>
        <tr>
            <th style="width: 15%;">Kaynak AdÄ±</th>
            <th style="width: 30%;">Ã–lÃ§Ã¼m Parametresi</th>
            <th style="width: 25%;">Ã–lÃ§Ã¼m StandardÄ±</th>
            <th style="width: 8%; text-align: center;">Adet</th>
            <th style="width: 12%; text-align: right;">Birim Fiyat</th>
            <th style="width: 10%; text-align: right;">Toplam</th>
        </tr>
    </thead>
    <tbody>
        <!-- Dinamik olarak JavaScript ile doldurulacak -->
    </tbody>
</table>
<!-- âœ… TUTARLAR BÃ–LÃœMÃœ -->
<div class="pdf-totals">
    <div style="margin: 5px 0;">TOPLAM: <span id="pdf-toplam"></span></div>
    <div style="margin: 5px 0;">TABAN FÄ°YAT: <span id="pdf-taban-fiyat"></span></div>
    <div style="margin: 5px 0; font-size: 10px;">GENEL TOPLAM: <span id="pdf-genel-toplam"></span></div>
</div>

<!-- âœ… KDV NOTU -->
<div style="font-size: 8px; margin-top: 10px;">
    <div>- FiyatlarÄ±mÄ±za %20 KDV Dahil DeÄŸildir.</div>
    <div id="pdf-ek-notlar"></div>
</div>
    
    <!-- Footer -->
    <div class="pdf-footer">
        <div>Teklifimiz 30 GÃ¼n GeÃ§erlidir.</div>
        <div>Teklif imiz OnaylanmasÄ± Durumunda SÃ¶zleÅŸme NiteliÄŸindedir.</div>
        <div>FR 89 / 08.01.2024-10</div>
    </div>
</div>

<!-- SAYFA 3: Ä°DARÄ° HÃœKÃœMLER -->
<div class="pdf-page page-3" style="page-break-before: always;">
    <div style="text-align: right; font-size: 9px; margin-bottom: 20px;">
        <div>3 | S a y f a</div>
        <div>Teklif NumarasÄ± | <span class="pdf-teklif-no-copy"></span></div>
        <div>Tarih | <span class="pdf-tarih-copy"></span></div>
    </div>
    
    <h3 style="text-align: center; font-size: 13px; font-weight: bold; margin-bottom: 20px;">
        Ä°DARÄ° HÃœKÃœMLER
    </h3>
    
    <div style="font-size: 10px; line-height: 1.6; text-align: justify;">
        <p><strong>1.</strong> MÃ¼ÅŸteri ve Laboratuvar, T.C Ã‡evre, Åehircilik ve Ä°klim DeÄŸiÅŸikliÄŸi BakanlÄ±ÄŸÄ± tarafÄ±ndan yayÄ±mlanan asgari fiyat tarifesi hÃ¼kÃ¼mlerine uymak zorundadÄ±r.</p>
        
        <p><strong>2.</strong> SÃ¶z konusu teklif 2025 YÄ±lÄ± Asgari Fiyat Tarifesi 'ne gÃ¶re hazÄ±rlanmÄ±ÅŸtÄ±r.</p>
        
        <p><strong>3.</strong> Merkezi Laboratuvar Belirleme Sistemi (MELBES) ile gelen iÅŸler iÃ§in; BaÅŸvuru tarihi, planlanan baÅŸlangÄ±Ã§ tarihi gibi belirleyici durumlara uygun ÅŸekilde firmadan kaynaklÄ± Ã¶lÃ§Ã¼m planlamasÄ± yapÄ±lamamasÄ± durumunda, Ã¶lÃ§Ã¼m tarihi dikkate alÄ±narak Ã¶lÃ§Ã¼mÃ¼n yapÄ±ldÄ±ÄŸÄ± yÄ±la ait asgari fiyat tarifesine gÃ¶re teklif gÃ¼ncellenerek fatura edilecektir. (Ã–rnek; BaÅŸvuru 2024 YÄ±lÄ± Temmuz ayÄ±nda yapÄ±lmÄ±ÅŸ, Planlanan Ã¶lÃ§Ã¼m baÅŸlangÄ±Ã§ tarihi en geÃ§ 15.08.2024, ancak firmadan kaynaklÄ± Ã¶lÃ§Ã¼mler 15.02.2025 tarihinde yapÄ±ldÄ±. 2025 yÄ±lÄ± asgari fiyat tarifesine uygun olarak Ã¶lÃ§Ã¼m bedeli kesilecektir.)</p>
        
        <p><strong>4.</strong> Teklifin onaylanmasÄ±nÄ± takiben, kuruluÅŸunuz yetkili personeli ile birlikte Ã¶lÃ§Ã¼m programÄ± yapÄ±lacak ve tÃ¼m Ã§alÄ±ÅŸmalar yapÄ±lan iÅŸ planÄ±na uygun olarak gerÃ§ekleÅŸtirilecektir. T.C Ã‡evre ve Åehircilik BakanlÄ±ÄŸÄ±nÄ±n tebliÄŸi gereÄŸi MELBES Sistemine Ã§evresel Ã¶lÃ§Ã¼m programÄ± en az 5 gÃ¼n(120 saat) Ã¶ncesinden bildirilmesi gerekmektedir. Ã–lÃ§Ã¼m kayÄ±t sisteminde kayÄ±t tarihi ile beraber kayÄ±t saati de kayÄ±t iÅŸlemini etkilediÄŸi iÃ§in, laboratuvarÄ±mÄ±z en az 6 gÃ¼n Ã¶ncesinden bildirimleri gerÃ§ekleÅŸtirmektedir. Ã–lÃ§Ã¼m tarihleri belirlenirken, LaboratuvarÄ±mÄ±z mÃ¼ÅŸteri ile ortak tarih belirlemektedir. BakanlÄ±ÄŸa gÃ¶nderilen Ã¶lÃ§Ã¼m sistemi bildirimleri iÃ§in program revizyonu Ã¶lÃ§Ã¼m tarihinden en az 3 gÃ¼n Ã¶nce yapÄ±labilir. Ã–lÃ§Ã¼me 2 veya daha az gÃ¼n kalmasÄ± durumunda sistemde revizyon yapmak mÃ¼mkÃ¼n deÄŸildir.</p>
        
        <p><strong>5.</strong> MÃ¼ÅŸteriye ait tÃ¼m bilgi ve belgeleri Gizlilik ve TarafsÄ±zlÄ±k ilkesine uygun olarak saklanÄ±r. MÃ¼ÅŸteri bilgilerinin 3. ÅahÄ±slarla paylaÅŸÄ±lmasÄ± iÃ§in; GÃ¶zde Ã‡evre LaboratuvarÄ± mÃ¼ÅŸteriyi yazÄ±lÄ± olarak bilgilendirir. MÃ¼ÅŸterinin yazÄ±lÄ± izni olmasÄ± durumunda bilgiler paylaÅŸÄ±labilir. (Mail, yazÄ±lÄ± belge v.b.) MÃ¼ÅŸterinin Ã‡evre YÃ¶netim Hizmetini yÃ¼rÃ¼ten EÃ‡BS Ã¼zerinden atanmÄ±ÅŸ Ã‡evre MÃ¼hendisi mÃ¼ÅŸteri adÄ±na bilgi ve belge talebi oluÅŸturabilir.</p>
        
        <p><strong>6.</strong> Ancak; MÃ¼ÅŸteri adÄ±na MELBES sistemi Ã¼zerinden baÅŸvuruyu yapan, sÃ¼reci yÃ¶neten Ã‡evre YÃ¶netim Hizmeti kuruluÅŸu deÄŸiÅŸip, mÃ¼ÅŸteri yeni bir Ã‡evre YÃ¶netim Hizmeti kuruluÅŸu ile anlaÅŸmasÄ± durumunda laboratuvarÄ±mÄ±zdan bilgi ve belge talebi oluÅŸturabilmesi iÃ§in, MÃ¼ÅŸteri tarafÄ±ndan yazÄ±lÄ± olarak (mail, yazÄ±lÄ± belge v.b.) laboratuvarÄ±mÄ±z bilgilendirilmesi gerekmektedir.</p>
        
        <p><strong>7.</strong> T.C Ã‡evre, Åehircilik ve Ä°klim DeÄŸiÅŸikliÄŸi BakanlÄ±ÄŸÄ± ya da diÄŸer yasal otoriteler mÃ¼ÅŸteriye ait bilgilere ulaÅŸmak isterse bilgilerin paylaÅŸÄ±mÄ± ile ilgili hususta mÃ¼ÅŸteriye bilgi verilmeden bilgi ve belgeler yasal otoriteye iletilebilir.</p>
    </div>
    
    <div style="position: absolute; bottom: 15px; font-size: 9px; font-style: italic;">
        <div>Teklifimiz 30 GÃ¼n GeÃ§erlidir.</div>
        <div>Teklif imiz OnaylanmasÄ± Durumunda SÃ¶zleÅŸme NiteliÄŸindedir.</div>
        <div>FR 89 / 08.01.2024-10</div>
    </div>
</div>

<!-- SAYFA 4: Ã–LÃ‡ÃœME AÄ°T BÄ°LGÄ°LER -->
<div class="pdf-page page-4" style="page-break-before: always;">
    <div style="text-align: right; font-size: 9px; margin-bottom: 20px;">
        <div>4 | S a y f a</div>
        <div>Teklif NumarasÄ± | <span class="pdf-teklif-no-copy"></span></div>
        <div>Tarih | <span class="pdf-tarih-copy"></span></div>
    </div>
    
    <h3 style="text-align: center; font-size: 13px; font-weight: bold; margin-bottom: 20px;">
        Ã–LÃ‡ÃœME AÄ°T BÄ°LGÄ°LER
    </h3>
    
    <div style="font-size: 10px; line-height: 1.6; text-align: justify;">
        <p><strong>1.</strong> Ã–lÃ§Ã¼m iÅŸlemleri, mÃ¼ÅŸterinin tesislerinde mevcut emisyon kaynaklarÄ±ndan periyodik emisyon Ã¶lÃ§Ã¼mÃ¼ yapÄ±lacak olanlar iÃ§in gerÃ§ekleÅŸtirilecektir.</p>
        
        <p><strong>2.</strong> Ã–lÃ§Ã¼m Ã¶ncesi tesis yetkilileri ile Ã¶lÃ§Ã¼m programÄ± oluÅŸturulacak ve programa uygun ÅŸekilde Ã¶lÃ§Ã¼mler gerÃ§ekleÅŸtirilecektir.</p>
        
        <p><strong>3.</strong> Ã–lÃ§Ã¼mler sÄ±rasÄ±nda tesiste elektrik, su vb. ihtiyaÃ§lar tesis tarafÄ±ndan karÅŸÄ±lanacaktÄ±r.</p>
        
        <p><strong>4.</strong> Ã–lÃ§Ã¼m ekibinin tesise giriÅŸ-Ã§Ä±kÄ±ÅŸ iÅŸlemleri ve tesis iÃ§i gÃ¼venlik prosedÃ¼rleri tesis tarafÄ±ndan saÄŸlanacaktÄ±r.</p>
        
        <p><strong>5.</strong> Ã–lÃ§Ã¼m noktalarÄ±na ulaÅŸÄ±m iÃ§in gerekli platform, merdiven vb. ekipmanlar tesis tarafÄ±ndan saÄŸlanacak ve Ã¶lÃ§Ã¼m ekibinin gÃ¼venliÄŸi tesis tarafÄ±ndan garanti altÄ±na alÄ±nacaktÄ±r.</p>
        
        <p><strong>6.</strong> Ã–lÃ§Ã¼m sÄ±rasÄ±nda kaynak normal Ã§alÄ±ÅŸma ÅŸartlarÄ±nda olacaktÄ±r. Kaynak durmasÄ± veya anormal Ã§alÄ±ÅŸma durumunda Ã¶lÃ§Ã¼m ertelenecektir.</p>
        
        <p><strong>7.</strong> Ã–lÃ§Ã¼m sÄ±rasÄ±nda meydana gelebilecek kazalardan laboratuvarÄ±mÄ±z sorumlu deÄŸildir. Tesiste Ä°SG prosedÃ¼rlerine uygun Ã§alÄ±ÅŸma ÅŸartlarÄ± saÄŸlanmalÄ±dÄ±r.</p>
        
        <p><strong>8.</strong> Elektrik kesintilerinin, mekanik arÄ±zalarÄ±n veya hava koÅŸullarÄ±nÄ±n Ã¶lÃ§Ã¼m yapÄ±lmasÄ±na engel olmasÄ± durumunda Ã¶lÃ§Ã¼mler ileri bir tarihe ertelenebilir. Bu durumda ek Ã¼cret talep edilmez.</p>
        
        <p><strong>9.</strong> Firmadan kaynaklÄ± Ã¶lÃ§Ã¼m erteleme durumlarÄ±nda (tesis bakÄ±mda, tesis Ã§alÄ±ÅŸmÄ±yor vb.) ekibimiz Ã§alÄ±ÅŸma noktasÄ±na geldikten sonra Ã¶lÃ§Ã¼m yapÄ±lamaz ise ulaÅŸÄ±m bedeli + 1 personel gÃ¼nlÃ¼k Ã§alÄ±ÅŸma Ã¼creti tahsil edilecektir.</p>
        
        <p><strong>10.</strong> Ã–lÃ§Ã¼m sÄ±rasÄ±nda kaynak parametreleri (sÄ±caklÄ±k, basÄ±nÃ§, debi vb.) tesis tarafÄ±ndan laboratuvar ekibine bildirilecektir.</p>
    </div>
    
    <div style="position: absolute; bottom: 15px; font-size: 9px; font-style: italic;">
        <div>Teklifimiz 30 GÃ¼n GeÃ§erlidir.</div>
        <div>Teklif imiz OnaylanmasÄ± Durumunda SÃ¶zleÅŸme NiteliÄŸindedir.</div>
        <div>FR 89 / 08.01.2024-10</div>
    </div>
</div>

<!-- SAYFA 5: RAPORLAMAYA AÄ°T BÄ°LGÄ°LER -->
<div class="pdf-page page-5" style="page-break-before: always;">
    <div style="text-align: right; font-size: 9px; margin-bottom: 20px;">
        <div>5 | S a y f a</div>
        <div>Teklif NumarasÄ± | <span class="pdf-teklif-no-copy"></span></div>
        <div>Tarih | <span class="pdf-tarih-copy"></span></div>
    </div>
    
    <h3 style="text-align: center; font-size: 13px; font-weight: bold; margin-bottom: 20px;">
        RAPORLAMAYA AÄ°T BÄ°LGÄ°LER
    </h3>
    
    <div style="font-size: 10px; line-height: 1.6; text-align: justify;">
        <p><strong>1.</strong> Ã–lÃ§Ã¼mlerin tamamlanmasÄ±nÄ± takiben, numune analizleri laboratuvarÄ±mÄ±zda gerÃ§ekleÅŸtirilecek ve sonuÃ§lar rapor haline getirilecektir.</p>
        
        <p><strong>2.</strong> Rapor teslim sÃ¼resi, Ã¶lÃ§Ã¼m tarihinden itibaren en geÃ§ 15 iÅŸ gÃ¼nÃ¼dÃ¼r. (Tatil gÃ¼nleri ve resmi tatiller hariÃ§)</p>
        
        <p><strong>3.</strong> Acil rapor talebi durumunda ek Ã¼cret karÅŸÄ±lÄ±ÄŸÄ±nda rapor sÃ¼resi kÄ±saltÄ±labilir.</p>
        
        <p><strong>4.</strong> Raporlar elektronik ortamda PDF formatÄ±nda teslim edilecektir. Talep edilmesi durumunda Ä±slak imzalÄ± orijinal rapor kargo ile gÃ¶nderilebilir (kargo Ã¼creti ayrÄ±ca tahsil edilir).</p>
        
        <p><strong>5.</strong> Raporlarda Ã¶lÃ§Ã¼m sonuÃ§larÄ±, yasal limit deÄŸerler, kullanÄ±lan standartlar ve akreditasyon bilgileri yer alacaktÄ±r.</p>
        
        <p><strong>6.</strong> Rapor onaylandÄ±ktan sonra iÃ§eriÄŸinde deÄŸiÅŸiklik yapÄ±lmaz. Ancak raporda teknik hata tespit edilmesi durumunda dÃ¼zeltme raporu dÃ¼zenlenir.</p>
        
        <p><strong>7.</strong> RaporlarÄ±n geÃ§erlilik sÃ¼resi dÃ¼zenlenme tarihinden itibaren 1 yÄ±ldÄ±r.</p>
        
        <p><strong>8.</strong> Rapor kopyalarÄ± mÃ¼ÅŸteri talebi Ã¼zerine ek Ã¼cret karÅŸÄ±lÄ±ÄŸÄ±nda temin edilebilir.</p>
        
        <p><strong>9.</strong> MELBES sistemine rapor yÃ¼kleme iÅŸlemi laboratuvarÄ±mÄ±z tarafÄ±ndan gerÃ§ekleÅŸtirilecektir.</p>
        
        <p><strong>10.</strong> Rapor sonuÃ§larÄ±na itiraz durumunda, numune saklama sÃ¼resi iÃ§inde (Ã¶lÃ§Ã¼m tarihinden itibaren 30 gÃ¼n) yeniden analiz talep edilebilir.</p>
    </div>
    
    <div style="position: absolute; bottom: 15px; font-size: 9px; font-style: italic;">
        <div>Teklifimiz 30 GÃ¼n GeÃ§erlidir.</div>
        <div>Teklif imiz OnaylanmasÄ± Durumunda SÃ¶zleÅŸme NiteliÄŸindedir.</div>
        <div>FR 89 / 08.01.2024-10</div>
    </div>
</div>

<!-- SAYFA 6: Ã–DEME ÅEKLÄ° -->
<div class="pdf-page page-6" style="page-break-before: always;">
    <div style="text-align: right; font-size: 9px; margin-bottom: 20px;">
        <div>6 | S a y f a</div>
        <div>Teklif NumarasÄ± | <span class="pdf-teklif-no-copy"></span></div>
        <div>Tarih | <span class="pdf-tarih-copy"></span></div>
    </div>
    
    <h3 style="text-align: center; font-size: 13px; font-weight: bold; margin-bottom: 20px;">
        Ã–DEME ÅEKLÄ°
    </h3>
    
    <div style="font-size: 10px; line-height: 1.6; text-align: justify;">
        <p><strong>1.</strong> FaturanÄ±z, Ã–lÃ§Ã¼mler tamamlandÄ±ktan sonra dÃ¼zenlenecektir.</p>
        
        <p><strong>2.</strong> Ã–deme, fatura tarihinden itibaren 30 gÃ¼n iÃ§inde aÅŸaÄŸÄ±daki banka hesaplarÄ±mÄ±zdan birine yapÄ±lacaktÄ±r.</p>
        
        <p><strong>3.</strong> Ã–deme yaparken lÃ¼tfen fatura numarasÄ±nÄ± aÃ§Ä±klama kÄ±smÄ±na yazÄ±nÄ±z.</p>
        
        <p><strong>4.</strong> Vadeli Ã¶deme talepleri deÄŸerlendirilerek ayrÄ±ca bildirilecektir.</p>
    </div>
    
    <div style="margin-top: 20px;">
        <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
            <thead>
                <tr style="background: #4472C4; color: white;">
                    <th style="border: 1px solid #000; padding: 8px;">FÄ°RMA ADI</th>
                    <th style="border: 1px solid #000; padding: 8px;">BANKA ADI</th>
                    <th style="border: 1px solid #000; padding: 8px;">BANKA KODU</th>
                    <th style="border: 1px solid #000; padding: 8px;">ÅUBE ADI VE Ä°LÄ°</th>
                    <th style="border: 1px solid #000; padding: 8px;">ÅUBE KODU</th>
                    <th style="border: 1px solid #000; padding: 8px;">IBAN NO</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="border: 1px solid #000; padding: 8px;">GÃ–ZDE Ã‡EVRE Ä°Å GÃœVENLÄ°ÄÄ° Ã–LÃ‡ÃœM TEST ANALÄ°Z LABORATUVAR SAN. TÄ°C. LTD. ÅTÄ°.</td>
                    <td style="border: 1px solid #000; padding: 8px;">DENÄ°ZBANK A.Å.</td>
                    <td style="border: 1px solid #000; padding: 8px;">134</td>
                    <td style="border: 1px solid #000; padding: 8px;">Ã‡ORLU ORION / TEKÄ°RDAÄ</td>
                    <td style="border: 1px solid #000; padding: 8px;">9380</td>
                    <td style="border: 1px solid #000; padding: 8px;">TR64 0013 4000 0228 8009 2000 01</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div style="margin-top: 60px; font-size: 10px;">
        <div style="border: 2px solid #000; padding: 40px; text-align: center;">
            <div style="font-weight: bold; font-size: 12px;">MÃœÅTERÄ° ONAYI</div>
            <div style="margin-top: 10px;">(Ä°mza / Tarih / Firma KaÅŸesi)</div>
        </div>
    </div>
    
    <div style="position: absolute; bottom: 15px; font-size: 9px; font-style: italic;">
        <div>Teklifimiz 30 GÃ¼n GeÃ§erlidir.</div>
        <div>Teklifimiz OnaylanmasÄ± Durumunda SÃ¶zleÅŸme NiteliÄŸindedir.</div>
        <div>FR 89 / 08.01.2024-10</div>
    </div>
</div>

</div>

<!-- INVOICES TAB -->
<div id="invoices" class="tab-content">
    <!-- ÃœST BAÅLIK VE BUTONLAR -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">ğŸ“„ Faturalar</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalInvoicesCount">0</strong> fatura kayÄ±tlÄ±</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="openImportInvoiceModal()" style="font-size: 16px; padding: 12px 25px;">
                ğŸ“¤ E-Fatura Ä°Ã§e Aktar (CSV)
            </button>
            <button class="btn btn-primary" onclick="scrollToInvoiceForm()" style="font-size: 16px; padding: 12px 25px;">
                â• Manuel Fatura Ekle
            </button>
        </div>
    </div>

    <!-- FATURA LÄ°STESÄ° (Ã–nce listeler gÃ¶sterilsin) -->
    <div class="card">
        <h3>ğŸ“‹ Fatura Listesi</h3>
        
        <!-- FÄ°LTRELER -->
        <div class="filters">
            <div class="grid-4">
                <div class="form-group">
                    <label>BaÅŸlangÄ±Ã§ Tarihi</label>
                    <input type="date" id="filterStartDate">
                </div>
                <div class="form-group">
                    <label>BitiÅŸ Tarihi</label>
                    <input type="date" id="filterEndDate">
                </div>
                <div class="form-group">
                    <label>Fatura TÃ¼rÃ¼</label>
                    <select id="filterType">
                        <option value="">TÃ¼mÃ¼</option>
                        <option value="sales">SatÄ±ÅŸ</option>
                        <option value="purchase">AlÄ±ÅŸ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ã–deme Durumu</label>
                    <select id="filterPaymentStatus">
                        <option value="">TÃ¼mÃ¼</option>
                        <option value="paid">Ã–dendi</option>
                        <option value="partial">KÄ±smi</option>
                        <option value="unpaid">Ã–denmedi</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-info" onclick="filterInvoices()">ğŸ” Filtrele</button>
            <button class="btn btn-warning" onclick="clearInvoiceFilters()">ğŸ”„ Temizle</button>
        </div>
        
        <table id="invoicesTable">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>No</th>
                    <th>TÃ¼r</th>
                    <th>Cari</th>
                    <th>Toplam</th>
                    <th>Ã–denen</th>
                    <th>Kalan</th>
                    <th>Durum</th>
                    <th>Ä°ÅŸlemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- MANUEL FATURA EKLEME FORMU (AÅŸaÄŸÄ±da) -->
    <div class="card" id="invoiceFormCard">
        <h3>â• Yeni Fatura Ekle (Manuel)</h3>
        <form id="invoiceForm">
                 <input type="hidden" id="invoiceId">
                        <div class="grid-4">
                            <div class="form-group">
                                <label>Fatura TÃ¼rÃ¼ *</label>
                                <select id="invoiceType" required>
                                    <option value="">SeÃ§iniz</option>
                                    <option value="sales">SatÄ±ÅŸ FaturasÄ±</option>
                                    <option value="purchase">AlÄ±ÅŸ FaturasÄ±</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Fatura No *</label>
                                <input type="text" id="invoiceNo" required>
                            </div>
                            <div class="form-group">
                                <label>Tarih *</label>
                                <input type="date" id="invoiceDate" required>
                            </div>
                            <div class="form-group">
                                <label>Vade Tarihi</label>
                                <input type="date" id="invoiceDueDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Cari Hesap *</label>
                            <select id="invoiceAccount" required>
                                <option value="">SeÃ§iniz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>AÃ§Ä±klama</label>
                            <textarea id="invoiceDescription" rows="2"></textarea>
                        </div>

                        <div class="invoice-items">
                            <h4 style="margin-bottom:15px;">Fatura Kalemleri</h4>
                            <div id="invoiceItemsList"></div>
                            <button type="button" class="btn btn-success" onclick="addInvoiceItem()">â• Kalem Ekle</button>
                        </div>

                        <div class="grid-3" style="margin-top: 20px;">
                            <div class="stat-card">
                                <h4>Ara Toplam</h4>
                                <div class="amount" id="invoiceSubtotal">0.00 â‚º</div>
                            </div>
                            <div class="stat-card warning">
                                <h4>KDV</h4>
                                <div class="amount" id="invoiceVAT">0.00 â‚º</div>
                            </div>
                            <div class="stat-card success">
                                <h4>Genel Toplam</h4>
                                <div class="amount" id="invoiceTotal">0.00 â‚º</div>
                            </div>
                        </div>

            <!-- âœ… BURAYA EKLE - FATURA DEKONTI YÃœKLEME -->
            <div class="form-group" style="margin-top: 20px;">
                <label>ğŸ“ Fatura DekontÄ± (Opsiyonel - Maks 5 MB)</label>
                <input type="file" id="invoiceReceipt" accept="image/*,.pdf" onchange="handleInvoiceReceipt(this)">
                <div id="invoiceReceiptPreview" style="margin-top: 10px;"></div>
            </div>
            <!-- âœ… BURAYA KADAR -->

                        <button type="submit" class="btn btn-primary" style="margin-top: 20px;" id="saveInvoiceBtn">ğŸ’¾ Fatura Kaydet</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelInvoiceEdit()" id="cancelInvoiceBtn" style="display:none;">âœ–ï¸ Ä°ptal</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Fatura Listesi</h3>
                    <div class="filters">
                        <div class="grid-4">
                            <div class="form-group">
                                <label>BaÅŸlangÄ±Ã§ Tarihi</label>
                                <input type="date" id="filterStartDate">
                            </div>
                            <div class="form-group">
                                <label>BitiÅŸ Tarihi</label>
                                <input type="date" id="filterEndDate">
                            </div>
                            <div class="form-group">
                                <label>Fatura TÃ¼rÃ¼</label>
                                <select id="filterType">
                                    <option value="">TÃ¼mÃ¼</option>
                                    <option value="sales">SatÄ±ÅŸ</option>
                                    <option value="purchase">AlÄ±ÅŸ</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ã–deme Durumu</label>
                                <select id="filterPaymentStatus">
                                    <option value="">TÃ¼mÃ¼</option>
                                    <option value="paid">Ã–dendi</option>
                                    <option value="partial">KÄ±smi</option>
                                    <option value="unpaid">Ã–denmedi</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-info" onclick="filterInvoices()">ğŸ” Filtrele</button>
                        <button class="btn btn-warning" onclick="clearInvoiceFilters()">ğŸ”„ Temizle</button>
                    </div>
                    <table id="invoicesTable">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>No</th>
                                <th>TÃ¼r</th>
                                <th>Cari</th>
                                <th>Toplam</th>
                                <th>Ã–denen</th>
                                <th>Kalan</th>
                                <th>Durum</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- PAYMENTS TAB -->
            <div id="payments" class="tab-content">
                <div class="card">
                    <h3>ğŸ’° Ã–deme ve Tahsilat YÃ¶netimi</h3>
                    
                    <div class="grid-2">
                        <div class="file-upload-area" onclick="document.getElementById('bankFileInput').click()" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
                            <h3>ğŸ“¤ Banka Ã–zeti YÃ¼kle</h3>
                            <p style="margin: 10px 0; color: #6b7280;">Excel veya CSV dosyanÄ±zÄ± sÃ¼rÃ¼kleyin veya tÄ±klayÄ±n</p>
                            <p style="font-size: 0.9em; color: #9ca3af;">Desteklenen format: Ziraat BankasÄ±, Excel, CSV</p>
                            <input type="file" id="bankFileInput" accept=".xlsx,.xls,.csv" style="display:none;" onchange="importBankStatement(event)">
                        </div>

                        <div style="background: var(--light); padding: 20px; border-radius: 8px;">
                            <h3>â• Manuel Ã–deme Ekle</h3>
                            <button class="btn btn-primary" onclick="openPaymentModal()" style="margin-top: 15px; width: 100%;">Yeni Ã–deme/Tahsilat</button>
                            <div style="margin-top: 15px; font-size: 0.9em; color: #6b7280;">
                                <p>âœ“ HÄ±zlÄ± Ã¶deme kaydÄ±</p>
                                <p>âœ“ Faturaya baÄŸlama</p>
                                <p>âœ“ KÄ±smi Ã¶deme desteÄŸi</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Ã–deme GeÃ§miÅŸi</h3>
                    <div class="filters">
                        <div class="grid-3">
                            <div class="form-group">
                                <label>BaÅŸlangÄ±Ã§ Tarihi</label>
                                <input type="date" id="paymentFilterStart">
                            </div>
                            <div class="form-group">
                                <label>BitiÅŸ Tarihi</label>
                                <input type="date" id="paymentFilterEnd">
                            </div>
                            <div class="form-group">
                                <label>Cari</label>
                                <select id="paymentFilterAccount">
                                    <option value="">TÃ¼mÃ¼</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-info" onclick="filterPayments()">ğŸ” Filtrele</button>
                        <button class="btn btn-warning" onclick="clearPaymentFilters()">ğŸ”„ Temizle</button>
                    </div>
                    <table id="paymentsTable">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Cari</th>
                                <th>Tutar</th>
                                <th>Tip</th>
                                <th>Fatura</th>
                                <th>AÃ§Ä±klama</th>
                                <th>Kaynak</th>
                                <th>Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTS TAB -->
            <div id="reports" class="tab-content">
                <div class="card">
                    <h3>Rapor Parametreleri</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>YÄ±l</label>
                            <select id="reportYear">
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ay</label>
                            <select id="reportMonth">
                                <option value="">TÃ¼m YÄ±l</option>
                                <option value="01">Ocak</option>
                                <option value="02">Åubat</option>
                                <option value="03">Mart</option>
                                <option value="04">Nisan</option>
                                <option value="05">MayÄ±s</option>
                                <option value="06">Haziran</option>
                                <option value="07">Temmuz</option>
                                <option value="08">AÄŸustos</option>
                                <option value="09">EylÃ¼l</option>
                                <option value="10">Ekim</option>
                                <option value="11">KasÄ±m</option>
                                <option value="12">AralÄ±k</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="generateReport()">ğŸ“Š Rapor OluÅŸtur</button>
                        </div>
                    </div>
                </div>

                <div id="reportResults"></div>

                <div class="card">
                    <h3>Cari Ekstre</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Cari SeÃ§iniz</label>
                            <select id="statementAccount">
                                <option value="">SeÃ§iniz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>BaÅŸlangÄ±Ã§ Tarihi</label>
                            <input type="date" id="statementStartDate">
                        </div>
                        <div class="form-group">
                            <label>BitiÅŸ Tarihi</label>
                            <input type="date" id="statementEndDate">
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="generateStatement()">ğŸ“‹ Ekstre GÃ¶rÃ¼ntÃ¼le</button>
                    <div id="statementResults"></div>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div id="settings" class="tab-content">
                <div class="card">
                    <h3>Veri YÃ¶netimi</h3>
                    <div class="export-section">
                        <h4>ğŸ’¾ Yedekleme ve Geri YÃ¼kleme</h4>
                        <p>TÃ¼m verilerinizi yedekleyin veya Ã¶nceki bir yedekten geri yÃ¼kleyin.</p>
                        <button class="btn btn-success" onclick="exportData()">ğŸ“¥ Verileri DÄ±ÅŸa Aktar</button>
                        <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">ğŸ“¤ Verileri Ä°Ã§e Aktar</button>
                        <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
                    </div>
                </div>

<div class="card">
    <h3>ğŸ”§ Bakiye DÃ¼zeltme</h3>
    <p>Cari hesap bakiyelerini fatura ve Ã¶demelere gÃ¶re yeniden hesaplar.</p>
    <button class="btn btn-warning" onclick="recalculateAccountBalances()">
        ğŸ”„ Bakiyeleri Yeniden Hesapla
    </button>
</div>

<div class="card">
    <h3>ğŸ”„ Duplicate Cari Temizleme</h3>
    <p>AynÄ± isim ve vergi numaralÄ± cari hesaplarÄ± bulur ve birleÅŸtirir.</p>
    <button class="btn btn-warning" onclick="findAndMergeDuplicateAccounts()">
        ğŸ” Duplicate Carileri Bul ve BirleÅŸtir
    </button>
</div>

<div class="card">
    <h3>MaaÅŸ Hesaplama Tablosu (CSV YÃ¼kle)</h3>
    <div style="margin-bottom:15px;">
        <input type="file" id="salaryTableCSV" accept=".csv" onchange="handleSalaryCSVUpload(event)">
        <button class="btn btn-info" onclick="downloadSalaryExample()">ğŸ“¥ Ã–rnek CSV Ä°ndir</button>
        <span id="salaryTableStatus" style="margin-left:10px; color:green;"></span>
    </div>
</div>

                <div class="card">
                    <h3>âš ï¸ Tehlikeli Ä°ÅŸlemler</h3>
                    <div class="alert alert-info">
                        <strong>UyarÄ±:</strong> AÅŸaÄŸÄ±daki iÅŸlemler geri alÄ±namaz. Devam etmeden Ã¶nce verilerinizi yedeklediÄŸinizden emin olun.
                    </div>
                    <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ TÃ¼m Verileri Sil</button>
                </div>

<div class="card">
    <h3>ğŸ—‘ï¸ Ã‡Ã¶p Kutusu</h3>
    <p>Son 30 gÃ¼n iÃ§inde silinen faturalar buradan geri yÃ¼klenebilir.</p>
    <button class="btn btn-info" onclick="showTrashModal()">
        ğŸ“‹ Ã‡Ã¶p Kutusunu GÃ¶rÃ¼ntÃ¼le
    </button>
</div>

                <div class="card">
                    <h3>â„¹ï¸ HakkÄ±nda</h3>
                    <p><strong>Muhasebe Takip Sistemi v2.0</strong></p>
                    <p>âœ… Ã‡oklu firma desteÄŸi</p>
                    <p>âœ… GeliÅŸmiÅŸ Ã¶deme takibi</p>
                    <p>âœ… Banka Ã¶zeti import</p>
                    <p>âœ… AkÄ±llÄ± eÅŸleÅŸtirme</p>
                    <p>âœ… Vade takibi</p>
                    <p>âœ… KÄ±smi Ã¶deme desteÄŸi</p>
                    <p style="margin-top: 15px; color: #6b7280;">Veriler LocalStorage'da gÃ¼venle saklanÄ±r.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ğŸ’° Yeni Ã–deme/Tahsilat</h3>
                <button class="close-modal" onclick="closePaymentModal()">âœ–</button>
            </div>
            <form id="paymentForm">
                <input type="hidden" id="paymentId">
                <div class="form-group">
                    <label>Tarih *</label>
                    <input type="date" id="paymentDate" required>
                </div>
                <div class="form-group">
                    <label>Cari *</label>
                    <select id="paymentAccount" required onchange="loadAccountInvoices()">
                        <option value="">SeÃ§iniz</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tutar *</label>
                    <input type="number" id="paymentAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Tip *</label>
                    <select id="paymentType" required>
                        <option value="income">Tahsilat (Gelen)</option>
                        <option value="expense">Ã–deme (Giden)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Faturaya BaÄŸla</label>
                    <select id="paymentInvoice">
                        <option value="">Genel Ã–deme (Fatura Yok)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>AÃ§Ä±klama</label>
                    <textarea id="paymentDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ğŸ’¾ Kaydet</button>
                <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">âœ–ï¸ Ä°ptal</button>
            </form>
        </div>
    </div>

<!-- Ã–DEME DÃœZENLEME MODAL -->
<div id="editPaymentModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>âœï¸ Ã–deme DÃ¼zenle</h3>
            <button class="close-modal" onclick="closeEditPaymentModal()">âœ–</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="editPaymentForm">
                <input type="hidden" id="editPaymentId">
                
                <!-- Ã–deme Bilgileri (Salt Okunur) -->
                <div class="alert alert-info">
                    <strong>ğŸ’° Ã–deme Bilgileri</strong>
                    <div style="margin-top: 10px;">
                        <p><strong>Tutar:</strong> <span id="editPaymentAmount" style="font-size:1.3em; color:var(--primary);"></span></p>
                        <p><strong>Tarih:</strong> <span id="editPaymentDate"></span></p>
                        <p><strong>Kaynak:</strong> <span id="editPaymentSource"></span></p>
                    </div>
                </div>
                
                <!-- Cari Hesap (DeÄŸiÅŸtirilebilir) -->
                <div class="form-group">
                    <label>ğŸ‘¤ Cari Hesap *</label>
                    <select id="editPaymentAccount" required onchange="loadEditPaymentInvoices()">
                        <option value="">SeÃ§iniz</option>
                    </select>
                </div>
                
                <!-- Faturaya BaÄŸla -->
                <div class="form-group">
                    <label>ğŸ“„ Faturaya BaÄŸla (Opsiyonel)</label>
                    <select id="editPaymentInvoice">
                        <option value="">Genel Ã–deme (Fatura Yok)</option>
                    </select>
                    <small style="color:#6b7280; display:block; margin-top:5px;">
                        EÄŸer bu Ã¶deme belirli bir faturaya aitse, yukarÄ±dan seÃ§in.
                    </small>
                </div>
                
                <!-- AÃ§Ä±klama -->
                <div class="form-group">
                    <label>ğŸ“ AÃ§Ä±klama</label>
                    <textarea id="editPaymentDescription" rows="3"></textarea>
                </div>
                
                <!-- Ä°ÅŸlem Tipi (Otomatik belirlenir ama deÄŸiÅŸtirilebilir) -->
                <div class="form-group">
                    <label>ğŸ”„ Ä°ÅŸlem Tipi</label>
                    <select id="editPaymentType">
                        <option value="income">ğŸ“¥ Tahsilat (Gelen)</option>
                        <option value="expense">ğŸ“¤ Ã–deme (Giden)</option>
                    </select>
                </div>
                
                <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditPaymentModal()">
                        âœ–ï¸ Ä°ptal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ğŸ’¾ Ã–demeyi GÃ¼ncelle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- BANK IMPORT MODAL -->
    <div id="bankImportModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>ğŸ“¤ Banka Ã–zeti EÅŸleÅŸtirme</h3>
                <button class="close-modal" onclick="closeBankImportModal()">âœ–</button>
            </div>
            <div id="bankImportContent"></div>
        </div>
    </div>

<!-- Transaction Details Modal -->
<div id="transactionDetailsModal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
">
    <div style="
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    ">
        <!-- Header -->
        <div style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        ">
            <h3 style="margin: 0; font-size: 20px;">ğŸ’° Banka Ä°ÅŸlemleri</h3>
            <button onclick="closeTransactionDetailsModal()" style="
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.3s;
            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
               onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                Ã—
            </button>
        </div>

        <!-- Scrollable Content -->
        <div id="transactionDetailsContainer" style="
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        ">
            <!-- Transactions will be inserted here -->
        </div>

        <!-- Footer -->
        <div style="
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        ">
            <button onclick="closeTransactionDetailsModal()" style="
                padding: 10px 20px;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            ">
                Ä°ptal
            </button>
            <button onclick="saveAllTransactions()" style="
                padding: 10px 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
            ">
                ğŸ’¾ TÃ¼mÃ¼nÃ¼ Kaydet
            </button>
        </div>
    </div>
</div>

<!-- CARI HESAP KARTI MODAL -->
<div id="accountCardModal" class="modal">
    <div class="modal-content" style="max-width: 1200px; max-height: 95vh;">
        <div class="modal-header">
            <h3 id="accountCardTitle">ğŸ“Š Cari Hesap KartÄ±</h3>
            <button class="close-modal" onclick="closeAccountCardModal()">âœ–</button>
        </div>
        
        <div style="padding: 20px;">
            <!-- Cari Bilgileri -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="grid-3">
                    <div>
                        <strong>Cari AdÄ±:</strong>
                        <p id="cardAccountName" style="font-size: 1.2em; color: var(--primary); margin-top: 5px;">-</p>
                    </div>
                    <div>
                        <strong>TÃ¼r:</strong>
                        <p id="cardAccountType" style="margin-top: 5px;">-</p>
                    </div>
                    <div>
                        <strong>GÃ¼ncel Bakiye:</strong>
                        <p id="cardAccountBalance" style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">-</p>
                    </div>
                </div>
                <div class="grid-3" style="margin-top: 15px;">
                    <div>
                        <strong>Telefon:</strong>
                        <p id="cardAccountPhone" style="margin-top: 5px;">-</p>
                    </div>
                    <div>
                        <strong>Email:</strong>
                        <p id="cardAccountEmail" style="margin-top: 5px;">-</p>
                    </div>
                    <div>
                        <strong>Vergi No:</strong>
                        <p id="cardAccountTaxNo" style="margin-top: 5px;">-</p>
                    </div>
                </div>
            </div>

            <!-- Filtreler -->
            <div class="filters" style="margin-bottom: 20px;">
                <div class="grid-4">
                    <div class="form-group">
                        <label>ğŸ“… YÄ±l</label>
                        <select id="cardFilterYear" onchange="filterAccountCard()">
                            <option value="">TÃ¼m YÄ±llar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ğŸ“† BaÅŸlangÄ±Ã§ Tarihi</label>
                        <input type="date" id="cardFilterStartDate" onchange="filterAccountCard()">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“† BitiÅŸ Tarihi</label>
                        <input type="date" id="cardFilterEndDate" onchange="filterAccountCard()">
                    </div>
                    <div class="form-group">
                        <label>ğŸ“‹ Ä°ÅŸlem Tipi</label>
                        <select id="cardFilterType" onchange="filterAccountCard()">
                            <option value="">TÃ¼mÃ¼</option>
                            <option value="invoice">Sadece Faturalar</option>
                            <option value="payment">Sadece Ã–demeler</option>
                            <option value="income">Sadece Gelirler (Tahsilat)</option>
                            <option value="expense">Sadece Giderler (Ã–deme)</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-warning" onclick="clearAccountCardFilters()">ğŸ”„ Filtreleri Temizle</button>
                <button class="btn btn-success" onclick="exportAccountCard()">ğŸ“¥ Excel'e Aktar</button>
		<button class="btn btn-success" onclick="matchOldDataWithNewAccount(currentAccountCardId)">ğŸ”— Eski Verilerle EÅŸleÅŸtir</button>
            </div>

            <!-- Ã–zet Ä°statistikler -->
            <div class="grid-4" style="margin-bottom: 20px;" id="cardStats">
                <div class="stat-card success">
                    <h4>Toplam Gelir</h4>
                    <div class="amount" id="cardTotalIncome">0.00 â‚º</div>
                    <small id="cardIncomeCount">0 iÅŸlem</small>
                </div>
                <div class="stat-card danger">
                    <h4>Toplam Gider</h4>
                    <div class="amount" id="cardTotalExpense">0.00 â‚º</div>
                    <small id="cardExpenseCount">0 iÅŸlem</small>
                </div>
                <div class="stat-card warning">
                    <h4>Fatura ToplamÄ±</h4>
                    <div class="amount" id="cardTotalInvoices">0.00 â‚º</div>
                    <small id="cardInvoiceCount">0 fatura</small>
                </div>
                <div class="stat-card info">
                    <h4>Net Bakiye</h4>
                    <div class="amount" id="cardNetBalance">0.00 â‚º</div>
                    <small>Gelir - Gider</small>
                </div>
            </div>

            <!-- Ä°ÅŸlem Listesi -->
            <div style="overflow-y: auto; max-height: 400px;">
                <table id="accountCardTable">
                    <thead style="position: sticky; top: 0; background: var(--primary); z-index: 10;">
                        <tr>
                            <th>Tarih</th>
                            <th>Ä°ÅŸlem Tipi</th>
                            <th>Referans</th>
                            <th>AÃ§Ä±klama</th>
                            <th>BorÃ§</th>
                            <th>Alacak</th>
                            <th>Bakiye</th>
                            <th>Ä°ÅŸlem</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- DÃ–KÃœMAN GÃ–RÃœNTÃœLEME MODAL -->
<div id="documentsModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="documentsModalTitle">ğŸ“ DÃ¶kÃ¼manlar</h3>
            <button class="close-modal" onclick="closeDocumentsModal()">âœ–</button>
        </div>
        
        <div style="padding: 20px;">
            <div id="documentsListView"></div>
        </div>
    </div>
</div>

<!-- DÃ–KÃœMAN DETAY MODAL (PDF/Resim GÃ¶rÃ¼ntÃ¼leme) -->
<div id="documentViewerModal" class="modal">
    <div class="modal-content" style="max-width: 1000px; max-height: 95vh;">
        <div class="modal-header">
            <h3 id="documentViewerTitle">ğŸ“„ DÃ¶kÃ¼man GÃ¶rÃ¼ntÃ¼le</h3>
            <button class="close-modal" onclick="closeDocumentViewer()">âœ–</button>
        </div>
        
        <div style="padding: 20px; overflow: auto; max-height: calc(95vh - 100px);">
            <div id="documentViewerContent" style="text-align: center;"></div>
        </div>
        
        <div style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #dee2e6; text-align: center;">
            <button class="btn btn-success" onclick="downloadCurrentDocument()">
                ğŸ“¥ Ä°ndir
            </button>
            <button class="btn btn-secondary" onclick="closeDocumentViewer()">
                âœ–ï¸ Kapat
            </button>
        </div>
    </div>
</div>

<!-- FÄ°RMA DETAY GÃ–RÃœNTÃœLEME MODAL -->
<div id="companyDetailModal" class="modal">
    <div class="modal-content" style="max-width: 1000px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="companyDetailTitle">ğŸ¢ Firma DetaylarÄ±</h3>
            <button class="close-modal" onclick="closeCompanyDetailModal()">âœ–</button>
        </div>
        
        <div style="padding: 30px;">
            <!-- Firma Ã–zet KartÄ± -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                <div class="grid-2">
                    <div>
                        <h2 id="detailCompanyName" style="margin: 0 0 10px 0; color: white;">-</h2>
                        <p id="detailCompanySector" style="margin: 0; opacity: 0.9;">-</p>
                    </div>
                    <div style="text-align: right;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; display: inline-block;">
                            <div style="font-size: 0.9em; opacity: 0.9;">Toplam Cari Hesap</div>
                            <div id="detailAccountCount" style="font-size: 2.5em; font-weight: 700; margin-top: 5px;">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Temel Bilgiler -->
            <div class="card">
                <h3 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px;">
                    ğŸ“‹ Temel Bilgiler
                </h3>
                <div class="grid-2">
                    <div>
                        <p><strong>ğŸ¢ Firma ÃœnvanÄ±:</strong></p>
                        <p id="detailCompanyNameFull" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                    <div>
                        <p><strong>ğŸ­ SektÃ¶r:</strong></p>
                        <p id="detailCompanySectorFull" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                </div>
            </div>

            <!-- Vergi Bilgileri -->
            <div class="card">
                <h3 style="color: var(--warning); border-bottom: 2px solid var(--warning); padding-bottom: 10px; margin-bottom: 20px;">
                    ğŸ’¼ Vergi Bilgileri
                </h3>
                <div class="grid-2">
                    <div>
                        <p><strong>Vergi NumarasÄ±:</strong></p>
                        <p id="detailCompanyTaxNo" style="color: #1f2937; font-size: 1.1em; font-family: monospace;">-</p>
                    </div>
                    <div>
                        <p><strong>Vergi Dairesi:</strong></p>
                        <p id="detailCompanyTaxOffice" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                </div>
            </div>

            <!-- Ä°letiÅŸim Bilgileri -->
            <div class="card">
                <h3 style="color: var(--success); border-bottom: 2px solid var(--success); padding-bottom: 10px; margin-bottom: 20px;">
                    ğŸ“ Ä°letiÅŸim Bilgileri
                </h3>
                <div class="grid-3">
                    <div>
                        <p><strong>ğŸ“± Telefon:</strong></p>
                        <p id="detailCompanyPhone" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                    <div>
                        <p><strong>ğŸ“§ Email:</strong></p>
                        <p id="detailCompanyEmail" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                    <div>
                        <p><strong>ğŸŒ Website:</strong></p>
                        <p id="detailCompanyWebsite" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <p><strong>ğŸ“ Adres:</strong></p>
                    <p id="detailCompanyAddress" style="color: #1f2937; font-size: 1.1em; line-height: 1.6;">-</p>
                </div>
            </div>

            <!-- DÃ¶kÃ¼manlar -->
            <div class="card" id="detailCompanyDocumentsCard" style="display: none;">
                <h3 style="color: var(--info); border-bottom: 2px solid var(--info); padding-bottom: 10px; margin-bottom: 20px;">
                    ğŸ“ DÃ¶kÃ¼manlar
                </h3>
                <div id="detailCompanyDocuments"></div>
            </div>

            <!-- KayÄ±t LoglarÄ± -->
            <div class="card" style="background: #f9fafb;">
                <h3 style="color: #6b7280; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 20px;">
                    ğŸ“ KayÄ±t Bilgileri
                </h3>
                <div class="grid-2">
                    <div>
                        <p><strong>OluÅŸturulma:</strong></p>
                        <p id="detailCompanyCreated" style="color: #1f2937;">-</p>
                    </div>
                    <div>
                        <p><strong>Son GÃ¼ncelleme:</strong></p>
                        <p id="detailCompanyUpdated" style="color: #1f2937;">-</p>
                    </div>
                </div>
            </div>

            <!-- Finansal Ã–zet -->
            <div class="card">
                <h3 style="color: var(--purple); border-bottom: 2px solid var(--purple); padding-bottom: 10px; margin-bottom: 20px;">
                    ğŸ’° Finansal Ã–zet
                </h3>
                <div class="grid-4">
                    <div class="stat-card success">
                        <h4>Toplam Gelir</h4>
                        <div class="amount" id="detailTotalIncome">0.00 â‚º</div>
                        <small id="detailIncomeInvoices">0 fatura</small>
                    </div>
                    <div class="stat-card danger">
                        <h4>Toplam Gider</h4>
                        <div class="amount" id="detailTotalExpense">0.00 â‚º</div>
                        <small id="detailExpenseInvoices">0 fatura</small>
                    </div>
                    <div class="stat-card">
                        <h4>Net Kar/Zarar</h4>
                        <div class="amount" id="detailNetProfit">0.00 â‚º</div>
                    </div>
                    <div class="stat-card warning">
                        <h4>Toplam Ã–deme</h4>
                        <div class="amount" id="detailTotalPayments">0.00 â‚º</div>
                        <small id="detailPaymentCount">0 Ã¶deme</small>
                    </div>
                </div>
            </div>

            <!-- Cari Hesaplar Listesi -->
            <div class="card">
                <h3 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px;">
                    ğŸ‘¥ Cari Hesaplar
                </h3>
                <div id="detailCompanyAccountsList"></div>
            </div>

            <!-- Ä°ÅŸlem ButonlarÄ± -->
            <div style="margin-top: 30px; text-align: center; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <button class="btn btn-warning" onclick="editCompanyFromDetail()">
                    âœï¸ DÃ¼zenle
                </button>
                <button class="btn btn-success" onclick="viewCompanyAccountsFromDetail()">
                    ğŸ‘¥ Cari Hesaplara Git
                </button>
                <button class="btn btn-info" onclick="viewCompanyDocumentsFromDetail()" id="detailViewDocsBtn" style="display: none;">
                    ğŸ“ DÃ¶kÃ¼manlarÄ± GÃ¶rÃ¼ntÃ¼le
                </button>
                <button class="btn btn-secondary" onclick="closeCompanyDetailModal()">
                    âœ–ï¸ Kapat
                </button>
            </div>
        </div>
    </div>
</div>

<!-- E-FATURA Ä°Ã‡E AKTARMA MODAL -->
<div id="importInvoiceModal" class="modal">
    <div class="modal-content" style="max-width: 1200px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3>ğŸ“¤ E-Fatura Ä°Ã§e Aktarma (Excel/CSV)</h3>
            <button class="close-modal" onclick="closeImportInvoiceModal()">âœ–</button>
        </div>
        
        <div style="padding: 30px;">
            <!-- YÃ¼kleme AlanÄ± -->
            <div class="alert alert-info">
                <strong>â„¹ï¸ E-Fatura FormatÄ± HakkÄ±nda</strong>
                <p style="margin: 10px 0 0 0; font-size: 0.95em;">
                    E-Fatura sisteminizden aldÄ±ÄŸÄ±nÄ±z <strong>CSV</strong> veya <strong>Excel</strong> dosyasÄ±nÄ± yÃ¼kleyin.<br>
                    Sistem otomatik olarak fatura bilgilerini okuyacak ve <strong>cari hesaplarla eÅŸleÅŸtirecektir</strong>.
                </p>
            </div>

            <!-- Fatura TÃ¼rÃ¼ SeÃ§imi -->
            <div class="card" style="margin-bottom: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">ğŸ“‹ Fatura TÃ¼rÃ¼ SeÃ§in</h4>
                <div style="display: flex; gap: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; flex: 1; transition: all 0.3s;">
                        <input type="radio" name="invoiceImportType" value="sales" checked onchange="updateInvoiceTypeSelection()" style="margin-right: 10px; width: 20px; height: 20px;">
                        <div>
                            <strong style="color: var(--success); font-size: 1.1em;">ğŸ“— Giden Fatura (SatÄ±ÅŸ)</strong>
                            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">MÃ¼ÅŸterilerinize dÃ¼zenlenen faturalar</p>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; flex: 1; transition: all 0.3s;">
                        <input type="radio" name="invoiceImportType" value="purchase" onchange="updateInvoiceTypeSelection()" style="margin-right: 10px; width: 20px; height: 20px;">
                        <div>
                            <strong style="color: var(--danger); font-size: 1.1em;">ğŸ“• Gelen Fatura (AlÄ±ÅŸ)</strong>
                            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">TedarikÃ§ilerinizden gelen faturalar</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Dosya YÃ¼kleme -->
            <div class="file-upload-area" 
                 onclick="document.getElementById('invoiceExcelFile').click()" 
                 ondragover="handleDragOver(event)" 
                 ondrop="handleInvoiceExcelDrop(event)"
                 style="cursor: pointer;">
                <h3>ğŸ“‚ CSV/Excel DosyasÄ±nÄ± YÃ¼kle</h3>
                <p style="margin: 10px 0; color: #6b7280;">DosyanÄ±zÄ± sÃ¼rÃ¼kleyin veya tÄ±klayÄ±n</p>
                <p style="font-size: 0.9em; color: #9ca3af;">Desteklenen format: .csv, .xlsx, .xls</p>
                <input type="file" 
                       id="invoiceExcelFile" 
                       accept=".csv,.xlsx,.xls" 
                       style="display:none;" 
                       onchange="importInvoiceExcel(event)">
            </div>

            <!-- Ã–rnek Format GÃ¶sterimi -->
            <div class="card" style="margin-top: 20px; background: #f9fafb;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">ğŸ“‹ Beklenen Format (E-Fatura Standart)</h4>
                <p style="font-size: 0.9em; color: #6b7280; margin-bottom: 10px;">
                    CSV/Excel dosyanÄ±zda ÅŸu sÃ¼tunlar olmalÄ±dÄ±r:
                </p>
                <div style="overflow-x: auto;">
                    <table style="font-size: 0.85em; width: 100%;">
                        <thead style="background: var(--primary); color: white;">
                            <tr>
                                <th>AlÄ±cÄ± AdÄ±</th>
                                <th>Fatura NumarasÄ±</th>
                                <th>Fatura Tarihi</th>
                                <th>OluÅŸturma Tarihi</th>
                                <th>Senaryo</th>
                                <th>Durum</th>
                                <th>Tutar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Ã–RNEK FÄ°RMA A.Å.</td>
                                <td>NRC2025000000369</td>
                                <td>30.09.2025</td>
                                <td>19.09.2025</td>
                                <td>TICARIFATURA</td>
                                <td>GÃ¶nderildi</td>
                                <td>10737,6</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FATURA EÅLEÅTÄ°RME MODAL -->
<div id="invoiceMatchModal" class="modal">
    <div class="modal-content" style="max-width: 1400px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="invoiceMatchTitle">ğŸ”„ Fatura EÅŸleÅŸtirme</h3>
            <button class="close-modal" onclick="closeInvoiceMatchModal()">âœ–</button>
        </div>
        
        <div style="padding: 20px;">
            <div class="alert alert-success" id="invoiceMatchSummary">
                <strong>âœ… <span id="matchedInvoiceCount">0</span> fatura baÅŸarÄ±yla okundu!</strong>
            </div>

            <!-- EÅŸleÅŸtirme Listesi -->
            <div id="invoiceMatchList"></div>

            <!-- Alt Butonlar -->
            <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <button class="btn btn-secondary" onclick="closeInvoiceMatchModal()">
                    âœ–ï¸ Ä°ptal
                </button>
                <button class="btn btn-success" onclick="saveInvoicesFromModal()" style="font-size: 16px; padding: 12px 30px;">
    		    ğŸ’¾ <span id="saveInvoiceCount">0</span> FaturayÄ± Kaydet
		</button>
            </div>
        </div>
    </div>
</div>

<!-- PURCHASES TAB - YENÄ° -->
<div id="purchases" class="tab-content">
    <!-- Ãœst BaÅŸlÄ±k ve Butonlar -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">ğŸ’¸ AlÄ±ÅŸlar (Nakit/FiÅŸ)</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalPurchasesCount">0</strong> alÄ±ÅŸ kaydÄ±</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="openImportPurchasesModal()" style="font-size: 16px; padding: 12px 25px;">
                ğŸ“¤ Excel'den Ä°Ã§e Aktar
            </button>
            <button class="btn btn-primary" onclick="scrollToPurchaseForm()" style="font-size: 16px; padding: 12px 25px;">
                â• Yeni AlÄ±ÅŸ Ekle
            </button>
        </div>
    </div>

    <!-- ALIÅ LÄ°STESÄ° -->
    <div class="card">
        <h3>ğŸ“‹ AlÄ±ÅŸ Listesi</h3>
        
        <!-- FÄ°LTRELER -->
        <div class="filters">
            <div class="grid-4">
                <div class="form-group">
                    <label>ğŸ“… BaÅŸlangÄ±Ã§ Tarihi</label>
                    <input type="date" id="filterPurchaseStartDate">
                </div>
                <div class="form-group">
                    <label>ğŸ“… BitiÅŸ Tarihi</label>
                    <input type="date" id="filterPurchaseEndDate">
                </div>
                <div class="form-group">
                    <label>ğŸ·ï¸ Kategori</label>
                    <select id="filterPurchaseCategory">
                        <option value="">TÃ¼mÃ¼</option>
                        <option value="KÄ±rtasiye">KÄ±rtasiye</option>
                        <option value="YakÄ±t">YakÄ±t</option>
                        <option value="Yemek">Yemek</option>
                        <option value="Temizlik">Temizlik</option>
                        <option value="Kargo">Kargo</option>
                        <option value="Elektrik">Elektrik</option>
                        <option value="Su">Su</option>
                        <option value="Ä°nternet">Ä°nternet</option>
                        <option value="Telefon">Telefon</option>
                        <option value="BakÄ±m-OnarÄ±m">BakÄ±m-OnarÄ±m</option>
                        <option value="UlaÅŸÄ±m">UlaÅŸÄ±m</option>
                        <option value="DiÄŸer">DiÄŸer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ğŸ’³ Ã–deme YÃ¶ntemi</label>
                    <select id="filterPurchasePayment">
                        <option value="">TÃ¼mÃ¼</option>
                        <option value="cash">Nakit</option>
                        <option value="card">Kart</option>
                        <option value="transfer">Havale/EFT</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-info" onclick="filterPurchases()">ğŸ” Filtrele</button>
            <button class="btn btn-warning" onclick="clearPurchaseFilters()">ğŸ”„ Temizle</button>
        </div>
        
        <!-- Ã–ZET Ä°STATÄ°STÄ°KLER -->
        <div class="grid-4" style="margin: 20px 0;">
            <div class="stat-card danger">
                <h4>Toplam Harcama</h4>
                <div class="amount" id="purchasesTotalAmount">0.00 â‚º</div>
                <small id="purchasesCount">0 kayÄ±t</small>
            </div>
            <div class="stat-card">
                <h4>KDV HariÃ§</h4>
                <div class="amount" id="purchasesSubtotal">0.00 â‚º</div>
            </div>
            <div class="stat-card warning">
                <h4>Toplam KDV</h4>
                <div class="amount" id="purchasesTotalVAT">0.00 â‚º</div>
                <small>Mahsup edilecek</small>
            </div>
            <div class="stat-card purple">
                <h4>Ortalama Ä°ÅŸlem</h4>
                <div class="amount" id="purchasesAverage">0.00 â‚º</div>
            </div>
        </div>
        
        <table id="purchasesTable">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>Kategori</th>
                    <th>AÃ§Ä±klama</th>
                    <th>TedarikÃ§i</th>
                    <th>KDV HariÃ§</th>
                    <th>KDV</th>
                    <th>Toplam</th>
                    <th>Ã–deme</th>
                    <th>FiÅŸ</th>
                    <th>Ä°ÅŸlemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- ALIÅ EKLEME FORMU -->
    <div class="card" id="purchaseFormCard">
        <h3>â• Yeni AlÄ±ÅŸ Ekle</h3>
        <form id="purchaseForm">
            <input type="hidden" id="purchaseId">
            
            <div class="grid-3">
                <div class="form-group">
                    <label>ğŸ“… Tarih *</label>
                    <input type="date" id="purchaseDate" required>
                </div>
                <div class="form-group">
                    <label>ğŸ·ï¸ Kategori *</label>
                    <select id="purchaseCategory" required>
                        <option value="">SeÃ§iniz</option>
                        <option value="KÄ±rtasiye">ğŸ“ KÄ±rtasiye</option>
                        <option value="YakÄ±t">â›½ YakÄ±t</option>
                        <option value="Yemek">ğŸ½ï¸ Yemek</option>
                        <option value="Temizlik">ğŸ§¹ Temizlik</option>
                        <option value="Kargo">ğŸ“¦ Kargo</option>
                        <option value="Elektrik">ğŸ’¡ Elektrik</option>
                        <option value="Su">ğŸ’§ Su</option>
                        <option value="Ä°nternet">ğŸŒ Ä°nternet</option>
                        <option value="Telefon">ğŸ“± Telefon</option>
                        <option value="BakÄ±m-OnarÄ±m">ğŸ”§ BakÄ±m-OnarÄ±m</option>
                        <option value="UlaÅŸÄ±m">ğŸš— UlaÅŸÄ±m</option>
                        <option value="DiÄŸer">ğŸ“‹ DiÄŸer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ğŸ’³ Ã–deme YÃ¶ntemi *</label>
                    <select id="purchasePaymentMethod" required>
                        <option value="">SeÃ§iniz</option>
                        <option value="cash">ğŸ’µ Nakit</option>
                        <option value="card">ğŸ’³ Kredi/Banka KartÄ±</option>
                        <option value="transfer">ğŸ¦ Havale/EFT</option>
                    </select>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="form-group">
                    <label>AÃ§Ä±klama *</label>
                    <input type="text" id="purchaseDescription" required placeholder="Ã–rn: A4 kaÄŸÄ±t, toner">
                </div>
                <div class="form-group">
                    <label>TedarikÃ§i (Opsiyonel)</label>
                    <input type="text" id="purchaseSupplier" placeholder="Ã–rn: Migros, BÄ°M">
                </div>
            </div>
            
            <div class="grid-3">
                <div class="form-group">
                    <label>ğŸ’° Tutar (KDV HariÃ§) *</label>
                    <input type="number" id="purchaseAmount" step="0.01" required onchange="calculatePurchaseTotal()">
                </div>
                <div class="form-group">
                    <label>KDV OranÄ± *</label>
                    <select id="purchaseVATRate" required onchange="calculatePurchaseTotal()">
                        <option value="0">%0</option>
                        <option value="1">%1</option>
                        <option value="10">%10</option>
                        <option value="20" selected>%20</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>KDV TutarÄ±</label>
                    <input type="number" id="purchaseVATAmount" step="0.01" readonly style="background: #f3f4f6;">
                </div>
            </div>
            
            <div class="alert alert-info">
                <strong>ğŸ’µ Toplam Ã–denecek:</strong> 
                <span id="purchaseTotalDisplay" style="font-size: 1.5em; font-weight: 700; color: var(--danger);">0.00 â‚º</span>
            </div>
            
            <!-- FÄ°Å YÃœKLEME -->
            <div class="form-group">
                <label>ğŸ“„ FiÅŸ/Dekont YÃ¼kle (Opsiyonel - Maks 2 MB)</label>
                <input type="file" id="purchaseReceipt" accept="image/*,.pdf" onchange="handlePurchaseReceipt(this)">
                <div id="purchaseReceiptPreview" style="margin-top: 10px;"></div>
            </div>
            
            <div style="margin-top: 20px;">
                <button type="submit" class="btn btn-primary" id="savePurchaseBtn">ğŸ’¾ AlÄ±ÅŸÄ± Kaydet</button>
                <button type="button" class="btn btn-secondary" onclick="cancelPurchaseEdit()" id="cancelPurchaseBtn" style="display:none;">âœ–ï¸ Ä°ptal</button>
            </div>
        </form>
    </div>
</div>

<!-- PERSONNEL TAB -->
<div id="personnel" class="tab-content">
    <!-- Ãœst BaÅŸlÄ±k -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">ğŸ‘¥ Personel YÃ¶netimi</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalPersonnelCount">0</strong> personel</p>
        </div>
        <button class="btn btn-primary" onclick="openAddPersonnelModal()">
            â• Yeni Personel Ekle
        </button>
    </div>

    <!-- Ä°statistik KartlarÄ± -->
    <div class="grid-4" style="margin-bottom: 20px;">
        <div class="stat-card">
            <h4>Toplam Personel</h4>
            <div class="amount" id="activePersonnelCount">0</div>
            <small>Aktif Ã§alÄ±ÅŸan</small>
        </div>
        <div class="stat-card danger">
            <h4>Bu Ay MaaÅŸ</h4>
            <div class="amount" id="monthlySalaryTotal">0.00 â‚º</div>
        </div>
        <div class="stat-card warning">
            <h4>Bu Ay SGK</h4>
            <div class="amount" id="monthlySGKTotal">0.00 â‚º</div>
        </div>
        <div class="stat-card success">
            <h4>Bu Ay Ä°zin</h4>
            <div class="amount" id="monthlyLeaveCount">0</div>
            <small>gÃ¼n</small>
        </div>
    </div>

    <!-- Personel Listesi -->
    <div class="card">
        <h3>ğŸ“‹ Personel Listesi</h3>
        <table id="personnelTable">
            <thead>
                <tr>
                    <th>Ad Soyad</th>
                    <th>Pozisyon</th>
                    <th>MaaÅŸ</th>
                    <th>SGK (%</th>
                    <th>Ä°ÅŸe BaÅŸlama</th>
                    <th>Durum</th>
                    <th>Ä°ÅŸlemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- DevamsÄ±zlÄ±k ve Ä°zin Takibi -->
    <div class="card">
        <h3>ğŸ“… Bu Ay DevamsÄ±zlÄ±k & Ä°zin Takibi</h3>
        
        <div style="margin-bottom: 20px;">
            <label>Personel SeÃ§in:</label>
            <select id="attendancePersonnelSelect" onchange="loadPersonnelAttendance()">
                <option value="">Personel SeÃ§iniz</option>
            </select>
        </div>

        <div id="attendanceSection" style="display: none;">
            <div class="grid-2" style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="markAttendance('present')">
                    âœ… Geldi
                </button>
                <button class="btn btn-danger" onclick="markAttendance('absent')">
                    âŒ Gelmedi
                </button>
            </div>

            <button class="btn btn-warning" onclick="openLeaveRequestModal()">
                ğŸ–ï¸ Ä°zin Talebi OluÅŸtur
            </button>

            <div style="margin-top: 20px;">
                <h4>Bu Ayki KayÄ±tlar:</h4>
                <div id="attendanceRecords"></div>
            </div>
        </div>
    </div>

<div class="card">
  <h3>Ä°zin Talepleri (YÃ¶netici Paneli)</h3>
  <table>
    <thead>
      <tr>
        <th>Personel</th><th>Tarih</th><th>Tip</th><th>AÃ§Ä±klama</th>
        <th>Durum</th><th>Onaylayan</th><th>Detay</th><th>Ä°ÅŸlem</th>
      </tr>
    </thead>
    <tbody id="adminLeaveRequestsTableBody"></tbody>
  </table>
</div>

<!-- PERSONEL TAB - MAAÅ Ã–DEMELERÄ° REVÄ°ZE -->
<div class="card">
    <h3>ğŸ’° MaaÅŸ Ã–demeleri (Netten Ä°ÅŸveren Maliyeti)</h3>
    <div class="grid-3" style="margin-bottom: 20px;">
        <div class="form-group">
            <label>ğŸ“… Ay</label>
            <input type="month" id="salaryMonth" value="">
        </div>
        <div class="form-group">
            <label>ğŸ‘¤ Personel</label>
            <select id="salaryPersonnelSelect">
                <option value="">TÃ¼m Personel</option>
            </select>
        </div>
        <div class="form-group">
            <label>&nbsp;</label>
            <button class="btn btn-primary" onclick="processSalaryPayments()" style="width: 100%;">
                ğŸ’¸ MaaÅŸ Ã–demelerini Ä°ÅŸle
            </button>
        </div>
    </div>
    <!-- Yeni UI alanlarÄ± -->
    <div class="grid-3" style="margin-bottom: 20px;">
        <div class="form-group">
            <label>Net MaaÅŸ (â‚º)</label>
            <input type="number" id="salaryNetInput" step="0.01" required>
        </div>
        <div class="form-group">
            <label>Ek KazanÃ§ (â‚º)</label>
            <input type="number" id="salaryExtraInput" step="0.01" value="0">
        </div>
        <div class="form-group">
            <label>Toplam Ä°ÅŸveren Maliyeti (â‚º)</label>
            <input type="text" id="salaryTotalCostDisplay" readonly style="background:#f3f4f6;">
        </div>
    </div>
    <!-- Rapor tablosu -->
    <table id="salaryPaymentsTable">
        <thead>
            <tr>
                <th>Tarih</th>
                <th>Personel</th>
                <th>Net MaaÅŸ</th>
                <th>Ek KazanÃ§</th>
                <th>Toplam Ä°ÅŸveren Maliyeti</th>
                <th>Durum</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

    <!-- YÄ±llÄ±k maaÅŸ tablosu -->
    <div class="card">
        <h3>ğŸ‘¤ Personel YÄ±llÄ±k MaaÅŸ Tablosu ve Dekont YÃ¼kleme</h3>
        <div class="grid-3" style="margin-bottom: 20px;">
            <div class="form-group">
                <label>YÄ±l</label>
                <select id="yearSalarySelect">
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
            </div>
            <div class="form-group">
                <label>Personel</label>
                <select id="yearPersonnelSelect"></select>
            </div>
            <div class="form-group">
                <label>&nbsp;</label>
                <button class="btn btn-info" onclick="renderYearlySalaryTable()">YÄ±lÄ± Listele</button>
            </div>
        </div>
        <div id="yearlySalaryTableSection"></div>
    </div>

<!-- PERSONEL EKLEME/DÃœZENLEME MODAL -->
<div id="personnelFormModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="personnelFormModalTitle">â• Yeni Personel Ekle</h3>
            <button class="close-modal" onclick="closePersonnelFormModal()">âœ–</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="personnelForm">
                <input type="hidden" id="personnelId">
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Ad Soyad *</label>
                        <input type="text" id="personnelName" required>
                    </div>
                    <div class="form-group">
                        <label>TC Kimlik No *</label>
                        <input type="text" id="personnelTCNo" maxlength="11" required>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Pozisyon *</label>
                        <input type="text" id="personnelPosition" required>
                    </div>
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="tel" id="personnelPhone">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>BrÃ¼t MaaÅŸ (â‚º) *</label>
                        <input type="number" id="personnelSalary" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>SGK OranÄ± (%) *</label>
                        <input type="number" id="personnelSGKRate" value="14" step="0.01" required>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Ä°ÅŸe BaÅŸlama Tarihi *</label>
                        <input type="date" id="personnelStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>Durum</label>
                        <select id="personnelStatus">
                            <option value="active">Aktif</option>
                            <option value="inactive">Pasif</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Adres</label>
                    <textarea id="personnelAddress" rows="2"></textarea>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closePersonnelFormModal()">
                        âœ–ï¸ Ä°ptal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ğŸ’¾ Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Ä°ZÄ°N TALEBÄ° MODAL -->
<div id="leaveRequestModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>ğŸ–ï¸ Ä°zin Talebi OluÅŸtur</h3>
            <button class="close-modal" onclick="closeLeaveRequestModal()">âœ–</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="leaveRequestForm">
                <div class="form-group">
                    <label>Ä°zin TÃ¼rÃ¼ *</label>
                    <select id="leaveType" required>
                        <option value="">SeÃ§iniz</option>
                        <option value="annual">YÄ±llÄ±k Ä°zin</option>
                        <option value="sick">HastalÄ±k Ä°zni</option>
                        <option value="unpaid">Ãœcretsiz Ä°zin</option>
                        <option value="other">DiÄŸer</option>
                    </select>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>BaÅŸlangÄ±Ã§ *</label>
                        <input type="date" id="leaveStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>BitiÅŸ *</label>
                        <input type="date" id="leaveEndDate" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>AÃ§Ä±klama</label>
                    <textarea id="leaveDescription" rows="3"></textarea>
                </div>
                
                <div style="text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeLeaveRequestModal()">
                        âœ–ï¸ Ä°ptal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        ğŸ’¾ Ä°zin OluÅŸtur
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>

// ============================================
// ğŸ¯ FUZZY MATCHING FONKSÄ°YONLARI (EN ÃœSTTE)
// ============================================

function calculateSimilarity(str1, str2) {
    // Metinleri normalize et
    const s1 = str1.toLowerCase()
        .replace(/Ä±/g, 'i')
        .replace(/ÄŸ/g, 'g')
        .replace(/Ã¼/g, 'u')
        .replace(/ÅŸ/g, 's')
        .replace(/Ã¶/g, 'o')
        .replace(/Ã§/g, 'c')
        .trim();
    
    const s2 = str2.toLowerCase()
        .replace(/Ä±/g, 'i')
        .replace(/ÄŸ/g, 'g')
        .replace(/Ã¼/g, 'u')
        .replace(/ÅŸ/g, 's')
        .replace(/Ã¶/g, 'o')
        .replace(/Ã§/g, 'c')
        .trim();
    
    // Tam eÅŸleÅŸme
    if (s1 === s2) return 100;
    
    // Ä°Ã§erme kontrolÃ¼
    if (s1.includes(s2) || s2.includes(s1)) {
        const longerLength = Math.max(s1.length, s2.length);
        const shorterLength = Math.min(s1.length, s2.length);
        return (shorterLength / longerLength) * 100;
    }
    
    // Levenshtein mesafesi ile benzerlik
    const longer = s1.length > s2.length ? s1 : s2;
    const shorter = s1.length > s2.length ? s2 : s1;
    
    if (longer.length === 0) return 100;
    
    const editDistance = calculateLevenshteinDistance(longer, shorter);
    return ((longer.length - editDistance) / longer.length) * 100;
}

function calculateLevenshteinDistance(str1, str2) {
    const matrix = [];
    
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    
    return matrix[str2.length][str1.length];
}

// ============================================
// ğŸ“Š PARAMETRE KATALOÄU
// ============================================

const PARAMS_CATALOG = [
    { name: "PartikÃ¼l Madde", price: 4160 },
    { name: "Toz", price: 4160 },
    { name: "Yanma GazlarÄ± (SO2, CO, O2, NOx, CO2)", price: 2410 },
    { name: "Yanma GazlarÄ±", price: 2410 },
    { name: "SO2", price: 1125 },
    { name: "CO", price: 1125 },
    { name: "O2", price: 1125 },
    { name: "NOx", price: 1125 },
    { name: "CO2", price: 1125 },
    { name: "NH3", price: 3025 },
    { name: "NH", price: 3025 },
    { name: "Formaldehit", price: 6865 },
    { name: "PAH", price: 42220 },
    { name: "FlorÃ¼r", price: 7505 },
    { name: "KlorÃ¼r", price: 7505 },
    { name: "Isilik", price: 710 },
    { name: "AÄŸÄ±r Metal", price: 19000 },
    { name: "UÃ§ucu Organik BileÅŸikler ve Buhar (VOCs)", price: 13185 },
    { name: "Su BuharÄ± (Nem)", price: 1430 },
    { name: "HÄ±z", price: 1430 }
];

console.log('âœ… PARAMS_CATALOG tanÄ±mlandÄ±:', PARAMS_CATALOG.length, 'parametre');

// ============================================
// ğŸ¯ PARAMETRE FUZZY EÅLEÅTÄ°RME
// ============================================

function fuzzyParameterMatch(parameterName) {
    if (!parameterName) return null;
    
    console.log(`ğŸ” Fuzzy eÅŸleÅŸtirme arÄ±yor: "${parameterName}"`);
    
    // TÃ¼m parametreleri kontrol et
    const matches = PARAMS_CATALOG.map(param => {
        const similarity = calculateSimilarity(parameterName, param.name);
        return {
            param: param,
            name: param.name,
            price: param.price,
            similarity: similarity
        };
    }).filter(m => m.similarity >= 70); // %70+ benzerlik
    
    // En yÃ¼ksek skorlu parametreyi al
    matches.sort((a, b) => b.similarity - a.similarity);
    
    if (matches.length > 0) {
        const bestMatch = matches[0];
        console.log(`âœ… En iyi eÅŸleÅŸme: "${bestMatch.name}" (%${bestMatch.similarity.toFixed(1)})`);
        return bestMatch;
    } else {
        console.warn(`âŒ "${parameterName}" iÃ§in uygun eÅŸleÅŸme bulunamadÄ± (>%70)`);
        return null;
    }
}

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDjIhTD6qJFnXITxQQ1z3KiFk-zS8mGhWU",
  authDomain: "muhasebe-takip-sistemi.firebaseapp.com",
  projectId: "muhasebe-takip-sistemi",
  storageBucket: "muhasebe-takip-sistemi.firebasestorage.app",
  messagingSenderId: "120946847757",
  appId: "1:120946847757:web:6b0da047efc34534bda544",
  measurementId: "G-M0CJHK3HWN"
};

// Firebase'i baÅŸlat
firebase.initializeApp(firebaseConfig);

// Servisleri hazÄ±rla
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

console.log('âœ… Firebase baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±!');

// ========================================
// GOOGLE DRIVE ENTEGRASYONU
// ========================================

// Google API'yi baÅŸlat
function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    try {
        await gapi.client.init({
            apiKey: GOOGLE_API_KEY,
            discoveryDocs: [
                'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'
            ],
        });
        gapiInited = true;
        console.log('âœ… Google API hazÄ±r (Drive + Gmail)');
    } catch (error) {
        console.error('âŒ Google API baÅŸlatma hatasÄ±:', error);
        gapiInited = false;
    }
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES,
        callback: '', // sonra tanÄ±mlanacak
    });
    gisInited = true;
    console.log('âœ… Google Identity Services hazÄ±r');
}

// Google Drive'a dosya yÃ¼kle
async function uploadToGoogleDrive(file, fileName, mimeType) {
    if (!gapiInited || !gisInited) {
        throw new Error('Google Drive henÃ¼z hazÄ±r deÄŸil');
    }

    // Token yoksa al
    if (!accessToken) {
        await new Promise((resolve, reject) => {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    reject(resp);
                }
                accessToken = gapi.client.getToken().access_token;
                resolve();
            };
            tokenClient.requestAccessToken({ prompt: 'consent' });
        });
    }

    // DosyayÄ± yÃ¼kle
    const metadata = {
        name: fileName,
        mimeType: mimeType
    };

    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', file);

    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
        body: form,
    });

    const result = await response.json();
    
    // DosyayÄ± herkese aÃ§Ä±k yap
    await gapi.client.drive.permissions.create({
        fileId: result.id,
        resource: {
            role: 'reader',
            type: 'anyone',
        }
    });

    return {
        fileId: result.id,
        webViewLink: `https://drive.google.com/file/d/${result.id}/view`,
        webContentLink: `https://drive.google.com/uc?id=${result.id}&export=download`
    };
}

// Google Drive'dan dosya sil
async function deleteFromGoogleDrive(fileId) {
    if (!gapiInited || !accessToken) {
        throw new Error('Google Drive eriÅŸimi yok');
    }

    await gapi.client.drive.files.delete({
        fileId: fileId
    });
    
    console.log('âœ… Dosya Google Drive\'dan silindi:', fileId);
}

// ========================================
// GLOBAL DATA STORE - Firebase ile senkronize
// ========================================
let companies = [];
let accounts = [];
let invoices = [];
let payments = [];
let purchases = [];
let personnel = [];
let attendanceRecords = [];
let leaveRequests = [];
let salaryPayments = [];
let salaryTableData = {};
let activeCompanyId = null;
let currentProposalDocument = null; // YÃ¼klenen baÅŸvuru PDF'i
let currentInvoiceReceipt = null;
let currentPurchaseReceipt = null;
let companyDocuments = [];
let accountDocuments = [];
const MAX_ACCOUNT_DOCS = 5;
const MAX_ACCOUNT_SIZE = 3 * 1024 * 1024; // 3 MB

// E-Fatura import
let parsedInvoices = [];
let currentInvoiceType = 'sales';

// Banka import
let pendingTransactions = [];

// Ã–deme dÃ¼zenleme
let currentEditPaymentId = null;

// Google Drive iÃ§in
let gapiInited = false;
let gisInited = false;
let tokenClient;
let accessToken = null;

// Google Drive ayarlarÄ±
const GOOGLE_CLIENT_ID = '1089603522619-89h072ckei0h7kf2h7testpehuniob9m.apps.googleusercontent.com';
const GOOGLE_API_KEY = 'AIzaSyDcrZgT1UD-i938N6leIJ3ki99d0ntTNR8';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/gmail.send';

// Teklif verileri
let proposals = []; // Teklifleri tutacak array

// ========================================
// GLOBAL YARDIMCI FONKSÄ°YONLAR
// ========================================

// TÃ¼rkÃ§e sayÄ± formatÄ±nÄ± parse et (10.737,6 â†’ 10737.6)
function parseTurkishNumber(str) {
    if (!str || typeof str !== 'string') return 0;
    
    str = str.trim();
    str = str.replace(/[^\d,.\-+]/g, ''); // Sadece sayÄ±, virgÃ¼l, nokta ve iÅŸaret
    str = str.replace(/\./g, ''); // Binlik ayracÄ± noktayÄ± kaldÄ±r
    str = str.replace(',', '.'); // VirgÃ¼lÃ¼ noktaya Ã§evir
    
    let num = parseFloat(str);
    console.log(`Parse: "${str}" â†’ ${num}`);
    return isNaN(num) ? 0 : num;
}

// Gmail API ile mail gÃ¶nder (UTF-8 Fix)
async function sendEmailWithGmail(to, subject, body, pdfBlob, pdfFilename) {
    try {
        // PDF'i base64'e Ã§evir
        const reader = new FileReader();
        const base64Promise = new Promise((resolve) => {
            reader.onloadend = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.readAsDataURL(pdfBlob);
        });
        
        const pdfBase64 = await base64Promise;
        
        // Email oluÅŸtur (MIME format) - UTF-8 FIX
        const boundary = "boundary_" + Math.random().toString(36).substr(2);
        
        // âœ… UTF-8 encoding iÃ§in subject'i encode et
        const encodedSubject = '=?UTF-8?B?' + btoa(unescape(encodeURIComponent(subject))) + '?=';
        
        const email = [
            'Content-Type: multipart/mixed; boundary="' + boundary + '"',
            'MIME-Version: 1.0',
            'To: ' + to,
            'Subject: ' + encodedSubject, // âœ… Encoded subject
            'Content-Transfer-Encoding: 8bit',
            '',
            '--' + boundary,
            'Content-Type: text/html; charset=UTF-8',
            'Content-Transfer-Encoding: quoted-printable', // âœ… quoted-printable encoding
            '',
            body,
            '',
            '--' + boundary,
            'Content-Type: application/pdf; name="' + pdfFilename + '"',
            'Content-Disposition: attachment; filename="' + pdfFilename + '"',
            'Content-Transfer-Encoding: base64',
            '',
            pdfBase64,
            '',
            '--' + boundary + '--'
        ].join('\r\n');
        
        // âœ… DÃ¼zgÃ¼n UTF-8 encoding
        const encoder = new TextEncoder();
        const emailBytes = encoder.encode(email);
        
        // Base64url encoding
        let encodedEmail = '';
        const bytes = new Uint8Array(emailBytes);
        const len = bytes.length;
        for (let i = 0; i < len; i++) {
            encodedEmail += String.fromCharCode(bytes[i]);
        }
        encodedEmail = btoa(encodedEmail)
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');
        
        // Gmail API ile gÃ¶nder
        const response = await gapi.client.gmail.users.messages.send({
            userId: 'me',
            resource: {
                raw: encodedEmail
            }
        });
        
        console.log('âœ… Email gÃ¶nderildi:', response);
        return response;
        
    } catch (error) {
        console.error('âŒ Gmail API hatasÄ±:', error);
        throw error;
    }
}

// Teklifi Gmail ile gÃ¶nder
async function sendProposalEmail(proposalId) {
    const proposal = proposals.find(p => p.id === proposalId);
    if (!proposal) {
        alert('Teklif bulunamadÄ±!');
        return;
    }
    
    // âœ… Email'i Ã¶nce cari hesaptan al
    let recipientEmail = null;
    let recipientName = proposal.firmaUnvan;
    
    if (proposal.cariAccount && proposal.cariAccount.id) {
        // Cari hesap seÃ§ilmiÅŸse, ondan al
        const cariAccount = accounts.find(a => a.id === proposal.cariAccount.id);
        if (cariAccount) {
            recipientEmail = cariAccount.email;
            recipientName = cariAccount.name;
            console.log('âœ… Email cari hesaptan alÄ±ndÄ±:', recipientEmail);
        }
    }
    
    // âœ… Cari hesapta yoksa proposal'dan al
    if (!recipientEmail) {
        recipientEmail = proposal.mail;
        console.log('âš ï¸ Email proposal kaydÄ±ndan alÄ±ndÄ±:', recipientEmail);
    }
    
    if (!recipientEmail) {
        alert('âŒ Firma e-posta adresi bulunamadÄ±!\n\nLÃ¼tfen cari hesap seÃ§in veya email adresini manuel girin.');
        return;
    }
    
    const confirmSend = confirm(
        `ğŸ“§ Teklif mail ile gÃ¶nderilecek:\n\n` +
        `AlÄ±cÄ±: ${recipientEmail}\n` +
        `Firma: ${recipientName}\n` +
        `Teklif No: ${proposal.teklifNo}\n\n` +
        `Devam etmek istiyor musunuz?`
    );
    
    if (!confirmSend) return;
    
    try {
        console.log('ğŸ“„ PDF oluÅŸturuluyor...');
        
        const teklifData = {
            teklifNo: proposal.teklifNo,
            tarih: proposal.basvuruTarihi || new Date().toLocaleDateString('tr-TR'),
            firmaUnvan: recipientName, // âœ… Cari hesaptan gelen isim
            firmaAdres: proposal.firmaAdres || '',
            telefon: proposal.telefon || '',
            mail: recipientEmail, // âœ… Cari hesaptan gelen email
            konu: 'MELBES',
            icerik: proposal.icerik || 'Ä°misyon Ã–lÃ§Ã¼mÃ¼ Fiyat Teklifi',
            baslikTur: proposal.baslikTur || 'Emisyon Ã–lÃ§Ã¼mÃ¼',
            basvuruNo: proposal.basvuruNo || '',
            hazirlayan: proposal.hazirlayan || 'GÃ¶knur YAÄAN',
            iletisim: proposal.iletisim || '0 282 651 46 50',
            parameters: proposal.parameters || [],
            toplam: proposal.toplam || '0,00 TL',
            tabanFiyat: proposal.tabanFiyat || '0,00 TL',
            genelToplam: proposal.genelToplam || '0,00 TL',
            ekNotlar: proposal.ekNotlar || ''
        };
        
        fillPDFTemplate(teklifData);
        
        const element = document.getElementById('pdfTemplate');
        element.style.display = 'block';
        
   const opt = {
            margin: 10,
            filename: `${proposal.teklifNo}_Teklif.pdf`,
            image: { type: 'jpeg', quality: 0.95 },
            html2canvas: { 
                scale: 1.5,
                useCORS: true, 
                letterRendering: true, 
                logging: false,
                scrollY: 0,
                scrollX: 0,
                backgroundColor: '#ffffff'
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait', 
                compress: true,
                precision: 2
            },
            pagebreak: { 
                mode: ['css', 'legacy'],
                before: '.pdf-page',
                after: '.pdf-page'
            }
        };

        const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');
        element.style.display = 'none';
        
        console.log('âœ… PDF oluÅŸturuldu:', (pdfBlob.size / 1024).toFixed(2), 'KB');
        
        // âœ… Gmail API baÅŸlatÄ±lmamÄ±ÅŸsa baÅŸlat
        if (!gapiInited || !gisInited) {
            alert('â³ Google API baÅŸlatÄ±lÄ±yor... LÃ¼tfen birkaÃ§ saniye bekleyin ve tekrar deneyin.');
            gapiLoaded();
            gisLoaded();
            return;
        }
        
        // âœ… Token yoksa al
        if (!accessToken) {
            console.log('ğŸ” Google izni isteniyor...');
            await new Promise((resolve, reject) => {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        reject(resp);
                    }
                    accessToken = gapi.client.getToken().access_token;
                    resolve();
                };
                tokenClient.requestAccessToken({ prompt: 'consent' });
            });
        }
        
        // Email iÃ§eriÄŸi (HTML) - UTF-8 uyumlu
        const emailSubject = `Teklif: ${proposal.teklifNo} - ${recipientName}`; // âœ… Cari hesap adÄ±
        const emailBody = `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                <h2 style="color: #2563eb;">SayÄ±n ${recipientName} Yetkilileri,</h2>
                
                <p style="font-size: 16px; line-height: 1.6;">
                    <strong>${proposal.teklifNo}</strong> numaralÄ± <strong>${proposal.baslikTur || 'Emisyon Ã–lÃ§Ã¼mÃ¼'}</strong> teklifimiz ektedir.
                </p>
                
                <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: #1f2937; margin-top: 0;">ğŸ“‹ Teklif DetaylarÄ±</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 8px 0; color: #6b7280;">Firma:</td>
                            <td style="padding: 8px 0; font-weight: bold;">${recipientName}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; color: #6b7280;">Toplam Tutar:</td>
                            <td style="padding: 8px 0; font-weight: bold; color: #10b981;">${proposal.genelToplam || '0,00 TL'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; color: #6b7280;">Teklif Tarihi:</td>
                            <td style="padding: 8px 0; font-weight: bold;">${proposal.basvuruTarihi || new Date().toLocaleDateString('tr-TR')}</td>
                        </tr>
                    </table>
                </div>
                
                <p style="font-size: 14px; line-height: 1.6;">
                    Teklif detaylarÄ± iÃ§in ekteki PDF dosyasÄ±nÄ± inceleyebilirsiniz.
                </p>
                
                <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
                
                <div style="color: #6b7280; font-size: 13px;">
                    <p style="margin: 5px 0;"><strong>GÃ–ZDE Ã‡evre Ä°ÅŸ GÃ¼venliÄŸi Ã–lÃ§Ã¼m Test Analiz Laboratuvar</strong></p>
                    <p style="margin: 5px 0;">Tel: 0 282 651 46 50</p>
                    <p style="margin: 5px 0;">Email: info@gozdecevre.com</p>
                    <p style="margin: 5px 0;">Web: www.gozdecevre.com</p>
                </div>
            </div>
        `;
        
        console.log('ğŸ“¤ Gmail ile mail gÃ¶nderiliyor...');
        
        await sendEmailWithGmail(
            recipientEmail, // âœ… Cari hesaptan gelen email
            emailSubject,
            emailBody,
            pdfBlob,
            `${proposal.teklifNo}_Teklif.pdf`
        );
        
        alert('âœ… Teklif mail ile baÅŸarÄ±yla gÃ¶nderildi!');
        
        // Teklif durumunu gÃ¼ncelle
        if (auth.currentUser) {
            await db.collection('users')
                .doc(auth.currentUser.uid)
                .collection('proposals')
                .doc(proposal.id)
                .update({
                    status: 'gonderildi',
                    sentDate: new Date().toISOString()
                });
            
            // Local state'i gÃ¼ncelle
            const proposalIndex = proposals.findIndex(p => p.id === proposal.id);
            if (proposalIndex >= 0) {
                proposals[proposalIndex].status = 'gonderildi';
                proposals[proposalIndex].sentDate = new Date().toISOString();
            }
            
            renderProposalsList();
        }
        
    } catch (error) {
        console.error('âŒ Mail gÃ¶nderme hatasÄ±:', error);
        
        if (error.result && error.result.error) {
            alert('âŒ Mail gÃ¶nderilemedi: ' + error.result.error.message);
        } else {
            alert('âŒ Mail gÃ¶nderilemedi: ' + error.message);
        }
    }
}

// Cari hesaba ait teklifleri gÃ¶ster
function showAccountProposals(accountId) {
    const accountProposals = proposals.filter(p => 
        p.cariAccount && p.cariAccount.id === accountId
    );
    
    if (accountProposals.length === 0) {
        return '<p style="color:#6b7280; padding:10px;">Bu cariye ait teklif bulunamadÄ±</p>';
    }
    
    let html = '<div class="proposals-list" style="max-height:300px; overflow-y:auto;">';
    
    accountProposals.forEach(proposal => {
        html += `
            <div class="proposal-item" style="border:1px solid #e5e7eb; padding:10px; margin-bottom:10px; border-radius:5px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${proposal.teklifNo}</strong> - ${proposal.basvuruTarihi}
                        <br><small style="color:#6b7280;">${proposal.genelToplam}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-info" onclick="viewProposal('${proposal.id}')">
                            ğŸ‘ï¸
                        </button>
                        ${proposal.applicationDocument ? `
                        <button class="btn btn-sm btn-warning" onclick="window.open('${proposal.applicationDocument.viewLink}', '_blank')">
                            ğŸ“„
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

        // TAB NAVIGATION
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Reload data when switching to payments tab
            if (tabName === 'payments') {
                loadPayments();
            }
 	    if (tabName === 'personnel') {
    		loadLeaveRequestsAdminPanel();
  	    }
        }

// Cari hesap dÃ¶kÃ¼manlarÄ±nÄ± Storage'a yÃ¼kle
async function uploadAccountDocuments(companyId, accountId, documents) {
    const uploadedDocs = [];
    
    for (const doc of documents) {
        try {
            if (doc.file && doc.file.startsWith('data:')) {
                // Base64 dosyayÄ± blob'a Ã§evir
                const blob = await fetch(doc.file).then(r => r.blob());
                
                // Storage'a yÃ¼kle
                const fileName = `${Date.now()}_${doc.fileName}`;
                const storageRef = storage.ref(`companies/${companyId}/accounts/${accountId}/${fileName}`);
                
                const snapshot = await storageRef.put(blob);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                uploadedDocs.push({
                    id: doc.id,
                    name: doc.name,
                    fileName: doc.fileName,
                    fileSize: doc.fileSize,
                    fileType: doc.fileType,
                    fileUrl: downloadURL,
                    uploadDate: doc.uploadDate
                });
                
                console.log(`âœ… Cari dÃ¶kÃ¼man yÃ¼klendi: ${doc.name}`);
            }
        } catch (error) {
            console.error(`âŒ Cari dÃ¶kÃ¼man yÃ¼kleme hatasÄ± (${doc.name}):`, error);
        }
    }
    
    return uploadedDocs;
}

// Firma dÃ¶kÃ¼manlarÄ±nÄ± Storage'a yÃ¼kle
async function uploadCompanyDocuments(companyId, documents) {
    const uploadedDocs = [];
    
    for (const doc of documents) {
        try {
            if (doc.file && doc.file.startsWith('data:')) {
                // Base64 dosyayÄ± blob'a Ã§evir
                const blob = await fetch(doc.file).then(r => r.blob());
                
                // Storage'a yÃ¼kle
                const fileName = `${Date.now()}_${doc.fileName}`;
                const storageRef = storage.ref(`companies/${companyId}/documents/${fileName}`);
                
                const snapshot = await storageRef.put(blob);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                uploadedDocs.push({
                    id: doc.id,
                    name: doc.name,
                    fileName: doc.fileName,
                    fileSize: doc.fileSize,
                    fileType: doc.fileType,
                    fileUrl: downloadURL,
                    uploadDate: doc.uploadDate
                });
                
                console.log(`âœ… DÃ¶kÃ¼man yÃ¼klendi: ${doc.name}`);
            }
        } catch (error) {
            console.error(`âŒ DÃ¶kÃ¼man yÃ¼kleme hatasÄ± (${doc.name}):`, error);
        }
    }
    
    return uploadedDocs;
}

// ========================================
// FÄ°RMA MODAL YÃ–NETÄ°MÄ°
// ========================================

function openAddCompanyModal() {
    // Form temizle
    document.getElementById('companyForm').reset();
    document.getElementById('companyId').value = '';
    companyDocuments = [];
    renderCompanyDocuments();
    
    // BaÅŸlÄ±k deÄŸiÅŸtir
    document.getElementById('companyFormModalTitle').textContent = 'â• Yeni Firma Ekle';
    document.getElementById('saveCompanyBtn').textContent = 'ğŸ’¾ Firma Kaydet';
    
    // Log bilgilerini gizle
    document.getElementById('companyLogInfo').style.display = 'none';
    
    // Modal'Ä± aÃ§
    document.getElementById('companyFormModal').classList.add('active');
}

function closeCompanyFormModal() {
    document.getElementById('companyFormModal').classList.remove('active');
    document.getElementById('companyForm').reset();
    document.getElementById('companyId').value = '';
    companyDocuments = [];
    renderCompanyDocuments();
}

function editCompany(id) {
    const company = companies.find(c => c.id === id);
    if (!company) return;

    document.getElementById('companyId').value = company.id;
    document.getElementById('companyName').value = company.name;
    document.getElementById('companyTaxNo').value = company.taxNo;
    document.getElementById('companyTaxOffice').value = company.taxOffice || '';
    document.getElementById('companyPhone').value = company.phone || '';
    document.getElementById('companyEmail').value = company.email || '';
    document.getElementById('companyWebsite').value = company.website || '';
    document.getElementById('companyAddress').value = company.address || '';
    document.getElementById('companySector').value = company.sector || '';

    // DÃ¶kÃ¼manlarÄ± yÃ¼kle
    companyDocuments = company.documents ? JSON.parse(JSON.stringify(company.documents)) : [];
    renderCompanyDocuments();

    // Log bilgilerini gÃ¶ster
    if (company.createdAt) {
        const createdDate = new Date(company.createdAt).toLocaleString('tr-TR');
        const createdBy = company.createdBy || 'Bilinmiyor';
        document.getElementById('companyCreatedInfo').innerHTML = `ğŸ“ OluÅŸturulma: <strong>${createdDate}</strong> - <em>${createdBy}</em>`;
        
        if (company.updatedAt && company.updatedAt !== company.createdAt) {
            const updatedDate = new Date(company.updatedAt).toLocaleString('tr-TR');
            const updatedBy = company.updatedBy || 'Bilinmiyor';
            document.getElementById('companyUpdatedInfo').innerHTML = `ğŸ”„ Son GÃ¼ncelleme: <strong>${updatedDate}</strong> - <em>${updatedBy}</em>`;
        } else {
            document.getElementById('companyUpdatedInfo').innerHTML = '';
        }
        
        document.getElementById('companyLogInfo').style.display = 'block';
    }

    // BaÅŸlÄ±k deÄŸiÅŸtir
    document.getElementById('companyFormModalTitle').textContent = 'âœï¸ Firma DÃ¼zenle - ' + company.name;
    document.getElementById('saveCompanyBtn').textContent = 'ğŸ’¾ GÃ¼ncelle';

    // Modal'Ä± aÃ§
    document.getElementById('companyFormModal').classList.add('active');
}

function cancelCompanyEdit() {
    closeCompanyFormModal();
}

// ========================================
// CARÄ° HESAP MODAL YÃ–NETÄ°MÄ°
// ========================================

function openAddAccountModal() {
    // Firma kontrolÃ¼
    if (companies.length === 0) {
        alert('âš ï¸ Ã–nce en az bir firma eklemelisiniz!');
        showTab('companies');
        document.querySelector('.tab[onclick*="companies"]').click();
        return;
    }
    
    // Form temizle
    document.getElementById('accountForm').reset();
    document.getElementById('accountId').value = '';
    accountDocuments = [];
    renderAccountDocuments();
    
    // Aktif firma varsa otomatik seÃ§
    if (activeCompanyId) {
        document.getElementById('accountCompany').value = activeCompanyId;
        updateAccountCompanyInfo();
    }
    
    // BaÅŸlÄ±k deÄŸiÅŸtir
    document.getElementById('accountFormModalTitle').textContent = 'â• Yeni Cari Hesap Ekle';
    document.getElementById('saveAccountBtn').textContent = 'ğŸ’¾ Cari Kaydet';
    
    // Log bilgilerini gizle
    document.getElementById('accountLogInfo').style.display = 'none';
    
    // Modal'Ä± aÃ§
    document.getElementById('accountFormModal').classList.add('active');
}

function closeAccountFormModal() {
    document.getElementById('accountFormModal').classList.remove('active');
    document.getElementById('accountForm').reset();
    document.getElementById('accountId').value = '';
    accountDocuments = [];
    renderAccountDocuments();
}

function editAccount(id) {
    const account = accounts.find(a => a.id === id);
    if (!account) return;

    document.getElementById('accountId').value = account.id;
    document.getElementById('accountCompany').value = account.companyId;
    document.getElementById('accountName').value = account.name;
    document.getElementById('accountType').value = account.type;
    document.getElementById('accountTaxNo').value = account.taxNo || '';
    document.getElementById('accountPhone').value = account.phone || '';
    document.getElementById('accountEmail').value = account.email || '';
    document.getElementById('accountAddress').value = account.address || '';

    // DÃ¶kÃ¼manlarÄ± yÃ¼kle
    accountDocuments = account.documents ? JSON.parse(JSON.stringify(account.documents)) : [];
    renderAccountDocuments();

    updateAccountCompanyInfo();

    // Log bilgilerini gÃ¶ster
    if (account.createdAt) {
        const createdDate = new Date(account.createdAt).toLocaleString('tr-TR');
        const createdBy = account.createdBy || 'Bilinmiyor';
        document.getElementById('accountCreatedInfo').innerHTML = `ğŸ“ OluÅŸturulma: <strong>${createdDate}</strong> - <em>${createdBy}</em>`;
        
        if (account.updatedAt && account.updatedAt !== account.createdAt) {
            const updatedDate = new Date(account.updatedAt).toLocaleString('tr-TR');
            const updatedBy = account.updatedBy || 'Bilinmiyor';
            document.getElementById('accountUpdatedInfo').innerHTML = `ğŸ”„ Son GÃ¼ncelleme: <strong>${updatedDate}</strong> - <em>${updatedBy}</em>`;
        } else {
            document.getElementById('accountUpdatedInfo').innerHTML = '';
        }
        
        document.getElementById('accountLogInfo').style.display = 'block';
    }

    // BaÅŸlÄ±k deÄŸiÅŸtir
    document.getElementById('accountFormModalTitle').textContent = 'âœï¸ Cari Hesap DÃ¼zenle - ' + account.name;
    document.getElementById('saveAccountBtn').textContent = 'ğŸ’¾ GÃ¼ncelle';

    // Modal'Ä± aÃ§
    document.getElementById('accountFormModal').classList.add('active');
}

function cancelAccountEdit() {
    closeAccountFormModal();
}

// ========================================
// ARAMA FONKSÄ°YONLARI
// ========================================

function searchCompanies() {
    const searchTerm = document.getElementById('searchCompany').value.toLowerCase();
    const tbody = document.querySelector('#companiesTable tbody');
    const rows = tbody.getElementsByTagName('tr');
    
    let visibleCount = 0;
    
    for (let row of rows) {
        const companyName = row.cells[0]?.textContent.toLowerCase() || '';
        const sector = row.cells[1]?.textContent.toLowerCase() || '';
        const taxNo = row.cells[2]?.textContent.toLowerCase() || '';
        
        if (companyName.includes(searchTerm) || sector.includes(searchTerm) || taxNo.includes(searchTerm)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }
}

async function loadCompanies() {
    if (!auth.currentUser) {
        console.log('âš ï¸ KullanÄ±cÄ± yok, firmalar yÃ¼klenmiyor');
        companies = [];
        return;
    }
    
    try {
        const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData && userData.companies && userData.companies.length > 0) {
            const companiesSnapshot = await db.collection('companies')
                .where(firebase.firestore.FieldPath.documentId(), 'in', userData.companies)
                .get();
            
            companies = [];
            companiesSnapshot.forEach(doc => {
                companies.push({ id: doc.id, ...doc.data() });
            });
            
            console.log('âœ… Firmalar yÃ¼klendi:', companies.length);
            
            // Ä°lk firma aktif firma olsun
            if (companies.length > 0 && !activeCompanyId) {
                activeCompanyId = companies[0].id;
            }
        } else {
            companies = [];
            console.log('â„¹ï¸ KullanÄ±cÄ±ya ait firma yok');
        }
        
    } catch (error) {
        console.error('âŒ Firma yÃ¼kleme hatasÄ±:', error);
        companies = [];
    }
    
    renderCompaniesTable();
    populateCompanySelects();
}

// ========================================
// RENDER FONKSIYONLARI (Firebase Ä°Ã§in AyrÄ±lmÄ±ÅŸ)
// ========================================

function renderCompaniesTable() {
    const tbody = document.querySelector('#companiesTable tbody');
    if (!tbody) {
        console.warn('Companies table tbody bulunamadÄ±');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (companies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">ğŸ¢</div><h3>HenÃ¼z firma yok</h3><p>Yeni firma eklemek iÃ§in "Yeni Firma Ekle" butonunu kullanÄ±n.</p></td></tr>';
        return;
    }
    
    companies.forEach(company => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${company.name}</strong></td>
            <td>${company.taxNo || '-'}</td>
            <td>${company.phone || '-'}</td>
            <td>${company.sector || '-'}</td>
            <td>
                <button class="btn btn-sm btn-info" onclick="setActiveCompany('${company.id}')" title="Aktif Yap">
                    ${activeCompanyId === company.id ? 'âœ…' : 'â­•'}
                </button>
            </td>
            <td>
                <button class="btn btn-sm" onclick="viewCompanyDetail('${company.id}')" title="Detay">ğŸ‘ï¸</button>
                <button class="btn btn-warning btn-sm" onclick="editCompany('${company.id}')" title="DÃ¼zenle">âœï¸</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCompany('${company.id}')" title="Sil">ğŸ—‘ï¸</button>
            </td>
        `;
    });
    
    console.log('âœ… Firma tablosu render edildi');
}

// ========================================
// Ã–DEME DÃœZENLEME FONKSÄ°YONU
// ========================================

function editPayment(paymentId) {
    const payment = payments.find(p => p.id === paymentId);
    
    if (!payment) {
        alert('âŒ Ã–deme kaydÄ± bulunamadÄ±!');
        return;
    }
    
    // Modal HTML'i oluÅŸtur
    const modalHtml = `
        <div class="modal active" id="editPaymentModal" style="display: flex;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3>âœï¸ Ã–demeyi DÃ¼zenle</h3>
                    <button class="close-modal" onclick="closeEditPaymentModal()">âœ–</button>
                </div>
                
                <div style="padding: 30px;">
                    <form id="editPaymentForm">
                        <input type="hidden" id="editPaymentId" value="${payment.id}">
                        
                        <!-- Tarih -->
                        <div class="form-group">
                            <label>ğŸ“… Tarih *</label>
                            <input type="date" id="editPaymentDate" value="${payment.date}" required>
                        </div>
                        
                        <!-- Cari Hesap -->
                        <div class="form-group">
                            <label>ğŸ‘¤ Cari Hesap *</label>
                            <select id="editPaymentAccount" required>
                                <option value="">SeÃ§iniz</option>
                                ${accounts
                                    .filter(a => a.companyId === activeCompanyId)
                                    .map(a => `
                                        <option value="${a.id}" ${payment.accountId === a.id ? 'selected' : ''}>
                                            ${a.name} (${a.type === 'customer' ? 'MÃ¼ÅŸteri' : 'TedarikÃ§i'})
                                        </option>
                                    `).join('')}
                            </select>
                        </div>
                        
                        <!-- Tutar -->
                        <div class="form-group">
                            <label>ğŸ’° Tutar *</label>
                            <input type="number" id="editPaymentAmount" value="${payment.amount}" 
                                   min="0" step="0.01" required>
                        </div>
                        
                        <!-- Ä°ÅŸlem Tipi -->
                        <div class="form-group">
                            <label>ğŸ”„ Ä°ÅŸlem Tipi *</label>
                            <select id="editPaymentType" required>
                                <option value="income" ${payment.type === 'income' ? 'selected' : ''}>
                                    ğŸ’° Tahsilat (Gelen Ã–deme)
                                </option>
                                <option value="expense" ${payment.type === 'expense' ? 'selected' : ''}>
                                    ğŸ’¸ Ã–deme (Giden Ã–deme)
                                </option>
                            </select>
                        </div>
                        
                        <!-- Fatura BaÄŸlantÄ±sÄ± -->
                        <div class="form-group">
                            <label>ğŸ“„ Fatura (Opsiyonel)</label>
                            <select id="editPaymentInvoice">
                                <option value="">Fatura baÄŸlama</option>
                                ${invoices
                                    .filter(inv => inv.accountId === payment.accountId)
                                    .map(inv => `
                                        <option value="${inv.id}" ${payment.invoiceId === inv.id ? 'selected' : ''}>
                                            ${inv.invoiceNo} - ${formatCurrency(inv.total)}
                                        </option>
                                    `).join('')}
                            </select>
                        </div>
                        
                        <!-- AÃ§Ä±klama -->
                        <div class="form-group">
                            <label>ğŸ“ AÃ§Ä±klama</label>
                            <textarea id="editPaymentDescription" rows="3">${payment.description || ''}</textarea>
                        </div>
                        
                        <!-- Kaynak Bilgisi (sadece gÃ¶sterim) -->
                        <div class="alert alert-info">
                            <strong>â„¹ï¸ Kaynak:</strong> ${payment.source === 'bank' ? 'ğŸ¦ Banka' : 'âœï¸ Manuel'}
                        </div>
                        
                        <!-- Butonlar -->
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" onclick="closeEditPaymentModal()" style="flex: 1;">
                                âœ–ï¸ Ä°ptal
                            </button>
                            <button type="submit" class="btn btn-success" style="flex: 2;">
                                ğŸ’¾ GÃ¼ncelle
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    // Modal'Ä± sayfaya ekle
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
    
    // Form submit handler
    document.getElementById('editPaymentForm').addEventListener('submit', updatePayment);
    
    // Cari deÄŸiÅŸince faturalarÄ± gÃ¼ncelle
    document.getElementById('editPaymentAccount').addEventListener('change', function() {
        updateEditPaymentInvoices();
    });
}

function closeEditPaymentModal() {
    const modal = document.getElementById('editPaymentModal');
    if (modal) {
        modal.remove();
    }
}

function updateEditPaymentInvoices() {
    const accountId = document.getElementById('editPaymentAccount').value;
    const invoiceSelect = document.getElementById('editPaymentInvoice');
    
    invoiceSelect.innerHTML = '<option value="">Fatura baÄŸlama</option>';
    
    if (!accountId) return;
    
    const accountInvoices = invoices.filter(inv => inv.accountId === accountId);
    
    accountInvoices.forEach(inv => {
        const option = new Option(
            `${inv.invoiceNo} - ${formatCurrency(inv.total)}`,
            inv.id
        );
        invoiceSelect.add(option);
    });
}

async function updatePayment(e) {
    e.preventDefault();
    
    const paymentId = document.getElementById('editPaymentId').value;
    const payment = payments.find(p => p.id === paymentId);
    
    if (!payment) {
        alert('âŒ Ã–deme kaydÄ± bulunamadÄ±!');
        return;
    }
    
    // Yeni deÄŸerleri al
    const newDate = document.getElementById('editPaymentDate').value;
    const newAccountId = document.getElementById('editPaymentAccount').value;
    const newAmount = parseFloat(document.getElementById('editPaymentAmount').value);
    const newType = document.getElementById('editPaymentType').value;
    const newInvoiceId = document.getElementById('editPaymentInvoice').value || null;
    const newDescription = document.getElementById('editPaymentDescription').value || '';
    
    // âš ï¸ Validation
    if (!newDate || !newAccountId || !newAmount || !newType) {
        alert('âš ï¸ LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun!');
        return;
    }
    
    // Eski deÄŸerleri sakla
    const oldAccountId = payment.accountId;
    const oldAmount = payment.amount;
    const oldType = payment.type;
    const oldInvoiceId = payment.invoiceId;
    
    try {
        console.log('ğŸ”„ Ã–deme gÃ¼ncelleniyor:', paymentId);
        
        // ========================================
        // 1. ESKÄ° BAKÄ°YELERÄ° GERÄ° AL
        // ========================================
        
        // Eski cariden bakiyeyi geri al
        const oldAccount = accounts.find(a => a.id === oldAccountId);
        if (oldAccount) {
            console.log(`ğŸ‘¤ Eski cari: ${oldAccount.name}`);
            if (oldType === 'income') {
                oldAccount.balance += oldAmount;
            } else {
                oldAccount.balance -= oldAmount;
            }
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('accounts').doc(oldAccountId).update({
                    balance: oldAccount.balance
                });
            
            console.log(`âœ… Eski cari gÃ¼ncellendi: ${formatCurrency(oldAccount.balance)}`);
        }
        
        // Eski faturadan Ã¶demeyi geri al
        if (oldInvoiceId) {
            const oldInvoice = invoices.find(inv => inv.id === oldInvoiceId);
            if (oldInvoice) {
                oldInvoice.paidAmount = Math.max(0, (oldInvoice.paidAmount || 0) - oldAmount);
                
                if (oldInvoice.paidAmount <= 0) {
                    oldInvoice.status = 'unpaid';
                } else if (oldInvoice.paidAmount >= oldInvoice.total) {
                    oldInvoice.status = 'paid';
                } else {
                    oldInvoice.status = 'partial';
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('invoices').doc(oldInvoiceId).update({
                        paidAmount: oldInvoice.paidAmount,
                        status: oldInvoice.status
                    });
                
                console.log(`âœ… Eski fatura gÃ¼ncellendi: ${oldInvoice.invoiceNo}`);
            }
        }
        
        // ========================================
        // 2. YENÄ° DEÄERLERÄ° UYGULA
        // ========================================
        
        // Yeni cariye bakiye ekle
        const newAccount = accounts.find(a => a.id === newAccountId);
        if (newAccount) {
            console.log(`ğŸ‘¤ Yeni cari: ${newAccount.name}`);
            if (newType === 'income') {
                newAccount.balance -= newAmount;
            } else {
                newAccount.balance += newAmount;
            }
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('accounts').doc(newAccountId).update({
                    balance: newAccount.balance
                });
            
            console.log(`âœ… Yeni cari gÃ¼ncellendi: ${formatCurrency(newAccount.balance)}`);
        }
        
        // Yeni faturaya Ã¶deme ekle
        if (newInvoiceId) {
            const newInvoice = invoices.find(inv => inv.id === newInvoiceId);
            if (newInvoice) {
                newInvoice.paidAmount = (newInvoice.paidAmount || 0) + newAmount;
                
                if (newInvoice.paidAmount >= newInvoice.total) {
                    newInvoice.status = 'paid';
                } else if (newInvoice.paidAmount > 0) {
                    newInvoice.status = 'partial';
                } else {
                    newInvoice.status = 'unpaid';
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('invoices').doc(newInvoiceId).update({
                        paidAmount: newInvoice.paidAmount,
                        status: newInvoice.status
                    });
                
                console.log(`âœ… Yeni fatura gÃ¼ncellendi: ${newInvoice.invoiceNo}`);
            }
        }
        
        // ========================================
        // 3. Ã–DEME KAYDINI GÃœNCELLE
        // ========================================
        
        const updatedPayment = {
            date: newDate,
            accountId: newAccountId,
            amount: newAmount,
            type: newType,
            description: newDescription,
            updatedAt: new Date().toISOString(),
            updatedBy: auth.currentUser.uid
        };
        
        // âš ï¸ invoiceId iÃ§in Ã¶zel iÅŸlem (undefined olmasÄ±n)
        if (newInvoiceId) {
            updatedPayment.invoiceId = newInvoiceId;
        } else if (oldInvoiceId) {
            // EÄŸer eski fatura varsa ama yeni yoksa, Firebase'den kaldÄ±r
            updatedPayment.invoiceId = firebase.firestore.FieldValue.delete();
        }
        // EÄŸer ikisi de yoksa invoiceId field'ini hiÃ§ ekleme
        
        await db.collection('companies').doc(activeCompanyId)
            .collection('payments').doc(paymentId).update(updatedPayment);
        
        // Local array'i gÃ¼ncelle (invoiceId null olabilir)
        payment.date = newDate;
        payment.accountId = newAccountId;
        payment.amount = newAmount;
        payment.type = newType;
        payment.description = newDescription;
        payment.invoiceId = newInvoiceId || null;
        payment.updatedAt = updatedPayment.updatedAt;
        payment.updatedBy = updatedPayment.updatedBy;
        
        console.log('âœ… Ã–deme baÅŸarÄ±yla gÃ¼ncellendi');
        
        closeEditPaymentModal();
        
        // UI'Ä± yenile
        await Promise.all([
            loadPayments(),
            loadInvoices(),
            loadAccounts()
        ]);
        
        // EÄŸer cari kartÄ± aÃ§Ä±ksa yenile
        if (currentAccountCardId) {
            loadAccountCardTransactions();
            filterAccountCard();
        }
        
        updateDashboard();
        
        alert('âœ… Ã–deme baÅŸarÄ±yla gÃ¼ncellendi!');
        
    } catch (error) {
        console.error('âŒ Ã–deme gÃ¼ncelleme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

function renderInvoicesTable() {
    const tbody = document.querySelector('#invoicesTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    const companyInvoices = invoices
        .filter(inv => !activeCompanyId || inv.companyId === activeCompanyId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

    const totalCountElement = document.getElementById('totalInvoicesCount');
    if (totalCountElement) {
        totalCountElement.textContent = companyInvoices.length;
    }

    if (companyInvoices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">ğŸ“„</div><h3>HenÃ¼z fatura yok</h3><p>Yeni fatura eklemek veya E-Fatura import yapmak iÃ§in yukarÄ±daki butonlarÄ± kullanÄ±n.</p></td></tr>';
        if (typeof updateRecentInvoices === 'function') {
            updateRecentInvoices();
        }
        return;
    }

    companyInvoices.forEach(invoice => {
        const account = accounts.find(a => a.id === invoice.accountId);
        const typeText = invoice.type === 'sales' ? 'ğŸ“¤ Giden' : 'ğŸ“¥ Gelen';
        const typeColor = invoice.type === 'sales' ? 'var(--success)' : 'var(--danger)';
        
        const remaining = invoice.total - (invoice.paidAmount || 0);
        const paidAmountText = invoice.paidAmount > 0 ? formatCurrency(invoice.paidAmount) : '-';
        
        let statusText = 'Ã–denmedi';
        let statusClass = 'badge-danger';
        
        if (invoice.status === 'paid' || remaining <= 0) {
            statusText = 'Ã–dendi';
            statusClass = 'badge-success';
        } else if (invoice.status === 'partial' || invoice.paidAmount > 0) {
            statusText = 'KÄ±smi';
            statusClass = 'badge-warning';
        }

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${invoice.invoiceNo}</strong></td>
            <td>${formatDate(invoice.date)}</td>
            <td style="color: ${typeColor};">${typeText}</td>
            <td>${account ? account.name : 'SilinmiÅŸ'}</td>
            <td style="font-weight: 700;">${formatCurrency(invoice.total)}</td>
            <td>${paidAmountText}</td>
            <td style="color: ${remaining > 0 ? 'var(--danger)' : 'var(--success)'};">
                ${formatCurrency(remaining)}
            </td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
            <td style="white-space: nowrap;">
                ${invoice.receiptUrl ? `
                    <button class="btn btn-sm btn-info" onclick="viewInvoiceReceipt('${invoice.id}')" title="Dekontu GÃ¶rÃ¼ntÃ¼le">
                        ğŸ“
                    </button>
                ` : ''}
                <button class="btn btn-sm" onclick="viewInvoice('${invoice.id}')" title="Detay">ğŸ‘ï¸</button>
                <button class="btn btn-info btn-sm" onclick="editInvoice('${invoice.id}')" title="DÃ¼zenle">âœï¸</button>
                <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice.id}')" title="Sil">ğŸ—‘ï¸</button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    if (typeof updateRecentInvoices === 'function') {
        updateRecentInvoices();
    }
}

function renderPurchasesTable() {
    const tbody = document.querySelector('#purchasesTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const companyPurchases = purchases
        .filter(p => !activeCompanyId || p.companyId === activeCompanyId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const totalCountElement = document.getElementById('totalPurchasesCount');
    if (totalCountElement) {
        totalCountElement.textContent = companyPurchases.length;
    }
    
    if (companyPurchases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">ğŸ’¸</div><h3>HenÃ¼z alÄ±ÅŸ kaydÄ± yok</h3><p>Yeni alÄ±ÅŸ eklemek iÃ§in yukarÄ±daki butonu kullanÄ±n.</p></td></tr>';
        if (typeof updatePurchaseStats === 'function') {
            updatePurchaseStats([]);
        }
        return;
    }
    
    companyPurchases.forEach(purchase => {
        const paymentMethodText = {
            'cash': 'ğŸ’µ Nakit',
            'card': 'ğŸ’³ Kart',
            'transfer': 'ğŸ¦ Havale'
        }[purchase.paymentMethod] || purchase.paymentMethod;
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${formatDate(purchase.date)}</td>
            <td><span class="badge badge-info">${purchase.category}</span></td>
            <td><strong>${purchase.description}</strong></td>
            <td>${purchase.supplier || '-'}</td>
            <td>${formatCurrency(purchase.amount)}</td>
            <td>${formatCurrency(purchase.vatAmount)} <small>(%${purchase.vatRate})</small></td>
            <td style="font-weight: 700; color: var(--danger);">${formatCurrency(purchase.total)}</td>
            <td>${paymentMethodText}</td>
            <td>
                ${(purchase.receiptUrl || (purchase.receipt && purchase.receipt.file)) ? `
                    <button class="btn btn-info btn-sm" onclick="viewPurchaseReceipt('${purchase.id}')" title="FiÅŸi GÃ¶rÃ¼ntÃ¼le">
                        ğŸ“„
                    </button>
                ` : '<span style="color:#6b7280;">-</span>'}
            </td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editPurchase('${purchase.id}')" title="DÃ¼zenle">âœï¸</button>
                <button class="btn btn-danger btn-sm" onclick="deletePurchase('${purchase.id}')" title="Sil">ğŸ—‘ï¸</button>
            </td>
        `;
    });
    
    if (typeof updatePurchaseStats === 'function') {
        updatePurchaseStats(companyPurchases);
    }
}

function renderPaymentsTable() {
    const tbody = document.querySelector('#paymentsTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const companyPayments = payments
        .filter(p => !activeCompanyId || p.companyId === activeCompanyId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (companyPayments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">ğŸ’°</div><h3>HenÃ¼z Ã¶deme kaydÄ± yok</h3></td></tr>';
        return;
    }
    
    companyPayments.forEach(payment => {
        const account = accounts.find(a => a.id === payment.accountId);
        const typeText = payment.type === 'income' ? 'ğŸ“¥ Tahsilat' : 'ğŸ“¤ Ã–deme';
        const typeColor = payment.type === 'income' ? 'var(--success)' : 'var(--danger)';
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${formatDate(payment.date)}</td>
            <td style="color:${typeColor};">${typeText}</td>
            <td>${account ? account.name : 'SilinmiÅŸ'}</td>
            <td style="font-weight:700; color:${typeColor};">${formatCurrency(payment.amount)}</td>
            <td>${payment.description || '-'}</td>
            <td>
    		<button class="btn btn-warning btn-sm" onclick="editPayment('${payment.id}')" title="DÃ¼zenle">âœï¸</button>
                <button class="btn btn-danger btn-sm" onclick="deletePayment('${payment.id}')" title="Sil">ğŸ—‘ï¸</button>
            </td>
        `;
    });
}



function renderPersonnelTable() {
    const tbody = document.querySelector('#personnelTable tbody');
    if (!tbody) {
        console.warn('personnelTable tbody bulunamadÄ±!');
        return;
    }
    
    tbody.innerHTML = '';
    
    // Sadece aktif firmaya ait personeli gÃ¶ster
    const companyPersonnel = personnel.filter(p => 
        !activeCompanyId || p.companyId === activeCompanyId
    );
    
    // Personel sayÄ±sÄ±nÄ± gÃ¼ncelle
    const totalCountElement = document.getElementById('totalPersonnelCount');
    if (totalCountElement) {
        totalCountElement.textContent = companyPersonnel.length;
    }
    
    if (companyPersonnel.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">ğŸ‘¥</div><h3>HenÃ¼z personel kaydÄ± yok</h3></td></tr>';
        return;
    }
    
    companyPersonnel.forEach(person => {
        const statusClass = person.status === 'active' ? 'success' : 'danger';
        const statusText = person.status === 'active' ? 'Aktif' : 'Pasif';
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${person.name}</strong></td>
            <td>${person.position || '-'}</td>
            <td>${formatCurrency(person.salary || 0)}</td>
            <td>${person.sgkRate || 0}%</td>
            <td>${formatDate(person.startDate)}</td>
            <td><span class="badge badge-${statusClass}">${statusText}</span></td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editPersonnel('${person.id}')" title="DÃ¼zenle">âœï¸</button>
                <button class="btn btn-danger btn-sm" onclick="deletePersonnel('${person.id}')" title="Sil">ğŸ—‘ï¸</button>
            </td>
        `;
    });
    
    console.log('âœ… Personel tablosu render edildi:', companyPersonnel.length, 'personel');
}

async function loadAccounts() {
    if (!activeCompanyId || !auth.currentUser) {
        accounts = [];
        renderAccountsTable();
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('accounts').get();
        
        accounts = [];
        snapshot.forEach(doc => {
            accounts.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('âœ… Cari hesaplar yÃ¼klendi:', accounts.length);
        
    } catch (error) {
        console.error('âŒ Cari hesap yÃ¼kleme hatasÄ±:', error);
        accounts = [];
    }
    
    renderAccountsTable();
}

async function loadInvoices() {
    if (!activeCompanyId || !auth.currentUser) {
        invoices = [];
        renderInvoicesTable();
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('invoices').orderBy('date', 'desc').get();
        
        // â¬‡ï¸ DEÄÄ°ÅÄ°KLÄ°K: Sadece aktif faturalarÄ± filtrele
        invoices = [];
        snapshot.forEach(doc => {
            const invoice = { id: doc.id, ...doc.data() };
            // SilinmiÅŸ ve pasif olanlarÄ± atla
            if (invoice.status !== 'deleted' && invoice.status !== 'passive') {
                invoices.push(invoice);
            }
        });
        
        console.log('âœ… Faturalar yÃ¼klendi (sadece aktif):', invoices.length);
        
    } catch (error) {
        console.error('âŒ Fatura yÃ¼kleme hatasÄ±:', error);
        invoices = [];
    }
    
    renderInvoicesTable();
}

// Firmadan Cari Hesaplara GeÃ§iÅŸ Fonksiyonu
function viewCompanyAccounts(companyId) {
    // Firma seÃ§imini gÃ¼ncelle
    activeCompanyId = companyId;
    localStorage.setItem('activeCompanyId', activeCompanyId);
    
    // Filtre seÃ§imini ayarla
    const filterSelect = document.getElementById('filterAccountCompany');
    if (filterSelect) {
        filterSelect.value = companyId;
    }
    
    // Cari Hesaplar sekmesine geÃ§
    showTab('accounts');
    document.querySelector('.tab[onclick*="accounts"]').click();
    
    // Tabloyu gÃ¼ncelle
    populateSelects();
    loadAccounts();
    updateDashboard();
    
    // Bilgilendirme
    const company = companies.find(c => c.id === companyId);
    const accountCount = accounts.filter(a => a.companyId === companyId).length;
    
    setTimeout(() => {
        alert(`ğŸ“Š ${company.name}\n\n${accountCount} cari hesap gÃ¶steriliyor.`);
    }, 300);
}

async function deleteCompany(id) {
    if (!confirm('Bu firmayÄ± ve tÃ¼m ilgili verileri silmek istediÄŸinizden emin misiniz?')) {
        return;
    }
    
    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    try {
        // Firestore'dan sil
        await db.collection('companies').doc(id).delete();
        
        // KullanÄ±cÄ±nÄ±n firma listesinden Ã§Ä±kar
        await db.collection('users').doc(auth.currentUser.uid).update({
            companies: firebase.firestore.FieldValue.arrayRemove(id)
        });
        
        // Local array'den sil
        companies = companies.filter(c => c.id !== id);
        invoices = invoices.filter(inv => inv.companyId !== id);
        accounts = accounts.filter(acc => acc.companyId !== id);
        payments = payments.filter(pay => pay.companyId !== id);
        purchases = purchases.filter(pur => pur.companyId !== id);
        personnel = personnel.filter(per => per.companyId !== id);
        
        // Aktif firma silinmiÅŸse temizle
        if (activeCompanyId === id) {
            activeCompanyId = companies.length > 0 ? companies[0].id : null;
        }
        
        await loadCompanies();
        updateDashboard();
        
        alert('âœ… Firma ve ilgili tÃ¼m veriler silindi!');
        
    } catch (error) {
        console.error('Firma silme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

        function changeActiveCompany() {
            activeCompanyId = document.getElementById('activeCompanySelect').value;
            localStorage.setItem('activeCompanyId', activeCompanyId);
            updateDashboard();
            loadAccounts();
            loadInvoices();
            loadPayments();
            populateSelects();
        }


// ========================================
// ACCOUNT FUNCTIONS - GÃœNCELLENMIÅ
// ========================================

async function saveAccount(e) {
    e.preventDefault();
    
    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    const selectedCompanyId = document.getElementById('accountCompany').value;
    if (!selectedCompanyId) {
        alert('âš ï¸ LÃ¼tfen bir firma seÃ§in!');
        return;
    }
    
    // ========================================
    // DUPLICATE KONTROL (YENÄ° EKLEME)
    // ========================================
    const accountId = document.getElementById('accountId').value;
    const accountName = document.getElementById('accountName').value.trim();
    const accountTaxNo = document.getElementById('accountTaxNo').value.trim();
    
    // Yeni kayÄ±t ise duplicate kontrol et
    if (!accountId) {
        const newAccountKey = `${accountName.toUpperCase()}_${accountTaxNo || ""}`;
        
        const existingAccount = accounts
            .filter(a => a.companyId === selectedCompanyId)
            .filter(a => a.status !== "passive" && a.status !== "deleted")
            .find(a => {
                const existingKey = `${a.name.trim().toUpperCase()}_${a.taxNo || ""}`;
                return existingKey === newAccountKey;
            });
        
        if (existingAccount) {
            const confirmCreate = confirm(
                `âš ï¸ "${accountName}" isimli cari hesap zaten kayÄ±tlÄ±!\n\n` +
                `Mevcut cari:\n` +
                `â€¢ Ä°sim: ${existingAccount.name}\n` +
                `â€¢ Vergi No: ${existingAccount.taxNo || 'Yok'}\n` +
                `â€¢ Bakiye: ${formatCurrency(existingAccount.balance)}\n` +
                `â€¢ TÃ¼r: ${existingAccount.type === 'customer' ? 'MÃ¼ÅŸteri' : 'TedarikÃ§i'}\n\n` +
                `Yine de YENÄ° cari oluÅŸturmak ister misiniz?\n\n` +
                `âŒ HAYIR â†’ Ä°ptal et (Ã¶nerilen)\n` +
                `âœ… EVET â†’ Yeni cari oluÅŸtur (duplicate olur)`
            );
            
            if (!confirmCreate) {
                console.log('KullanÄ±cÄ± duplicate cari oluÅŸturmayÄ± iptal etti');
                return;
            }
        }
    }
    
    // ========================================
    // DÃ–KÃœMAN YÃœKLEME
    // ========================================
    let uploadedDocs = [];
    if (accountDocuments.length > 0) {
        try {
            // GeÃ§ici ID oluÅŸtur (dÃ¶kÃ¼man yÃ¼kleme iÃ§in)
            const tempAccountId = accountId || `temp_${Date.now()}`;
            uploadedDocs = await uploadAccountDocuments(selectedCompanyId, tempAccountId, accountDocuments);
            console.log('âœ… Cari dÃ¶kÃ¼manlarÄ± yÃ¼klendi:', uploadedDocs.length);
        } catch (error) {
            console.error('âš ï¸ DÃ¶kÃ¼man yÃ¼kleme hatasÄ±:', error);
            alert('âš ï¸ BazÄ± dÃ¶kÃ¼manlar yÃ¼klenemedi ama cari kaydedilecek.');
        }
    }
    
    const now = new Date().toISOString();
    let accountData = null;
    
    try {
        // ========================================
        // GÃœNCELLEME (Mevcut Cari)
        // ========================================
        if (accountId) {
            console.log('ğŸ”„ Cari gÃ¼ncelleniyor:', accountId);
            
            const account = accounts.find(a => a.id === accountId);
            if (!account) {
                alert('âŒ Cari hesap bulunamadÄ±!');
                return;
            }
            
            // Eski ve yeni deÄŸerleri al
            const oldCompanyId = account.companyId;
            const oldType = account.type;
            const newType = document.getElementById('accountType').value;
            
            // GÃ¼ncellenmiÅŸ veriyi hazÄ±rla
            const updatedData = {
                name: accountName,
                companyId: selectedCompanyId,
                type: newType,
                taxNo: accountTaxNo,
                phone: document.getElementById('accountPhone').value,
                email: document.getElementById('accountEmail')?.value || '',
                address: document.getElementById('accountAddress').value,
                documents: uploadedDocs.length > 0 ? uploadedDocs : (account.documents || []),
                updatedAt: now,
                updatedBy: auth.currentUser.uid
            };
            
            // Firebase'e kaydet
            await db.collection('companies').doc(oldCompanyId)
                .collection('accounts').doc(accountId).update(updatedData);
            
            // Local array'i gÃ¼ncelle
            Object.assign(account, updatedData);
            accountData = account;
            
            console.log('âœ… Cari gÃ¼ncellendi');
            
        } 
        // ========================================
        // YENÄ° KAYIT
        // ========================================
        else {
            console.log('â• Yeni cari oluÅŸturuluyor');
            
            const newAccountRef = db.collection('companies').doc(selectedCompanyId)
                .collection('accounts').doc();
            
            const newAccount = {
                id: newAccountRef.id,
                companyId: selectedCompanyId,
                name: accountName,
                type: document.getElementById('accountType').value,
                taxNo: accountTaxNo,
                phone: document.getElementById('accountPhone').value,
                email: document.getElementById('accountEmail')?.value || '',
                address: document.getElementById('accountAddress').value,
                balance: 0,
                documents: uploadedDocs,
                status: 'active',
                createdAt: now,
                createdBy: auth.currentUser.uid,
                updatedAt: now,
                updatedBy: auth.currentUser.uid
            };
            
            await newAccountRef.set(newAccount);
            
            accounts.push(newAccount);
            accountData = newAccount;
            
            console.log('âœ… Yeni cari oluÅŸturuldu:', newAccount.id);
        }
        
        // ========================================
        // TEMÄ°ZLEME VE YENÄ°LEME
        // ========================================
        document.getElementById('accountForm').reset();
        document.getElementById('accountId').value = '';
        accountDocuments = [];
        renderAccountDocuments();
        cancelAccountEdit();
        
        await loadAccounts();
        populateSelects();
        
        // Modal'Ä± kapat (eÄŸer modal iÃ§inde aÃ§Ä±ldÄ±ysa)
        const modal = document.getElementById('addAccountModal');
        if (modal && modal.classList.contains('active')) {
            modal.classList.remove('active');
        }
        
        alert('âœ… Cari hesap baÅŸarÄ±yla kaydedildi!');
        
    } catch (error) {
        console.error('âŒ Cari hesap kayÄ±t hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

// ========================================
// DUPLICATE CARÄ° TEMÄ°ZLEME
// ========================================
async function findAndMergeDuplicateAccounts() {
    if (!confirm(
        'ğŸ” Duplicate cari hesaplarÄ± bulmak ve birleÅŸtirmek ister misiniz?\n\n' +
        'Bu iÅŸlem:\n' +
        'âœ… AynÄ± isim ve vergi numaralÄ± carileri bulur\n' +
        'âœ… Fatura ve Ã¶demeleri tek cariye taÅŸÄ±r\n' +
        'âœ… Gereksiz duplicate carileri pasif yapar\n\n' +
        'Devam etmek istiyor musunuz?'
    )) {
        return;
    }
    
    try {
        const duplicateGroups = {};
        
        // Carileri grupla (isim + vergi no)
        accounts
            .filter(a => a.status !== 'deleted' && a.companyId === activeCompanyId)
            .forEach(account => {
                const key = getAccountUniqueKey(account);
                if (!duplicateGroups[key]) {
                    duplicateGroups[key] = [];
                }
                duplicateGroups[key].push(account);
            });
        
        // Sadece 2+ kayÄ±tlÄ± olanlarÄ± al
        const duplicates = Object.values(duplicateGroups).filter(group => group.length > 1);
        
        if (duplicates.length === 0) {
            alert('âœ… Duplicate cari hesap bulunamadÄ±!');
            return;
        }
        
        console.log(`ğŸ” ${duplicates.length} grup duplicate bulundu`);
        
        let mergedCount = 0;
        const batch = db.batch();
        
        for (const group of duplicates) {
            console.log(`\nğŸ“‹ Grup: ${group[0].name}`);
            
            // En eski veya en Ã§ok iÅŸleme sahip olanÄ± "master" yap
            let master = group[0];
            
            for (const account of group) {
                const invoiceCount = invoices.filter(inv => inv.accountId === account.id).length;
                const paymentCount = payments.filter(p => p.accountId === account.id).length;
                const totalTransactions = invoiceCount + paymentCount;
                
                const masterInvoiceCount = invoices.filter(inv => inv.accountId === master.id).length;
                const masterPaymentCount = payments.filter(p => p.accountId === master.id).length;
                const masterTotalTransactions = masterInvoiceCount + masterPaymentCount;
                
                if (totalTransactions > masterTotalTransactions) {
                    master = account;
                }
            }
            
            console.log(`âœ… Master cari: ${master.name} (ID: ${master.id})`);
            
            // DiÄŸerlerini master'a taÅŸÄ±
            for (const duplicate of group) {
                if (duplicate.id === master.id) continue;
                
                console.log(`ğŸ”„ TaÅŸÄ±nÄ±yor: ${duplicate.name} (ID: ${duplicate.id})`);
                
                // FaturalarÄ± taÅŸÄ±
                invoices
                    .filter(inv => inv.accountId === duplicate.id)
                    .forEach(inv => {
                        batch.update(
                            db.collection('companies').doc(activeCompanyId)
                                .collection('invoices').doc(inv.id),
                            { accountId: master.id }
                        );
                        inv.accountId = master.id;
                    });
                
                // Ã–demeleri taÅŸÄ±
                payments
                    .filter(p => p.accountId === duplicate.id)
                    .forEach(p => {
                        batch.update(
                            db.collection('companies').doc(activeCompanyId)
                                .collection('payments').doc(p.id),
                            { accountId: master.id }
                        );
                        p.accountId = master.id;
                    });
                
                // Duplicate'i pasif yap
                batch.update(
                    db.collection('companies').doc(activeCompanyId)
                        .collection('accounts').doc(duplicate.id),
                    { status: 'passive', mergedTo: master.id }
                );
                
                duplicate.status = 'passive';
                mergedCount++;
            }
        }
        
        await batch.commit();
        
        await loadAccounts();
        await loadInvoices();
        await loadPayments();
        updateDashboard();
        
        alert(
            `âœ… BirleÅŸtirme tamamlandÄ±!\n\n` +
            `ğŸ“Š ${duplicates.length} grup iÅŸlendi\n` +
            `â™»ï¸ ${mergedCount} duplicate cari birleÅŸtirildi`
        );
        
    } catch (error) {
        console.error('Duplicate temizleme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

async function deleteAccount(id) {
    const account = accounts.find(a => a.id === id);
    
    const relatedInvoices = invoices.filter(inv => inv.accountId === id);
    const relatedPayments = payments.filter(p => p.accountId === id);
    
    if (relatedInvoices.length > 0 || relatedPayments.length > 0) {
        if (!confirm(`âš ï¸ Bu cari hesaba baÄŸlÄ± ${relatedInvoices.length} fatura ve ${relatedPayments.length} Ã¶deme var!\n\nSilmek istediÄŸinizden emin misiniz?`)) {
            return;
        }
    } else {
        if (!confirm('Bu cari hesabÄ± silmek istediÄŸinizden emin misiniz?')) {
            return;
        }
    }
    
    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    try {
        await db.collection('companies').doc(account.companyId)
            .collection('accounts').doc(id).delete();
        
        accounts = accounts.filter(a => a.id !== id);
        
        await loadAccounts();
        populateSelects();
        
        alert('âœ… Cari hesap silindi!');
        
    } catch (error) {
        console.error('Cari hesap silme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

function updateAccountCompanyInfo() {
    const companyId = document.getElementById('accountCompany').value;
    const company = companies.find(c => c.id === companyId);
    const infoDiv = document.getElementById('accountCompanyInfo');
    const infoSpan = document.getElementById('accountActiveCompanyName');
    
    if (company) {
        infoSpan.textContent = company.name;
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
}

// ========================================
// CARÄ° FÄ°LTRELEME VE SIRALAMA - YENÄ° SÄ°STEM
// ========================================

let currentAccountSort = { field: 'name', direction: 'asc' };

function filterAndSortAccounts() {
    console.log('ğŸ” Cari filtreleme baÅŸlÄ±yor...');
    
    const companyFilter = document.getElementById('filterAccountCompany').value;
    const typeFilter = document.getElementById('filterAccountType').value;
    const balanceFilter = document.getElementById('filterAccountBalance').value;
    const searchTerm = document.getElementById('searchAccount').value.toLowerCase().trim();
    const sortValue = document.getElementById('sortAccount').value;
    
    // Filtre uygula
    let filtered = accounts.filter(account => {
        // Status kontrolÃ¼ - sadece aktif cariler
        if (account.status === 'deleted' || account.status === 'passive') {
            return false;
        }
        
        // Firma filtresi
        if (companyFilter && account.companyId !== companyFilter) {
            return false;
        }
        
        // TÃ¼r filtresi
        if (typeFilter && account.type !== typeFilter) {
            return false;
        }
        
        // Bakiye filtresi
        if (balanceFilter) {
            const balance = account.balance || 0;
            if (balanceFilter === 'positive' && balance <= 0) return false;
            if (balanceFilter === 'negative' && balance >= 0) return false;
            if (balanceFilter === 'zero' && Math.abs(balance) > 0.01) return false;
        }
        
        // Arama terimi
        if (searchTerm) {
            const searchableText = [
                account.name || '',
                account.taxNo || '',
                account.phone || '',
                account.email || '',
                account.address || ''
            ].join(' ').toLowerCase();
            
            if (!searchableText.includes(searchTerm)) {
                return false;
            }
        }
        
        return true;
    });
    
    console.log(`ğŸ“Š Filtrelendi: ${filtered.length}/${accounts.length}`);
    
    // SÄ±ralama uygula
    const [sortField, sortDir] = sortValue.split('-');
    currentAccountSort = { field: sortField, direction: sortDir };
    
    filtered = sortAccounts(filtered, sortField, sortDir);
    
    // Tabloyu render et
    renderAccountsTable(filtered);
    
    // SayaÃ§larÄ± gÃ¼ncelle
    updateAccountCount(filtered.length, accounts.filter(a => 
        a.status !== 'deleted' && a.status !== 'passive'
    ).length);
}

function sortAccounts(accountsList, field, direction) {
    const sorted = [...accountsList];
    
    sorted.sort((a, b) => {
        let valA, valB;
        
        switch(field) {
            case 'name':
                valA = (a.name || '').toLowerCase();
                valB = (b.name || '').toLowerCase();
                break;
            
            case 'balance':
                valA = a.balance || 0;
                valB = b.balance || 0;
                break;
            
            case 'date':
                valA = new Date(a.createdAt || 0);
                valB = new Date(b.createdAt || 0);
                break;
            
            case 'company':
                const companyA = companies.find(c => c.id === a.companyId);
                const companyB = companies.find(c => c.id === b.companyId);
                valA = (companyA?.name || '').toLowerCase();
                valB = (companyB?.name || '').toLowerCase();
                break;
            
            case 'type':
                valA = a.type || '';
                valB = b.type || '';
                break;
            
            default:
                return 0;
        }
        
        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    return sorted;
}

function sortAccountsBy(field) {
    // TÄ±klanan sÃ¼tuna gÃ¶re sÄ±ralama yÃ¶nÃ¼nÃ¼ deÄŸiÅŸtir
    if (currentAccountSort.field === field) {
        currentAccountSort.direction = currentAccountSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentAccountSort.field = field;
        currentAccountSort.direction = 'asc';
    }
    
    // SÄ±ralama select'ini gÃ¼ncelle
    document.getElementById('sortAccount').value = `${field}-${currentAccountSort.direction}`;
    
    // Ok iÅŸaretlerini gÃ¼ncelle
    updateSortIcons(field, currentAccountSort.direction);
    
    // Filtrelemeyi yeniden Ã§alÄ±ÅŸtÄ±r
    filterAndSortAccounts();
}

function updateSortIcons(activeField, direction) {
    // TÃ¼m ok iÅŸaretlerini sÄ±fÄ±rla
    ['sortCompany', 'sortName', 'sortType', 'sortBalance'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = 'â‡…';
    });
    
    // Aktif sÃ¼tunun okunu gÃ¼ncelle
    const iconMap = {
        'company': 'sortCompany',
        'name': 'sortName',
        'type': 'sortType',
        'balance': 'sortBalance'
    };
    
    const iconId = iconMap[activeField];
    if (iconId) {
        const element = document.getElementById(iconId);
        if (element) {
            element.textContent = direction === 'asc' ? 'â†‘' : 'â†“';
        }
    }
}

function updateAccountCount(filtered, total) {
    const countElement = document.getElementById('totalAccountsCount');
    if (countElement) {
        if (filtered === total) {
            countElement.textContent = total;
        } else {
            countElement.textContent = `${filtered} / ${total}`;
        }
    }
}

function clearAccountFilters() {
    document.getElementById('filterAccountCompany').value = '';
    document.getElementById('filterAccountType').value = '';
    document.getElementById('filterAccountBalance').value = '';
    document.getElementById('searchAccount').value = '';
    document.getElementById('sortAccount').value = 'name-asc';
    
    currentAccountSort = { field: 'name', direction: 'asc' };
    updateSortIcons('name', 'asc');
    
    filterAndSortAccounts();
}

// ========================================
// RENDER FONKSÄ°YONU - GÃœNCELLENMÄ°Å
// ========================================

function renderAccountsTable(accountsList = null) {
    const tbody = document.querySelector('#accountsTable tbody');
    if (!tbody) {
        console.warn('Accounts table tbody bulunamadÄ±');
        return;
    }
    
    tbody.innerHTML = '';
    
    // EÄŸer liste verilmediyse tÃ¼m aktif carileri kullan
    if (!accountsList) {
        accountsList = accounts.filter(a => 
            a.status !== 'deleted' && a.status !== 'passive'
        );
    }
    
    if (accountsList.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align:center; padding:40px; color:#6b7280;">
                    <div style="font-size:3em; margin-bottom:10px;">ğŸ‘¥</div>
                    <h3>Cari hesap bulunamadÄ±</h3>
                    <p>Filtrelerinizi deÄŸiÅŸtirin veya yeni cari ekleyin.</p>
                </td>
            </tr>
        `;
        updateAccountCount(0, accounts.filter(a => 
            a.status !== 'deleted' && a.status !== 'passive'
        ).length);
        return;
    }
    
    accountsList.forEach(account => {
        const company = companies.find(c => c.id === account.companyId);
        const balanceColor = account.balance >= 0 ? 'var(--success)' : 'var(--danger)';
        const typeText = account.type === 'customer' ? 'ğŸ‘¤ MÃ¼ÅŸteri' : 'ğŸ¢ TedarikÃ§i';
        const typeBadge = account.type === 'customer' ? 'badge-success' : 'badge-warning';
        
        const hasDocuments = account.documents && account.documents.length > 0;
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${company ? company.name : '<span style="color:#6b7280;">Firma SilinmiÅŸ</span>'}</td>
            <td><strong>${account.name}</strong></td>
            <td><span class="badge ${typeBadge}">${typeText}</span></td>
            <td>${account.phone || '-'}</td>
            <td style="font-weight: 700; color: ${balanceColor};">
                ${formatCurrency(account.balance || 0)}
            </td>
            <td style="text-align: center;">
                ${hasDocuments ? `
                    <button class="btn btn-info btn-sm" onclick="viewAccountDocuments('${account.id}')" title="DÃ¶kÃ¼manlarÄ± GÃ¶rÃ¼ntÃ¼le">
                        ğŸ“„ ${account.documents.length}
                    </button>
                ` : '<span style="color:#6b7280;">-</span>'}
            </td>
            <td style="white-space: nowrap;">
                <button class="btn btn-info btn-sm" onclick="viewAccountCard('${account.id}')" title="Cari KartÄ±">
                    ğŸ“Š
                </button>
                <button class="btn btn-warning btn-sm" onclick="editAccount('${account.id}')" title="DÃ¼zenle">
                    âœï¸
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteAccount('${account.id}')" title="Sil">
                    ğŸ—‘ï¸
                </button>
            </td>
        `;
    });
    
    updateAccountCount(accountsList.length, accounts.filter(a => 
        a.status !== 'deleted' && a.status !== 'passive'
    ).length);
}

        // INVOICE FUNCTIONS
        let invoiceItems = [];

        function addInvoiceItem() {
            const item = {
                id: Date.now() + Math.random(),
                description: '',
                quantity: 1,
                unitPrice: 0,
                vatRate: 20,
                amount: 0,
                vatAmount: 0
            };

            invoiceItems.push(item);
            renderInvoiceItems();
        }

        function renderInvoiceItems() {
            const container = document.getElementById('invoiceItemsList');
            container.innerHTML = '';

            invoiceItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'invoice-item';
                div.innerHTML = `
                    <div class="form-group">
                        <label>AÃ§Ä±klama</label>
                        <input type="text" value="${item.description}" onchange="updateInvoiceItem(${index}, 'description', this.value)" required>
                    </div>
                    <div class="form-group">
                        <label>Miktar</label>
                        <input type="number" value="${item.quantity}" onchange="updateInvoiceItem(${index}, 'quantity', this.value)" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Birim Fiyat</label>
                        <input type="number" value="${item.unitPrice}" onchange="updateInvoiceItem(${index}, 'unitPrice', this.value)" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>KDV %</label>
                        <select onchange="updateInvoiceItem(${index}, 'vatRate', this.value)">
                            <option value="0" ${item.vatRate == 0 ? 'selected' : ''}>%0</option>
                            <option value="1" ${item.vatRate == 1 ? 'selected' : ''}>%1</option>
                            <option value="8" ${item.vatRate == 8 ? 'selected' : ''}>%8</option>
                            <option value="10" ${item.vatRate == 10 ? 'selected' : ''}>%10</option>
                            <option value="18" ${item.vatRate == 18 ? 'selected' : ''}>%18</option>
                            <option value="20" ${item.vatRate == 20 ? 'selected' : ''}>%20</option>
                        </select>
                    </div>
                    <div>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(${index})">ğŸ—‘ï¸</button>
                    </div>
                `;
                container.appendChild(div);
            });

            calculateInvoiceTotals();
        }

        function updateInvoiceItem(index, field, value) {
            invoiceItems[index][field] = field === 'description' ? value : parseFloat(value) || 0;
            calculateInvoiceTotals();
        }

        function removeInvoiceItem(index) {
            if (invoiceItems.length === 1) {
                alert('âš ï¸ En az bir fatura kalemi olmalÄ±dÄ±r!');
                return;
            }
            invoiceItems.splice(index, 1);
            renderInvoiceItems();
        }

        function calculateInvoiceTotals() {
            let subtotal = 0;
            let totalVAT = 0;

            invoiceItems.forEach(item => {
                item.amount = item.quantity * item.unitPrice;
                item.vatAmount = item.amount * (item.vatRate / 100);
                subtotal += item.amount;
                totalVAT += item.vatAmount;
            });

            const total = subtotal + totalVAT;

            document.getElementById('invoiceSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('invoiceVAT').textContent = formatCurrency(totalVAT);
            document.getElementById('invoiceTotal').textContent = formatCurrency(total);
        }

async function saveInvoice(e) {
    e.preventDefault();

    if (!activeCompanyId) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce bir firma seÃ§in!');
        return;
    }

    if (invoiceItems.length === 0 || !invoiceItems[0].description) {
        alert('âš ï¸ LÃ¼tfen en az bir fatura kalemi ekleyin!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }

    const invoiceId = document.getElementById('invoiceId').value;
    const subtotal = invoiceItems.reduce((sum, item) => sum + item.amount, 0);
    const vatAmount = invoiceItems.reduce((sum, item) => sum + item.vatAmount, 0);
    const total = subtotal + vatAmount;

    try {
        let receiptUrl = null;
        
        // EÄŸer yeni dekont yÃ¼klendiyse Storage'a yÃ¼kle
        if (currentInvoiceReceipt && currentInvoiceReceipt instanceof File) {
            const tempId = invoiceId || Date.now().toString();
            const fileName = `${Date.now()}_${currentInvoiceReceipt.name}`;
            const storageRef = storage.ref(`companies/${activeCompanyId}/invoices/${tempId}/${fileName}`);
            
            const snapshot = await storageRef.put(currentInvoiceReceipt);
            receiptUrl = await snapshot.ref.getDownloadURL();
            
            console.log('âœ… Fatura dekontÄ± yÃ¼klendi:', receiptUrl);
        }

        let invoiceData;

        if (invoiceId) {
            // Update existing invoice
            const invoice = invoices.find(inv => inv.id === invoiceId);
            const oldTotal = invoice.total;
            const oldType = invoice.type;
            const oldAccountId = invoice.accountId;

            const updatedData = {
                type: document.getElementById('invoiceType').value,
                invoiceNo: document.getElementById('invoiceNo').value,
                date: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('invoiceDueDate').value,
                accountId: document.getElementById('invoiceAccount').value,
                description: document.getElementById('invoiceDescription').value,
                items: JSON.parse(JSON.stringify(invoiceItems)),
                subtotal: subtotal,
                vatAmount: vatAmount,
                total: total,
                receiptUrl: receiptUrl || invoice.receiptUrl,
                updatedAt: new Date().toISOString(),
                updatedBy: auth.currentUser.uid
            };

            await db.collection('companies').doc(activeCompanyId)
                .collection('invoices').doc(invoiceId).update(updatedData);

            // Bakiye gÃ¼ncellemeleri
            const oldAccount = accounts.find(a => a.id === oldAccountId);
            if (oldAccount) {
                if (oldType === 'sales') {
                    oldAccount.balance -= oldTotal;
                } else {
                    oldAccount.balance += oldTotal;
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('accounts').doc(oldAccountId).update({
                        balance: oldAccount.balance
                    });
            }

	    const newAccount = accounts.find(a => a.id === updatedData.accountId);  // âœ… DOÄRU

            if (newAccount) {
                if (updatedData.type === 'sales') {
                    newAccount.balance += total;
                } else {
                    newAccount.balance -= total;
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('accounts').doc(updatedData.accountId).update({
                        balance: newAccount.balance
                    });
            }

            Object.assign(invoice, updatedData);
            invoiceData = invoice;
            
        } else {
            // Create new invoice
            const newInvoiceRef = db.collection('companies').doc(activeCompanyId)
                .collection('invoices').doc();
            const newInvoiceId = newInvoiceRef.id;

            const newInvoice = {
                id: newInvoiceId,
                companyId: activeCompanyId,
                type: document.getElementById('invoiceType').value,
                invoiceNo: document.getElementById('invoiceNo').value,
                date: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('invoiceDueDate').value,
                accountId: document.getElementById('invoiceAccount').value,
                description: document.getElementById('invoiceDescription').value,
                items: JSON.parse(JSON.stringify(invoiceItems)),
                subtotal: subtotal,
                vatAmount: vatAmount,
                total: total,
                paidAmount: 0,
                status: 'unpaid',
                receiptUrl: receiptUrl,
                createdAt: new Date().toISOString(),
                createdBy: auth.currentUser.uid
            };

            await newInvoiceRef.set(newInvoice);

            // Update account balance
            const account = accounts.find(a => a.id === newInvoice.accountId);
            if (account) {
                if (newInvoice.type === 'sales') {
                    account.balance += total;
                } else {
                    account.balance -= total;
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('accounts').doc(newInvoice.accountId).update({
                        balance: account.balance
                    });
            }

            invoices.push(newInvoice);
            invoiceData = newInvoice;
        }

        document.getElementById('invoiceForm').reset();
        document.getElementById('invoiceDate').valueAsDate = new Date();
        document.getElementById('invoiceId').value = '';
        invoiceItems = [];
        addInvoiceItem();
        cancelInvoiceEdit();
        
        clearInvoiceReceipt();
        
        await loadInvoices();
        await loadAccounts();
        updateDashboard();

        alert('âœ… Fatura baÅŸarÄ±yla kaydedildi!');
        
    } catch (error) {
        console.error('Fatura kayÄ±t hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

        function editInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            document.getElementById('invoiceId').value = invoice.id;
            document.getElementById('invoiceType').value = invoice.type;
            document.getElementById('invoiceNo').value = invoice.invoiceNo;
            document.getElementById('invoiceDate').value = invoice.date;
            document.getElementById('invoiceDueDate').value = invoice.dueDate || '';
            document.getElementById('invoiceAccount').value = invoice.accountId;
            document.getElementById('invoiceDescription').value = invoice.description || '';

            invoiceItems = JSON.parse(JSON.stringify(invoice.items));
            renderInvoiceItems();

            document.getElementById('saveInvoiceBtn').textContent = 'ğŸ’¾ GÃ¼ncelle';
            document.getElementById('cancelInvoiceBtn').style.display = 'inline-block';

            showTab('invoices');
            document.getElementById('invoiceForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelInvoiceEdit() {
            document.getElementById('invoiceForm').reset();
            document.getElementById('invoiceId').value = '';
            document.getElementById('invoiceDate').valueAsDate = new Date();
            document.getElementById('saveInvoiceBtn').textContent = 'ğŸ’¾ Fatura Kaydet';
            document.getElementById('cancelInvoiceBtn').style.display = 'none';
            invoiceItems = [];
            addInvoiceItem();
        }

        function viewInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            const account = accounts.find(a => a.id === invoice.accountId);
            const company = companies.find(c => c.id === invoice.companyId);
            const typeText = invoice.type === 'sales' ? 'SATIÅ FATURASI' : 'ALIÅ FATURASI';
            
            let itemsHtml = '<table style="width:100%; margin-top:20px; border-collapse: collapse;"><thead><tr style="background:#2563eb; color:white;"><th style="padding:10px; border:1px solid #ddd;">AÃ§Ä±klama</th><th style="padding:10px; border:1px solid #ddd;">Miktar</th><th style="padding:10px; border:1px solid #ddd;">Birim Fiyat</th><th style="padding:10px; border:1px solid #ddd;">KDV %</th><th style="padding:10px; border:1px solid #ddd;">Tutar</th></tr></thead><tbody>';
            
            invoice.items.forEach(item => {
                itemsHtml += `
                    <tr>
                        <td style="padding:10px; border:1px solid #ddd;">${item.description}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:center;">${item.quantity}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right;">${formatCurrency(item.unitPrice)}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:center;">%${item.vatRate}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right;"><strong>${formatCurrency(item.amount + item.vatAmount)}</strong></td>
                    </tr>
                `;
            });
            
            itemsHtml += '</tbody></table>';

            const remaining = invoice.total - (invoice.paidAmount || 0);
            const paymentStatusHtml = invoice.paidAmount > 0 ? `
                <div style="margin-top:20px; padding:15px; background:#dbeafe; border-radius:8px;">
                    <p><strong>Ã–deme Durumu:</strong></p>
                    <p>Ã–denen: ${formatCurrency(invoice.paidAmount)}</p>
                    <p>Kalan: ${formatCurrency(remaining)}</p>
                </div>
            ` : '';

            const content = `
                <div style="max-width: 900px; margin: 0 auto;">
                    <h2 style="color:#2563eb; border-bottom:3px solid #2563eb; padding-bottom:10px;">${typeText}</h2>
                    <div style="margin: 20px 0; padding: 20px; background: #f3f4f6; border-radius: 8px;">
                        <p><strong>Firma:</strong> ${company ? company.name : '-'}</p>
                        <p><strong>Fatura No:</strong> ${invoice.invoiceNo}</p>
                        <p><strong>Tarih:</strong> ${formatDate(invoice.date)}</p>
                        ${invoice.dueDate ? `<p><strong>Vade:</strong> ${formatDate(invoice.dueDate)}</p>` : ''}
                        <p><strong>Cari:</strong> ${account ? account.name : 'SilinmiÅŸ'}</p>
                        <p><strong>AÃ§Ä±klama:</strong> ${invoice.description || '-'}</p>
                    </div>
                    ${itemsHtml}
                    ${paymentStatusHtml}
                    <div style="margin-top:30px; text-align:right; padding:20px; background:#f3f4f6; border-radius:8px;">
                        <p style="font-size:1.1em;"><strong>Ara Toplam:</strong> ${formatCurrency(invoice.subtotal)}</p>
                        <p style="font-size:1.1em;"><strong>KDV:</strong> ${formatCurrency(invoice.vatAmount)}</p>
                        <hr style="margin:15px 0;">
                        <p style="font-size:2em; color:#2563eb;"><strong>TOPLAM:</strong> ${formatCurrency(invoice.total)}</p>
                    </div>
                </div>
            `;

            const win = window.open('', 'Fatura', 'width=900,height=700');
            win.document.write(`
                <html>
                    <head>
                        <title>Fatura ${invoice.invoiceNo}</title>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: Arial, sans-serif; padding: 40px; }
                            @media print { button { display: none !important; } }
                        </style>
                    </head>
                    <body>
                        ${content}
                        <div style="text-align:center; margin-top:30px;">
                            <button onclick="window.print()" style="padding:12px 30px; background:#2563eb; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px;">ğŸ–¨ï¸ YazdÄ±r</button>
                            <button onclick="window.close()" style="padding:12px 30px; background:#6b7280; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; margin-left:10px;">âœ–ï¸ Kapat</button>
                        </div>
                    </body>
                </html>
            `);
        }

async function deleteInvoice(id) {
    const invoice = invoices.find(inv => inv.id === id);
    
    if (!invoice || !auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    // ========================================
    // KULLANICIYA SEÃ‡ENEK SUN
    // ========================================
    const choice = confirm(
        'ğŸ—‘ï¸ Fatura Silme SeÃ§enekleri:\n\n' +
        'âœ… TAMAM â†’ Ã‡Ã¶p kutusuna taÅŸÄ± (30 gÃ¼n sonra otomatik silinir)\n' +
        'âŒ Ä°PTAL â†’ KalÄ±cÄ± olarak sil (geri alÄ±namaz)\n\n' +
        'Ã‡Ã¶p kutusuna taÅŸÄ±mak iÃ§in TAMAM\'a basÄ±n.'
    );
    
    try {
        if (choice) {
            // ========================================
            // SEÃ‡Ä°M 1: SOFT DELETE (Ã‡Ã¶p Kutusu)
            // ========================================
            await softDeleteInvoice(id, invoice);
        } else {
            // ========================================
            // SEÃ‡Ä°M 2: HARD DELETE (KalÄ±cÄ± Silme)
            // ========================================
            const confirmHard = confirm(
                'âš ï¸ DÄ°KKAT!\n\n' +
                'FaturayÄ± KALICI olarak silmek istediÄŸinize emin misiniz?\n' +
                'Bu iÅŸlem GERÄ° ALINAMAZ!\n\n' +
                'Fatura No: ' + invoice.invoiceNo + '\n' +
                'Tutar: ' + formatCurrency(invoice.total)
            );
            
            if (confirmHard) {
                await hardDeleteInvoice(id, invoice);
            } else {
                return; // KullanÄ±cÄ± vazgeÃ§ti
            }
        }
        
    } catch (error) {
        console.error('âŒ Fatura silme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

// ========================================
// SOFT DELETE FONKSÄ°YONU
// ========================================
async function softDeleteInvoice(id, invoice) {
    console.log('ğŸ—‘ï¸ Soft delete baÅŸlÄ±yor:', id);
    
    // Silme tarihini hesapla (30 gÃ¼n sonra)
    const deleteDate = new Date();
    deleteDate.setDate(deleteDate.getDate() + 30);
    
    // FaturayÄ± "deleted" olarak iÅŸaretle
    await db.collection('companies').doc(activeCompanyId)
        .collection('invoices').doc(id).update({
            status: 'deleted',
            deletedAt: new Date().toISOString(),
            deletedBy: auth.currentUser.uid,
            permanentDeleteDate: deleteDate.toISOString(),
            previousStatus: invoice.status || 'unpaid' // Eski durumu sakla
        });
    
    // Cari bakiyesini dÃ¼zelt
    const account = accounts.find(a => a.id === invoice.accountId);
    if (account) {
        const remainingAmount = invoice.total - (invoice.paidAmount || 0);
        
        if (invoice.type === 'sales') {
            account.balance -= remainingAmount;
        } else {
            account.balance += remainingAmount;
        }
        
        await db.collection('companies').doc(activeCompanyId)
            .collection('accounts').doc(account.id).update({
                balance: account.balance
            });
    }
    
    // Local array'den kaldÄ±r
    invoices = invoices.filter(inv => inv.id !== id);
    
    // UI'Ä± gÃ¼ncelle
    await loadInvoices();
    await loadAccounts();
    updateDashboard();
    
    alert(
        'âœ… Fatura Ã§Ã¶p kutusuna taÅŸÄ±ndÄ±!\n\n' +
        'ğŸ“… ' + deleteDate.toLocaleDateString('tr-TR') + ' tarihinde otomatik silinecek.\n\n' +
        'ğŸ’¡ Geri almak iÃ§in Ayarlar â†’ Ã‡Ã¶p Kutusu bÃ¶lÃ¼mÃ¼nden geri yÃ¼kleyebilirsiniz.'
    );
}

// ========================================
// HARD DELETE FONKSÄ°YONU
// ========================================
async function hardDeleteInvoice(id, invoice) {
    console.log('ğŸ’£ Hard delete baÅŸlÄ±yor:', id);
    
    // Ä°lgili Ã¶demeleri kontrol et
    const relatedPayments = payments.filter(p => p.invoiceId === id);
    
    if (relatedPayments.length > 0) {
        const totalPaid = relatedPayments.reduce((sum, p) => sum + p.amount, 0);
        
        const confirmWithPayments = confirm(
            `âš ï¸ Bu faturaya ${formatCurrency(totalPaid)} Ã¶deme yapÄ±lmÄ±ÅŸ!\n\n` +
            'Fatura ve Ã¶demeler KALICI olarak silinecek.\n' +
            'Devam edilsin mi?'
        );
        
        if (!confirmWithPayments) {
            return;
        }
        
        // Batch iÅŸlem baÅŸlat
        const batch = db.batch();
        
        // Ã–demeleri sil
        for (const payment of relatedPayments) {
            const paymentRef = db.collection('companies').doc(activeCompanyId)
                .collection('payments').doc(payment.id);
            batch.delete(paymentRef);
            
            // Ã–deme bakiyesini geri al
            const payAccount = accounts.find(a => a.id === payment.accountId);
            if (payAccount) {
                if (payAccount.type === 'customer') {
                    if (payment.type === 'income') {
                        payAccount.balance += payment.amount;
                    }
                } else {
                    if (payment.type === 'expense') {
                        payAccount.balance -= payment.amount;
                    }
                }
                
                const accountRef = db.collection('companies').doc(activeCompanyId)
                    .collection('accounts').doc(payAccount.id);
                batch.update(accountRef, { balance: payAccount.balance });
            }
        }
        
        // FaturayÄ± KALICI SIL
        const invoiceRef = db.collection('companies').doc(activeCompanyId)
            .collection('invoices').doc(id);
        batch.delete(invoiceRef);
        
        await batch.commit();
        
        // Local array'lerden kaldÄ±r
        payments = payments.filter(p => p.invoiceId !== id);
    } else {
        // Ã–deme yoksa direkt sil
        
        // Cari bakiyesini dÃ¼zelt
        const account = accounts.find(a => a.id === invoice.accountId);
        if (account) {
            const remainingAmount = invoice.total - (invoice.paidAmount || 0);
            
            if (invoice.type === 'sales') {
                account.balance -= remainingAmount;
            } else {
                account.balance += remainingAmount;
            }
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('accounts').doc(account.id).update({
                    balance: account.balance
                });
        }
        
        // FaturayÄ± KALICI SIL
        await db.collection('companies').doc(activeCompanyId)
            .collection('invoices').doc(id).delete();
    }
    
    // Local array'den kaldÄ±r
    invoices = invoices.filter(inv => inv.id !== id);
    
    // UI'Ä± gÃ¼ncelle
    await loadInvoices();
    await loadAccounts();
    await loadPayments();
    updateDashboard();
    
    alert('âœ… Fatura ve ilgili tÃ¼m veriler KALICI olarak silindi!');
}

        function filterInvoices() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const type = document.getElementById('filterType').value;
            const status = document.getElementById('filterPaymentStatus').value;

            const tbody = document.querySelector('#invoicesTable tbody');
            tbody.innerHTML = '';

            let filtered = invoices.filter(inv => !activeCompanyId || inv.companyId === activeCompanyId);

            if (startDate) filtered = filtered.filter(inv => inv.date >= startDate);
            if (endDate) filtered = filtered.filter(inv => inv.date <= endDate);
            if (type) filtered = filtered.filter(inv => inv.type === type);
            if (status) {
                filtered = filtered.filter(inv => {
                    const remaining = inv.total - (inv.paidAmount || 0);
                    if (status === 'paid') return remaining <= 0;
                    if (status === 'partial') return inv.paidAmount > 0 && remaining > 0;
                    if (status === 'unpaid') return inv.paidAmount === 0;
                    return true;
                });
            }

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px;">SonuÃ§ bulunamadÄ±.</td></tr>';
                return;
            }

            // Render filtered invoices (same as loadInvoices)
            filtered.forEach(invoice => {
                const account = accounts.find(a => a.id === invoice.accountId);
                const typeText = invoice.type === 'sales' ? 'ğŸ“— SatÄ±ÅŸ' : 'ğŸ“• AlÄ±ÅŸ';
                const remaining = invoice.total - (invoice.paidAmount || 0);
                
                let statusText = 'Ã–denmedi';
                let statusClass = 'status-unpaid';
                if (invoice.paidAmount >= invoice.total) {
                    statusText = 'Ã–dendi';
                    statusClass = 'status-paid';
                } else if (invoice.paidAmount > 0) {
                    statusText = 'KÄ±smi';
                    statusClass = 'status-partial';
                }
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(invoice.date)}</td>
                    <td><strong>${invoice.invoiceNo}</strong></td>
                    <td>${typeText}</td>
                    <td>${account ? account.name : 'SilinmiÅŸ'}</td>
                    <td><strong>${formatCurrency(invoice.total)}</strong></td>
                    <td>${formatCurrency(invoice.paidAmount || 0)}</td>
                    <td style="color: ${remaining > 0 ? 'var(--danger)' : 'var(--success)'};">${formatCurrency(remaining)}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewInvoice('${invoice.id}')">ğŸ‘ï¸</button>
                        <button class="btn btn-warning btn-sm" onclick="editInvoice('${invoice.id}')">âœï¸</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice.id}')">ğŸ—‘ï¸</button>
                    </td>
                `;
            });
        }

        function clearInvoiceFilters() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterPaymentStatus').value = '';
            loadInvoices();
        }

        // PAYMENT FUNCTIONS
        function openPaymentModal() {
            if (!activeCompanyId) {
                alert('âš ï¸ LÃ¼tfen Ã¶nce bir firma seÃ§in!');
                return;
            }
            document.getElementById('paymentModal').classList.add('active');
            document.getElementById('paymentDate').valueAsDate = new Date();
            populatePaymentAccounts();
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentId').value = '';
        }

        function populatePaymentAccounts() {
            const select = document.getElementById('paymentAccount');
            select.innerHTML = '<option value="">SeÃ§iniz</option>';
            
            const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
            companyAccounts.forEach(account => {
                const option = new Option(`${account.name} (${account.type === 'customer' ? 'MÃ¼ÅŸteri' : 'TedarikÃ§i'})`, account.id);
                select.add(option);
            });
        }

        function loadAccountInvoices() {
            const accountId = document.getElementById('paymentAccount').value;
            const select = document.getElementById('paymentInvoice');
            select.innerHTML = '<option value="">Genel Ã–deme (Fatura Yok)</option>';

            if (!accountId) return;

            const accountInvoices = invoices.filter(inv => 
                inv.accountId === accountId && 
                (inv.total - (inv.paidAmount || 0)) > 0
            );

            accountInvoices.forEach(invoice => {
                const remaining = invoice.total - (invoice.paidAmount || 0);
                const option = new Option(
                    `${invoice.invoiceNo} - ${formatCurrency(remaining)} kalan`,
                    invoice.id
                );
                select.add(option);
            });
        }

async function savePayment(e) {
    e.preventDefault();

    if (!activeCompanyId) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce bir firma seÃ§in!');
        return;
    }

    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }

    try {
        const paymentRef = db.collection('companies').doc(activeCompanyId)
            .collection('payments').doc();
        const paymentId = paymentRef.id;

        const payment = {
            id: paymentId,
            companyId: activeCompanyId,
            date: document.getElementById('paymentDate').value,
            accountId: document.getElementById('paymentAccount').value,
            amount: parseFloat(document.getElementById('paymentAmount').value),
            type: document.getElementById('paymentType').value,
            invoiceId: document.getElementById('paymentInvoice').value || null,
            description: document.getElementById('paymentDescription').value,
            source: 'manual',
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser.uid
        };

        await paymentRef.set(payment);
        payments.push(payment);

        // Update invoice if linked
        if (payment.invoiceId) {
            const invoice = invoices.find(inv => inv.id === payment.invoiceId);
            if (invoice) {
                invoice.paidAmount = (invoice.paidAmount || 0) + payment.amount;
                
                // Update status
                if (invoice.paidAmount >= invoice.total) {
                    invoice.status = 'paid';
                } else if (invoice.paidAmount > 0) {
                    invoice.status = 'partial';
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('invoices').doc(invoice.id).update({
                        paidAmount: invoice.paidAmount,
                        status: invoice.status
                    });
            }
        }

        // Update account balance
        const account = accounts.find(a => a.id === payment.accountId);
        if (account) {
            if (account.type === 'customer') {
                if (payment.type === 'income') {
                    account.balance -= payment.amount;
                } else {
                    account.balance += payment.amount;
                }
            } else {
                if (payment.type === 'expense') {
                    account.balance += payment.amount;
                } else {
                    account.balance -= payment.amount;
                }
            }
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('accounts').doc(account.id).update({
                    balance: account.balance
                });
        }

        closePaymentModal();
        await loadPayments();
        await loadInvoices();
        await loadAccounts();
        updateDashboard();

        alert('âœ… Ã–deme baÅŸarÄ±yla kaydedildi!');
        
    } catch (error) {
        console.error('Ã–deme kayÄ±t hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

async function loadPayments() {
    if (!activeCompanyId || !auth.currentUser) {
        payments = [];
        renderPaymentsTable();
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('payments').orderBy('date', 'desc').get();
        
        payments = [];
        snapshot.forEach(doc => {
            payments.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('âœ… Ã–demeler yÃ¼klendi:', payments.length);
        
    } catch (error) {
        console.error('âŒ Ã–deme yÃ¼kleme hatasÄ±:', error);
        payments = [];
    }
    
    renderPaymentsTable();
}

async function deletePayment(id) {
    if (!confirm('Bu Ã¶deme kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?')) return;

    const payment = payments.find(p => p.id === id);
    
    if (!payment || !auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    try {
        // Revert invoice payment
        if (payment.invoiceId) {
            const invoice = invoices.find(inv => inv.id === payment.invoiceId);
            if (invoice) {
                invoice.paidAmount = (invoice.paidAmount || 0) - payment.amount;
                if (invoice.paidAmount <= 0) {
                    invoice.status = 'unpaid';
                    invoice.paidAmount = 0;
                } else if (invoice.paidAmount < invoice.total) {
                    invoice.status = 'partial';
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('invoices').doc(invoice.id).update({
                        paidAmount: invoice.paidAmount,
                        status: invoice.status
                    });
            }
        }

        // Revert account balance
        const account = accounts.find(a => a.id === payment.accountId);
        if (account) {
            if (account.type === 'customer') {
                if (payment.type === 'income') {
                    account.balance += payment.amount;
                } else {
                    account.balance -= payment.amount;
                }
            } else {
                if (payment.type === 'expense') {
                    account.balance -= payment.amount;
                } else {
                    account.balance += payment.amount;
                }
            }
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('accounts').doc(account.id).update({
                    balance: account.balance
                });
        }
        
        await db.collection('companies').doc(activeCompanyId)
            .collection('payments').doc(id).delete();
        
        payments = payments.filter(p => p.id !== id);

        await loadPayments();
        await loadInvoices();
        await loadAccounts();
        updateDashboard();

        alert('âœ… Ã–deme kaydÄ± silindi!');
        
    } catch (error) {
        console.error('Ã–deme silme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

        function filterPayments() {
            const startDate = document.getElementById('paymentFilterStart').value;
            const endDate = document.getElementById('paymentFilterEnd').value;
            const accountId = document.getElementById('paymentFilterAccount').value;

            const tbody = document.querySelector('#paymentsTable tbody');
            tbody.innerHTML = '';

            let filtered = payments.filter(p => !activeCompanyId || p.companyId === activeCompanyId);

            if (startDate) filtered = filtered.filter(p => p.date >= startDate);
            if (endDate) filtered = filtered.filter(p => p.date <= endDate);
            if (accountId) filtered = filtered.filter(p => p.accountId === accountId);

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">SonuÃ§ bulunamadÄ±.</td></tr>';
                return;
            }

            filtered.forEach(payment => {
                const account = accounts.find(a => a.id === payment.accountId);
                const invoice = payment.invoiceId ? invoices.find(inv => inv.id === payment.invoiceId) : null;
                const typeText = payment.type === 'income' ? 'ğŸ“— Tahsilat' : 'ğŸ“• Ã–deme';
                const sourceText = payment.source === 'manual' ? 'Manuel' : 'Banka';

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(payment.date)}</td>
                    <td>${account ? account.name : 'SilinmiÅŸ'}</td>
                    <td style="color: ${payment.type === 'income' ? 'var(--success)' : 'var(--danger)'};">
                        ${payment.type === 'income' ? '+' : '-'}${formatCurrency(payment.amount)}
                    </td>
                    <td>${typeText}</td>
                    <td>${invoice ? invoice.invoiceNo : '-'}</td>
                    <td>${payment.description || '-'}</td>
                    <td><span class="badge badge-${payment.source === 'manual' ? 'info' : 'success'}">${sourceText}</span></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deletePayment('${payment.id}')">ğŸ—‘ï¸</button>
                    </td>
                `;
            });
        }

        function clearPaymentFilters() {
            document.getElementById('paymentFilterStart').value = '';
            document.getElementById('paymentFilterEnd').value = '';
            document.getElementById('paymentFilterAccount').value = '';
            loadPayments();
        }

        // BANK IMPORT FUNCTIONS
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function importBankStatement(event) {
            const file = event.target.files[0];
            if (!file) return;
            processFile(file);
        }

async function processFile(file) {
    try {
        await saveImportedFileToStorage(file, "payments");
    } catch (err) {
        console.error("Banka/Ã–deme dosya kaydedilemedi:", err);
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const transactions = parseCSV(e.target.result);
            showTransactionDetailsModal(transactions); // EKLE!
        } catch (err) {
            console.error("Banka dosya parse hatasÄ±:", err);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

function parseCSV(content) {
    console.log('ğŸ“‚ CSV Parse iÅŸlemi baÅŸlatÄ±lÄ±yor...');
    console.log('CSV Content baÅŸlangÄ±Ã§:', content.substring(0, 500));

    let lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);
    console.log('Toplam satÄ±r sayÄ±sÄ±:', lines.length);

    if (lines.length === 0) {
        console.error('âš ï¸ CSV dosyasÄ± boÅŸ!');
        return [];
    }

    console.log('Header:', lines[0]);

    let parsedTransactions = [];

    // ========================================
    // Ä°ÅLEM SATIRLARINI PARSE ET
    // ========================================
    console.log("\nğŸ“ Ä°ÅŸlem satÄ±rlarÄ±nÄ± parse ediyorum...");

    for (let i = 1; i < lines.length; i++) {
        console.log(`\nSatÄ±r ${i}: ${lines[i]}`);
        
        let parts = lines[i].split(';');
        console.log('NoktalÄ± virgÃ¼l ile ayrÄ±ldÄ±, parÃ§a sayÄ±sÄ±:', parts.length);
        console.log('ParÃ§alar:', parts);

        // EÄŸer satÄ±r yeterli sÃ¼tuna sahip deÄŸilse atla
        if (parts.length < 9) {
            console.log('âš ï¸ Bu satÄ±rda yeterli sÃ¼tun yok, atlanÄ±yor');
            continue;
        }

        // --- VERÄ° Ã‡IKARMA (Ä°lk YaklaÅŸÄ±m) ---
        let tarih = parts[0]?.trim() || '';
        let valor = parts[1]?.trim() || '';
        let kanal = parts[2]?.trim() || '';
        let tutarStr = parts[3]?.trim() || '';
        let bakiyeStr = parts[4]?.trim() || '';
        let islemTipi = parts[7]?.trim() || '';
        let aciklama = parts[8]?.trim() || ''; // SÃ¼tun 8'deki aÃ§Ä±klama

        console.log('Ã‡Ä±karÄ±lan veriler:');
        console.log('  Tarih:', tarih);
        console.log('  Tutar:', tutarStr);
        console.log('  Bakiye:', bakiyeStr);
        console.log('  AÃ§Ä±klama (SÃ¼tun 8):', aciklama);
        console.log('  Kanal:', kanal);
        console.log('  Ä°ÅŸlem Tipi:', islemTipi);

        // --- Ä°KÄ°NCÄ° YAKLAÅIM: FarklÄ± Format KontrolÃ¼ ---
        if (!tutarStr && parts.length >= 15) {
            tarih = parts[1]?.trim() || '';
            tutarStr = parts[3]?.trim() || '';
            bakiyeStr = parts[4]?.trim() || '';
            
            // Ã–nce sÃ¼tun 8'i kontrol et, yoksa sÃ¼tun 14'Ã¼ kullan
            let sutun8 = parts[8]?.trim() || '';
            let sutun14 = parts[14]?.trim() || '';
            
            // EÄŸer sÃ¼tun 8 boÅŸ veya sadece referans numarasÄ± gibi gÃ¶rÃ¼nÃ¼yorsa
            if (!sutun8 || sutun8.match(/^\d{29,}$/)) {
                aciklama = sutun14 || sutun8 || 'AÃ§Ä±klama yok';
            } else {
                aciklama = sutun8;
            }
            
            console.log('Ã‡Ä±karÄ±lan veriler (2. yaklaÅŸÄ±m):');
            console.log('  Tarih:', tarih);
            console.log('  Tutar:', tutarStr);
            console.log('  Bakiye:', bakiyeStr);
            console.log('  AÃ§Ä±klama:', aciklama);
        }

        // --- TUTAR PARSE ---
        let tutar = parseTurkishNumber(tutarStr);

        if (tutar === 0 || isNaN(tutar)) {
            console.log('Tutar 0 veya geÃ§ersiz, atlandÄ±');
            continue;
        }

        // --- TARÄ°H STANDARDIZASYONU ---
        let dateMatch = tarih.match(/(\d{2})\/(\d{2})\/(\d{4})/);
        let standardDate = '';
        if (dateMatch) {
            let [, day, month, year] = dateMatch;
            standardDate = `${year}-${month}-${day}`;
        } else {
            console.log('âš ï¸ Tarih formatÄ± tanÄ±nmadÄ±, atlandÄ±');
            continue;
        }

        // --- BAKÄ°YE PARSE ---
        let bakiye = parseTurkishNumber(bakiyeStr);

        // --- AÃ‡IKLAMA Ä°YÄ°LEÅTÄ°RME ---
        // EÄŸer aÃ§Ä±klama hala boÅŸ veya sadece referans numarasÄ± ise
        if (!aciklama || aciklama.match(/^\d{29,}$/)) {
            // Ã–nce sÃ¼tun 8'i tekrar kontrol et
            if (parts[8]?.trim() && !parts[8].trim().match(/^\d{29,}$/)) {
                aciklama = parts[8].trim();
            } 
            // Sonra kanal ve iÅŸlem tipini birleÅŸtir
            else if (kanal || islemTipi) {
                aciklama = [kanal, islemTipi].filter(x => x).join(' - ') || 'AÃ§Ä±klama yok';
            } 
            // Son Ã§are: "AÃ§Ä±klama yok"
            else {
                aciklama = 'AÃ§Ä±klama yok';
            }
        }

        // Uzun aÃ§Ä±klamalarÄ± kÄ±salt (150 karakterden uzunsa)
        if (aciklama.length > 150) {
            aciklama = aciklama.substring(0, 147) + '...';
        }

        // --- TRANSACTION KAYDET ---
        parsedTransactions.push({
            date: standardDate,
            description: aciklama,
            amount: tutar,
            balance: bakiye,
            channel: kanal || 'Bilinmiyor',
            type: islemTipi || 'Bilinmiyor'
        });

        console.log('âœ… Transaction eklendi:', parsedTransactions[parsedTransactions.length - 1]);
    }

    console.log('\nğŸ“Š Toplam iÅŸlem sayÄ±sÄ±:', parsedTransactions.length);
    return parsedTransactions;
}

function parseAmount(amountStr) {
    try {
        // TÃ¼m boÅŸluklarÄ± temizle
        let cleaned = amountStr.replace(/\s/g, '');
        
        // TÃ¼rkÃ§e format: 73.000,50 veya -73.000,50
        // Binlik ayracÄ± (.) kaldÄ±r, ondalÄ±k ayracÄ± (,) noktaya Ã§evir
        cleaned = cleaned.replace(/\./g, '');  // 73000,50
        cleaned = cleaned.replace(',', '.');   // 73000.50
        
        const result = parseFloat(cleaned) || 0;
        
        // Debug iÃ§in
        console.log(`Parse: "${amountStr}" â†’ ${result}`);
        
        return result;
    } catch (e) {
        console.error('Amount parse error:', amountStr, e);
        return 0;
    }
}

function parseDate(dateStr) {
    // Format: 11/09/2025-10:32:37 veya 11.09.2025
    try {
        const datePart = dateStr.split(/[-\s]/)[0]; // Saat kÄ±smÄ±nÄ± at
        const parts = datePart.split(/[\/\.]/);
        
        if (parts.length === 3) {
            const day = parts[0].padStart(2, '0');
            const month = parts[1].padStart(2, '0');
            const year = parts[2];
            return `${year}-${month}-${day}`;
        }
    } catch (e) {
        console.error('Date parse error:', dateStr, e);
    }
    return null;
}

function extractFromTo(description, amount) {
    // AÃ§Ä±klama temizleme
    let cleanDesc = description.trim();
    
    console.log(`ğŸ” EÅŸleÅŸtirme: "${cleanDesc.substring(0, 80)}" | Tutar: ${amount}`);
    
    // BSMV, komisyon gibi banka Ã¼cretleri
    if (cleanDesc.match(/BSMV|KOMÄ°SYON|MASRAF|ÃœCRET.*H\d+/i)) {
        return 'ğŸ’³ Banka Ãœcreti';
    }
    
    // Format 1: "Ä°SÄ°M*TR...*AÃ§Ä±klama" (En yaygÄ±n)
    // Ã–rnek: "AYÅENUR ATEÅ DEMÄ°RKAN*TR270006400000115220278205*NORA Ã‡EVRE..."
    const nameIbanMatch = cleanDesc.match(/^([^*]+)\*TR\d+/i);
    if (nameIbanMatch) {
        const name = nameIbanMatch[1].trim();
        console.log(`âœ… Format 1 bulundu: "${name}"`);
        return name;
    }
    
    // Format 2: "Ä°SÄ°M*AÃ§Ä±klama" (IBAN yok)
    // Ã–rnek: "ZET AÅ*ZET LOJÄ°STÄ°K HAZIR BETON SANAYÄ°..."
    const nameStarMatch = cleanDesc.match(/^([A-ZÃ‡ÄÄ°Ã–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼\s\.]+)\*/);
    if (nameStarMatch) {
        const name = nameStarMatch[1].trim();
        // "ÃœCRET" gibi anahtar kelimeler deÄŸilse
        if (!name.match(/ÃœCRET|BSMV|KOMÄ°SYON/i)) {
            console.log(`âœ… Format 2 bulundu: "${name}"`);
            return name;
        }
    }
    
    // Format 3: "...tarafÄ±ndan aktarÄ±lan*Ä°SÄ°M*..."
    // Ã–rnek: "AYÅENUR ATEÅ DEMÄ°RKAN tarafÄ±ndan aktarÄ±lan*AYÅENUR ATEÅ DEMÄ°RKAN*H2509..."
    const transferByMatch = cleanDesc.match(/([^*]+)\s+tarafÄ±ndan\s+aktarÄ±lan/i);
    if (transferByMatch) {
        const name = transferByMatch[1].trim();
        console.log(`âœ… Format 3 bulundu: "${name}"`);
        return name;
    }
    
    // Format 4: "//FATURA_NO//TARÄ°H//*FÄ°RMA_ADI*..."
    // Ã–rnek: "//NRC2025000000285//20250721/F110//*CAMÄ°Å MADENCÄ°LÄ°K ANONÄ°M ÅÄ°RKETÄ°*..."
    const invoiceMatch = cleanDesc.match(/\/\/.*?\/\/\*([^*]+)\*/);
    if (invoiceMatch) {
        const name = invoiceMatch[1].trim();
        console.log(`âœ… Format 4 (Fatura) bulundu: "${name}"`);
        return name;
    }
    
    // Format 5: "cari hesap ist*FÄ°RMA_ADI*..."
    // Ã–rnek: "cari hesap ist*SENSER TEKSTÄ°L HALI Ä°MALAT SANAYÄ°..."
    const cariMatch = cleanDesc.match(/cari hesap ist\*([^*]+)/i);
    if (cariMatch) {
        const name = cariMatch[1].trim();
        console.log(`âœ… Format 5 (Cari) bulundu: "${name}"`);
        return name;
    }
    
    // Format 6: "FÄ°RMA_ADI*0046*AÃ§Ä±klama*..."
    // Ã–rnek: "HAYRULLAH ALTINTAÅ*0046*DanÄ±ÅŸmanlÄ±k hizmeti Ã¶demesi*..."
    const codeMatch = cleanDesc.match(/^([^*]+)\*\d{4}\*/);
    if (codeMatch) {
        const name = codeMatch[1].trim();
        console.log(`âœ… Format 6 (Kod) bulundu: "${name}"`);
        return name;
    }
    
    // Format 7: "FÄ°RMA_ADI*0062*NORA Ã‡EVRE..." (NRC numaralÄ±)
    const nrcMatch = cleanDesc.match(/^([^*]+)\*006\d\*/);
    if (nrcMatch) {
        const name = nrcMatch[1].trim();
        console.log(`âœ… Format 7 (NRC) bulundu: "${name}"`);
        return name;
    }
    
    // Format 8: Fatura Ã¶demesi
    // Ã–rnek: "100200334844 /TREPAÅ /FATURA NO:0000000910953291/K:02970"
    const billMatch = cleanDesc.match(/\/([A-ZÃ‡ÄÄ°Ã–ÅÃœ\s]+)\s*\//);
    if (billMatch) {
        const name = billMatch[1].trim();
        console.log(`âœ… Format 8 (Fatura) bulundu: "${name}"`);
        return name;
    }
    
    // HiÃ§bir format eÅŸleÅŸmedi - ilk 50 karakter
    console.log(`âš ï¸ EÅŸleÅŸme bulunamadÄ±, ham aÃ§Ä±klama kullanÄ±lÄ±yor`);
    return cleanDesc.substring(0, 50);
}

function categorizeTransaction(description, transactionType) {
    const desc = description.toUpperCase();
    const type = (transactionType || '').toUpperCase();
    
    // Banka Ã¼cretleri
    if (desc.includes('BSMV') || desc.match(/H\d{13}/)) return 'ğŸ’³ BSMV';
    if (desc.includes('ÃœCRET') && desc.match(/H\d{13}/)) return 'ğŸ’³ Banka Ãœcreti';
    if (desc.includes('KOMÄ°SYON')) return 'ğŸ’³ Komisyon';
    if (desc.includes('MASRAF')) return 'ğŸ’³ Masraf';
    
    // Fatura Ã¶demeleri
    if (desc.includes('FATURA') || desc.includes('/TREPAÅ/')) return 'ğŸ§¾ Fatura';
    
    // Ä°ÅŸlem tipleri
    if (type.includes('HAVALE')) return 'ğŸ’¸ Havale';
    if (type.includes('EFT')) return 'ğŸ’¸ EFT';
    if (type.includes('FAST')) return 'âš¡ Fast';
    if (type.includes('POS') || desc.includes('KART')) return 'ğŸ’³ Kart';
    if (type.includes('Ã‡EK')) return 'ğŸ“ Ã‡ek';
    
    // MaaÅŸ Ã¶demeleri
    if (desc.includes('MAAÅ') || desc.includes('MAA')) return 'ğŸ‘” MaaÅŸ';
    
    // Kira
    if (desc.includes('KÄ°RA')) return 'ğŸ  Kira';
    
    return 'ğŸ“‹ DiÄŸer';
}

        function matchTransactions(transactions) {
            const matches = [];

            transactions.forEach(transaction => {
                const match = {
                    transaction: transaction,
                    suggestedAccount: null,
                    suggestedInvoice: null,
                    confidence: 0
                };

                // Try to match with accounts based on description
                const description = transaction.description.toLowerCase();
                const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);

                for (let account of companyAccounts) {
                    const accountName = account.name.toLowerCase();
                    
                    // Simple matching - check if account name is in description
                    if (description.includes(accountName) || accountName.includes(description.split('*')[0])) {
                        match.suggestedAccount = account;
                        match.confidence = 80;
                        break;
                    }
                    
                    // Fuzzy match - check for partial matches
                    const words = accountName.split(' ');
                    for (let word of words) {
                        if (word.length > 3 && description.includes(word)) {
                            if (!match.suggestedAccount || match.confidence < 50) {
                                match.suggestedAccount = account;
                                match.confidence = 50;
                            }
                        }
                    }
                }

                // Try to match with invoices
                if (match.suggestedAccount) {
                    const accountInvoices = invoices.filter(inv => 
                        inv.accountId === match.suggestedAccount.id &&
                        Math.abs(inv.total - (inv.paidAmount || 0) - Math.abs(transaction.amount)) < 1
                    );

                    if (accountInvoices.length > 0) {
                        match.suggestedInvoice = accountInvoices[0];
                        match.confidence = 90;
                    }
                }

                matches.push(match);
            });

            showMatchingInterface(matches);
        }


function showMatchingInterface(matches) {
    const modal = document.getElementById('bankImportModal');
    const content = document.getElementById('bankImportContent');

    let html = `
        <div class="alert alert-info">
            <strong>âœ… ${matches.length} iÅŸlem bulundu.</strong> LÃ¼tfen eÅŸleÅŸtirmeleri kontrol edin.
        </div>
        <div id="matchList">
    `;

    matches.forEach((match, index) => {
        const t = match.transaction;
        const isMatched = match.suggestedAccount !== null;
        const confidenceText = match.confidence >= 80 ? 'YÃ¼ksek' : match.confidence >= 50 ? 'Orta' : 'DÃ¼ÅŸÃ¼k';
        const confidenceColor = match.confidence >= 80 ? 'success' : match.confidence >= 50 ? 'warning' : 'danger';
        
        const amountColor = t.amount > 0 ? 'var(--success)' : 'var(--danger)';
        const amountSign = t.amount > 0 ? '+' : '';

        html += `
            <div class="payment-match-item ${isMatched ? 'matched' : 'unmatched'}">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <strong style="font-size: 1.1em;">${formatDate(t.date)}</strong>
                            <span style="color: ${amountColor}; font-weight: 700; font-size: 1.3em;">
                                ${amountSign}${formatCurrency(Math.abs(t.amount))}
                            </span>
                            <span class="badge badge-info">${t.category}</span>
                        </div>
                        <div style="font-size: 0.95em; margin-bottom: 5px;">
                            <strong>${t.amount > 0 ? 'ğŸ“¥ GÃ¶nderen:' : 'ğŸ“¤ AlÄ±cÄ±:'}</strong> 
                            <span style="color: #1f2937; font-weight: 600;">${t.fromTo}</span>
                        </div>
                        <div style="font-size: 0.85em; color: #6b7280; font-style: italic;">
                            ${t.description.substring(0, 100)}${t.description.length > 100 ? '...' : ''}
                        </div>
                    </div>
                    ${isMatched ? `
                        <span class="badge badge-${confidenceColor}" style="margin-left: 10px;">
                            ${confidenceText} EÅŸleÅŸme
                        </span>
                    ` : ''}
                </div>
                
                <div class="grid-2" style="margin-top: 15px;">
                    <div class="form-group">
                        <label>Cari Hesap ${isMatched ? '(Ã–nerilen)' : ''}</label>
                        <select id="matchAccount_${index}" onchange="updateMatchInvoices(${index})" style="font-weight: ${isMatched ? '600' : 'normal'};">
                            <option value="">Manuel SeÃ§in</option>
                            ${accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId).map(a => 
                                `<option value="${a.id}" ${match.suggestedAccount && match.suggestedAccount.id === a.id ? 'selected' : ''}>${a.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Fatura (Opsiyonel)</label>
                        <select id="matchInvoice_${index}">
                            <option value="">Genel Ã–deme</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
    });

    html += `
        </div>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border); text-align: right;">
            <button class="btn btn-success" onclick="confirmBankImport()">
                âœ… ${matches.length} Ä°ÅŸlemi Kaydet
            </button>
            <button class="btn btn-secondary" onclick="closeBankImportModal()">âœ–ï¸ Ä°ptal</button>
        </div>
    `;

    content.innerHTML = html;
    modal.classList.add('active');

    // Populate invoice selects
    matches.forEach((match, index) => {
        if (match.suggestedAccount) {
            updateMatchInvoices(index, match.suggestedInvoice ? match.suggestedInvoice.id : null);
        }
    });

    window.bankMatches = matches;
}

        function updateMatchInvoices(index, selectedInvoiceId = null) {
            const accountSelect = document.getElementById(`matchAccount_${index}`);
            const invoiceSelect = document.getElementById(`matchInvoice_${index}`);
            
            const accountId = accountSelect.value;
            invoiceSelect.innerHTML = '<option value="">Genel Ã–deme</option>';

            if (!accountId) return;

            const accountInvoices = invoices.filter(inv => 
                inv.accountId === accountId && 
                (inv.total - (inv.paidAmount || 0)) > 0
            );

            accountInvoices.forEach(invoice => {
                const remaining = invoice.total - (invoice.paidAmount || 0);
                const option = new Option(
                    `${invoice.invoiceNo} - ${formatCurrency(remaining)} kalan`,
                    invoice.id
                );
                if (selectedInvoiceId && invoice.id === selectedInvoiceId) {
                    option.selected = true;
                }
                invoiceSelect.add(option);
            });
        }

        function confirmBankImport() {
            if (!window.bankMatches) return;

            let importedCount = 0;

            window.bankMatches.forEach((match, index) => {
                const accountId = document.getElementById(`matchAccount_${index}`).value;
                const invoiceId = document.getElementById(`matchInvoice_${index}`).value;

                if (!accountId) return; // Skip if no account selected

                const payment = {
                    id: Date.now().toString() + '_' + index,
                    companyId: activeCompanyId,
                    date: match.transaction.date,
                    accountId: accountId,
                    amount: Math.abs(match.transaction.amount),
                    type: match.transaction.amount > 0 ? 'income' : 'expense',
                    invoiceId: invoiceId || null,
                    description: match.transaction.description,
                    source: 'bank',
                    createdAt: new Date().toISOString()
                };

                payments.push(payment);

                // Update invoice
                if (invoiceId) {
                    const invoice = invoices.find(inv => inv.id === invoiceId);
                    if (invoice) {
                        invoice.paidAmount = (invoice.paidAmount || 0) + payment.amount;
                        if (invoice.paidAmount >= invoice.total) {
                            invoice.status = 'paid';
                        } else {
                            invoice.status = 'partial';
                        }
                    }
                }

                // Update account balance
                const account = accounts.find(a => a.id === accountId);
                if (account) {
                    if (payment.type === 'income') {
                        account.balance += payment.amount;
                    } else {
                        account.balance -= payment.amount;
                    }
                }

                importedCount++;
            });

            localStorage.setItem('payments', JSON.stringify(payments));
            localStorage.setItem('invoices', JSON.stringify(invoices));
            localStorage.setItem('accounts', JSON.stringify(accounts));

            closeBankImportModal();
            loadPayments();
            loadInvoices();
            loadAccounts();
            updateDashboard();

            alert(`âœ… ${importedCount} Ã¶deme baÅŸarÄ±yla kaydedildi!`);
        }

        function closeBankImportModal() {
            document.getElementById('bankImportModal').classList.remove('active');
            window.bankMatches = null;
        }

// updateDashboard() fonksiyonuna ekle (SatÄ±r ~1440 civarÄ±)

function updateDashboard() {
    const companyInvoices = invoices.filter(inv => !activeCompanyId || inv.companyId === activeCompanyId);
    const companyPayments = payments.filter(p => !activeCompanyId || p.companyId === activeCompanyId);
    const companyPurchases = purchases.filter(p => !activeCompanyId || p.companyId === activeCompanyId); // YENÄ°

    const salesInvoices = companyInvoices.filter(inv => inv.type === 'sales');
    const purchaseInvoices = companyInvoices.filter(inv => inv.type === 'purchase');

    const totalIncome = salesInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
    const totalExpense = purchaseInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
    
    // YENÄ°: AlÄ±ÅŸlarÄ± da giderlere ekle
    const purchasesExpense = companyPurchases.reduce((sum, p) => sum + p.amount, 0);
    const totalExpenseWithPurchases = totalExpense + purchasesExpense;
    
    const netProfit = totalIncome - totalExpenseWithPurchases;

    const salesVAT = salesInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
    const purchaseVAT = purchaseInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
    
    // YENÄ°: AlÄ±ÅŸlarÄ±n KDV'sini de mahsuba ekle
    const purchasesVAT = companyPurchases.reduce((sum, p) => sum + p.vatAmount, 0);
    const totalVAT = salesVAT - (purchaseVAT + purchasesVAT);

    const corporateTax = netProfit > 0 ? netProfit * 0.20 : 0;

    const totalPaymentsAmount = companyPayments.reduce((sum, p) => sum + (p.type === 'income' ? p.amount : -p.amount), 0);
    
    const receivables = salesInvoices.reduce((sum, inv) => sum + (inv.total - (inv.paidAmount || 0)), 0);

    document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
    document.getElementById('totalExpense').textContent = formatCurrency(totalExpenseWithPurchases);
    document.getElementById('netProfit').textContent = formatCurrency(netProfit);
    document.getElementById('totalVAT').textContent = formatCurrency(totalVAT);
    document.getElementById('corporateTax').textContent = formatCurrency(corporateTax);
    document.getElementById('totalPayments').textContent = formatCurrency(totalPaymentsAmount);
    document.getElementById('receivables').textContent = formatCurrency(receivables);
}

        function updateRecentInvoices() {
            const tbody = document.querySelector('#recentInvoices tbody');
            tbody.innerHTML = '';

            const recentInvoices = invoices
                .filter(inv => !activeCompanyId || inv.companyId === activeCompanyId)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            if (recentInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:10px; color:#6b7280;">HenÃ¼z fatura yok</td></tr>';
                return;
            }

            recentInvoices.forEach(invoice => {
                const account = accounts.find(a => a.id === invoice.accountId);
                const remaining = invoice.total - (invoice.paidAmount || 0);
                let statusText = remaining <= 0 ? 'Ã–dendi' : invoice.paidAmount > 0 ? 'KÄ±smi' : 'Ã–denmedi';
                let statusClass = remaining <= 0 ? 'status-paid' : invoice.paidAmount > 0 ? 'status-partial' : 'status-unpaid';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(invoice.date)}</td>
                    <td>${invoice.invoiceNo}</td>
                    <td>${account ? account.name : 'SilinmiÅŸ'}</td>
                    <td>${formatCurrency(invoice.total)}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                `;
            });
        }

        function updateRecentPayments() {
            const tbody = document.querySelector('#recentPayments tbody');
            tbody.innerHTML = '';

            const recentPayments = payments
                .filter(p => !activeCompanyId || p.companyId === activeCompanyId)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            if (recentPayments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:10px; color:#6b7280;">HenÃ¼z Ã¶deme yok</td></tr>';
                return;
            }

            recentPayments.forEach(payment => {
                const account = accounts.find(a => a.id === payment.accountId);
                const typeText = payment.type === 'income' ? 'ğŸ“— Tahsilat' : 'ğŸ“• Ã–deme';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(payment.date)}</td>
                    <td>${account ? account.name : 'SilinmiÅŸ'}</td>
                    <td style="color: ${payment.type === 'income' ? 'var(--success)' : 'var(--danger)'};">
                        ${payment.type === 'income' ? '+' : '-'}${formatCurrency(payment.amount)}
                    </td>
                    <td>${typeText}</td>
                `;
            });
        }

        // REPORTS FUNCTIONS
        function generateReport() {
            const year = document.getElementById('reportYear').value;
            const month = document.getElementById('reportMonth').value;

            const companyInvoices = invoices.filter(inv => {
                if (activeCompanyId && inv.companyId !== activeCompanyId) return false;
                
                const invDate = new Date(inv.date);
                const invYear = invDate.getFullYear().toString();
                const invMonth = (invDate.getMonth() + 1).toString().padStart(2, '0');

                if (invYear !== year) return false;
                if (month && invMonth !== month) return false;

                return true;
            });

            const salesInvoices = companyInvoices.filter(inv => inv.type === 'sales');
            const purchaseInvoices = companyInvoices.filter(inv => inv.type === 'purchase');

            const totalIncome = salesInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
            const totalExpense = purchaseInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
            const netProfit = totalIncome - totalExpense;

            const salesVAT = salesInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
            const purchaseVAT = purchaseInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
            const totalVAT = salesVAT - purchaseVAT;

            const corporateTax = netProfit > 0 ? netProfit * 0.20 : 0;

            const periodText = month ? `${getMonthName(month)} ${year}` : `${year} YÄ±lÄ±`;

            const html = `
                <div class="card">
                    <h3>ğŸ“Š ${periodText} DÃ¶nemi Raporu</h3>
                    
                    <div class="grid-3">
                        <div class="stat-card success">
                            <h4>SatÄ±ÅŸ Geliri</h4>
                            <div class="amount">${formatCurrency(totalIncome)}</div>
                            <small>${salesInvoices.length} Fatura</small>
                        </div>
                        <div class="stat-card danger">
                            <h4>AlÄ±ÅŸ Gideri</h4>
                            <div class="amount">${formatCurrency(totalExpense)}</div>
                            <small>${purchaseInvoices.length} Fatura</small>
                        </div>
                        <div class="stat-card">
                            <h4>Net Kar/Zarar</h4>
                            <div class="amount">${formatCurrency(netProfit)}</div>
                        </div>
                    </div>

                    <div class="grid-2" style="margin-top:20px;">
                        <div class="stat-card warning">
                            <h4>Ã–denecek KDV</h4>
                            <div class="amount">${formatCurrency(totalVAT)}</div>
                            <small>SatÄ±ÅŸ KDV - AlÄ±ÅŸ KDV</small>
                        </div>
                        <div class="stat-card purple">
                            <h4>Tahmini Kurumlar Vergisi</h4>
                            <div class="amount">${formatCurrency(corporateTax)}</div>
                            <small>Net Kar x %20</small>
                        </div>
                    </div>

                    <div style="margin-top:30px;">
                        <h4>ğŸ“‹ DetaylÄ± Fatura Listesi</h4>
                        ${companyInvoices.length === 0 ? '<p style="text-align:center; padding:20px; color:#6b7280;">Bu dÃ¶nemde fatura yok.</p>' : `
                        <table>
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>No</th>
                                    <th>TÃ¼r</th>
                                    <th>Cari</th>
                                    <th>Ara Toplam</th>
                                    <th>KDV</th>
                                    <th>Toplam</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${companyInvoices.map(inv => {
                                    const account = accounts.find(a => a.id === inv.accountId);
                                    const typeText = inv.type === 'sales' ? 'ğŸ“— SatÄ±ÅŸ' : 'ğŸ“• AlÄ±ÅŸ';
                                    const remaining = inv.total - (inv.paidAmount || 0);
                                    let statusText = remaining <= 0 ? 'Ã–dendi' : inv.paidAmount > 0 ? 'KÄ±smi' : 'Ã–denmedi';
                                    return `
                                        <tr>
                                            <td>${formatDate(inv.date)}</td>
                                            <td>${inv.invoiceNo}</td>
                                            <td>${typeText}</td>
                                            <td>${account ? account.name : 'SilinmiÅŸ'}</td>
                                            <td>${formatCurrency(inv.subtotal)}</td>
                                            <td>${formatCurrency(inv.vatAmount)}</td>
                                            <td><strong>${formatCurrency(inv.total)}</strong></td>
                                            <td>${statusText}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        `}
                    </div>
                </div>
            `;

            document.getElementById('reportResults').innerHTML = html;
        }

        function generateStatement() {
            const accountId = document.getElementById('statementAccount').value;
            const startDate = document.getElementById('statementStartDate').value;
            const endDate = document.getElementById('statementEndDate').value;

            if (!accountId) {
                alert('âš ï¸ LÃ¼tfen bir cari hesap seÃ§in!');
                return;
            }

            const account = accounts.find(a => a.id === accountId);
            if (!account) return;

            let accountTransactions = [];

            // Add invoices
            invoices.filter(inv => inv.accountId === accountId).forEach(inv => {
                if (startDate && inv.date < startDate) return;
                if (endDate && inv.date > endDate) return;
                
                accountTransactions.push({
                    date: inv.date,
                    type: 'invoice',
                    description: `Fatura: ${inv.invoiceNo}`,
                    debit: inv.type === 'sales' ? inv.total : 0,
                    credit: inv.type === 'purchase' ? inv.total : 0,
                    reference: inv.invoiceNo
                });
            });

            // Add payments
            payments.filter(p => p.accountId === accountId).forEach(p => {
                if (startDate && p.date < startDate) return;
                if (endDate && p.date > endDate) return;
                
                accountTransactions.push({
                    date: p.date,
                    type: 'payment',
                    description: p.description || 'Ã–deme',
                    debit: p.type === 'expense' ? p.amount : 0,
                    credit: p.type === 'income' ? p.amount : 0,
                    reference: p.invoiceId ? invoices.find(inv => inv.id === p.invoiceId)?.invoiceNo : '-'
                });
            });

            accountTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));

            let balance = 0;
            const rows = accountTransactions.map(t => {
                balance += (t.debit - t.credit);
                return `
                    <tr>
                        <td>${formatDate(t.date)}</td>
                        <td>${t.reference}</td>
                        <td>${t.description}</td>
                        <td style="color: var(--danger); font-weight:600;">${t.debit > 0 ? formatCurrency(t.debit) : '-'}</td>
                        <td style="color: var(--success); font-weight:600;">${t.credit > 0 ? formatCurrency(t.credit) : '-'}</td>
                        <td style="font-weight:700;">${formatCurrency(balance)}</td>
                    </tr>
                `;
            }).join('');

            const html = `
                <div style="margin-top:20px;">
                    <h4>ğŸ“‹ ${account.name} - Cari Ekstre</h4>
                    <p><strong>DÃ¶nem:</strong> ${startDate ? formatDate(startDate) : 'BaÅŸlangÄ±Ã§'} - ${endDate ? formatDate(endDate) : 'BugÃ¼n'}</p>
                    <p><strong>GÃ¼ncel Bakiye:</strong> <span style="color: ${balance >= 0 ? 'var(--success)' : 'var(--danger)'}; font-size:1.8em; font-weight:700;">${formatCurrency(balance)}</span></p>
                    
                    ${accountTransactions.length === 0 ? '<p style="text-align:center; padding:20px; color:#6b7280;">Bu dÃ¶nemde iÅŸlem yok.</p>' : `
                    <table>
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Referans</th>
                                <th>AÃ§Ä±klama</th>
                                <th>BorÃ§</th>
                                <th>Alacak</th>
                                <th>Bakiye</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                    `}
                </div>
            `;

            document.getElementById('statementResults').innerHTML = html;
        }

        // DATA MANAGEMENT
        function exportData() {
            const data = {
                companies: companies,
                accounts: accounts,
                invoices: invoices,
                payments: payments,
                activeCompanyId: activeCompanyId,
                exportDate: new Date().toISOString(),
                version: '2.0.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `muhasebe-yedek-v2-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert('âœ… Veriler baÅŸarÄ±yla dÄ±ÅŸa aktarÄ±ldÄ±!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.companies || !data.accounts || !data.invoices) {
                        alert('âš ï¸ GeÃ§ersiz yedek dosyasÄ±!');
                        return;
                    }

                    if (confirm('âš ï¸ Mevcut tÃ¼m veriler silinecek ve yedekten geri yÃ¼klenecek. Devam etmek istiyor musunuz?')) {
                        companies = data.companies;
                        accounts = data.accounts;
                        invoices = data.invoices;
                        payments = data.payments || [];
                        activeCompanyId = data.activeCompanyId;

                        localStorage.setItem('companies', JSON.stringify(companies));
                        localStorage.setItem('accounts', JSON.stringify(accounts));
                        localStorage.setItem('invoices', JSON.stringify(invoices));
                        localStorage.setItem('payments', JSON.stringify(payments));
                        localStorage.setItem('activeCompanyId', activeCompanyId);

                        initializeApp();
                        
                        alert('âœ… Veriler baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±!');
                    }
                } catch (error) {
                    alert('âŒ Dosya okunamadÄ±! LÃ¼tfen geÃ§erli bir yedek dosyasÄ± seÃ§in.');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        function clearAllData() {
            if (!confirm('âš ï¸ TÃœM VERÄ°LER SÄ°LÄ°NECEK! Bu iÅŸlem geri alÄ±namaz. Devam etmek istiyor musunuz?')) {
                return;
            }

            if (!confirm('âš ï¸âš ï¸âš ï¸ SON UYARI! TÃ¼m firmalar, cari hesaplar, faturalar ve Ã¶demeler kalÄ±cÄ± olarak silinecek. EMÄ°N MÄ°SÄ°NÄ°Z?')) {
                return;
            }

            localStorage.clear();

            companies = [];
            accounts = [];
            invoices = [];
            payments = [];
            activeCompanyId = null;

            initializeApp();

            alert('âœ… TÃ¼m veriler silindi!');
        }

function populateSelects() {
     populateCompanySelects();
    populateAccountSelects();
    populatePaymentAccounts();

    // Teklif formu iÃ§in cari hesaplarÄ± doldur
    const proposalCariSelect = document.getElementById('proposalCariAccount');
    if (proposalCariSelect) {
        proposalCariSelect.innerHTML = '<option value="">Cari hesap seÃ§iniz...</option>';
        
        let accountsToShow = accounts;
        if (activeCompanyId) {
            accountsToShow = accounts.filter(a => a.companyId === activeCompanyId);
        }
        
        accountsToShow.forEach(account => {
            const option = document.createElement('option');
            option.value = account.id;
            option.textContent = `${account.name} ${account.taxNo ? '(' + account.taxNo + ')' : ''}`;
            proposalCariSelect.appendChild(option);
        });
    }
}

function populateAccountSelects() {
    // Invoice account select
    const invoiceAccountSelect = document.getElementById('invoiceAccount');
    if (invoiceAccountSelect) {
        const currentValue = invoiceAccountSelect.value;
        invoiceAccountSelect.innerHTML = '<option value="">Cari Hesap SeÃ§in</option>';
        
        accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId).forEach(account => {
            const option = new Option(
                `${account.name} (${account.type === 'customer' ? 'MÃ¼ÅŸteri' : 'TedarikÃ§i'})`,
                account.id
            );
            invoiceAccountSelect.add(option);
        });
        
        if (currentValue) {
            invoiceAccountSelect.value = currentValue;
        }
    }
}

function populatePaymentAccounts() {
    const select = document.getElementById('paymentAccount');
    if (!select) return;
    
    select.innerHTML = '<option value="">SeÃ§iniz</option>';
    
    const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
    companyAccounts.forEach(account => {
        const option = new Option(
            `${account.name} (${account.type === 'customer' ? 'MÃ¼ÅŸteri' : 'TedarikÃ§i'})`,
            account.id
        );
        select.add(option);
    });
}

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR');
        }

        function getMonthName(month) {
            const months = {
                '01': 'Ocak', '02': 'Åubat', '03': 'Mart', '04': 'Nisan',
                '05': 'MayÄ±s', '06': 'Haziran', '07': 'Temmuz', '08': 'AÄŸustos',
                '09': 'EylÃ¼l', '10': 'Ekim', '11': 'KasÄ±m', '12': 'AralÄ±k'
            };
            return months[month] || month;
        }

function showTransactionDetailsModal(transactions) {
    console.log('ğŸ”µ showTransactionDetailsModal Ã§aÄŸrÄ±ldÄ±');
    console.log('ğŸ“Š Gelen transaction sayÄ±sÄ±:', transactions.length);

    if (!transactions || transactions.length === 0) {
        console.error('âŒ Transactions boÅŸ veya undefined!');
        alert('GÃ¶sterilecek iÅŸlem bulunamadÄ±!');
        return;
    }

    const modal = document.getElementById('transactionDetailsModal');
    const container = document.getElementById('transactionDetailsContainer');

    if (!modal || !container) {
        console.error('âŒ Modal veya Container elementi bulunamadÄ±!');
        return;
    }

    console.log('âœ… Modal ve Container elementleri bulundu');

    // Store transactions globally
    pendingTransactions = transactions;

    // Container'Ä± temizle
    container.innerHTML = '';

    // âœ… EÅLEÅME Ä°STATÄ°STÄ°KLERÄ°
    let autoMatchedCount = 0;
    let manualMatchCount = 0;

    // âœ… HER TRANSACTION Ä°Ã‡Ä°N OTOMATÄ°K EÅLEÅTIRME YAP
    transactions.forEach((tx, index) => {
        // Otomatik cari hesap eÅŸleÅŸtirme
        const matchResult = findMatchingAccountForTransaction(tx);
        tx.suggestedAccount = matchResult.account;
        tx.matchConfidence = matchResult.confidence;
        tx.matchReason = matchResult.reason;

        if (matchResult.account) {
            autoMatchedCount++;
        } else {
            manualMatchCount++;
        }

        console.log(`ğŸ“ Transaction ${index + 1}:`, {
            amount: tx.amount,
            description: tx.description.substring(0, 50),
            matchedAccount: matchResult.account?.name || 'YOK',
            confidence: matchResult.confidence,
            reason: matchResult.reason
        });
    });

    // Ã–zet istatistik
    const totalCount = transactions.length;
    const matchPercentage = Math.round((autoMatchedCount / totalCount) * 100);

    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'alert alert-success';
    summaryDiv.style.cssText = 'margin-bottom: 20px;';
    summaryDiv.innerHTML = `
        <strong>âœ… ${totalCount} banka iÅŸlemi baÅŸarÄ±yla okundu!</strong><br>
        <div style="margin-top: 10px; display: flex; gap: 20px; font-size: 0.95em;">
            <span style="color: var(--success);">âœ… ${autoMatchedCount} otomatik eÅŸleÅŸti (%${matchPercentage})</span>
            ${manualMatchCount > 0 ? `<span style="color: var(--warning);">âš ï¸ ${manualMatchCount} manuel seÃ§im gerekli</span>` : ''}
        </div>
    `;
    container.appendChild(summaryDiv);

    // Her transaction iÃ§in kart oluÅŸtur
    transactions.forEach((tx, index) => {
        const card = document.createElement('div');
        card.className = 'transaction-detail-card';
        
        // âœ… EÅŸleÅŸme durumuna gÃ¶re renk
        const borderColor = tx.suggestedAccount ? '#10b981' : '#f59e0b';
        const bgGradient = tx.suggestedAccount 
            ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' 
            : 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';

        card.style.cssText = `
            background: ${bgGradient};
            border-left: 4px solid ${borderColor};
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        `;

        const amountColor = tx.amount >= 0 ? '#00b894' : '#d63031';
        const amountPrefix = tx.amount >= 0 ? '+' : '';
        const formattedAmount = `${amountPrefix}â‚º${Math.abs(tx.amount).toLocaleString('tr-TR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        })}`;

        // GÃ¼ven skoru badge
        const confidenceBadge = tx.suggestedAccount 
            ? `<span class="badge badge-${tx.matchConfidence >= 90 ? 'success' : tx.matchConfidence >= 70 ? 'warning' : 'danger'}" style="font-size: 0.9em;">
                ${tx.matchConfidence}% EÅŸleÅŸme
               </span>`
            : '<span class="badge badge-danger" style="font-size: 0.9em;">Manuel SeÃ§im Gerekli</span>';

        // Get current account list for dropdown
        const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
        const accountOptions = companyAccounts.map(acc => 
            `<option value="${acc.id}" ${tx.suggestedAccount && tx.suggestedAccount.id === acc.id ? 'selected' : ''}>
                ${acc.name} (${acc.type === 'customer' ? 'MÃ¼ÅŸteri' : 'TedarikÃ§i'})
            </option>`
        ).join('');

        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <div style="font-size: 18px; font-weight: bold; color: ${amountColor};">
                            ${formattedAmount}
                        </div>
                        ${confidenceBadge}
                    </div>
                    <div style="font-size: 14px; color: #2d3436; margin-bottom: 4px;">
                        ğŸ“… ${tx.date || 'Tarih yok'}
                    </div>
                    <div style="font-size: 13px; color: #636e72; margin-bottom: 8px;">
                        ğŸ’³ ${tx.channel || 'Kanal bilgisi yok'} | ${tx.type || 'Ä°ÅŸlem tipi yok'}
                    </div>
                    ${tx.suggestedAccount ? `
                        <div style="font-size: 0.9em; color: var(--success); margin-top: 8px; padding: 8px; background: rgba(16, 185, 129, 0.15); border-radius: 6px;">
                            âœ… <strong>Otomatik EÅŸleÅŸti:</strong> ${tx.suggestedAccount.name}<br>
                            <small style="opacity: 0.8;">Sebep: ${tx.matchReason}</small>
                        </div>
                    ` : `
                        <div style="font-size: 0.9em; color: var(--danger); margin-top: 8px; padding: 8px; background: rgba(239, 68, 68, 0.15); border-radius: 6px;">
                            âš ï¸ Cari hesap bulunamadÄ± - LÃ¼tfen manuel seÃ§in
                        </div>
                    `}
                </div>
                <div style="background: white; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #2d3436; font-weight: 500;">
                    Bakiye: â‚º${(tx.balance || 0).toLocaleString('tr-TR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    })}
                </div>
            </div>
            <div style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 6px; font-size: 13px; color: #2d3436; line-height: 1.5; margin-bottom: 12px;">
                ğŸ“ ${tx.description || 'AÃ§Ä±klama yok'}
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="display: block; font-size: 12px; color: #636e72; margin-bottom: 5px;">
                        Cari Hesap ${tx.suggestedAccount ? '(âœ… Otomatik)' : '(âš ï¸ Manuel)'}
                    </label>
                    <select class="cari-hesap-select" data-index="${index}" style="width: 100%; padding: 8px; border: 2px solid ${tx.suggestedAccount ? 'var(--success)' : 'var(--danger)'}; border-radius: 4px; background: white; font-weight: ${tx.suggestedAccount ? '600' : 'normal'};">
                        <option value="">Cari Hesap SeÃ§in</option>
                        ${accountOptions}
                    </select>
                </div>
                <div>
                    <label style="display: block; font-size: 12px; color: #636e72; margin-bottom: 5px;">
                        Kategori (Opsiyonel)
                    </label>
                    <select class="fatura-select" data-index="${index}" style="width: 100%; padding: 8px; border: 1px solid #dfe6e9; border-radius: 4px; background: white;">
                        <option value="">Genel Ã–deme</option>
                        <option value="Kira Ã–demesi">Kira Ã–demesi</option>
                        <option value="MaaÅŸ Ã–demesi">MaaÅŸ Ã–demesi</option>
                        <option value="Hizmet Bedeli">Hizmet Bedeli</option>
                        <option value="Fatura Ã–demesi">Fatura Ã–demesi</option>
                        <option value="Vergi/SGK">Vergi/SGK</option>
                        <option value="Banka Ãœcreti">Banka Ãœcreti</option>
                        <option value="DiÄŸer">DiÄŸer</option>
                    </select>
                </div>
            </div>
        `;

        container.appendChild(card);
    });

    // âœ… EKLE: Kaydetme butonu
    const saveButtonHTML = `
        <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
            <button class="btn btn-secondary" onclick="closeTransactionDetailsModal()">
                âœ–ï¸ Ä°ptal
            </button>
            <button class="btn btn-success" onclick="confirmImportTransactions()" style="font-size: 16px; padding: 12px 30px;">
                ğŸ’¾ ${transactions.length} Ä°ÅŸlemi Kaydet
            </button>
        </div>
    `;
    
    container.innerHTML += saveButtonHTML;
    
    // Global'e kaydet
    window.pendingTransactions = transactions;

    // Modal'Ä± gÃ¶ster
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.style.opacity = '1';
    }, 10);
}

// âœ… Banka iÅŸlemlerini Firebase'e kaydet
async function confirmImportTransactions() {
    console.log('ğŸ’¾ Banka iÅŸlemleri kaydediliyor...');
    
    if (!window.pendingTransactions || window.pendingTransactions.length === 0) {
        alert('âŒ Kaydedilecek iÅŸlem yok!');
        return;
    }
    
    if (!activeCompanyId) {
        alert('âŒ LÃ¼tfen bir firma seÃ§in!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('âŒ LÃ¼tfen giriÅŸ yapÄ±n!');
        return;
    }
    
    try {
        const batch = db.batch();
        const now = new Date().toISOString();
        let savedCount = 0;
        let skippedCount = 0;
        
        for (let i = 0; i < window.pendingTransactions.length; i++) {
            const trans = window.pendingTransactions[i];
            
            const accountSelect = document.querySelector(`.cari-hesap-select[data-index="${i}"]`);
            const accountId = accountSelect ? accountSelect.value : trans.suggestedAccount?.id;
            
            if (!accountId || accountId === '' || accountId === 'YOK') {
                console.log(`âš ï¸ Ä°ÅŸlem ${i} atlandÄ±: Cari hesap seÃ§ilmedi`);
                skippedCount++;
                continue;
            }
            
            const paymentRef = db.collection('companies').doc(activeCompanyId)
                .collection('payments').doc();
            
            const paymentData = {
                id: paymentRef.id,
                companyId: activeCompanyId,
                date: trans.date,
                accountId: accountId,
                amount: Math.abs(trans.amount),
                type: trans.amount > 0 ? 'income' : 'expense',
                description: trans.description,
                source: 'bank',
                createdAt: now,
                createdBy: auth.currentUser.uid
            };
            
            batch.set(paymentRef, paymentData);
            payments.push(paymentData);
            
            savedCount++;
            console.log(`âœ… Ä°ÅŸlem ${i} hazÄ±rlandÄ±: ${paymentData.amount} TL`);
        }
        
        if (savedCount > 0) {
            await batch.commit();
            console.log(`âœ… ${savedCount} iÅŸlem Firebase'e kaydedildi`);
        }
        
        closeTransactionDetailsModal();
        
        await loadPayments();
        await loadAccounts();
        updateDashboard();
        
        if (skippedCount > 0) {
            alert(`âœ… ${savedCount} iÅŸlem kaydedildi\nâš ï¸ ${skippedCount} iÅŸlem atlandÄ± (cari hesap seÃ§ilmedi)`);
        } else {
            alert(`âœ… ${savedCount} banka iÅŸlemi baÅŸarÄ±yla kaydedildi!`);
        }
        
    } catch (error) {
        console.error('âŒ Firebase kaydetme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

function closeTransactionDetailsModal() {
    console.log('ğŸ”´ Modal kapatÄ±lÄ±yor...');
    const modal = document.getElementById('transactionDetailsModal');
    if (modal) {
        modal.style.display = 'none';
    }
    window.pendingTransactions = null;
    console.log('âœ… Modal kapatÄ±ldÄ±');
}

// ========================================
// BANKA Ä°ÅLEMÄ° OTOMATÄ°K EÅLEÅTIRME
// ========================================

function findMatchingAccountForTransaction(transaction) {
    const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
    
    if (companyAccounts.length === 0) {
        return { account: null, confidence: 0, reason: 'Cari hesap yok' };
    }

    const description = transaction.description.toUpperCase();
    const amount = Math.abs(transaction.amount);

    console.log(`\nğŸ” EÅŸleÅŸtirme: "${description.substring(0, 80)}" | Tutar: ${amount}`);

    // ========================================
    // 1. BANKA ÃœCRETLERÄ° (Otomatik Atla veya Ã–zel Cari)
    // ========================================
    if (description.match(/BSMV|KOMÄ°SYON.*H\d{13}|MASRAF.*H\d{13}|ÃœCRET.*H\d{13}/i)) {
        // EÄŸer "Banka Ãœcretleri" carisi varsa otomatik eÅŸleÅŸtir
        const bankFeesAccount = companyAccounts.find(a => 
            a.name.toUpperCase().includes('BANKA') && 
            (a.name.toUpperCase().includes('ÃœCRET') || a.name.toUpperCase().includes('GÄ°DER'))
        );
        
        if (bankFeesAccount) {
            return { 
                account: bankFeesAccount, 
                confidence: 100, 
                reason: 'Banka Ã¼creti - Otomatik atandÄ±' 
            };
        }
        
        return { 
            account: null, 
            confidence: 0, 
            reason: 'Banka Ã¼creti - "Banka Ãœcretleri" carisi oluÅŸturun' 
        };
    }

    // ========================================
    // 2. FATURA Ã–DEMELERÄ° (NRC NumaralÄ±)
    // ========================================
    // Format: "//NRC2025000000285//20250721/F110//*CAMÄ°Å MADENCÄ°LÄ°K ANONÄ°M ÅÄ°RKETÄ°*..."
    const nrcMatch = description.match(/NRC\d{13}/);
    if (nrcMatch) {
        const nrcNo = nrcMatch[0];
        console.log(`ğŸ“„ NRC Fatura NumarasÄ± bulundu: ${nrcNo}`);
        
        // FaturayÄ± bul
        const matchedInvoice = invoices.find(inv => 
            inv.invoiceNo && inv.invoiceNo.toUpperCase().includes(nrcNo)
        );
        
        if (matchedInvoice) {
            const invoiceAccount = accounts.find(a => a.id === matchedInvoice.accountId);
            if (invoiceAccount) {
                console.log(`âœ… FATURA EÅLEÅME: ${nrcNo} â†’ ${invoiceAccount.name}`);
                return { 
                    account: invoiceAccount, 
                    confidence: 100, 
                    reason: `Fatura ${nrcNo} ile eÅŸleÅŸti` 
                };
            }
        }
        
        // Fatura bulunamadÄ±ysa firma adÄ±ndan eÅŸleÅŸtir
        const companyMatch = description.match(/\/\/\*([^*]+)\*/);
        if (companyMatch) {
            const companyName = companyMatch[1].trim();
            const result = findAccountByName(companyName, companyAccounts);
            if (result.account) {
                return { 
                    account: result.account, 
                    confidence: result.confidence, 
                    reason: `NRC fatura - Firma adÄ± eÅŸleÅŸti: ${companyName}` 
                };
            }
        }
    }

    // ========================================
    // 3. Ä°SÄ°M*IBAN FORMATI
    // ========================================
    // Format: "AYÅENUR ATEÅ DEMÄ°RKAN*TR270006400000115220278205*..."
    const nameIbanMatch = description.match(/^([^*]+)\*TR\d{24}/);
    if (nameIbanMatch) {
        const name = nameIbanMatch[1].trim();
        console.log(`ğŸ‘¤ Format: Ä°sim*IBAN â†’ "${name}"`);
        
        const result = findAccountByName(name, companyAccounts);
        if (result.account) {
            return { 
                account: result.account, 
                confidence: result.confidence, 
                reason: `Ä°sim eÅŸleÅŸti: ${name}` 
            };
        }
    }

    // ========================================
    // 4. Ä°SÄ°M*AÃ‡IKLAMA FORMATI (IBAN yok)
    // ========================================
    // Format: "ZET AÅ*ZET LOJÄ°STÄ°K HAZIR BETON..."
    const nameStarMatch = description.match(/^([A-ZÃ‡ÄÄ°Ã–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼\s\.]+)\*/);
    if (nameStarMatch) {
        const name = nameStarMatch[1].trim();
        
        // "ÃœCRET" gibi kelimeler deÄŸilse
        if (!name.match(/ÃœCRET|BSMV|KOMÄ°SYON|MASRAF/i)) {
            console.log(`ğŸ‘¤ Format: Ä°sim*AÃ§Ä±klama â†’ "${name}"`);
            
            const result = findAccountByName(name, companyAccounts);
            if (result.account) {
                return { 
                    account: result.account, 
                    confidence: result.confidence, 
                    reason: `Ä°sim eÅŸleÅŸti: ${name}` 
                };
            }
        }
    }

    // ========================================
    // 5. TUTAR BAZLI EÅLEÅTIRME (Bekleyen Faturalar)
    // ========================================
    const unpaidInvoices = invoices.filter(inv => {
        const remaining = inv.total - (inv.paidAmount || 0);
        return remaining > 0 && Math.abs(remaining - amount) < 1; // 1 TL tolerans
    });

    if (unpaidInvoices.length === 1) {
        const invoice = unpaidInvoices[0];
        const invoiceAccount = accounts.find(a => a.id === invoice.accountId);
        
        if (invoiceAccount) {
            console.log(`âœ… TUTAR EÅLEÅME: ${amount} TL â†’ ${invoiceAccount.name} (Fatura: ${invoice.invoiceNo})`);
            return { 
                account: invoiceAccount, 
                confidence: 85, 
                reason: `Bekleyen fatura tutarÄ± eÅŸleÅŸti (${invoice.invoiceNo})` 
            };
        }
    }

    // ========================================
    // 6. ACÄ°L DURUMLAR (MaaÅŸ, Kira vb.)
    // ========================================
    if (description.includes('MAAÅ') || description.includes('MAA')) {
        const salaryAccount = companyAccounts.find(a => 
            a.name.toUpperCase().includes('PERSONEL') || 
            a.name.toUpperCase().includes('MAAÅ')
        );
        
        if (salaryAccount) {
            return { 
                account: salaryAccount, 
                confidence: 90, 
                reason: 'MaaÅŸ Ã¶demesi tespit edildi' 
            };
        }
    }

    if (description.includes('KÄ°RA')) {
        const rentAccount = companyAccounts.find(a => 
            a.name.toUpperCase().includes('KÄ°RA')
        );
        
        if (rentAccount) {
            return { 
                account: rentAccount, 
                confidence: 90, 
                reason: 'Kira Ã¶demesi tespit edildi' 
            };
        }
    }

    console.log(`âŒ EÅŸleÅŸme bulunamadÄ±`);
    return { account: null, confidence: 0, reason: 'Otomatik eÅŸleÅŸtirme baÅŸarÄ±sÄ±z' };
}

// ========================================
// YARDIMCI FONKSÄ°YON: Ä°simden Cari Bulma
// ========================================

function findAccountByName(searchName, accountList) {
    const cleanName = (name) => {
        return name.toUpperCase()
            .replace(/\s+/g, ' ')
            .replace(/\./g, '')
            .replace(/LTD\.?\s*ÅTÄ°\.?/gi, '')
            .replace(/LÄ°MÄ°TED\s*ÅÄ°RKETÄ°/gi, '')
            .replace(/A\.?\s*Å\.?/gi, '')
            .replace(/ANONÄ°M\s*ÅÄ°RKETÄ°/gi, '')
            .replace(/SANAYÄ°/gi, '')
            .replace(/TÄ°CARET/gi, '')
            .replace(/VE/gi, '')
            .trim();
    };

    const cleanedSearch = cleanName(searchName);

    // 1. TAM EÅLEÅME
    for (let account of accountList) {
        if (cleanName(account.name) === cleanedSearch) {
            console.log(`âœ… TAM EÅLEÅME (100%): "${searchName}" â†’ "${account.name}"`);
            return { account: account, confidence: 100 };
        }
    }

    // 2. TAM Ä°Ã‡ERME
    for (let account of accountList) {
        const accountName = cleanName(account.name);
        if (accountName.includes(cleanedSearch) || cleanedSearch.includes(accountName)) {
            console.log(`âœ… TAM Ä°Ã‡ERME (95%): "${searchName}" â†’ "${account.name}"`);
            return { account: account, confidence: 95 };
        }
    }

    // 3. Ä°LK KELÄ°ME EÅLEÅME
    const firstWord = cleanedSearch.split(/\s+/)[0];
    if (firstWord.length >= 4) {
        let matches = [];
        
        for (let account of accountList) {
            const accountFirstWord = cleanName(account.name).split(/\s+/)[0];
            if (firstWord === accountFirstWord) {
                matches.push(account);
            }
        }
        
        if (matches.length === 1) {
            console.log(`âœ… Ä°LK KELÄ°ME (90%): "${searchName}" â†’ "${matches[0].name}"`);
            return { account: matches[0], confidence: 90 };
        }
    }

    // 4. Ã‡OK KELÄ°MELÄ° EÅLEÅME
    const words = cleanedSearch.split(/\s+/).filter(w => w.length > 2).slice(0, 3);
    
    if (words.length >= 2) {
        let bestMatch = null;
        let bestScore = 0;
        
        for (let account of accountList) {
            const accountName = cleanName(account.name);
            let matchCount = 0;
            
            for (let word of words) {
                if (accountName.includes(word)) {
                    matchCount++;
                }
            }
            
            const score = matchCount / words.length;
            if (score >= 0.66 && score > bestScore) {
                bestScore = score;
                bestMatch = account;
            }
        }
        
        if (bestMatch) {
            const confidence = Math.round(bestScore * 85);
            console.log(`âœ… Ã‡OK KELÄ°MELÄ° (${confidence}%): "${searchName}" â†’ "${bestMatch.name}"`);
            return { account: bestMatch, confidence: confidence };
        }
    }

    return { account: null, confidence: 0 };
}

function closeTransactionDetailsModal() {
    console.log('ğŸ”´ Modal kapatÄ±lÄ±yor...');
    const modal = document.getElementById('transactionDetailsModal');
    
    if (modal) {
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.style.display = 'none';
            pendingTransactions = [];
            console.log('âœ… Modal kapatÄ±ldÄ±');
        }, 300);
    }
}

// ===============================
// CSV'den Ã¶deme import iÅŸlemi
// ===============================
async function saveAllTransactions() {
    if (!window.pendingTransactions || window.pendingTransactions.length === 0) {
        alert('âŒ Kaydedilecek iÅŸlem yok!');
        return;
    }
    if (!activeCompanyId) {
        alert('âŒ LÃ¼tfen bir firma seÃ§in!');
        return;
    }
    if (!auth.currentUser) {
        alert('âŒ LÃ¼tfen giriÅŸ yapÄ±n!');
        return;
    }

    // Mevcut Ã¶demelerin unique key dizisini oluÅŸtur
    const existingKeys = payments.map(getPaymentUniqueKey);
    const filteredTransactions = [];
    let skippedCount = 0;

    window.pendingTransactions.forEach(tx => {
        // Cari hesap zorunlu!
        const accountId = tx.accountId || tx.suggestedAccount?.id;
        if (!accountId) return;
        tx.accountId = accountId;

        const txKey = getPaymentUniqueKey(tx);
        if (existingKeys.includes(txKey)) {
            skippedCount++;
        } else {
            filteredTransactions.push(tx);
            existingKeys.push(txKey);
        }
    });

    if (filteredTransactions.length === 0) {
        alert(`âš ï¸ TÃ¼m iÅŸlemler zaten kayÄ±tlÄ±, yeni Ã¶deme eklenmedi.`);
        return;
    }

    // Firebase batch ile ekle
    const batch = db.batch();
    const now = new Date().toISOString();
    filteredTransactions.forEach(tx => {
        const paymentRef = db.collection('companies').doc(activeCompanyId)
            .collection('payments').doc();
        const paymentData = {
            id: paymentRef.id,
            companyId: activeCompanyId,
            date: tx.date,
            time: tx.time || "",
            accountId: tx.accountId,
            amount: Math.abs(tx.amount),
            type: tx.amount > 0 ? 'income' : 'expense',
            description: tx.description,
            referenceCode: tx.referenceCode || "",
            source: tx.source || 'bank',
            createdAt: now,
            createdBy: auth.currentUser.uid
        };
        batch.set(paymentRef, paymentData);
        payments.push(paymentData);
    });

    await batch.commit();
    await loadPayments();
    await loadAccounts();
    updateDashboard();

    alert(`âœ… ${filteredTransactions.length} yeni Ã¶deme eklendi\nâš ï¸ ${skippedCount} iÅŸlem zaten vardÄ±, atlandÄ±!`);
}

// ========================================
// CARÄ° HESAP KARTI MODAL
// ========================================

let currentAccountCardId = null;
let accountCardTransactions = [];

function viewAccountCard(accountId) {
    currentAccountCardId = accountId;
    const account = accounts.find(a => a.id === accountId);
    
    if (!account) {
        alert('âŒ Cari hesap bulunamadÄ±!');
        return;
    }

    // Modal baÅŸlÄ±ÄŸÄ± ve bilgileri
    document.getElementById('accountCardTitle').innerHTML = `ğŸ“Š Cari Hesap KartÄ± - ${account.name}`;
    document.getElementById('cardAccountName').textContent = account.name;
    document.getElementById('cardAccountType').innerHTML = `<span class="badge badge-${account.type === 'customer' ? 'success' : 'warning'}">${account.type === 'customer' ? 'MÃ¼ÅŸteri' : 'TedarikÃ§i'}</span>`;
    
    const balanceColor = account.balance >= 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('cardAccountBalance').innerHTML = `<span style="color: ${balanceColor}">${formatCurrency(account.balance)}</span>`;
    
    document.getElementById('cardAccountPhone').textContent = account.phone || '-';
    document.getElementById('cardAccountEmail').textContent = account.email || '-';
    document.getElementById('cardAccountTaxNo').textContent = account.taxNo || '-';

    // YÄ±l seÃ§eneklerini doldur
    populateYearOptions();

    // TÃ¼m iÅŸlemleri yÃ¼kle
    loadAccountCardTransactions();

    // Modal'Ä± aÃ§
    document.getElementById('accountCardModal').classList.add('active');
}

function closeAccountCardModal() {
    document.getElementById('accountCardModal').classList.remove('active');
    currentAccountCardId = null;
    accountCardTransactions = [];
}

function populateYearOptions() {
    const select = document.getElementById('cardFilterYear');
    select.innerHTML = '<option value="">TÃ¼m YÄ±llar</option>';
    
    // Mevcut iÅŸlemlerden yÄ±llarÄ± Ã§Ä±kar
    const years = new Set();
    
    invoices.forEach(inv => {
        if (inv.accountId === currentAccountCardId) {
            const year = new Date(inv.date).getFullYear();
            years.add(year);
        }
    });
    
    payments.forEach(p => {
        if (p.accountId === currentAccountCardId) {
            const year = new Date(p.date).getFullYear();
            years.add(year);
        }
    });
    
    // YÄ±llarÄ± sÄ±rala ve ekle
    Array.from(years).sort((a, b) => b - a).forEach(year => {
        const option = new Option(year, year);
        select.add(option);
    });
}

function loadAccountCardTransactions() {
    accountCardTransactions = [];
    
    // FaturalarÄ± ekle
    invoices.filter(inv => inv.accountId === currentAccountCardId).forEach(inv => {
        const company = companies.find(c => c.id === inv.companyId);
        accountCardTransactions.push({
            date: inv.date,
            type: 'invoice',
            subType: inv.type,
            reference: inv.invoiceNo,
            description: `${inv.type === 'sales' ? 'ğŸ“— SatÄ±ÅŸ' : 'ğŸ“• AlÄ±ÅŸ'} FaturasÄ± - ${company ? company.name : 'Bilinmiyor'}`,
            debit: inv.type === 'sales' ? inv.total : 0,
            credit: inv.type === 'purchase' ? inv.total : 0,
            invoiceId: inv.id,
            paymentId: null
        });
    });
    
    // Ã–demeleri ekle
    payments.filter(p => p.accountId === currentAccountCardId).forEach(p => {
        const invoice = p.invoiceId ? invoices.find(inv => inv.id === p.invoiceId) : null;
        const company = companies.find(c => c.id === p.companyId);
        
        accountCardTransactions.push({
            date: p.date,
            type: 'payment',
            subType: p.type,
            reference: invoice ? invoice.invoiceNo : 'Genel Ã–deme',
            description: `${p.type === 'income' ? 'ğŸ’° Tahsilat' : 'ğŸ’¸ Ã–deme'} - ${p.description || (company ? company.name : 'Bilinmiyor')}`,
            debit: p.type === 'expense' ? p.amount : 0,
            credit: p.type === 'income' ? p.amount : 0,
            invoiceId: p.invoiceId,
            paymentId: p.id,
            source: p.source
        });
    });
    
    // Tarihe gÃ¶re sÄ±rala
    accountCardTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // â¬‡ï¸ YENÄ° EKLEME: GerÃ§ek bakiyeyi hesapla ve gÃ¼ncelle
    let calculatedBalance = 0;
    accountCardTransactions.forEach(t => {
        calculatedBalance += (t.debit - t.credit);
    });
    
    // Cari kart Ã¼stÃ¼ndeki bakiyeyi gÃ¼ncelle
    const account = accounts.find(a => a.id === currentAccountCardId);
    if (account) {
        const balanceColor = calculatedBalance >= 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('cardAccountBalance').innerHTML = `<span style="color: ${balanceColor}">${formatCurrency(calculatedBalance)}</span>`;
        
        // âš ï¸ BONUS: EÄŸer hesaplanan bakiye account.balance ile uyuÅŸmuyorsa uyar
        if (Math.abs(calculatedBalance - account.balance) > 0.01) {
            console.warn(
                `âš ï¸ Bakiye uyuÅŸmazlÄ±ÄŸÄ± tespit edildi!\n` +
                `Cari: ${account.name}\n` +
                `VeritabanÄ± bakiyesi: ${account.balance}\n` +
                `Hesaplanan bakiye: ${calculatedBalance}\n` +
                `Fark: ${calculatedBalance - account.balance}`
            );
        }
    }
    
    filterAccountCard();
}

// ========================================
// BAKÄ°YE YENÄ°DEN HESAPLAMA (SADECE BAKÄ°YELERÄ° DÃœZELTIR)
// ========================================
async function recalculateAccountBalances() {
    if (!confirm(
        'âš ï¸ TÃ¼m cari hesaplarÄ±n bakiyelerini yeniden hesaplamak istediÄŸinize emin misiniz?\n\n' +
        'Bu iÅŸlem:\n' +
        'âœ… Fatura ve Ã¶demelere gÃ¶re bakiyeleri dÃ¼zeltecektir\n' +
        'âŒ Ã–deme kayÄ±tlarÄ±nÄ± deÄŸiÅŸtirmeyecektir\n\n' +
        'Devam etmek istiyor musunuz?'
    )) {
        return;
    }
    
    try {
        const batch = db.batch();
        let correctedCount = 0;
        
        for (const account of accounts) {
            console.log(`\nğŸ” ${account.name} kontrol ediliyor...`);
            
            // Bu cariye ait faturalarÄ± topla
            let calculatedBalance = 0;
            
            // 1. Faturalardan hesapla
            const accountInvoices = invoices.filter(inv => 
                inv.accountId === account.id && 
                inv.status !== 'deleted' && 
                inv.status !== 'passive'
            );
            
            accountInvoices.forEach(inv => {
                const unpaidAmount = inv.total - (inv.paidAmount || 0);
                if (inv.type === 'sales') {
                    calculatedBalance += unpaidAmount; // MÃ¼ÅŸteri borcu
                    console.log(`  ğŸ“— SatÄ±ÅŸ: ${inv.invoiceNo} â†’ +${formatCurrency(unpaidAmount)}`);
                } else {
                    calculatedBalance -= unpaidAmount; // TedarikÃ§i alacaÄŸÄ±
                    console.log(`  ğŸ“• AlÄ±ÅŸ: ${inv.invoiceNo} â†’ -${formatCurrency(unpaidAmount)}`);
                }
            });
            
            // 2. FaturasÄ±z Ã¶demeleri ekle (genel Ã¶demeler)
            const accountPayments = payments.filter(p => 
                p.accountId === account.id && 
                !p.invoiceId && // Sadece faturasÄ±z Ã¶demeler
                p.status !== 'deleted'
            );
            
            accountPayments.forEach(p => {
                if (p.type === 'income') {
                    calculatedBalance -= p.amount; // Tahsilat (borÃ§ azalÄ±r)
                    console.log(`  ğŸ’° Tahsilat: ${p.description} â†’ -${formatCurrency(p.amount)}`);
                } else {
                    calculatedBalance += p.amount; // Ã–deme (alacak azalÄ±r)
                    console.log(`  ğŸ’¸ Ã–deme: ${p.description} â†’ +${formatCurrency(p.amount)}`);
                }
            });
            
            console.log(`  ğŸ“Š Hesaplanan: ${formatCurrency(calculatedBalance)}`);
            console.log(`  ğŸ’¾ Mevcut: ${formatCurrency(account.balance)}`);
            
            // EÄŸer fark varsa dÃ¼zelt
            if (Math.abs(calculatedBalance - account.balance) > 0.01) {
                console.log(`  ğŸ”§ DÃœZELTME GEREKÄ°YOR!`);
                
                const accountRef = db.collection('companies')
                    .doc(activeCompanyId)
                    .collection('accounts')
                    .doc(account.id);
                
                batch.update(accountRef, { balance: calculatedBalance });
                account.balance = calculatedBalance;
                correctedCount++;
            } else {
                console.log(`  âœ… Bakiye doÄŸru`);
            }
        }
        
        if (correctedCount > 0) {
            await batch.commit();
            await loadAccounts();
            
            // EÄŸer cari kartÄ± aÃ§Ä±ksa yenile
            if (currentAccountCardId) {
                loadAccountCardTransactions();
                filterAccountCard();
            }
            
            updateDashboard();
            alert(`âœ… ${correctedCount} cari hesabÄ±n bakiyesi dÃ¼zeltildi!`);
        } else {
            alert('âœ… TÃ¼m bakiyeler doÄŸru, dÃ¼zeltme yapÄ±lmadÄ±.');
        }
        
    } catch (error) {
        console.error('Bakiye dÃ¼zeltme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

function filterAccountCard() {
    const year = document.getElementById('cardFilterYear').value;
    const startDate = document.getElementById('cardFilterStartDate').value;
    const endDate = document.getElementById('cardFilterEndDate').value;
    const filterType = document.getElementById('cardFilterType').value;
    
    let filtered = [...accountCardTransactions];
    
    // YÄ±l filtresi
    if (year) {
        filtered = filtered.filter(t => new Date(t.date).getFullYear().toString() === year);
    }
    
    // Tarih aralÄ±ÄŸÄ± filtresi
    if (startDate) {
        filtered = filtered.filter(t => t.date >= startDate);
    }
    if (endDate) {
        filtered = filtered.filter(t => t.date <= endDate);
    }
    
    // Ä°ÅŸlem tipi filtresi
    if (filterType === 'invoice') {
        filtered = filtered.filter(t => t.type === 'invoice');
    } else if (filterType === 'payment') {
        filtered = filtered.filter(t => t.type === 'payment');
    } else if (filterType === 'income') {
        filtered = filtered.filter(t => t.credit > 0);
    } else if (filterType === 'expense') {
        filtered = filtered.filter(t => t.debit > 0);
    }
    
    renderAccountCardTable(filtered);
    updateAccountCardStats(filtered);
}

function renderAccountCardTable(transactions) {
    const tbody = document.querySelector('#accountCardTable tbody');
    tbody.innerHTML = '';
    
    if (transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#6b7280;">Bu filtreye uygun iÅŸlem bulunamadÄ±.</td></tr>';
        return;
    }
    
    let balance = 0;
    
    transactions.forEach(t => {
        balance += (t.debit - t.credit);
        
        // Tip badge'i
        let typeBadge = '';
        if (t.type === 'invoice') {
            typeBadge = `<span class="badge badge-${t.subType === 'sales' ? 'success' : 'warning'}">Fatura</span>`;
        } else {
            typeBadge = `<span class="badge badge-${t.subType === 'income' ? 'success' : 'danger'}">Ã–deme</span>`;
            if (t.source === 'bank') {
                typeBadge += ' <span class="badge badge-info" style="font-size:0.8em;">Banka</span>';
            }
        }
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${formatDate(t.date)}</td>
            <td>${typeBadge}</td>
            <td><strong>${t.reference}</strong></td>
            <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${t.description}</td>
            <td style="color: var(--danger); font-weight: 600;">${t.debit > 0 ? formatCurrency(t.debit) : '-'}</td>
            <td style="color: var(--success); font-weight: 600;">${t.credit > 0 ? formatCurrency(t.credit) : '-'}</td>
            <td style="font-weight: 700; color: ${balance >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(balance)}</td>
            <td>
                ${t.invoiceId ? `<button class="btn btn-info btn-sm" onclick="viewInvoice('${t.invoiceId}')" title="FaturayÄ± GÃ¶rÃ¼ntÃ¼le">ğŸ‘ï¸</button>` : ''}
                ${t.paymentId ? `
                    <button class="btn btn-warning btn-sm" onclick="editPayment('${t.paymentId}')" title="Ã–deme DÃ¼zenle">âœï¸</button>
                ` : ''}
            </td>
        `;
    });
}

function updateAccountCardStats(transactions) {
    let totalIncome = 0;
    let totalExpense = 0;
    let totalInvoices = 0;
    let incomeCount = 0;
    let expenseCount = 0;
    let invoiceCount = 0;
    
    transactions.forEach(t => {
        if (t.credit > 0) {
            totalIncome += t.credit;
            incomeCount++;
        }
        if (t.debit > 0) {
            totalExpense += t.debit;
            expenseCount++;
        }
        if (t.type === 'invoice') {
            totalInvoices += (t.debit || t.credit);
            invoiceCount++;
        }
    });
    
    const netBalance = totalIncome - totalExpense;
    
    document.getElementById('cardTotalIncome').textContent = formatCurrency(totalIncome);
    document.getElementById('cardIncomeCount').textContent = `${incomeCount} iÅŸlem`;
    
    document.getElementById('cardTotalExpense').textContent = formatCurrency(totalExpense);
    document.getElementById('cardExpenseCount').textContent = `${expenseCount} iÅŸlem`;
    
    document.getElementById('cardTotalInvoices').textContent = formatCurrency(totalInvoices);
    document.getElementById('cardInvoiceCount').textContent = `${invoiceCount} fatura`;
    
    const netBalanceColor = netBalance >= 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('cardNetBalance').innerHTML = `<span style="color: ${netBalanceColor}">${formatCurrency(netBalance)}</span>`;
}

function clearAccountCardFilters() {
    document.getElementById('cardFilterYear').value = '';
    document.getElementById('cardFilterStartDate').value = '';
    document.getElementById('cardFilterEndDate').value = '';
    document.getElementById('cardFilterType').value = '';
    filterAccountCard();
}

function viewPaymentDetail(paymentId) {
    const payment = payments.find(p => p.id === paymentId);
    if (!payment) {
        alert('âŒ Ã–deme kaydÄ± bulunamadÄ±!');
        return;
    }
    
    const account = accounts.find(a => a.id === payment.accountId);
    const invoice = payment.invoiceId ? invoices.find(inv => inv.id === payment.invoiceId) : null;
    const company = companies.find(c => c.id === payment.companyId);
    
    const details = `
ğŸ“‹ Ã–DEME DETAYI

Tarih: ${formatDate(payment.date)}
Cari: ${account ? account.name : 'Bilinmiyor'}
Firma: ${company ? company.name : 'Bilinmiyor'}
Tutar: ${formatCurrency(payment.amount)}
Tip: ${payment.type === 'income' ? 'ğŸ’° Tahsilat (Gelen)' : 'ğŸ’¸ Ã–deme (Giden)'}
${invoice ? `Fatura: ${invoice.invoiceNo}` : 'Fatura: Genel Ã–deme'}
Kaynak: ${payment.source === 'manual' ? 'âœï¸ Manuel' : 'ğŸ¦ Banka'}
AÃ§Ä±klama: ${payment.description || '-'}
KayÄ±t Tarihi: ${new Date(payment.createdAt).toLocaleString('tr-TR')}
    `;
    
    alert(details);
}

function exportAccountCard() {
    const account = accounts.find(a => a.id === currentAccountCardId);
    if (!account) return;
    
    const year = document.getElementById('cardFilterYear').value;
    const startDate = document.getElementById('cardFilterStartDate').value;
    const endDate = document.getElementById('cardFilterEndDate').value;
    
    // Filtered transactions al
    let filtered = [...accountCardTransactions];
    
    if (year) {
        filtered = filtered.filter(t => new Date(t.date).getFullYear().toString() === year);
    }
    if (startDate) {
        filtered = filtered.filter(t => t.date >= startDate);
    }
    if (endDate) {
        filtered = filtered.filter(t => t.date <= endDate);
    }
    
    // CSV oluÅŸtur
    let csv = 'Tarih,Ä°ÅŸlem Tipi,Referans,AÃ§Ä±klama,BorÃ§,Alacak,Bakiye\n';
    
    let balance = 0;
    filtered.forEach(t => {
        balance += (t.debit - t.credit);
        
        const typeText = t.type === 'invoice' ? 'Fatura' : 'Ã–deme';
        const debitText = t.debit > 0 ? t.debit.toFixed(2) : '';
        const creditText = t.credit > 0 ? t.credit.toFixed(2) : '';
        
        csv += `${t.date},${typeText},${t.reference},"${t.description.replace(/"/g, '""')}",${debitText},${creditText},${balance.toFixed(2)}\n`;
    });
    
    // Download
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `cari-hesap-${account.name}-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    
    alert('âœ… Cari hesap kartÄ± Excel\'e aktarÄ±ldÄ±!');
}

// ========================================
// FÄ°RMA DÃ–KÃœMAN YÃ–NETÄ°MÄ°
// ========================================

function addCompanyDocument() {
    const docId = Date.now() + Math.random();
    
    companyDocuments.push({
        id: docId,
        name: '',
        file: null,
        fileName: '',
        fileSize: 0,
        fileType: '',
        uploadDate: new Date().toISOString()
    });
    
    renderCompanyDocuments();
}

function renderCompanyDocuments() {
    const container = document.getElementById('companyDocumentsList');
    container.innerHTML = '';
    
    if (companyDocuments.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; font-style: italic;">HenÃ¼z dÃ¶kÃ¼man eklenmedi.</p>';
        return;
    }
    
    companyDocuments.forEach((doc, index) => {
        const div = document.createElement('div');
        div.style.cssText = 'border: 2px solid #e5e7eb; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f9fafb;';
        
        div.innerHTML = `
            <div class="grid-2" style="align-items: end;">
                <div class="form-group" style="margin: 0;">
                    <label>DÃ¶kÃ¼man AdÄ±</label>
                    <input type="text" 
                           value="${doc.name}" 
                           onchange="updateCompanyDocName(${index}, this.value)" 
                           placeholder="Ã–rn: Ticaret Sicil Gazetesi"
                           style="margin: 0;">
                </div>
                <div class="form-group" style="margin: 0;">
                    <label>Dosya SeÃ§</label>
                    <input type="file" 
                           onchange="handleCompanyDocFile(${index}, this.files[0])"
                           accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                           style="margin: 0;">
                </div>
            </div>
            ${doc.fileName ? `
                <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 0.9em;">
                    ğŸ“„ <strong>${doc.fileName}</strong> 
                    (${formatFileSize(doc.fileSize)})
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeCompanyDocument(${index})" style="float: right;">
                        ğŸ—‘ï¸ KaldÄ±r
                    </button>
                </div>
            ` : ''}
        `;
        
        container.appendChild(div);
    });
}

function updateCompanyDocName(index, name) {
    companyDocuments[index].name = name;
}

function handleCompanyDocFile(index, file) {
    if (!file) return;
    
    // Dosya boyut kontrolÃ¼ (max 10MB per file)
    if (file.size > 10 * 1024 * 1024) {
        alert('âš ï¸ Dosya boyutu 10 MB\'dan kÃ¼Ã§Ã¼k olmalÄ±dÄ±r!');
        return;
    }
    
    // Dosya tipini kontrol et
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg', 
                          'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    
    if (!allowedTypes.includes(file.type)) {
        alert('âš ï¸ Sadece PDF, JPG, PNG, DOC, DOCX dosyalarÄ± yÃ¼klenebilir!');
        return;
    }
    
    // FileReader ile base64'e Ã§evir
    const reader = new FileReader();
    reader.onload = function(e) {
        companyDocuments[index].file = e.target.result; // base64
        companyDocuments[index].fileName = file.name;
        companyDocuments[index].fileSize = file.size;
        companyDocuments[index].fileType = file.type;
        
        renderCompanyDocuments();
    };
    reader.readAsDataURL(file);
}

function removeCompanyDocument(index) {
    if (confirm('Bu dÃ¶kÃ¼manÄ± kaldÄ±rmak istediÄŸinizden emin misiniz?')) {
        companyDocuments.splice(index, 1);
        renderCompanyDocuments();
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// ========================================
// CARÄ° DÃ–KÃœMAN YÃ–NETÄ°MÄ°
// ========================================

function addAccountDocument() {
    if (accountDocuments.length >= MAX_ACCOUNT_DOCS) {
        alert('âš ï¸ Maksimum 5 dÃ¶kÃ¼man ekleyebilirsiniz!');
        return;
    }
    
    const totalSize = accountDocuments.reduce((sum, doc) => sum + doc.fileSize, 0);
    if (totalSize >= MAX_ACCOUNT_SIZE) {
        alert('âš ï¸ Toplam dÃ¶kÃ¼man boyutu 3 MB\'Ä± aÅŸamaz!');
        return;
    }
    
    const docId = Date.now() + Math.random();
    
    accountDocuments.push({
        id: docId,
        name: '',
        file: null,
        fileName: '',
        fileSize: 0,
        fileType: '',
        uploadDate: new Date().toISOString()
    });
    
    renderAccountDocuments();
}

function renderAccountDocuments() {
    const container = document.getElementById('accountDocumentsList');
    container.innerHTML = '';
    
    if (accountDocuments.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; font-style: italic;">HenÃ¼z dÃ¶kÃ¼man eklenmedi.</p>';
    } else {
        accountDocuments.forEach((doc, index) => {
            const div = document.createElement('div');
            div.style.cssText = 'border: 2px solid #e5e7eb; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f9fafb;';
            
            div.innerHTML = `
                <div class="grid-2" style="align-items: end;">
                    <div class="form-group" style="margin: 0;">
                        <label>DÃ¶kÃ¼man AdÄ±</label>
                        <input type="text" 
                               value="${doc.name}" 
                               onchange="updateAccountDocName(${index}, this.value)" 
                               placeholder="Ã–rn: SÃ¶zleÅŸme"
                               style="margin: 0;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Dosya SeÃ§</label>
                        <input type="file" 
                               onchange="handleAccountDocFile(${index}, this.files[0])"
                               accept=".pdf,.jpg,.jpeg,.png"
                               style="margin: 0;">
                    </div>
                </div>
                ${doc.fileName ? `
                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 0.9em;">
                        ğŸ“„ <strong>${doc.fileName}</strong> 
                        (${formatFileSize(doc.fileSize)})
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeAccountDocument(${index})" style="float: right;">
                            ğŸ—‘ï¸ KaldÄ±r
                        </button>
                    </div>
                ` : ''}
            `;
            
            container.appendChild(div);
        });
    }
    
    // Buton gÃ¼ncelle
    const totalSize = accountDocuments.reduce((sum, doc) => sum + doc.fileSize, 0);
    document.getElementById('addAccountDocBtn').textContent = `â• DÃ¶kÃ¼man Ekle (${accountDocuments.length}/${MAX_ACCOUNT_DOCS})`;
    document.getElementById('addAccountDocBtn').disabled = accountDocuments.length >= MAX_ACCOUNT_DOCS || totalSize >= MAX_ACCOUNT_SIZE;
    document.getElementById('accountDocSize').textContent = formatFileSize(totalSize);
    
    // Boyut uyarÄ±sÄ±
    const sizeInfo = document.getElementById('accountDocSizeInfo');
    if (totalSize > MAX_ACCOUNT_SIZE * 0.9) {
        sizeInfo.style.color = 'var(--danger)';
    } else if (totalSize > MAX_ACCOUNT_SIZE * 0.7) {
        sizeInfo.style.color = 'var(--warning)';
    } else {
        sizeInfo.style.color = '#6b7280';
    }
}

function updateAccountDocName(index, name) {
    accountDocuments[index].name = name;
}

function handleAccountDocFile(index, file) {
    if (!file) return;
    
    // Mevcut toplam boyut
    const currentTotalSize = accountDocuments.reduce((sum, doc, idx) => {
        return idx === index ? sum : sum + doc.fileSize;
    }, 0);
    
    // Yeni dosya ile birlikte toplam boyut kontrolÃ¼
    if (currentTotalSize + file.size > MAX_ACCOUNT_SIZE) {
        alert(`âš ï¸ Toplam dÃ¶kÃ¼man boyutu ${formatFileSize(MAX_ACCOUNT_SIZE)} sÄ±nÄ±rÄ±nÄ± aÅŸÄ±yor!\n\nMevcut: ${formatFileSize(currentTotalSize)}\nYeni dosya: ${formatFileSize(file.size)}`);
        return;
    }
    
    // Dosya boyut kontrolÃ¼ (max 2MB per file)
    if (file.size > 2 * 1024 * 1024) {
        alert('âš ï¸ Tek dosya boyutu 2 MB\'dan kÃ¼Ã§Ã¼k olmalÄ±dÄ±r!');
        return;
    }
    
    // Dosya tipini kontrol et (sadece PDF ve resim)
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg'];
    
    if (!allowedTypes.includes(file.type)) {
        alert('âš ï¸ Sadece PDF, JPG, PNG dosyalarÄ± yÃ¼klenebilir!');
        return;
    }
    
    // FileReader ile base64'e Ã§evir
    const reader = new FileReader();
    reader.onload = function(e) {
        accountDocuments[index].file = e.target.result; // base64
        accountDocuments[index].fileName = file.name;
        accountDocuments[index].fileSize = file.size;
        accountDocuments[index].fileType = file.type;
        
        renderAccountDocuments();
    };
    reader.readAsDataURL(file);
}

function removeAccountDocument(index) {
    if (confirm('Bu dÃ¶kÃ¼manÄ± kaldÄ±rmak istediÄŸinizden emin misiniz?')) {
        accountDocuments.splice(index, 1);
        renderAccountDocuments();
    }
}

// ========================================
// DÃ–KÃœMAN GÃ–RÃœNTÃœLEME
// ========================================

let currentDocuments = [];
let currentDocumentData = null;

function viewCompanyDocuments(companyId) {
    const company = companies.find(c => c.id === companyId);
    if (!company || !company.documents || company.documents.length === 0) {
        alert('âŒ Bu firmaya ait dÃ¶kÃ¼man bulunamadÄ±!');
        return;
    }
    
    currentDocuments = company.documents;
    
    document.getElementById('documentsModalTitle').textContent = `ğŸ“ ${company.name} - DÃ¶kÃ¼manlar`;
    
    renderDocumentsList();
    
    document.getElementById('documentsModal').classList.add('active');
}

function viewAccountDocuments(accountId) {
    const account = accounts.find(a => a.id === accountId);
    if (!account || !account.documents || account.documents.length === 0) {
        alert('âŒ Bu cari hesaba ait dÃ¶kÃ¼man bulunamadÄ±!');
        return;
    }
    
    currentDocuments = account.documents;
    
    document.getElementById('documentsModalTitle').textContent = `ğŸ“ ${account.name} - DÃ¶kÃ¼manlar`;
    
    renderDocumentsList();
    
    document.getElementById('documentsModal').classList.add('active');
}

function renderDocumentsList() {
    const container = document.getElementById('documentsListView');
    container.innerHTML = '';
    
    if (currentDocuments.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#6b7280;">DÃ¶kÃ¼man bulunamadÄ±.</p>';
        return;
    }
    
    currentDocuments.forEach((doc, index) => {
        const card = document.createElement('div');
        card.style.cssText = `
            border: 2px solid #e5e7eb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        `;
        
        card.onmouseover = function() {
            this.style.borderColor = '#2563eb';
            this.style.boxShadow = '0 4px 12px rgba(37, 99, 235, 0.2)';
        };
        
        card.onmouseout = function() {
            this.style.borderColor = '#e5e7eb';
            this.style.boxShadow = 'none';
        };
        
        const fileIcon = getFileIcon(doc.fileType);
        const uploadDate = new Date(doc.uploadDate).toLocaleDateString('tr-TR');
        
        card.innerHTML = `
            <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 2.5em;">${fileIcon}</div>
                    <div>
                        <h4 style="margin: 0; color: var(--primary);">${doc.name || 'Ä°simsiz DÃ¶kÃ¼man'}</h4>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">
                            ğŸ“„ ${doc.fileName} â€¢ ${formatFileSize(doc.fileSize)} â€¢ ${uploadDate}
                        </p>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-info btn-sm" onclick="viewDocument(${index})" title="GÃ¶rÃ¼ntÃ¼le">
                    ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼le
                </button>
                <button class="btn btn-success btn-sm" onclick="downloadDocument(${index})" title="Ä°ndir">
                    ğŸ“¥ Ä°ndir
                </button>
            </div>
        `;
        
        container.appendChild(card);
    });
}

function getFileIcon(fileType) {
    if (fileType.includes('pdf')) return 'ğŸ“•';
    if (fileType.includes('image')) return 'ğŸ–¼ï¸';
    if (fileType.includes('word') || fileType.includes('doc')) return 'ğŸ“„';
    return 'ğŸ“';
}

function viewDocument(index) {
    const doc = currentDocuments[index];
    currentDocumentData = doc;
    
    document.getElementById('documentViewerTitle').textContent = `ğŸ“„ ${doc.name}`;
    
    const content = document.getElementById('documentViewerContent');
    content.innerHTML = '';
    
    if (doc.fileType.includes('image')) {
        // Resim gÃ¶ster
        const img = document.createElement('img');
        img.src = doc.file;
        img.style.maxWidth = '100%';
        img.style.borderRadius = '8px';
        img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        content.appendChild(img);
    } else if (doc.fileType.includes('pdf')) {
        // PDF gÃ¶ster
        const iframe = document.createElement('iframe');
        iframe.src = doc.file;
        iframe.style.width = '100%';
        iframe.style.height = '600px';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        content.appendChild(iframe);
    } else {
        // DiÄŸer dosya tipleri iÃ§in download butonu
        content.innerHTML = `
            <div style="padding: 40px; text-align: center;">
                <div style="font-size: 4em; margin-bottom: 20px;">ğŸ“„</div>
                <h3>${doc.fileName}</h3>
                <p style="color: #6b7280; margin: 20px 0;">Bu dosya tÃ¼rÃ¼ Ã¶nizlenemez.</p>
                <button class="btn btn-success" onclick="downloadDocument(${index})">
                    ğŸ“¥ DosyayÄ± Ä°ndir
                </button>
            </div>
        `;
    }
    
    document.getElementById('documentViewerModal').classList.add('active');
}

function downloadDocument(index) {
    const doc = currentDocuments[index];
    
    // Base64'ten blob oluÅŸtur
    const byteString = atob(doc.file.split(',')[1]);
    const mimeString = doc.file.split(',')[0].split(':')[1].split(';')[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    
    const blob = new Blob([ab], { type: mimeString });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = doc.fileName;
    link.click();
    
    URL.revokeObjectURL(url);
}

function downloadCurrentDocument() {
    if (currentDocumentData) {
        const index = currentDocuments.indexOf(currentDocumentData);
        downloadDocument(index);
    }
}

function closeDocumentsModal() {
    document.getElementById('documentsModal').classList.remove('active');
    currentDocuments = [];
}

function closeDocumentViewer() {
    document.getElementById('documentViewerModal').classList.remove('active');
    currentDocumentData = null;
}

// ========================================
// FÄ°RMA DETAY MODAL
// ========================================

let currentDetailCompanyId = null;

function viewCompanyDetail(companyId) {
    const company = companies.find(c => c.id === companyId);
    
    if (!company) {
        alert('âŒ Firma bulunamadÄ±!');
        return;
    }
    
    currentDetailCompanyId = companyId;
    
    // BaÅŸlÄ±k
    document.getElementById('companyDetailTitle').textContent = `ğŸ¢ ${company.name}`;
    
    // Temel Bilgiler
    document.getElementById('detailCompanyName').textContent = company.name;
    document.getElementById('detailCompanySector').textContent = company.sector || 'SektÃ¶r belirtilmemiÅŸ';
    document.getElementById('detailCompanyNameFull').textContent = company.name;
    document.getElementById('detailCompanySectorFull').innerHTML = company.sector 
        ? `<span class="badge badge-info" style="font-size: 1em;">${company.sector}</span>` 
        : '<span style="color: #6b7280;">BelirtilmemiÅŸ</span>';
    
    // Vergi Bilgileri
    document.getElementById('detailCompanyTaxNo').textContent = company.taxNo || '-';
    document.getElementById('detailCompanyTaxOffice').textContent = company.taxOffice || '-';
    
    // Ä°letiÅŸim Bilgileri
    document.getElementById('detailCompanyPhone').textContent = company.phone || '-';
    
    const emailEl = document.getElementById('detailCompanyEmail');
    if (company.email) {
        emailEl.innerHTML = `<a href="mailto:${company.email}" style="color: var(--primary);">${company.email}</a>`;
    } else {
        emailEl.textContent = '-';
    }
    
    const websiteEl = document.getElementById('detailCompanyWebsite');
    if (company.website) {
        websiteEl.innerHTML = `<a href="${company.website}" target="_blank" style="color: var(--primary);">${company.website}</a>`;
    } else {
        websiteEl.textContent = '-';
    }
    
    document.getElementById('detailCompanyAddress').textContent = company.address || '-';
    
    // DÃ¶kÃ¼manlar
    if (company.documents && company.documents.length > 0) {
        document.getElementById('detailCompanyDocumentsCard').style.display = 'block';
        document.getElementById('detailViewDocsBtn').style.display = 'inline-block';
        
        const docsContainer = document.getElementById('detailCompanyDocuments');
        docsContainer.innerHTML = '';
        
        company.documents.forEach((doc, index) => {
            const docDiv = document.createElement('div');
            docDiv.style.cssText = 'display: flex; align-items: center; padding: 12px; background: white; border-radius: 6px; margin-bottom: 10px; border: 1px solid #e5e7eb;';
            
            const fileIcon = getFileIcon(doc.fileType);
            
            docDiv.innerHTML = `
                <div style="font-size: 2em; margin-right: 15px;">${fileIcon}</div>
                <div style="flex: 1;">
                    <strong>${doc.name || 'Ä°simsiz DÃ¶kÃ¼man'}</strong>
                    <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        ${doc.fileName} â€¢ ${formatFileSize(doc.fileSize)}
                    </p>
                </div>
                <span class="badge badge-info">${index + 1}</span>
            `;
            
            docsContainer.appendChild(docDiv);
        });
    } else {
        document.getElementById('detailCompanyDocumentsCard').style.display = 'none';
        document.getElementById('detailViewDocsBtn').style.display = 'none';
    }
    
    // KayÄ±t LoglarÄ±
    if (company.createdAt) {
        const createdDate = new Date(company.createdAt).toLocaleString('tr-TR');
        const createdBy = company.createdBy || 'Bilinmiyor';
        document.getElementById('detailCompanyCreated').innerHTML = `
            <span style="color: var(--success); font-weight: 600;">${createdDate}</span><br>
            <span style="font-size: 0.9em; color: #6b7280;">OluÅŸturan: ${createdBy}</span>
        `;
    } else {
        document.getElementById('detailCompanyCreated').textContent = '-';
    }
    
    if (company.updatedAt && company.updatedAt !== company.createdAt) {
        const updatedDate = new Date(company.updatedAt).toLocaleString('tr-TR');
        const updatedBy = company.updatedBy || 'Bilinmiyor';
        document.getElementById('detailCompanyUpdated').innerHTML = `
            <span style="color: var(--warning); font-weight: 600;">${updatedDate}</span><br>
            <span style="font-size: 0.9em; color: #6b7280;">GÃ¼ncelleyen: ${updatedBy}</span>
        `;
    } else {
        document.getElementById('detailCompanyUpdated').innerHTML = '<span style="color: #6b7280;">GÃ¼ncelleme yapÄ±lmamÄ±ÅŸ</span>';
    }
    
    // Cari Hesap SayÄ±sÄ±
    const companyAccounts = accounts.filter(a => a.companyId === companyId);
    document.getElementById('detailAccountCount').textContent = companyAccounts.length;
    
    // Finansal Ã–zet
    calculateCompanyFinancials(companyId);
    
    // Cari Hesaplar Listesi
    renderCompanyAccountsList(companyAccounts);
    
    // Modal'Ä± aÃ§
    document.getElementById('companyDetailModal').classList.add('active');
}

function calculateCompanyFinancials(companyId) {
    const companyInvoices = invoices.filter(inv => inv.companyId === companyId);
    const companyPayments = payments.filter(p => p.companyId === companyId);
    
    const salesInvoices = companyInvoices.filter(inv => inv.type === 'sales');
    const purchaseInvoices = companyInvoices.filter(inv => inv.type === 'purchase');
    
    const totalIncome = salesInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
    const totalExpense = purchaseInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
    const netProfit = totalIncome - totalExpense;
    
    const totalPaymentsAmount = companyPayments.reduce((sum, p) => sum + p.amount, 0);
    
    document.getElementById('detailTotalIncome').textContent = formatCurrency(totalIncome);
    document.getElementById('detailIncomeInvoices').textContent = `${salesInvoices.length} fatura`;
    
    document.getElementById('detailTotalExpense').textContent = formatCurrency(totalExpense);
    document.getElementById('detailExpenseInvoices').textContent = `${purchaseInvoices.length} fatura`;
    
    const netProfitEl = document.getElementById('detailNetProfit');
    netProfitEl.textContent = formatCurrency(netProfit);
    netProfitEl.style.color = netProfit >= 0 ? 'var(--success)' : 'var(--danger)';
    
    document.getElementById('detailTotalPayments').textContent = formatCurrency(totalPaymentsAmount);
    document.getElementById('detailPaymentCount').textContent = `${companyPayments.length} Ã¶deme`;
}

function renderCompanyAccountsList(companyAccounts) {
    const container = document.getElementById('detailCompanyAccountsList');
    
    if (companyAccounts.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Bu firmaya ait cari hesap bulunmuyor.</p>';
        return;
    }
    
    container.innerHTML = '';
    
    companyAccounts.forEach(account => {
        const accountDiv = document.createElement('div');
        accountDiv.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.3s;
        `;
        
        accountDiv.onmouseover = function() {
            this.style.borderColor = '#2563eb';
            this.style.boxShadow = '0 4px 12px rgba(37, 99, 235, 0.2)';
        };
        
        accountDiv.onmouseout = function() {
            this.style.borderColor = '#e5e7eb';
            this.style.boxShadow = 'none';
        };
        
const typeText = account.type === 'customer'
    ? 'MÃ¼ÅŸteri'
    : account.type === 'supplier'
    ? 'TedarikÃ§i'
    : 'Personel';

const typeBadge = account.type === 'customer'
    ? 'success'
    : account.type === 'supplier'
    ? 'warning'
    : 'info';

        const balanceColor = account.balance >= 0 ? 'var(--success)' : 'var(--danger)';
        
        accountDiv.innerHTML = `
            <div style="flex: 1;">
                <h4 style="margin: 0 0 5px 0; color: var(--primary);">${account.name}</h4>
                <div style="display: flex; gap: 10px; font-size: 0.9em; color: #6b7280;">
                    <span class="badge badge-${typeBadge}">${typeText}</span>
                    ${account.phone ? `<span>ğŸ“± ${account.phone}</span>` : ''}
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 1.5em; font-weight: 700; color: ${balanceColor}; margin-bottom: 5px;">
                    ${formatCurrency(account.balance)}
                </div>
                <button class="btn btn-info btn-sm" onclick="viewAccountCardFromCompanyDetail('${account.id}')">
                    ğŸ“Š Hesap KartÄ±
                </button>
            </div>
        `;
        
        container.appendChild(accountDiv);
    });
}

function editCompanyFromDetail() {
    closeCompanyDetailModal();
    showTab('companies');
    document.querySelector('.tab[onclick*="companies"]').click();
    setTimeout(() => {
        editCompany(currentDetailCompanyId);
    }, 300);
}

function viewCompanyAccountsFromDetail() {
    closeCompanyDetailModal();
    viewCompanyAccounts(currentDetailCompanyId);
}

function viewCompanyDocumentsFromDetail() {
    viewCompanyDocuments(currentDetailCompanyId);
}

function viewAccountCardFromCompanyDetail(accountId) {
    viewAccountCard(accountId);
}

function closeCompanyDetailModal() {
    document.getElementById('companyDetailModal').classList.remove('active');
    currentDetailCompanyId = null;
}

// ========================================
// E-FATURA Ä°MPORT SÄ°STEMÄ°
// ========================================

// MODAL AÃ‡MA - HER SEFERÄ°NDE TEMÄ°ZLENÄ°R
function openImportInvoiceModal() {
    // Eski modal varsa kapat ve inputu sÄ±fÄ±rla
    closeImportInvoiceModal();

    if (!activeCompanyId) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce bir firma seÃ§in!');
        return;
    }
    document.getElementById('importInvoiceModal').classList.add('active');
    // Dosya inputunu sÄ±fÄ±rla
    const input = document.getElementById('invoiceExcelFile');
    if (input) input.value = '';
}

// MODAL KAPATMA - HER SEFERÄ°NDE TEMÄ°ZLENÄ°R
function closeImportInvoiceModal() {
    const modal = document.getElementById('importInvoiceModal');
    if (modal) modal.classList.remove('active');
    const input = document.getElementById('invoiceExcelFile');
    if (input) input.value = '';
}

function updateInvoiceTypeSelection() {
    const selectedType = document.querySelector('input[name="invoiceImportType"]:checked').value;
    currentInvoiceType = selectedType;
    console.log('Fatura tÃ¼rÃ¼ seÃ§ildi:', selectedType === 'sales' ? 'Giden (SatÄ±ÅŸ)' : 'Gelen (AlÄ±ÅŸ)');
}

function handleInvoiceExcelDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        processInvoiceFile(files[0]);
    }
}

// Dosya YÃ¼kleme Handler
function importInvoiceExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    processInvoiceFile(file);
}

async function processInvoiceFile(file) {
    if (!file) { alert("Dosya seÃ§ilmedi!"); return; }
    try {
        await saveImportedFileToStorage(file, "invoices");
        await loadInvoices(); // Import Ã¶ncesi gÃ¼ncel veri!
    } catch (err) {
        console.error("Fatura dosya kaydedilemedi:", err);
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            parseEInvoiceCSV(e.target.result); // Modal aÃ§ma parse fonksiyonu iÃ§inde zaten var!
        } catch (err) {
            console.error("Fatura dosya parse hatasÄ±:", err);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

// Dosya inputu resetlemek iÃ§in (drag-drop veya tekrar yÃ¼klemede)
function resetInvoiceExcelInput() {
    const input = document.getElementById('invoiceExcelFile');
    if (input) input.value = '';
}

function parseEInvoiceCSV(content) {
    console.log('ğŸ“Š E-Fatura CSV Parse baÅŸlÄ±yor...');

    // SatÄ±r sonlarÄ±nÄ± normalize et
    content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);

    console.log('Toplam satÄ±r:', lines.length);
    console.log('Ä°lk satÄ±r (header):', lines[0]);

    // Delimiter algÄ±la
    let delimiter = ';';
    if (lines[0].includes(',')) delimiter = ',';

    // Header kontrolÃ¼
    const header = lines[0].toLowerCase();
    if (!header.includes('fatura') || !header.includes('tutar')) {
        alert('âš ï¸ Bu dosya E-Fatura formatÄ±nda gÃ¶rÃ¼nmÃ¼yor!\n\nBeklenen sÃ¼tunlar: AlÄ±cÄ± AdÄ±, Fatura NumarasÄ±, Fatura Tarihi, Tutar');
        return;
    }

    parsedInvoices = [];

    // SatÄ±rlarÄ± parse et (Header'Ä± atla)
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        const parts = line.split(delimiter);
        console.log(`SatÄ±r ${i}:`, parts);

        if (parts.length < 7) {
            console.log(`âš ï¸ SatÄ±r ${i} atlandÄ±: Yeterli sÃ¼tun yok (${parts.length})`);
            continue;
        }

        const aliciAdi = parts[0]?.trim() || '';
        const faturaNo = parts[1]?.trim() || '';
        const faturaTarihi = parts[2]?.trim() || '';
        const olusturmaTarihi = parts[3]?.trim() || '';
        const senaryo = parts[4]?.trim() || '';
        const durum = parts[5]?.trim() || '';
        const tutarStr = parts[6]?.trim() || '';

        // Tutar parse (TÃ¼rkÃ§e format: 10737,6)
        const tutar = parseTurkishNumber(tutarStr);

        if (!aliciAdi || !faturaNo || !faturaTarihi || tutar === 0) {
            console.log(`âš ï¸ SatÄ±r ${i} atlandÄ±: Eksik veri`);
            continue;
        }

        const standardDate = parseEInvoiceDate(faturaTarihi);

        if (!standardDate) {
            console.log(`âš ï¸ SatÄ±r ${i} atlandÄ±: GeÃ§ersiz tarih formatÄ±`);
            continue;
        }

        // Cari hesap eÅŸleÅŸtirme
        const matchedAccount = findMatchingAccount(aliciAdi);

        parsedInvoices.push({
            aliciAdi: aliciAdi,
            faturaNo: faturaNo,
            faturaTarihi: standardDate,
            olusturmaTarihi: parseEInvoiceDate(olusturmaTarihi),
            senaryo: senaryo,
            durum: durum,
            tutar: tutar,
            matchedAccount: matchedAccount,
            confidence: matchedAccount ? calculateMatchConfidence(aliciAdi, matchedAccount) : 0
        });

        console.log(`âœ… Fatura ${i} parse edildi:`, parsedInvoices[parsedInvoices.length - 1]);
    }

    console.log(`\nğŸ“Š Toplam ${parsedInvoices.length} fatura baÅŸarÄ±yla okundu!`);

    if (parsedInvoices.length === 0) {
        alert('âŒ Dosyada geÃ§erli fatura bulunamadÄ±!');
        return;
    }

    // EÅŸleÅŸtirme modal'Ä±nÄ± aÃ§
    closeImportInvoiceModal();
    showInvoiceMatchModal();
}

function parseEInvoiceDate(dateStr) {
    // Format: 30.09.2025 veya 19.09.2025
    const match = dateStr.match(/(\d{1,2})\.(\d{1,2})\.(\d{4})/);
    
    if (match) {
        const day = match[1].padStart(2, '0');
        const month = match[2].padStart(2, '0');
        const year = match[3];
        return `${year}-${month}-${day}`;
    }
    
    return null;
}

function findMatchingAccount(companyName) {
    const companyAccounts = accounts.filter(a => a.companyId === activeCompanyId);
    
    if (companyAccounts.length === 0) return null;

    // Arama iÃ§in temizleme
    const cleanName = (name) => {
        return name.toUpperCase()
            .replace(/\s+/g, ' ') // Ã‡oklu boÅŸluklarÄ± tek boÅŸluÄŸa
            .replace(/\./g, '') // NoktalarÄ± kaldÄ±r
            .replace(/LTD\.?\s*ÅTÄ°\.?/gi, '')
            .replace(/LÄ°MÄ°TED\s*ÅÄ°RKETÄ°/gi, '')
            .replace(/A\.?\s*Å\.?/gi, '')
            .replace(/ANONÄ°M\s*ÅÄ°RKETÄ°/gi, '')
            .replace(/SANAYÄ°/gi, '')
            .replace(/SANAYÄ°Ä°/gi, '')
            .replace(/TÄ°CARET/gi, '')
            .replace(/VE/gi, '')
            .replace(/Ä°NÅAAT/gi, '')
            .replace(/PAZARLAMA/gi, '')
            .replace(/ÃœRETÄ°M/gi, '')
            .replace(/ÃœNVAN\s*:/gi, '')
            .trim();
    };

    const searchName = cleanName(companyName);
    console.log('ğŸ” Aranan firma (temizlenmiÅŸ):', searchName);

    // 1. TAM EÅLEÅME
    for (let account of companyAccounts) {
        const accountName = cleanName(account.name);
        
        if (accountName === searchName) {
            console.log(`âœ… TAM EÅLEÅME (100%): "${companyName}" â†’ "${account.name}"`);
            return account;
        }
    }

    // 2. TAM Ä°Ã‡ERME (Biri diÄŸerini tamamen iÃ§eriyor)
    for (let account of companyAccounts) {
        const accountName = cleanName(account.name);
        
        if (accountName.includes(searchName) || searchName.includes(accountName)) {
            console.log(`âœ… TAM Ä°Ã‡ERME (95%): "${companyName}" â†’ "${account.name}"`);
            return account;
        }
    }

    // 3. Ä°LK KELÄ°ME EÅLEÅME (Firma adÄ±nÄ±n ilk kelimesi benzersizse)
    const searchFirstWord = searchName.split(/\s+/)[0];
    if (searchFirstWord.length >= 4) {
        let matches = [];
        
        for (let account of companyAccounts) {
            const accountName = cleanName(account.name);
            const accountFirstWord = accountName.split(/\s+/)[0];
            
            if (searchFirstWord === accountFirstWord) {
                matches.push(account);
            }
        }
        
        // EÄŸer tek bir eÅŸleÅŸme varsa, gÃ¼venli
        if (matches.length === 1) {
            console.log(`âœ… Ä°LK KELÄ°ME EÅLEÅME (90%): "${companyName}" â†’ "${matches[0].name}"`);
            return matches[0];
        }
    }

    // 4. Ã‡OK KELÄ°MELÄ° EÅLEÅME (Ä°lk 3 kelimenin 2'si eÅŸleÅŸmeli)
    const searchWords = searchName.split(/\s+/).filter(w => w.length > 2).slice(0, 3);
    
    if (searchWords.length >= 2) {
        let bestMatch = null;
        let bestScore = 0;
        
        for (let account of companyAccounts) {
            const accountName = cleanName(account.name);
            let matchCount = 0;
            
            for (let word of searchWords) {
                if (accountName.includes(word)) {
                    matchCount++;
                }
            }
            
            const score = matchCount / searchWords.length;
            
            if (score >= 0.66 && score > bestScore) { // En az %66 eÅŸleÅŸme
                bestScore = score;
                bestMatch = account;
            }
        }
        
        if (bestMatch) {
            console.log(`âœ… Ã‡OK KELÄ°MELÄ° EÅLEÅME (${Math.round(bestScore * 100)}%): "${companyName}" â†’ "${bestMatch.name}"`);
            return bestMatch;
        }
    }

    // 5. FUZZY EÅLEÅME (En az 5 karakterlik kelimeler)
    const searchLongWords = searchName.split(/\s+/).filter(w => w.length >= 5);
    
    if (searchLongWords.length > 0) {
        for (let account of companyAccounts) {
            const accountName = cleanName(account.name);
            
            for (let word of searchLongWords) {
                if (accountName.includes(word)) {
                    console.log(`âš ï¸ FUZZY EÅLEÅME (70%): "${companyName}" â†’ "${account.name}" (Kelime: "${word}")`);
                    return account;
                }
            }
        }
    }

    console.log(`âŒ EÅLEÅME YOK: "${companyName}"`);
    return null;
}

function calculateMatchConfidence(companyName, account) {
    const cleanName = (name) => {
        return name.toUpperCase()
            .replace(/\s+/g, ' ')
            .replace(/\./g, '')
            .replace(/LTD\.?\s*ÅTÄ°\.?/gi, '')
            .replace(/LÄ°MÄ°TED\s*ÅÄ°RKETÄ°/gi, '')
            .replace(/A\.?\s*Å\.?/gi, '')
            .replace(/ANONÄ°M\s*ÅÄ°RKETÄ°/gi, '')
            .replace(/SANAYÄ°/gi, '')
            .replace(/TÄ°CARET/gi, '')
            .replace(/VE/gi, '')
            .trim();
    };

    const searchName = cleanName(companyName);
    const accountName = cleanName(account.name);
    
    // Tam eÅŸleÅŸme
    if (accountName === searchName) return 100;
    
    // Tam iÃ§erme
    if (accountName.includes(searchName) || searchName.includes(accountName)) return 95;
    
    // Ä°lk kelime eÅŸleÅŸmesi
    const searchFirstWord = searchName.split(/\s+/)[0];
    const accountFirstWord = accountName.split(/\s+/)[0];
    if (searchFirstWord === accountFirstWord && searchFirstWord.length >= 4) return 90;
    
    // Kelime eÅŸleÅŸme oranÄ±
    const searchWords = searchName.split(/\s+/).filter(w => w.length > 2);
    let matchCount = 0;
    
    for (let word of searchWords) {
        if (accountName.includes(word)) {
            matchCount++;
        }
    }
    
    if (searchWords.length > 0) {
        return Math.round((matchCount / searchWords.length) * 85);
    }
    
    return 50; // Fuzzy eÅŸleÅŸme
}

function showInvoiceMatchModal() {
    const typeText = currentInvoiceType === 'sales' ? 'Giden (SatÄ±ÅŸ)' : 'Gelen (AlÄ±ÅŸ)';
    document.getElementById('invoiceMatchTitle').textContent = `ğŸ”„ ${typeText} Fatura EÅŸleÅŸtirme`;
    
    // âœ… EÅLEÅME Ä°STATÄ°STÄ°KLERÄ°
    const totalCount = parsedInvoices.length;
    const matchedCount = parsedInvoices.filter(inv => inv.matchedAccount).length;
    const unmatchedCount = totalCount - matchedCount;
    const matchPercentage = Math.round((matchedCount / totalCount) * 100);

    document.getElementById('matchedInvoiceCount').textContent = totalCount;
    document.getElementById('saveInvoiceCount').textContent = totalCount;

    // Ã–zet bilgiyi gÃ¼ncelle
    const summaryHtml = `
        <strong>âœ… ${totalCount} fatura baÅŸarÄ±yla okundu!</strong><br>
        <div style="margin-top: 10px; display: flex; gap: 20px; font-size: 0.95em;">
            <span style="color: var(--success);">âœ… ${matchedCount} otomatik eÅŸleÅŸti (%${matchPercentage})</span>
            ${unmatchedCount > 0 ? `<span style="color: var(--warning);">âš ï¸ ${unmatchedCount} manuel seÃ§im gerekli</span>` : ''}
        </div>
    `;
    document.getElementById('invoiceMatchSummary').innerHTML = summaryHtml;

    const matchList = document.getElementById('invoiceMatchList');
    matchList.innerHTML = '';

    parsedInvoices.forEach((invoice, index) => {
        // âœ… OTOMATIK VADE TARÄ°HÄ° HESAPLA (Fatura tarihinden 7 gÃ¼n sonra)
        const invoiceDate = new Date(invoice.faturaTarihi);
        const dueDate = new Date(invoiceDate);
        dueDate.setDate(dueDate.getDate() + 7);
        const dueDateStr = dueDate.toISOString().split('T')[0]; // YYYY-MM-DD format

        const card = document.createElement('div');
        card.style.cssText = `
            border: 2px solid ${invoice.matchedAccount ? '#10b981' : '#f59e0b'};
            background: ${invoice.matchedAccount ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' : 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)'};
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        `;

        const confidenceBadge = invoice.matchedAccount 
            ? `<span class="badge badge-${invoice.confidence >= 90 ? 'success' : invoice.confidence >= 70 ? 'warning' : 'danger'}" style="font-size: 0.9em;">
                ${invoice.confidence}% EÅŸleÅŸme
               </span>`
            : '<span class="badge badge-danger" style="font-size: 0.9em;">Manuel SeÃ§im Gerekli</span>';

        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <strong style="font-size: 1.2em; color: var(--primary);">${invoice.faturaNo}</strong>
                        <span class="badge badge-info">${invoice.durum}</span>
                        ${confidenceBadge}
                    </div>
                    <div style="font-size: 0.95em; color: #1f2937; margin-bottom: 5px;">
                        <strong>ğŸ“… Fatura Tarihi:</strong> ${formatDate(invoice.faturaTarihi)}
                        <span style="margin-left: 15px; color: var(--warning);"><strong>â° Vade:</strong> ${formatDate(dueDateStr)}</span>
                    </div>
                    <div style="font-size: 0.95em; color: #1f2937; margin-bottom: 5px;">
                        <strong>ğŸ¢ Firma (E-Fatura):</strong> ${invoice.aliciAdi}
                    </div>
                    ${invoice.matchedAccount ? `
                        <div style="font-size: 0.9em; color: var(--success); margin-top: 8px; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
                            âœ… <strong>Otomatik EÅŸleÅŸti:</strong> ${invoice.matchedAccount.name}
                        </div>
                    ` : `
                        <div style="font-size: 0.9em; color: var(--danger); margin-top: 8px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px;">
                            âš ï¸ Cari hesap bulunamadÄ± - LÃ¼tfen manuel seÃ§in
                        </div>
                    `}
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 2em; font-weight: 700; color: ${currentInvoiceType === 'sales' ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 5px;">
                        ${formatCurrency(invoice.tutar)}
                    </div>
                    <div style="font-size: 0.85em; color: #6b7280;">KDV Dahil</div>
                </div>
            </div>

            <div class="grid-2" style="margin-top: 15px;">
                <div class="form-group" style="margin: 0;">
                    <label>Cari Hesap ${invoice.matchedAccount ? '(âœ… Otomatik EÅŸleÅŸti)' : '(âš ï¸ Manuel SeÃ§in)'}</label>
                    <select id="invoiceAccount_${index}" style="font-weight: ${invoice.matchedAccount ? '600' : 'normal'}; background: white; border-color: ${invoice.matchedAccount ? 'var(--success)' : 'var(--danger)'};">
                        <option value="">Cari Hesap SeÃ§in</option>
                        ${accounts.filter(a => a.companyId === activeCompanyId).map(a => 
                            `<option value="${a.id}" ${invoice.matchedAccount && invoice.matchedAccount.id === a.id ? 'selected' : ''}>
                                ${a.name} (${a.type === 'customer' ? 'MÃ¼ÅŸteri' : 'TedarikÃ§i'})
                            </option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label>â° Vade Tarihi (Otomatik: +7 gÃ¼n)</label>
                    <input type="date" id="invoiceDueDate_${index}" value="${dueDateStr}" style="background: white;">
                </div>
            </div>

            <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
                <label>AÃ§Ä±klama/Notlar (Opsiyonel)</label>
                <textarea id="invoiceDescription_${index}" rows="2" placeholder="Fatura ile ilgili notlar..." style="background: white;"></textarea>
            </div>
        `;

        matchList.appendChild(card);
    });

    document.getElementById('invoiceMatchModal').classList.add('active');
}

function closeInvoiceMatchModal() {
    document.getElementById('invoiceMatchModal').classList.remove('active');
    parsedInvoices = [];
}

// ===============================
// CSV'den fatura import iÅŸlemi
// ===============================
async function saveAllInvoices(importedInvoices) {
    if (!importedInvoices || importedInvoices.length === 0) {
        alert('âŒ Kaydedilecek fatura yok!');
        return;
    }
    if (!activeCompanyId) {
        alert('âŒ LÃ¼tfen bir firma seÃ§in!');
        return;
    }
    if (!auth.currentUser) {
        alert('âŒ LÃ¼tfen giriÅŸ yapÄ±n!');
        return;
    }

    // Mevcut fatura unique key dizisini oluÅŸtur
    const existingKeys = invoices.map(getInvoiceUniqueKey);
    const filteredInvoices = [];
    let skippedCount = 0;

    importedInvoices.forEach(inv => {
        const invKey = getInvoiceUniqueKey(inv);
        if (existingKeys.includes(invKey)) {
            skippedCount++;
        } else {
            filteredInvoices.push(inv);
            existingKeys.push(invKey);
        }
    });

    if (filteredInvoices.length === 0) {
        alert(`âš ï¸ TÃ¼m faturalar zaten kayÄ±tlÄ±, yeni fatura eklenmedi.`);
        return;
    }

    // Firebase batch ile ekle
    const batch = db.batch();
    const now = new Date().toISOString();
    filteredInvoices.forEach(inv => {
        const invoiceRef = db.collection('companies').doc(activeCompanyId)
            .collection('invoices').doc();
        const invoiceData = {
            id: invoiceRef.id,
            invoiceNo: inv.invoiceNo,
            companyId: activeCompanyId,
            accountId: inv.accountId,
            date: inv.date,
            total: inv.total,
            type: inv.type || 'sales',
            status: 'unpaid',
            description: inv.description || '',
            createdAt: now,
            createdBy: auth.currentUser.uid
        };
        batch.set(invoiceRef, invoiceData);
        invoices.push(invoiceData);
    });

    await batch.commit();
    await loadInvoices();
    await loadAccounts();
    updateDashboard();

    alert(`âœ… ${filteredInvoices.length} yeni fatura eklendi\nâš ï¸ ${skippedCount} fatura zaten vardÄ±, atlandÄ±!`);
}

function scrollToInvoiceForm() {
    document.getElementById('invoiceFormCard').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
    });
    
    // Formu vurgula (1 saniye)
    const formCard = document.getElementById('invoiceFormCard');
    const originalBorder = formCard.style.border;
    formCard.style.border = '3px solid var(--primary)';
    formCard.style.boxShadow = '0 0 20px rgba(37, 99, 235, 0.4)';
    
    setTimeout(() => {
        formCard.style.border = originalBorder;
        formCard.style.boxShadow = '';
    }, 1500);
}

// ========================================
// PURCHASES (ALIÅLAR) FONKSÄ°YONLARI
// ========================================

function calculatePurchaseTotal() {
    const amount = parseFloat(document.getElementById('purchaseAmount').value) || 0;
    const vatRate = parseFloat(document.getElementById('purchaseVATRate').value) || 0;
    
    const vatAmount = amount * (vatRate / 100);
    const total = amount + vatAmount;
    
    document.getElementById('purchaseVATAmount').value = vatAmount.toFixed(2);
    document.getElementById('purchaseTotalDisplay').textContent = formatCurrency(total);
}

function handlePurchaseReceipt(input) {
    const file = input.files[0];
    if (!file) {
        currentPurchaseReceipt = null;
        document.getElementById('purchaseReceiptPreview').innerHTML = '';
        return;
    }
    
    // Boyut kontrolÃ¼ (5 MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('âš ï¸ FiÅŸ boyutu 5 MB\'dan kÃ¼Ã§Ã¼k olmalÄ±dÄ±r!');
        input.value = '';
        return;
    }
    
    // âœ… ArtÄ±k dosyayÄ± direkt saklÄ±yoruz (Base64'e Ã§evirmeye gerek yok)
    currentPurchaseReceipt = file;
    
    // Ã–nizleme
    const preview = document.getElementById('purchaseReceiptPreview');
    
    if (file.type.includes('image')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <div style="border: 2px solid var(--success); padding: 10px; border-radius: 8px; background: white;">
                    <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        ğŸ“„ ${file.name} (${formatFileSize(file.size)})
                    </p>
                    <button type="button" onclick="clearPurchaseReceipt()" class="btn btn-danger btn-sm" style="margin-top:5px;">âœ– KaldÄ±r</button>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = `
            <div style="border: 2px solid var(--success); padding: 15px; border-radius: 8px; background: white; text-align:center;">
                <div style="font-size: 3em;">ğŸ“„</div>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                    ${file.name} (${formatFileSize(file.size)})
                </p>
                <button type="button" onclick="clearPurchaseReceipt()" class="btn btn-danger btn-sm" style="margin-top:5px;">âœ– KaldÄ±r</button>
            </div>
        `;
    }
}

function clearPurchaseReceipt() {
    currentPurchaseReceipt = null;
    document.getElementById('purchaseReceipt').value = '';
    document.getElementById('purchaseReceiptPreview').innerHTML = '';
}

async function savePurchase(e) {
    e.preventDefault();
    
    if (!activeCompanyId) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce bir firma seÃ§in!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    const purchaseId = document.getElementById('purchaseId').value;
    const now = new Date().toISOString();
    
    const amount = parseFloat(document.getElementById('purchaseAmount').value);
    const vatRate = parseFloat(document.getElementById('purchaseVATRate').value);
    const vatAmount = amount * (vatRate / 100);
    const total = amount + vatAmount;
    
    try {
        let receiptUrl = null;
        
        // EÄŸer yeni fiÅŸ yÃ¼klendiyse Storage'a yÃ¼kle
        if (currentPurchaseReceipt && currentPurchaseReceipt instanceof File) {
            const tempId = purchaseId || Date.now().toString();
            const fileName = `${Date.now()}_${currentPurchaseReceipt.name}`;
            const storageRef = storage.ref(`companies/${activeCompanyId}/purchases/${tempId}/${fileName}`);
            
            const snapshot = await storageRef.put(currentPurchaseReceipt);
            receiptUrl = await snapshot.ref.getDownloadURL();
            
            console.log('âœ… AlÄ±ÅŸ fiÅŸi yÃ¼klendi:', receiptUrl);
        }
        
        let purchaseData;
        
        if (purchaseId) {
            // Update existing
            const purchase = purchases.find(p => p.id === purchaseId);
            
            const updatedData = {
                date: document.getElementById('purchaseDate').value,
                category: document.getElementById('purchaseCategory').value,
                description: document.getElementById('purchaseDescription').value,
                supplier: document.getElementById('purchaseSupplier').value,
                amount: amount,
                vatRate: vatRate,
                vatAmount: vatAmount,
                total: total,
                paymentMethod: document.getElementById('purchasePaymentMethod').value,
                receiptUrl: receiptUrl || purchase.receiptUrl,
                updatedAt: now,
                updatedBy: auth.currentUser.uid
            };
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('purchases').doc(purchaseId).update(updatedData);
            
            Object.assign(purchase, updatedData);
            purchaseData = purchase;
            
        } else {
            // Create new
            const newPurchaseRef = db.collection('companies').doc(activeCompanyId)
                .collection('purchases').doc();
            const newPurchaseId = newPurchaseRef.id;
            
            const newPurchase = {
                id: newPurchaseId,
                companyId: activeCompanyId,
                date: document.getElementById('purchaseDate').value,
                category: document.getElementById('purchaseCategory').value,
                description: document.getElementById('purchaseDescription').value,
                supplier: document.getElementById('purchaseSupplier').value || '',
                amount: amount,
                vatRate: vatRate,
                vatAmount: vatAmount,
                total: total,
                paymentMethod: document.getElementById('purchasePaymentMethod').value,
                receiptUrl: receiptUrl,
                createdAt: now,
                createdBy: auth.currentUser.uid
            };
            
            await newPurchaseRef.set(newPurchase);
            
            purchases.push(newPurchase);
            purchaseData = newPurchase;
        }
        
        document.getElementById('purchaseForm').reset();
        document.getElementById('purchaseId').value = '';
        document.getElementById('purchaseDate').valueAsDate = new Date();
        currentPurchaseReceipt = null;
        document.getElementById('purchaseReceiptPreview').innerHTML = '';
        cancelPurchaseEdit();
        
        await loadPurchases();
        updateDashboard();
        
        alert('âœ… AlÄ±ÅŸ baÅŸarÄ±yla kaydedildi!');
        
    } catch (error) {
        console.error('AlÄ±ÅŸ kayÄ±t hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

async function loadPurchases() {
    if (!activeCompanyId || !auth.currentUser) {
        purchases = [];
        renderPurchasesTable();
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('purchases').orderBy('date', 'desc').get();
        
        purchases = [];
        snapshot.forEach(doc => {
            purchases.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('âœ… AlÄ±ÅŸlar yÃ¼klendi:', purchases.length);
        
    } catch (error) {
        console.error('âŒ AlÄ±ÅŸ yÃ¼kleme hatasÄ±:', error);
        purchases = [];
    }
    
    renderPurchasesTable();
}

function updatePurchaseStats(purchaseList) {
    const totalAmount = purchaseList.reduce((sum, p) => sum + p.total, 0);
    const subtotal = purchaseList.reduce((sum, p) => sum + p.amount, 0);
    const totalVAT = purchaseList.reduce((sum, p) => sum + p.vatAmount, 0);
    const average = purchaseList.length > 0 ? totalAmount / purchaseList.length : 0;
    
    document.getElementById('purchasesTotalAmount').textContent = formatCurrency(totalAmount);
    document.getElementById('purchasesCount').textContent = `${purchaseList.length} kayÄ±t`;
    document.getElementById('purchasesSubtotal').textContent = formatCurrency(subtotal);
    document.getElementById('purchasesTotalVAT').textContent = formatCurrency(totalVAT);
    document.getElementById('purchasesAverage').textContent = formatCurrency(average);
}

function editPurchase(id) {
    const purchase = purchases.find(p => p.id === id);
    if (!purchase) return;
    
    document.getElementById('purchaseId').value = purchase.id;
    document.getElementById('purchaseDate').value = purchase.date;
    document.getElementById('purchaseCategory').value = purchase.category;
    document.getElementById('purchaseDescription').value = purchase.description;
    document.getElementById('purchaseSupplier').value = purchase.supplier || '';
    document.getElementById('purchaseAmount').value = purchase.amount;
    document.getElementById('purchaseVATRate').value = purchase.vatRate;
    document.getElementById('purchasePaymentMethod').value = purchase.paymentMethod;
    
    // âœ… Mevcut fiÅŸi gÃ¶ster (URL veya Base64)
    const preview = document.getElementById('purchaseReceiptPreview');
    
    if (purchase.receiptUrl) {
        // Yeni sistem: Firebase Storage URL
        const isPDF = purchase.receiptUrl.toLowerCase().includes('.pdf');
        
        if (isPDF) {
            preview.innerHTML = `
                <div style="border: 2px solid var(--info); padding: 15px; border-radius: 8px; background: white; text-align:center;">
                    <div style="font-size: 3em;">ğŸ“„</div>
                    <p style="margin: 10px 0; font-size: 0.9em; color: #6b7280;">Mevcut PDF FiÅŸ</p>
                    <button type="button" onclick="viewPurchaseReceipt('${purchase.id}')" class="btn btn-sm">ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼le</button>
                    <p style="margin-top:10px; font-size:0.85em; color:#6b7280;">Yeni fiÅŸ yÃ¼klerseniz eski fiÅŸ silinir.</p>
                </div>
            `;
        } else {
            preview.innerHTML = `
                <div style="border: 2px solid var(--info); padding: 10px; border-radius: 8px; background: white;">
                    <img src="${purchase.receiptUrl}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">Mevcut FiÅŸ</p>
                    <p style="margin-top:5px; font-size:0.85em; color:#6b7280;">Yeni fiÅŸ yÃ¼klerseniz eski fiÅŸ silinir.</p>
                </div>
            `;
        }
        
        // Not: Eski fiÅŸi sakla (deÄŸiÅŸtirmezse aynÄ± kalacak)
        currentPurchaseReceipt = null;
        
    } else if (purchase.receipt && purchase.receipt.file) {
        // Eski sistem: Base64
        if (purchase.receipt.fileType.includes('image')) {
            preview.innerHTML = `
                <div style="border: 2px solid var(--warning); padding: 10px; border-radius: 8px; background: white;">
                    <img src="${purchase.receipt.file}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        ğŸ“„ ${purchase.receipt.fileName} (${formatFileSize(purchase.receipt.fileSize)})
                    </p>
                    <p style="margin-top:5px; font-size:0.85em; color:#f59e0b;">âš ï¸ Eski format (Base64)</p>
                </div>
            `;
        }
        currentPurchaseReceipt = null;
    } else {
        preview.innerHTML = '<p style="color:#6b7280;">FiÅŸ yok</p>';
        currentPurchaseReceipt = null;
    }
    
    calculatePurchaseTotal();
    
    document.getElementById('savePurchaseBtn').textContent = 'ğŸ’¾ GÃ¼ncelle';
    document.getElementById('cancelPurchaseBtn').style.display = 'inline-block';
    
    scrollToPurchaseForm();
}

async function deletePurchase(id) {
    if (!confirm('Bu alÄ±ÅŸ kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?')) return;
    
    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    try {
        await db.collection('companies').doc(activeCompanyId)
            .collection('purchases').doc(id).delete();
        
        purchases = purchases.filter(p => p.id !== id);
        
        await loadPurchases();
        updateDashboard();
        
        alert('âœ… AlÄ±ÅŸ kaydÄ± silindi!');
        
    } catch (error) {
        console.error('AlÄ±ÅŸ silme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

function cancelPurchaseEdit() {
    document.getElementById('purchaseForm').reset();
    document.getElementById('purchaseId').value = '';
    document.getElementById('purchaseDate').valueAsDate = new Date();
    document.getElementById('savePurchaseBtn').textContent = 'ğŸ’¾ AlÄ±ÅŸÄ± Kaydet';
    document.getElementById('cancelPurchaseBtn').style.display = 'none';
    currentPurchaseReceipt = null;
    document.getElementById('purchaseReceiptPreview').innerHTML = '';
    calculatePurchaseTotal();
}

function scrollToPurchaseForm() {
    document.getElementById('purchaseFormCard').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
    });
    
    const formCard = document.getElementById('purchaseFormCard');
    const originalBorder = formCard.style.border;
    formCard.style.border = '3px solid var(--primary)';
    formCard.style.boxShadow = '0 0 20px rgba(37, 99, 235, 0.4)';
    
    setTimeout(() => {
        formCard.style.border = originalBorder;
        formCard.style.boxShadow = '';
    }, 1500);
}

function filterPurchases() {
    const startDate = document.getElementById('filterPurchaseStartDate').value;
    const endDate = document.getElementById('filterPurchaseEndDate').value;
    const category = document.getElementById('filterPurchaseCategory').value;
    const paymentMethod = document.getElementById('filterPurchasePayment').value;
    
    let filtered = purchases.filter(p => !activeCompanyId || p.companyId === activeCompanyId);
    
    if (startDate) filtered = filtered.filter(p => p.date >= startDate);
    if (endDate) filtered = filtered.filter(p => p.date <= endDate);
    if (category) filtered = filtered.filter(p => p.category === category);
    if (paymentMethod) filtered = filtered.filter(p => p.paymentMethod === paymentMethod);
    
    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const tbody = document.querySelector('#purchasesTable tbody');
    tbody.innerHTML = '';
    
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px;">SonuÃ§ bulunamadÄ±.</td></tr>';
        updatePurchaseStats([]);
        return;
    }
    
    filtered.forEach(purchase => {
        const paymentMethodText = {
            'cash': 'ğŸ’µ Nakit',
            'card': 'ğŸ’³ Kart',
            'transfer': 'ğŸ¦ Havale'
        }[purchase.paymentMethod] || purchase.paymentMethod;
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${formatDate(purchase.date)}</td>
            <td><span class="badge badge-info">${purchase.category}</span></td>
            <td><strong>${purchase.description}</strong></td>
            <td>${purchase.supplier || '-'}</td>
            <td>${formatCurrency(purchase.amount)}</td>
            <td>${formatCurrency(purchase.vatAmount)} <small>(%${purchase.vatRate})</small></td>
            <td style="font-weight: 700; color: var(--danger);">${formatCurrency(purchase.total)}</td>
            <td>${paymentMethodText}</td>
            <td>
                ${purchase.receipt ? `
                    <button class="btn btn-info btn-sm" onclick="viewPurchaseReceipt('${purchase.id}')">ğŸ“„</button>
                ` : '<span style="color:#6b7280;">-</span>'}
            </td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editPurchase('${purchase.id}')">âœï¸</button>
                <button class="btn btn-danger btn-sm" onclick="deletePurchase('${purchase.id}')">ğŸ—‘ï¸</button>
            </td>
        `;
    });
    
    updatePurchaseStats(filtered);
}

function clearPurchaseFilters() {
    document.getElementById('filterPurchaseStartDate').value = '';
    document.getElementById('filterPurchaseEndDate').value = '';
    document.getElementById('filterPurchaseCategory').value = '';
    document.getElementById('filterPurchasePayment').value = '';
    loadPurchases();
}

function viewPurchaseReceipt(id) {
    const purchase = purchases.find(p => p.id === id);
    
    if (!purchase) {
        alert('âš ï¸ AlÄ±ÅŸ kaydÄ± bulunamadÄ±!');
        return;
    }
    
    // âœ… Ã–nce yeni sistem (receiptUrl), yoksa eski sistem (receipt.file)
    let receiptSource = null;
    let isPDF = false;
    
    if (purchase.receiptUrl) {
        // Yeni sistem: Firebase Storage URL
        receiptSource = purchase.receiptUrl;
        isPDF = purchase.receiptUrl.toLowerCase().includes('.pdf');
    } else if (purchase.receipt && purchase.receipt.file) {
        // Eski sistem: Base64
        receiptSource = purchase.receipt.file;
        isPDF = purchase.receipt.fileType && purchase.receipt.fileType.includes('pdf');
    } else {
        alert('âš ï¸ Bu alÄ±ÅŸa ait fiÅŸ yok!');
        return;
    }
    
    document.getElementById('documentViewerTitle').textContent = `ğŸ“„ FiÅŸ - ${purchase.description}`;
    
    const content = document.getElementById('documentViewerContent');
    content.innerHTML = '';
    
    if (isPDF) {
        const iframe = document.createElement('iframe');
        iframe.src = receiptSource;
        iframe.style.width = '100%';
        iframe.style.height = '600px';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        content.appendChild(iframe);
    } else {
        const img = document.createElement('img');
        img.src = receiptSource;
        img.style.maxWidth = '100%';
        img.style.borderRadius = '8px';
        img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        content.appendChild(img);
        
        // Ä°ndirme butonu ekle
        const downloadBtn = document.createElement('a');
        downloadBtn.href = receiptSource;
        downloadBtn.download = `fis_${purchase.id}.jpg`;
        downloadBtn.target = '_blank';
        downloadBtn.className = 'btn btn-primary';
        downloadBtn.style.marginTop = '20px';
        downloadBtn.innerHTML = 'ğŸ“¥ Ä°ndir';
        content.appendChild(downloadBtn);
    }
    
    currentDocumentData = { file: receiptSource, fileName: purchase.description };
    document.getElementById('documentViewerModal').classList.add('active');
}

// ========================================
// ALIÅ EXCEL Ä°MPORT FONKSÄ°YONLARI
// ========================================

// ========================================
// ALIÅ EXCEL Ä°MPORT SÄ°STEMÄ°
// ========================================

function openImportPurchasesModal() {
    if (!activeCompanyId) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce bir firma seÃ§in!');
        return;
    }
    
    const modalHtml = `
        <div class="modal active" id="purchasesImportModal" style="display: flex;">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3>ğŸ“¤ AlÄ±ÅŸ Listesi Ä°Ã§e Aktar (Excel/CSV)</h3>
                    <button class="close-modal" onclick="closePurchasesImportModal()">âœ–</button>
                </div>
                
                <div style="padding: 30px;">
                    <!-- Ã–rnek Format -->
                    <div class="alert alert-info">
                        <strong>ğŸ“‹ Excel/CSV FormatÄ±</strong>
                        <p style="margin: 10px 0 5px 0; font-size: 0.95em;">
                            AÅŸaÄŸÄ±daki sÃ¼tun sÄ±rasÄ±nÄ± kullanÄ±n (baÅŸlÄ±k satÄ±rÄ± olmalÄ±):
                        </p>
                    </div>
                    
                    <div style="overflow-x: auto; margin-bottom: 20px;">
                        <table style="font-size: 0.85em; width: 100%; border: 2px solid var(--primary);">
                            <thead style="background: var(--primary); color: white;">
                                <tr>
                                    <th>Tarih</th>
                                    <th>Kategori</th>
                                    <th>AÃ§Ä±klama</th>
                                    <th>TedarikÃ§i</th>
                                    <th>Tutar</th>
                                    <th>KDV%</th>
                                    <th>Ã–deme</th>
                                </tr>
                            </thead>
                            <tbody style="background: white;">
                                <tr>
                                    <td>2025-01-15</td>
                                    <td>KÄ±rtasiye</td>
                                    <td>A4 KaÄŸÄ±t</td>
                                    <td>Migros</td>
                                    <td>250.00</td>
                                    <td>20</td>
                                    <td>Nakit</td>
                                </tr>
                                <tr>
                                    <td>2025-01-16</td>
                                    <td>YakÄ±t</td>
                                    <td>Motorin 50L</td>
                                    <td>Shell</td>
                                    <td>1850.50</td>
                                    <td>20</td>
                                    <td>Kart</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Kategoriler Rehberi -->
                    <div class="card" style="background: #f9fafb; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">ğŸ·ï¸ KullanÄ±labilir Kategoriler</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 0.9em;">
                            <div>ğŸ“ KÄ±rtasiye</div>
                            <div>â›½ YakÄ±t</div>
                            <div>ğŸ½ï¸ Yemek</div>
                            <div>ğŸ§¹ Temizlik</div>
                            <div>ğŸ“¦ Kargo</div>
                            <div>ğŸ’¡ Elektrik</div>
                            <div>ğŸ’§ Su</div>
                            <div>ğŸŒ Ä°nternet</div>
                            <div>ğŸ“± Telefon</div>
                            <div>ğŸ”§ BakÄ±m-OnarÄ±m</div>
                            <div>ğŸš— UlaÅŸÄ±m</div>
                            <div>ğŸ“‹ DiÄŸer</div>
                        </div>
                    </div>

                    <!-- Ã–deme YÃ¶ntemleri -->
                    <div class="card" style="background: #f9fafb; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">ğŸ’³ Ã–deme YÃ¶ntemleri</h4>
                        <div style="display: flex; gap: 20px; font-size: 0.9em;">
                            <div>ğŸ’µ <strong>Nakit</strong></div>
                            <div>ğŸ’³ <strong>Kart</strong></div>
                            <div>ğŸ¦ <strong>Havale</strong></div>
                        </div>
                    </div>

                    <!-- Dosya YÃ¼kleme -->
                    <div class="file-upload-area" 
                         onclick="document.getElementById('purchasesExcelFile').click()" 
                         style="cursor: pointer; margin-bottom: 20px;">
                        <h3>ğŸ“‚ CSV/Excel DosyasÄ±nÄ± YÃ¼kle</h3>
                        <p style="margin: 10px 0; color: #6b7280;">DosyanÄ±zÄ± sÃ¼rÃ¼kleyin veya tÄ±klayÄ±n</p>
                        <p style="font-size: 0.9em; color: #9ca3af;">Desteklenen format: .csv</p>
                        <input type="file" 
                               id="purchasesExcelFile" 
                               accept=".csv" 
                               style="display:none;" 
                               onchange="processPurchasesExcel(event)">
                    </div>

                    <!-- Ã–rnek Dosya Ä°ndir -->
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="downloadPurchaseTemplate()">
                            ğŸ“¥ Ã–rnek CSV Åablonunu Ä°ndir
                        </button>
                        <button class="btn btn-secondary" onclick="closePurchasesImportModal()">
                            âœ–ï¸ Ä°ptal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Modal'Ä± sayfaya ekle
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closePurchasesImportModal() {
    const modal = document.getElementById('purchasesImportModal');
    if (modal) {
        modal.remove();
    }
}

function downloadPurchaseTemplate() {
    const csv = `Tarih,Kategori,AÃ§Ä±klama,TedarikÃ§i,Tutar,KDV%,Ã–deme
2025-01-15,KÄ±rtasiye,A4 KaÄŸÄ±t 5 paket,Migros,250.00,20,Nakit
2025-01-16,YakÄ±t,Motorin 50L,Shell,1850.50,20,Kart
2025-01-17,Yemek,Personel yemeÄŸi,Yemek Sepeti,450.00,10,Kart
2025-01-18,Elektrik,Ocak faturasÄ±,BEDAÅ,980.00,20,Havale
2025-01-19,Temizlik,Temizlik malzemesi,BÄ°M,125.75,20,Nakit
2025-01-20,Kargo,Kargo Ã¶demesi,MNG,85.00,20,Kart`;
    
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `alislar-sablonu-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    
    alert('âœ… Ã–rnek CSV ÅŸablonu indirildi!\n\nDosyayÄ± aÃ§Ä±p dÃ¼zenleyebilir, ardÄ±ndan tekrar yÃ¼kleyebilirsiniz.');
}

async function processPurchasesExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    try {
        await saveImportedFileToStorage(file, "purchases");
    } catch (err) {
        console.error("AlÄ±ÅŸ dosya kaydedilemedi:", err);
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            parsePurchasesCSV(e.target.result);
        } catch (err) {
            console.error("AlÄ±ÅŸ dosya parse hatasÄ±:", err);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

function parsePurchasesCSV(content) {
    const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);

    // NoktalÄ± virgÃ¼l veya virgÃ¼l ayraÃ§ desteÄŸi!
    // Otomatik algÄ±la: ilk satÄ±rda ";" varsa split(";"), yoksa split(",")
    const delimiter = lines[0].includes(';') ? ';' : ',';

    // BaÅŸlÄ±k kontrolÃ¼ (dilersen delimiter ile split ederek de kontrol edebilirsin)
    const header = lines[0].toLowerCase();
    if (!header.includes('tarih') || !header.includes('kategori') || !header.includes('aÃ§Ä±klama')) {
        alert('âš ï¸ CSV baÅŸlÄ±k satÄ±rÄ± hatalÄ±!');
        return;
    }

    let importedPurchases = [];
    let errorCount = 0;

    for (let i = 1; i < lines.length; i++) {
        // SatÄ±rÄ± sÃ¼tunlara bÃ¶l
        const parts = lines[i].split(delimiter);
        if (parts.length < 7) { // SÃ¼tun sayÄ±sÄ± kontrolÃ¼
            errorCount++;
            continue;
        }

        // SÃ¼tunlar: Tarih;Kategori;AÃ§Ä±klama;TedarikÃ§i;Tutar;KDV%;Ã–deme
        const tarih = parts[0].trim();
        const kategori = parts[1].trim();
        const aciklama = parts[2].trim();
        const tedarikci = parts[3].trim();
        const tutar = parseFloat(parts[4].replace(',', '.'));
        const kdvOrani = parseFloat(parts[5].replace(',', '.'));
        const odeme = parts[6].trim();

        // Validasyon
        if (!tarih || !kategori || !aciklama || isNaN(tutar) || isNaN(kdvOrani)) {
            errorCount++;
            continue;
        }

        // KDV ve toplam otomatik hesaplanÄ±r
        const kdvTutari = tutar * (kdvOrani / 100);
        const toplamTutar = tutar + kdvTutari;

        // Ã–deme tÃ¼rÃ¼
        let paymentMethod = 'cash';
        const odemeUpper = odeme.toUpperCase();
        if (odemeUpper.includes('KART')) paymentMethod = 'card';
        else if (odemeUpper.includes('HAVALE') || odemeUpper.includes('EFT') || odemeUpper.includes('TRANSFER')) paymentMethod = 'transfer';

        importedPurchases.push({
            date: tarih,
            category: kategori,
            description: aciklama,
            supplier: tedarikci,
            amount: tutar,
            vatRate: kdvOrani,
            vatAmount: kdvTutari,
            total: toplamTutar,
            paymentMethod: paymentMethod
        });
    }

    showPurchasesConfirmModal(importedPurchases, errorCount);
}

function showPurchasesConfirmModal(importedPurchases, errorCount) {
    closePurchasesImportModal();
    
    const totalAmount = importedPurchases.reduce((sum, p) => sum + p.total, 0);
    const totalVAT = importedPurchases.reduce((sum, p) => sum + p.vatAmount, 0);
    
    const summaryHtml = errorCount > 0 
        ? `<div class="alert alert-warning">
            <strong>âš ï¸ ${errorCount} satÄ±r hatalÄ± olduÄŸu iÃ§in atlandÄ±!</strong>
           </div>`
        : '';
    
    const modalHtml = `
        <div class="modal active" id="purchasesConfirmModal" style="display: flex;">
            <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h3>âœ… AlÄ±ÅŸlarÄ± OnaylayÄ±n (${importedPurchases.length} KayÄ±t)</h3>
                    <button class="close-modal" onclick="closePurchasesConfirmModal()">âœ–</button>
                </div>
                
                <div style="padding: 20px;">
                    ${summaryHtml}
                    
                    <div class="alert alert-success">
                        <strong>ğŸ“Š Ã–zet Ä°statistikler</strong>
                        <div style="margin-top: 10px; display: flex; gap: 30px; font-size: 1.1em;">
                            <span>ğŸ’° Toplam Harcama: <strong>${formatCurrency(totalAmount)}</strong></span>
                            <span>ğŸ“‹ KDV ToplamÄ±: <strong>${formatCurrency(totalVAT)}</strong></span>
                            <span>ğŸ“ KayÄ±t SayÄ±sÄ±: <strong>${importedPurchases.length}</strong></span>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Kategori</th>
                                    <th>AÃ§Ä±klama</th>
                                    <th>TedarikÃ§i</th>
                                    <th>KDV HariÃ§</th>
                                    <th>KDV</th>
                                    <th>Toplam</th>
                                    <th>Ã–deme</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${importedPurchases.map((p, index) => {
                                    const paymentIcon = {
                                        'cash': 'ğŸ’µ Nakit',
                                        'card': 'ğŸ’³ Kart',
                                        'transfer': 'ğŸ¦ Havale'
                                    }[p.paymentMethod];
                                    
                                    return `
                                        <tr style="background: ${index % 2 === 0 ? 'white' : '#f9fafb'};">
                                            <td>${formatDate(p.date)}</td>
                                            <td><span class="badge badge-info">${p.category}</span></td>
                                            <td><strong>${p.description}</strong></td>
                                            <td>${p.supplier || '-'}</td>
                                            <td>${formatCurrency(p.amount)}</td>
                                            <td>${formatCurrency(p.vatAmount)} <small>(%${p.vatRate})</small></td>
                                            <td style="font-weight: 700; color: var(--danger);">${formatCurrency(p.total)}</td>
                                            <td>${paymentIcon}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                        <button class="btn btn-secondary" onclick="closePurchasesConfirmModal()">
                            âœ–ï¸ Ä°ptal
                        </button>
                        <button class="btn btn-success" onclick="saveImportedPurchases()" style="font-size: 16px; padding: 12px 30px;">
                            ğŸ’¾ ${importedPurchases.length} AlÄ±ÅŸÄ± Kaydet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
    
    // Global'e kaydet
    window.tempImportedPurchases = importedPurchases;
}

function closePurchasesConfirmModal() {
    const modal = document.getElementById('purchasesConfirmModal');
    if (modal) {
        modal.remove();
    }
    window.tempImportedPurchases = null;
}

async function saveImportedPurchases() {
    if (!window.tempImportedPurchases || window.tempImportedPurchases.length === 0) {
        alert('âŒ Kaydedilecek alÄ±ÅŸ bulunamadÄ±!');
        return;
    }
    
    if (!activeCompanyId || !auth.currentUser) {
        alert('âŒ LÃ¼tfen giriÅŸ yapÄ±n!');
        return;
    }
    
    try {
        const batch = db.batch();
        const now = new Date().toISOString();
        let savedCount = 0;
        
        for (const p of window.tempImportedPurchases) {
            const newPurchaseRef = db.collection('companies').doc(activeCompanyId)
                .collection('purchases').doc();
            
            const purchase = {
                id: newPurchaseRef.id,
                companyId: activeCompanyId,
                date: p.date,
                category: p.category,
                description: p.description,
                supplier: p.supplier || '',
                amount: p.amount,
                vatRate: p.vatRate,
                vatAmount: p.vatAmount,
                total: p.total,
                paymentMethod: p.paymentMethod,
                receiptUrl: null,
                createdAt: now,
                createdBy: auth.currentUser.uid
            };
            
            batch.set(newPurchaseRef, purchase);
            purchases.push(purchase);
            savedCount++;
        }
        
        if (savedCount > 0) {
            await batch.commit();
        }
        
        closePurchasesConfirmModal();
        
        await loadPurchases();
        updateDashboard();
        
        alert(`âœ… ${savedCount} alÄ±ÅŸ kaydÄ± baÅŸarÄ±yla eklendi!`);
        
    } catch (error) {
        console.error('AlÄ±ÅŸ kayÄ±t hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

// ========================================
// TEKLÄ°F DOSYASI YÃ–NETÄ°MÄ° FONKSÄ°YONLARI
// ========================================

const TEKLIF_PREFIX = "2025-Ã‡-";
async function getNextTeklifNo() {
    // Firestore Ã¶rneÄŸi
    const tekliflerRef = firebase.firestore().collection("proposals");
    const snapshot = await tekliflerRef.orderBy("number", "desc").limit(1).get();
    if (snapshot.empty) return TEKLIF_PREFIX + "001";
    const lastNum = snapshot.docs[0].data().number;
    // Son 3 haneyi alÄ±p artÄ±r
    let lastSeq = parseInt(lastNum.split("-")[2], 10);
    let nextSeq = (lastSeq + 1).toString().padStart(3, "0");
    return TEKLIF_PREFIX + nextSeq;
}

// Fonksiyon: Teklif modalÄ± aÃ§Ä±lÄ±rken otomatik numara
async function openAddProposalModal() {
    document.getElementById('proposalFormModal').classList.add('active');
    loadCariList();
    clearParametersTable();
    addParameterRow();
    // Otomatik teklif no doldur
    document.getElementById('proposalNumber').value = await getNextTeklifNo();
}

async function saveProposal() {
    try {
        console.log('ğŸ’¾ Teklif kaydediliyor...');
        
        // Teklif verilerini topla
        const teklifData = getTeklifDataFromModal();
        
        // Cari hesap bilgilerini ekle
        const selectedCariId = document.getElementById('proposalCariAccount').value;
        if (!selectedCariId) {
            alert('âš ï¸ LÃ¼tfen cari hesap seÃ§iniz!');
            return;
        }
        
        const cariAccount = accounts.find(a => a.id === selectedCariId);
        if (cariAccount) {
            // âœ… undefined deÄŸerleri temizle
            teklifData.cariAccount = {
                id: cariAccount.id,
                name: cariAccount.name || '',
                taxNo: cariAccount.taxNo || '',
                phone: cariAccount.phone || '',
                email: cariAccount.email || '',
                address: cariAccount.address || '',
                contactPerson: cariAccount.contactPerson || '' // âœ… undefined yerine boÅŸ string
            };
        }
        
        // BaÅŸvuru PDF'i varsa Google Drive'a yÃ¼kle
        if (currentProposalDocument && gapiInited && gisInited) {
            try {
                console.log('ğŸ“¤ BaÅŸvuru PDF Google Drive\'a yÃ¼kleniyor...');
                const uploadResult = await uploadToGoogleDrive(
                    currentProposalDocument,
                    `basvuru_${teklifData.teklifNo}_${Date.now()}.pdf`,
                    'application/pdf'
                );
                
                teklifData.applicationDocument = {
                    fileId: uploadResult.fileId,
                    viewLink: uploadResult.webViewLink,
                    downloadLink: uploadResult.webContentLink,
                    fileName: currentProposalDocument.name,
                    uploadDate: new Date().toISOString()
                };
                
                console.log('âœ… BaÅŸvuru PDF yÃ¼klendi:', uploadResult.webViewLink);
            } catch (error) {
                console.warn('âš ï¸ PDF yÃ¼kleme baÅŸarÄ±sÄ±z, devam ediliyor:', error);
            }
        }
        
// ID yoksa yeni teklif, varsa gÃ¼ncelleme
const proposalId = document.getElementById('proposalId')?.value;
if (!teklifData.id && proposalId) {
    teklifData.id = proposalId; // DÃ¼zenleme modu
} else if (!teklifData.id) {
    teklifData.id = Date.now().toString(); // Yeni teklif
    teklifData.createdAt = new Date().toISOString();
    teklifData.createdBy = auth.currentUser.email;
}     

        teklifData.updatedAt = new Date().toISOString();
        teklifData.status = teklifData.status || 'taslak';
        teklifData.companyId = activeCompanyId;
        
        // âœ… TÃ¼m undefined deÄŸerleri temizle (Firebase iÃ§in)
        const cleanData = JSON.parse(JSON.stringify(teklifData, (key, value) => {
            return value === undefined ? null : value;
        }));
        
        // Firestore'a kaydet
        const currentUser = auth.currentUser;
        if (!currentUser) {
            throw new Error('KullanÄ±cÄ± oturumu bulunamadÄ±');
        }
        
        await db.collection('users')
            .doc(currentUser.uid)
            .collection('proposals')
            .doc(cleanData.id)
            .set(cleanData);
        
        console.log('âœ… Teklif Firestore\'a kaydedildi');
        
        // Local array'e ekle/gÃ¼ncelle
        const existingIndex = proposals.findIndex(p => p.id === cleanData.id);
        if (existingIndex >= 0) {
            proposals[existingIndex] = cleanData;
        } else {
            proposals.push(cleanData);
        }
        
        alert('âœ… Teklif baÅŸarÄ±yla kaydedildi!');
        closeProposalFormModal();
        renderProposalsList();
        
        // Temizlik
        currentProposalDocument = null;
        
    } catch (error) {
        console.error('âŒ Teklif kaydetme hatasÄ±:', error);
        alert('âŒ Teklif kaydedilemedi: ' + error.message);
    }
}

// Teklifleri Firestore'dan yÃ¼kle
async function loadProposals() {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            console.log('âš ï¸ KullanÄ±cÄ± giriÅŸi yok, teklifler yÃ¼klenemiyor');
            return;
        }
        
        console.log('ğŸ”„ Teklifler Firestore\'dan yÃ¼kleniyor...');
        
        const snapshot = await db.collection('users')
            .doc(currentUser.uid)
            .collection('proposals')
            .orderBy('createdAt', 'desc') // âœ… En yeni Ã¶nce
            .get();
        
        proposals = [];
        snapshot.forEach(doc => {
            proposals.push({ id: doc.id, ...doc.data() });
        });
        
        console.log(`âœ… ${proposals.length} teklif yÃ¼klendi`);
        
        // Tabloyu render et
        renderProposalsList();
        
    } catch (error) {
        console.error('âŒ Teklif yÃ¼kleme hatasÄ±:', error);
        
        // EÄŸer createdAt index yoksa
        if (error.code === 'failed-precondition') {
            console.warn('âš ï¸ Firestore index oluÅŸturuluyor...');
            // Index olmadan yÃ¼kle
            const snapshot = await db.collection('users')
                .doc(auth.currentUser.uid)
                .collection('proposals')
                .get();
            
            proposals = [];
            snapshot.forEach(doc => {
                proposals.push({ id: doc.id, ...doc.data() });
            });
            
            console.log(`âœ… ${proposals.length} teklif yÃ¼klendi (index olmadan)`);
            renderProposalsList();
        }
    }
}

// Teklifleri listele
function renderProposalsList() {
    const tbody = document.querySelector('#proposalsTable tbody');
    if (!tbody) {
        console.warn('âš ï¸ Teklif tablosu bulunamadÄ±');
        return;
    }
    
    tbody.innerHTML = '';
    
    // Aktif firmaya gÃ¶re filtrele
    let filteredProposals = proposals;
    if (activeCompanyId) {
        filteredProposals = proposals.filter(p => p.companyId === activeCompanyId);
    }
    
    if (filteredProposals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#6b7280;">HenÃ¼z teklif kaydÄ± yok</td></tr>';
        return;
    }
    
    filteredProposals.forEach(proposal => {
        const tr = document.createElement('tr');
        
        // Durum badge
        let statusBadge = '';
        switch(proposal.status) {
            case 'taslak':
                statusBadge = '<span style="background:#6b7280; color:white; padding:3px 8px; border-radius:4px; font-size:0.85em;">ğŸ“ Taslak</span>';
                break;
            case 'gonderildi':
                statusBadge = '<span style="background:#3b82f6; color:white; padding:3px 8px; border-radius:4px; font-size:0.85em;">ğŸ“¤ GÃ¶nderildi</span>';
                break;
            case 'onaylandi':
                statusBadge = '<span style="background:#10b981; color:white; padding:3px 8px; border-radius:4px; font-size:0.85em;">âœ… OnaylandÄ±</span>';
                break;
            case 'reddedildi':
                statusBadge = '<span style="background:#ef4444; color:white; padding:3px 8px; border-radius:4px; font-size:0.85em;">âŒ Reddedildi</span>';
                break;
            default:
                statusBadge = '<span style="background:#6b7280; color:white; padding:3px 8px; border-radius:4px; font-size:0.85em;">-</span>';
        }
        
        tr.innerHTML = `
            <td>${proposal.teklifNo || '-'}</td>
            <td>${proposal.firmaUnvan || '-'}</td>
            <td>${proposal.basvuruTarihi || '-'}</td>
            <td style="font-weight:bold;">${proposal.genelToplam || '-'}</td>
            <td>${statusBadge}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editProposal('${proposal.id}')" title="DÃ¼zenle">
                    âœï¸
                </button>
                <button class="btn btn-sm btn-success" onclick="downloadProposalPDF('${proposal.id}')" title="PDF Ä°ndir">
                    ğŸ“¥ PDF
                </button>
                ${proposal.applicationDocument ? `
                <button class="btn btn-sm btn-warning" onclick="window.open('${proposal.applicationDocument.viewLink}', '_blank')" title="BaÅŸvuru PDF">
                    ğŸ“„ BaÅŸvuru
                </button>
                ` : ''}
                <button class="btn btn-sm btn-secondary" onclick="sendProposalEmail('${proposal.id}')" title="Mail GÃ¶nder">
                    ğŸ“§ Mail
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteProposal('${proposal.id}')" title="Sil">
                    ğŸ—‘ï¸
                </button>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
    
    console.log(`âœ… ${filteredProposals.length} teklif listelendi`);
}

// Teklif dÃ¼zenle
function editProposal(proposalId) {
    const proposal = proposals.find(p => p.id === proposalId);
    if (!proposal) {
        alert('Teklif bulunamadÄ±!');
        return;
    }
    
    // Teklif formunu aÃ§
    openAddProposalModal();
    
    // Formu doldur
    document.getElementById('proposalNumber').value = proposal.teklifNo || '';
    document.getElementById('proposalApplicationNo').value = proposal.basvuruNo || '';
    document.getElementById('proposalApplicationDate').value = proposal.basvuruTarihi || '';
    
    // Cari seÃ§
    if (proposal.cariAccount && proposal.cariAccount.id) {
        document.getElementById('proposalCariAccount').value = proposal.cariAccount.id;
        fillFromCariAccount(); // Cari bilgilerini doldur
    }
    
    // Firma bilgileri
    document.getElementById('proposalCompany').value = proposal.firmaUnvan || '';
    document.getElementById('proposalAddress').value = proposal.firmaAdres || '';
    document.getElementById('proposalPhone').value = proposal.telefon || '';
    document.getElementById('proposalEmail').value = proposal.mail || '';
    if (document.getElementById('proposalContactPerson')) {
        document.getElementById('proposalContactPerson').value = proposal.cariAccount?.contactPerson || '';
    }
    
    // Teklif iÃ§erik bilgileri
    if (document.getElementById('proposalType')) {
        document.getElementById('proposalType').value = proposal.baslikTur || 'Emisyon Ã–lÃ§Ã¼mÃ¼';
    }
    if (document.getElementById('proposalContent')) {
        document.getElementById('proposalContent').value = proposal.icerik || '';
    }
    if (document.getElementById('proposalPreparedBy')) {
        document.getElementById('proposalPreparedBy').value = proposal.hazirlayan || '';
    }
    if (document.getElementById('proposalContact')) {
        document.getElementById('proposalContact').value = proposal.iletisim || '';
    }
    
    // Parametreleri yÃ¼kle
    clearParametersTable();
    if (proposal.parameters && proposal.parameters.length > 0) {
        proposal.parameters.forEach(param => {
            addParameterRow({
                name: param.parametre || param.name,
                adet: param.adet,
                price: param.birimFiyat || param.price,
                total: param.toplam || param.total
            });
        });
    } else {
        addParameterRow();
    }
    
    // Tutarlar
    if (document.getElementById('proposalTotal')) {
        document.getElementById('proposalTotal').value = proposal.toplam || '';
    }
    if (document.getElementById('proposalBaseFee')) {
        document.getElementById('proposalBaseFee').value = proposal.tabanFiyat || '';
    }
    if (document.getElementById('proposalDiscountedTotal')) {
        document.getElementById('proposalDiscountedTotal').value = proposal.genelToplam || '';
    }
    if (document.getElementById('proposalNotes')) {
        document.getElementById('proposalNotes').value = proposal.ekNotlar || '';
    }
    
    // ID'yi sakla (gÃ¼ncelleme iÃ§in)
    if (!document.getElementById('proposalId')) {
        const hiddenId = document.createElement('input');
        hiddenId.type = 'hidden';
        hiddenId.id = 'proposalId';
        document.getElementById('proposalForm').appendChild(hiddenId);
    }
    document.getElementById('proposalId').value = proposal.id;
    
    // Modal baÅŸlÄ±ÄŸÄ±nÄ± deÄŸiÅŸtir
    document.getElementById('proposalFormModalTitle').textContent = 'âœï¸ Teklif DÃ¼zenle';
    
    console.log('âœ… Teklif dÃ¼zenleme modu aÃ§Ä±ldÄ±:', proposalId);
}

// Teklif sil
async function deleteProposal(proposalId) {
    if (!confirm('âš ï¸ Bu teklifi silmek istediÄŸinizden emin misiniz?')) {
        return;
    }
    
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            alert('KullanÄ±cÄ± oturumu bulunamadÄ±');
            return;
        }
        
        // Google Drive'dan baÅŸvuru PDF'ini sil
        const proposal = proposals.find(p => p.id === proposalId);
        if (proposal && proposal.applicationDocument && proposal.applicationDocument.fileId) {
            try {
                await deleteFromGoogleDrive(proposal.applicationDocument.fileId);
                console.log('âœ… BaÅŸvuru PDF Google Drive\'dan silindi');
            } catch (error) {
                console.warn('âš ï¸ Google Drive\'dan dosya silinemedi:', error);
            }
        }
        
        // Firestore'dan sil
        await db.collection('users')
            .doc(currentUser.uid)
            .collection('proposals')
            .doc(proposalId)
            .delete();
        
        // Local array'den Ã§Ä±kar
        proposals = proposals.filter(p => p.id !== proposalId);
        
        console.log('âœ… Teklif silindi:', proposalId);
        alert('âœ… Teklif baÅŸarÄ±yla silindi');
        
        renderProposalsList();
        
    } catch (error) {
        console.error('âŒ Silme hatasÄ±:', error);
        alert('âŒ Teklif silinemedi: ' + error.message);
    }
}

// âœ… KAYITLI TEKLÄ°FTEN PDF OLUÅTURMA (AynÄ± ayarlarla)
async function downloadProposalPDF(proposalId) {
    const proposal = proposals.find(p => p.id === proposalId);
    
    if (!proposal) {
        alert('âŒ Teklif bulunamadÄ±!');
        return;
    }
    
    try {
        console.log('ğŸ“„ PDF oluÅŸturuluyor...');
        
        const teklifData = {
            teklifNo: proposal.teklifNo,
            tarih: proposal.basvuruTarihi || new Date().toLocaleDateString('tr-TR'),
            firmaUnvan: proposal.firmaUnvan,
            firmaAdres: proposal.firmaAdres || '',
            telefon: proposal.telefon || '',
            mail: proposal.mail || '',
            konu: 'MELBES',
            icerik: proposal.icerik || 'Ä°misyon Ã–lÃ§Ã¼mÃ¼ Fiyat Teklifi',
            baslikTur: proposal.baslikTur || 'Emisyon Ã–lÃ§Ã¼mÃ¼',
            basvuruNo: proposal.basvuruNo || '',
            hazirlayan: proposal.hazirlayan || 'GÃ¶knur YAÄAN',
            iletisim: proposal.iletisim || '0 282 651 46 50',
            parameters: proposal.parameters || [],
            toplam: proposal.toplam || '0,00 TL',
            tabanFiyat: proposal.tabanFiyat || '0,00 TL',
            genelToplam: proposal.genelToplam || '0,00 TL',
            ekNotlar: proposal.ekNotlar || ''
        };
        
        fillPDFTemplate(teklifData);
        
        const element = document.getElementById('pdfTemplate');
        element.style.display = 'block';
        
        // â³ DOM'un render olmasÄ±nÄ± bekle
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // âœ… FÄ°NAL OPTÄ°MÄ°ZE PDF AYARLARI
        const opt = {
            margin: 5,  // âœ… 10'dan 5'e dÃ¼ÅŸÃ¼r - boÅŸ sayfalarÄ± azalt
            filename: `${teklifData.teklifNo}_Fiyat_Teklifi.pdf`,
            image: { 
                type: 'jpeg', 
                quality: 0.95
            },
            html2canvas: { 
                scale: 1.4,  // âœ… 1.5'ten 1.4'e dÃ¼ÅŸÃ¼r
                useCORS: true,
                letterRendering: true,
                logging: false,
                scrollY: 0,
                scrollX: 0,
                backgroundColor: '#ffffff',
                onclone: function(clonedDoc) {
                    // âœ… Clone edilen dokÃ¼mandaki boÅŸluklarÄ± kaldÄ±r
                    const clonedElement = clonedDoc.getElementById('pdfTemplate');
                    if (clonedElement) {
                        clonedElement.style.padding = '10mm 15mm';
                    }
                }
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait',
                compress: true,
                precision: 2
            },
            pagebreak: { 
                mode: ['css', 'legacy'],
                before: '.pdf-page',
                after: '.pdf-page'
            }
        };
   
        await html2pdf().set(opt).from(element).save();
        
        element.style.display = 'none';
        
        console.log('âœ… PDF indirildi');
        
    } catch (error) {
        console.error('âŒ PDF oluÅŸturma hatasÄ±:', error);
        alert('âŒ PDF oluÅŸturulamadÄ±: ' + error.message);
        
        const element = document.getElementById('pdfTemplate');
        if (element) element.style.display = 'none';
    }
}

// Cari hesaptan bilgileri otomatik doldur
function fillFromCariAccount() {
    const cariId = document.getElementById('proposalCariAccount').value;
    
    if (!cariId) {
        // Temizle
        document.getElementById('proposalCompany').value = '';
        document.getElementById('proposalAddress').value = '';
        document.getElementById('proposalPhone').value = '';
        document.getElementById('proposalEmail').value = '';
        if (document.getElementById('proposalContactPerson')) {
            document.getElementById('proposalContactPerson').value = '';
        }
        return;
    }
    
    const cariAccount = accounts.find(a => a.id === cariId);
    if (!cariAccount) {
        console.warn('Cari hesap bulunamadÄ±:', cariId);
        return;
    }
    
    // Bilgileri doldur
    document.getElementById('proposalCompany').value = cariAccount.name || '';
    document.getElementById('proposalAddress').value = cariAccount.address || '';
    document.getElementById('proposalPhone').value = cariAccount.phone || '';
    document.getElementById('proposalEmail').value = cariAccount.email || '';
    if (document.getElementById('proposalContactPerson')) {
        document.getElementById('proposalContactPerson').value = cariAccount.contactPerson || '';
    }
    
    console.log('âœ… Cari bilgileri form alanlarÄ±na dolduruldu');
}

function selectMatchingParameterInRow(row, parameterName) {
    console.log(`ğŸ” EÅŸleÅŸtirme arÄ±yor: "${parameterName}"`);
    
    const cells = row.querySelectorAll('td');
    if (cells.length === 0) {
        console.warn('âŒ SatÄ±rda hÃ¼cre bulunamadÄ±');
        return false;
    }
    
    const parameterSelect = cells[1]?.querySelector('select');
    if (!parameterSelect) {
        console.warn('âŒ Parametre dropdown bulunamadÄ±');
        return false;
    }
    
    const options = Array.from(parameterSelect.options);
    
    // Her seÃ§enek iÃ§in benzerlik skoru hesapla
    const matches = options.map(option => {
        const optionText = option.text.trim();
        const similarity = calculateSimilarity(parameterName, optionText);
        
        return {
            option: option,
            text: optionText,
            value: option.value,
            similarity: similarity
        };
    }).filter(m => m.similarity >= 70); // %70+ benzerlik
    
    // En yÃ¼ksek skorlu seÃ§eneÄŸi al
    matches.sort((a, b) => b.similarity - a.similarity);
    
    if (matches.length > 0) {
        const bestMatch = matches[0];
        console.log(`âœ… En iyi eÅŸleÅŸme: "${bestMatch.text}" (%${bestMatch.similarity.toFixed(1)})`);
        
        parameterSelect.value = bestMatch.value;
        
        // onChange event'ini tetikle
        const event = new Event('change', { bubbles: true });
        parameterSelect.dispatchEvent(event);
        
        return true;
    } else {
        console.warn(`âŒ "${parameterName}" iÃ§in uygun eÅŸleÅŸme bulunamadÄ± (>%70)`);
        return false;
    }
}

function getParametersTableData() {
    const rows = [];
    document.querySelectorAll('#parametersTable tbody tr').forEach(tr => {
        rows.push({
            name: tr.querySelector("select").value,
            adet: tr.querySelector(".param-qty").value,
            price: tr.querySelector(".param-price").value,
            total: tr.querySelector(".param-total").value
        });
    });
    return rows;
}

async function loadProposalsList() {
    const tekliflerRef = firebase.firestore().collection("proposals");
    const snapshot = await tekliflerRef.orderBy("createdAt", "desc").get();
    let tbody = document.querySelector("#proposalsTable tbody");
    tbody.innerHTML = "";
    snapshot.forEach(doc => {
        let d = doc.data();
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${d.number}</td><td>${d.company}</td><td>${d.applicationDate}</td><td>${d.discountedTotal}</td><td>HazÄ±rlandÄ±</td><td></td>`;
        tbody.appendChild(tr);
    });
}

async function uploadPDF(file, teklifNo) {
    const storageRef = firebase.storage().ref();
    const pdfRef = storageRef.child(`teklifler/${teklifNo}.pdf`);
    await pdfRef.put(file);
    const downloadURL = await pdfRef.getDownloadURL();
    return downloadURL;
}

// Modalden tÃ¼m teklif verilerini topla
function getTeklifDataFromModal() {
    console.log('ğŸš€ getTeklifDataFromModal Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...');
    
    const teklifData = {
        teklifNo: document.getElementById('proposalNumber')?.value || '',
        tarih: new Date().toLocaleDateString('tr-TR'),
        basvuruNo: document.getElementById('proposalApplicationNo')?.value || '',
        firmaUnvan: document.getElementById('proposalCompany')?.value || '',
        firmaAdres: document.getElementById('proposalAddress')?.value || '',
        telefon: document.getElementById('proposalPhone')?.value || '-',
        mail: document.getElementById('proposalEmail')?.value || '-',
        konu: 'MELBES',
        icerik: document.getElementById('proposalContent')?.value || 'Ä°misyon Ã–lÃ§Ã¼mÃ¼ Fiyat Teklifi',
        baslikTur: document.getElementById('proposalType')?.value || 'Emisyon Ã–lÃ§Ã¼mÃ¼',
        hazirlayan: document.getElementById('proposalPreparedBy')?.value || 'GÃ¶knur YAÄAN',
        iletisim: document.getElementById('proposalContact')?.value || '0 282 651 46 50',
        parameters: [],
        toplam: document.getElementById('proposalTotal')?.value || '0,00 TL',
        tabanFiyat: document.getElementById('proposalBaseFee')?.value || '0,00 TL',
        genelToplam: document.getElementById('proposalDiscountedTotal')?.value || '0,00 TL',
        ekNotlar: document.getElementById('proposalNotes')?.value || ''
    };
    
    console.log('ğŸ” Tabloyu arÄ±yorum...');
    
    const allTables = document.querySelectorAll('table');
    console.log(`ğŸ“Š Sayfada ${allTables.length} tablo bulundu`);
    
    let targetTable = null;
    
    // Parametreler tablosunu bul
    for (let table of allTables) {
        const deleteButtons = table.querySelectorAll('button[onclick*="deleteProposalParameter"]');
        if (deleteButtons.length > 0) {
            targetTable = table;
            console.log('âœ… Parametreler tablosu bulundu! (Sil butonundan tanÄ±ndÄ±)');
            break;
        }
    }
    
    if (!targetTable) {
        for (let table of allTables) {
            const headers = table.querySelectorAll('th');
            for (let th of headers) {
                if (th.textContent.includes('Kaynak AdÄ±') || th.textContent.includes('Parametre')) {
                    targetTable = table;
                    console.log('âœ… Parametreler tablosu bulundu! (BaÅŸlÄ±ktan tanÄ±ndÄ±)');
                    break;
                }
            }
            if (targetTable) break;
        }
    }
    
    if (!targetTable) {
        console.error('âŒ Parametreler tablosu bulunamadÄ±!');
        return teklifData;
    }
    
    const tbody = targetTable.querySelector('tbody');
    if (!tbody) {
        console.error('âŒ tbody bulunamadÄ±!');
        return teklifData;
    }
    
    const rows = tbody.querySelectorAll('tr');
    console.log(`ğŸ“Š Tabloda ${rows.length} satÄ±r bulundu`);
    
// Her satÄ±rÄ± oku kÄ±smÄ±nda deÄŸiÅŸiklik
rows.forEach((row, index) => {
    const cells = row.querySelectorAll('td');
    console.log(`\n--- SATIR ${index + 1} (${cells.length} hÃ¼cre) ---`);
    
    if (cells.length >= 4) { // 4 hÃ¼cre yeterli
        const getValue = (cell) => {
            if (!cell) return '';
            
            const input = cell.querySelector('input');
            const select = cell.querySelector('select');
            
            if (input) {
                return input.value;
            } else if (select) {
                return select.options[select.selectedIndex]?.text || select.value;
            } else {
                return cell.textContent.trim();
            }
        };
        
        // DOÄRU SIRALAMA
const param = {
    kaynakAdi: '', // BoÅŸ - tabloda yok
    parametre: getValue(cells[0]), // HÃ¼cre 0 = Parametre adÄ± (Formaldehit, PAH vs.)
    standart: '', // Standart bilgisi yok
    adet: getValue(cells[1]), // HÃ¼cre 1 = Adet
    birimFiyat: getValue(cells[2]), // HÃ¼cre 2 = Birim Fiyat
    toplam: getValue(cells[3]) // HÃ¼cre 3 = Toplam
};
        
        console.log(`  ğŸ“¦ Parametre:`, param);
        
        // "Sil" butonunu atla
        if (param.parametre && 
            param.parametre.trim() !== '' && 
            param.parametre !== 'Sil' &&
            param.parametre !== 'SeÃ§iniz') {
            
            teklifData.parameters.push(param);
            console.log(`  âœ… Eklendi!`);
        }
    }
});

    console.log('\nğŸ“‹ SONUÃ‡:');
    console.log('Teklif Verileri:', teklifData);
    console.log('ğŸ“Š Toplam Parametre:', teklifData.parameters.length);
    
    if (teklifData.parameters.length === 0) {
        console.error('âŒ HÄ°Ã‡ PARAMETRE BULUNAMADI!');
    }
    
    return teklifData;
}

// PDF Template'ine verileri doldur
function fillPDFTemplate(teklifData) {
    console.log('ğŸ”„ PDF Template dolduruluyor...');
    
    // 1. Teklif No ve Tarih
    document.getElementById('pdf-teklif-no').textContent = teklifData.teklifNo;
    document.getElementById('pdf-tarih').textContent = teklifData.tarih;
    
    document.querySelectorAll('.pdf-teklif-no-copy').forEach(el => {
        el.textContent = teklifData.teklifNo;
    });
    document.querySelectorAll('.pdf-tarih-copy').forEach(el => {
        el.textContent = teklifData.tarih;
    });
    
    // 2. Sayfa 1: Kapak
    document.getElementById('pdf-firma-unvan').textContent = teklifData.firmaUnvan;
    document.getElementById('pdf-firma-adres').textContent = teklifData.firmaAdres;
    document.getElementById('pdf-telefon').textContent = teklifData.telefon;
    document.getElementById('pdf-mail').textContent = teklifData.mail;
    document.getElementById('pdf-konu').textContent = teklifData.konu;
    document.getElementById('pdf-icerik').textContent = teklifData.icerik;
    document.getElementById('pdf-basvuru-no').textContent = teklifData.basvuruNo;
    document.getElementById('pdf-hazirlayan').textContent = teklifData.hazirlayan;
    document.getElementById('pdf-iletisim').textContent = teklifData.iletisim;
    
    // 3. Sayfa 2: BaÅŸlÄ±k ve Tablo
    document.getElementById('pdf-baslik-tur').textContent = teklifData.baslikTur;
    
    // Parametreler tablosunu doldur
    const tableBody = document.querySelector('#pdf-parameters-table tbody');
    
    if (tableBody && teklifData.parameters.length > 0) {
        console.log(`ğŸ“Š ${teklifData.parameters.length} parametre ekleniyor...`);
        
        let tableHTML = '';
        teklifData.parameters.forEach((p, index) => {
            tableHTML += `
    <tr>
        <td>${p.kaynakAdi || 'Tesis Geneli'}</td>
        <td>${p.parametre || ''}</td>
        <td>${p.standart || '-'}</td>
        <td style="text-align: center;">${p.adet || ''}</td>
        <td style="text-align: right;">${p.birimFiyat || ''}</td>
        <td style="text-align: right;">${p.toplam || ''}</td>
    </tr>
            `;
            console.log(`  âœ“ Parametre ${index + 1}: ${p.parametre}`);
        });
        
        tableBody.innerHTML = tableHTML;
        console.log('âœ… Tablo dolduruldu!');
    } else {
        console.warn('âš ï¸ Parametre bulunamadÄ±!');
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Parametre eklenmemiÅŸ</td></tr>';
    }
    
    // 4. Tutarlar
    document.getElementById('pdf-toplam').textContent = teklifData.toplam;
    document.getElementById('pdf-taban-fiyat').textContent = teklifData.tabanFiyat;
    document.getElementById('pdf-genel-toplam').textContent = teklifData.genelToplam;
    
    // 5. Ek Notlar
    const ekNotlarEl = document.getElementById('pdf-ek-notlar');
    if (ekNotlarEl && teklifData.ekNotlar) {
        ekNotlarEl.textContent = '- ' + teklifData.ekNotlar;
    }
    
    console.log('âœ… Template doldurma tamamlandÄ±!');
}

// âœ… TAM DÃœZELTÄ°LMÄ°Å PDF OLUÅTURMA FONKSÄ°YONU
async function createProfessionalTeklifPDF() {
    try {
        console.log('ğŸš€ PDF oluÅŸturma baÅŸlatÄ±lÄ±yor...');
        
        // 1. Verileri topla
        const teklifData = getTeklifDataFromModal();
        
        // Veri kontrolÃ¼
        if (!teklifData.teklifNo) {
            alert('âš ï¸ LÃ¼tfen Teklif No giriniz!');
            return;
        }
        
        if (teklifData.parameters.length === 0) {
            alert('âš ï¸ LÃ¼tfen en az 1 parametre ekleyiniz!');
            return;
        }
        
        // 2. Template'i doldur
        fillPDFTemplate(teklifData);
        
        // 3. PDF Template elementini al
        const element = document.getElementById('pdfTemplate');
        
        if (!element) {
            alert('âŒ PDF Template bulunamadÄ±!');
            return;
        }
        
        // 4. GeÃ§ici olarak gÃ¶ster
        element.style.display = 'block';
        
        // â³ DOM'un render olmasÄ±nÄ± bekle
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // âœ… 5. OPTÄ°MÄ°ZE EDÄ°LMÄ°Å PDF AYARLARI
        const opt = {
            margin: 5,  // âœ… 10mm kenar boÅŸluÄŸu (0 yerine)
            filename: `${teklifData.teklifNo}_Fiyat_Teklifi.pdf`,
            image: { 
                type: 'jpeg', 
                quality: 0.95  // âœ… 0.98'den 0.95'e dÃ¼ÅŸÃ¼r (daha kÃ¼Ã§Ã¼k dosya)
            },
            html2canvas: { 
                scale: 1.4,  // âœ… 2'den 1.5'e dÃ¼ÅŸÃ¼r (Ã§ok bÃ¼yÃ¼k olmasÄ±n)
                useCORS: true,
                letterRendering: true,
                logging: false,
                // âŒ windowWidth ve windowHeight KALDIRILDI
                // Bunlar iÃ§eriÄŸi zorla boyutlandÄ±rÄ±yor!
                scrollY: 0,
                scrollX: 0,
                backgroundColor: '#ffffff',
		onclone: function(clonedDoc) {
                   			 // âœ… Clone edilen dokÃ¼mandaki boÅŸluklarÄ± kaldÄ±r
                    			 const clonedElement = clonedDoc.getElementById('pdfTemplate');
                   			  if (clonedElement) {
                       			  clonedElement.style.padding = '10mm 15mm';
                   			 }
                		  }
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait',
                compress: true,
                precision: 2  // âœ… Hassasiyet ekle
            },
            pagebreak: { 
                mode: ['css', 'legacy'],  // âœ… 'legacy' geri ekle
                before: '.pdf-page',
                after: '.pdf-page'
                // âŒ 'avoid' parametresi KALDIRILDI (sorun yaratÄ±yor)
            }
        };
        
        console.log('ğŸ“„ PDF oluÅŸturuluyor...');
        
        // 6. PDF OluÅŸtur
        await html2pdf().set(opt).from(element).save();
        
        // 7. Template'i tekrar gizle
        element.style.display = 'none';
        
        console.log('âœ… PDF baÅŸarÄ±yla oluÅŸturuldu!');
        alert('âœ… PDF baÅŸarÄ±yla indirildi!');
        
    } catch (error) {
        console.error('âŒ PDF oluÅŸturma hatasÄ±:', error);
        alert('âŒ PDF oluÅŸturulamadÄ±: ' + error.message);
        
        // Hata durumunda template'i gizle
        const element = document.getElementById('pdfTemplate');
        if (element) element.style.display = 'none';
    }
}

// ========================================
// CARÄ° HESAP EXCEL/CSV IMPORT FONKSÄ°YONLARI
// ========================================

function openImportAccountsModal() {
    if (!activeCompanyId) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce bir firma seÃ§in!');
        return;
    }

    const modalHtml = `
        <div class="modal active" id="accountsImportModal" style="display: flex;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>ğŸ“¤ Cari HesaplarÄ± Excel/CSV'den Ekle</h3>
                    <button class="close-modal" onclick="closeImportAccountsModal()">âœ–</button>
                </div>
                <div style="padding: 30px;">
                    <div class="alert alert-info">
                        <strong>ğŸ“‹ Format:</strong> Sadece 1 sÃ¼tun yeterli!
                        <p style="margin: 10px 0 0 0; font-size: 0.95em;">
                            <b>BaÅŸlÄ±k:</b> Cari AdÄ± veya AlÄ±cÄ± AdÄ±<br>
                            <b>Ã–rnek:</b>
                            <br>
                            <code>
Cari AdÄ±<br>
BORAY PLASTÄ°K VE AMBALAJ SAN.LTD.ÅTÄ°.<br>
YILPLAST PLASTÄ°K SANAYÄ° VE DIÅ TÄ°C.LTD.ÅTÄ°.<br>
ZET LOJÄ°STÄ°K HAZIR BETON SANAYÄ° VE TÄ°CARET ANONÄ°M ÅÄ°RKETÄ°
                            </code>
                        </p>
                    </div>
                    <div class="file-upload-area" 
                         onclick="document.getElementById('accountsExcelFile').click()" 
                         style="cursor: pointer; margin-bottom: 20px;">
                        <h3>ğŸ“‚ CSV/Excel DosyasÄ±nÄ± YÃ¼kle</h3>
                        <p style="margin: 10px 0; color: #6b7280;">DosyanÄ±zÄ± sÃ¼rÃ¼kleyin veya tÄ±klayÄ±n</p>
                        <input type="file" 
                               id="accountsExcelFile" 
                               accept=".csv" 
                               style="display:none;" 
                               onchange="processAccountsExcel(event)">
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeImportAccountsModal()">
                            âœ–ï¸ Ä°ptal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closeImportAccountsModal() {
    const modal = document.getElementById('accountsImportModal');
    if (modal) {
        modal.remove();
    }
}

async function processAccountsExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    try {
        await saveImportedFileToStorage(file, "accounts");
    } catch (err) {
        console.error("Cari dosya kaydedilemedi:", err);
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            parseAccountsCSV(e.target.result);
        } catch (err) {
            console.error("Cari dosya parse hatasÄ±:", err);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

function parseAccountsCSV(content) {
    const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);

    // AyraÃ§ algÄ±la (virgÃ¼l veya noktalÄ± virgÃ¼l veya tab)
    let delimiter = ',';
    if (lines[0].includes(';')) delimiter = ';';
    if (lines[0].includes('\t')) delimiter = '\t';

    // BaÅŸlÄ±k kontrolÃ¼
    const header = lines[0].toLowerCase();
    if (!header.includes('cari') && !header.includes('alÄ±cÄ±')) {
        alert('âš ï¸ Ä°lk satÄ±r baÅŸlÄ±k olmalÄ±: "Cari AdÄ±" veya "AlÄ±cÄ± AdÄ±"');
        return;
    }

    let importedAccounts = [];
    let errorCount = 0;

    for (let i = 1; i < lines.length; i++) {
        let name = lines[i].split(delimiter)[0]?.trim();
        if (!name || name.length < 3) { errorCount++; continue; }
        // AynÄ± isim varsa atla
        if (accounts.some(acc => acc.name.trim().toLowerCase() === name.toLowerCase() && acc.companyId === activeCompanyId)) {
            errorCount++;
            continue;
        }
        importedAccounts.push({
            id: Date.now().toString() + '_' + i + '_' + Math.random(),
            companyId: activeCompanyId,
            name: name,
            type: 'customer', // default: mÃ¼ÅŸteri, istenirse seÃ§ilebilir!
            balance: 0,
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.uid : 'unknown'
        });
    }

    showAccountsConfirmModal(importedAccounts, errorCount);
}

function showAccountsConfirmModal(importedAccounts, errorCount) {
    closeImportAccountsModal();
    const summaryHtml = errorCount > 0 
        ? `<div class="alert alert-warning">
            <strong>âš ï¸ ${errorCount} satÄ±r hatalÄ± veya tekrar olduÄŸu iÃ§in atlandÄ±!</strong>
           </div>`
        : '';
    const modalHtml = `
        <div class="modal active" id="accountsConfirmModal" style="display: flex;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>âœ… Cari HesaplarÄ± OnaylayÄ±n (${importedAccounts.length} KayÄ±t)</h3>
                    <button class="close-modal" onclick="closeAccountsConfirmModal()">âœ–</button>
                </div>
                <div style="padding: 20px;">
                    ${summaryHtml}
                    <div class="alert alert-success">
                        <strong>ğŸ“Š Toplam ${importedAccounts.length} cari hesap eklenecek</strong>
                    </div>
                    <ul style="max-height:300px;overflow:auto;">
                        ${importedAccounts.map(acc => `<li>${acc.name}</li>`).join('')}
                    </ul>
                    <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                        <button class="btn btn-secondary" onclick="closeAccountsConfirmModal()">
                            âœ–ï¸ Ä°ptal
                        </button>
                        <button class="btn btn-success" onclick="saveImportedAccounts()" style="font-size: 16px; padding: 12px 30px;">
                            ğŸ’¾ Cari HesaplarÄ± Kaydet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);

    window.tempImportedAccounts = importedAccounts;
}

function closeAccountsConfirmModal() {
    const modal = document.getElementById('accountsConfirmModal');
    if (modal) {
        modal.remove();
    }
    window.tempImportedAccounts = null;
}

// ===============================
// CSV'den cari (hesap) import iÅŸlemi
// ===============================

async function saveImportedAccounts() {
    // DoÄŸru dizi: window.tempImportedAccounts
    const accountsToSave = window.tempImportedAccounts;
    if (!accountsToSave || accountsToSave.length === 0) {
        alert('âŒ Kaydedilecek cari hesap yok!');
        return;
    }
    if (!activeCompanyId) {
        alert('âŒ LÃ¼tfen bir firma seÃ§in!');
        return;
    }
    if (!auth.currentUser) {
        alert('âŒ LÃ¼tfen giriÅŸ yapÄ±n!');
        return;
    }

    // Firebase'den gÃ¼ncel carileri Ã§ek!
    await loadAccounts();

    // Unique key algoritmasÄ±nÄ± kullan
    const existingKeys = accounts.map(getAccountUniqueKey);
    const filteredAccounts = [];
    let skippedCount = 0;

    accountsToSave.forEach(acc => {
        const accKey = getAccountUniqueKey(acc);
        if (existingKeys.includes(accKey)) {
            skippedCount++;
        } else {
            filteredAccounts.push(acc);
            existingKeys.push(accKey);
        }
    });

    if (filteredAccounts.length === 0) {
        alert(`âš ï¸ TÃ¼m cari hesaplar zaten kayÄ±tlÄ±, yeni hesap eklenmedi.`);
        return;
    }

    // Firebase batch ile ekle
    const batch = db.batch();
    const now = new Date().toISOString();
    filteredAccounts.forEach(acc => {
        const accountRef = db.collection('companies').doc(activeCompanyId)
            .collection('accounts').doc();
        const accountData = {
            id: accountRef.id,
            companyId: activeCompanyId,
            name: acc.name,
            taxNo: acc.taxNo || "",
            type: acc.type || "customer",
            address: acc.address || "",
            phone: acc.phone || "",
            email: acc.email || "",
            balance: 0,
            createdAt: now,
            createdBy: auth.currentUser.uid
        };
        batch.set(accountRef, accountData);
        accounts.push(accountData);
    });

    await batch.commit();
    await loadAccounts();
    updateDashboard();

    alert(`âœ… ${filteredAccounts.length} yeni cari hesap eklendi\nâš ï¸ ${skippedCount} cari zaten vardÄ±, atlandÄ±!`);

    // ModalÄ± kapat
    closeAccountsConfirmModal();
}

// 1. Excel'den gelen carileri modalda Ã¶nizle
async function openCariImportModal(importedAccounts) {
    await loadAccounts(); // Firebase'den gÃ¼ncel veri
    const existingKeys = accounts.map(getAccountUniqueKey);
    window.filteredAccounts = [];
    let skippedCount = 0;

    importedAccounts.forEach(acc => {
        const accKey = getAccountUniqueKey(acc);
        if (existingKeys.includes(accKey)) {
            skippedCount++;
        } else {
            window.filteredAccounts.push(acc);
            existingKeys.push(accKey);
        }
    });

    // ModalÄ± aÃ§, window.filteredAccounts'u UI'da gÃ¶ster
}

// YÃ¶netici panelinde izin taleplerini listele
function loadLeaveRequestsAdminPanel() {
    const tbody = document.getElementById('adminLeaveRequestsTableBody');
    tbody.innerHTML = '';
    if (!leaveRequests || leaveRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">HenÃ¼z izin talebi yok.</td></tr>';
        return;
    }
    leaveRequests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    leaveRequests.forEach(lr => {
        const person = personnel.find(p => p.id === lr.personnelId);
        const statusColor =
            lr.status === "approved" ? "success" :
            lr.status === "rejected" ? "danger" : "warning";
        const statusLabel =
            lr.status === "approved" ? "OnaylandÄ±" :
            lr.status === "rejected" ? "Reddedildi" : "Beklemede";
        tbody.innerHTML += `
            <tr>
                <td>${person ? person.name : 'Bilinmiyor'}</td>
                <td>${formatDate(lr.startDate)} - ${formatDate(lr.endDate)}</td>
                <td>${getLeaveTypeLabel(lr.type)}</td>
                <td>${lr.description || '-'}</td>
                <td><span class="badge badge-${statusColor}">${statusLabel}</span></td>
                <td>${lr.approvedBy || lr.rejectedBy || '-'}</td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="showLeaveDetailModal('${lr.id}')">Detay/Ã‡Ä±ktÄ±</button>
                </td>
                <td>
                    ${lr.status === "pending"
                        ? `<button class="btn btn-success btn-sm" onclick="approveLeaveRequest('${lr.id}')">Onayla</button>
                           <button class="btn btn-danger btn-sm" onclick="rejectLeaveRequest('${lr.id}')">Reddet</button>`
                        : ''
                    }
                </td>
            </tr>
        `;
    });
}
function getLeaveTypeLabel(type) {
    switch(type) {
        case "annual": return "YÄ±llÄ±k Ä°zin";
        case "sick": return "HastalÄ±k Ä°zni";
        case "unpaid": return "Ãœcretsiz Ä°zin";
        default: return "DiÄŸer";
    }
}


// Ä°zin detay modalÄ± ve Ã§Ä±ktÄ± alma
function showLeaveDetailModal(id) {
    const lr = leaveRequests.find(l => l.id === id);
    if (!lr) return;
    const person = personnel.find(p => p.id === lr.personnelId);
    const statusLabel = lr.status === "approved" ? "OnaylandÄ±" : lr.status === "rejected" ? "Reddedildi" : "Beklemede";
    const approveInfo = lr.status === "approved"
        ? `<strong>Onaylayan:</strong> ${lr.approvedBy}<br><strong>Onay Tarihi:</strong> ${formatDate(lr.approvedAt)}`
        : lr.status === "rejected"
        ? `<strong>Reddeden:</strong> ${lr.rejectedBy}<br><strong>Red Tarihi:</strong> ${formatDate(lr.rejectedAt)}`
        : '';
    const modalHtml = `
        <div id="leaveDetailModal" class="modal active" style="display:flex;">
            <div class="modal-content" style="max-width:600px;">
                <div class="modal-header">
                    <h3>Ä°zin Talebi DetayÄ± ve Ã‡Ä±ktÄ±sÄ±</h3>
                    <button class="close-modal" onclick="closeLeaveDetailModal()">âœ–</button>
                </div>
                <div style="padding:20px;">
                    <table style="width:100%;margin-bottom:15px;">
                        <tr><td><strong>Personel:</strong></td><td>${person ? person.name : 'Bilinmiyor'}</td></tr>
                        <tr><td><strong>Ä°zin Tipi:</strong></td><td>${getLeaveTypeLabel(lr.type)}</td></tr>
                        <tr><td><strong>BaÅŸlangÄ±Ã§ Tarihi:</strong></td><td>${formatDate(lr.startDate)}</td></tr>
                        <tr><td><strong>BitiÅŸ Tarihi:</strong></td><td>${formatDate(lr.endDate)}</td></tr>
                        <tr><td><strong>AÃ§Ä±klama:</strong></td><td>${lr.description || '-'}</td></tr>
                        <tr><td><strong>Durum:</strong></td><td>${statusLabel}</td></tr>
                        <tr><td colspan="2">${approveInfo}</td></tr>
                    </table>
                    <div style="margin:30px 0 10px 0;text-align:center;">
                        <strong>Ä°mza:</strong>
                        <div style="border-bottom:1px solid #888;width:220px;margin:12px auto 0 auto;height:32px;"></div>
                    </div>
                    <div style="text-align:center;">
                        <button class="btn btn-success" onclick="printLeaveDetail('${lr.id}')">ğŸ–¨ï¸ Ã‡Ä±ktÄ± Al</button>
                        <button class="btn btn-secondary" onclick="closeLeaveDetailModal()">Kapat</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    // Modal ekle
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}
function closeLeaveDetailModal() {
    const modal = document.getElementById('leaveDetailModal');
    if (modal) modal.remove();
}
function printLeaveDetail(id) {
    const lr = leaveRequests.find(l => l.id === id);
    if (!lr) return;
    const person = personnel.find(p => p.id === lr.personnelId);
    const statusLabel = lr.status === "approved" ? "OnaylandÄ±" : lr.status === "rejected" ? "Reddedildi" : "Beklemede";
    const approveInfo = lr.status === "approved"
        ? `Onaylayan: ${lr.approvedBy}\nOnay Tarihi: ${formatDate(lr.approvedAt)}`
        : lr.status === "rejected"
        ? `Reddeden: ${lr.rejectedBy}\nRed Tarihi: ${formatDate(lr.rejectedAt)}`
        : '';
    const printHtml = `
        <html>
        <head>
            <title>Ä°zin Talebi Ã‡Ä±ktÄ±sÄ±</title>
            <meta charset="UTF-8">
            <style>
                body {font-family:Arial;padding:40px;}
                .header {font-size:1.6em;font-weight:700;margin-bottom:20px;}
                table {width:100%;margin-bottom:20px;}
                td {padding:6px;}
                .imza {margin-top:30px;}
                @media print {button {display:none !important;}}
            </style>
        </head>
        <body>
            <div class="header">Ä°zin Talebi Formu</div>
            <table>
                <tr><td><strong>Personel:</strong></td><td>${person ? person.name : 'Bilinmiyor'}</td></tr>
                <tr><td><strong>Ä°zin Tipi:</strong></td><td>${getLeaveTypeLabel(lr.type)}</td></tr>
                <tr><td><strong>BaÅŸlangÄ±Ã§ Tarihi:</strong></td><td>${formatDate(lr.startDate)}</td></tr>
                <tr><td><strong>BitiÅŸ Tarihi:</strong></td><td>${formatDate(lr.endDate)}</td></tr>
                <tr><td><strong>AÃ§Ä±klama:</strong></td><td>${lr.description || '-'}</td></tr>
                <tr><td><strong>Durum:</strong></td><td>${statusLabel}</td></tr>
                <tr><td colspan="2">${approveInfo}</td></tr>
            </table>
            <div class="imza">
                <strong>Ä°mza:</strong>
                <div style="border-bottom:1.5px solid #444;width:240px;height:32px;margin-top:20px;"></div>
            </div>
            <div style="text-align:center;margin-top:24px;">
                <button onclick="window.print()" style="padding:12px 40px;font-size:1.2em;">ğŸ–¨ï¸ YazdÄ±r</button>
                <button onclick="window.close()" style="padding:12px 40px;font-size:1.2em;margin-left:12px;">Kapat</button>
            </div>
        </body>
        </html>
    `;
    const win = window.open('', 'Ä°zinTalebi', 'width=800,height=600');
    win.document.write(printHtml);
}

// Personel paneli iÃ§in eriÅŸim (Ã¶rnek, sistemde oturum yoksa basit bir modal ile aÃ§Ä±labilir)
function openPersonnelLeavePanel(personnelId) {
    // Sadece kendi izinleri ve talep formu gÃ¶sterilecek
    const myLeaves = leaveRequests.filter(lr => lr.personnelId === personnelId);
    let leavesHtml = myLeaves.length === 0
        ? '<tr><td colspan="6" style="text-align:center;">HenÃ¼z talep yok.</td></tr>'
        : myLeaves.map(lr => `
            <tr>
                <td>${getLeaveTypeLabel(lr.type)}</td>
                <td>${formatDate(lr.startDate)} - ${formatDate(lr.endDate)}</td>
                <td>${lr.description || '-'}</td>
                <td><span class="badge badge-${lr.status === "approved" ? "success" : lr.status === "rejected" ? "danger" : "warning"}">
                    ${lr.status === "approved" ? "OnaylandÄ±" : lr.status === "rejected" ? "Reddedildi" : "Beklemede"}
                </span></td>
                <td>${lr.approvedBy || lr.rejectedBy || '-'}</td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="showLeaveDetailModal('${lr.id}')">Detay/Ã‡Ä±ktÄ±</button>
                </td>
            </tr>
        `).join('');
    const modalHtml = `
        <div id="personnelLeavePanelModal" class="modal active" style="display:flex;">
            <div class="modal-content" style="max-width:700px;">
                <div class="modal-header">
                    <h3>ğŸ‘¤ Personel Ä°zin Paneli</h3>
                    <button class="close-modal" onclick="closePersonnelLeavePanelModal()">âœ–</button>
                </div>
                <div style="padding:20px;">
                    <h4>Ä°zin Taleplerim</h4>
                    <table style="width:100%;margin-bottom:15px;">
                        <tr>
                            <th>Tip</th><th>Tarih</th><th>AÃ§Ä±klama</th><th>Durum</th><th>Onaylayan</th><th>Detay</th>
                        </tr>
                        ${leavesHtml}
                    </table>
                    <hr>
                    <h4>Yeni Ä°zin Talebi OluÅŸtur</h4>
                    <form onsubmit="submitPersonnelLeaveRequest(event, '${personnelId}')">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                            <div>
                                <label>Tip</label>
                                <select name="leaveType" required>
                                    <option value="">SeÃ§iniz</option>
                                    <option value="annual">YÄ±llÄ±k</option>
                                    <option value="sick">HastalÄ±k</option>
                                    <option value="unpaid">Ãœcretsiz</option>
                                    <option value="other">DiÄŸer</option>
                                </select>
                            </div>
                            <div>
                                <label>BaÅŸlangÄ±Ã§</label>
                                <input type="date" name="leaveStartDate" required>
                            </div>
                            <div>
                                <label>BitiÅŸ</label>
                                <input type="date" name="leaveEndDate" required>
                            </div>
                            <div>
                                <label>AÃ§Ä±klama</label>
                                <input type="text" name="leaveDescription">
                            </div>
                        </div>
                        <div style="margin-top:20px;text-align:right;">
                            <button type="submit" class="btn btn-primary">Talep OluÅŸtur</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}
function closePersonnelLeavePanelModal() {
    const modal = document.getElementById('personnelLeavePanelModal');
    if (modal) modal.remove();
}
function submitPersonnelLeaveRequest(event, personnelId) {
    event.preventDefault();
    const form = event.target;
    const leaveType = form.leaveType.value;
    const leaveStartDate = form.leaveStartDate.value;
    const leaveEndDate = form.leaveEndDate.value;
    const leaveDescription = form.leaveDescription.value;
    if (!leaveType || !leaveStartDate || !leaveEndDate) {
        alert("Eksik bilgi!");
        return;
    }
    leaveRequests.push({
        id: Date.now().toString(),
        personnelId: personnelId,
        type: leaveType,
        startDate: leaveStartDate,
        endDate: leaveEndDate,
        description: leaveDescription,
        status: "pending",
        approvedBy: "",
        approvedAt: "",
        rejectedBy: "",
        rejectedAt: "",
        createdAt: new Date().toISOString()
    });
    localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
    closePersonnelLeavePanelModal();
    alert("Ä°zin talebi oluÅŸturuldu. YÃ¶netici onayÄ±nÄ± bekleyin.");
}

// ========================================
// PERSONEL FONKSÄ°YONLARI
// ========================================

function openAddPersonnelModal() {
    document.getElementById('personnelForm').reset();
    document.getElementById('personnelId').value = '';
    document.getElementById('personnelFormModalTitle').textContent = 'â• Yeni Personel Ekle';
    document.getElementById('personnelFormModal').classList.add('active');
}

function closePersonnelFormModal() {
    document.getElementById('personnelFormModal').classList.remove('active');
}

async function savePersonnel(e) {
    e.preventDefault();
    
    if (!activeCompanyId) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce bir firma seÃ§in!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    const personnelId = document.getElementById('personnelId').value;
    const now = new Date().toISOString();
    
    try {
        const personnelData = {
            companyId: activeCompanyId,  // âœ… EKLE
            name: document.getElementById('personnelName').value,
            tcNo: document.getElementById('personnelTCNo').value,
            position: document.getElementById('personnelPosition').value,
            phone: document.getElementById('personnelPhone').value,
            salary: parseFloat(document.getElementById('personnelSalary').value),
            sgkRate: parseFloat(document.getElementById('personnelSGKRate').value),
            startDate: document.getElementById('personnelStartDate').value,
            status: document.getElementById('personnelStatus').value,
            address: document.getElementById('personnelAddress').value,
            updatedAt: now,
            updatedBy: auth.currentUser.uid
        };
        
        if (personnelId) {
            // Update
            await db.collection('companies').doc(activeCompanyId)
                .collection('personnel').doc(personnelId).update(personnelData);
            
            const person = personnel.find(p => p.id === personnelId);
            Object.assign(person, personnelData);
            
        } else {
            // Create
            personnelData.createdAt = now;
            personnelData.createdBy = auth.currentUser.uid;
            
            const newPersonnelRef = db.collection('companies').doc(activeCompanyId)
                .collection('personnel').doc();
            personnelData.id = newPersonnelRef.id;
            
            await newPersonnelRef.set(personnelData);
            personnel.push(personnelData);  // âœ… Local array'e ekle
        }
        
        closePersonnelFormModal();
        
        // âœ… RENDER FONKSÄ°YONLARINI Ã‡AÄIR
        await loadPersonnel();
        renderPersonnelTable();  // âœ… EKLE
        populatePersonnelSelects();  // âœ… EKLE
        populateYearPersonnelSelect();  // âœ… EKLE (yÄ±llÄ±k tablo iÃ§in)
        updatePersonnelStats();
        
        alert('âœ… Personel kaydedildi!');
        
    } catch (error) {
        console.error('Personel kayÄ±t hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

async function loadPersonnel() {
    if (!activeCompanyId || !auth.currentUser) {
        personnel = [];
        renderPersonnelTable();
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('personnel').get();
        
        personnel = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            personnel.push({ 
                id: doc.id, 
                ...data,
                companyId: data.companyId || activeCompanyId  // âœ… Fallback
            });
        });
        
        console.log('âœ… Personel yÃ¼klendi:', personnel.length);
        
    } catch (error) {
        console.error('âŒ Personel yÃ¼kleme hatasÄ±:', error);
        personnel = [];
    }
    
    renderPersonnelTable();  // âœ… EKLE
    populatePersonnelSelects();  // âœ… EKLE
}

async function loadAttendanceRecords() {
    if (!activeCompanyId || !auth.currentUser) {
        attendanceRecords = [];
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('attendance').get();
        
        attendanceRecords = [];
        snapshot.forEach(doc => {
            attendanceRecords.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('âœ… DevamsÄ±zlÄ±k kayÄ±tlarÄ± yÃ¼klendi:', attendanceRecords.length);
        
    } catch (error) {
        console.error('âŒ DevamsÄ±zlÄ±k yÃ¼kleme hatasÄ±:', error);
        attendanceRecords = [];
    }
}

async function loadLeaveRequests() {
    if (!activeCompanyId || !auth.currentUser) {
        leaveRequests = [];
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('leaveRequests').get();
        
        leaveRequests = [];
        snapshot.forEach(doc => {
            leaveRequests.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('âœ… Ä°zin talepleri yÃ¼klendi:', leaveRequests.length);
        
    } catch (error) {
        console.error('âŒ Ä°zin talebi yÃ¼kleme hatasÄ±:', error);
        leaveRequests = [];
    }
}

function editPersonnel(id) {
    const person = personnel.find(p => p.id === id);
    if (!person) return;
    
    document.getElementById('personnelId').value = person.id;
    document.getElementById('personnelName').value = person.name;
    document.getElementById('personnelTCNo').value = person.tcNo;
    document.getElementById('personnelPosition').value = person.position;
    document.getElementById('personnelPhone').value = person.phone || '';
    document.getElementById('personnelSalary').value = person.salary;
    document.getElementById('personnelSGKRate').value = person.sgkRate;
    document.getElementById('personnelStartDate').value = person.startDate;
    document.getElementById('personnelStatus').value = person.status;
    document.getElementById('personnelAddress').value = person.address || '';
    
    document.getElementById('personnelFormModalTitle').textContent = 'âœï¸ Personel DÃ¼zenle';
    document.getElementById('personnelFormModal').classList.add('active');
}

async function deletePersonnel(id) {
    if (!confirm('Bu personeli silmek istediÄŸinizden emin misiniz?')) return;
    
    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    try {
        await db.collection('companies').doc(activeCompanyId)
            .collection('personnel').doc(id).delete();
        
        personnel = personnel.filter(p => p.id !== id);
        
        await loadPersonnel();
        populatePersonnelSelects();
        updatePersonnelStats();
        
        alert('âœ… Personel silindi!');
        
    } catch (error) {
        console.error('Personel silme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

function populatePersonnelSelects() {
    const selectIds = [
        'attendancePersonnelSelect',
        'salaryPersonnelSelect',
        'yearPersonnelSelect'
    ];
    
    selectIds.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) {
            console.warn(`${selectId} elementi bulunamadÄ±!`);
            return;
        }
        
        // Ä°lk seÃ§eneÄŸi koru
        const firstOption = select.querySelector('option:first-child');
        const firstOptionHtml = firstOption ? firstOption.outerHTML : '<option value="">SeÃ§iniz</option>';
        
        select.innerHTML = firstOptionHtml;
        
        // Aktif personeli filtrele
        const activePersonnel = personnel.filter(p => 
            p.status === 'active' && 
            (!activeCompanyId || p.companyId === activeCompanyId)
        );
        
        activePersonnel.forEach(person => {
            const option = document.createElement('option');
            option.value = person.id;
            option.textContent = person.name;
            select.appendChild(option);
        });
        
        console.log(`âœ… ${selectId} dolduruldu:`, activePersonnel.length, 'personel');
    });
}

// Ay adÄ±nÄ± bulmak iÃ§in yardÄ±mcÄ± fonksiyon
function getMonthName(monthNum) {
    const months = ["Ocak","Åubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
    return months[parseInt(monthNum,10)-1];
}

// Toplam maliyeti hesapla ve gÃ¶ster
function updateSalaryTotalCost() {
    const ayVal = document.getElementById('salaryMonth').value; // YYYY-MM
    if (!ayVal) return;
    const ayAd = getMonthName(ayVal.split('-')[1]);
    const netMaas = parseFloat(document.getElementById('salaryNetInput').value) || 0;
    const ekKazanc = parseFloat(document.getElementById('salaryExtraInput').value) || 0;
    if (!salaryTableData[ayAd]) {
        document.getElementById('salaryTotalCostDisplay').value = 'CSV tablo yok!';
        return;
    }
    const hesap = hesaplaIsverenMaliyetiCSV(ayAd, netMaas, ekKazanc);
    if (hesap) {
        document.getElementById('salaryTotalCostDisplay').value = hesap.toplamIsveren.toFixed(2) + ' â‚º';
    } else {
        document.getElementById('salaryTotalCostDisplay').value = 'Hesaplama yok!';
    }
}

function updatePersonnelStats() {
    const activeCount = personnel.filter(p => p.status === 'active').length;
    const monthlySalary = personnel
        .filter(p => p.status === 'active')
        .reduce((sum, p) => sum + p.salary, 0);
    const monthlySGK = personnel
        .filter(p => p.status === 'active')
        .reduce((sum, p) => sum + (p.salary * p.sgkRate / 100), 0);
    
    // Bu ay izin gÃ¼nÃ¼ hesabÄ±
    const today = new Date();
    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    const monthlyLeaves = leaveRequests.filter(leave => {
        const leaveMonth = leave.startDate.substring(0, 7);
        return leaveMonth === currentMonth;
    });
    const totalLeaveDays = monthlyLeaves.reduce((sum, leave) => {
        const start = new Date(leave.startDate);
        const end = new Date(leave.endDate);
        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        return sum + days;
    }, 0);
    
    document.getElementById('activePersonnelCount').textContent = activeCount;
    document.getElementById('monthlySalaryTotal').textContent = formatCurrency(monthlySalary);
    document.getElementById('monthlySGKTotal').textContent = formatCurrency(monthlySGK);
    document.getElementById('monthlyLeaveCount').textContent = totalLeaveDays;
}

// ========================================
// DEVAMSIZLIK TAKÄ°BÄ°
// ========================================

function loadPersonnelAttendance() {
    const personnelId = document.getElementById('attendancePersonnelSelect').value;
    
    if (!personnelId) {
        document.getElementById('attendanceSection').style.display = 'none';
        return;
    }
    
    document.getElementById('attendanceSection').style.display = 'block';
    
    const today = new Date();
    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    
    const records = attendanceRecords.filter(r => 
        r.personnelId === personnelId && r.date.startsWith(currentMonth)
    );
    
    const recordsDiv = document.getElementById('attendanceRecords');
    recordsDiv.innerHTML = '';
    
    if (records.length === 0) {
        recordsDiv.innerHTML = '<p style="color:#6b7280;">Bu ay henÃ¼z kayÄ±t yok.</p>';
        return;
    }
    
    records.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    records.forEach(record => {
        const div = document.createElement('div');
        div.style.cssText = 'padding:10px; margin:5px 0; border-radius:6px; background:#f9fafb; border-left:4px solid ' + (record.status === 'present' ? 'var(--success)' : 'var(--danger)');
        div.innerHTML = `
            <strong>${formatDate(record.date)}</strong> - 
            <span style="color:${record.status === 'present' ? 'var(--success)' : 'var(--danger)'};">
                ${record.status === 'present' ? 'âœ… Geldi' : 'âŒ Gelmedi'}
            </span>
        `;
        recordsDiv.appendChild(div);
    });
}

async function markAttendance(status) {
    const personnelId = document.getElementById('attendancePersonnelSelect').value;
    if (!personnelId) return;
    
    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    const today = new Date().toISOString().split('T')[0];
    
    try {
        // BugÃ¼n iÃ§in kayÄ±t var mÄ± kontrol et
        const existingRecord = attendanceRecords.find(r => 
            r.personnelId === personnelId && r.date === today
        );
        
        if (existingRecord) {
            // Update
            existingRecord.status = status;
            existingRecord.updatedAt = new Date().toISOString();
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('attendance').doc(existingRecord.id).update({
                    status: status,
                    updatedAt: existingRecord.updatedAt
                });
        } else {
            // Create
            const newRecordRef = db.collection('companies').doc(activeCompanyId)
                .collection('attendance').doc();
            
            const newRecord = {
                id: newRecordRef.id,
                personnelId: personnelId,
                date: today,
                status: status,
                createdAt: new Date().toISOString(),
                createdBy: auth.currentUser.uid
            };
            
            await newRecordRef.set(newRecord);
            attendanceRecords.push(newRecord);
        }
        
        loadPersonnelAttendance();
        alert(`âœ… DevamsÄ±zlÄ±k kaydedildi: ${status === 'present' ? 'Geldi' : 'Gelmedi'}`);
        
    } catch (error) {
        console.error('DevamsÄ±zlÄ±k kayÄ±t hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

// ========================================
// Ä°ZÄ°N TALEPLERÄ°
// ========================================

function openLeaveRequestModal() {
    const personnelId = document.getElementById('attendancePersonnelSelect').value;
    if (!personnelId) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce personel seÃ§in!');
        return;
    }
    
    document.getElementById('leaveRequestForm').reset();
    document.getElementById('leaveRequestModal').classList.add('active');
}

function closeLeaveRequestModal() {
    document.getElementById('leaveRequestModal').classList.remove('active');
}

async function saveLeaveRequest(e) {
    e.preventDefault();
    
    if (!activeCompanyId) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce bir firma seÃ§in!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    const personnelId = document.getElementById('attendancePersonnelSelect').value;
    
    try {
        const newLeaveRef = db.collection('companies').doc(activeCompanyId)
            .collection('leaveRequests').doc();
        
        const leaveRequest = {
            id: newLeaveRef.id,
            personnelId: personnelId,
            type: document.getElementById('leaveType').value,
            startDate: document.getElementById('leaveStartDate').value,
            endDate: document.getElementById('leaveEndDate').value,
            description: document.getElementById('leaveDescription').value,
            status: 'pending',
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser.uid
        };
        
        await newLeaveRef.set(leaveRequest);
        leaveRequests.push(leaveRequest);
        
        closeLeaveRequestModal();
        updatePersonnelStats();
        
        alert('âœ… Ä°zin talebi oluÅŸturuldu!');
        
    } catch (error) {
        console.error('Ä°zin talebi kayÄ±t hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

async function approveLeaveRequest(id) {
    const lr = leaveRequests.find(l => l.id === id);
    if (!lr || lr.status !== "pending") return;
    
    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    try {
        const updatedData = {
            status: "approved",
            approvedBy: auth.currentUser.email,
            approvedAt: new Date().toISOString()
        };
        
        await db.collection('companies').doc(activeCompanyId)
            .collection('leaveRequests').doc(id).update(updatedData);
        
        Object.assign(lr, updatedData);
        
        loadLeaveRequestsAdminPanel();
        updatePersonnelStats();
        alert("âœ… Ä°zin talebi onaylandÄ±.");
        
    } catch (error) {
        console.error('Ä°zin onaylama hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

async function rejectLeaveRequest(id) {
    const lr = leaveRequests.find(l => l.id === id);
    if (!lr || lr.status !== "pending") return;
    
    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    try {
        const updatedData = {
            status: "rejected",
            rejectedBy: auth.currentUser.email,
            rejectedAt: new Date().toISOString()
        };
        
        await db.collection('companies').doc(activeCompanyId)
            .collection('leaveRequests').doc(id).update(updatedData);
        
        Object.assign(lr, updatedData);
        
        loadLeaveRequestsAdminPanel();
        updatePersonnelStats();
        alert("âœ… Ä°zin talebi reddedildi.");
        
    } catch (error) {
        console.error('Ä°zin reddetme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

// ========================================
// MAAÅ Ã–DEMELERÄ°
// ========================================

// MaaÅŸ Ã¶deme iÅŸleminde yeni mantÄ±k
async function processSalaryPayments() {
    const monthVal = document.getElementById('salaryMonth').value; // YYYY-MM
    if (!monthVal) {
        alert('âš ï¸ LÃ¼tfen ay seÃ§in!');
        return;
    }
    
    if (!activeCompanyId || !auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    const ayAd = getMonthName(monthVal.split('-')[1]);
    const personnelId = document.getElementById('salaryPersonnelSelect').value;
    let personnelToProcess = personnel.filter(p => p.status === 'active');
    
    if (personnelId) {
        personnelToProcess = personnelToProcess.filter(p => p.id === personnelId);
    }
    
    if (personnelToProcess.length === 0) {
        alert('âš ï¸ Ä°ÅŸlenecek personel yok!');
        return;
    }
    
    const netMaas = parseFloat(document.getElementById('salaryNetInput').value) || 0;
    const ekKazanc = parseFloat(document.getElementById('salaryExtraInput').value) || 0;
    
    if (!netMaas || !salaryTableData[ayAd]) {
        alert('âš ï¸ Net maaÅŸ ve CSV tablo gerekli!');
        return;
    }
    
    try {
        let processedCount = 0;
        const batch = db.batch();
        
        for (const person of personnelToProcess) {
            // Bu ay iÃ§in Ã¶deme yapÄ±lmÄ±ÅŸ mÄ± kontrol et
            const existingPayment = salaryPayments.find(sp =>
                sp.personnelId === person.id && sp.month === monthVal
            );
            
            if (existingPayment) continue;
            
            const hesap = hesaplaIsverenMaliyetiCSV(ayAd, netMaas, ekKazanc);
            
            const newPaymentRef = db.collection('companies').doc(activeCompanyId)
                .collection('salaryPayments').doc();
            
            const paymentData = {
                id: newPaymentRef.id,
                personnelId: person.id,
                month: monthVal,
                netSalary: netMaas,
                extraIncome: ekKazanc,
                totalEmployerCost: hesap.toplamIsveren,
                paidDate: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                createdBy: auth.currentUser.uid
            };
            
            batch.set(newPaymentRef, paymentData);
            salaryPayments.push(paymentData);
            processedCount++;
        }
        
        if (processedCount > 0) {
            await batch.commit();
        }
        
        await loadSalaryPayments();
        alert(`âœ… ${processedCount} personelin maaÅŸÄ± iÅŸlendi!`);
        
    } catch (error) {
        console.error('MaaÅŸ iÅŸleme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

async function handleSalaryCSVUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!activeCompanyId || !auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const content = e.target.result;
            const parsedData = parseSalaryCSV(content);
            salaryTableData = parsedData;
            
            // Firebase'e kaydet
            await db.collection('companies').doc(activeCompanyId)
                .collection('settings').doc('salaryTable').set({
                    tableData: parsedData,
                    uploadedAt: new Date().toISOString(),
                    uploadedBy: auth.currentUser.uid
                });
            
            document.getElementById('salaryTableStatus').textContent = 'âœ… CSV baÅŸarÄ±yla yÃ¼klendi ve kaydedildi!';
            
        } catch (error) {
            console.error('CSV yÃ¼kleme hatasÄ±:', error);
            alert('âŒ Hata: ' + error.message);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

async function loadSalaryPayments() {
    if (!activeCompanyId || !auth.currentUser) {
        salaryPayments = [];
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('salaryPayments').get();
        
        salaryPayments = [];
        snapshot.forEach(doc => {
            salaryPayments.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('âœ… MaaÅŸ Ã¶demeleri yÃ¼klendi:', salaryPayments.length);
        
        const tbody = document.querySelector('#salaryPaymentsTable tbody');
        if (tbody) {
            tbody.innerHTML = '';
            
            if (salaryPayments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">HenÃ¼z maaÅŸ Ã¶demesi yok.</td></tr>';
                return;
            }
            
            const sorted = [...salaryPayments].sort((a, b) => new Date(b.paidDate) - new Date(a.paidDate));
            
            sorted.forEach(payment => {
                const person = personnel.find(p => p.id === payment.personnelId);
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(payment.paidDate)}</td>
                    <td><strong>${person ? person.name : 'SilinmiÅŸ'}</strong></td>
                    <td>${formatCurrency(payment.netSalary)}</td>
                    <td>${formatCurrency(payment.extraIncome || 0)}</td>
                    <td style="color:var(--success); font-weight:700;">${formatCurrency(payment.totalEmployerCost)}</td>
                    <td><span class="badge badge-success">Ã–dendi</span></td>
                `;
            });
        }
        
    } catch (error) {
        console.error('âŒ MaaÅŸ Ã¶demesi yÃ¼kleme hatasÄ±:', error);
        salaryPayments = [];
    }
}

async function loadSalaryTable() {
    if (!activeCompanyId || !auth.currentUser) {
        salaryTableData = {};
        return;
    }
    
    try {
        const doc = await db.collection('companies').doc(activeCompanyId)
            .collection('settings').doc('salaryTable').get();
        
        if (doc.exists) {
            salaryTableData = doc.data().tableData || {};
            console.log('âœ… MaaÅŸ tablosu yÃ¼klendi');
        } else {
            salaryTableData = {};
            console.log('â„¹ï¸ MaaÅŸ tablosu bulunamadÄ±');
        }
        
    } catch (error) {
        console.error('âŒ MaaÅŸ tablosu yÃ¼kleme hatasÄ±:', error);
        salaryTableData = {};
    }
}

// CSV Ã¶rneÄŸi indirme
function downloadSalaryExample() {
    const csv = `Ay;BrÃ¼t;SSK Ä°ÅŸÃ§i;Ä°ÅŸsizlik Ä°ÅŸÃ§i;AylÄ±k Gelir Vergisi;Damga Vergisi;KÃ¼mÃ¼latif Toplam;Net;AGÄ°;Toplam Net Ele GeÃ§en;SSK Ä°ÅŸveren;Ä°ÅŸsizlik Ä°ÅŸveren;Toplam Maliyet;Asgari Ãœcret Gelir Vergisi Ä°stisnasÄ±;Asgari Ãœcret Damga Vergisi Ä°stisnasÄ±
Ocak;45000;6300;450;5737,5;341,55;38250;32170,95;0;35684,03;9337,5;900;55237,5;3315,7;197,38
Åubat;45000;6300;450;5737,5;341,55;76500;32170,95;0;35684,03;9337,5;900;55237,5;3315,7;197,38
Mart;45000;6300;450;5737,5;341,55;114750;32170,95;0;35684,03;9337,5;900;55237,5;3315,7;197,38
...`; // TÃ¼m aylar iÃ§in doldurabilirsin
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `maas-tablosu-ornegi.csv`;
    link.click();
    URL.revokeObjectURL(url);
}

function normalizeMonthName(raw) {
    const map = {
        " ubat": "Åubat",
        "Mart": "Mart",
        "Nisan": "Nisan",
        "May s": "MayÄ±s",
        "Haziran": "Haziran",
        "Temmuz": "Temmuz",
        "A ustos": "AÄŸustos",
        "Eyl l": "EylÃ¼l",
        "Ekim": "Ekim",
        "Kas m": "KasÄ±m",
        "Aral k": "AralÄ±k",
        "Ocak": "Ocak"
    };
    let clean = raw.trim();
    return map[clean] || clean;
}

// CSV parsing fonksiyonu
function parseSalaryCSV(content) {
    const lines = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
    let header = null;
    let result = {};
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const parts = line.split(';');
        // Header satÄ±rÄ±nÄ± bul
        if (!header && parts[0].match(/Ay|Ocak|Åubat|Mart|Nisan|MayÄ±s|Haziran|Temmuz|AÄŸustos|EylÃ¼l|Ekim|KasÄ±m|AralÄ±k| ubat|May s|A ustos|Eyl l|Kas m|Aral k/)) {
            header = parts;
            continue;
        }
        // Data satÄ±rÄ±
        if (header && parts.length === header.length) {
            const ayRaw = parts[0];
            const ay = normalizeMonthName(ayRaw);
            result[ay] = {};
            for (let j = 1; j < header.length; j++) {
                const key = header[j].replace(/\s+/g, '_').toLowerCase();
                const val = parts[j].replace(',', '.');
                result[ay][key] = parseFloat(val) || 0;
            }
        }
    }
    return result;
}

// MaaÅŸ Ã¶deme/hesaplama fonksiyonu (ay, net maaÅŸ, ek kazanÃ§)
function hesaplaIsverenMaliyetiCSV(ay, netMaas, ekKazanc) {
    if (!salaryTableData[ay]) return null;
    // CSV'den tablodaki net ve iÅŸveren maliyeti
    const data = salaryTableData[ay];
    const tablonet = data.net;
    const tabloisveren = data.toplam_maliyet || data['toplam_maliyet'];
    // Oranla: Net maaÅŸ farklÄ±ysa, iÅŸveren maliyetini orantÄ±la
    const oran = netMaas / tablonet;
    const toplamIsveren = tabloisveren * oran + (ekKazanc || 0);
    return {
        netMaas: netMaas,
        ekKazanc: ekKazanc || 0,
        toplamIsveren: toplamIsveren,
        tabloSatir: data
    };
}

function populateYearPersonnelSelect() {
    const select = document.getElementById('yearPersonnelSelect');
    if (!select) {
        console.warn('yearPersonnelSelect elementi bulunamadÄ±!');
        return;
    }
    
    // Temizle
    select.innerHTML = '';
    
    // Sadece aktif personeli gÃ¶ster
    const activePersonnel = personnel.filter(p => 
        p.status === 'active' && 
        (!activeCompanyId || p.companyId === activeCompanyId)
    );
    
    if (activePersonnel.length === 0) {
        select.innerHTML = '<option value="">Personel yok</option>';
        return;
    }
    
    // Ä°lk seÃ§enek
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Personel SeÃ§in';
    select.appendChild(defaultOption);
    
    // Personel seÃ§enekleri
    activePersonnel.forEach(person => {
        const option = document.createElement('option');
        option.value = person.id;
        option.textContent = person.name;
        select.appendChild(option);
    });
    
    console.log('âœ… yearPersonnelSelect dolduruldu:', activePersonnel.length, 'personel');
}

// MaaÅŸ deÄŸiÅŸiklikleri Ã¶rnek veri (personel objesinde salaryHistory alanÄ± olmalÄ±!)
/*
personnel = [{
    id: "123",
    name: "Ali Veli",
    startDate: "2025-03-15",
    salaryHistory: [
        { from: "2025-03", net: 32000 },
        { from: "2025-07", net: 35000 }
    ],
    // ...
}]
*/

// YÄ±llÄ±k tablo render fonksiyonu
function renderYearlySalaryTable() {
    const year = document.getElementById('yearSalarySelect').value;
    const personnelId = document.getElementById('yearPersonnelSelect').value;
    const person = personnel.find(p => p.id === personnelId);
    if (!person || !salaryTableData) {
        document.getElementById('yearlySalaryTableSection').innerHTML = '<div class="alert alert-danger">Personel veya maaÅŸ tablosu eksik!</div>';
        return;
    }

    // Ä°ÅŸe baÅŸlama tarihi
    const startDate = new Date(person.startDate);
    const startYear = startDate.getFullYear();
    const startMonth = startDate.getMonth() + 1;

    // MaaÅŸ deÄŸiÅŸikliklerini sÄ±rala
    const salaryHistory = person.salaryHistory || [{ from: `${startYear}-${String(startMonth).padStart(2, '0')}`, net: person.salary }];
    salaryHistory.sort((a, b) => a.from.localeCompare(b.from));

    // Aylar
    const aylar = ['01','02','03','04','05','06','07','08','09','10','11','12'];
    let rows = '';
    let currentNet = null;
    let historyIdx = 0;

    for (let i = 0; i < aylar.length; i++) {
        const ayNum = aylar[i];
        const ayAd = getMonthName(ayNum);
        const ayLabel = `${ayAd} ${year}`;
        const monthStr = `${year}-${ayNum}`;
        const ayStartDate = new Date(`${year}-${ayNum}-01`);

        // Ä°ÅŸe baÅŸlama Ã¶ncesi aylar
        if (ayStartDate < startDate) {
            rows += `<tr style="background:#f3f4f6;color:#888;">
                <td>${ayLabel}</td>
                <td colspan="6" style="text-align:center;">Ã‡alÄ±ÅŸmadÄ±</td>
            </tr>`;
            continue;
        }

        // MaaÅŸ deÄŸiÅŸikliÄŸi kontrolÃ¼
        while (historyIdx < salaryHistory.length && salaryHistory[historyIdx].from <= monthStr) {
            currentNet = salaryHistory[historyIdx].net;
            historyIdx++;
        }

        // Ek kazanÃ§ ve dekontlar localStorage'da
        const dekontKey = `salaryReceipt_${person.id}_${monthStr}`;
        const dekontData = JSON.parse(localStorage.getItem(dekontKey) || 'null');
        const ekKazancKey = `salaryExtra_${person.id}_${monthStr}`;
        const ekKazanc = parseFloat(localStorage.getItem(ekKazancKey) || '0');

        // Toplam maliyet hesapla
        const ayCSV = salaryTableData[ayAd];
        let toplamMaaliyet = ayCSV && ayCSV.net ? (ayCSV.toplam_maliyet * (currentNet / ayCSV.net) + ekKazanc) : 0;

        // Durum ve Ã¶deme tarihi
        const durum = dekontData ? '<span class="badge badge-success">Ã–dendi</span>' : '<span class="badge badge-danger">Ã–denmedi</span>';
        const odemeTarihi = dekontData ? formatDate(dekontData.uploadDate) : '-';

        // Dekont alanÄ±
        const dekontHtml = dekontData
            ? `<button class="btn btn-info btn-sm" onclick="viewSalaryReceipt('${person.id}','${monthStr}')">GÃ¶rÃ¼ntÃ¼le</button>`
            : `<input type="file" onchange="uploadSalaryReceipt(event,'${person.id}','${monthStr}')">`;

        rows += `<tr>
            <td>${ayLabel}</td>
            <td>${currentNet ? formatCurrency(currentNet) : '-'}</td>
            <td>
                <input type="number" min="0" step="0.01" style="width:90px;" value="${ekKazanc}" onchange="saveSalaryExtra(this.value,'${person.id}','${monthStr}')">
            </td>
            <td>${toplamMaaliyet ? formatCurrency(toplamMaaliyet) : '-'}</td>
            <td>${durum}</td>
            <td>${dekontHtml}</td>
            <td>${odemeTarihi}</td>
        </tr>`;
    }

    // Tablo template
    const html = `
        <table>
            <thead>
                <tr>
                    <th>Ay</th>
                    <th>Net MaaÅŸ</th>
                    <th>Ek KazanÃ§</th>
                    <th>Toplam Maliyet</th>
                    <th>Durum</th>
                    <th>Dekont</th>
                    <th>Ã–deme Tarihi</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
    document.getElementById('yearlySalaryTableSection').innerHTML = html;
}

// Ek kazancÄ± kaydet
function saveSalaryExtra(val, personId, monthStr) {
    localStorage.setItem(`salaryExtra_${personId}_${monthStr}`, val);
    renderYearlySalaryTable();
}

// Dekont yÃ¼kleme
function uploadSalaryReceipt(event, personId, monthStr) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = {
            base64: e.target.result,
            uploadDate: new Date().toISOString()
        };
        localStorage.setItem(`salaryReceipt_${personId}_${monthStr}`, JSON.stringify(data));
        renderYearlySalaryTable();
    };
    reader.readAsDataURL(file);
}

// Dekont gÃ¶rÃ¼ntÃ¼leme
function viewSalaryReceipt(personId, monthStr) {
    const key = `salaryReceipt_${personId}_${monthStr}`;
    const data = JSON.parse(localStorage.getItem(key));
    if (!data) return;
    const modalHtml = `
        <div id="salaryReceiptModal" class="modal active" style="display:flex;">
            <div class="modal-content" style="max-width:700px;">
                <div class="modal-header">
                    <h3>Dekont GÃ¶rÃ¼ntÃ¼le</h3>
                    <button class="close-modal" onclick="closeSalaryReceiptModal()">âœ–</button>
                </div>
                <div style="padding:20px;text-align:center;">
                    <img src="${data.base64}" style="max-width:100%;border-radius:8px;">
                    <div style="margin-top:18px;color:#888;">YÃ¼kleme tarihi: ${formatDate(data.uploadDate)}</div>
                </div>
            </div>
        </div>
    `;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closeSalaryReceiptModal() {
    const modal = document.getElementById('salaryReceiptModal');
    if (modal) modal.remove();
}

// Sayfa yÃ¼klendiÄŸinde kullanÄ±cÄ± kontrolÃ¼
auth.onAuthStateChanged((user) => {
    if (user) {
        // KullanÄ±cÄ± giriÅŸ yapmÄ±ÅŸ
        document.getElementById('authModal').style.display = 'none';
        initializeApp(user);
    } else {
        // KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ
        document.getElementById('authModal').style.display = 'flex';
    }
});

// KayÄ±t olma
async function registerUser() {
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    
    if (!name || !email || !password) {
        alert('âš ï¸ TÃ¼m alanlarÄ± doldurun!');
        return;
    }
    
    if (password.length < 6) {
        alert('âš ï¸ Åifre en az 6 karakter olmalÄ±!');
        return;
    }
    
    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // KullanÄ±cÄ± profilini Firestore'a kaydet
        await db.collection('users').doc(user.uid).set({
            name: name,
            email: email,
            role: 'admin', // Ä°lk kullanÄ±cÄ± admin
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            companies: []
        });
        
        alert('âœ… KayÄ±t baÅŸarÄ±lÄ±! HoÅŸ geldiniz.');
    } catch (error) {
        console.error('KayÄ±t hatasÄ±:', error);
        if (error.code === 'auth/email-already-in-use') {
            alert('âš ï¸ Bu email zaten kullanÄ±mda!');
        } else {
            alert('âŒ KayÄ±t hatasÄ±: ' + error.message);
        }
    }
}

// GiriÅŸ yapma
async function loginUser() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        alert('âš ï¸ Email ve ÅŸifre gerekli!');
        return;
    }
    
    try {
        await auth.signInWithEmailAndPassword(email, password);
        alert('âœ… GiriÅŸ baÅŸarÄ±lÄ±!');
    } catch (error) {
        console.error('GiriÅŸ hatasÄ±:', error);
        if (error.code === 'auth/user-not-found') {
            alert('âš ï¸ KullanÄ±cÄ± bulunamadÄ±!');
        } else if (error.code === 'auth/wrong-password') {
            alert('âš ï¸ YanlÄ±ÅŸ ÅŸifre!');
        } else {
            alert('âŒ GiriÅŸ hatasÄ±: ' + error.message);
        }
    }
}

// Google ile giriÅŸ
async function loginWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    
    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        // Ä°lk giriÅŸse Firestore'a kaydet
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (!userDoc.exists) {
            await db.collection('users').doc(user.uid).set({
                name: user.displayName,
                email: user.email,
                role: 'admin',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                companies: []
            });
        }
        
        alert('âœ… Google giriÅŸi baÅŸarÄ±lÄ±!');
    } catch (error) {
        console.error('Google giriÅŸ hatasÄ±:', error);
        alert('âŒ Google giriÅŸ hatasÄ±: ' + error.message);
    }
}

// Ã‡Ä±kÄ±ÅŸ yapma
async function logoutUser() {
    if (confirm('Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?')) {
        await auth.signOut();
        location.reload();
    }
}

// Form deÄŸiÅŸtirme
function toggleAuthMode() {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const title = document.getElementById('authTitle');
    
    if (loginForm.style.display === 'none') {
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        title.textContent = 'ğŸ” GiriÅŸ Yap';
    } else {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        title.textContent = 'ğŸ“ KayÄ±t Ol';
    }
}

async function initializeApp(user) {
    if (!user) {
        console.error('User undefined!');
        return;
    }
    
    console.log('ğŸ”„ Veriler Firebase\'den yÃ¼kleniyor...');
    
    try {
        // 1. Tarih inputlarÄ±nÄ± bugÃ¼ne ayarla (Ã¶nce UI hazÄ±rla)
        const today = new Date();
        if (document.getElementById('invoiceDate')) {
            document.getElementById('invoiceDate').valueAsDate = today;
        }
        if (document.getElementById('paymentDate')) {
            document.getElementById('paymentDate').valueAsDate = today;
        }
        if (document.getElementById('purchaseDate')) {
            document.getElementById('purchaseDate').valueAsDate = today;
        }
        
        const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        if (document.getElementById('salaryMonth')) {
            document.getElementById('salaryMonth').value = currentMonth;
        }
        
        // 2. KullanÄ±cÄ± profilini yÃ¼kle
        await loadUserData(user.uid);
        
        // 3. KullanÄ±cÄ±nÄ±n firmalarÄ±nÄ± yÃ¼kle
        await loadCompanies();
        
        // 4. Aktif firma yoksa ve firma varsa, ilkini aktif yap
        if (!activeCompanyId && companies.length > 0) {
            activeCompanyId = companies[0].id;
        }
        
        // 5. TÃ¼m verileri paralel yÃ¼kle
        await Promise.all([
            loadAccounts(),
            loadInvoices(),
            loadPayments(),
            loadPurchases(),
            loadPersonnel(),
            loadAttendanceRecords(),
            loadLeaveRequests(),
            loadSalaryPayments(),
            loadSalaryTable(),
            loadProposals() // âœ… TEKLÄ°FLER
        ]);
        
        // 6. UI'Ä± gÃ¼ncelle
        updateDashboard();
        populateSelects();
        populatePersonnelSelects();
        
        // 7. Form handlers'Ä± kur
        setupFormHandlers();
        
        // 8. Google API baÅŸlat
        gapiLoaded();
        gisLoaded();
        
        console.log('âœ… TÃ¼m veriler Firebase\'den yÃ¼klendi!');
        
    } catch (error) {
        console.error('âŒ BaÅŸlatma hatasÄ±:', error);
        throw error;
    }
}

// KullanÄ±cÄ± verilerini yÃ¼kle
async function loadUserData(userId) {
    try {
        const userDoc = await db.collection('users').doc(userId).get();
        const userData = userDoc.data();
        
        if (!userData) {
            console.warn('KullanÄ±cÄ± verisi bulunamadÄ±!');
            return;
        }
        
        console.log('âœ… KullanÄ±cÄ± bilgileri yÃ¼klendi:', userData.name);
        
        // Header'a kullanÄ±cÄ± adÄ± ekle
        const header = document.querySelector('.header');
        const existingUserInfo = header.querySelector('.user-info');
        if (existingUserInfo) {
            existingUserInfo.remove();
        }
        
        const userInfo = document.createElement('div');
        userInfo.className = 'user-info';
        userInfo.style.cssText = 'position:absolute; top:20px; right:20px; display:flex; align-items:center; gap:10px;';
        userInfo.innerHTML = `
            <span style="color:white; font-weight:600;">ğŸ‘¤ ${userData.name}</span>
            <button class="btn btn-sm" onclick="logoutUser()" style="background:rgba(255,255,255,0.2); color:white;">Ã‡Ä±kÄ±ÅŸ</button>
        `;
        header.style.position = 'relative';
        header.appendChild(userInfo);
        
        return userData;
        
    } catch (error) {
        console.error('âŒ KullanÄ±cÄ± verisi yÃ¼kleme hatasÄ±:', error);
        throw error;
    }
}

function handleInvoiceReceipt(input) {
    const file = input.files[0];
    if (!file) {
        currentInvoiceReceipt = null;
        document.getElementById('invoiceReceiptPreview').innerHTML = '';
        return;
    }
    
    // Boyut kontrolÃ¼ (5 MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('âš ï¸ Dekont boyutu 5 MB\'dan kÃ¼Ã§Ã¼k olmalÄ±dÄ±r!');
        input.value = '';
        return;
    }
    
    currentInvoiceReceipt = file;
    
    const preview = document.getElementById('invoiceReceiptPreview');
    
    if (file.type.includes('image')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <div style="border: 2px solid var(--success); padding: 10px; border-radius: 8px; background: white;">
                    <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        ğŸ“„ ${file.name} (${formatFileSize(file.size)})
                    </p>
                    <button type="button" onclick="clearInvoiceReceipt()" class="btn btn-danger btn-sm" style="margin-top:5px;">âœ– KaldÄ±r</button>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = `
            <div style="border: 2px solid var(--success); padding: 15px; border-radius: 8px; background: white; text-align:center;">
                <div style="font-size: 3em;">ğŸ“„</div>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                    ${file.name} (${formatFileSize(file.size)})
                </p>
                <button type="button" onclick="clearInvoiceReceipt()" class="btn btn-danger btn-sm" style="margin-top:5px;">âœ– KaldÄ±r</button>
            </div>
        `;
    }
}

function clearInvoiceReceipt() {
    currentInvoiceReceipt = null;
    document.getElementById('invoiceReceipt').value = '';
    document.getElementById('invoiceReceiptPreview').innerHTML = '';
}

function viewInvoiceReceipt(invoiceId) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    
    if (!invoice || !invoice.receiptUrl) {
        alert('âš ï¸ Bu faturaya ait dekont yok!');
        return;
    }
    
    const isPDF = invoice.receiptUrl.toLowerCase().includes('.pdf');
    
    const modalHtml = `
        <div id="invoiceReceiptModal" class="modal active" style="display:flex;">
            <div class="modal-content" style="max-width:900px;">
                <div class="modal-header">
                    <h3>ğŸ“ Fatura Dekont - ${invoice.invoiceNo}</h3>
                    <button class="close-modal" onclick="closeInvoiceReceiptModal()">âœ–</button>
                </div>
                <div style="padding:20px; text-align:center;">
                    ${isPDF 
                        ? `<iframe src="${invoice.receiptUrl}" style="width:100%; height:600px; border:none; border-radius:8px;"></iframe>`
                        : `<img src="${invoice.receiptUrl}" style="max-width:100%; border-radius:8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">`
                    }
                    <div style="margin-top:20px;">
                        <a href="${invoice.receiptUrl}" target="_blank" class="btn btn-primary" download>
                            ğŸ“¥ Ä°ndir
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closeInvoiceReceiptModal() {
    const modal = document.getElementById('invoiceReceiptModal');
    if (modal) modal.remove();
}

function populateCompanySelects() {
    // âœ… Sadece aktif firma dropdown'Ä±nÄ± gÃ¼ncelle
    const activeCompanySelect = document.getElementById('activeCompanySelect');
    if (activeCompanySelect) {
        const currentValue = activeCompanySelect.value;
        activeCompanySelect.innerHTML = '<option value="">Firma SeÃ§iniz</option>';
        
        companies.forEach(company => {
            const option = new Option(company.name, company.id);
            activeCompanySelect.add(option);
        });
        
        if (activeCompanyId) {
            activeCompanySelect.value = activeCompanyId;
        } else if (currentValue) {
            activeCompanySelect.value = currentValue;
        }
    }
    
    // âœ… Filtre dropdown'Ä±nÄ± gÃ¼ncelle
    const filterSelect = document.getElementById('filterAccountCompany');
    if (filterSelect) {
        const currentValue = filterSelect.value;
        filterSelect.innerHTML = '<option value="">TÃ¼m Firmalar</option>';
        
        companies.forEach(company => {
            const option = new Option(company.name, company.id);
            filterSelect.add(option);
        });
        
        if (activeCompanyId) {
            filterSelect.value = activeCompanyId;
        } else if (currentValue) {
            filterSelect.value = currentValue;
        }
    }
    
    // âœ… Cari hesap firma dropdown'Ä±nÄ± gÃ¼ncelle
    const accountCompanySelect = document.getElementById('accountCompany');
    if (accountCompanySelect) {
        const currentValue = accountCompanySelect.value;
        accountCompanySelect.innerHTML = '<option value="">Firma SeÃ§iniz</option>';
        
        companies.forEach(company => {
            const option = new Option(company.name, company.id);
            accountCompanySelect.add(option);
        });
        
        // Aktif firma varsa otomatik seÃ§
        if (activeCompanyId && !currentValue) {
            accountCompanySelect.value = activeCompanyId;
            updateAccountCompanyInfo();
        } else if (currentValue) {
            accountCompanySelect.value = currentValue;
        }
    }
}

function closeCompanyModal() {
    const modal = document.getElementById('companyModal');
    if (modal) {
        modal.classList.remove('active');
    }
    
    // Formu temizle
    document.getElementById('companyForm').reset();
    document.getElementById('companyId').value = '';
    companyDocuments = [];
    
    // DÃ¶kÃ¼man Ã¶nizlemesini temizle
    const docContainer = document.getElementById('companyDocumentsContainer');
    if (docContainer) {
        docContainer.innerHTML = '';
    }
}

function renderCompanyDocuments() {
    const container = document.getElementById('companyDocumentsContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (companyDocuments.length === 0) {
        container.innerHTML = '<p style="color:#6b7280; text-align:center; padding:20px;">HenÃ¼z dÃ¶kÃ¼man eklenmedi</p>';
        return;
    }
    
    companyDocuments.forEach((doc, index) => {
        const docDiv = document.createElement('div');
        docDiv.style.cssText = 'border:1px solid #e5e7eb; padding:10px; border-radius:5px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;';
        docDiv.innerHTML = `
            <div>
                <strong>${doc.name}</strong>
                <div style="font-size:0.85em; color:#6b7280;">${formatFileSize(doc.fileSize)}</div>
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeCompanyDocument(${index})">ğŸ—‘ï¸</button>
        `;
        container.appendChild(docDiv);
    });
}

function removeCompanyDocument(index) {
    companyDocuments.splice(index, 1);
    renderCompanyDocuments();
}

function setupFormHandlers() {
    const companyForm = document.getElementById('companyForm');
    if (companyForm && typeof saveCompany === 'function') {
        companyForm.removeEventListener('submit', saveCompany);
        companyForm.addEventListener('submit', saveCompany);
    }
    
    const accountForm = document.getElementById('accountForm');
    if (accountForm && typeof saveAccount === 'function') {
        accountForm.removeEventListener('submit', saveAccount);
        accountForm.addEventListener('submit', saveAccount);
    }
    
    const invoiceForm = document.getElementById('invoiceForm');
    if (invoiceForm && typeof saveInvoice === 'function') {
        invoiceForm.removeEventListener('submit', saveInvoice);
        invoiceForm.addEventListener('submit', saveInvoice);
    }
    
    const paymentForm = document.getElementById('paymentForm');
    if (paymentForm && typeof savePayment === 'function') {
        paymentForm.removeEventListener('submit', savePayment);
        paymentForm.addEventListener('submit', savePayment);
    }
    
    const purchaseForm = document.getElementById('purchaseForm');
    if (purchaseForm && typeof savePurchase === 'function') {
        purchaseForm.removeEventListener('submit', savePurchase);
        purchaseForm.addEventListener('submit', savePurchase);
    }
    
    const personnelForm = document.getElementById('personnelForm');
    if (personnelForm && typeof savePersonnel === 'function') {
        personnelForm.removeEventListener('submit', savePersonnel);
        personnelForm.addEventListener('submit', savePersonnel);
    }
    
    const editPaymentForm = document.getElementById('editPaymentForm');
    if (editPaymentForm && typeof updatePayment === 'function') {
        editPaymentForm.removeEventListener('submit', updatePayment);
        editPaymentForm.addEventListener('submit', updatePayment);
    }
    
    console.log('âœ… Form handlers kuruldu');
}

// ========================================
// Ã–DEME DÃœZENLEME FONKSÄ°YONLARI
// ========================================

function loadEditPaymentInvoices() {
    const accountId = document.getElementById('editPaymentAccount').value;
    const select = document.getElementById('editPaymentInvoice');
    
    select.innerHTML = '<option value="">Genel Ã–deme (Fatura Yok)</option>';
    
    if (!accountId) return;
    
    // Bu cari hesaba ait Ã¶denmemiÅŸ veya kÄ±smi Ã¶denmiÅŸ faturalarÄ± getir
    const accountInvoices = invoices.filter(inv => {
        const remaining = inv.total - (inv.paidAmount || 0);
        return inv.accountId === accountId && remaining > 0;
    });
    
    accountInvoices.forEach(invoice => {
        const remaining = invoice.total - (invoice.paidAmount || 0);  // âœ… DÃœZELT
        const typeIcon = invoice.type === 'sales' ? 'ğŸ“¤' : 'ğŸ“¥';
        const option = new Option(
            `${typeIcon} ${invoice.invoiceNo} - ${formatCurrency(remaining)} kalan`,
            invoice.id
        );
        select.add(option);
    });
    
    console.log(`âœ… ${accountInvoices.length} fatura yÃ¼klendi (editPayment)`);
}

async function saveCompany(e) {
    e.preventDefault();
    
    if (!auth.currentUser) {
        alert('âš ï¸ LÃ¼tfen Ã¶nce giriÅŸ yapÄ±n!');
        return;
    }
    
    const companyId = document.getElementById('companyId').value;
    const now = new Date().toISOString();
    const validDocs = companyDocuments.filter(doc => doc.name && doc.file);
    
    try {
        let companyData;
        
        if (companyId) {
            // Update existing company
            const company = companies.find(c => c.id === companyId);
            
            // DÃ¶kÃ¼manlarÄ± Storage'a yÃ¼kle
            const uploadedDocs = await uploadCompanyDocuments(companyId, validDocs);
            
            const updatedData = {
                name: document.getElementById('companyName').value,
                sector: document.getElementById('companySector').value,
                taxNo: document.getElementById('companyTaxNo').value,
                taxOffice: document.getElementById('companyTaxOffice').value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail').value,
                website: document.getElementById('companyWebsite').value,
                address: document.getElementById('companyAddress').value,
                documents: uploadedDocs,
                updatedAt: now,
                updatedBy: auth.currentUser.uid
            };
            
            await db.collection('companies').doc(companyId).update(updatedData);
            
            Object.assign(company, updatedData);
            companyData = company;
            
        } else {
            // Create new company
            const newCompanyRef = db.collection('companies').doc();
            const newCompanyId = newCompanyRef.id;
            
            // DÃ¶kÃ¼manlarÄ± Storage'a yÃ¼kle
            const uploadedDocs = await uploadCompanyDocuments(newCompanyId, validDocs);
            
            const newCompany = {
                id: newCompanyId,
                name: document.getElementById('companyName').value,
                sector: document.getElementById('companySector').value,
                taxNo: document.getElementById('companyTaxNo').value,
                taxOffice: document.getElementById('companyTaxOffice').value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail').value,
                website: document.getElementById('companyWebsite').value,
                address: document.getElementById('companyAddress').value,
                documents: uploadedDocs,
                createdAt: now,
                createdBy: auth.currentUser.uid,
                updatedAt: now,
                updatedBy: auth.currentUser.uid
            };
            
            await newCompanyRef.set(newCompany);
            
            // KullanÄ±cÄ±nÄ±n firma listesine ekle
            await db.collection('users').doc(auth.currentUser.uid).update({
                companies: firebase.firestore.FieldValue.arrayUnion(newCompanyId)
            });
            
            companies.push(newCompany);
            
            // Ä°lk firma ise aktif yap
            if (!activeCompanyId) {
                activeCompanyId = newCompanyId;
            }
            
            companyData = newCompany;
        }
        
        document.getElementById('companyForm').reset();
        document.getElementById('companyId').value = '';
        companyDocuments = [];
        renderCompanyDocuments();
        closeCompanyFormModal();
        
        await loadCompanies();
        populateCompanySelects();
        
        alert('âœ… Firma baÅŸarÄ±yla kaydedildi!');
        
    } catch (error) {
        console.error('Firma kayÄ±t hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}


// ===============================
// TEKRAR EDEN KAYIT ENGELLEME MODÃœLÃœ
// ===============================

// Ã–deme duplicate kontrolÃ¼ - sadece aktif kayÄ±tlar!
function getPaymentUniqueKey(payment) {
    const time = payment.date + " " + (payment.time || "00:00:00");
    return `${time}_${payment.amount}_${payment.accountId}_${payment.referenceCode || ""}`;
}

function isDuplicatePayment(payment, paymentsArray) {
    const key = getPaymentUniqueKey(payment);
    // Sadece aktif Ã¶deme kayÄ±tlarÄ±!
    return paymentsArray
        .filter(p => !p.status || (p.status !== "deleted" && p.status !== "passive"))
        .some(existing => getPaymentUniqueKey(existing) === key);
}

// Fatura duplicate kontrolÃ¼ - sadece aktif kayÄ±tlar!
function getInvoiceUniqueKey(invoice) {
    return `${invoice.invoiceNo}_${invoice.date}_${invoice.total}`;
}

function isDuplicateInvoice(invoice, invoicesArray) {
    const key = getInvoiceUniqueKey(invoice);
    return invoicesArray
        .filter(inv => !inv.status || (inv.status !== "deleted" && inv.status !== "passive"))
        .some(existing => getInvoiceUniqueKey(existing) === key);
}

// Cari duplicate kontrolÃ¼ - sadece aktif kayÄ±tlar!
function getAccountUniqueKey(account) {
    return `${account.name.trim().toUpperCase()}_${account.taxNo || ""}`;
}

function isDuplicateAccount(account, accountsArray) {
    const key = getAccountUniqueKey(account);
    // Sadece aktif (status !== 'passive' && status !== 'deleted')
    return accountsArray
        .filter(a => a.status !== "passive" && a.status !== "deleted")
        .some(existing => getAccountUniqueKey(existing) === key);
}

// Cariyi pasif yapma
async function setAccountPassive(accountId) {
    await db.collection('companies').doc(activeCompanyId)
        .collection('accounts').doc(accountId).update({ status: "passive" });
    const account = accounts.find(a => a.id === accountId);
    if (account) account.status = "passive";
    await loadAccounts();
    renderAccountsTable();
    alert("Cari hesap pasif yapÄ±ldÄ±!");
}

// Pasif cariler modalÄ±
function showPassiveAccountsModal() {
    const passiveAccounts = accounts.filter(a => a.status === "passive" && a.companyId === activeCompanyId);
    let html = `
        <div class="modal active" id="passiveAccountsModal" style="display:flex;">
            <div class="modal-content" style="max-width:600px;">
                <div class="modal-header">
                    <h3>ğŸ—ƒï¸ Pasif Cariler</h3>
                    <button class="close-modal" onclick="closePassiveAccountsModal()">âœ–</button>
                </div>
                <div style="padding:20px;">
                    <ul>
                        ${passiveAccounts.map(acc => `
                        <li>
                            <strong>${acc.name}</strong>
                            <button class="btn btn-success btn-sm" onclick="activatePassiveAccount('${acc.id}')">Aktif Yap</button>
                        </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        </div>
    `;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closePassiveAccountsModal() {
    const modal = document.getElementById('passiveAccountsModal');
    if (modal) modal.remove();
}

async function activatePassiveAccount(accountId) {
    await db.collection('companies').doc(activeCompanyId)
        .collection('accounts').doc(accountId).update({ status: "active" });
    const account = accounts.find(a => a.id === accountId);
    if (account) account.status = "active";
    await loadAccounts();
    renderAccountsTable();
    closePassiveAccountsModal();
    alert("Cari hesap tekrar aktif!");
}

// Cari kartta eski verilerle eÅŸleÅŸtir
async function matchOldDataWithNewAccount(newAccountId) {
    try {
        console.log('matchOldDataWithNewAccount Ã‡AÄRILDI - newAccountId:', newAccountId);

        const newAccount = accounts.find(a => a.id === newAccountId);
        if (!newAccount) {
            alert('Yeni cari bulunamadÄ±!');
            return;
        }

        // 1. AdÄ± ve companyId aynÄ± olan, kendisi harici tÃ¼m cariler (aktif/pasif farketmez)
        const candidates = accounts.filter(a =>
            a.id !== newAccount.id &&
            a.companyId === newAccount.companyId &&
            a.name.trim().toLowerCase() === newAccount.name.trim().toLowerCase()
        );

        console.log('Eski aday cariler:', candidates);

        // 2. Fatura veya Ã¶deme kaydÄ± olan ilk cariyi bul
        let oldAccount = null;
        for (const candidate of candidates) {
            const hasInvoices = invoices.some(inv => inv.accountId === candidate.id);
            const hasPayments = payments.some(pay => pay.accountId === candidate.id);
            if (hasInvoices || hasPayments) {
                oldAccount = candidate;
                break;
            }
        }

        if (!oldAccount) {
            alert("AdÄ± aynÄ± olan eski cari bulunamadÄ± veya adÄ±na baÄŸlÄ± fatura/Ã¶deme yok.");
            return;
        }

        // 3. TÃ¼m fatura/Ã¶demelerin accountId'sini yeniye taÅŸÄ±
        const batch = db.batch();
        let transferCount = 0;

        invoices.filter(inv => inv.accountId === oldAccount.id)
            .forEach(inv => {
                batch.update(
                    db.collection('companies').doc(activeCompanyId).collection('invoices').doc(inv.id),
                    { accountId: newAccountId }
                );
                transferCount++;
            });
        payments.filter(pay => pay.accountId === oldAccount.id)
            .forEach(pay => {
                batch.update(
                    db.collection('companies').doc(activeCompanyId).collection('payments').doc(pay.id),
                    { accountId: newAccountId }
                );
                transferCount++;
            });

        await batch.commit();
        await loadInvoices();
        await loadPayments();
        await loadAccounts();

        console.log('Fatura/Ã–deme transferi bitti, toplam:', transferCount);
        alert(`Eski cari (${oldAccount.name})'ye baÄŸlÄ± ${transferCount} hareket yeni cariye aktarÄ±ldÄ±!`);
    } catch (e) {
        console.error("matchOldDataWithNewAccount HATASI:", e);
        alert("Hata: " + e.message);
    }
}

// DosyayÄ± Storage'a ve imports koleksiyonuna kaydeden fonksiyon
async function saveImportedFileToStorage(file, type) {
    if (!auth.currentUser || !activeCompanyId || !file) return;
    try {
        const timestamp = new Date().toISOString();
        const fileName = `${type}_${activeCompanyId}_${timestamp}_${file.name}`;
        const storageRef = storage.ref(`imports/${activeCompanyId}/${fileName}`);
        const snapshot = await storageRef.put(file);
        const downloadURL = await snapshot.ref.getDownloadURL();
        await db.collection('imports').add({
            companyId: activeCompanyId,
            userId: auth.currentUser.uid,
            type,
            fileName,
            downloadURL,
            timestamp
        });
        console.log(`âœ… Import dosyasÄ± kaydedildi: ${downloadURL}`);
    } catch (err) {
        console.error("Dosya Storage'a veya Firestore'a kaydedilemedi:", err);
    }
}

async function showTrashModal() {
    if (!activeCompanyId) {
        alert('âŒ LÃ¼tfen bir firma seÃ§in!');
        return;
    }
    
    try {
        // SilinmiÅŸ faturalarÄ± Ã§ek (indexsiz)
        const snapshot = await db.collection('companies')
            .doc(activeCompanyId)
            .collection('invoices')
            .where('status', '==', 'deleted')
            .get();
        
        // Client-side sÄ±ralama
        const deletedInvoices = [];
        snapshot.forEach(doc => {
            deletedInvoices.push({ id: doc.id, ...doc.data() });
        });
        
        // Silme tarihine gÃ¶re sÄ±rala (en yeni Ã¶nce)
        deletedInvoices.sort((a, b) => {
            const dateA = new Date(a.deletedAt || 0);
            const dateB = new Date(b.deletedAt || 0);
            return dateB - dateA;
        });
        
        if (deletedInvoices.length === 0) {
            alert('âœ… Ã‡Ã¶p kutusu boÅŸ!');
            return;
        }
        
        // Modal iÃ§eriÄŸi oluÅŸtur
        let modalHtml = `
            <div class="modal active" id="trashModal">
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>ğŸ—‘ï¸ Ã‡Ã¶p Kutusu (${deletedInvoices.length} fatura)</h3>
                        <button class="close-modal" onclick="closeTrashModal()">âœ–</button>
                    </div>
                    <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fatura No</th>
                                    <th>Tarih</th>
                                    <th>Tutar</th>
                                    <th>Silinme Tarihi</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        deletedInvoices.forEach(inv => {
            const deleteDate = new Date(inv.permanentDeleteDate);
            const daysLeft = Math.ceil((deleteDate - new Date()) / (1000 * 60 * 60 * 24));
            
            modalHtml += `
                <tr>
                    <td>${inv.invoiceNo}</td>
                    <td>${formatDate(inv.date)}</td>
                    <td>${formatCurrency(inv.total)}</td>
                    <td>
                        ${formatDate(inv.deletedAt)}<br>
                        <small style="color: ${daysLeft < 7 ? 'red' : '#6b7280'};">
                            ${daysLeft > 0 ? daysLeft + ' gÃ¼n kaldÄ±' : 'SÃ¼resi dolmuÅŸ'}
                        </small>
                    </td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="restoreInvoice('${inv.id}')">
                            â™»ï¸ Geri YÃ¼kle
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="permanentDeleteFromTrash('${inv.id}')">
                            ğŸ—‘ï¸ KalÄ±cÄ± Sil
                        </button>
                    </td>
                </tr>
            `;
        });
        
        modalHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
    } catch (error) {
        console.error('Ã‡Ã¶p kutusu hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

function closeTrashModal() {
    const modal = document.getElementById('trashModal');
    if (modal) modal.remove();
}

async function restoreInvoice(id) {
    if (!confirm('Bu faturayÄ± geri yÃ¼klemek istediÄŸinize emin misiniz?')) {
        return;
    }
    
    try {
        // Fatura verisini al
        const doc = await db.collection('companies')
            .doc(activeCompanyId)
            .collection('invoices')
            .doc(id)
            .get();
        
        const invoice = doc.data();
        
        // Status'u eski haline getir
        await db.collection('companies').doc(activeCompanyId)
            .collection('invoices').doc(id).update({
                status: invoice.previousStatus || 'unpaid',
                deletedAt: firebase.firestore.FieldValue.delete(),
                deletedBy: firebase.firestore.FieldValue.delete(),
                permanentDeleteDate: firebase.firestore.FieldValue.delete(),
                previousStatus: firebase.firestore.FieldValue.delete(),
                restoredAt: new Date().toISOString(),
                restoredBy: auth.currentUser.uid
            });
        
        // Cari bakiyesini dÃ¼zelt
        const account = accounts.find(a => a.id === invoice.accountId);
        if (account) {
            const remainingAmount = invoice.total - (invoice.paidAmount || 0);
            
            if (invoice.type === 'sales') {
                account.balance += remainingAmount;
            } else {
                account.balance -= remainingAmount;
            }
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('accounts').doc(account.id).update({
                    balance: account.balance
                });
        }
        
        closeTrashModal();
        await loadInvoices();
        await loadAccounts();
        updateDashboard();
        
        alert('âœ… Fatura geri yÃ¼klendi!');
        
    } catch (error) {
        console.error('Geri yÃ¼kleme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

async function permanentDeleteFromTrash(id) {
    if (!confirm('âš ï¸ Bu faturayÄ± KALICI olarak silmek istediÄŸinize emin misiniz?\n\nBu iÅŸlem GERÄ° ALINAMAZ!')) {
        return;
    }
    
    try {
        await db.collection('companies')
            .doc(activeCompanyId)
            .collection('invoices')
            .doc(id)
            .delete();
        
        closeTrashModal();
        alert('âœ… Fatura kalÄ±cÄ± olarak silindi!');
        showTrashModal(); // Modal'Ä± yenile
        
    } catch (error) {
        console.error('KalÄ±cÄ± silme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

async function saveInvoicesFromModal() {
    if (!parsedInvoices || parsedInvoices.length === 0) {
        alert('âŒ Kaydedilecek fatura yok!');
        return;
    }
    
    // Modal'daki seÃ§imleri topla
    const invoicesToSave = [];
    
    for (let i = 0; i < parsedInvoices.length; i++) {
        const invoice = parsedInvoices[i];
        
        // KullanÄ±cÄ±nÄ±n seÃ§tiÄŸi cari hesabÄ± al
        const selectedAccountId = document.getElementById(`invoiceAccount_${i}`)?.value;
        
        if (!selectedAccountId) {
            alert(`âš ï¸ ${invoice.faturaNo} iÃ§in cari hesap seÃ§ilmedi!`);
            return;
        }
        
        // Vade tarihini al
        const dueDate = document.getElementById(`invoiceDueDate_${i}`)?.value;
        
        // AÃ§Ä±klama al
        const description = document.getElementById(`invoiceDescription_${i}`)?.value || '';
        
        invoicesToSave.push({
            invoiceNo: invoice.faturaNo,
            date: invoice.faturaTarihi,
            dueDate: dueDate,
            accountId: selectedAccountId,
            total: invoice.tutar,
            type: currentInvoiceType, // 'sales' veya 'purchase'
            description: description,
            status: 'unpaid',
            paidAmount: 0,
            items: [{
                description: invoice.aliciAdi,
                quantity: 1,
                unitPrice: invoice.tutar,
                vatRate: 0,
                amount: invoice.tutar,
                vatAmount: 0
            }]
        });
    }
    
    console.log('ğŸ“¤ Kaydedilecek faturalar:', invoicesToSave);
    
    // AsÄ±l kaydetme fonksiyonunu Ã§aÄŸÄ±r
    await saveAllInvoices(invoicesToSave);
}

// AsÄ±l kaydetme fonksiyonu
async function saveAllInvoices(importedInvoices) {
    if (!importedInvoices || importedInvoices.length === 0) {
        alert('âŒ Kaydedilecek fatura yok!');
        return;
    }
    if (!activeCompanyId) {
        alert('âŒ LÃ¼tfen bir firma seÃ§in!');
        return;
    }
    if (!auth.currentUser) {
        alert('âŒ LÃ¼tfen giriÅŸ yapÄ±n!');
        return;
    }

    console.log('ğŸ” Duplicate kontrolÃ¼ baÅŸlÄ±yor...');
    console.log('Mevcut faturalar:', invoices.length);
    
    // â¬‡ï¸ Ã–NEMLÄ°: Duplicate kontrolÃ¼nden Ã¶nce verileri yenile
    await loadInvoices();
    
    // Mevcut fatura unique key dizisini oluÅŸtur
    const existingKeys = invoices.map(getInvoiceUniqueKey);
    console.log('Mevcut unique key\'ler:', existingKeys);
    
    const filteredInvoices = [];
    let skippedCount = 0;

    importedInvoices.forEach(inv => {
        const invKey = getInvoiceUniqueKey(inv);
        console.log(`Kontrol ediliyor: ${invKey}`);
        
        if (existingKeys.includes(invKey)) {
            console.log(`âŒ Duplicate bulundu: ${invKey}`);
            skippedCount++;
        } else {
            console.log(`âœ… Yeni fatura: ${invKey}`);
            filteredInvoices.push(inv);
            existingKeys.push(invKey);
        }
    });

    if (filteredInvoices.length === 0) {
        alert(`âš ï¸ TÃ¼m faturalar zaten kayÄ±tlÄ±, yeni fatura eklenmedi.\n\n${skippedCount} fatura atlandÄ±.`);
        closeInvoiceMatchModal();
        return;
    }

    try {
        // Firebase batch ile ekle
        const batch = db.batch();
        const now = new Date().toISOString();
        
        filteredInvoices.forEach(inv => {
            const invoiceRef = db.collection('companies').doc(activeCompanyId)
                .collection('invoices').doc();
            
            const invoiceData = {
                id: invoiceRef.id,
                invoiceNo: inv.invoiceNo,
                companyId: activeCompanyId,
                accountId: inv.accountId,
                date: inv.date,
                dueDate: inv.dueDate || inv.date,
                total: inv.total,
                subtotal: inv.total, // KDV dahil olarak varsayÄ±yoruz
                vatAmount: 0,
                type: inv.type || currentInvoiceType,
                status: 'unpaid',
                paidAmount: 0,
                description: inv.description || '',
                items: inv.items || [{
                    description: 'E-Fatura',
                    quantity: 1,
                    unitPrice: inv.total,
                    vatRate: 0,
                    amount: inv.total,
                    vatAmount: 0
                }],
                createdAt: now,
                createdBy: auth.currentUser.uid
            };
            
            batch.set(invoiceRef, invoiceData);
            
            console.log('âœ… Batch\'e eklendi:', invoiceData.invoiceNo);
        });

        // Commit iÅŸlemi
        await batch.commit();
        console.log('âœ… Batch commit tamamlandÄ±');
        
        // Verileri yenile
        await loadInvoices();
        await loadAccounts();
        updateDashboard();
        
        // Modal'Ä± kapat
        closeInvoiceMatchModal();
        
        alert(
            `âœ… ${filteredInvoices.length} yeni fatura eklendi!\n` +
            (skippedCount > 0 ? `âš ï¸ ${skippedCount} fatura zaten vardÄ±, atlandÄ±.` : '')
        );
        
    } catch (error) {
        console.error('âŒ Fatura kaydetme hatasÄ±:', error);
        alert('âŒ Hata: ' + error.message);
    }
}

// Cari hesap listesi Ã¶rnek (Firebase ile doldurulacak)
const CARI_LIST = [
    "HEMA OTOMOTÄ°V SÄ°STEMLERÄ° A.Å. Ã‡ERKEZKÃ–Y ÅUBESÄ°",
    "KALE MADEN SANAYÄ°",
    "ABC TÄ°CARET LTD. ÅTÄ°."
];

function loadCariList() {
    let select = document.getElementById('proposalCari');
    if (!select) return;
    select.innerHTML = '<option value="">Cari seÃ§iniz</option>';
    CARI_LIST.forEach(cari => {
        let opt = document.createElement('option');
        opt.value = cari;
        opt.textContent = cari;
        select.appendChild(opt);
    });
}

function openAddProposalModal() {
    document.getElementById('proposalFormModal').classList.add('active');
    loadCariList();
    clearParametersTable();
    addParameterRow(); // En az bir satÄ±r olsun
}

function closeProposalFormModal() {
    document.getElementById('proposalFormModal').classList.remove('active');
    document.getElementById('documentParseResult').innerHTML = '';
    document.getElementById('proposalForm').reset();
    clearParametersTable();
}

function clearParametersTable() {
    document.querySelector('#parametersTable tbody').innerHTML = '';
}

// Levenshtein distance (benzerlik skoru)
function levenshtein(a, b) {
    if (a.length === 0) return b.length;
    if (b.length === 0) return a.length;
    let matrix = [];
    for (let i = 0; i <= b.length; i++) matrix[i] = [i];
    for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
    for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
            if (b.charAt(i-1) === a.charAt(j-1)) {
                matrix[i][j] = matrix[i-1][j-1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i-1][j-1]+1,
                    matrix[i][j-1]+1,
                    matrix[i-1][j]+1
                );
            }
        }
    }
    return matrix[b.length][a.length];
}

function similarity(a, b) {
    let maxLen = Math.max(a.length, b.length);
    if (maxLen === 0) return 1.0;
    return (maxLen - levenshtein(a, b)) / maxLen;
}

// Parametre eÅŸleÅŸmesini fuzzy hale getir
function fuzzyParameterMatch(paramName) {
    paramName = paramName.trim().toLowerCase();
    let bestSim = 0;
    let bestParam = PARAMS_CATALOG[0];
    for (const p of PARAMS_CATALOG) {
        let sim = similarity(paramName, p.name.trim().toLowerCase());
        if (sim > bestSim) {
            bestSim = sim;
            bestParam = p;
        }
    }
    return (bestSim >= 0.7) ? bestParam : null; // %70 eÅŸik
}

// Parametre eklerken kullandÄ±ÄŸÄ±n yerde:
function addParameterRow(paramData={}) {
    let tbody = document.querySelector('#parametersTable tbody');
    let tr = document.createElement('tr');
    
    // â­ Parametre adÄ±nÄ± farklÄ± alanlardan al
    const parameterName = paramData.parametre || paramData.name || paramData.parameter;
    
    // Parametre dropdown
    let paramCell = document.createElement('td');
    let select = document.createElement('select');
    PARAMS_CATALOG.forEach(p => {
        let opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name;
        select.appendChild(opt);
    });
    
    // â­ Fuzzy eÅŸleÅŸme ile otomatik seÃ§im
    let fuzzyParam = parameterName ? fuzzyParameterMatch(parameterName) : null;
    
    console.log('ğŸ“¥ Gelen paramData:', paramData);
    console.log('ğŸ” Aranan parametre:', parameterName);
    console.log('âœ… Bulunan eÅŸleÅŸme:', fuzzyParam);
    
    select.value = fuzzyParam ? fuzzyParam.name : (parameterName || PARAMS_CATALOG[0].name);
    
    select.onchange = function(){
        let fiyat = PARAMS_CATALOG.find(p=>p.name===select.value)?.price || 0;
        tr.querySelector('.param-price').value = fiyat;
        calculateRowTotal(tr);
    }
    paramCell.appendChild(select);
    
    // Adet
    let adetCell = document.createElement('td');
    let adetInput = document.createElement('input');
    adetInput.type = 'number';
    adetInput.min = 1;
    adetInput.value = paramData.adet || 1;
    adetInput.className = 'param-qty';
    adetInput.oninput = ()=>calculateRowTotal(tr);
    adetCell.appendChild(adetInput);
    
    // Fiyat
    let priceCell = document.createElement('td');
    let priceInput = document.createElement('input');
    priceInput.type = 'number';
    priceInput.min = 0;
    priceInput.value = fuzzyParam ? fuzzyParam.price : (paramData.price || paramData.birimFiyat || 0);
    priceInput.className = 'param-price';
    priceInput.oninput = ()=>calculateRowTotal(tr);
    priceCell.appendChild(priceInput);
    
    // Toplam
    let totalCell = document.createElement('td');
    let totalInput = document.createElement('input');
    totalInput.type = 'number';
    totalInput.min = 0;
    totalInput.value = paramData.total || paramData.toplam || (priceInput.value * adetInput.value);
    totalInput.className = 'param-total';
    totalInput.readOnly = true;
    totalCell.appendChild(totalInput);
    
    // Sil butonu
    let removeCell = document.createElement('td');
    let removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-danger btn-sm';
    removeBtn.textContent = 'Sil';
    removeBtn.onclick = ()=>tr.remove();
    removeCell.appendChild(removeBtn);
    
    tr.appendChild(paramCell);
    tr.appendChild(adetCell);
    tr.appendChild(priceCell);
    tr.appendChild(totalCell);
    tr.appendChild(removeCell);
    
    tbody.appendChild(tr);
    calculateRowTotal(tr);
    
    // â­ KullanÄ±cÄ±ya otomatik eÅŸleÅŸen parametre bilgisini gÃ¶ster
if (parameterName && fuzzyParam && fuzzyParam.similarity && fuzzyParam.name !== parameterName) {
    let info = document.createElement('div');
    info.style.color = "orange";
    info.style.fontSize = "11px";
    info.style.marginTop = "5px";
    info.textContent = `ğŸ“Œ "${parameterName}" â†’ "${fuzzyParam.name}" olarak eÅŸleÅŸtirildi (%${fuzzyParam.similarity.toFixed(0)})`;
    paramCell.appendChild(info);
}
}

function calculateRowTotal(tr) {
    let adet = Number(tr.querySelector('.param-qty').value);
    let fiyat = Number(tr.querySelector('.param-price').value);
    let total = adet * fiyat;
    tr.querySelector('.param-total').value = total;
    calculateGlobals();
}
function calculateGlobals() {
    // KDV HariÃ§ Toplam ve indirimli toplamÄ± otomatik bul
    let rows = document.querySelectorAll('#parametersTable tbody tr');
    let sum = 0;
    rows.forEach(row=>{
        sum += Number(row.querySelector('.param-total').value);
    });
    document.getElementById('proposalTotal').value = sum;
    // Ä°ndirimli KDV hariÃ§ toplam (Ã¶rnek: %10 indirim)
    let discounted = sum * 0.9;
    document.getElementById('proposalDiscountedTotal').value = discounted.toFixed(2);
}

// PDF/gÃ¶rsel yÃ¼kleme ve parse
async function handleDocumentUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Global deÄŸiÅŸkene kaydet (Google Drive iÃ§in)
    uploadedFile = file;
    currentProposalDocument = file;
    
    document.getElementById('documentParseResult').innerHTML = '<span style="color:blue;">Ä°ÅŸleniyor...</span>';
    
    if (file.type === "application/pdf") {
        const reader = new FileReader();
        reader.onload = async function(e) {
            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let textContent = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                textContent += content.items.map(item => item.str).join(" ") + "\n";
            }
            parseProposalContent(textContent);
            document.getElementById('documentParseResult').innerHTML = '<span style="color:green;">âœ… PDF yÃ¼klendi ve parse edildi!</span>';
        };
        reader.readAsArrayBuffer(file);
    } else if (file.type.startsWith("image/")) {
        Tesseract.recognize(file, 'tur').then(({ data: { text } }) => {
            parseProposalContent(text);
            document.getElementById('documentParseResult').innerHTML = '<span style="color:green;">âœ… GÃ¶rsel yÃ¼klendi ve parse edildi!</span>';
        });
    } else {
        document.getElementById('documentParseResult').innerHTML = '<span style="color:red;">âŒ Desteklenmeyen dosya formatÄ±!</span>';
    }
}

function parseProposalContent(text) {
    document.getElementById('documentParseResult').innerHTML = '<pre style="background:#f3f4f6; padding:10px; border-radius:8px; max-height:250px; overflow:auto;">'+text+'</pre>';
    let appNo = (text.match(/BaÅŸvuru No[:\s]*([A-Z0-9]+)/) || [])[1] || "";
    let appDate = (text.match(/BaÅŸvuru Tarihi[:\s]*([0-9.:\s]+)/) || [])[1] || "";
    let company = (text.match(/Tesis[:\s]*([A-ZÃ‡ÄÄ°Ã–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼0-9(). -]+)/) || [])[1] || "";
    let lab = (text.match(/Laboratuvar[:\s]*([A-ZÃ‡ÄÄ°Ã–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼0-9(). -]*)/) || [])[1] || "";

    // Parametreler tablosunu bul, satÄ±rlara ayÄ±r
    let paramRows = [];
    let tableStart = text.indexOf("Parametreler");
    let tableEnd = text.indexOf("Taban Fiyat");
    if (tableStart > -1 && tableEnd > tableStart) {
        let tableText = text.substring(tableStart, tableEnd);
        let lines = tableText.split("\n").filter(l => l.trim().length > 0);
        for (let line of lines) {
            // BaÅŸlÄ±k satÄ±rlarÄ±nÄ± atla
            if (line.match(/Parametre[\s]*Adet[\s]*Fiyat[\s]*Toplam/i)) continue;
            // SatÄ±rda parametre adÄ± + 3 rakam aranÄ±yor mu?
            let m = line.match(/^(.*?)(\d+)[\s]+([\d.,]+)[\s]*â‚º?[\s]+([\d.,]+)[\s]*â‚º?$/);
            if (m) {
                paramRows.push({
                    name: m[1].trim(),
                    adet: m[2],
                    price: m[3].replace(/\./g,'').replace(',','.'),
                    total: m[4].replace(/\./g,'').replace(',','.')
                });
            } else {
                // Alternatif: satÄ±rda birden fazla sayÄ± varsa
                let numbers = line.match(/(\d[\d.,]*)/g);
                if (numbers && numbers.length >= 3) {
                    let name = line.split(numbers[0])[0].trim();
                    paramRows.push({
                        name: name,
                        adet: numbers[0],
                        price: numbers[1].replace(/\./g,'').replace(',','.'),
                        total: numbers[2].replace(/\./g,'').replace(',','.')
                    });
                }
            }
        }
    }

    document.getElementById('proposalApplicationNo').value = appNo.trim();
    document.getElementById('proposalApplicationDate').value = appDate.trim();
    document.getElementById('proposalCompany').value = company.trim();
    document.getElementById('proposalLab').value = lab.trim();

    clearParametersTable();
    if (paramRows.length) {
        paramRows.forEach(row=>addParameterRow(row));
    } else {
        addParameterRow();
    }
    calculateGlobals();
}

// Cari/firma eÅŸleÅŸme kontrolÃ¼
function checkCompanyMatch() {
    let cari = document.getElementById('proposalCari').value;
    let firma = document.getElementById('proposalCompany').value;
    let warning = document.getElementById('companyMatchWarning');
    if (cari && firma && cari !== firma) {
        warning.style.display = 'inline';
    } else {
        warning.style.display = 'none';
    }
}

function showTab(tabId) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.querySelector('.tab[onclick="showTab(\''+tabId+'\')"]').classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

let uploadedFile = null;

// PDF.js ile pozisyon bazlÄ± parse
function parseWithPDFjs() {
    if (!uploadedFile) return alert("Ã–nce bir dosya yÃ¼kleyin!");
    const reader = new FileReader();
    reader.onload = async function(e) {
        const typedarray = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument(typedarray).promise;
        let paramRows = [];
        let fullText = "";
        
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            
            // BloklarÄ± y pozisyonuna gÃ¶re grupla (satÄ±r bulma)
            let lines = {};
            content.items.forEach(item => {
                let y = Math.round(item.transform[5]);
                if (!lines[y]) lines[y] = [];
                lines[y].push(item.str);
            });
            
            Object.values(lines).forEach(cols => {
                let line = cols.join(' ').trim();
                fullText += line + "\n";
                
                // â­ AKILLI REGEX - Ä°lk baÄŸÄ±msÄ±z sayÄ±ya kadar her ÅŸey parametre adÄ±
                let m = line.match(/^(.+?)\s+(\d+)\s+([\d.,]+)\s*â‚º?\s+([\d.,]+)\s*â‚º?$/);
                
                if (m) {
                    const paramName = m[1].trim();
                    
                    // BaÅŸlÄ±k satÄ±rlarÄ±nÄ± atla
                    if (paramName.match(/parametre|adet|fiyat|toplam|baÅŸvuru|tesis|laboratuvar/i)) {
                        return;
                    }
                    
                    paramRows.push({
                        name: paramName,
                        adet: m[2],
                        price: m[3].replace(/â‚º/g, '').replace(/\./g,'').replace(',','.').trim(),
                        total: m[4].replace(/â‚º/g, '').replace(/\./g,'').replace(',','.').trim()
                    });
                    
                    console.log(`âœ… Parse edildi: "${paramName}" | Adet: ${m[2]} | Fiyat: ${m[3]}`);
                }
            });
        }
        
        console.log(`\nğŸ“Š Toplam ${paramRows.length} parametre bulundu`);
        
        document.getElementById('documentParseResult').innerHTML = 
            '<pre style="background:#f3f4f6; padding:10px; border-radius:8px; max-height:250px; overflow:auto;">PDF.js Ã§Ä±ktÄ±sÄ±:\n'+fullText+'</pre>';
        
        fillProposalFields(fullText, paramRows);
    };
    reader.readAsArrayBuffer(uploadedFile);
}

// PDF'yi gÃ¶rsele Ã§evirip OCR ile parse
function parseWithOCR() {
    if (!uploadedFile) return alert("Ã–nce bir dosya yÃ¼kleyin!");
    const reader = new FileReader();
    reader.onload = async function(e) {
        const typedarray = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument(typedarray).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2.0 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({canvasContext: context, viewport: viewport}).promise;
            // Canvas'Ä± Tesseract.js ile OCR yap
            const { data: { text } } = await Tesseract.recognize(canvas, 'tur');
            document.getElementById('documentParseResult').innerHTML = '<pre style="background:#f3f4f6; padding:10px; border-radius:8px; max-height:250px; overflow:auto;">OCR Ã§Ä±ktÄ±sÄ±:\n'+text+'</pre>';
            fillProposalFields(text, null); // OCR'dan satÄ±r parse etmeyi aÅŸaÄŸÄ±da yapacaÄŸÄ±z
        }
    };
    reader.readAsArrayBuffer(uploadedFile);
}

// Parse edilen metni kutucuklara ve tabloya aktar
function fillProposalFields(text, paramRows) {
    let appNo = (text.match(/BaÅŸvuru No[:\s]*([A-Z0-9]+)/) || [])[1] || "";
    let appDate = (text.match(/BaÅŸvuru Tarihi[:\s]*([0-9.:\s]+)/) || [])[1] || "";
    let company = (text.match(/Tesis[:\s]*([A-ZÃ‡ÄÄ°Ã–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼0-9(). -]+)/) || [])[1] || "";
    let lab = (text.match(/Laboratuvar[:\s]*([A-ZÃ‡ÄÄ°Ã–ÅÃœa-zÃ§ÄŸÄ±Ã¶ÅŸÃ¼0-9(). -]*)/) || [])[1] || "";
    
    document.getElementById('proposalApplicationNo').value = appNo.trim();
    document.getElementById('proposalApplicationDate').value = appDate.trim();
    document.getElementById('proposalCompany').value = company.trim();
    document.getElementById('proposalLab').value = lab.trim();
    
    clearParametersTable();
    
    // PDF.js parse ile paramRows varsa tabloya ekle
    if (paramRows && paramRows.length) {
        console.log(`ğŸ“Š ${paramRows.length} parametre bulundu, tabloya ekleniyor...`);
        paramRows.forEach(row => {
            console.log(`  â• Ekleniyor:`, row);
            addParameterRow(row);
        });
    } else {
        // Fallback: OCR parse
        let lines = text.split("\n").filter(l => l.trim().length > 0);
        
        for (let line of lines) {
            // BaÅŸlÄ±k satÄ±rlarÄ±nÄ± atla
            if (line.match(/parametre|adet|fiyat|toplam|baÅŸvuru|tesis|laboratuvar/i)) continue;
            
            // â­ AKILLI REGEX
            let m = line.match(/^(.+?)\s+(\d+)\s+([\d.,]+)\s*â‚º?\s+([\d.,]+)\s*â‚º?$/);
            
            if (m) {
                addParameterRow({
                    name: m[1].trim(),
                    adet: m[2],
                    price: m[3].replace(/â‚º/g, '').replace(/\./g,'').replace(',','.').trim(),
                    total: m[4].replace(/â‚º/g, '').replace(/\./g,'').replace(',','.').trim()
                });
            }
        }
    }
    
    calculateGlobals();
}

function toggleFirmaDetay() {
    const section = document.getElementById('firmaDetaySection');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
}

// ========================================
// EVENT LISTENERS
// ========================================

document.getElementById('personnelForm').addEventListener('submit', savePersonnel);
document.getElementById('leaveRequestForm').addEventListener('submit', saveLeaveRequest);

// Inputlarda deÄŸiÅŸiklik olunca otomatik hesapla
document.getElementById('salaryNetInput').addEventListener('input', updateSalaryTotalCost);
document.getElementById('salaryExtraInput').addEventListener('input', updateSalaryTotalCost);
document.getElementById('salaryMonth').addEventListener('change', updateSalaryTotalCost);

// Sayfa yÃ¼klendiÄŸinde bu ayÄ± otomatik seÃ§
// Sayfa yÃ¼klendiÄŸinde
document.addEventListener('DOMContentLoaded', function() {
    // âœ… Sadece UI hazÄ±rlama iÅŸleri
    // Veri yÃ¼kleme tamamen Firebase auth'dan sonra yapÄ±lacak
    
    // Tarih inputlarÄ±nÄ± bugÃ¼ne ayarla
    const today = new Date();
    
    const invoiceDateInput = document.getElementById('invoiceDate');
    if (invoiceDateInput) {
        invoiceDateInput.valueAsDate = today;
    }
    
    const paymentDateInput = document.getElementById('paymentDate');
    if (paymentDateInput) {
        paymentDateInput.valueAsDate = today;
    }
    
    const purchaseDateInput = document.getElementById('purchaseDate');
    if (purchaseDateInput) {
        purchaseDateInput.valueAsDate = today;
    }
    
    // âœ… MaaÅŸ ayÄ± otomatik seÃ§
    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    const salaryMonthInput = document.getElementById('salaryMonth');
    if (salaryMonthInput) {
        salaryMonthInput.value = currentMonth;
    }
       
    const editPaymentForm = document.getElementById('editPaymentForm');
    if (editPaymentForm) {
        editPaymentForm.addEventListener('submit', updatePayment);
    }

    console.log('âœ… UI hazÄ±rlandÄ±, Firebase auth bekleniyor...');
});

// Firebase Authentication State Listener
auth.onAuthStateChanged(async (user) => {
    if (user) {
        console.log('âœ… KullanÄ±cÄ± giriÅŸ yaptÄ±:', user.email);
        document.getElementById('authModal').style.display = 'none';
        
        try {
            await initializeApp(user);
        } catch (error) {
            console.error('âŒ BaÅŸlatma hatasÄ±:', error);
            alert('âŒ Veri yÃ¼kleme hatasÄ±. LÃ¼tfen sayfayÄ± yenileyin.');
        }
        
    } else {
        console.log('âš ï¸ KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ');
        document.getElementById('authModal').style.display = 'flex';
        
        companies = [];
        accounts = [];
        invoices = [];
        payments = [];
        purchases = [];
        personnel = [];
        attendanceRecords = [];
        leaveRequests = [];
        salaryPayments = [];
        salaryTableData = {};
        activeCompanyId = null;
    }
});

</script>
</body>
</html>