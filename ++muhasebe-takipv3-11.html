<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muhasebe Takip Sistemi v2.0</title>

<!-- Firebase SDK'ları -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
<!-- JS KÜTÜPHANELERİ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.4/dist/tesseract.min.js"></script>

<!-- jsPDF ve autoTable CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.7.0/jspdf.plugin.autotable.min.js"></script>
<!-- DejaVu font base64 (örnek) -->
<script src="https://unpkg.com/jspdf@2.5.1/dist/font/dejavu.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<!-- Google API Client Library -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --border: #e5e7eb;
            --purple: #8b5cf6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .version-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: var(--dark);
            border-bottom: 3px solid var(--primary);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 18px 20px;
            background: var(--dark);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 140px;
        }

        .tab:hover {
            background: #374151;
        }

        .tab.active {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .content {
            padding: 30px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-info {
            background: var(--info);
            color: var(--white);
        }

        .btn-info:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: var(--white);
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .card {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .card h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: var(--primary);
            color: var(--white);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        tbody tr:hover {
            background: var(--light);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .stat-card h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .amount {
            font-size: 2em;
            font-weight: 700;
        }

        .stat-card small {
            opacity: 0.8;
            font-size: 0.85em;
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, var(--purple) 0%, #6d28d9 100%);
        }

        .invoice-items {
            margin-top: 20px;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            background: var(--light);
        }

        .invoice-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--success);
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid var(--info);
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--warning);
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--danger);
        }

        .filters {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .company-selector {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: var(--success);
            color: var(--white);
        }

        .badge-danger {
            background: var(--danger);
            color: var(--white);
        }

        .badge-warning {
            background: var(--warning);
            color: var(--white);
        }

        .badge-info {
            background: var(--info);
            color: var(--white);
        }

        .badge-secondary {
            background: #6b7280;
            color: var(--white);
        }

        .export-section {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h3 {
            color: var(--primary);
            margin: 0;
        }

        .close-modal {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }

        .payment-match-item {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .payment-match-item.matched {
            border-color: var(--success);
            background: #d1fae5;
        }

        .payment-match-item.unmatched {
            border-color: var(--warning);
            background: #fef3c7;
        }

        .file-upload-area {
            border: 3px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: var(--light);
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: #dbeafe;
        }

        .file-upload-area.drag-over {
            border-color: var(--success);
            background: #d1fae5;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }

            .invoice-item {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                min-width: 100%;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .version-badge {
                position: static;
                display: block;
                margin-top: 10px;
            }
        }

        .status-paid {
            color: var(--success);
            font-weight: 600;
        }

        .status-partial {
            color: var(--warning);
            font-weight: 600;
        }

        .status-unpaid {
            color: var(--danger);
            font-weight: 600;
        }

        .overdue {
            background: #fee2e2;
            color: var(--danger);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--light);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            transition: width 0.3s;
        }

/* ============================================
   PDF TEMPLATE - TAM DÜZELTME (Tablo + Metin)
   ============================================ */

/* Ana Sayfa Container */
.pdf-page {
    width: 210mm;
    min-height: auto;
    max-width: 210mm;
    padding: 12mm 15mm;
    margin: 0;
    position: relative;
    background: white;
    page-break-after: always;
    page-break-inside: avoid;
    overflow: visible;
    box-sizing: border-box;
}

/* Son sayfada sayfa atlamayı kaldır */
.pdf-page:last-child {
    page-break-after: avoid;
}

/* SAYFA ÖZEL YÜKSEKLİKLERİ - OPTİMİZE */
.page-1 {
    min-height: 290mm;  /* ✅ Kapak - azalt */
    padding: 15mm 15mm;
}

.page-2 {
    min-height: 290mm;  /* ✅ Tablo - azalt */
    padding: 12mm 15mm;
}

.page-3, .page-4, .page-5, .page-6 {
    min-height: 290mm;  /* İçerik sayfaları */
}

/* ============================================
   TABLO STİLLERİ - SAYFA İÇİNDE KALSIN
   ============================================ */
/* TABLO STİLLERİ - YAZILARI BÜYÜT */

.pdf-table {
    width: 100%;
    max-width: 100%;
    border-collapse: collapse;
    font-size: 9px;  /* ✅ 8px'den 9px'e çıkar */
    margin: 10px 0;
    table-layout: fixed;
}

.pdf-table th {
    background: #4472C4;
    color: white;
    border: 1px solid #000;
    padding: 7px 5px;  /* ✅ Padding artır */
    text-align: left;
    font-weight: bold;
    font-size: 9px;  /* ✅ 8px'den 9px'e çıkar */
    word-wrap: break-word;
}

.pdf-table td {
    border: 1px solid #000;
    padding: 5px 4px;  /* ✅ Padding artır */
    text-align: left;
    font-size: 9px;  /* ✅ 8px'den 9px'e çıkar */
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Sütun genişlikleri - OPTİMİZE */
#pdf-parameters-table th:nth-child(1),
#pdf-parameters-table td:nth-child(1) {
    width: 14%;  /* Kaynak Adı */
}

#pdf-parameters-table th:nth-child(2),
#pdf-parameters-table td:nth-child(2) {
    width: 32%;  /* Ölçüm Parametresi - biraz genişlet */
}

#pdf-parameters-table th:nth-child(3),
#pdf-parameters-table td:nth-child(3) {
    width: 22%;  /* Ölçüm Standardı */
}

#pdf-parameters-table th:nth-child(4),
#pdf-parameters-table td:nth-child(4) {
    width: 8%;  /* Adet */
    text-align: center;
}

#pdf-parameters-table th:nth-child(5),
#pdf-parameters-table td:nth-child(5) {
    width: 12%;  /* Birim Fiyat */
    text-align: right;
}

#pdf-parameters-table th:nth-child(6),
#pdf-parameters-table td:nth-child(6) {
    width: 12%;  /* Toplam */
    text-align: right;
}

/* ============================================
   FİRMA BİLGİ TABLOSU
   ============================================ */

.info-table {
    width: 100%;
    max-width: 100%;
    border-collapse: collapse;
    font-size: 9px;
    margin: 8px 0;  /* ✅ Azalt */
    table-layout: fixed;
}

.info-table td {
    border: 1px solid #000;
    padding: 4px;  /* ✅ Azalt */
    word-wrap: break-word;
}

.info-table td:first-child {
    font-weight: bold;
    width: 30%;
    background: #f0f0f0;
}

.info-table td:last-child {
    width: 70%;
}

/* ============================================
   BAŞLIK VE METİN STİLLERİ
   ============================================ */

.pdf-title {
    text-align: center;
    font-size: 12px;
    font-weight: bold;
    margin: 12px 0;  /* ✅ Azalt */
    color: #333;
}

.pdf-subtitle {
    text-align: center;
    font-size: 10px;
    font-weight: normal;
    margin: 8px 0;
    color: #666;
}

.blue-header {
    background: #4472C4;
    color: white;
    text-align: center;
    padding: 8px;
    font-size: 11px;
    font-weight: bold;
    margin: 8px 0;  /* ✅ Azalt */
}

/* ============================================
   METİN BLOKLARI - SAYFA İÇİNDE KALSIN
   ============================================ */

.pdf-text {
    font-size: 9px;
    line-height: 1.4;  /* ✅ Azalt (1.5 -> 1.4) */
    text-align: justify;
    color: #333;
    word-wrap: break-word;
    overflow-wrap: break-word;
    max-width: 100%;
}

.pdf-text p {
    margin: 5px 0;  /* ✅ Azalt (6px -> 5px) */
    page-break-inside: avoid;
}

/* ============================================
   HEADER & FOOTER
   ============================================ */

.pdf-header {
    margin-bottom: 8px;  /* ✅ Azalt */
}

.pdf-footer {
    position: absolute;
    bottom: 8mm;  /* ✅ Azalt */
    left: 15mm;
    right: 15mm;
    font-size: 8px;
    font-style: italic;
    color: #666;
}

.page-number {
    position: absolute;
    top: 8mm;  /* ✅ Azalt */
    right: 15mm;
    font-size: 8px;
    color: #666;
}

/* ============================================
   TUTARLAR BÖLÜMÜ
   ============================================ */

.pdf-totals {
    font-size: 9px;
    margin-top: 8px;  /* ✅ Azalt */
    font-weight: bold;
}

.pdf-totals div {
    margin: 3px 0;  /* ✅ Azalt */
}

/* ============================================
   BANKA TABLOSU
   ============================================ */

.bank-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 8px;
    margin: 10px 0;
}

.bank-table th {
    background: #4472C4;
    color: white;
    border: 1px solid #000;
    padding: 5px;
    text-align: center;
    font-size: 8px;
}

.bank-table td {
    border: 1px solid #000;
    padding: 5px;
    text-align: center;
    font-size: 8px;
}

/* ============================================
   PRINT MODU
   ============================================ */

@media print {
    body {
        margin: 0;
        padding: 0;
    }
    
    .pdf-page {
        page-break-after: always;
        page-break-inside: avoid;
        margin: 0;
        overflow: visible;
    }
    
    .pdf-page:last-child {
        page-break-after: avoid;
    }
    
    .pdf-table,
    .info-table,
    .pdf-text {
        page-break-inside: avoid;
    }
}

/* ============================================
   RESPONSIVE TABLO (Çok uzun içerik için)
   ============================================ */

@page {
    size: A4;
    margin: 0;
}

/* Uzun metinleri kes */
.text-truncate {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Kelime kırma */
.break-word {
    word-break: break-word;
    overflow-wrap: break-word;
}

    </style>
</head>
<body>

<!-- AUTH MODAL -->
<div id="authModal" class="modal active" style="display:flex;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
            <h3 id="authTitle">🔐 Giriş Yap</h3>
        </div>
        <div style="padding: 20px;">
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="ornek@mail.com" required>
                </div>
                <div class="form-group">
                    <label>Şifre</label>
                    <input type="password" id="loginPassword" placeholder="••••••••" required>
                </div>
                <button class="btn btn-primary" onclick="loginUser()" style="width:100%; margin-bottom:10px;">
                    Giriş Yap
                </button>
                <button class="btn btn-primary" onclick="loginWithGoogle()" style="width:100%; margin-bottom:10px;">
    		    🔵 Google ile Giriş
		</button>
                <p style="text-align:center; margin-top:15px; color:#6b7280;">
                    Hesabın yok mu? 
                    <a href="#" onclick="toggleAuthMode()" style="color:var(--primary);">Kayıt Ol</a>
                </p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" style="display:none;">
                <div class="form-group">
                    <label>Ad Soyad</label>
                    <input type="text" id="registerName" placeholder="Ahmet Yılmaz" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="ornek@mail.com" required>
                </div>
                <div class="form-group">
                    <label>Şifre (min 6 karakter)</label>
                    <input type="password" id="registerPassword" placeholder="••••••••" required>
                </div>
                <button class="btn btn-primary" onclick="registerUser()" style="width:100%; margin-bottom:10px;">
                    Kayıt Ol
                </button>
                <p style="text-align:center; margin-top:15px; color:#6b7280;">
                    Hesabın var mı? 
                    <a href="#" onclick="toggleAuthMode()" style="color:var(--primary);">Giriş Yap</a>
                </p>
            </div>
        </div>
    </div>
</div>



    <div class="container">
        <div class="header">
            <span class="version-badge">v2.0 Pro</span>
            <h1>💼 Muhasebe Takip Sistemi</h1>
            <p>Profesyonel Fatura, Cari ve Ödeme Yönetimi</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">📊 Dashboard</button>
            <button class="tab" onclick="showTab('companies')">🏢 Firmalar</button>
            <button class="tab" onclick="showTab('accounts')">👥 Cari Hesaplar</button>
	    <button class="tab" onclick="showTab('proposals')">📑 Teklifler</button>
            <button class="tab" onclick="showTab('invoices')">📄 Faturalar</button>
    	    <button class="tab" onclick="showTab('purchases')">💸 Alışlar</button>
            <button class="tab" onclick="showTab('payments')">💰 Ödemeler</button>
            <button class="tab" onclick="showTab('reports')">📈 Raporlar</button>
	    <button class="tab" onclick="showTab('personnel')">👥 Personel</button>
            <button class="tab" onclick="showTab('settings')">⚙️ Ayarlar</button>
        </div>

        <div class="content">
            <!-- DASHBOARD TAB -->
            <div id="dashboard" class="tab-content active">
                <div class="company-selector">
                    <label>Aktif Firma:</label>
                    <select id="activeCompanySelect" onchange="changeActiveCompany()">
                        <option value="">Firma Seçiniz</option>
                    </select>
                </div>

                <div class="grid-4">
                    <div class="stat-card success">
                        <h4>Toplam Gelir</h4>
                        <div class="amount" id="totalIncome">0.00 ₺</div>
                    </div>
                    <div class="stat-card danger">
                        <h4>Toplam Gider</h4>
                        <div class="amount" id="totalExpense">0.00 ₺</div>
                    </div>
                    <div class="stat-card">
                        <h4>Net Kar/Zarar</h4>
                        <div class="amount" id="netProfit">0.00 ₺</div>
                    </div>
                    <div class="stat-card warning">
                        <h4>Tahsil Edilecek</h4>
                        <div class="amount" id="receivables">0.00 ₺</div>
                    </div>
                </div>

                <div class="grid-3">
                    <div class="stat-card warning">
                        <h4>Ödenecek KDV</h4>
                        <div class="amount" id="totalVAT">0.00 ₺</div>
                    </div>
                    <div class="stat-card purple">
                        <h4>Kurumlar Vergisi (%20)</h4>
                        <div class="amount" id="corporateTax">0.00 ₺</div>
                    </div>
                    <div class="stat-card info">
                        <h4>Toplam Ödeme</h4>
                        <div class="amount" id="totalPayments">0.00 ₺</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <h3>Son Faturalar</h3>
                        <table id="recentInvoices">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>No</th>
                                    <th>Cari</th>
                                    <th>Tutar</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div class="card">
                        <h3>Son Ödemeler</h3>
                        <table id="recentPayments">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Cari</th>
                                    <th>Tutar</th>
                                    <th>Tip</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>


<!-- COMPANIES TAB - YENİ TASARIM -->
<div id="companies" class="tab-content">
    <!-- Üst Başlık ve Butonlar -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">🏢 Firmalar</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalCompaniesCount">0</strong> firma kayıtlı</p>
        </div>
        <button class="btn btn-primary" onclick="openAddCompanyModal()" style="font-size: 16px; padding: 12px 25px;">
            ➕ Yeni Firma Ekle
        </button>
    </div>

    <!-- Firma Listesi -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>📊 Kayıtlı Firmalar</h3>
            <input type="text" id="searchCompany" placeholder="🔍 Firma ara..." 
                   oninput="searchCompanies()" 
                   style="width: 300px; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
        </div>
        
        <table id="companiesTable">
            <thead>
                <tr>
                    <th>Ünvan</th>
                    <th>Sektör</th>
                    <th>Vergi No</th>
                    <th>Vergi Dairesi</th>
                    <th>Telefon</th>
                    <th>Cari Sayısı</th>
                    <th>Döküman</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- ACCOUNTS TAB - YENİ TASARIM -->
<div id="accounts" class="tab-content">
    <!-- Üst Başlık ve Butonlar -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">👥 Cari Hesaplar</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalAccountsCount">0</strong> cari hesap kayıtlı</p>
        </div>
        <button class="btn btn-primary" onclick="openAddAccountModal()" style="font-size: 16px; padding: 12px 25px;">
            ➕ Yeni Cari Hesap Ekle
        </button>
	<button class="btn btn-success" onclick="openImportAccountsModal()" style="font-size: 16px; padding: 12px 25px;">
    	    📤 Cari Hesapları Excel'den Ekle
	</button>
	<button class="btn btn-success" onclick="showPassiveAccountsModal()" style="font-size: 16px; padding: 12px 25px;">
    	    🗃️ Pasif Cariler
	</button>
    </div>

    <!-- Cari Hesaplar Listesi -->
    <div class="card">
        <h3>📋 Cari Hesap Listesi</h3>
        
<!-- FİLTRELER -->
<div class="filters">
    <div class="grid-4">
        <div class="form-group">
            <label>🏢 Firma</label>
            <select id="filterAccountCompany" onchange="filterAndSortAccounts()">
                <option value="">Tüm Firmalar</option>
            </select>
        </div>
        <div class="form-group">
            <label>👥 Tür</label>
            <select id="filterAccountType" onchange="filterAndSortAccounts()">
                <option value="">Tümü</option>
                <option value="customer">Müşteri</option>
                <option value="supplier">Tedarikçi</option>
            </select>
        </div>
        <div class="form-group">
            <label>💰 Bakiye Durumu</label>
            <select id="filterAccountBalance" onchange="filterAndSortAccounts()">
                <option value="">Tümü</option>
                <option value="positive">Alacaklı (+)</option>
                <option value="negative">Borçlu (-)</option>
                <option value="zero">Sıfır (0)</option>
            </select>
        </div>
        <div class="form-group">
            <label>🔍 Ara</label>
            <input type="text" id="searchAccount" placeholder="Cari adı, vergi no, telefon..." oninput="filterAndSortAccounts()">
        </div>
    </div>
    
    <!-- Sıralama ve Butonlar -->
    <div class="grid-4" style="margin-top: 15px;">
        <div class="form-group">
            <label>📊 Sırala</label>
            <select id="sortAccount" onchange="filterAndSortAccounts()">
                <option value="name-asc">İsim (A-Z)</option>
                <option value="name-desc">İsim (Z-A)</option>
                <option value="balance-desc">Bakiye (Yüksek → Düşük)</option>
                <option value="balance-asc">Bakiye (Düşük → Yüksek)</option>
                <option value="date-desc">Tarih (Yeni → Eski)</option>
                <option value="date-asc">Tarih (Eski → Yeni)</option>
            </select>
        </div>
        <div class="form-group" style="display: flex; align-items: flex-end; gap: 10px;">
            <button class="btn btn-info" onclick="filterAndSortAccounts()" style="flex: 1;">
                🔍 Filtrele
            </button>
            <button class="btn btn-warning" onclick="clearAccountFilters()" style="flex: 1;">
                🔄 Temizle
            </button>
        </div>
    </div>
</div>
        
<table id="accountsTable">
    <thead>
        <tr>
            <th onclick="sortAccountsBy('company')" style="cursor: pointer;">
                🏢 Firma <span id="sortCompany">⇅</span>
            </th>
            <th onclick="sortAccountsBy('name')" style="cursor: pointer;">
                👤 Cari Adı <span id="sortName">⇅</span>
            </th>
            <th onclick="sortAccountsBy('type')" style="cursor: pointer;">
                🏷️ Tür <span id="sortType">⇅</span>
            </th>
            <th>📞 Telefon</th>
            <th onclick="sortAccountsBy('balance')" style="cursor: pointer;">
                💰 Bakiye <span id="sortBalance">⇅</span>
            </th>
            <th>📄 Döküman</th>
            <th>⚙️ İşlemler</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>
    </div>
</div>

<!-- FİRMA EKLEME/DÜZENLEME MODAL -->
<div id="companyFormModal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="companyFormModalTitle">➕ Yeni Firma Ekle</h3>
            <button class="close-modal" onclick="closeCompanyFormModal()">✖</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="companyForm" enctype="multipart/form-data">
                <input type="hidden" id="companyId">
                
                <!-- Temel Bilgiler -->
                <div class="alert alert-info">
                    <strong>📋 Temel Bilgiler</strong>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Firma Ünvanı *</label>
                        <input type="text" id="companyName" required placeholder="Örn: ABC Ticaret Ltd. Şti.">
                    </div>
                    <div class="form-group">
                        <label>Sektör</label>
                        <select id="companySector">
                            <option value="">Seçiniz</option>
                            <option value="İnşaat">İnşaat</option>
                            <option value="Ticaret">Ticaret</option>
                            <option value="Üretim">Üretim</option>
                            <option value="Hizmet">Hizmet</option>
                            <option value="Danışmanlık">Danışmanlık</option>
                            <option value="Lojistik">Lojistik</option>
                            <option value="Gıda">Gıda</option>
                            <option value="Teknoloji">Teknoloji</option>
                            <option value="Eğitim">Eğitim</option>
                            <option value="Sağlık">Sağlık</option>
                            <option value="Diğer">Diğer</option>
                        </select>
                    </div>
                </div>
                
                <!-- Vergi Bilgileri -->
                <div class="alert alert-warning" style="margin-top: 20px;">
                    <strong>💼 Vergi Bilgileri</strong>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Vergi Numarası *</label>
                        <input type="text" id="companyTaxNo" required placeholder="10 haneli vergi numarası" maxlength="10">
                    </div>
                    <div class="form-group">
                        <label>Vergi Dairesi *</label>
                        <input type="text" id="companyTaxOffice" required placeholder="Örn: Kadıköy Vergi Dairesi">
                    </div>
                </div>
                
                <!-- İletişim Bilgileri -->
                <div class="alert alert-success" style="margin-top: 20px;">
                    <strong>📞 İletişim Bilgileri</strong>
                </div>
                
                <div class="grid-3">
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="tel" id="companyPhone" placeholder="0XXX XXX XX XX">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="companyEmail" placeholder="info@firma.com">
                    </div>
                    <div class="form-group">
                        <label>Website</label>
                        <input type="url" id="companyWebsite" placeholder="https://www.firma.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Adres *</label>
                    <textarea id="companyAddress" rows="3" required placeholder="Tam adres bilgisi..."></textarea>
                </div>
                
                <!-- Dökümanlar -->
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>📎 Dökümanlar (İsteğe Bağlı)</strong>
                    <p style="font-size: 0.9em; margin-top: 5px;">Ticaret Sicil Gazetesi, İmza Sirküleri, Vergi Levhası vb.</p>
                </div>
                
                <div id="companyDocumentsList"></div>
                <button type="button" class="btn btn-success" onclick="addCompanyDocument()">
                    ➕ Yeni Döküman Ekle
                </button>
                
                <!-- Log Bilgisi (Düzenleme modunda göster) -->
                <div id="companyLogInfo" style="display: none; margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px; font-size: 0.9em;">
                    <strong>📝 Kayıt Bilgileri:</strong>
                    <p id="companyCreatedInfo" style="margin: 5px 0;"></p>
                    <p id="companyUpdatedInfo" style="margin: 5px 0;"></p>
                </div>
                
                <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" class="btn btn-secondary" onclick="closeCompanyFormModal()">
                        ✖️ İptal
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveCompanyBtn">
                        💾 Firma Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Teklifler sekmesi -->
<div id="proposals" class="tab-content">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">📑 Teklifler</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Başvuru dokümanını yükleyerek veya manuel teklif oluşturabilirsiniz.</p>
        </div>
        <button class="btn btn-primary" onclick="openAddProposalModal()">
            ➕ Teklif Oluştur
        </button>
    </div>
    <div class="card">
        <h3>📋 Teklif Listesi</h3>
        <table id="proposalsTable">
            <thead>
                <tr>
                    <th>Teklif No</th>
                    <th>Firma</th>
                    <th>Başvuru Tarihi</th>
                    <th>Tutar</th>
                    <th>Durum</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Teklif ekleme/düzenleme modalı -->
<div id="proposalFormModal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="proposalFormModalTitle">➕ Teklif Oluştur</h3>
            <button class="close-modal" onclick="closeProposalFormModal()">✖</button>
        </div>
        <div style="padding: 20px;">
            <form id="proposalForm">
                <div class="alert alert-info">
                    <strong>Başvuru PDF veya Görsel Yükle</strong>
                    <p style="font-size: 0.9em; margin-top: 5px;">Başvuru.pdf veya başvuru formunun görselini yükleyin. Otomatik parse edilecek, eksik/hatalı alanlar manuel düzeltilebilir.</p>
                </div>
<div class="form-group">
    <label>PDF/Görsel Yükle</label>
    <input type="file" id="proposalDocument" accept=".pdf,image/png,image/jpeg" onchange="handleDocumentUpload(event)">
    <div style="margin-top:10px;">
        <button type="button" class="btn btn-info btn-sm" onclick="parseWithPDFjs()">PDF.js ile Parse</button>
    </div>
</div>
                <div id="documentParseResult" style="margin-bottom: 15px;"></div>
                <div class="alert alert-success">
                    <strong>Teklif Bilgileri</strong>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Teklif No</label>
                        <input type="text" id="proposalNumber" placeholder="Örn: 2025-Ç-127" required>
                    </div>
                    <div class="form-group">
                        <label>Başvuru No</label>
                        <input type="text" id="proposalApplicationNo" required>
                    </div>
                </div>

<!-- YENİ: Cari Hesap Seçimi -->
<div class="form-group">
    <label>👤 Cari Hesap Seç *</label>
    <select id="proposalCariAccount" onchange="fillFromCariAccount()" required>
        <option value="">Cari hesap seçiniz...</option>
    </select>
    <small style="color: #6b7280; display: block; margin-top: 5px;">
        ✨ Cari seçtiğinizde firma bilgileri otomatik doldurulur
    </small>
</div>

<div class="alert alert-warning" style="margin-top: 20px;">
    <strong>📋 Firma Bilgileri</strong>
    <button type="button" class="btn btn-sm btn-secondary" style="float: right;" onclick="toggleFirmaDetay()">
        Detayları Göster/Gizle
    </button>
</div>

<div id="firmaDetaySection" style="display: none;">
    <div class="form-group">
        <label>Firma Ünvanı</label>
        <input type="text" id="proposalCompany" placeholder="Örn: ABC Sanayi Ltd. Şti." required>
    </div>
    
    <div class="form-group">
        <label>Firma Adresi</label>
        <textarea id="proposalAddress" rows="2" placeholder="Tam adres giriniz" required></textarea>
    </div>
<div class="form-group">
    <label>Yetkili Kişi</label>
    <input type="text" id="proposalContactPerson" placeholder="Yetkili kişi adı">
</div>    
    <div class="grid-2">
        <div class="form-group">
            <label>Telefon</label>
            <input type="text" id="proposalPhone" placeholder="0 XXX XXX XX XX">
        </div>
        <div class="form-group">
            <label>E-posta</label>
            <input type="email" id="proposalEmail" placeholder="ornek@firma.com">
        </div>
    </div>
    
    <div class="alert alert-info" style="margin-top: 20px;">
        <strong>📄 Teklif İçerik Bilgileri</strong>
    </div>
    
    <div class="form-group">
        <label>Teklif Türü</label>
        <select id="proposalType" required>
            <option value="Emisyon Ölçümü">Emisyon Ölçümü</option>
            <option value="İmisyon Ölçümü">İmisyon Ölçümü</option>
            <option value="Emisyon-İmisyon Ölçümü">Emisyon-İmisyon Ölçümü</option>
        </select>
    </div>
    
    <div class="form-group">
        <label>Teklif İçeriği</label>
        <input type="text" id="proposalContent" value="İmisyon Ölçümü Fiyat Teklifi">
    </div>
    
    <div class="grid-2">
        <div class="form-group">
            <label>Teklifi Hazırlayan</label>
            <input type="text" id="proposalPreparedBy" value="Göknur YAĞAN" required>
        </div>
        <div class="form-group">
            <label>İletişim</label>
            <input type="text" id="proposalContact" value="0 282 651 46 50" required>
        </div>
    </div>
</div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>Başvuru Tarihi</label>
                        <input type="text" id="proposalApplicationDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Cari Hesap Seç</label>
                    <select id="proposalCari" onchange="checkCompanyMatch()">
                        <option value="">Cari seçiniz</option>
                        <!-- JS ile cariler doldurulacak -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Laboratuvar</label>
                    <input type="text" id="proposalLab">
                </div>
                <div class="form-group">
                    <label>Parametreler <button type="button" class="btn btn-info btn-sm" onclick="addParameterRow()">➕ Ekstra Parametre</button></label>
                    <table id="parametersTable" style="width:100%; margin-top:10px;">
                        <thead>
                            <tr>
                                <th>Parametre</th>
                                <th>Adet</th>
                                <th>Birim Fiyat</th>
                                <th>Toplam</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>KDV Hariç Toplam</label>
                        <input type="text" id="proposalTotal">
                    </div>
                    <div class="form-group">
                        <label>İndirimli KDV Hariç Toplam</label>
                        <input type="text" id="proposalDiscountedTotal">
                    </div>
                </div>
                <div class="form-group">
                    <label>Açıklamalar</label>
                    <textarea id="proposalNotes" rows="3"></textarea>
                </div>
		<button type="button" class="btn btn-success" onclick="createTeklifPDF()">
                    PDF Oluştur 1
                </button>
		<button type="button" class="btn btn-success" onclick="createProfessionalTeklifPDF()">
                    PDF Oluştur 2
                </button>
                <button type="button" class="btn btn-success" onclick="saveProposal()">
                    Kaydet
                </button>
            </form>
        </div>
    </div>
</div>

<!-- CARİ HESAP EKLEME/DÜZENLEME MODAL -->
<div id="accountFormModal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="accountFormModalTitle">➕ Yeni Cari Hesap Ekle</h3>
            <button class="close-modal" onclick="closeAccountFormModal()">✖</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="accountForm">
                <input type="hidden" id="accountId">
                <input type="hidden" id="accountCompanyId">
                
                <!-- Firma Bilgisi -->
                <div class="alert alert-info" id="accountCompanyInfo">
                    <strong>🏢 Firma:</strong> <span id="accountActiveCompanyName">Seçiniz</span>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>🏢 Firma *</label>
                        <select id="accountCompany" required onchange="updateAccountCompanyInfo()">
                            <option value="">Firma Seçiniz</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cari Adı *</label>
                        <input type="text" id="accountName" required placeholder="Örn: ABC Tedarik Ltd. Şti.">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Tür *</label>
                        <select id="accountType" required>
                            <option value="">Seçiniz</option>
                            <option value="customer">Müşteri</option>
                            <option value="supplier">Tedarikçi</option>
    			    <option value="personnel">Personel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vergi/TC No</label>
                        <input type="text" id="accountTaxNo" placeholder="10 veya 11 haneli">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="tel" id="accountPhone" placeholder="0XXX XXX XX XX">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="accountEmail" placeholder="info@cari.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Adres</label>
                    <textarea id="accountAddress" rows="3" placeholder="Adres bilgisi..."></textarea>
                </div>
                
                <!-- Dökümanlar -->
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>📎 Dökümanlar (Maks. 5 adet, Toplam 3 MB)</strong>
                    <p style="font-size: 0.9em; margin-top: 5px;">Sözleşme, Fatura örneği, Ön yazışmalar vb.</p>
                </div>
                
                <div id="accountDocumentsList"></div>
                <button type="button" class="btn btn-success" onclick="addAccountDocument()" id="addAccountDocBtn">
                    ➕ Döküman Ekle (0/5)
                </button>
                
                <div id="accountDocSizeInfo" style="margin-top: 10px; font-size: 0.9em; color: #6b7280;">
                    Toplam boyut: <strong id="accountDocSize">0 KB</strong> / 3 MB
                </div>
                
                <!-- Log Bilgisi -->
                <div id="accountLogInfo" style="display: none; margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px; font-size: 0.9em;">
                    <strong>📝 Kayıt Bilgileri:</strong>
                    <p id="accountCreatedInfo" style="margin: 5px 0;"></p>
                    <p id="accountUpdatedInfo" style="margin: 5px 0;"></p>
                </div>
                
                <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" class="btn btn-secondary" onclick="closeAccountFormModal()">
                        ✖️ İptal
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveAccountBtn">
                        💾 Cari Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- PDF Template (gizli) -->
<div id="pdfTemplate" style="display: none;">
    <div class="pdf-page page-1">
        <!-- KAPAK SAYFASI -->
        <div class="pdf-header">
            <div style="text-align: right; font-size: 10px;">
                <div>Teklif Numarası | <span id="pdf-teklif-no"></span></div>
                <div>Tarih | <span id="pdf-tarih"></span></div>
            </div>
        </div>
        
        <div class="pdf-logo-section" style="text-align: center; margin: 20px 0;">
            <!-- Sol logo -->
            <img src="logo-sol.png" style="width: 80px; display: inline-block;">
            <!-- Orta logo (GÖZDE) -->
            <img src="logo-gozde.png" style="width: 200px; display: inline-block; margin: 0 20px;">
            <!-- Sağ logo (TÜRKAK) -->
            <img src="logo-turkak.png" style="width: 80px; display: inline-block;">
        </div>
        
        <div style="text-align: center; margin: 10px 0;">
            <div style="font-weight: bold; font-size: 11px;">Yeterlilik Belge No</div>
            <div style="font-size: 11px;">Y-59/279/2021</div>
        </div>
        
        <h2 style="text-align: center; font-size: 12px; font-weight: bold;">
            GÖZDE ÇEVRE İŞ GÜVENLİĞİ ÖLÇÜM TEST<br>
            ANALİZ LABORATUVAR SAN. VE TİC. LTD. ŞTİ.
        </h2>
        
        <div style="text-align: center; font-size: 10px; margin: 10px 0;">
            Çobançeşme Mahallesi Atay Cad. No: 18 / B Çorlu / TEKİRDAĞ<br>
            Tel :+90 282 651 46 50<br>
            E-posta : bilgi@gozdeisglab.com / gozdecevrelaboratuvari@gmail.com<br>
            Website : www.gozdecevre.com
        </div>
        
        <h3 style="text-align: center; background: #4472C4; color: white; padding: 8px; font-size: 12px;">
            TEKLİF FORMU
        </h3>
        
        <table style="width: 100%; border-collapse: collapse; font-size: 10px; margin: 15px 0;">
            <tr>
                <td style="border: 1px solid #000; padding: 5px; font-weight: bold; width: 30%;">Firma Ünvanı</td>
                <td style="border: 1px solid #000; padding: 5px;" id="pdf-firma-unvan"></td>
            </tr>
            <tr>
                <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">Firma Adresi</td>
                <td style="border: 1px solid #000; padding: 5px;" id="pdf-firma-adres"></td>
            </tr>
            <tr>
                <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">Telefon</td>
                <td style="border: 1px solid #000; padding: 5px;">
                    <span id="pdf-telefon"></span> 
                    <span style="margin-left: 50px;">Mail</span>
                    <span id="pdf-mail"></span>
                </td>
            </tr>
            <tr>
                <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">Konu</td>
                <td style="border: 1px solid #000; padding: 5px;" id="pdf-konu"></td>
            </tr>
            <tr>
                <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">İçerik</td>
                <td style="border: 1px solid #000; padding: 5px;" id="pdf-icerik"></td>
            </tr>
            <tr>
                <td style="border: 1px solid #000; padding: 5px; font-weight: bold;">Melbes Başvuru No</td>
                <td style="border: 1px solid #000; padding: 5px;" id="pdf-basvuru-no"></td>
            </tr>
        </table>
        
        <div style="font-size: 10px; margin: 15px 0; line-height: 1.6;">
            <p>Sayın Yetkili,</p>
            <p>2025 Yılı Asgari Fiyat Tarifesine uygun olarak hazırlanan fiyat teklifidir...</p>
            <p>İyi Çalışmalar Dileriz.</p>
            <p>Saygılarımızla,<br>Gözde Çevre Laboratuvarı</p>
        </div>
        
        <div style="font-size: 10px; margin: 20px 0;">
            <div>Teklifi Hazırlayan</div>
            <div><strong><span id="pdf-hazirlayan"></span></strong></div>
            <div>İletişim: <span id="pdf-iletisim"></span></div>
        </div>
        
        <div style="position: absolute; bottom: 20px; font-size: 9px; font-style: italic;">
            <div>Teklifimiz 30 Gün Geçerlidir.</div>
            <div>Teklif imiz Onaylanması Durumunda Sözleşme Niteliğindedir.</div>
            <div>FR 89 / 08.01.2024-10</div>
        </div>
    </div>
    
<!-- SAYFA 2: PARAMETRELER TABLOSU -->
<div class="pdf-page page-2">
    <div class="page-number">
        <div>Teklif Numarası | <span class="pdf-teklif-no-copy"></span></div>
        <div>Tarih | <span class="pdf-tarih-copy"></span></div>
    </div>
    
    <h3 class="pdf-title">
        <span id="pdf-baslik-tur"></span> Fiyat Teklifi
    </h3>
    
<!-- ✅ DÜZELTİLMİŞ PARAMETRELER TABLOSU -->
<table class="pdf-table" id="pdf-parameters-table">
    <thead>
        <tr>
            <th style="width: 15%;">Kaynak Adı</th>
            <th style="width: 30%;">Ölçüm Parametresi</th>
            <th style="width: 25%;">Ölçüm Standardı</th>
            <th style="width: 8%; text-align: center;">Adet</th>
            <th style="width: 12%; text-align: right;">Birim Fiyat</th>
            <th style="width: 10%; text-align: right;">Toplam</th>
        </tr>
    </thead>
    <tbody>
        <!-- Dinamik olarak JavaScript ile doldurulacak -->
    </tbody>
</table>
<!-- ✅ TUTARLAR BÖLÜMÜ -->
<div class="pdf-totals">
    <div style="margin: 5px 0;">TOPLAM: <span id="pdf-toplam"></span></div>
    <div style="margin: 5px 0;">TABAN FİYAT: <span id="pdf-taban-fiyat"></span></div>
    <div style="margin: 5px 0; font-size: 10px;">GENEL TOPLAM: <span id="pdf-genel-toplam"></span></div>
</div>

<!-- ✅ KDV NOTU -->
<div style="font-size: 8px; margin-top: 10px;">
    <div>- Fiyatlarımıza %20 KDV Dahil Değildir.</div>
    <div id="pdf-ek-notlar"></div>
</div>
    
    <!-- Footer -->
    <div class="pdf-footer">
        <div>Teklifimiz 30 Gün Geçerlidir.</div>
        <div>Teklif imiz Onaylanması Durumunda Sözleşme Niteliğindedir.</div>
        <div>FR 89 / 08.01.2024-10</div>
    </div>
</div>

<!-- SAYFA 3: İDARİ HÜKÜMLER -->
<div class="pdf-page page-3" style="page-break-before: always;">
    <div style="text-align: right; font-size: 9px; margin-bottom: 20px;">
        <div>3 | S a y f a</div>
        <div>Teklif Numarası | <span class="pdf-teklif-no-copy"></span></div>
        <div>Tarih | <span class="pdf-tarih-copy"></span></div>
    </div>
    
    <h3 style="text-align: center; font-size: 13px; font-weight: bold; margin-bottom: 20px;">
        İDARİ HÜKÜMLER
    </h3>
    
    <div style="font-size: 10px; line-height: 1.6; text-align: justify;">
        <p><strong>1.</strong> Müşteri ve Laboratuvar, T.C Çevre, Şehircilik ve İklim Değişikliği Bakanlığı tarafından yayımlanan asgari fiyat tarifesi hükümlerine uymak zorundadır.</p>
        
        <p><strong>2.</strong> Söz konusu teklif 2025 Yılı Asgari Fiyat Tarifesi 'ne göre hazırlanmıştır.</p>
        
        <p><strong>3.</strong> Merkezi Laboratuvar Belirleme Sistemi (MELBES) ile gelen işler için; Başvuru tarihi, planlanan başlangıç tarihi gibi belirleyici durumlara uygun şekilde firmadan kaynaklı ölçüm planlaması yapılamaması durumunda, ölçüm tarihi dikkate alınarak ölçümün yapıldığı yıla ait asgari fiyat tarifesine göre teklif güncellenerek fatura edilecektir. (Örnek; Başvuru 2024 Yılı Temmuz ayında yapılmış, Planlanan ölçüm başlangıç tarihi en geç 15.08.2024, ancak firmadan kaynaklı ölçümler 15.02.2025 tarihinde yapıldı. 2025 yılı asgari fiyat tarifesine uygun olarak ölçüm bedeli kesilecektir.)</p>
        
        <p><strong>4.</strong> Teklifin onaylanmasını takiben, kuruluşunuz yetkili personeli ile birlikte ölçüm programı yapılacak ve tüm çalışmalar yapılan iş planına uygun olarak gerçekleştirilecektir. T.C Çevre ve Şehircilik Bakanlığının tebliği gereği MELBES Sistemine çevresel ölçüm programı en az 5 gün(120 saat) öncesinden bildirilmesi gerekmektedir. Ölçüm kayıt sisteminde kayıt tarihi ile beraber kayıt saati de kayıt işlemini etkilediği için, laboratuvarımız en az 6 gün öncesinden bildirimleri gerçekleştirmektedir. Ölçüm tarihleri belirlenirken, Laboratuvarımız müşteri ile ortak tarih belirlemektedir. Bakanlığa gönderilen ölçüm sistemi bildirimleri için program revizyonu ölçüm tarihinden en az 3 gün önce yapılabilir. Ölçüme 2 veya daha az gün kalması durumunda sistemde revizyon yapmak mümkün değildir.</p>
        
        <p><strong>5.</strong> Müşteriye ait tüm bilgi ve belgeleri Gizlilik ve Tarafsızlık ilkesine uygun olarak saklanır. Müşteri bilgilerinin 3. Şahıslarla paylaşılması için; Gözde Çevre Laboratuvarı müşteriyi yazılı olarak bilgilendirir. Müşterinin yazılı izni olması durumunda bilgiler paylaşılabilir. (Mail, yazılı belge v.b.) Müşterinin Çevre Yönetim Hizmetini yürüten EÇBS üzerinden atanmış Çevre Mühendisi müşteri adına bilgi ve belge talebi oluşturabilir.</p>
        
        <p><strong>6.</strong> Ancak; Müşteri adına MELBES sistemi üzerinden başvuruyu yapan, süreci yöneten Çevre Yönetim Hizmeti kuruluşu değişip, müşteri yeni bir Çevre Yönetim Hizmeti kuruluşu ile anlaşması durumunda laboratuvarımızdan bilgi ve belge talebi oluşturabilmesi için, Müşteri tarafından yazılı olarak (mail, yazılı belge v.b.) laboratuvarımız bilgilendirilmesi gerekmektedir.</p>
        
        <p><strong>7.</strong> T.C Çevre, Şehircilik ve İklim Değişikliği Bakanlığı ya da diğer yasal otoriteler müşteriye ait bilgilere ulaşmak isterse bilgilerin paylaşımı ile ilgili hususta müşteriye bilgi verilmeden bilgi ve belgeler yasal otoriteye iletilebilir.</p>
    </div>
    
    <div style="position: absolute; bottom: 15px; font-size: 9px; font-style: italic;">
        <div>Teklifimiz 30 Gün Geçerlidir.</div>
        <div>Teklif imiz Onaylanması Durumunda Sözleşme Niteliğindedir.</div>
        <div>FR 89 / 08.01.2024-10</div>
    </div>
</div>

<!-- SAYFA 4: ÖLÇÜME AİT BİLGİLER -->
<div class="pdf-page page-4" style="page-break-before: always;">
    <div style="text-align: right; font-size: 9px; margin-bottom: 20px;">
        <div>4 | S a y f a</div>
        <div>Teklif Numarası | <span class="pdf-teklif-no-copy"></span></div>
        <div>Tarih | <span class="pdf-tarih-copy"></span></div>
    </div>
    
    <h3 style="text-align: center; font-size: 13px; font-weight: bold; margin-bottom: 20px;">
        ÖLÇÜME AİT BİLGİLER
    </h3>
    
    <div style="font-size: 10px; line-height: 1.6; text-align: justify;">
        <p><strong>1.</strong> Ölçüm işlemleri, müşterinin tesislerinde mevcut emisyon kaynaklarından periyodik emisyon ölçümü yapılacak olanlar için gerçekleştirilecektir.</p>
        
        <p><strong>2.</strong> Ölçüm öncesi tesis yetkilileri ile ölçüm programı oluşturulacak ve programa uygun şekilde ölçümler gerçekleştirilecektir.</p>
        
        <p><strong>3.</strong> Ölçümler sırasında tesiste elektrik, su vb. ihtiyaçlar tesis tarafından karşılanacaktır.</p>
        
        <p><strong>4.</strong> Ölçüm ekibinin tesise giriş-çıkış işlemleri ve tesis içi güvenlik prosedürleri tesis tarafından sağlanacaktır.</p>
        
        <p><strong>5.</strong> Ölçüm noktalarına ulaşım için gerekli platform, merdiven vb. ekipmanlar tesis tarafından sağlanacak ve ölçüm ekibinin güvenliği tesis tarafından garanti altına alınacaktır.</p>
        
        <p><strong>6.</strong> Ölçüm sırasında kaynak normal çalışma şartlarında olacaktır. Kaynak durması veya anormal çalışma durumunda ölçüm ertelenecektir.</p>
        
        <p><strong>7.</strong> Ölçüm sırasında meydana gelebilecek kazalardan laboratuvarımız sorumlu değildir. Tesiste İSG prosedürlerine uygun çalışma şartları sağlanmalıdır.</p>
        
        <p><strong>8.</strong> Elektrik kesintilerinin, mekanik arızaların veya hava koşullarının ölçüm yapılmasına engel olması durumunda ölçümler ileri bir tarihe ertelenebilir. Bu durumda ek ücret talep edilmez.</p>
        
        <p><strong>9.</strong> Firmadan kaynaklı ölçüm erteleme durumlarında (tesis bakımda, tesis çalışmıyor vb.) ekibimiz çalışma noktasına geldikten sonra ölçüm yapılamaz ise ulaşım bedeli + 1 personel günlük çalışma ücreti tahsil edilecektir.</p>
        
        <p><strong>10.</strong> Ölçüm sırasında kaynak parametreleri (sıcaklık, basınç, debi vb.) tesis tarafından laboratuvar ekibine bildirilecektir.</p>
    </div>
    
    <div style="position: absolute; bottom: 15px; font-size: 9px; font-style: italic;">
        <div>Teklifimiz 30 Gün Geçerlidir.</div>
        <div>Teklif imiz Onaylanması Durumunda Sözleşme Niteliğindedir.</div>
        <div>FR 89 / 08.01.2024-10</div>
    </div>
</div>

<!-- SAYFA 5: RAPORLAMAYA AİT BİLGİLER -->
<div class="pdf-page page-5" style="page-break-before: always;">
    <div style="text-align: right; font-size: 9px; margin-bottom: 20px;">
        <div>5 | S a y f a</div>
        <div>Teklif Numarası | <span class="pdf-teklif-no-copy"></span></div>
        <div>Tarih | <span class="pdf-tarih-copy"></span></div>
    </div>
    
    <h3 style="text-align: center; font-size: 13px; font-weight: bold; margin-bottom: 20px;">
        RAPORLAMAYA AİT BİLGİLER
    </h3>
    
    <div style="font-size: 10px; line-height: 1.6; text-align: justify;">
        <p><strong>1.</strong> Ölçümlerin tamamlanmasını takiben, numune analizleri laboratuvarımızda gerçekleştirilecek ve sonuçlar rapor haline getirilecektir.</p>
        
        <p><strong>2.</strong> Rapor teslim süresi, ölçüm tarihinden itibaren en geç 15 iş günüdür. (Tatil günleri ve resmi tatiller hariç)</p>
        
        <p><strong>3.</strong> Acil rapor talebi durumunda ek ücret karşılığında rapor süresi kısaltılabilir.</p>
        
        <p><strong>4.</strong> Raporlar elektronik ortamda PDF formatında teslim edilecektir. Talep edilmesi durumunda ıslak imzalı orijinal rapor kargo ile gönderilebilir (kargo ücreti ayrıca tahsil edilir).</p>
        
        <p><strong>5.</strong> Raporlarda ölçüm sonuçları, yasal limit değerler, kullanılan standartlar ve akreditasyon bilgileri yer alacaktır.</p>
        
        <p><strong>6.</strong> Rapor onaylandıktan sonra içeriğinde değişiklik yapılmaz. Ancak raporda teknik hata tespit edilmesi durumunda düzeltme raporu düzenlenir.</p>
        
        <p><strong>7.</strong> Raporların geçerlilik süresi düzenlenme tarihinden itibaren 1 yıldır.</p>
        
        <p><strong>8.</strong> Rapor kopyaları müşteri talebi üzerine ek ücret karşılığında temin edilebilir.</p>
        
        <p><strong>9.</strong> MELBES sistemine rapor yükleme işlemi laboratuvarımız tarafından gerçekleştirilecektir.</p>
        
        <p><strong>10.</strong> Rapor sonuçlarına itiraz durumunda, numune saklama süresi içinde (ölçüm tarihinden itibaren 30 gün) yeniden analiz talep edilebilir.</p>
    </div>
    
    <div style="position: absolute; bottom: 15px; font-size: 9px; font-style: italic;">
        <div>Teklifimiz 30 Gün Geçerlidir.</div>
        <div>Teklif imiz Onaylanması Durumunda Sözleşme Niteliğindedir.</div>
        <div>FR 89 / 08.01.2024-10</div>
    </div>
</div>

<!-- SAYFA 6: ÖDEME ŞEKLİ -->
<div class="pdf-page page-6" style="page-break-before: always;">
    <div style="text-align: right; font-size: 9px; margin-bottom: 20px;">
        <div>6 | S a y f a</div>
        <div>Teklif Numarası | <span class="pdf-teklif-no-copy"></span></div>
        <div>Tarih | <span class="pdf-tarih-copy"></span></div>
    </div>
    
    <h3 style="text-align: center; font-size: 13px; font-weight: bold; margin-bottom: 20px;">
        ÖDEME ŞEKLİ
    </h3>
    
    <div style="font-size: 10px; line-height: 1.6; text-align: justify;">
        <p><strong>1.</strong> Faturanız, Ölçümler tamamlandıktan sonra düzenlenecektir.</p>
        
        <p><strong>2.</strong> Ödeme, fatura tarihinden itibaren 30 gün içinde aşağıdaki banka hesaplarımızdan birine yapılacaktır.</p>
        
        <p><strong>3.</strong> Ödeme yaparken lütfen fatura numarasını açıklama kısmına yazınız.</p>
        
        <p><strong>4.</strong> Vadeli ödeme talepleri değerlendirilerek ayrıca bildirilecektir.</p>
    </div>
    
    <div style="margin-top: 20px;">
        <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
            <thead>
                <tr style="background: #4472C4; color: white;">
                    <th style="border: 1px solid #000; padding: 8px;">FİRMA ADI</th>
                    <th style="border: 1px solid #000; padding: 8px;">BANKA ADI</th>
                    <th style="border: 1px solid #000; padding: 8px;">BANKA KODU</th>
                    <th style="border: 1px solid #000; padding: 8px;">ŞUBE ADI VE İLİ</th>
                    <th style="border: 1px solid #000; padding: 8px;">ŞUBE KODU</th>
                    <th style="border: 1px solid #000; padding: 8px;">IBAN NO</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="border: 1px solid #000; padding: 8px;">GÖZDE ÇEVRE İŞ GÜVENLİĞİ ÖLÇÜM TEST ANALİZ LABORATUVAR SAN. TİC. LTD. ŞTİ.</td>
                    <td style="border: 1px solid #000; padding: 8px;">DENİZBANK A.Ş.</td>
                    <td style="border: 1px solid #000; padding: 8px;">134</td>
                    <td style="border: 1px solid #000; padding: 8px;">ÇORLU ORION / TEKİRDAĞ</td>
                    <td style="border: 1px solid #000; padding: 8px;">9380</td>
                    <td style="border: 1px solid #000; padding: 8px;">TR64 0013 4000 0228 8009 2000 01</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div style="margin-top: 60px; font-size: 10px;">
        <div style="border: 2px solid #000; padding: 40px; text-align: center;">
            <div style="font-weight: bold; font-size: 12px;">MÜŞTERİ ONAYI</div>
            <div style="margin-top: 10px;">(İmza / Tarih / Firma Kaşesi)</div>
        </div>
    </div>
    
    <div style="position: absolute; bottom: 15px; font-size: 9px; font-style: italic;">
        <div>Teklifimiz 30 Gün Geçerlidir.</div>
        <div>Teklifimiz Onaylanması Durumunda Sözleşme Niteliğindedir.</div>
        <div>FR 89 / 08.01.2024-10</div>
    </div>
</div>

</div>

<!-- INVOICES TAB -->
<div id="invoices" class="tab-content">
    <!-- ÜST BAŞLIK VE BUTONLAR -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">📄 Faturalar</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalInvoicesCount">0</strong> fatura kayıtlı</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="openImportInvoiceModal()" style="font-size: 16px; padding: 12px 25px;">
                📤 E-Fatura İçe Aktar (CSV)
            </button>
            <button class="btn btn-primary" onclick="scrollToInvoiceForm()" style="font-size: 16px; padding: 12px 25px;">
                ➕ Manuel Fatura Ekle
            </button>
        </div>
    </div>

    <!-- FATURA LİSTESİ (Önce listeler gösterilsin) -->
    <div class="card">
        <h3>📋 Fatura Listesi</h3>
        
        <!-- FİLTRELER -->
        <div class="filters">
            <div class="grid-4">
                <div class="form-group">
                    <label>Başlangıç Tarihi</label>
                    <input type="date" id="filterStartDate">
                </div>
                <div class="form-group">
                    <label>Bitiş Tarihi</label>
                    <input type="date" id="filterEndDate">
                </div>
                <div class="form-group">
                    <label>Fatura Türü</label>
                    <select id="filterType">
                        <option value="">Tümü</option>
                        <option value="sales">Satış</option>
                        <option value="purchase">Alış</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ödeme Durumu</label>
                    <select id="filterPaymentStatus">
                        <option value="">Tümü</option>
                        <option value="paid">Ödendi</option>
                        <option value="partial">Kısmi</option>
                        <option value="unpaid">Ödenmedi</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-info" onclick="filterInvoices()">🔍 Filtrele</button>
            <button class="btn btn-warning" onclick="clearInvoiceFilters()">🔄 Temizle</button>
        </div>
        
        <table id="invoicesTable">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>No</th>
                    <th>Tür</th>
                    <th>Cari</th>
                    <th>Toplam</th>
                    <th>Ödenen</th>
                    <th>Kalan</th>
                    <th>Durum</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- MANUEL FATURA EKLEME FORMU (Aşağıda) -->
    <div class="card" id="invoiceFormCard">
        <h3>➕ Yeni Fatura Ekle (Manuel)</h3>
        <form id="invoiceForm">
                 <input type="hidden" id="invoiceId">
                        <div class="grid-4">
                            <div class="form-group">
                                <label>Fatura Türü *</label>
                                <select id="invoiceType" required>
                                    <option value="">Seçiniz</option>
                                    <option value="sales">Satış Faturası</option>
                                    <option value="purchase">Alış Faturası</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Fatura No *</label>
                                <input type="text" id="invoiceNo" required>
                            </div>
                            <div class="form-group">
                                <label>Tarih *</label>
                                <input type="date" id="invoiceDate" required>
                            </div>
                            <div class="form-group">
                                <label>Vade Tarihi</label>
                                <input type="date" id="invoiceDueDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Cari Hesap *</label>
                            <select id="invoiceAccount" required>
                                <option value="">Seçiniz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Açıklama</label>
                            <textarea id="invoiceDescription" rows="2"></textarea>
                        </div>

                        <div class="invoice-items">
                            <h4 style="margin-bottom:15px;">Fatura Kalemleri</h4>
                            <div id="invoiceItemsList"></div>
                            <button type="button" class="btn btn-success" onclick="addInvoiceItem()">➕ Kalem Ekle</button>
                        </div>

                        <div class="grid-3" style="margin-top: 20px;">
                            <div class="stat-card">
                                <h4>Ara Toplam</h4>
                                <div class="amount" id="invoiceSubtotal">0.00 ₺</div>
                            </div>
                            <div class="stat-card warning">
                                <h4>KDV</h4>
                                <div class="amount" id="invoiceVAT">0.00 ₺</div>
                            </div>
                            <div class="stat-card success">
                                <h4>Genel Toplam</h4>
                                <div class="amount" id="invoiceTotal">0.00 ₺</div>
                            </div>
                        </div>

            <!-- ✅ BURAYA EKLE - FATURA DEKONTI YÜKLEME -->
            <div class="form-group" style="margin-top: 20px;">
                <label>📎 Fatura Dekontı (Opsiyonel - Maks 5 MB)</label>
                <input type="file" id="invoiceReceipt" accept="image/*,.pdf" onchange="handleInvoiceReceipt(this)">
                <div id="invoiceReceiptPreview" style="margin-top: 10px;"></div>
            </div>
            <!-- ✅ BURAYA KADAR -->

                        <button type="submit" class="btn btn-primary" style="margin-top: 20px;" id="saveInvoiceBtn">💾 Fatura Kaydet</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelInvoiceEdit()" id="cancelInvoiceBtn" style="display:none;">✖️ İptal</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Fatura Listesi</h3>
                    <div class="filters">
                        <div class="grid-4">
                            <div class="form-group">
                                <label>Başlangıç Tarihi</label>
                                <input type="date" id="filterStartDate">
                            </div>
                            <div class="form-group">
                                <label>Bitiş Tarihi</label>
                                <input type="date" id="filterEndDate">
                            </div>
                            <div class="form-group">
                                <label>Fatura Türü</label>
                                <select id="filterType">
                                    <option value="">Tümü</option>
                                    <option value="sales">Satış</option>
                                    <option value="purchase">Alış</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Ödeme Durumu</label>
                                <select id="filterPaymentStatus">
                                    <option value="">Tümü</option>
                                    <option value="paid">Ödendi</option>
                                    <option value="partial">Kısmi</option>
                                    <option value="unpaid">Ödenmedi</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-info" onclick="filterInvoices()">🔍 Filtrele</button>
                        <button class="btn btn-warning" onclick="clearInvoiceFilters()">🔄 Temizle</button>
                    </div>
                    <table id="invoicesTable">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>No</th>
                                <th>Tür</th>
                                <th>Cari</th>
                                <th>Toplam</th>
                                <th>Ödenen</th>
                                <th>Kalan</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- PAYMENTS TAB -->
            <div id="payments" class="tab-content">
                <div class="card">
                    <h3>💰 Ödeme ve Tahsilat Yönetimi</h3>
                    
                    <div class="grid-2">
                        <div class="file-upload-area" onclick="document.getElementById('bankFileInput').click()" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
                            <h3>📤 Banka Özeti Yükle</h3>
                            <p style="margin: 10px 0; color: #6b7280;">Excel veya CSV dosyanızı sürükleyin veya tıklayın</p>
                            <p style="font-size: 0.9em; color: #9ca3af;">Desteklenen format: Ziraat Bankası, Excel, CSV</p>
                            <input type="file" id="bankFileInput" accept=".xlsx,.xls,.csv" style="display:none;" onchange="importBankStatement(event)">
                        </div>

                        <div style="background: var(--light); padding: 20px; border-radius: 8px;">
                            <h3>➕ Manuel Ödeme Ekle</h3>
                            <button class="btn btn-primary" onclick="openPaymentModal()" style="margin-top: 15px; width: 100%;">Yeni Ödeme/Tahsilat</button>
                            <div style="margin-top: 15px; font-size: 0.9em; color: #6b7280;">
                                <p>✓ Hızlı ödeme kaydı</p>
                                <p>✓ Faturaya bağlama</p>
                                <p>✓ Kısmi ödeme desteği</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>Ödeme Geçmişi</h3>
                    <div class="filters">
                        <div class="grid-3">
                            <div class="form-group">
                                <label>Başlangıç Tarihi</label>
                                <input type="date" id="paymentFilterStart">
                            </div>
                            <div class="form-group">
                                <label>Bitiş Tarihi</label>
                                <input type="date" id="paymentFilterEnd">
                            </div>
                            <div class="form-group">
                                <label>Cari</label>
                                <select id="paymentFilterAccount">
                                    <option value="">Tümü</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-info" onclick="filterPayments()">🔍 Filtrele</button>
                        <button class="btn btn-warning" onclick="clearPaymentFilters()">🔄 Temizle</button>
                    </div>
                    <table id="paymentsTable">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Cari</th>
                                <th>Tutar</th>
                                <th>Tip</th>
                                <th>Fatura</th>
                                <th>Açıklama</th>
                                <th>Kaynak</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTS TAB -->
            <div id="reports" class="tab-content">
                <div class="card">
                    <h3>Rapor Parametreleri</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Yıl</label>
                            <select id="reportYear">
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ay</label>
                            <select id="reportMonth">
                                <option value="">Tüm Yıl</option>
                                <option value="01">Ocak</option>
                                <option value="02">Şubat</option>
                                <option value="03">Mart</option>
                                <option value="04">Nisan</option>
                                <option value="05">Mayıs</option>
                                <option value="06">Haziran</option>
                                <option value="07">Temmuz</option>
                                <option value="08">Ağustos</option>
                                <option value="09">Eylül</option>
                                <option value="10">Ekim</option>
                                <option value="11">Kasım</option>
                                <option value="12">Aralık</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="generateReport()">📊 Rapor Oluştur</button>
                        </div>
                    </div>
                </div>

                <div id="reportResults"></div>

                <div class="card">
                    <h3>Cari Ekstre</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Cari Seçiniz</label>
                            <select id="statementAccount">
                                <option value="">Seçiniz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Başlangıç Tarihi</label>
                            <input type="date" id="statementStartDate">
                        </div>
                        <div class="form-group">
                            <label>Bitiş Tarihi</label>
                            <input type="date" id="statementEndDate">
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="generateStatement()">📋 Ekstre Görüntüle</button>
                    <div id="statementResults"></div>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div id="settings" class="tab-content">
                <div class="card">
                    <h3>Veri Yönetimi</h3>
                    <div class="export-section">
                        <h4>💾 Yedekleme ve Geri Yükleme</h4>
                        <p>Tüm verilerinizi yedekleyin veya önceki bir yedekten geri yükleyin.</p>
                        <button class="btn btn-success" onclick="exportData()">📥 Verileri Dışa Aktar</button>
                        <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">📤 Verileri İçe Aktar</button>
                        <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
                    </div>
                </div>

<div class="card">
    <h3>🔧 Bakiye Düzeltme</h3>
    <p>Cari hesap bakiyelerini fatura ve ödemelere göre yeniden hesaplar.</p>
    <button class="btn btn-warning" onclick="recalculateAccountBalances()">
        🔄 Bakiyeleri Yeniden Hesapla
    </button>
</div>

<div class="card">
    <h3>🔄 Duplicate Cari Temizleme</h3>
    <p>Aynı isim ve vergi numaralı cari hesapları bulur ve birleştirir.</p>
    <button class="btn btn-warning" onclick="findAndMergeDuplicateAccounts()">
        🔍 Duplicate Carileri Bul ve Birleştir
    </button>
</div>

<div class="card">
    <h3>Maaş Hesaplama Tablosu (CSV Yükle)</h3>
    <div style="margin-bottom:15px;">
        <input type="file" id="salaryTableCSV" accept=".csv" onchange="handleSalaryCSVUpload(event)">
        <button class="btn btn-info" onclick="downloadSalaryExample()">📥 Örnek CSV İndir</button>
        <span id="salaryTableStatus" style="margin-left:10px; color:green;"></span>
    </div>
</div>

                <div class="card">
                    <h3>⚠️ Tehlikeli İşlemler</h3>
                    <div class="alert alert-info">
                        <strong>Uyarı:</strong> Aşağıdaki işlemler geri alınamaz. Devam etmeden önce verilerinizi yedeklediğinizden emin olun.
                    </div>
                    <button class="btn btn-danger" onclick="clearAllData()">🗑️ Tüm Verileri Sil</button>
                </div>

<div class="card">
    <h3>🗑️ Çöp Kutusu</h3>
    <p>Son 30 gün içinde silinen faturalar buradan geri yüklenebilir.</p>
    <button class="btn btn-info" onclick="showTrashModal()">
        📋 Çöp Kutusunu Görüntüle
    </button>
</div>

                <div class="card">
                    <h3>ℹ️ Hakkında</h3>
                    <p><strong>Muhasebe Takip Sistemi v2.0</strong></p>
                    <p>✅ Çoklu firma desteği</p>
                    <p>✅ Gelişmiş ödeme takibi</p>
                    <p>✅ Banka özeti import</p>
                    <p>✅ Akıllı eşleştirme</p>
                    <p>✅ Vade takibi</p>
                    <p>✅ Kısmi ödeme desteği</p>
                    <p style="margin-top: 15px; color: #6b7280;">Veriler LocalStorage'da güvenle saklanır.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>💰 Yeni Ödeme/Tahsilat</h3>
                <button class="close-modal" onclick="closePaymentModal()">✖</button>
            </div>
            <form id="paymentForm">
                <input type="hidden" id="paymentId">
                <div class="form-group">
                    <label>Tarih *</label>
                    <input type="date" id="paymentDate" required>
                </div>
                <div class="form-group">
                    <label>Cari *</label>
                    <select id="paymentAccount" required onchange="loadAccountInvoices()">
                        <option value="">Seçiniz</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tutar *</label>
                    <input type="number" id="paymentAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Tip *</label>
                    <select id="paymentType" required>
                        <option value="income">Tahsilat (Gelen)</option>
                        <option value="expense">Ödeme (Giden)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Faturaya Bağla</label>
                    <select id="paymentInvoice">
                        <option value="">Genel Ödeme (Fatura Yok)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Açıklama</label>
                    <textarea id="paymentDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">💾 Kaydet</button>
                <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">✖️ İptal</button>
            </form>
        </div>
    </div>

<!-- ÖDEME DÜZENLEME MODAL -->
<div id="editPaymentModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>✏️ Ödeme Düzenle</h3>
            <button class="close-modal" onclick="closeEditPaymentModal()">✖</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="editPaymentForm">
                <input type="hidden" id="editPaymentId">
                
                <!-- Ödeme Bilgileri (Salt Okunur) -->
                <div class="alert alert-info">
                    <strong>💰 Ödeme Bilgileri</strong>
                    <div style="margin-top: 10px;">
                        <p><strong>Tutar:</strong> <span id="editPaymentAmount" style="font-size:1.3em; color:var(--primary);"></span></p>
                        <p><strong>Tarih:</strong> <span id="editPaymentDate"></span></p>
                        <p><strong>Kaynak:</strong> <span id="editPaymentSource"></span></p>
                    </div>
                </div>
                
                <!-- Cari Hesap (Değiştirilebilir) -->
                <div class="form-group">
                    <label>👤 Cari Hesap *</label>
                    <select id="editPaymentAccount" required onchange="loadEditPaymentInvoices()">
                        <option value="">Seçiniz</option>
                    </select>
                </div>
                
                <!-- Faturaya Bağla -->
                <div class="form-group">
                    <label>📄 Faturaya Bağla (Opsiyonel)</label>
                    <select id="editPaymentInvoice">
                        <option value="">Genel Ödeme (Fatura Yok)</option>
                    </select>
                    <small style="color:#6b7280; display:block; margin-top:5px;">
                        Eğer bu ödeme belirli bir faturaya aitse, yukarıdan seçin.
                    </small>
                </div>
                
                <!-- Açıklama -->
                <div class="form-group">
                    <label>📝 Açıklama</label>
                    <textarea id="editPaymentDescription" rows="3"></textarea>
                </div>
                
                <!-- İşlem Tipi (Otomatik belirlenir ama değiştirilebilir) -->
                <div class="form-group">
                    <label>🔄 İşlem Tipi</label>
                    <select id="editPaymentType">
                        <option value="income">📥 Tahsilat (Gelen)</option>
                        <option value="expense">📤 Ödeme (Giden)</option>
                    </select>
                </div>
                
                <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditPaymentModal()">
                        ✖️ İptal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        💾 Ödemeyi Güncelle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

    <!-- BANK IMPORT MODAL -->
    <div id="bankImportModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>📤 Banka Özeti Eşleştirme</h3>
                <button class="close-modal" onclick="closeBankImportModal()">✖</button>
            </div>
            <div id="bankImportContent"></div>
        </div>
    </div>

<!-- Transaction Details Modal -->
<div id="transactionDetailsModal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
">
    <div style="
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    ">
        <!-- Header -->
        <div style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        ">
            <h3 style="margin: 0; font-size: 20px;">💰 Banka İşlemleri</h3>
            <button onclick="closeTransactionDetailsModal()" style="
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.3s;
            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
               onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                ×
            </button>
        </div>

        <!-- Scrollable Content -->
        <div id="transactionDetailsContainer" style="
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        ">
            <!-- Transactions will be inserted here -->
        </div>

        <!-- Footer -->
        <div style="
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        ">
            <button onclick="closeTransactionDetailsModal()" style="
                padding: 10px 20px;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            ">
                İptal
            </button>
            <button onclick="saveAllTransactions()" style="
                padding: 10px 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
            ">
                💾 Tümünü Kaydet
            </button>
        </div>
    </div>
</div>

<!-- CARI HESAP KARTI MODAL -->
<div id="accountCardModal" class="modal">
    <div class="modal-content" style="max-width: 1200px; max-height: 95vh;">
        <div class="modal-header">
            <h3 id="accountCardTitle">📊 Cari Hesap Kartı</h3>
            <button class="close-modal" onclick="closeAccountCardModal()">✖</button>
        </div>
        
        <div style="padding: 20px;">
            <!-- Cari Bilgileri -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="grid-3">
                    <div>
                        <strong>Cari Adı:</strong>
                        <p id="cardAccountName" style="font-size: 1.2em; color: var(--primary); margin-top: 5px;">-</p>
                    </div>
                    <div>
                        <strong>Tür:</strong>
                        <p id="cardAccountType" style="margin-top: 5px;">-</p>
                    </div>
                    <div>
                        <strong>Güncel Bakiye:</strong>
                        <p id="cardAccountBalance" style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">-</p>
                    </div>
                </div>
                <div class="grid-3" style="margin-top: 15px;">
                    <div>
                        <strong>Telefon:</strong>
                        <p id="cardAccountPhone" style="margin-top: 5px;">-</p>
                    </div>
                    <div>
                        <strong>Email:</strong>
                        <p id="cardAccountEmail" style="margin-top: 5px;">-</p>
                    </div>
                    <div>
                        <strong>Vergi No:</strong>
                        <p id="cardAccountTaxNo" style="margin-top: 5px;">-</p>
                    </div>
                </div>
            </div>

            <!-- Filtreler -->
            <div class="filters" style="margin-bottom: 20px;">
                <div class="grid-4">
                    <div class="form-group">
                        <label>📅 Yıl</label>
                        <select id="cardFilterYear" onchange="filterAccountCard()">
                            <option value="">Tüm Yıllar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>📆 Başlangıç Tarihi</label>
                        <input type="date" id="cardFilterStartDate" onchange="filterAccountCard()">
                    </div>
                    <div class="form-group">
                        <label>📆 Bitiş Tarihi</label>
                        <input type="date" id="cardFilterEndDate" onchange="filterAccountCard()">
                    </div>
                    <div class="form-group">
                        <label>📋 İşlem Tipi</label>
                        <select id="cardFilterType" onchange="filterAccountCard()">
                            <option value="">Tümü</option>
                            <option value="invoice">Sadece Faturalar</option>
                            <option value="payment">Sadece Ödemeler</option>
                            <option value="income">Sadece Gelirler (Tahsilat)</option>
                            <option value="expense">Sadece Giderler (Ödeme)</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-warning" onclick="clearAccountCardFilters()">🔄 Filtreleri Temizle</button>
                <button class="btn btn-success" onclick="exportAccountCard()">📥 Excel'e Aktar</button>
		<button class="btn btn-success" onclick="matchOldDataWithNewAccount(currentAccountCardId)">🔗 Eski Verilerle Eşleştir</button>
            </div>

            <!-- Özet İstatistikler -->
            <div class="grid-4" style="margin-bottom: 20px;" id="cardStats">
                <div class="stat-card success">
                    <h4>Toplam Gelir</h4>
                    <div class="amount" id="cardTotalIncome">0.00 ₺</div>
                    <small id="cardIncomeCount">0 işlem</small>
                </div>
                <div class="stat-card danger">
                    <h4>Toplam Gider</h4>
                    <div class="amount" id="cardTotalExpense">0.00 ₺</div>
                    <small id="cardExpenseCount">0 işlem</small>
                </div>
                <div class="stat-card warning">
                    <h4>Fatura Toplamı</h4>
                    <div class="amount" id="cardTotalInvoices">0.00 ₺</div>
                    <small id="cardInvoiceCount">0 fatura</small>
                </div>
                <div class="stat-card info">
                    <h4>Net Bakiye</h4>
                    <div class="amount" id="cardNetBalance">0.00 ₺</div>
                    <small>Gelir - Gider</small>
                </div>
            </div>

            <!-- İşlem Listesi -->
            <div style="overflow-y: auto; max-height: 400px;">
                <table id="accountCardTable">
                    <thead style="position: sticky; top: 0; background: var(--primary); z-index: 10;">
                        <tr>
                            <th>Tarih</th>
                            <th>İşlem Tipi</th>
                            <th>Referans</th>
                            <th>Açıklama</th>
                            <th>Borç</th>
                            <th>Alacak</th>
                            <th>Bakiye</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- DÖKÜMAN GÖRÜNTÜLEME MODAL -->
<div id="documentsModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="documentsModalTitle">📎 Dökümanlar</h3>
            <button class="close-modal" onclick="closeDocumentsModal()">✖</button>
        </div>
        
        <div style="padding: 20px;">
            <div id="documentsListView"></div>
        </div>
    </div>
</div>

<!-- DÖKÜMAN DETAY MODAL (PDF/Resim Görüntüleme) -->
<div id="documentViewerModal" class="modal">
    <div class="modal-content" style="max-width: 1000px; max-height: 95vh;">
        <div class="modal-header">
            <h3 id="documentViewerTitle">📄 Döküman Görüntüle</h3>
            <button class="close-modal" onclick="closeDocumentViewer()">✖</button>
        </div>
        
        <div style="padding: 20px; overflow: auto; max-height: calc(95vh - 100px);">
            <div id="documentViewerContent" style="text-align: center;"></div>
        </div>
        
        <div style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #dee2e6; text-align: center;">
            <button class="btn btn-success" onclick="downloadCurrentDocument()">
                📥 İndir
            </button>
            <button class="btn btn-secondary" onclick="closeDocumentViewer()">
                ✖️ Kapat
            </button>
        </div>
    </div>
</div>

<!-- FİRMA DETAY GÖRÜNTÜLEME MODAL -->
<div id="companyDetailModal" class="modal">
    <div class="modal-content" style="max-width: 1000px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="companyDetailTitle">🏢 Firma Detayları</h3>
            <button class="close-modal" onclick="closeCompanyDetailModal()">✖</button>
        </div>
        
        <div style="padding: 30px;">
            <!-- Firma Özet Kartı -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                <div class="grid-2">
                    <div>
                        <h2 id="detailCompanyName" style="margin: 0 0 10px 0; color: white;">-</h2>
                        <p id="detailCompanySector" style="margin: 0; opacity: 0.9;">-</p>
                    </div>
                    <div style="text-align: right;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; display: inline-block;">
                            <div style="font-size: 0.9em; opacity: 0.9;">Toplam Cari Hesap</div>
                            <div id="detailAccountCount" style="font-size: 2.5em; font-weight: 700; margin-top: 5px;">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Temel Bilgiler -->
            <div class="card">
                <h3 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px;">
                    📋 Temel Bilgiler
                </h3>
                <div class="grid-2">
                    <div>
                        <p><strong>🏢 Firma Ünvanı:</strong></p>
                        <p id="detailCompanyNameFull" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                    <div>
                        <p><strong>🏭 Sektör:</strong></p>
                        <p id="detailCompanySectorFull" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                </div>
            </div>

            <!-- Vergi Bilgileri -->
            <div class="card">
                <h3 style="color: var(--warning); border-bottom: 2px solid var(--warning); padding-bottom: 10px; margin-bottom: 20px;">
                    💼 Vergi Bilgileri
                </h3>
                <div class="grid-2">
                    <div>
                        <p><strong>Vergi Numarası:</strong></p>
                        <p id="detailCompanyTaxNo" style="color: #1f2937; font-size: 1.1em; font-family: monospace;">-</p>
                    </div>
                    <div>
                        <p><strong>Vergi Dairesi:</strong></p>
                        <p id="detailCompanyTaxOffice" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                </div>
            </div>

            <!-- İletişim Bilgileri -->
            <div class="card">
                <h3 style="color: var(--success); border-bottom: 2px solid var(--success); padding-bottom: 10px; margin-bottom: 20px;">
                    📞 İletişim Bilgileri
                </h3>
                <div class="grid-3">
                    <div>
                        <p><strong>📱 Telefon:</strong></p>
                        <p id="detailCompanyPhone" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                    <div>
                        <p><strong>📧 Email:</strong></p>
                        <p id="detailCompanyEmail" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                    <div>
                        <p><strong>🌐 Website:</strong></p>
                        <p id="detailCompanyWebsite" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <p><strong>📍 Adres:</strong></p>
                    <p id="detailCompanyAddress" style="color: #1f2937; font-size: 1.1em; line-height: 1.6;">-</p>
                </div>
            </div>

            <!-- Dökümanlar -->
            <div class="card" id="detailCompanyDocumentsCard" style="display: none;">
                <h3 style="color: var(--info); border-bottom: 2px solid var(--info); padding-bottom: 10px; margin-bottom: 20px;">
                    📎 Dökümanlar
                </h3>
                <div id="detailCompanyDocuments"></div>
            </div>

            <!-- Kayıt Logları -->
            <div class="card" style="background: #f9fafb;">
                <h3 style="color: #6b7280; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 20px;">
                    📝 Kayıt Bilgileri
                </h3>
                <div class="grid-2">
                    <div>
                        <p><strong>Oluşturulma:</strong></p>
                        <p id="detailCompanyCreated" style="color: #1f2937;">-</p>
                    </div>
                    <div>
                        <p><strong>Son Güncelleme:</strong></p>
                        <p id="detailCompanyUpdated" style="color: #1f2937;">-</p>
                    </div>
                </div>
            </div>

            <!-- Finansal Özet -->
            <div class="card">
                <h3 style="color: var(--purple); border-bottom: 2px solid var(--purple); padding-bottom: 10px; margin-bottom: 20px;">
                    💰 Finansal Özet
                </h3>
                <div class="grid-4">
                    <div class="stat-card success">
                        <h4>Toplam Gelir</h4>
                        <div class="amount" id="detailTotalIncome">0.00 ₺</div>
                        <small id="detailIncomeInvoices">0 fatura</small>
                    </div>
                    <div class="stat-card danger">
                        <h4>Toplam Gider</h4>
                        <div class="amount" id="detailTotalExpense">0.00 ₺</div>
                        <small id="detailExpenseInvoices">0 fatura</small>
                    </div>
                    <div class="stat-card">
                        <h4>Net Kar/Zarar</h4>
                        <div class="amount" id="detailNetProfit">0.00 ₺</div>
                    </div>
                    <div class="stat-card warning">
                        <h4>Toplam Ödeme</h4>
                        <div class="amount" id="detailTotalPayments">0.00 ₺</div>
                        <small id="detailPaymentCount">0 ödeme</small>
                    </div>
                </div>
            </div>

            <!-- Cari Hesaplar Listesi -->
            <div class="card">
                <h3 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px;">
                    👥 Cari Hesaplar
                </h3>
                <div id="detailCompanyAccountsList"></div>
            </div>

            <!-- İşlem Butonları -->
            <div style="margin-top: 30px; text-align: center; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <button class="btn btn-warning" onclick="editCompanyFromDetail()">
                    ✏️ Düzenle
                </button>
                <button class="btn btn-success" onclick="viewCompanyAccountsFromDetail()">
                    👥 Cari Hesaplara Git
                </button>
                <button class="btn btn-info" onclick="viewCompanyDocumentsFromDetail()" id="detailViewDocsBtn" style="display: none;">
                    📎 Dökümanları Görüntüle
                </button>
                <button class="btn btn-secondary" onclick="closeCompanyDetailModal()">
                    ✖️ Kapat
                </button>
            </div>
        </div>
    </div>
</div>

<!-- E-FATURA İÇE AKTARMA MODAL -->
<div id="importInvoiceModal" class="modal">
    <div class="modal-content" style="max-width: 1200px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3>📤 E-Fatura İçe Aktarma (Excel/CSV)</h3>
            <button class="close-modal" onclick="closeImportInvoiceModal()">✖</button>
        </div>
        
        <div style="padding: 30px;">
            <!-- Yükleme Alanı -->
            <div class="alert alert-info">
                <strong>ℹ️ E-Fatura Formatı Hakkında</strong>
                <p style="margin: 10px 0 0 0; font-size: 0.95em;">
                    E-Fatura sisteminizden aldığınız <strong>CSV</strong> veya <strong>Excel</strong> dosyasını yükleyin.<br>
                    Sistem otomatik olarak fatura bilgilerini okuyacak ve <strong>cari hesaplarla eşleştirecektir</strong>.
                </p>
            </div>

            <!-- Fatura Türü Seçimi -->
            <div class="card" style="margin-bottom: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">📋 Fatura Türü Seçin</h4>
                <div style="display: flex; gap: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; flex: 1; transition: all 0.3s;">
                        <input type="radio" name="invoiceImportType" value="sales" checked onchange="updateInvoiceTypeSelection()" style="margin-right: 10px; width: 20px; height: 20px;">
                        <div>
                            <strong style="color: var(--success); font-size: 1.1em;">📗 Giden Fatura (Satış)</strong>
                            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">Müşterilerinize düzenlenen faturalar</p>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; flex: 1; transition: all 0.3s;">
                        <input type="radio" name="invoiceImportType" value="purchase" onchange="updateInvoiceTypeSelection()" style="margin-right: 10px; width: 20px; height: 20px;">
                        <div>
                            <strong style="color: var(--danger); font-size: 1.1em;">📕 Gelen Fatura (Alış)</strong>
                            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">Tedarikçilerinizden gelen faturalar</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Dosya Yükleme -->
            <div class="file-upload-area" 
                 onclick="document.getElementById('invoiceExcelFile').click()" 
                 ondragover="handleDragOver(event)" 
                 ondrop="handleInvoiceExcelDrop(event)"
                 style="cursor: pointer;">
                <h3>📂 CSV/Excel Dosyasını Yükle</h3>
                <p style="margin: 10px 0; color: #6b7280;">Dosyanızı sürükleyin veya tıklayın</p>
                <p style="font-size: 0.9em; color: #9ca3af;">Desteklenen format: .csv, .xlsx, .xls</p>
                <input type="file" 
                       id="invoiceExcelFile" 
                       accept=".csv,.xlsx,.xls" 
                       style="display:none;" 
                       onchange="importInvoiceExcel(event)">
            </div>

            <!-- Örnek Format Gösterimi -->
            <div class="card" style="margin-top: 20px; background: #f9fafb;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">📋 Beklenen Format (E-Fatura Standart)</h4>
                <p style="font-size: 0.9em; color: #6b7280; margin-bottom: 10px;">
                    CSV/Excel dosyanızda şu sütunlar olmalıdır:
                </p>
                <div style="overflow-x: auto;">
                    <table style="font-size: 0.85em; width: 100%;">
                        <thead style="background: var(--primary); color: white;">
                            <tr>
                                <th>Alıcı Adı</th>
                                <th>Fatura Numarası</th>
                                <th>Fatura Tarihi</th>
                                <th>Oluşturma Tarihi</th>
                                <th>Senaryo</th>
                                <th>Durum</th>
                                <th>Tutar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>ÖRNEK FİRMA A.Ş.</td>
                                <td>NRC2025000000369</td>
                                <td>30.09.2025</td>
                                <td>19.09.2025</td>
                                <td>TICARIFATURA</td>
                                <td>Gönderildi</td>
                                <td>10737,6</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FATURA EŞLEŞTİRME MODAL -->
<div id="invoiceMatchModal" class="modal">
    <div class="modal-content" style="max-width: 1400px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="invoiceMatchTitle">🔄 Fatura Eşleştirme</h3>
            <button class="close-modal" onclick="closeInvoiceMatchModal()">✖</button>
        </div>
        
        <div style="padding: 20px;">
            <div class="alert alert-success" id="invoiceMatchSummary">
                <strong>✅ <span id="matchedInvoiceCount">0</span> fatura başarıyla okundu!</strong>
            </div>

            <!-- Eşleştirme Listesi -->
            <div id="invoiceMatchList"></div>

            <!-- Alt Butonlar -->
            <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <button class="btn btn-secondary" onclick="closeInvoiceMatchModal()">
                    ✖️ İptal
                </button>
                <button class="btn btn-success" onclick="saveInvoicesFromModal()" style="font-size: 16px; padding: 12px 30px;">
    		    💾 <span id="saveInvoiceCount">0</span> Faturayı Kaydet
		</button>
            </div>
        </div>
    </div>
</div>

<!-- PURCHASES TAB - YENİ -->
<div id="purchases" class="tab-content">
    <!-- Üst Başlık ve Butonlar -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">💸 Alışlar (Nakit/Fiş)</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalPurchasesCount">0</strong> alış kaydı</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="openImportPurchasesModal()" style="font-size: 16px; padding: 12px 25px;">
                📤 Excel'den İçe Aktar
            </button>
            <button class="btn btn-primary" onclick="scrollToPurchaseForm()" style="font-size: 16px; padding: 12px 25px;">
                ➕ Yeni Alış Ekle
            </button>
        </div>
    </div>

    <!-- ALIŞ LİSTESİ -->
    <div class="card">
        <h3>📋 Alış Listesi</h3>
        
        <!-- FİLTRELER -->
        <div class="filters">
            <div class="grid-4">
                <div class="form-group">
                    <label>📅 Başlangıç Tarihi</label>
                    <input type="date" id="filterPurchaseStartDate">
                </div>
                <div class="form-group">
                    <label>📅 Bitiş Tarihi</label>
                    <input type="date" id="filterPurchaseEndDate">
                </div>
                <div class="form-group">
                    <label>🏷️ Kategori</label>
                    <select id="filterPurchaseCategory">
                        <option value="">Tümü</option>
                        <option value="Kırtasiye">Kırtasiye</option>
                        <option value="Yakıt">Yakıt</option>
                        <option value="Yemek">Yemek</option>
                        <option value="Temizlik">Temizlik</option>
                        <option value="Kargo">Kargo</option>
                        <option value="Elektrik">Elektrik</option>
                        <option value="Su">Su</option>
                        <option value="İnternet">İnternet</option>
                        <option value="Telefon">Telefon</option>
                        <option value="Bakım-Onarım">Bakım-Onarım</option>
                        <option value="Ulaşım">Ulaşım</option>
                        <option value="Diğer">Diğer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>💳 Ödeme Yöntemi</label>
                    <select id="filterPurchasePayment">
                        <option value="">Tümü</option>
                        <option value="cash">Nakit</option>
                        <option value="card">Kart</option>
                        <option value="transfer">Havale/EFT</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-info" onclick="filterPurchases()">🔍 Filtrele</button>
            <button class="btn btn-warning" onclick="clearPurchaseFilters()">🔄 Temizle</button>
        </div>
        
        <!-- ÖZET İSTATİSTİKLER -->
        <div class="grid-4" style="margin: 20px 0;">
            <div class="stat-card danger">
                <h4>Toplam Harcama</h4>
                <div class="amount" id="purchasesTotalAmount">0.00 ₺</div>
                <small id="purchasesCount">0 kayıt</small>
            </div>
            <div class="stat-card">
                <h4>KDV Hariç</h4>
                <div class="amount" id="purchasesSubtotal">0.00 ₺</div>
            </div>
            <div class="stat-card warning">
                <h4>Toplam KDV</h4>
                <div class="amount" id="purchasesTotalVAT">0.00 ₺</div>
                <small>Mahsup edilecek</small>
            </div>
            <div class="stat-card purple">
                <h4>Ortalama İşlem</h4>
                <div class="amount" id="purchasesAverage">0.00 ₺</div>
            </div>
        </div>
        
        <table id="purchasesTable">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>Kategori</th>
                    <th>Açıklama</th>
                    <th>Tedarikçi</th>
                    <th>KDV Hariç</th>
                    <th>KDV</th>
                    <th>Toplam</th>
                    <th>Ödeme</th>
                    <th>Fiş</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- ALIŞ EKLEME FORMU -->
    <div class="card" id="purchaseFormCard">
        <h3>➕ Yeni Alış Ekle</h3>
        <form id="purchaseForm">
            <input type="hidden" id="purchaseId">
            
            <div class="grid-3">
                <div class="form-group">
                    <label>📅 Tarih *</label>
                    <input type="date" id="purchaseDate" required>
                </div>
                <div class="form-group">
                    <label>🏷️ Kategori *</label>
                    <select id="purchaseCategory" required>
                        <option value="">Seçiniz</option>
                        <option value="Kırtasiye">📎 Kırtasiye</option>
                        <option value="Yakıt">⛽ Yakıt</option>
                        <option value="Yemek">🍽️ Yemek</option>
                        <option value="Temizlik">🧹 Temizlik</option>
                        <option value="Kargo">📦 Kargo</option>
                        <option value="Elektrik">💡 Elektrik</option>
                        <option value="Su">💧 Su</option>
                        <option value="İnternet">🌐 İnternet</option>
                        <option value="Telefon">📱 Telefon</option>
                        <option value="Bakım-Onarım">🔧 Bakım-Onarım</option>
                        <option value="Ulaşım">🚗 Ulaşım</option>
                        <option value="Diğer">📋 Diğer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>💳 Ödeme Yöntemi *</label>
                    <select id="purchasePaymentMethod" required>
                        <option value="">Seçiniz</option>
                        <option value="cash">💵 Nakit</option>
                        <option value="card">💳 Kredi/Banka Kartı</option>
                        <option value="transfer">🏦 Havale/EFT</option>
                    </select>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="form-group">
                    <label>Açıklama *</label>
                    <input type="text" id="purchaseDescription" required placeholder="Örn: A4 kağıt, toner">
                </div>
                <div class="form-group">
                    <label>Tedarikçi (Opsiyonel)</label>
                    <input type="text" id="purchaseSupplier" placeholder="Örn: Migros, BİM">
                </div>
            </div>
            
            <div class="grid-3">
                <div class="form-group">
                    <label>💰 Tutar (KDV Hariç) *</label>
                    <input type="number" id="purchaseAmount" step="0.01" required onchange="calculatePurchaseTotal()">
                </div>
                <div class="form-group">
                    <label>KDV Oranı *</label>
                    <select id="purchaseVATRate" required onchange="calculatePurchaseTotal()">
                        <option value="0">%0</option>
                        <option value="1">%1</option>
                        <option value="10">%10</option>
                        <option value="20" selected>%20</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>KDV Tutarı</label>
                    <input type="number" id="purchaseVATAmount" step="0.01" readonly style="background: #f3f4f6;">
                </div>
            </div>
            
            <div class="alert alert-info">
                <strong>💵 Toplam Ödenecek:</strong> 
                <span id="purchaseTotalDisplay" style="font-size: 1.5em; font-weight: 700; color: var(--danger);">0.00 ₺</span>
            </div>
            
            <!-- FİŞ YÜKLEME -->
            <div class="form-group">
                <label>📄 Fiş/Dekont Yükle (Opsiyonel - Maks 2 MB)</label>
                <input type="file" id="purchaseReceipt" accept="image/*,.pdf" onchange="handlePurchaseReceipt(this)">
                <div id="purchaseReceiptPreview" style="margin-top: 10px;"></div>
            </div>
            
            <div style="margin-top: 20px;">
                <button type="submit" class="btn btn-primary" id="savePurchaseBtn">💾 Alışı Kaydet</button>
                <button type="button" class="btn btn-secondary" onclick="cancelPurchaseEdit()" id="cancelPurchaseBtn" style="display:none;">✖️ İptal</button>
            </div>
        </form>
    </div>
</div>

<!-- PERSONNEL TAB -->
<div id="personnel" class="tab-content">
    <!-- Üst Başlık -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">👥 Personel Yönetimi</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalPersonnelCount">0</strong> personel</p>
        </div>
        <button class="btn btn-primary" onclick="openAddPersonnelModal()">
            ➕ Yeni Personel Ekle
        </button>
    </div>

    <!-- İstatistik Kartları -->
    <div class="grid-4" style="margin-bottom: 20px;">
        <div class="stat-card">
            <h4>Toplam Personel</h4>
            <div class="amount" id="activePersonnelCount">0</div>
            <small>Aktif çalışan</small>
        </div>
        <div class="stat-card danger">
            <h4>Bu Ay Maaş</h4>
            <div class="amount" id="monthlySalaryTotal">0.00 ₺</div>
        </div>
        <div class="stat-card warning">
            <h4>Bu Ay SGK</h4>
            <div class="amount" id="monthlySGKTotal">0.00 ₺</div>
        </div>
        <div class="stat-card success">
            <h4>Bu Ay İzin</h4>
            <div class="amount" id="monthlyLeaveCount">0</div>
            <small>gün</small>
        </div>
    </div>

    <!-- Personel Listesi -->
    <div class="card">
        <h3>📋 Personel Listesi</h3>
        <table id="personnelTable">
            <thead>
                <tr>
                    <th>Ad Soyad</th>
                    <th>Pozisyon</th>
                    <th>Maaş</th>
                    <th>SGK (%</th>
                    <th>İşe Başlama</th>
                    <th>Durum</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Devamsızlık ve İzin Takibi -->
    <div class="card">
        <h3>📅 Bu Ay Devamsızlık & İzin Takibi</h3>
        
        <div style="margin-bottom: 20px;">
            <label>Personel Seçin:</label>
            <select id="attendancePersonnelSelect" onchange="loadPersonnelAttendance()">
                <option value="">Personel Seçiniz</option>
            </select>
        </div>

        <div id="attendanceSection" style="display: none;">
            <div class="grid-2" style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="markAttendance('present')">
                    ✅ Geldi
                </button>
                <button class="btn btn-danger" onclick="markAttendance('absent')">
                    ❌ Gelmedi
                </button>
            </div>

            <button class="btn btn-warning" onclick="openLeaveRequestModal()">
                🏖️ İzin Talebi Oluştur
            </button>

            <div style="margin-top: 20px;">
                <h4>Bu Ayki Kayıtlar:</h4>
                <div id="attendanceRecords"></div>
            </div>
        </div>
    </div>

<div class="card">
  <h3>İzin Talepleri (Yönetici Paneli)</h3>
  <table>
    <thead>
      <tr>
        <th>Personel</th><th>Tarih</th><th>Tip</th><th>Açıklama</th>
        <th>Durum</th><th>Onaylayan</th><th>Detay</th><th>İşlem</th>
      </tr>
    </thead>
    <tbody id="adminLeaveRequestsTableBody"></tbody>
  </table>
</div>

<!-- PERSONEL TAB - MAAŞ ÖDEMELERİ REVİZE -->
<div class="card">
    <h3>💰 Maaş Ödemeleri (Netten İşveren Maliyeti)</h3>
    <div class="grid-3" style="margin-bottom: 20px;">
        <div class="form-group">
            <label>📅 Ay</label>
            <input type="month" id="salaryMonth" value="">
        </div>
        <div class="form-group">
            <label>👤 Personel</label>
            <select id="salaryPersonnelSelect">
                <option value="">Tüm Personel</option>
            </select>
        </div>
        <div class="form-group">
            <label>&nbsp;</label>
            <button class="btn btn-primary" onclick="processSalaryPayments()" style="width: 100%;">
                💸 Maaş Ödemelerini İşle
            </button>
        </div>
    </div>
    <!-- Yeni UI alanları -->
    <div class="grid-3" style="margin-bottom: 20px;">
        <div class="form-group">
            <label>Net Maaş (₺)</label>
            <input type="number" id="salaryNetInput" step="0.01" required>
        </div>
        <div class="form-group">
            <label>Ek Kazanç (₺)</label>
            <input type="number" id="salaryExtraInput" step="0.01" value="0">
        </div>
        <div class="form-group">
            <label>Toplam İşveren Maliyeti (₺)</label>
            <input type="text" id="salaryTotalCostDisplay" readonly style="background:#f3f4f6;">
        </div>
    </div>
    <!-- Rapor tablosu -->
    <table id="salaryPaymentsTable">
        <thead>
            <tr>
                <th>Tarih</th>
                <th>Personel</th>
                <th>Net Maaş</th>
                <th>Ek Kazanç</th>
                <th>Toplam İşveren Maliyeti</th>
                <th>Durum</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

    <!-- Yıllık maaş tablosu -->
    <div class="card">
        <h3>👤 Personel Yıllık Maaş Tablosu ve Dekont Yükleme</h3>
        <div class="grid-3" style="margin-bottom: 20px;">
            <div class="form-group">
                <label>Yıl</label>
                <select id="yearSalarySelect">
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
            </div>
            <div class="form-group">
                <label>Personel</label>
                <select id="yearPersonnelSelect"></select>
            </div>
            <div class="form-group">
                <label>&nbsp;</label>
                <button class="btn btn-info" onclick="renderYearlySalaryTable()">Yılı Listele</button>
            </div>
        </div>
        <div id="yearlySalaryTableSection"></div>
    </div>

<!-- PERSONEL EKLEME/DÜZENLEME MODAL -->
<div id="personnelFormModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="personnelFormModalTitle">➕ Yeni Personel Ekle</h3>
            <button class="close-modal" onclick="closePersonnelFormModal()">✖</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="personnelForm">
                <input type="hidden" id="personnelId">
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Ad Soyad *</label>
                        <input type="text" id="personnelName" required>
                    </div>
                    <div class="form-group">
                        <label>TC Kimlik No *</label>
                        <input type="text" id="personnelTCNo" maxlength="11" required>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Pozisyon *</label>
                        <input type="text" id="personnelPosition" required>
                    </div>
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="tel" id="personnelPhone">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Brüt Maaş (₺) *</label>
                        <input type="number" id="personnelSalary" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>SGK Oranı (%) *</label>
                        <input type="number" id="personnelSGKRate" value="14" step="0.01" required>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>İşe Başlama Tarihi *</label>
                        <input type="date" id="personnelStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>Durum</label>
                        <select id="personnelStatus">
                            <option value="active">Aktif</option>
                            <option value="inactive">Pasif</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Adres</label>
                    <textarea id="personnelAddress" rows="2"></textarea>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closePersonnelFormModal()">
                        ✖️ İptal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        💾 Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- İZİN TALEBİ MODAL -->
<div id="leaveRequestModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>🏖️ İzin Talebi Oluştur</h3>
            <button class="close-modal" onclick="closeLeaveRequestModal()">✖</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="leaveRequestForm">
                <div class="form-group">
                    <label>İzin Türü *</label>
                    <select id="leaveType" required>
                        <option value="">Seçiniz</option>
                        <option value="annual">Yıllık İzin</option>
                        <option value="sick">Hastalık İzni</option>
                        <option value="unpaid">Ücretsiz İzin</option>
                        <option value="other">Diğer</option>
                    </select>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Başlangıç *</label>
                        <input type="date" id="leaveStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>Bitiş *</label>
                        <input type="date" id="leaveEndDate" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Açıklama</label>
                    <textarea id="leaveDescription" rows="3"></textarea>
                </div>
                
                <div style="text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeLeaveRequestModal()">
                        ✖️ İptal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        💾 İzin Oluştur
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>

// ============================================
// 🎯 FUZZY MATCHING FONKSİYONLARI (EN ÜSTTE)
// ============================================

function calculateSimilarity(str1, str2) {
    // Metinleri normalize et
    const s1 = str1.toLowerCase()
        .replace(/ı/g, 'i')
        .replace(/ğ/g, 'g')
        .replace(/ü/g, 'u')
        .replace(/ş/g, 's')
        .replace(/ö/g, 'o')
        .replace(/ç/g, 'c')
        .trim();
    
    const s2 = str2.toLowerCase()
        .replace(/ı/g, 'i')
        .replace(/ğ/g, 'g')
        .replace(/ü/g, 'u')
        .replace(/ş/g, 's')
        .replace(/ö/g, 'o')
        .replace(/ç/g, 'c')
        .trim();
    
    // Tam eşleşme
    if (s1 === s2) return 100;
    
    // İçerme kontrolü
    if (s1.includes(s2) || s2.includes(s1)) {
        const longerLength = Math.max(s1.length, s2.length);
        const shorterLength = Math.min(s1.length, s2.length);
        return (shorterLength / longerLength) * 100;
    }
    
    // Levenshtein mesafesi ile benzerlik
    const longer = s1.length > s2.length ? s1 : s2;
    const shorter = s1.length > s2.length ? s2 : s1;
    
    if (longer.length === 0) return 100;
    
    const editDistance = calculateLevenshteinDistance(longer, shorter);
    return ((longer.length - editDistance) / longer.length) * 100;
}

function calculateLevenshteinDistance(str1, str2) {
    const matrix = [];
    
    for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
    }
    
    for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
    }
    
    for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
            if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i - 1][j - 1] + 1,
                    matrix[i][j - 1] + 1,
                    matrix[i - 1][j] + 1
                );
            }
        }
    }
    
    return matrix[str2.length][str1.length];
}

// ============================================
// 📊 PARAMETRE KATALOĞU
// ============================================

const PARAMS_CATALOG = [
    { name: "Partikül Madde", price: 4160 },
    { name: "Toz", price: 4160 },
    { name: "Yanma Gazları (SO2, CO, O2, NOx, CO2)", price: 2410 },
    { name: "Yanma Gazları", price: 2410 },
    { name: "SO2", price: 1125 },
    { name: "CO", price: 1125 },
    { name: "O2", price: 1125 },
    { name: "NOx", price: 1125 },
    { name: "CO2", price: 1125 },
    { name: "NH3", price: 3025 },
    { name: "NH", price: 3025 },
    { name: "Formaldehit", price: 6865 },
    { name: "PAH", price: 42220 },
    { name: "Florür", price: 7505 },
    { name: "Klorür", price: 7505 },
    { name: "Isilik", price: 710 },
    { name: "Ağır Metal", price: 19000 },
    { name: "Uçucu Organik Bileşikler ve Buhar (VOCs)", price: 13185 },
    { name: "Su Buharı (Nem)", price: 1430 },
    { name: "Hız", price: 1430 }
];

console.log('✅ PARAMS_CATALOG tanımlandı:', PARAMS_CATALOG.length, 'parametre');

// ============================================
// 🎯 PARAMETRE FUZZY EŞLEŞTİRME
// ============================================

function fuzzyParameterMatch(parameterName) {
    if (!parameterName) return null;
    
    console.log(`🔍 Fuzzy eşleştirme arıyor: "${parameterName}"`);
    
    // Tüm parametreleri kontrol et
    const matches = PARAMS_CATALOG.map(param => {
        const similarity = calculateSimilarity(parameterName, param.name);
        return {
            param: param,
            name: param.name,
            price: param.price,
            similarity: similarity
        };
    }).filter(m => m.similarity >= 70); // %70+ benzerlik
    
    // En yüksek skorlu parametreyi al
    matches.sort((a, b) => b.similarity - a.similarity);
    
    if (matches.length > 0) {
        const bestMatch = matches[0];
        console.log(`✅ En iyi eşleşme: "${bestMatch.name}" (%${bestMatch.similarity.toFixed(1)})`);
        return bestMatch;
    } else {
        console.warn(`❌ "${parameterName}" için uygun eşleşme bulunamadı (>%70)`);
        return null;
    }
}

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDjIhTD6qJFnXITxQQ1z3KiFk-zS8mGhWU",
  authDomain: "muhasebe-takip-sistemi.firebaseapp.com",
  projectId: "muhasebe-takip-sistemi",
  storageBucket: "muhasebe-takip-sistemi.firebasestorage.app",
  messagingSenderId: "120946847757",
  appId: "1:120946847757:web:6b0da047efc34534bda544",
  measurementId: "G-M0CJHK3HWN"
};

// Firebase'i başlat
firebase.initializeApp(firebaseConfig);

// Servisleri hazırla
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

console.log('✅ Firebase bağlantısı başarılı!');

// ========================================
// GOOGLE DRIVE ENTEGRASYONU
// ========================================

// Google API'yi başlat
function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    try {
        await gapi.client.init({
            apiKey: GOOGLE_API_KEY,
            discoveryDocs: [
                'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                'https://www.googleapis.com/discovery/v1/apis/gmail/v1/rest'
            ],
        });
        gapiInited = true;
        console.log('✅ Google API hazır (Drive + Gmail)');
    } catch (error) {
        console.error('❌ Google API başlatma hatası:', error);
        gapiInited = false;
    }
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES,
        callback: '', // sonra tanımlanacak
    });
    gisInited = true;
    console.log('✅ Google Identity Services hazır');
}

// Google Drive'a dosya yükle
async function uploadToGoogleDrive(file, fileName, mimeType) {
    if (!gapiInited || !gisInited) {
        throw new Error('Google Drive henüz hazır değil');
    }

    // Token yoksa al
    if (!accessToken) {
        await new Promise((resolve, reject) => {
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    reject(resp);
                }
                accessToken = gapi.client.getToken().access_token;
                resolve();
            };
            tokenClient.requestAccessToken({ prompt: 'consent' });
        });
    }

    // Dosyayı yükle
    const metadata = {
        name: fileName,
        mimeType: mimeType
    };

    const form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', file);

    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
        body: form,
    });

    const result = await response.json();
    
    // Dosyayı herkese açık yap
    await gapi.client.drive.permissions.create({
        fileId: result.id,
        resource: {
            role: 'reader',
            type: 'anyone',
        }
    });

    return {
        fileId: result.id,
        webViewLink: `https://drive.google.com/file/d/${result.id}/view`,
        webContentLink: `https://drive.google.com/uc?id=${result.id}&export=download`
    };
}

// Google Drive'dan dosya sil
async function deleteFromGoogleDrive(fileId) {
    if (!gapiInited || !accessToken) {
        throw new Error('Google Drive erişimi yok');
    }

    await gapi.client.drive.files.delete({
        fileId: fileId
    });
    
    console.log('✅ Dosya Google Drive\'dan silindi:', fileId);
}

// ========================================
// GLOBAL DATA STORE - Firebase ile senkronize
// ========================================
let companies = [];
let accounts = [];
let invoices = [];
let payments = [];
let purchases = [];
let personnel = [];
let attendanceRecords = [];
let leaveRequests = [];
let salaryPayments = [];
let salaryTableData = {};
let activeCompanyId = null;
let currentProposalDocument = null; // Yüklenen başvuru PDF'i
let currentInvoiceReceipt = null;
let currentPurchaseReceipt = null;
let companyDocuments = [];
let accountDocuments = [];
const MAX_ACCOUNT_DOCS = 5;
const MAX_ACCOUNT_SIZE = 3 * 1024 * 1024; // 3 MB

// E-Fatura import
let parsedInvoices = [];
let currentInvoiceType = 'sales';

// Banka import
let pendingTransactions = [];

// Ödeme düzenleme
let currentEditPaymentId = null;

// Google Drive için
let gapiInited = false;
let gisInited = false;
let tokenClient;
let accessToken = null;

// Google Drive ayarları
const GOOGLE_CLIENT_ID = '1089603522619-89h072ckei0h7kf2h7testpehuniob9m.apps.googleusercontent.com';
const GOOGLE_API_KEY = 'AIzaSyDcrZgT1UD-i938N6leIJ3ki99d0ntTNR8';
const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/gmail.send';

// Teklif verileri
let proposals = []; // Teklifleri tutacak array

// ========================================
// GLOBAL YARDIMCI FONKSİYONLAR
// ========================================

// Türkçe sayı formatını parse et (10.737,6 → 10737.6)
function parseTurkishNumber(str) {
    if (!str || typeof str !== 'string') return 0;
    
    str = str.trim();
    str = str.replace(/[^\d,.\-+]/g, ''); // Sadece sayı, virgül, nokta ve işaret
    str = str.replace(/\./g, ''); // Binlik ayracı noktayı kaldır
    str = str.replace(',', '.'); // Virgülü noktaya çevir
    
    let num = parseFloat(str);
    console.log(`Parse: "${str}" → ${num}`);
    return isNaN(num) ? 0 : num;
}

// Gmail API ile mail gönder (UTF-8 Fix)
async function sendEmailWithGmail(to, subject, body, pdfBlob, pdfFilename) {
    try {
        // PDF'i base64'e çevir
        const reader = new FileReader();
        const base64Promise = new Promise((resolve) => {
            reader.onloadend = () => {
                const base64 = reader.result.split(',')[1];
                resolve(base64);
            };
            reader.readAsDataURL(pdfBlob);
        });
        
        const pdfBase64 = await base64Promise;
        
        // Email oluştur (MIME format) - UTF-8 FIX
        const boundary = "boundary_" + Math.random().toString(36).substr(2);
        
        // ✅ UTF-8 encoding için subject'i encode et
        const encodedSubject = '=?UTF-8?B?' + btoa(unescape(encodeURIComponent(subject))) + '?=';
        
        const email = [
            'Content-Type: multipart/mixed; boundary="' + boundary + '"',
            'MIME-Version: 1.0',
            'To: ' + to,
            'Subject: ' + encodedSubject, // ✅ Encoded subject
            'Content-Transfer-Encoding: 8bit',
            '',
            '--' + boundary,
            'Content-Type: text/html; charset=UTF-8',
            'Content-Transfer-Encoding: quoted-printable', // ✅ quoted-printable encoding
            '',
            body,
            '',
            '--' + boundary,
            'Content-Type: application/pdf; name="' + pdfFilename + '"',
            'Content-Disposition: attachment; filename="' + pdfFilename + '"',
            'Content-Transfer-Encoding: base64',
            '',
            pdfBase64,
            '',
            '--' + boundary + '--'
        ].join('\r\n');
        
        // ✅ Düzgün UTF-8 encoding
        const encoder = new TextEncoder();
        const emailBytes = encoder.encode(email);
        
        // Base64url encoding
        let encodedEmail = '';
        const bytes = new Uint8Array(emailBytes);
        const len = bytes.length;
        for (let i = 0; i < len; i++) {
            encodedEmail += String.fromCharCode(bytes[i]);
        }
        encodedEmail = btoa(encodedEmail)
            .replace(/\+/g, '-')
            .replace(/\//g, '_')
            .replace(/=+$/, '');
        
        // Gmail API ile gönder
        const response = await gapi.client.gmail.users.messages.send({
            userId: 'me',
            resource: {
                raw: encodedEmail
            }
        });
        
        console.log('✅ Email gönderildi:', response);
        return response;
        
    } catch (error) {
        console.error('❌ Gmail API hatası:', error);
        throw error;
    }
}

// Teklifi Gmail ile gönder
async function sendProposalEmail(proposalId) {
    const proposal = proposals.find(p => p.id === proposalId);
    if (!proposal) {
        alert('Teklif bulunamadı!');
        return;
    }
    
    // ✅ Email'i önce cari hesaptan al
    let recipientEmail = null;
    let recipientName = proposal.firmaUnvan;
    
    if (proposal.cariAccount && proposal.cariAccount.id) {
        // Cari hesap seçilmişse, ondan al
        const cariAccount = accounts.find(a => a.id === proposal.cariAccount.id);
        if (cariAccount) {
            recipientEmail = cariAccount.email;
            recipientName = cariAccount.name;
            console.log('✅ Email cari hesaptan alındı:', recipientEmail);
        }
    }
    
    // ✅ Cari hesapta yoksa proposal'dan al
    if (!recipientEmail) {
        recipientEmail = proposal.mail;
        console.log('⚠️ Email proposal kaydından alındı:', recipientEmail);
    }
    
    if (!recipientEmail) {
        alert('❌ Firma e-posta adresi bulunamadı!\n\nLütfen cari hesap seçin veya email adresini manuel girin.');
        return;
    }
    
    const confirmSend = confirm(
        `📧 Teklif mail ile gönderilecek:\n\n` +
        `Alıcı: ${recipientEmail}\n` +
        `Firma: ${recipientName}\n` +
        `Teklif No: ${proposal.teklifNo}\n\n` +
        `Devam etmek istiyor musunuz?`
    );
    
    if (!confirmSend) return;
    
    try {
        console.log('📄 PDF oluşturuluyor...');
        
        const teklifData = {
            teklifNo: proposal.teklifNo,
            tarih: proposal.basvuruTarihi || new Date().toLocaleDateString('tr-TR'),
            firmaUnvan: recipientName, // ✅ Cari hesaptan gelen isim
            firmaAdres: proposal.firmaAdres || '',
            telefon: proposal.telefon || '',
            mail: recipientEmail, // ✅ Cari hesaptan gelen email
            konu: 'MELBES',
            icerik: proposal.icerik || 'İmisyon Ölçümü Fiyat Teklifi',
            baslikTur: proposal.baslikTur || 'Emisyon Ölçümü',
            basvuruNo: proposal.basvuruNo || '',
            hazirlayan: proposal.hazirlayan || 'Göknur YAĞAN',
            iletisim: proposal.iletisim || '0 282 651 46 50',
            parameters: proposal.parameters || [],
            toplam: proposal.toplam || '0,00 TL',
            tabanFiyat: proposal.tabanFiyat || '0,00 TL',
            genelToplam: proposal.genelToplam || '0,00 TL',
            ekNotlar: proposal.ekNotlar || ''
        };
        
        fillPDFTemplate(teklifData);
        
        const element = document.getElementById('pdfTemplate');
        element.style.display = 'block';
        
   const opt = {
            margin: 10,
            filename: `${proposal.teklifNo}_Teklif.pdf`,
            image: { type: 'jpeg', quality: 0.95 },
            html2canvas: { 
                scale: 1.5,
                useCORS: true, 
                letterRendering: true, 
                logging: false,
                scrollY: 0,
                scrollX: 0,
                backgroundColor: '#ffffff'
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait', 
                compress: true,
                precision: 2
            },
            pagebreak: { 
                mode: ['css', 'legacy'],
                before: '.pdf-page',
                after: '.pdf-page'
            }
        };

        const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');
        element.style.display = 'none';
        
        console.log('✅ PDF oluşturuldu:', (pdfBlob.size / 1024).toFixed(2), 'KB');
        
        // ✅ Gmail API başlatılmamışsa başlat
        if (!gapiInited || !gisInited) {
            alert('⏳ Google API başlatılıyor... Lütfen birkaç saniye bekleyin ve tekrar deneyin.');
            gapiLoaded();
            gisLoaded();
            return;
        }
        
        // ✅ Token yoksa al
        if (!accessToken) {
            console.log('🔐 Google izni isteniyor...');
            await new Promise((resolve, reject) => {
                tokenClient.callback = async (resp) => {
                    if (resp.error !== undefined) {
                        reject(resp);
                    }
                    accessToken = gapi.client.getToken().access_token;
                    resolve();
                };
                tokenClient.requestAccessToken({ prompt: 'consent' });
            });
        }
        
        // Email içeriği (HTML) - UTF-8 uyumlu
        const emailSubject = `Teklif: ${proposal.teklifNo} - ${recipientName}`; // ✅ Cari hesap adı
        const emailBody = `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                <h2 style="color: #2563eb;">Sayın ${recipientName} Yetkilileri,</h2>
                
                <p style="font-size: 16px; line-height: 1.6;">
                    <strong>${proposal.teklifNo}</strong> numaralı <strong>${proposal.baslikTur || 'Emisyon Ölçümü'}</strong> teklifimiz ektedir.
                </p>
                
                <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3 style="color: #1f2937; margin-top: 0;">📋 Teklif Detayları</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <tr>
                            <td style="padding: 8px 0; color: #6b7280;">Firma:</td>
                            <td style="padding: 8px 0; font-weight: bold;">${recipientName}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; color: #6b7280;">Toplam Tutar:</td>
                            <td style="padding: 8px 0; font-weight: bold; color: #10b981;">${proposal.genelToplam || '0,00 TL'}</td>
                        </tr>
                        <tr>
                            <td style="padding: 8px 0; color: #6b7280;">Teklif Tarihi:</td>
                            <td style="padding: 8px 0; font-weight: bold;">${proposal.basvuruTarihi || new Date().toLocaleDateString('tr-TR')}</td>
                        </tr>
                    </table>
                </div>
                
                <p style="font-size: 14px; line-height: 1.6;">
                    Teklif detayları için ekteki PDF dosyasını inceleyebilirsiniz.
                </p>
                
                <hr style="border: none; border-top: 1px solid #e5e7eb; margin: 30px 0;">
                
                <div style="color: #6b7280; font-size: 13px;">
                    <p style="margin: 5px 0;"><strong>GÖZDE Çevre İş Güvenliği Ölçüm Test Analiz Laboratuvar</strong></p>
                    <p style="margin: 5px 0;">Tel: 0 282 651 46 50</p>
                    <p style="margin: 5px 0;">Email: info@gozdecevre.com</p>
                    <p style="margin: 5px 0;">Web: www.gozdecevre.com</p>
                </div>
            </div>
        `;
        
        console.log('📤 Gmail ile mail gönderiliyor...');
        
        await sendEmailWithGmail(
            recipientEmail, // ✅ Cari hesaptan gelen email
            emailSubject,
            emailBody,
            pdfBlob,
            `${proposal.teklifNo}_Teklif.pdf`
        );
        
        alert('✅ Teklif mail ile başarıyla gönderildi!');
        
        // Teklif durumunu güncelle
        if (auth.currentUser) {
            await db.collection('users')
                .doc(auth.currentUser.uid)
                .collection('proposals')
                .doc(proposal.id)
                .update({
                    status: 'gonderildi',
                    sentDate: new Date().toISOString()
                });
            
            // Local state'i güncelle
            const proposalIndex = proposals.findIndex(p => p.id === proposal.id);
            if (proposalIndex >= 0) {
                proposals[proposalIndex].status = 'gonderildi';
                proposals[proposalIndex].sentDate = new Date().toISOString();
            }
            
            renderProposalsList();
        }
        
    } catch (error) {
        console.error('❌ Mail gönderme hatası:', error);
        
        if (error.result && error.result.error) {
            alert('❌ Mail gönderilemedi: ' + error.result.error.message);
        } else {
            alert('❌ Mail gönderilemedi: ' + error.message);
        }
    }
}

// Cari hesaba ait teklifleri göster
function showAccountProposals(accountId) {
    const accountProposals = proposals.filter(p => 
        p.cariAccount && p.cariAccount.id === accountId
    );
    
    if (accountProposals.length === 0) {
        return '<p style="color:#6b7280; padding:10px;">Bu cariye ait teklif bulunamadı</p>';
    }
    
    let html = '<div class="proposals-list" style="max-height:300px; overflow-y:auto;">';
    
    accountProposals.forEach(proposal => {
        html += `
            <div class="proposal-item" style="border:1px solid #e5e7eb; padding:10px; margin-bottom:10px; border-radius:5px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${proposal.teklifNo}</strong> - ${proposal.basvuruTarihi}
                        <br><small style="color:#6b7280;">${proposal.genelToplam}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-info" onclick="viewProposal('${proposal.id}')">
                            👁️
                        </button>
                        ${proposal.applicationDocument ? `
                        <button class="btn btn-sm btn-warning" onclick="window.open('${proposal.applicationDocument.viewLink}', '_blank')">
                            📄
                        </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

        // TAB NAVIGATION
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Reload data when switching to payments tab
            if (tabName === 'payments') {
                loadPayments();
            }
 	    if (tabName === 'personnel') {
    		loadLeaveRequestsAdminPanel();
  	    }
        }

// Cari hesap dökümanlarını Storage'a yükle
async function uploadAccountDocuments(companyId, accountId, documents) {
    const uploadedDocs = [];
    
    for (const doc of documents) {
        try {
            if (doc.file && doc.file.startsWith('data:')) {
                // Base64 dosyayı blob'a çevir
                const blob = await fetch(doc.file).then(r => r.blob());
                
                // Storage'a yükle
                const fileName = `${Date.now()}_${doc.fileName}`;
                const storageRef = storage.ref(`companies/${companyId}/accounts/${accountId}/${fileName}`);
                
                const snapshot = await storageRef.put(blob);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                uploadedDocs.push({
                    id: doc.id,
                    name: doc.name,
                    fileName: doc.fileName,
                    fileSize: doc.fileSize,
                    fileType: doc.fileType,
                    fileUrl: downloadURL,
                    uploadDate: doc.uploadDate
                });
                
                console.log(`✅ Cari döküman yüklendi: ${doc.name}`);
            }
        } catch (error) {
            console.error(`❌ Cari döküman yükleme hatası (${doc.name}):`, error);
        }
    }
    
    return uploadedDocs;
}

// Firma dökümanlarını Storage'a yükle
async function uploadCompanyDocuments(companyId, documents) {
    const uploadedDocs = [];
    
    for (const doc of documents) {
        try {
            if (doc.file && doc.file.startsWith('data:')) {
                // Base64 dosyayı blob'a çevir
                const blob = await fetch(doc.file).then(r => r.blob());
                
                // Storage'a yükle
                const fileName = `${Date.now()}_${doc.fileName}`;
                const storageRef = storage.ref(`companies/${companyId}/documents/${fileName}`);
                
                const snapshot = await storageRef.put(blob);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                uploadedDocs.push({
                    id: doc.id,
                    name: doc.name,
                    fileName: doc.fileName,
                    fileSize: doc.fileSize,
                    fileType: doc.fileType,
                    fileUrl: downloadURL,
                    uploadDate: doc.uploadDate
                });
                
                console.log(`✅ Döküman yüklendi: ${doc.name}`);
            }
        } catch (error) {
            console.error(`❌ Döküman yükleme hatası (${doc.name}):`, error);
        }
    }
    
    return uploadedDocs;
}

// ========================================
// FİRMA MODAL YÖNETİMİ
// ========================================

function openAddCompanyModal() {
    // Form temizle
    document.getElementById('companyForm').reset();
    document.getElementById('companyId').value = '';
    companyDocuments = [];
    renderCompanyDocuments();
    
    // Başlık değiştir
    document.getElementById('companyFormModalTitle').textContent = '➕ Yeni Firma Ekle';
    document.getElementById('saveCompanyBtn').textContent = '💾 Firma Kaydet';
    
    // Log bilgilerini gizle
    document.getElementById('companyLogInfo').style.display = 'none';
    
    // Modal'ı aç
    document.getElementById('companyFormModal').classList.add('active');
}

function closeCompanyFormModal() {
    document.getElementById('companyFormModal').classList.remove('active');
    document.getElementById('companyForm').reset();
    document.getElementById('companyId').value = '';
    companyDocuments = [];
    renderCompanyDocuments();
}

function editCompany(id) {
    const company = companies.find(c => c.id === id);
    if (!company) return;

    document.getElementById('companyId').value = company.id;
    document.getElementById('companyName').value = company.name;
    document.getElementById('companyTaxNo').value = company.taxNo;
    document.getElementById('companyTaxOffice').value = company.taxOffice || '';
    document.getElementById('companyPhone').value = company.phone || '';
    document.getElementById('companyEmail').value = company.email || '';
    document.getElementById('companyWebsite').value = company.website || '';
    document.getElementById('companyAddress').value = company.address || '';
    document.getElementById('companySector').value = company.sector || '';

    // Dökümanları yükle
    companyDocuments = company.documents ? JSON.parse(JSON.stringify(company.documents)) : [];
    renderCompanyDocuments();

    // Log bilgilerini göster
    if (company.createdAt) {
        const createdDate = new Date(company.createdAt).toLocaleString('tr-TR');
        const createdBy = company.createdBy || 'Bilinmiyor';
        document.getElementById('companyCreatedInfo').innerHTML = `📝 Oluşturulma: <strong>${createdDate}</strong> - <em>${createdBy}</em>`;
        
        if (company.updatedAt && company.updatedAt !== company.createdAt) {
            const updatedDate = new Date(company.updatedAt).toLocaleString('tr-TR');
            const updatedBy = company.updatedBy || 'Bilinmiyor';
            document.getElementById('companyUpdatedInfo').innerHTML = `🔄 Son Güncelleme: <strong>${updatedDate}</strong> - <em>${updatedBy}</em>`;
        } else {
            document.getElementById('companyUpdatedInfo').innerHTML = '';
        }
        
        document.getElementById('companyLogInfo').style.display = 'block';
    }

    // Başlık değiştir
    document.getElementById('companyFormModalTitle').textContent = '✏️ Firma Düzenle - ' + company.name;
    document.getElementById('saveCompanyBtn').textContent = '💾 Güncelle';

    // Modal'ı aç
    document.getElementById('companyFormModal').classList.add('active');
}

function cancelCompanyEdit() {
    closeCompanyFormModal();
}

// ========================================
// CARİ HESAP MODAL YÖNETİMİ
// ========================================

function openAddAccountModal() {
    // Firma kontrolü
    if (companies.length === 0) {
        alert('⚠️ Önce en az bir firma eklemelisiniz!');
        showTab('companies');
        document.querySelector('.tab[onclick*="companies"]').click();
        return;
    }
    
    // Form temizle
    document.getElementById('accountForm').reset();
    document.getElementById('accountId').value = '';
    accountDocuments = [];
    renderAccountDocuments();
    
    // Aktif firma varsa otomatik seç
    if (activeCompanyId) {
        document.getElementById('accountCompany').value = activeCompanyId;
        updateAccountCompanyInfo();
    }
    
    // Başlık değiştir
    document.getElementById('accountFormModalTitle').textContent = '➕ Yeni Cari Hesap Ekle';
    document.getElementById('saveAccountBtn').textContent = '💾 Cari Kaydet';
    
    // Log bilgilerini gizle
    document.getElementById('accountLogInfo').style.display = 'none';
    
    // Modal'ı aç
    document.getElementById('accountFormModal').classList.add('active');
}

function closeAccountFormModal() {
    document.getElementById('accountFormModal').classList.remove('active');
    document.getElementById('accountForm').reset();
    document.getElementById('accountId').value = '';
    accountDocuments = [];
    renderAccountDocuments();
}

function editAccount(id) {
    const account = accounts.find(a => a.id === id);
    if (!account) return;

    document.getElementById('accountId').value = account.id;
    document.getElementById('accountCompany').value = account.companyId;
    document.getElementById('accountName').value = account.name;
    document.getElementById('accountType').value = account.type;
    document.getElementById('accountTaxNo').value = account.taxNo || '';
    document.getElementById('accountPhone').value = account.phone || '';
    document.getElementById('accountEmail').value = account.email || '';
    document.getElementById('accountAddress').value = account.address || '';

    // Dökümanları yükle
    accountDocuments = account.documents ? JSON.parse(JSON.stringify(account.documents)) : [];
    renderAccountDocuments();

    updateAccountCompanyInfo();

    // Log bilgilerini göster
    if (account.createdAt) {
        const createdDate = new Date(account.createdAt).toLocaleString('tr-TR');
        const createdBy = account.createdBy || 'Bilinmiyor';
        document.getElementById('accountCreatedInfo').innerHTML = `📝 Oluşturulma: <strong>${createdDate}</strong> - <em>${createdBy}</em>`;
        
        if (account.updatedAt && account.updatedAt !== account.createdAt) {
            const updatedDate = new Date(account.updatedAt).toLocaleString('tr-TR');
            const updatedBy = account.updatedBy || 'Bilinmiyor';
            document.getElementById('accountUpdatedInfo').innerHTML = `🔄 Son Güncelleme: <strong>${updatedDate}</strong> - <em>${updatedBy}</em>`;
        } else {
            document.getElementById('accountUpdatedInfo').innerHTML = '';
        }
        
        document.getElementById('accountLogInfo').style.display = 'block';
    }

    // Başlık değiştir
    document.getElementById('accountFormModalTitle').textContent = '✏️ Cari Hesap Düzenle - ' + account.name;
    document.getElementById('saveAccountBtn').textContent = '💾 Güncelle';

    // Modal'ı aç
    document.getElementById('accountFormModal').classList.add('active');
}

function cancelAccountEdit() {
    closeAccountFormModal();
}

// ========================================
// ARAMA FONKSİYONLARI
// ========================================

function searchCompanies() {
    const searchTerm = document.getElementById('searchCompany').value.toLowerCase();
    const tbody = document.querySelector('#companiesTable tbody');
    const rows = tbody.getElementsByTagName('tr');
    
    let visibleCount = 0;
    
    for (let row of rows) {
        const companyName = row.cells[0]?.textContent.toLowerCase() || '';
        const sector = row.cells[1]?.textContent.toLowerCase() || '';
        const taxNo = row.cells[2]?.textContent.toLowerCase() || '';
        
        if (companyName.includes(searchTerm) || sector.includes(searchTerm) || taxNo.includes(searchTerm)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }
}

async function loadCompanies() {
    if (!auth.currentUser) {
        console.log('⚠️ Kullanıcı yok, firmalar yüklenmiyor');
        companies = [];
        return;
    }
    
    try {
        const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData && userData.companies && userData.companies.length > 0) {
            const companiesSnapshot = await db.collection('companies')
                .where(firebase.firestore.FieldPath.documentId(), 'in', userData.companies)
                .get();
            
            companies = [];
            companiesSnapshot.forEach(doc => {
                companies.push({ id: doc.id, ...doc.data() });
            });
            
            console.log('✅ Firmalar yüklendi:', companies.length);
            
            // İlk firma aktif firma olsun
            if (companies.length > 0 && !activeCompanyId) {
                activeCompanyId = companies[0].id;
            }
        } else {
            companies = [];
            console.log('ℹ️ Kullanıcıya ait firma yok');
        }
        
    } catch (error) {
        console.error('❌ Firma yükleme hatası:', error);
        companies = [];
    }
    
    renderCompaniesTable();
    populateCompanySelects();
}

// ========================================
// RENDER FONKSIYONLARI (Firebase İçin Ayrılmış)
// ========================================

function renderCompaniesTable() {
    const tbody = document.querySelector('#companiesTable tbody');
    if (!tbody) {
        console.warn('Companies table tbody bulunamadı');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (companies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">🏢</div><h3>Henüz firma yok</h3><p>Yeni firma eklemek için "Yeni Firma Ekle" butonunu kullanın.</p></td></tr>';
        return;
    }
    
    companies.forEach(company => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${company.name}</strong></td>
            <td>${company.taxNo || '-'}</td>
            <td>${company.phone || '-'}</td>
            <td>${company.sector || '-'}</td>
            <td>
                <button class="btn btn-sm btn-info" onclick="setActiveCompany('${company.id}')" title="Aktif Yap">
                    ${activeCompanyId === company.id ? '✅' : '⭕'}
                </button>
            </td>
            <td>
                <button class="btn btn-sm" onclick="viewCompanyDetail('${company.id}')" title="Detay">👁️</button>
                <button class="btn btn-warning btn-sm" onclick="editCompany('${company.id}')" title="Düzenle">✏️</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCompany('${company.id}')" title="Sil">🗑️</button>
            </td>
        `;
    });
    
    console.log('✅ Firma tablosu render edildi');
}

// ========================================
// ÖDEME DÜZENLEME FONKSİYONU
// ========================================

function editPayment(paymentId) {
    const payment = payments.find(p => p.id === paymentId);
    
    if (!payment) {
        alert('❌ Ödeme kaydı bulunamadı!');
        return;
    }
    
    // Modal HTML'i oluştur
    const modalHtml = `
        <div class="modal active" id="editPaymentModal" style="display: flex;">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <h3>✏️ Ödemeyi Düzenle</h3>
                    <button class="close-modal" onclick="closeEditPaymentModal()">✖</button>
                </div>
                
                <div style="padding: 30px;">
                    <form id="editPaymentForm">
                        <input type="hidden" id="editPaymentId" value="${payment.id}">
                        
                        <!-- Tarih -->
                        <div class="form-group">
                            <label>📅 Tarih *</label>
                            <input type="date" id="editPaymentDate" value="${payment.date}" required>
                        </div>
                        
                        <!-- Cari Hesap -->
                        <div class="form-group">
                            <label>👤 Cari Hesap *</label>
                            <select id="editPaymentAccount" required>
                                <option value="">Seçiniz</option>
                                ${accounts
                                    .filter(a => a.companyId === activeCompanyId)
                                    .map(a => `
                                        <option value="${a.id}" ${payment.accountId === a.id ? 'selected' : ''}>
                                            ${a.name} (${a.type === 'customer' ? 'Müşteri' : 'Tedarikçi'})
                                        </option>
                                    `).join('')}
                            </select>
                        </div>
                        
                        <!-- Tutar -->
                        <div class="form-group">
                            <label>💰 Tutar *</label>
                            <input type="number" id="editPaymentAmount" value="${payment.amount}" 
                                   min="0" step="0.01" required>
                        </div>
                        
                        <!-- İşlem Tipi -->
                        <div class="form-group">
                            <label>🔄 İşlem Tipi *</label>
                            <select id="editPaymentType" required>
                                <option value="income" ${payment.type === 'income' ? 'selected' : ''}>
                                    💰 Tahsilat (Gelen Ödeme)
                                </option>
                                <option value="expense" ${payment.type === 'expense' ? 'selected' : ''}>
                                    💸 Ödeme (Giden Ödeme)
                                </option>
                            </select>
                        </div>
                        
                        <!-- Fatura Bağlantısı -->
                        <div class="form-group">
                            <label>📄 Fatura (Opsiyonel)</label>
                            <select id="editPaymentInvoice">
                                <option value="">Fatura bağlama</option>
                                ${invoices
                                    .filter(inv => inv.accountId === payment.accountId)
                                    .map(inv => `
                                        <option value="${inv.id}" ${payment.invoiceId === inv.id ? 'selected' : ''}>
                                            ${inv.invoiceNo} - ${formatCurrency(inv.total)}
                                        </option>
                                    `).join('')}
                            </select>
                        </div>
                        
                        <!-- Açıklama -->
                        <div class="form-group">
                            <label>📝 Açıklama</label>
                            <textarea id="editPaymentDescription" rows="3">${payment.description || ''}</textarea>
                        </div>
                        
                        <!-- Kaynak Bilgisi (sadece gösterim) -->
                        <div class="alert alert-info">
                            <strong>ℹ️ Kaynak:</strong> ${payment.source === 'bank' ? '🏦 Banka' : '✏️ Manuel'}
                        </div>
                        
                        <!-- Butonlar -->
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button type="button" class="btn btn-secondary" onclick="closeEditPaymentModal()" style="flex: 1;">
                                ✖️ İptal
                            </button>
                            <button type="submit" class="btn btn-success" style="flex: 2;">
                                💾 Güncelle
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    
    // Modal'ı sayfaya ekle
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
    
    // Form submit handler
    document.getElementById('editPaymentForm').addEventListener('submit', updatePayment);
    
    // Cari değişince faturaları güncelle
    document.getElementById('editPaymentAccount').addEventListener('change', function() {
        updateEditPaymentInvoices();
    });
}

function closeEditPaymentModal() {
    const modal = document.getElementById('editPaymentModal');
    if (modal) {
        modal.remove();
    }
}

function updateEditPaymentInvoices() {
    const accountId = document.getElementById('editPaymentAccount').value;
    const invoiceSelect = document.getElementById('editPaymentInvoice');
    
    invoiceSelect.innerHTML = '<option value="">Fatura bağlama</option>';
    
    if (!accountId) return;
    
    const accountInvoices = invoices.filter(inv => inv.accountId === accountId);
    
    accountInvoices.forEach(inv => {
        const option = new Option(
            `${inv.invoiceNo} - ${formatCurrency(inv.total)}`,
            inv.id
        );
        invoiceSelect.add(option);
    });
}

async function updatePayment(e) {
    e.preventDefault();
    
    const paymentId = document.getElementById('editPaymentId').value;
    const payment = payments.find(p => p.id === paymentId);
    
    if (!payment) {
        alert('❌ Ödeme kaydı bulunamadı!');
        return;
    }
    
    // Yeni değerleri al
    const newDate = document.getElementById('editPaymentDate').value;
    const newAccountId = document.getElementById('editPaymentAccount').value;
    const newAmount = parseFloat(document.getElementById('editPaymentAmount').value);
    const newType = document.getElementById('editPaymentType').value;
    const newInvoiceId = document.getElementById('editPaymentInvoice').value || null;
    const newDescription = document.getElementById('editPaymentDescription').value || '';
    
    // ⚠️ Validation
    if (!newDate || !newAccountId || !newAmount || !newType) {
        alert('⚠️ Lütfen tüm zorunlu alanları doldurun!');
        return;
    }
    
    // Eski değerleri sakla
    const oldAccountId = payment.accountId;
    const oldAmount = payment.amount;
    const oldType = payment.type;
    const oldInvoiceId = payment.invoiceId;
    
    try {
        console.log('🔄 Ödeme güncelleniyor:', paymentId);
        
        // ========================================
        // 1. ESKİ BAKİYELERİ GERİ AL
        // ========================================
        
        // Eski cariden bakiyeyi geri al
        const oldAccount = accounts.find(a => a.id === oldAccountId);
        if (oldAccount) {
            console.log(`👤 Eski cari: ${oldAccount.name}`);
            if (oldType === 'income') {
                oldAccount.balance += oldAmount;
            } else {
                oldAccount.balance -= oldAmount;
            }
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('accounts').doc(oldAccountId).update({
                    balance: oldAccount.balance
                });
            
            console.log(`✅ Eski cari güncellendi: ${formatCurrency(oldAccount.balance)}`);
        }
        
        // Eski faturadan ödemeyi geri al
        if (oldInvoiceId) {
            const oldInvoice = invoices.find(inv => inv.id === oldInvoiceId);
            if (oldInvoice) {
                oldInvoice.paidAmount = Math.max(0, (oldInvoice.paidAmount || 0) - oldAmount);
                
                if (oldInvoice.paidAmount <= 0) {
                    oldInvoice.status = 'unpaid';
                } else if (oldInvoice.paidAmount >= oldInvoice.total) {
                    oldInvoice.status = 'paid';
                } else {
                    oldInvoice.status = 'partial';
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('invoices').doc(oldInvoiceId).update({
                        paidAmount: oldInvoice.paidAmount,
                        status: oldInvoice.status
                    });
                
                console.log(`✅ Eski fatura güncellendi: ${oldInvoice.invoiceNo}`);
            }
        }
        
        // ========================================
        // 2. YENİ DEĞERLERİ UYGULA
        // ========================================
        
        // Yeni cariye bakiye ekle
        const newAccount = accounts.find(a => a.id === newAccountId);
        if (newAccount) {
            console.log(`👤 Yeni cari: ${newAccount.name}`);
            if (newType === 'income') {
                newAccount.balance -= newAmount;
            } else {
                newAccount.balance += newAmount;
            }
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('accounts').doc(newAccountId).update({
                    balance: newAccount.balance
                });
            
            console.log(`✅ Yeni cari güncellendi: ${formatCurrency(newAccount.balance)}`);
        }
        
        // Yeni faturaya ödeme ekle
        if (newInvoiceId) {
            const newInvoice = invoices.find(inv => inv.id === newInvoiceId);
            if (newInvoice) {
                newInvoice.paidAmount = (newInvoice.paidAmount || 0) + newAmount;
                
                if (newInvoice.paidAmount >= newInvoice.total) {
                    newInvoice.status = 'paid';
                } else if (newInvoice.paidAmount > 0) {
                    newInvoice.status = 'partial';
                } else {
                    newInvoice.status = 'unpaid';
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('invoices').doc(newInvoiceId).update({
                        paidAmount: newInvoice.paidAmount,
                        status: newInvoice.status
                    });
                
                console.log(`✅ Yeni fatura güncellendi: ${newInvoice.invoiceNo}`);
            }
        }
        
        // ========================================
        // 3. ÖDEME KAYDINI GÜNCELLE
        // ========================================
        
        const updatedPayment = {
            date: newDate,
            accountId: newAccountId,
            amount: newAmount,
            type: newType,
            description: newDescription,
            updatedAt: new Date().toISOString(),
            updatedBy: auth.currentUser.uid
        };
        
        // ⚠️ invoiceId için özel işlem (undefined olmasın)
        if (newInvoiceId) {
            updatedPayment.invoiceId = newInvoiceId;
        } else if (oldInvoiceId) {
            // Eğer eski fatura varsa ama yeni yoksa, Firebase'den kaldır
            updatedPayment.invoiceId = firebase.firestore.FieldValue.delete();
        }
        // Eğer ikisi de yoksa invoiceId field'ini hiç ekleme
        
        await db.collection('companies').doc(activeCompanyId)
            .collection('payments').doc(paymentId).update(updatedPayment);
        
        // Local array'i güncelle (invoiceId null olabilir)
        payment.date = newDate;
        payment.accountId = newAccountId;
        payment.amount = newAmount;
        payment.type = newType;
        payment.description = newDescription;
        payment.invoiceId = newInvoiceId || null;
        payment.updatedAt = updatedPayment.updatedAt;
        payment.updatedBy = updatedPayment.updatedBy;
        
        console.log('✅ Ödeme başarıyla güncellendi');
        
        closeEditPaymentModal();
        
        // UI'ı yenile
        await Promise.all([
            loadPayments(),
            loadInvoices(),
            loadAccounts()
        ]);
        
        // Eğer cari kartı açıksa yenile
        if (currentAccountCardId) {
            loadAccountCardTransactions();
            filterAccountCard();
        }
        
        updateDashboard();
        
        alert('✅ Ödeme başarıyla güncellendi!');
        
    } catch (error) {
        console.error('❌ Ödeme güncelleme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

function renderInvoicesTable() {
    const tbody = document.querySelector('#invoicesTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    const companyInvoices = invoices
        .filter(inv => !activeCompanyId || inv.companyId === activeCompanyId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

    const totalCountElement = document.getElementById('totalInvoicesCount');
    if (totalCountElement) {
        totalCountElement.textContent = companyInvoices.length;
    }

    if (companyInvoices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">📄</div><h3>Henüz fatura yok</h3><p>Yeni fatura eklemek veya E-Fatura import yapmak için yukarıdaki butonları kullanın.</p></td></tr>';
        if (typeof updateRecentInvoices === 'function') {
            updateRecentInvoices();
        }
        return;
    }

    companyInvoices.forEach(invoice => {
        const account = accounts.find(a => a.id === invoice.accountId);
        const typeText = invoice.type === 'sales' ? '📤 Giden' : '📥 Gelen';
        const typeColor = invoice.type === 'sales' ? 'var(--success)' : 'var(--danger)';
        
        const remaining = invoice.total - (invoice.paidAmount || 0);
        const paidAmountText = invoice.paidAmount > 0 ? formatCurrency(invoice.paidAmount) : '-';
        
        let statusText = 'Ödenmedi';
        let statusClass = 'badge-danger';
        
        if (invoice.status === 'paid' || remaining <= 0) {
            statusText = 'Ödendi';
            statusClass = 'badge-success';
        } else if (invoice.status === 'partial' || invoice.paidAmount > 0) {
            statusText = 'Kısmi';
            statusClass = 'badge-warning';
        }

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${invoice.invoiceNo}</strong></td>
            <td>${formatDate(invoice.date)}</td>
            <td style="color: ${typeColor};">${typeText}</td>
            <td>${account ? account.name : 'Silinmiş'}</td>
            <td style="font-weight: 700;">${formatCurrency(invoice.total)}</td>
            <td>${paidAmountText}</td>
            <td style="color: ${remaining > 0 ? 'var(--danger)' : 'var(--success)'};">
                ${formatCurrency(remaining)}
            </td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
            <td style="white-space: nowrap;">
                ${invoice.receiptUrl ? `
                    <button class="btn btn-sm btn-info" onclick="viewInvoiceReceipt('${invoice.id}')" title="Dekontu Görüntüle">
                        📎
                    </button>
                ` : ''}
                <button class="btn btn-sm" onclick="viewInvoice('${invoice.id}')" title="Detay">👁️</button>
                <button class="btn btn-info btn-sm" onclick="editInvoice('${invoice.id}')" title="Düzenle">✏️</button>
                <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice.id}')" title="Sil">🗑️</button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    if (typeof updateRecentInvoices === 'function') {
        updateRecentInvoices();
    }
}

function renderPurchasesTable() {
    const tbody = document.querySelector('#purchasesTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const companyPurchases = purchases
        .filter(p => !activeCompanyId || p.companyId === activeCompanyId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const totalCountElement = document.getElementById('totalPurchasesCount');
    if (totalCountElement) {
        totalCountElement.textContent = companyPurchases.length;
    }
    
    if (companyPurchases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">💸</div><h3>Henüz alış kaydı yok</h3><p>Yeni alış eklemek için yukarıdaki butonu kullanın.</p></td></tr>';
        if (typeof updatePurchaseStats === 'function') {
            updatePurchaseStats([]);
        }
        return;
    }
    
    companyPurchases.forEach(purchase => {
        const paymentMethodText = {
            'cash': '💵 Nakit',
            'card': '💳 Kart',
            'transfer': '🏦 Havale'
        }[purchase.paymentMethod] || purchase.paymentMethod;
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${formatDate(purchase.date)}</td>
            <td><span class="badge badge-info">${purchase.category}</span></td>
            <td><strong>${purchase.description}</strong></td>
            <td>${purchase.supplier || '-'}</td>
            <td>${formatCurrency(purchase.amount)}</td>
            <td>${formatCurrency(purchase.vatAmount)} <small>(%${purchase.vatRate})</small></td>
            <td style="font-weight: 700; color: var(--danger);">${formatCurrency(purchase.total)}</td>
            <td>${paymentMethodText}</td>
            <td>
                ${(purchase.receiptUrl || (purchase.receipt && purchase.receipt.file)) ? `
                    <button class="btn btn-info btn-sm" onclick="viewPurchaseReceipt('${purchase.id}')" title="Fişi Görüntüle">
                        📄
                    </button>
                ` : '<span style="color:#6b7280;">-</span>'}
            </td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editPurchase('${purchase.id}')" title="Düzenle">✏️</button>
                <button class="btn btn-danger btn-sm" onclick="deletePurchase('${purchase.id}')" title="Sil">🗑️</button>
            </td>
        `;
    });
    
    if (typeof updatePurchaseStats === 'function') {
        updatePurchaseStats(companyPurchases);
    }
}

function renderPaymentsTable() {
    const tbody = document.querySelector('#paymentsTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const companyPayments = payments
        .filter(p => !activeCompanyId || p.companyId === activeCompanyId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (companyPayments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">💰</div><h3>Henüz ödeme kaydı yok</h3></td></tr>';
        return;
    }
    
    companyPayments.forEach(payment => {
        const account = accounts.find(a => a.id === payment.accountId);
        const typeText = payment.type === 'income' ? '📥 Tahsilat' : '📤 Ödeme';
        const typeColor = payment.type === 'income' ? 'var(--success)' : 'var(--danger)';
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${formatDate(payment.date)}</td>
            <td style="color:${typeColor};">${typeText}</td>
            <td>${account ? account.name : 'Silinmiş'}</td>
            <td style="font-weight:700; color:${typeColor};">${formatCurrency(payment.amount)}</td>
            <td>${payment.description || '-'}</td>
            <td>
    		<button class="btn btn-warning btn-sm" onclick="editPayment('${payment.id}')" title="Düzenle">✏️</button>
                <button class="btn btn-danger btn-sm" onclick="deletePayment('${payment.id}')" title="Sil">🗑️</button>
            </td>
        `;
    });
}



function renderPersonnelTable() {
    const tbody = document.querySelector('#personnelTable tbody');
    if (!tbody) {
        console.warn('personnelTable tbody bulunamadı!');
        return;
    }
    
    tbody.innerHTML = '';
    
    // Sadece aktif firmaya ait personeli göster
    const companyPersonnel = personnel.filter(p => 
        !activeCompanyId || p.companyId === activeCompanyId
    );
    
    // Personel sayısını güncelle
    const totalCountElement = document.getElementById('totalPersonnelCount');
    if (totalCountElement) {
        totalCountElement.textContent = companyPersonnel.length;
    }
    
    if (companyPersonnel.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">👥</div><h3>Henüz personel kaydı yok</h3></td></tr>';
        return;
    }
    
    companyPersonnel.forEach(person => {
        const statusClass = person.status === 'active' ? 'success' : 'danger';
        const statusText = person.status === 'active' ? 'Aktif' : 'Pasif';
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${person.name}</strong></td>
            <td>${person.position || '-'}</td>
            <td>${formatCurrency(person.salary || 0)}</td>
            <td>${person.sgkRate || 0}%</td>
            <td>${formatDate(person.startDate)}</td>
            <td><span class="badge badge-${statusClass}">${statusText}</span></td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editPersonnel('${person.id}')" title="Düzenle">✏️</button>
                <button class="btn btn-danger btn-sm" onclick="deletePersonnel('${person.id}')" title="Sil">🗑️</button>
            </td>
        `;
    });
    
    console.log('✅ Personel tablosu render edildi:', companyPersonnel.length, 'personel');
}

async function loadAccounts() {
    if (!activeCompanyId || !auth.currentUser) {
        accounts = [];
        renderAccountsTable();
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('accounts').get();
        
        accounts = [];
        snapshot.forEach(doc => {
            accounts.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('✅ Cari hesaplar yüklendi:', accounts.length);
        
    } catch (error) {
        console.error('❌ Cari hesap yükleme hatası:', error);
        accounts = [];
    }
    
    renderAccountsTable();
}

async function loadInvoices() {
    if (!activeCompanyId || !auth.currentUser) {
        invoices = [];
        renderInvoicesTable();
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('invoices').orderBy('date', 'desc').get();
        
        // ⬇️ DEĞİŞİKLİK: Sadece aktif faturaları filtrele
        invoices = [];
        snapshot.forEach(doc => {
            const invoice = { id: doc.id, ...doc.data() };
            // Silinmiş ve pasif olanları atla
            if (invoice.status !== 'deleted' && invoice.status !== 'passive') {
                invoices.push(invoice);
            }
        });
        
        console.log('✅ Faturalar yüklendi (sadece aktif):', invoices.length);
        
    } catch (error) {
        console.error('❌ Fatura yükleme hatası:', error);
        invoices = [];
    }
    
    renderInvoicesTable();
}

// Firmadan Cari Hesaplara Geçiş Fonksiyonu
function viewCompanyAccounts(companyId) {
    // Firma seçimini güncelle
    activeCompanyId = companyId;
    localStorage.setItem('activeCompanyId', activeCompanyId);
    
    // Filtre seçimini ayarla
    const filterSelect = document.getElementById('filterAccountCompany');
    if (filterSelect) {
        filterSelect.value = companyId;
    }
    
    // Cari Hesaplar sekmesine geç
    showTab('accounts');
    document.querySelector('.tab[onclick*="accounts"]').click();
    
    // Tabloyu güncelle
    populateSelects();
    loadAccounts();
    updateDashboard();
    
    // Bilgilendirme
    const company = companies.find(c => c.id === companyId);
    const accountCount = accounts.filter(a => a.companyId === companyId).length;
    
    setTimeout(() => {
        alert(`📊 ${company.name}\n\n${accountCount} cari hesap gösteriliyor.`);
    }, 300);
}

async function deleteCompany(id) {
    if (!confirm('Bu firmayı ve tüm ilgili verileri silmek istediğinizden emin misiniz?')) {
        return;
    }
    
    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    try {
        // Firestore'dan sil
        await db.collection('companies').doc(id).delete();
        
        // Kullanıcının firma listesinden çıkar
        await db.collection('users').doc(auth.currentUser.uid).update({
            companies: firebase.firestore.FieldValue.arrayRemove(id)
        });
        
        // Local array'den sil
        companies = companies.filter(c => c.id !== id);
        invoices = invoices.filter(inv => inv.companyId !== id);
        accounts = accounts.filter(acc => acc.companyId !== id);
        payments = payments.filter(pay => pay.companyId !== id);
        purchases = purchases.filter(pur => pur.companyId !== id);
        personnel = personnel.filter(per => per.companyId !== id);
        
        // Aktif firma silinmişse temizle
        if (activeCompanyId === id) {
            activeCompanyId = companies.length > 0 ? companies[0].id : null;
        }
        
        await loadCompanies();
        updateDashboard();
        
        alert('✅ Firma ve ilgili tüm veriler silindi!');
        
    } catch (error) {
        console.error('Firma silme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

        function changeActiveCompany() {
            activeCompanyId = document.getElementById('activeCompanySelect').value;
            localStorage.setItem('activeCompanyId', activeCompanyId);
            updateDashboard();
            loadAccounts();
            loadInvoices();
            loadPayments();
            populateSelects();
        }


// ========================================
// ACCOUNT FUNCTIONS - GÜNCELLENMIŞ
// ========================================

async function saveAccount(e) {
    e.preventDefault();
    
    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    const selectedCompanyId = document.getElementById('accountCompany').value;
    if (!selectedCompanyId) {
        alert('⚠️ Lütfen bir firma seçin!');
        return;
    }
    
    // ========================================
    // DUPLICATE KONTROL (YENİ EKLEME)
    // ========================================
    const accountId = document.getElementById('accountId').value;
    const accountName = document.getElementById('accountName').value.trim();
    const accountTaxNo = document.getElementById('accountTaxNo').value.trim();
    
    // Yeni kayıt ise duplicate kontrol et
    if (!accountId) {
        const newAccountKey = `${accountName.toUpperCase()}_${accountTaxNo || ""}`;
        
        const existingAccount = accounts
            .filter(a => a.companyId === selectedCompanyId)
            .filter(a => a.status !== "passive" && a.status !== "deleted")
            .find(a => {
                const existingKey = `${a.name.trim().toUpperCase()}_${a.taxNo || ""}`;
                return existingKey === newAccountKey;
            });
        
        if (existingAccount) {
            const confirmCreate = confirm(
                `⚠️ "${accountName}" isimli cari hesap zaten kayıtlı!\n\n` +
                `Mevcut cari:\n` +
                `• İsim: ${existingAccount.name}\n` +
                `• Vergi No: ${existingAccount.taxNo || 'Yok'}\n` +
                `• Bakiye: ${formatCurrency(existingAccount.balance)}\n` +
                `• Tür: ${existingAccount.type === 'customer' ? 'Müşteri' : 'Tedarikçi'}\n\n` +
                `Yine de YENİ cari oluşturmak ister misiniz?\n\n` +
                `❌ HAYIR → İptal et (önerilen)\n` +
                `✅ EVET → Yeni cari oluştur (duplicate olur)`
            );
            
            if (!confirmCreate) {
                console.log('Kullanıcı duplicate cari oluşturmayı iptal etti');
                return;
            }
        }
    }
    
    // ========================================
    // DÖKÜMAN YÜKLEME
    // ========================================
    let uploadedDocs = [];
    if (accountDocuments.length > 0) {
        try {
            // Geçici ID oluştur (döküman yükleme için)
            const tempAccountId = accountId || `temp_${Date.now()}`;
            uploadedDocs = await uploadAccountDocuments(selectedCompanyId, tempAccountId, accountDocuments);
            console.log('✅ Cari dökümanları yüklendi:', uploadedDocs.length);
        } catch (error) {
            console.error('⚠️ Döküman yükleme hatası:', error);
            alert('⚠️ Bazı dökümanlar yüklenemedi ama cari kaydedilecek.');
        }
    }
    
    const now = new Date().toISOString();
    let accountData = null;
    
    try {
        // ========================================
        // GÜNCELLEME (Mevcut Cari)
        // ========================================
        if (accountId) {
            console.log('🔄 Cari güncelleniyor:', accountId);
            
            const account = accounts.find(a => a.id === accountId);
            if (!account) {
                alert('❌ Cari hesap bulunamadı!');
                return;
            }
            
            // Eski ve yeni değerleri al
            const oldCompanyId = account.companyId;
            const oldType = account.type;
            const newType = document.getElementById('accountType').value;
            
            // Güncellenmiş veriyi hazırla
            const updatedData = {
                name: accountName,
                companyId: selectedCompanyId,
                type: newType,
                taxNo: accountTaxNo,
                phone: document.getElementById('accountPhone').value,
                email: document.getElementById('accountEmail')?.value || '',
                address: document.getElementById('accountAddress').value,
                documents: uploadedDocs.length > 0 ? uploadedDocs : (account.documents || []),
                updatedAt: now,
                updatedBy: auth.currentUser.uid
            };
            
            // Firebase'e kaydet
            await db.collection('companies').doc(oldCompanyId)
                .collection('accounts').doc(accountId).update(updatedData);
            
            // Local array'i güncelle
            Object.assign(account, updatedData);
            accountData = account;
            
            console.log('✅ Cari güncellendi');
            
        } 
        // ========================================
        // YENİ KAYIT
        // ========================================
        else {
            console.log('➕ Yeni cari oluşturuluyor');
            
            const newAccountRef = db.collection('companies').doc(selectedCompanyId)
                .collection('accounts').doc();
            
            const newAccount = {
                id: newAccountRef.id,
                companyId: selectedCompanyId,
                name: accountName,
                type: document.getElementById('accountType').value,
                taxNo: accountTaxNo,
                phone: document.getElementById('accountPhone').value,
                email: document.getElementById('accountEmail')?.value || '',
                address: document.getElementById('accountAddress').value,
                balance: 0,
                documents: uploadedDocs,
                status: 'active',
                createdAt: now,
                createdBy: auth.currentUser.uid,
                updatedAt: now,
                updatedBy: auth.currentUser.uid
            };
            
            await newAccountRef.set(newAccount);
            
            accounts.push(newAccount);
            accountData = newAccount;
            
            console.log('✅ Yeni cari oluşturuldu:', newAccount.id);
        }
        
        // ========================================
        // TEMİZLEME VE YENİLEME
        // ========================================
        document.getElementById('accountForm').reset();
        document.getElementById('accountId').value = '';
        accountDocuments = [];
        renderAccountDocuments();
        cancelAccountEdit();
        
        await loadAccounts();
        populateSelects();
        
        // Modal'ı kapat (eğer modal içinde açıldıysa)
        const modal = document.getElementById('addAccountModal');
        if (modal && modal.classList.contains('active')) {
            modal.classList.remove('active');
        }
        
        alert('✅ Cari hesap başarıyla kaydedildi!');
        
    } catch (error) {
        console.error('❌ Cari hesap kayıt hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

// ========================================
// DUPLICATE CARİ TEMİZLEME
// ========================================
async function findAndMergeDuplicateAccounts() {
    if (!confirm(
        '🔍 Duplicate cari hesapları bulmak ve birleştirmek ister misiniz?\n\n' +
        'Bu işlem:\n' +
        '✅ Aynı isim ve vergi numaralı carileri bulur\n' +
        '✅ Fatura ve ödemeleri tek cariye taşır\n' +
        '✅ Gereksiz duplicate carileri pasif yapar\n\n' +
        'Devam etmek istiyor musunuz?'
    )) {
        return;
    }
    
    try {
        const duplicateGroups = {};
        
        // Carileri grupla (isim + vergi no)
        accounts
            .filter(a => a.status !== 'deleted' && a.companyId === activeCompanyId)
            .forEach(account => {
                const key = getAccountUniqueKey(account);
                if (!duplicateGroups[key]) {
                    duplicateGroups[key] = [];
                }
                duplicateGroups[key].push(account);
            });
        
        // Sadece 2+ kayıtlı olanları al
        const duplicates = Object.values(duplicateGroups).filter(group => group.length > 1);
        
        if (duplicates.length === 0) {
            alert('✅ Duplicate cari hesap bulunamadı!');
            return;
        }
        
        console.log(`🔍 ${duplicates.length} grup duplicate bulundu`);
        
        let mergedCount = 0;
        const batch = db.batch();
        
        for (const group of duplicates) {
            console.log(`\n📋 Grup: ${group[0].name}`);
            
            // En eski veya en çok işleme sahip olanı "master" yap
            let master = group[0];
            
            for (const account of group) {
                const invoiceCount = invoices.filter(inv => inv.accountId === account.id).length;
                const paymentCount = payments.filter(p => p.accountId === account.id).length;
                const totalTransactions = invoiceCount + paymentCount;
                
                const masterInvoiceCount = invoices.filter(inv => inv.accountId === master.id).length;
                const masterPaymentCount = payments.filter(p => p.accountId === master.id).length;
                const masterTotalTransactions = masterInvoiceCount + masterPaymentCount;
                
                if (totalTransactions > masterTotalTransactions) {
                    master = account;
                }
            }
            
            console.log(`✅ Master cari: ${master.name} (ID: ${master.id})`);
            
            // Diğerlerini master'a taşı
            for (const duplicate of group) {
                if (duplicate.id === master.id) continue;
                
                console.log(`🔄 Taşınıyor: ${duplicate.name} (ID: ${duplicate.id})`);
                
                // Faturaları taşı
                invoices
                    .filter(inv => inv.accountId === duplicate.id)
                    .forEach(inv => {
                        batch.update(
                            db.collection('companies').doc(activeCompanyId)
                                .collection('invoices').doc(inv.id),
                            { accountId: master.id }
                        );
                        inv.accountId = master.id;
                    });
                
                // Ödemeleri taşı
                payments
                    .filter(p => p.accountId === duplicate.id)
                    .forEach(p => {
                        batch.update(
                            db.collection('companies').doc(activeCompanyId)
                                .collection('payments').doc(p.id),
                            { accountId: master.id }
                        );
                        p.accountId = master.id;
                    });
                
                // Duplicate'i pasif yap
                batch.update(
                    db.collection('companies').doc(activeCompanyId)
                        .collection('accounts').doc(duplicate.id),
                    { status: 'passive', mergedTo: master.id }
                );
                
                duplicate.status = 'passive';
                mergedCount++;
            }
        }
        
        await batch.commit();
        
        await loadAccounts();
        await loadInvoices();
        await loadPayments();
        updateDashboard();
        
        alert(
            `✅ Birleştirme tamamlandı!\n\n` +
            `📊 ${duplicates.length} grup işlendi\n` +
            `♻️ ${mergedCount} duplicate cari birleştirildi`
        );
        
    } catch (error) {
        console.error('Duplicate temizleme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

async function deleteAccount(id) {
    const account = accounts.find(a => a.id === id);
    
    const relatedInvoices = invoices.filter(inv => inv.accountId === id);
    const relatedPayments = payments.filter(p => p.accountId === id);
    
    if (relatedInvoices.length > 0 || relatedPayments.length > 0) {
        if (!confirm(`⚠️ Bu cari hesaba bağlı ${relatedInvoices.length} fatura ve ${relatedPayments.length} ödeme var!\n\nSilmek istediğinizden emin misiniz?`)) {
            return;
        }
    } else {
        if (!confirm('Bu cari hesabı silmek istediğinizden emin misiniz?')) {
            return;
        }
    }
    
    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    try {
        await db.collection('companies').doc(account.companyId)
            .collection('accounts').doc(id).delete();
        
        accounts = accounts.filter(a => a.id !== id);
        
        await loadAccounts();
        populateSelects();
        
        alert('✅ Cari hesap silindi!');
        
    } catch (error) {
        console.error('Cari hesap silme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

function updateAccountCompanyInfo() {
    const companyId = document.getElementById('accountCompany').value;
    const company = companies.find(c => c.id === companyId);
    const infoDiv = document.getElementById('accountCompanyInfo');
    const infoSpan = document.getElementById('accountActiveCompanyName');
    
    if (company) {
        infoSpan.textContent = company.name;
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
}

// ========================================
// CARİ FİLTRELEME VE SIRALAMA - YENİ SİSTEM
// ========================================

let currentAccountSort = { field: 'name', direction: 'asc' };

function filterAndSortAccounts() {
    console.log('🔍 Cari filtreleme başlıyor...');
    
    const companyFilter = document.getElementById('filterAccountCompany').value;
    const typeFilter = document.getElementById('filterAccountType').value;
    const balanceFilter = document.getElementById('filterAccountBalance').value;
    const searchTerm = document.getElementById('searchAccount').value.toLowerCase().trim();
    const sortValue = document.getElementById('sortAccount').value;
    
    // Filtre uygula
    let filtered = accounts.filter(account => {
        // Status kontrolü - sadece aktif cariler
        if (account.status === 'deleted' || account.status === 'passive') {
            return false;
        }
        
        // Firma filtresi
        if (companyFilter && account.companyId !== companyFilter) {
            return false;
        }
        
        // Tür filtresi
        if (typeFilter && account.type !== typeFilter) {
            return false;
        }
        
        // Bakiye filtresi
        if (balanceFilter) {
            const balance = account.balance || 0;
            if (balanceFilter === 'positive' && balance <= 0) return false;
            if (balanceFilter === 'negative' && balance >= 0) return false;
            if (balanceFilter === 'zero' && Math.abs(balance) > 0.01) return false;
        }
        
        // Arama terimi
        if (searchTerm) {
            const searchableText = [
                account.name || '',
                account.taxNo || '',
                account.phone || '',
                account.email || '',
                account.address || ''
            ].join(' ').toLowerCase();
            
            if (!searchableText.includes(searchTerm)) {
                return false;
            }
        }
        
        return true;
    });
    
    console.log(`📊 Filtrelendi: ${filtered.length}/${accounts.length}`);
    
    // Sıralama uygula
    const [sortField, sortDir] = sortValue.split('-');
    currentAccountSort = { field: sortField, direction: sortDir };
    
    filtered = sortAccounts(filtered, sortField, sortDir);
    
    // Tabloyu render et
    renderAccountsTable(filtered);
    
    // Sayaçları güncelle
    updateAccountCount(filtered.length, accounts.filter(a => 
        a.status !== 'deleted' && a.status !== 'passive'
    ).length);
}

function sortAccounts(accountsList, field, direction) {
    const sorted = [...accountsList];
    
    sorted.sort((a, b) => {
        let valA, valB;
        
        switch(field) {
            case 'name':
                valA = (a.name || '').toLowerCase();
                valB = (b.name || '').toLowerCase();
                break;
            
            case 'balance':
                valA = a.balance || 0;
                valB = b.balance || 0;
                break;
            
            case 'date':
                valA = new Date(a.createdAt || 0);
                valB = new Date(b.createdAt || 0);
                break;
            
            case 'company':
                const companyA = companies.find(c => c.id === a.companyId);
                const companyB = companies.find(c => c.id === b.companyId);
                valA = (companyA?.name || '').toLowerCase();
                valB = (companyB?.name || '').toLowerCase();
                break;
            
            case 'type':
                valA = a.type || '';
                valB = b.type || '';
                break;
            
            default:
                return 0;
        }
        
        if (valA < valB) return direction === 'asc' ? -1 : 1;
        if (valA > valB) return direction === 'asc' ? 1 : -1;
        return 0;
    });
    
    return sorted;
}

function sortAccountsBy(field) {
    // Tıklanan sütuna göre sıralama yönünü değiştir
    if (currentAccountSort.field === field) {
        currentAccountSort.direction = currentAccountSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentAccountSort.field = field;
        currentAccountSort.direction = 'asc';
    }
    
    // Sıralama select'ini güncelle
    document.getElementById('sortAccount').value = `${field}-${currentAccountSort.direction}`;
    
    // Ok işaretlerini güncelle
    updateSortIcons(field, currentAccountSort.direction);
    
    // Filtrelemeyi yeniden çalıştır
    filterAndSortAccounts();
}

function updateSortIcons(activeField, direction) {
    // Tüm ok işaretlerini sıfırla
    ['sortCompany', 'sortName', 'sortType', 'sortBalance'].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.textContent = '⇅';
    });
    
    // Aktif sütunun okunu güncelle
    const iconMap = {
        'company': 'sortCompany',
        'name': 'sortName',
        'type': 'sortType',
        'balance': 'sortBalance'
    };
    
    const iconId = iconMap[activeField];
    if (iconId) {
        const element = document.getElementById(iconId);
        if (element) {
            element.textContent = direction === 'asc' ? '↑' : '↓';
        }
    }
}

function updateAccountCount(filtered, total) {
    const countElement = document.getElementById('totalAccountsCount');
    if (countElement) {
        if (filtered === total) {
            countElement.textContent = total;
        } else {
            countElement.textContent = `${filtered} / ${total}`;
        }
    }
}

function clearAccountFilters() {
    document.getElementById('filterAccountCompany').value = '';
    document.getElementById('filterAccountType').value = '';
    document.getElementById('filterAccountBalance').value = '';
    document.getElementById('searchAccount').value = '';
    document.getElementById('sortAccount').value = 'name-asc';
    
    currentAccountSort = { field: 'name', direction: 'asc' };
    updateSortIcons('name', 'asc');
    
    filterAndSortAccounts();
}

// ========================================
// RENDER FONKSİYONU - GÜNCELLENMİŞ
// ========================================

function renderAccountsTable(accountsList = null) {
    const tbody = document.querySelector('#accountsTable tbody');
    if (!tbody) {
        console.warn('Accounts table tbody bulunamadı');
        return;
    }
    
    tbody.innerHTML = '';
    
    // Eğer liste verilmediyse tüm aktif carileri kullan
    if (!accountsList) {
        accountsList = accounts.filter(a => 
            a.status !== 'deleted' && a.status !== 'passive'
        );
    }
    
    if (accountsList.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" style="text-align:center; padding:40px; color:#6b7280;">
                    <div style="font-size:3em; margin-bottom:10px;">👥</div>
                    <h3>Cari hesap bulunamadı</h3>
                    <p>Filtrelerinizi değiştirin veya yeni cari ekleyin.</p>
                </td>
            </tr>
        `;
        updateAccountCount(0, accounts.filter(a => 
            a.status !== 'deleted' && a.status !== 'passive'
        ).length);
        return;
    }
    
    accountsList.forEach(account => {
        const company = companies.find(c => c.id === account.companyId);
        const balanceColor = account.balance >= 0 ? 'var(--success)' : 'var(--danger)';
        const typeText = account.type === 'customer' ? '👤 Müşteri' : '🏢 Tedarikçi';
        const typeBadge = account.type === 'customer' ? 'badge-success' : 'badge-warning';
        
        const hasDocuments = account.documents && account.documents.length > 0;
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${company ? company.name : '<span style="color:#6b7280;">Firma Silinmiş</span>'}</td>
            <td><strong>${account.name}</strong></td>
            <td><span class="badge ${typeBadge}">${typeText}</span></td>
            <td>${account.phone || '-'}</td>
            <td style="font-weight: 700; color: ${balanceColor};">
                ${formatCurrency(account.balance || 0)}
            </td>
            <td style="text-align: center;">
                ${hasDocuments ? `
                    <button class="btn btn-info btn-sm" onclick="viewAccountDocuments('${account.id}')" title="Dökümanları Görüntüle">
                        📄 ${account.documents.length}
                    </button>
                ` : '<span style="color:#6b7280;">-</span>'}
            </td>
            <td style="white-space: nowrap;">
                <button class="btn btn-info btn-sm" onclick="viewAccountCard('${account.id}')" title="Cari Kartı">
                    📊
                </button>
                <button class="btn btn-warning btn-sm" onclick="editAccount('${account.id}')" title="Düzenle">
                    ✏️
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteAccount('${account.id}')" title="Sil">
                    🗑️
                </button>
            </td>
        `;
    });
    
    updateAccountCount(accountsList.length, accounts.filter(a => 
        a.status !== 'deleted' && a.status !== 'passive'
    ).length);
}

        // INVOICE FUNCTIONS
        let invoiceItems = [];

        function addInvoiceItem() {
            const item = {
                id: Date.now() + Math.random(),
                description: '',
                quantity: 1,
                unitPrice: 0,
                vatRate: 20,
                amount: 0,
                vatAmount: 0
            };

            invoiceItems.push(item);
            renderInvoiceItems();
        }

        function renderInvoiceItems() {
            const container = document.getElementById('invoiceItemsList');
            container.innerHTML = '';

            invoiceItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'invoice-item';
                div.innerHTML = `
                    <div class="form-group">
                        <label>Açıklama</label>
                        <input type="text" value="${item.description}" onchange="updateInvoiceItem(${index}, 'description', this.value)" required>
                    </div>
                    <div class="form-group">
                        <label>Miktar</label>
                        <input type="number" value="${item.quantity}" onchange="updateInvoiceItem(${index}, 'quantity', this.value)" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Birim Fiyat</label>
                        <input type="number" value="${item.unitPrice}" onchange="updateInvoiceItem(${index}, 'unitPrice', this.value)" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>KDV %</label>
                        <select onchange="updateInvoiceItem(${index}, 'vatRate', this.value)">
                            <option value="0" ${item.vatRate == 0 ? 'selected' : ''}>%0</option>
                            <option value="1" ${item.vatRate == 1 ? 'selected' : ''}>%1</option>
                            <option value="8" ${item.vatRate == 8 ? 'selected' : ''}>%8</option>
                            <option value="10" ${item.vatRate == 10 ? 'selected' : ''}>%10</option>
                            <option value="18" ${item.vatRate == 18 ? 'selected' : ''}>%18</option>
                            <option value="20" ${item.vatRate == 20 ? 'selected' : ''}>%20</option>
                        </select>
                    </div>
                    <div>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(${index})">🗑️</button>
                    </div>
                `;
                container.appendChild(div);
            });

            calculateInvoiceTotals();
        }

        function updateInvoiceItem(index, field, value) {
            invoiceItems[index][field] = field === 'description' ? value : parseFloat(value) || 0;
            calculateInvoiceTotals();
        }

        function removeInvoiceItem(index) {
            if (invoiceItems.length === 1) {
                alert('⚠️ En az bir fatura kalemi olmalıdır!');
                return;
            }
            invoiceItems.splice(index, 1);
            renderInvoiceItems();
        }

        function calculateInvoiceTotals() {
            let subtotal = 0;
            let totalVAT = 0;

            invoiceItems.forEach(item => {
                item.amount = item.quantity * item.unitPrice;
                item.vatAmount = item.amount * (item.vatRate / 100);
                subtotal += item.amount;
                totalVAT += item.vatAmount;
            });

            const total = subtotal + totalVAT;

            document.getElementById('invoiceSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('invoiceVAT').textContent = formatCurrency(totalVAT);
            document.getElementById('invoiceTotal').textContent = formatCurrency(total);
        }

async function saveInvoice(e) {
    e.preventDefault();

    if (!activeCompanyId) {
        alert('⚠️ Lütfen önce bir firma seçin!');
        return;
    }

    if (invoiceItems.length === 0 || !invoiceItems[0].description) {
        alert('⚠️ Lütfen en az bir fatura kalemi ekleyin!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }

    const invoiceId = document.getElementById('invoiceId').value;
    const subtotal = invoiceItems.reduce((sum, item) => sum + item.amount, 0);
    const vatAmount = invoiceItems.reduce((sum, item) => sum + item.vatAmount, 0);
    const total = subtotal + vatAmount;

    try {
        let receiptUrl = null;
        
        // Eğer yeni dekont yüklendiyse Storage'a yükle
        if (currentInvoiceReceipt && currentInvoiceReceipt instanceof File) {
            const tempId = invoiceId || Date.now().toString();
            const fileName = `${Date.now()}_${currentInvoiceReceipt.name}`;
            const storageRef = storage.ref(`companies/${activeCompanyId}/invoices/${tempId}/${fileName}`);
            
            const snapshot = await storageRef.put(currentInvoiceReceipt);
            receiptUrl = await snapshot.ref.getDownloadURL();
            
            console.log('✅ Fatura dekontı yüklendi:', receiptUrl);
        }

        let invoiceData;

        if (invoiceId) {
            // Update existing invoice
            const invoice = invoices.find(inv => inv.id === invoiceId);
            const oldTotal = invoice.total;
            const oldType = invoice.type;
            const oldAccountId = invoice.accountId;

            const updatedData = {
                type: document.getElementById('invoiceType').value,
                invoiceNo: document.getElementById('invoiceNo').value,
                date: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('invoiceDueDate').value,
                accountId: document.getElementById('invoiceAccount').value,
                description: document.getElementById('invoiceDescription').value,
                items: JSON.parse(JSON.stringify(invoiceItems)),
                subtotal: subtotal,
                vatAmount: vatAmount,
                total: total,
                receiptUrl: receiptUrl || invoice.receiptUrl,
                updatedAt: new Date().toISOString(),
                updatedBy: auth.currentUser.uid
            };

            await db.collection('companies').doc(activeCompanyId)
                .collection('invoices').doc(invoiceId).update(updatedData);

            // Bakiye güncellemeleri
            const oldAccount = accounts.find(a => a.id === oldAccountId);
            if (oldAccount) {
                if (oldType === 'sales') {
                    oldAccount.balance -= oldTotal;
                } else {
                    oldAccount.balance += oldTotal;
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('accounts').doc(oldAccountId).update({
                        balance: oldAccount.balance
                    });
            }

	    const newAccount = accounts.find(a => a.id === updatedData.accountId);  // ✅ DOĞRU

            if (newAccount) {
                if (updatedData.type === 'sales') {
                    newAccount.balance += total;
                } else {
                    newAccount.balance -= total;
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('accounts').doc(updatedData.accountId).update({
                        balance: newAccount.balance
                    });
            }

            Object.assign(invoice, updatedData);
            invoiceData = invoice;
            
        } else {
            // Create new invoice
            const newInvoiceRef = db.collection('companies').doc(activeCompanyId)
                .collection('invoices').doc();
            const newInvoiceId = newInvoiceRef.id;

            const newInvoice = {
                id: newInvoiceId,
                companyId: activeCompanyId,
                type: document.getElementById('invoiceType').value,
                invoiceNo: document.getElementById('invoiceNo').value,
                date: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('invoiceDueDate').value,
                accountId: document.getElementById('invoiceAccount').value,
                description: document.getElementById('invoiceDescription').value,
                items: JSON.parse(JSON.stringify(invoiceItems)),
                subtotal: subtotal,
                vatAmount: vatAmount,
                total: total,
                paidAmount: 0,
                status: 'unpaid',
                receiptUrl: receiptUrl,
                createdAt: new Date().toISOString(),
                createdBy: auth.currentUser.uid
            };

            await newInvoiceRef.set(newInvoice);

            // Update account balance
            const account = accounts.find(a => a.id === newInvoice.accountId);
            if (account) {
                if (newInvoice.type === 'sales') {
                    account.balance += total;
                } else {
                    account.balance -= total;
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('accounts').doc(newInvoice.accountId).update({
                        balance: account.balance
                    });
            }

            invoices.push(newInvoice);
            invoiceData = newInvoice;
        }

        document.getElementById('invoiceForm').reset();
        document.getElementById('invoiceDate').valueAsDate = new Date();
        document.getElementById('invoiceId').value = '';
        invoiceItems = [];
        addInvoiceItem();
        cancelInvoiceEdit();
        
        clearInvoiceReceipt();
        
        await loadInvoices();
        await loadAccounts();
        updateDashboard();

        alert('✅ Fatura başarıyla kaydedildi!');
        
    } catch (error) {
        console.error('Fatura kayıt hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

        function editInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            document.getElementById('invoiceId').value = invoice.id;
            document.getElementById('invoiceType').value = invoice.type;
            document.getElementById('invoiceNo').value = invoice.invoiceNo;
            document.getElementById('invoiceDate').value = invoice.date;
            document.getElementById('invoiceDueDate').value = invoice.dueDate || '';
            document.getElementById('invoiceAccount').value = invoice.accountId;
            document.getElementById('invoiceDescription').value = invoice.description || '';

            invoiceItems = JSON.parse(JSON.stringify(invoice.items));
            renderInvoiceItems();

            document.getElementById('saveInvoiceBtn').textContent = '💾 Güncelle';
            document.getElementById('cancelInvoiceBtn').style.display = 'inline-block';

            showTab('invoices');
            document.getElementById('invoiceForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelInvoiceEdit() {
            document.getElementById('invoiceForm').reset();
            document.getElementById('invoiceId').value = '';
            document.getElementById('invoiceDate').valueAsDate = new Date();
            document.getElementById('saveInvoiceBtn').textContent = '💾 Fatura Kaydet';
            document.getElementById('cancelInvoiceBtn').style.display = 'none';
            invoiceItems = [];
            addInvoiceItem();
        }

        function viewInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            const account = accounts.find(a => a.id === invoice.accountId);
            const company = companies.find(c => c.id === invoice.companyId);
            const typeText = invoice.type === 'sales' ? 'SATIŞ FATURASI' : 'ALIŞ FATURASI';
            
            let itemsHtml = '<table style="width:100%; margin-top:20px; border-collapse: collapse;"><thead><tr style="background:#2563eb; color:white;"><th style="padding:10px; border:1px solid #ddd;">Açıklama</th><th style="padding:10px; border:1px solid #ddd;">Miktar</th><th style="padding:10px; border:1px solid #ddd;">Birim Fiyat</th><th style="padding:10px; border:1px solid #ddd;">KDV %</th><th style="padding:10px; border:1px solid #ddd;">Tutar</th></tr></thead><tbody>';
            
            invoice.items.forEach(item => {
                itemsHtml += `
                    <tr>
                        <td style="padding:10px; border:1px solid #ddd;">${item.description}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:center;">${item.quantity}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right;">${formatCurrency(item.unitPrice)}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:center;">%${item.vatRate}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right;"><strong>${formatCurrency(item.amount + item.vatAmount)}</strong></td>
                    </tr>
                `;
            });
            
            itemsHtml += '</tbody></table>';

            const remaining = invoice.total - (invoice.paidAmount || 0);
            const paymentStatusHtml = invoice.paidAmount > 0 ? `
                <div style="margin-top:20px; padding:15px; background:#dbeafe; border-radius:8px;">
                    <p><strong>Ödeme Durumu:</strong></p>
                    <p>Ödenen: ${formatCurrency(invoice.paidAmount)}</p>
                    <p>Kalan: ${formatCurrency(remaining)}</p>
                </div>
            ` : '';

            const content = `
                <div style="max-width: 900px; margin: 0 auto;">
                    <h2 style="color:#2563eb; border-bottom:3px solid #2563eb; padding-bottom:10px;">${typeText}</h2>
                    <div style="margin: 20px 0; padding: 20px; background: #f3f4f6; border-radius: 8px;">
                        <p><strong>Firma:</strong> ${company ? company.name : '-'}</p>
                        <p><strong>Fatura No:</strong> ${invoice.invoiceNo}</p>
                        <p><strong>Tarih:</strong> ${formatDate(invoice.date)}</p>
                        ${invoice.dueDate ? `<p><strong>Vade:</strong> ${formatDate(invoice.dueDate)}</p>` : ''}
                        <p><strong>Cari:</strong> ${account ? account.name : 'Silinmiş'}</p>
                        <p><strong>Açıklama:</strong> ${invoice.description || '-'}</p>
                    </div>
                    ${itemsHtml}
                    ${paymentStatusHtml}
                    <div style="margin-top:30px; text-align:right; padding:20px; background:#f3f4f6; border-radius:8px;">
                        <p style="font-size:1.1em;"><strong>Ara Toplam:</strong> ${formatCurrency(invoice.subtotal)}</p>
                        <p style="font-size:1.1em;"><strong>KDV:</strong> ${formatCurrency(invoice.vatAmount)}</p>
                        <hr style="margin:15px 0;">
                        <p style="font-size:2em; color:#2563eb;"><strong>TOPLAM:</strong> ${formatCurrency(invoice.total)}</p>
                    </div>
                </div>
            `;

            const win = window.open('', 'Fatura', 'width=900,height=700');
            win.document.write(`
                <html>
                    <head>
                        <title>Fatura ${invoice.invoiceNo}</title>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: Arial, sans-serif; padding: 40px; }
                            @media print { button { display: none !important; } }
                        </style>
                    </head>
                    <body>
                        ${content}
                        <div style="text-align:center; margin-top:30px;">
                            <button onclick="window.print()" style="padding:12px 30px; background:#2563eb; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px;">🖨️ Yazdır</button>
                            <button onclick="window.close()" style="padding:12px 30px; background:#6b7280; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; margin-left:10px;">✖️ Kapat</button>
                        </div>
                    </body>
                </html>
            `);
        }

async function deleteInvoice(id) {
    const invoice = invoices.find(inv => inv.id === id);
    
    if (!invoice || !auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    // ========================================
    // KULLANICIYA SEÇENEK SUN
    // ========================================
    const choice = confirm(
        '🗑️ Fatura Silme Seçenekleri:\n\n' +
        '✅ TAMAM → Çöp kutusuna taşı (30 gün sonra otomatik silinir)\n' +
        '❌ İPTAL → Kalıcı olarak sil (geri alınamaz)\n\n' +
        'Çöp kutusuna taşımak için TAMAM\'a basın.'
    );
    
    try {
        if (choice) {
            // ========================================
            // SEÇİM 1: SOFT DELETE (Çöp Kutusu)
            // ========================================
            await softDeleteInvoice(id, invoice);
        } else {
            // ========================================
            // SEÇİM 2: HARD DELETE (Kalıcı Silme)
            // ========================================
            const confirmHard = confirm(
                '⚠️ DİKKAT!\n\n' +
                'Faturayı KALICI olarak silmek istediğinize emin misiniz?\n' +
                'Bu işlem GERİ ALINAMAZ!\n\n' +
                'Fatura No: ' + invoice.invoiceNo + '\n' +
                'Tutar: ' + formatCurrency(invoice.total)
            );
            
            if (confirmHard) {
                await hardDeleteInvoice(id, invoice);
            } else {
                return; // Kullanıcı vazgeçti
            }
        }
        
    } catch (error) {
        console.error('❌ Fatura silme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

// ========================================
// SOFT DELETE FONKSİYONU
// ========================================
async function softDeleteInvoice(id, invoice) {
    console.log('🗑️ Soft delete başlıyor:', id);
    
    // Silme tarihini hesapla (30 gün sonra)
    const deleteDate = new Date();
    deleteDate.setDate(deleteDate.getDate() + 30);
    
    // Faturayı "deleted" olarak işaretle
    await db.collection('companies').doc(activeCompanyId)
        .collection('invoices').doc(id).update({
            status: 'deleted',
            deletedAt: new Date().toISOString(),
            deletedBy: auth.currentUser.uid,
            permanentDeleteDate: deleteDate.toISOString(),
            previousStatus: invoice.status || 'unpaid' // Eski durumu sakla
        });
    
    // Cari bakiyesini düzelt
    const account = accounts.find(a => a.id === invoice.accountId);
    if (account) {
        const remainingAmount = invoice.total - (invoice.paidAmount || 0);
        
        if (invoice.type === 'sales') {
            account.balance -= remainingAmount;
        } else {
            account.balance += remainingAmount;
        }
        
        await db.collection('companies').doc(activeCompanyId)
            .collection('accounts').doc(account.id).update({
                balance: account.balance
            });
    }
    
    // Local array'den kaldır
    invoices = invoices.filter(inv => inv.id !== id);
    
    // UI'ı güncelle
    await loadInvoices();
    await loadAccounts();
    updateDashboard();
    
    alert(
        '✅ Fatura çöp kutusuna taşındı!\n\n' +
        '📅 ' + deleteDate.toLocaleDateString('tr-TR') + ' tarihinde otomatik silinecek.\n\n' +
        '💡 Geri almak için Ayarlar → Çöp Kutusu bölümünden geri yükleyebilirsiniz.'
    );
}

// ========================================
// HARD DELETE FONKSİYONU
// ========================================
async function hardDeleteInvoice(id, invoice) {
    console.log('💣 Hard delete başlıyor:', id);
    
    // İlgili ödemeleri kontrol et
    const relatedPayments = payments.filter(p => p.invoiceId === id);
    
    if (relatedPayments.length > 0) {
        const totalPaid = relatedPayments.reduce((sum, p) => sum + p.amount, 0);
        
        const confirmWithPayments = confirm(
            `⚠️ Bu faturaya ${formatCurrency(totalPaid)} ödeme yapılmış!\n\n` +
            'Fatura ve ödemeler KALICI olarak silinecek.\n' +
            'Devam edilsin mi?'
        );
        
        if (!confirmWithPayments) {
            return;
        }
        
        // Batch işlem başlat
        const batch = db.batch();
        
        // Ödemeleri sil
        for (const payment of relatedPayments) {
            const paymentRef = db.collection('companies').doc(activeCompanyId)
                .collection('payments').doc(payment.id);
            batch.delete(paymentRef);
            
            // Ödeme bakiyesini geri al
            const payAccount = accounts.find(a => a.id === payment.accountId);
            if (payAccount) {
                if (payAccount.type === 'customer') {
                    if (payment.type === 'income') {
                        payAccount.balance += payment.amount;
                    }
                } else {
                    if (payment.type === 'expense') {
                        payAccount.balance -= payment.amount;
                    }
                }
                
                const accountRef = db.collection('companies').doc(activeCompanyId)
                    .collection('accounts').doc(payAccount.id);
                batch.update(accountRef, { balance: payAccount.balance });
            }
        }
        
        // Faturayı KALICI SIL
        const invoiceRef = db.collection('companies').doc(activeCompanyId)
            .collection('invoices').doc(id);
        batch.delete(invoiceRef);
        
        await batch.commit();
        
        // Local array'lerden kaldır
        payments = payments.filter(p => p.invoiceId !== id);
    } else {
        // Ödeme yoksa direkt sil
        
        // Cari bakiyesini düzelt
        const account = accounts.find(a => a.id === invoice.accountId);
        if (account) {
            const remainingAmount = invoice.total - (invoice.paidAmount || 0);
            
            if (invoice.type === 'sales') {
                account.balance -= remainingAmount;
            } else {
                account.balance += remainingAmount;
            }
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('accounts').doc(account.id).update({
                    balance: account.balance
                });
        }
        
        // Faturayı KALICI SIL
        await db.collection('companies').doc(activeCompanyId)
            .collection('invoices').doc(id).delete();
    }
    
    // Local array'den kaldır
    invoices = invoices.filter(inv => inv.id !== id);
    
    // UI'ı güncelle
    await loadInvoices();
    await loadAccounts();
    await loadPayments();
    updateDashboard();
    
    alert('✅ Fatura ve ilgili tüm veriler KALICI olarak silindi!');
}

        function filterInvoices() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const type = document.getElementById('filterType').value;
            const status = document.getElementById('filterPaymentStatus').value;

            const tbody = document.querySelector('#invoicesTable tbody');
            tbody.innerHTML = '';

            let filtered = invoices.filter(inv => !activeCompanyId || inv.companyId === activeCompanyId);

            if (startDate) filtered = filtered.filter(inv => inv.date >= startDate);
            if (endDate) filtered = filtered.filter(inv => inv.date <= endDate);
            if (type) filtered = filtered.filter(inv => inv.type === type);
            if (status) {
                filtered = filtered.filter(inv => {
                    const remaining = inv.total - (inv.paidAmount || 0);
                    if (status === 'paid') return remaining <= 0;
                    if (status === 'partial') return inv.paidAmount > 0 && remaining > 0;
                    if (status === 'unpaid') return inv.paidAmount === 0;
                    return true;
                });
            }

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px;">Sonuç bulunamadı.</td></tr>';
                return;
            }

            // Render filtered invoices (same as loadInvoices)
            filtered.forEach(invoice => {
                const account = accounts.find(a => a.id === invoice.accountId);
                const typeText = invoice.type === 'sales' ? '📗 Satış' : '📕 Alış';
                const remaining = invoice.total - (invoice.paidAmount || 0);
                
                let statusText = 'Ödenmedi';
                let statusClass = 'status-unpaid';
                if (invoice.paidAmount >= invoice.total) {
                    statusText = 'Ödendi';
                    statusClass = 'status-paid';
                } else if (invoice.paidAmount > 0) {
                    statusText = 'Kısmi';
                    statusClass = 'status-partial';
                }
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(invoice.date)}</td>
                    <td><strong>${invoice.invoiceNo}</strong></td>
                    <td>${typeText}</td>
                    <td>${account ? account.name : 'Silinmiş'}</td>
                    <td><strong>${formatCurrency(invoice.total)}</strong></td>
                    <td>${formatCurrency(invoice.paidAmount || 0)}</td>
                    <td style="color: ${remaining > 0 ? 'var(--danger)' : 'var(--success)'};">${formatCurrency(remaining)}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewInvoice('${invoice.id}')">👁️</button>
                        <button class="btn btn-warning btn-sm" onclick="editInvoice('${invoice.id}')">✏️</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice.id}')">🗑️</button>
                    </td>
                `;
            });
        }

        function clearInvoiceFilters() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterPaymentStatus').value = '';
            loadInvoices();
        }

        // PAYMENT FUNCTIONS
        function openPaymentModal() {
            if (!activeCompanyId) {
                alert('⚠️ Lütfen önce bir firma seçin!');
                return;
            }
            document.getElementById('paymentModal').classList.add('active');
            document.getElementById('paymentDate').valueAsDate = new Date();
            populatePaymentAccounts();
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentId').value = '';
        }

        function populatePaymentAccounts() {
            const select = document.getElementById('paymentAccount');
            select.innerHTML = '<option value="">Seçiniz</option>';
            
            const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
            companyAccounts.forEach(account => {
                const option = new Option(`${account.name} (${account.type === 'customer' ? 'Müşteri' : 'Tedarikçi'})`, account.id);
                select.add(option);
            });
        }

        function loadAccountInvoices() {
            const accountId = document.getElementById('paymentAccount').value;
            const select = document.getElementById('paymentInvoice');
            select.innerHTML = '<option value="">Genel Ödeme (Fatura Yok)</option>';

            if (!accountId) return;

            const accountInvoices = invoices.filter(inv => 
                inv.accountId === accountId && 
                (inv.total - (inv.paidAmount || 0)) > 0
            );

            accountInvoices.forEach(invoice => {
                const remaining = invoice.total - (invoice.paidAmount || 0);
                const option = new Option(
                    `${invoice.invoiceNo} - ${formatCurrency(remaining)} kalan`,
                    invoice.id
                );
                select.add(option);
            });
        }

async function savePayment(e) {
    e.preventDefault();

    if (!activeCompanyId) {
        alert('⚠️ Lütfen önce bir firma seçin!');
        return;
    }

    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }

    try {
        const paymentRef = db.collection('companies').doc(activeCompanyId)
            .collection('payments').doc();
        const paymentId = paymentRef.id;

        const payment = {
            id: paymentId,
            companyId: activeCompanyId,
            date: document.getElementById('paymentDate').value,
            accountId: document.getElementById('paymentAccount').value,
            amount: parseFloat(document.getElementById('paymentAmount').value),
            type: document.getElementById('paymentType').value,
            invoiceId: document.getElementById('paymentInvoice').value || null,
            description: document.getElementById('paymentDescription').value,
            source: 'manual',
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser.uid
        };

        await paymentRef.set(payment);
        payments.push(payment);

        // Update invoice if linked
        if (payment.invoiceId) {
            const invoice = invoices.find(inv => inv.id === payment.invoiceId);
            if (invoice) {
                invoice.paidAmount = (invoice.paidAmount || 0) + payment.amount;
                
                // Update status
                if (invoice.paidAmount >= invoice.total) {
                    invoice.status = 'paid';
                } else if (invoice.paidAmount > 0) {
                    invoice.status = 'partial';
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('invoices').doc(invoice.id).update({
                        paidAmount: invoice.paidAmount,
                        status: invoice.status
                    });
            }
        }

        // Update account balance
        const account = accounts.find(a => a.id === payment.accountId);
        if (account) {
            if (account.type === 'customer') {
                if (payment.type === 'income') {
                    account.balance -= payment.amount;
                } else {
                    account.balance += payment.amount;
                }
            } else {
                if (payment.type === 'expense') {
                    account.balance += payment.amount;
                } else {
                    account.balance -= payment.amount;
                }
            }
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('accounts').doc(account.id).update({
                    balance: account.balance
                });
        }

        closePaymentModal();
        await loadPayments();
        await loadInvoices();
        await loadAccounts();
        updateDashboard();

        alert('✅ Ödeme başarıyla kaydedildi!');
        
    } catch (error) {
        console.error('Ödeme kayıt hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

async function loadPayments() {
    if (!activeCompanyId || !auth.currentUser) {
        payments = [];
        renderPaymentsTable();
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('payments').orderBy('date', 'desc').get();
        
        payments = [];
        snapshot.forEach(doc => {
            payments.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('✅ Ödemeler yüklendi:', payments.length);
        
    } catch (error) {
        console.error('❌ Ödeme yükleme hatası:', error);
        payments = [];
    }
    
    renderPaymentsTable();
}

async function deletePayment(id) {
    if (!confirm('Bu ödeme kaydını silmek istediğinizden emin misiniz?')) return;

    const payment = payments.find(p => p.id === id);
    
    if (!payment || !auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    try {
        // Revert invoice payment
        if (payment.invoiceId) {
            const invoice = invoices.find(inv => inv.id === payment.invoiceId);
            if (invoice) {
                invoice.paidAmount = (invoice.paidAmount || 0) - payment.amount;
                if (invoice.paidAmount <= 0) {
                    invoice.status = 'unpaid';
                    invoice.paidAmount = 0;
                } else if (invoice.paidAmount < invoice.total) {
                    invoice.status = 'partial';
                }
                
                await db.collection('companies').doc(activeCompanyId)
                    .collection('invoices').doc(invoice.id).update({
                        paidAmount: invoice.paidAmount,
                        status: invoice.status
                    });
            }
        }

        // Revert account balance
        const account = accounts.find(a => a.id === payment.accountId);
        if (account) {
            if (account.type === 'customer') {
                if (payment.type === 'income') {
                    account.balance += payment.amount;
                } else {
                    account.balance -= payment.amount;
                }
            } else {
                if (payment.type === 'expense') {
                    account.balance -= payment.amount;
                } else {
                    account.balance += payment.amount;
                }
            }
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('accounts').doc(account.id).update({
                    balance: account.balance
                });
        }
        
        await db.collection('companies').doc(activeCompanyId)
            .collection('payments').doc(id).delete();
        
        payments = payments.filter(p => p.id !== id);

        await loadPayments();
        await loadInvoices();
        await loadAccounts();
        updateDashboard();

        alert('✅ Ödeme kaydı silindi!');
        
    } catch (error) {
        console.error('Ödeme silme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

        function filterPayments() {
            const startDate = document.getElementById('paymentFilterStart').value;
            const endDate = document.getElementById('paymentFilterEnd').value;
            const accountId = document.getElementById('paymentFilterAccount').value;

            const tbody = document.querySelector('#paymentsTable tbody');
            tbody.innerHTML = '';

            let filtered = payments.filter(p => !activeCompanyId || p.companyId === activeCompanyId);

            if (startDate) filtered = filtered.filter(p => p.date >= startDate);
            if (endDate) filtered = filtered.filter(p => p.date <= endDate);
            if (accountId) filtered = filtered.filter(p => p.accountId === accountId);

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">Sonuç bulunamadı.</td></tr>';
                return;
            }

            filtered.forEach(payment => {
                const account = accounts.find(a => a.id === payment.accountId);
                const invoice = payment.invoiceId ? invoices.find(inv => inv.id === payment.invoiceId) : null;
                const typeText = payment.type === 'income' ? '📗 Tahsilat' : '📕 Ödeme';
                const sourceText = payment.source === 'manual' ? 'Manuel' : 'Banka';

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(payment.date)}</td>
                    <td>${account ? account.name : 'Silinmiş'}</td>
                    <td style="color: ${payment.type === 'income' ? 'var(--success)' : 'var(--danger)'};">
                        ${payment.type === 'income' ? '+' : '-'}${formatCurrency(payment.amount)}
                    </td>
                    <td>${typeText}</td>
                    <td>${invoice ? invoice.invoiceNo : '-'}</td>
                    <td>${payment.description || '-'}</td>
                    <td><span class="badge badge-${payment.source === 'manual' ? 'info' : 'success'}">${sourceText}</span></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deletePayment('${payment.id}')">🗑️</button>
                    </td>
                `;
            });
        }

        function clearPaymentFilters() {
            document.getElementById('paymentFilterStart').value = '';
            document.getElementById('paymentFilterEnd').value = '';
            document.getElementById('paymentFilterAccount').value = '';
            loadPayments();
        }

        // BANK IMPORT FUNCTIONS
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function importBankStatement(event) {
            const file = event.target.files[0];
            if (!file) return;
            processFile(file);
        }

async function processFile(file) {
    try {
        await saveImportedFileToStorage(file, "payments");
    } catch (err) {
        console.error("Banka/Ödeme dosya kaydedilemedi:", err);
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const transactions = parseCSV(e.target.result);
            showTransactionDetailsModal(transactions); // EKLE!
        } catch (err) {
            console.error("Banka dosya parse hatası:", err);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

function parseCSV(content) {
    console.log('📂 CSV Parse işlemi başlatılıyor...');
    console.log('CSV Content başlangıç:', content.substring(0, 500));

    let lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);
    console.log('Toplam satır sayısı:', lines.length);

    if (lines.length === 0) {
        console.error('⚠️ CSV dosyası boş!');
        return [];
    }

    console.log('Header:', lines[0]);

    let parsedTransactions = [];

    // ========================================
    // İŞLEM SATIRLARINI PARSE ET
    // ========================================
    console.log("\n📝 İşlem satırlarını parse ediyorum...");

    for (let i = 1; i < lines.length; i++) {
        console.log(`\nSatır ${i}: ${lines[i]}`);
        
        let parts = lines[i].split(';');
        console.log('Noktalı virgül ile ayrıldı, parça sayısı:', parts.length);
        console.log('Parçalar:', parts);

        // Eğer satır yeterli sütuna sahip değilse atla
        if (parts.length < 9) {
            console.log('⚠️ Bu satırda yeterli sütun yok, atlanıyor');
            continue;
        }

        // --- VERİ ÇIKARMA (İlk Yaklaşım) ---
        let tarih = parts[0]?.trim() || '';
        let valor = parts[1]?.trim() || '';
        let kanal = parts[2]?.trim() || '';
        let tutarStr = parts[3]?.trim() || '';
        let bakiyeStr = parts[4]?.trim() || '';
        let islemTipi = parts[7]?.trim() || '';
        let aciklama = parts[8]?.trim() || ''; // Sütun 8'deki açıklama

        console.log('Çıkarılan veriler:');
        console.log('  Tarih:', tarih);
        console.log('  Tutar:', tutarStr);
        console.log('  Bakiye:', bakiyeStr);
        console.log('  Açıklama (Sütun 8):', aciklama);
        console.log('  Kanal:', kanal);
        console.log('  İşlem Tipi:', islemTipi);

        // --- İKİNCİ YAKLAŞIM: Farklı Format Kontrolü ---
        if (!tutarStr && parts.length >= 15) {
            tarih = parts[1]?.trim() || '';
            tutarStr = parts[3]?.trim() || '';
            bakiyeStr = parts[4]?.trim() || '';
            
            // Önce sütun 8'i kontrol et, yoksa sütun 14'ü kullan
            let sutun8 = parts[8]?.trim() || '';
            let sutun14 = parts[14]?.trim() || '';
            
            // Eğer sütun 8 boş veya sadece referans numarası gibi görünüyorsa
            if (!sutun8 || sutun8.match(/^\d{29,}$/)) {
                aciklama = sutun14 || sutun8 || 'Açıklama yok';
            } else {
                aciklama = sutun8;
            }
            
            console.log('Çıkarılan veriler (2. yaklaşım):');
            console.log('  Tarih:', tarih);
            console.log('  Tutar:', tutarStr);
            console.log('  Bakiye:', bakiyeStr);
            console.log('  Açıklama:', aciklama);
        }

        // --- TUTAR PARSE ---
        let tutar = parseTurkishNumber(tutarStr);

        if (tutar === 0 || isNaN(tutar)) {
            console.log('Tutar 0 veya geçersiz, atlandı');
            continue;
        }

        // --- TARİH STANDARDIZASYONU ---
        let dateMatch = tarih.match(/(\d{2})\/(\d{2})\/(\d{4})/);
        let standardDate = '';
        if (dateMatch) {
            let [, day, month, year] = dateMatch;
            standardDate = `${year}-${month}-${day}`;
        } else {
            console.log('⚠️ Tarih formatı tanınmadı, atlandı');
            continue;
        }

        // --- BAKİYE PARSE ---
        let bakiye = parseTurkishNumber(bakiyeStr);

        // --- AÇIKLAMA İYİLEŞTİRME ---
        // Eğer açıklama hala boş veya sadece referans numarası ise
        if (!aciklama || aciklama.match(/^\d{29,}$/)) {
            // Önce sütun 8'i tekrar kontrol et
            if (parts[8]?.trim() && !parts[8].trim().match(/^\d{29,}$/)) {
                aciklama = parts[8].trim();
            } 
            // Sonra kanal ve işlem tipini birleştir
            else if (kanal || islemTipi) {
                aciklama = [kanal, islemTipi].filter(x => x).join(' - ') || 'Açıklama yok';
            } 
            // Son çare: "Açıklama yok"
            else {
                aciklama = 'Açıklama yok';
            }
        }

        // Uzun açıklamaları kısalt (150 karakterden uzunsa)
        if (aciklama.length > 150) {
            aciklama = aciklama.substring(0, 147) + '...';
        }

        // --- TRANSACTION KAYDET ---
        parsedTransactions.push({
            date: standardDate,
            description: aciklama,
            amount: tutar,
            balance: bakiye,
            channel: kanal || 'Bilinmiyor',
            type: islemTipi || 'Bilinmiyor'
        });

        console.log('✅ Transaction eklendi:', parsedTransactions[parsedTransactions.length - 1]);
    }

    console.log('\n📊 Toplam işlem sayısı:', parsedTransactions.length);
    return parsedTransactions;
}

function parseAmount(amountStr) {
    try {
        // Tüm boşlukları temizle
        let cleaned = amountStr.replace(/\s/g, '');
        
        // Türkçe format: 73.000,50 veya -73.000,50
        // Binlik ayracı (.) kaldır, ondalık ayracı (,) noktaya çevir
        cleaned = cleaned.replace(/\./g, '');  // 73000,50
        cleaned = cleaned.replace(',', '.');   // 73000.50
        
        const result = parseFloat(cleaned) || 0;
        
        // Debug için
        console.log(`Parse: "${amountStr}" → ${result}`);
        
        return result;
    } catch (e) {
        console.error('Amount parse error:', amountStr, e);
        return 0;
    }
}

function parseDate(dateStr) {
    // Format: 11/09/2025-10:32:37 veya 11.09.2025
    try {
        const datePart = dateStr.split(/[-\s]/)[0]; // Saat kısmını at
        const parts = datePart.split(/[\/\.]/);
        
        if (parts.length === 3) {
            const day = parts[0].padStart(2, '0');
            const month = parts[1].padStart(2, '0');
            const year = parts[2];
            return `${year}-${month}-${day}`;
        }
    } catch (e) {
        console.error('Date parse error:', dateStr, e);
    }
    return null;
}

function extractFromTo(description, amount) {
    // Açıklama temizleme
    let cleanDesc = description.trim();
    
    console.log(`🔍 Eşleştirme: "${cleanDesc.substring(0, 80)}" | Tutar: ${amount}`);
    
    // BSMV, komisyon gibi banka ücretleri
    if (cleanDesc.match(/BSMV|KOMİSYON|MASRAF|ÜCRET.*H\d+/i)) {
        return '💳 Banka Ücreti';
    }
    
    // Format 1: "İSİM*TR...*Açıklama" (En yaygın)
    // Örnek: "AYŞENUR ATEŞ DEMİRKAN*TR270006400000115220278205*NORA ÇEVRE..."
    const nameIbanMatch = cleanDesc.match(/^([^*]+)\*TR\d+/i);
    if (nameIbanMatch) {
        const name = nameIbanMatch[1].trim();
        console.log(`✅ Format 1 bulundu: "${name}"`);
        return name;
    }
    
    // Format 2: "İSİM*Açıklama" (IBAN yok)
    // Örnek: "ZET AŞ*ZET LOJİSTİK HAZIR BETON SANAYİ..."
    const nameStarMatch = cleanDesc.match(/^([A-ZÇĞİÖŞÜa-zçğıöşü\s\.]+)\*/);
    if (nameStarMatch) {
        const name = nameStarMatch[1].trim();
        // "ÜCRET" gibi anahtar kelimeler değilse
        if (!name.match(/ÜCRET|BSMV|KOMİSYON/i)) {
            console.log(`✅ Format 2 bulundu: "${name}"`);
            return name;
        }
    }
    
    // Format 3: "...tarafından aktarılan*İSİM*..."
    // Örnek: "AYŞENUR ATEŞ DEMİRKAN tarafından aktarılan*AYŞENUR ATEŞ DEMİRKAN*H2509..."
    const transferByMatch = cleanDesc.match(/([^*]+)\s+tarafından\s+aktarılan/i);
    if (transferByMatch) {
        const name = transferByMatch[1].trim();
        console.log(`✅ Format 3 bulundu: "${name}"`);
        return name;
    }
    
    // Format 4: "//FATURA_NO//TARİH//*FİRMA_ADI*..."
    // Örnek: "//NRC2025000000285//20250721/F110//*CAMİŞ MADENCİLİK ANONİM ŞİRKETİ*..."
    const invoiceMatch = cleanDesc.match(/\/\/.*?\/\/\*([^*]+)\*/);
    if (invoiceMatch) {
        const name = invoiceMatch[1].trim();
        console.log(`✅ Format 4 (Fatura) bulundu: "${name}"`);
        return name;
    }
    
    // Format 5: "cari hesap ist*FİRMA_ADI*..."
    // Örnek: "cari hesap ist*SENSER TEKSTİL HALI İMALAT SANAYİ..."
    const cariMatch = cleanDesc.match(/cari hesap ist\*([^*]+)/i);
    if (cariMatch) {
        const name = cariMatch[1].trim();
        console.log(`✅ Format 5 (Cari) bulundu: "${name}"`);
        return name;
    }
    
    // Format 6: "FİRMA_ADI*0046*Açıklama*..."
    // Örnek: "HAYRULLAH ALTINTAŞ*0046*Danışmanlık hizmeti ödemesi*..."
    const codeMatch = cleanDesc.match(/^([^*]+)\*\d{4}\*/);
    if (codeMatch) {
        const name = codeMatch[1].trim();
        console.log(`✅ Format 6 (Kod) bulundu: "${name}"`);
        return name;
    }
    
    // Format 7: "FİRMA_ADI*0062*NORA ÇEVRE..." (NRC numaralı)
    const nrcMatch = cleanDesc.match(/^([^*]+)\*006\d\*/);
    if (nrcMatch) {
        const name = nrcMatch[1].trim();
        console.log(`✅ Format 7 (NRC) bulundu: "${name}"`);
        return name;
    }
    
    // Format 8: Fatura ödemesi
    // Örnek: "100200334844 /TREPAŞ /FATURA NO:0000000910953291/K:02970"
    const billMatch = cleanDesc.match(/\/([A-ZÇĞİÖŞÜ\s]+)\s*\//);
    if (billMatch) {
        const name = billMatch[1].trim();
        console.log(`✅ Format 8 (Fatura) bulundu: "${name}"`);
        return name;
    }
    
    // Hiçbir format eşleşmedi - ilk 50 karakter
    console.log(`⚠️ Eşleşme bulunamadı, ham açıklama kullanılıyor`);
    return cleanDesc.substring(0, 50);
}

function categorizeTransaction(description, transactionType) {
    const desc = description.toUpperCase();
    const type = (transactionType || '').toUpperCase();
    
    // Banka ücretleri
    if (desc.includes('BSMV') || desc.match(/H\d{13}/)) return '💳 BSMV';
    if (desc.includes('ÜCRET') && desc.match(/H\d{13}/)) return '💳 Banka Ücreti';
    if (desc.includes('KOMİSYON')) return '💳 Komisyon';
    if (desc.includes('MASRAF')) return '💳 Masraf';
    
    // Fatura ödemeleri
    if (desc.includes('FATURA') || desc.includes('/TREPAŞ/')) return '🧾 Fatura';
    
    // İşlem tipleri
    if (type.includes('HAVALE')) return '💸 Havale';
    if (type.includes('EFT')) return '💸 EFT';
    if (type.includes('FAST')) return '⚡ Fast';
    if (type.includes('POS') || desc.includes('KART')) return '💳 Kart';
    if (type.includes('ÇEK')) return '📝 Çek';
    
    // Maaş ödemeleri
    if (desc.includes('MAAŞ') || desc.includes('MAA')) return '👔 Maaş';
    
    // Kira
    if (desc.includes('KİRA')) return '🏠 Kira';
    
    return '📋 Diğer';
}

        function matchTransactions(transactions) {
            const matches = [];

            transactions.forEach(transaction => {
                const match = {
                    transaction: transaction,
                    suggestedAccount: null,
                    suggestedInvoice: null,
                    confidence: 0
                };

                // Try to match with accounts based on description
                const description = transaction.description.toLowerCase();
                const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);

                for (let account of companyAccounts) {
                    const accountName = account.name.toLowerCase();
                    
                    // Simple matching - check if account name is in description
                    if (description.includes(accountName) || accountName.includes(description.split('*')[0])) {
                        match.suggestedAccount = account;
                        match.confidence = 80;
                        break;
                    }
                    
                    // Fuzzy match - check for partial matches
                    const words = accountName.split(' ');
                    for (let word of words) {
                        if (word.length > 3 && description.includes(word)) {
                            if (!match.suggestedAccount || match.confidence < 50) {
                                match.suggestedAccount = account;
                                match.confidence = 50;
                            }
                        }
                    }
                }

                // Try to match with invoices
                if (match.suggestedAccount) {
                    const accountInvoices = invoices.filter(inv => 
                        inv.accountId === match.suggestedAccount.id &&
                        Math.abs(inv.total - (inv.paidAmount || 0) - Math.abs(transaction.amount)) < 1
                    );

                    if (accountInvoices.length > 0) {
                        match.suggestedInvoice = accountInvoices[0];
                        match.confidence = 90;
                    }
                }

                matches.push(match);
            });

            showMatchingInterface(matches);
        }


function showMatchingInterface(matches) {
    const modal = document.getElementById('bankImportModal');
    const content = document.getElementById('bankImportContent');

    let html = `
        <div class="alert alert-info">
            <strong>✅ ${matches.length} işlem bulundu.</strong> Lütfen eşleştirmeleri kontrol edin.
        </div>
        <div id="matchList">
    `;

    matches.forEach((match, index) => {
        const t = match.transaction;
        const isMatched = match.suggestedAccount !== null;
        const confidenceText = match.confidence >= 80 ? 'Yüksek' : match.confidence >= 50 ? 'Orta' : 'Düşük';
        const confidenceColor = match.confidence >= 80 ? 'success' : match.confidence >= 50 ? 'warning' : 'danger';
        
        const amountColor = t.amount > 0 ? 'var(--success)' : 'var(--danger)';
        const amountSign = t.amount > 0 ? '+' : '';

        html += `
            <div class="payment-match-item ${isMatched ? 'matched' : 'unmatched'}">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <strong style="font-size: 1.1em;">${formatDate(t.date)}</strong>
                            <span style="color: ${amountColor}; font-weight: 700; font-size: 1.3em;">
                                ${amountSign}${formatCurrency(Math.abs(t.amount))}
                            </span>
                            <span class="badge badge-info">${t.category}</span>
                        </div>
                        <div style="font-size: 0.95em; margin-bottom: 5px;">
                            <strong>${t.amount > 0 ? '📥 Gönderen:' : '📤 Alıcı:'}</strong> 
                            <span style="color: #1f2937; font-weight: 600;">${t.fromTo}</span>
                        </div>
                        <div style="font-size: 0.85em; color: #6b7280; font-style: italic;">
                            ${t.description.substring(0, 100)}${t.description.length > 100 ? '...' : ''}
                        </div>
                    </div>
                    ${isMatched ? `
                        <span class="badge badge-${confidenceColor}" style="margin-left: 10px;">
                            ${confidenceText} Eşleşme
                        </span>
                    ` : ''}
                </div>
                
                <div class="grid-2" style="margin-top: 15px;">
                    <div class="form-group">
                        <label>Cari Hesap ${isMatched ? '(Önerilen)' : ''}</label>
                        <select id="matchAccount_${index}" onchange="updateMatchInvoices(${index})" style="font-weight: ${isMatched ? '600' : 'normal'};">
                            <option value="">Manuel Seçin</option>
                            ${accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId).map(a => 
                                `<option value="${a.id}" ${match.suggestedAccount && match.suggestedAccount.id === a.id ? 'selected' : ''}>${a.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Fatura (Opsiyonel)</label>
                        <select id="matchInvoice_${index}">
                            <option value="">Genel Ödeme</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
    });

    html += `
        </div>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border); text-align: right;">
            <button class="btn btn-success" onclick="confirmBankImport()">
                ✅ ${matches.length} İşlemi Kaydet
            </button>
            <button class="btn btn-secondary" onclick="closeBankImportModal()">✖️ İptal</button>
        </div>
    `;

    content.innerHTML = html;
    modal.classList.add('active');

    // Populate invoice selects
    matches.forEach((match, index) => {
        if (match.suggestedAccount) {
            updateMatchInvoices(index, match.suggestedInvoice ? match.suggestedInvoice.id : null);
        }
    });

    window.bankMatches = matches;
}

        function updateMatchInvoices(index, selectedInvoiceId = null) {
            const accountSelect = document.getElementById(`matchAccount_${index}`);
            const invoiceSelect = document.getElementById(`matchInvoice_${index}`);
            
            const accountId = accountSelect.value;
            invoiceSelect.innerHTML = '<option value="">Genel Ödeme</option>';

            if (!accountId) return;

            const accountInvoices = invoices.filter(inv => 
                inv.accountId === accountId && 
                (inv.total - (inv.paidAmount || 0)) > 0
            );

            accountInvoices.forEach(invoice => {
                const remaining = invoice.total - (invoice.paidAmount || 0);
                const option = new Option(
                    `${invoice.invoiceNo} - ${formatCurrency(remaining)} kalan`,
                    invoice.id
                );
                if (selectedInvoiceId && invoice.id === selectedInvoiceId) {
                    option.selected = true;
                }
                invoiceSelect.add(option);
            });
        }

        function confirmBankImport() {
            if (!window.bankMatches) return;

            let importedCount = 0;

            window.bankMatches.forEach((match, index) => {
                const accountId = document.getElementById(`matchAccount_${index}`).value;
                const invoiceId = document.getElementById(`matchInvoice_${index}`).value;

                if (!accountId) return; // Skip if no account selected

                const payment = {
                    id: Date.now().toString() + '_' + index,
                    companyId: activeCompanyId,
                    date: match.transaction.date,
                    accountId: accountId,
                    amount: Math.abs(match.transaction.amount),
                    type: match.transaction.amount > 0 ? 'income' : 'expense',
                    invoiceId: invoiceId || null,
                    description: match.transaction.description,
                    source: 'bank',
                    createdAt: new Date().toISOString()
                };

                payments.push(payment);

                // Update invoice
                if (invoiceId) {
                    const invoice = invoices.find(inv => inv.id === invoiceId);
                    if (invoice) {
                        invoice.paidAmount = (invoice.paidAmount || 0) + payment.amount;
                        if (invoice.paidAmount >= invoice.total) {
                            invoice.status = 'paid';
                        } else {
                            invoice.status = 'partial';
                        }
                    }
                }

                // Update account balance
                const account = accounts.find(a => a.id === accountId);
                if (account) {
                    if (payment.type === 'income') {
                        account.balance += payment.amount;
                    } else {
                        account.balance -= payment.amount;
                    }
                }

                importedCount++;
            });

            localStorage.setItem('payments', JSON.stringify(payments));
            localStorage.setItem('invoices', JSON.stringify(invoices));
            localStorage.setItem('accounts', JSON.stringify(accounts));

            closeBankImportModal();
            loadPayments();
            loadInvoices();
            loadAccounts();
            updateDashboard();

            alert(`✅ ${importedCount} ödeme başarıyla kaydedildi!`);
        }

        function closeBankImportModal() {
            document.getElementById('bankImportModal').classList.remove('active');
            window.bankMatches = null;
        }

// updateDashboard() fonksiyonuna ekle (Satır ~1440 civarı)

function updateDashboard() {
    const companyInvoices = invoices.filter(inv => !activeCompanyId || inv.companyId === activeCompanyId);
    const companyPayments = payments.filter(p => !activeCompanyId || p.companyId === activeCompanyId);
    const companyPurchases = purchases.filter(p => !activeCompanyId || p.companyId === activeCompanyId); // YENİ

    const salesInvoices = companyInvoices.filter(inv => inv.type === 'sales');
    const purchaseInvoices = companyInvoices.filter(inv => inv.type === 'purchase');

    const totalIncome = salesInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
    const totalExpense = purchaseInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
    
    // YENİ: Alışları da giderlere ekle
    const purchasesExpense = companyPurchases.reduce((sum, p) => sum + p.amount, 0);
    const totalExpenseWithPurchases = totalExpense + purchasesExpense;
    
    const netProfit = totalIncome - totalExpenseWithPurchases;

    const salesVAT = salesInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
    const purchaseVAT = purchaseInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
    
    // YENİ: Alışların KDV'sini de mahsuba ekle
    const purchasesVAT = companyPurchases.reduce((sum, p) => sum + p.vatAmount, 0);
    const totalVAT = salesVAT - (purchaseVAT + purchasesVAT);

    const corporateTax = netProfit > 0 ? netProfit * 0.20 : 0;

    const totalPaymentsAmount = companyPayments.reduce((sum, p) => sum + (p.type === 'income' ? p.amount : -p.amount), 0);
    
    const receivables = salesInvoices.reduce((sum, inv) => sum + (inv.total - (inv.paidAmount || 0)), 0);

    document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
    document.getElementById('totalExpense').textContent = formatCurrency(totalExpenseWithPurchases);
    document.getElementById('netProfit').textContent = formatCurrency(netProfit);
    document.getElementById('totalVAT').textContent = formatCurrency(totalVAT);
    document.getElementById('corporateTax').textContent = formatCurrency(corporateTax);
    document.getElementById('totalPayments').textContent = formatCurrency(totalPaymentsAmount);
    document.getElementById('receivables').textContent = formatCurrency(receivables);
}

        function updateRecentInvoices() {
            const tbody = document.querySelector('#recentInvoices tbody');
            tbody.innerHTML = '';

            const recentInvoices = invoices
                .filter(inv => !activeCompanyId || inv.companyId === activeCompanyId)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            if (recentInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:10px; color:#6b7280;">Henüz fatura yok</td></tr>';
                return;
            }

            recentInvoices.forEach(invoice => {
                const account = accounts.find(a => a.id === invoice.accountId);
                const remaining = invoice.total - (invoice.paidAmount || 0);
                let statusText = remaining <= 0 ? 'Ödendi' : invoice.paidAmount > 0 ? 'Kısmi' : 'Ödenmedi';
                let statusClass = remaining <= 0 ? 'status-paid' : invoice.paidAmount > 0 ? 'status-partial' : 'status-unpaid';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(invoice.date)}</td>
                    <td>${invoice.invoiceNo}</td>
                    <td>${account ? account.name : 'Silinmiş'}</td>
                    <td>${formatCurrency(invoice.total)}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                `;
            });
        }

        function updateRecentPayments() {
            const tbody = document.querySelector('#recentPayments tbody');
            tbody.innerHTML = '';

            const recentPayments = payments
                .filter(p => !activeCompanyId || p.companyId === activeCompanyId)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            if (recentPayments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:10px; color:#6b7280;">Henüz ödeme yok</td></tr>';
                return;
            }

            recentPayments.forEach(payment => {
                const account = accounts.find(a => a.id === payment.accountId);
                const typeText = payment.type === 'income' ? '📗 Tahsilat' : '📕 Ödeme';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(payment.date)}</td>
                    <td>${account ? account.name : 'Silinmiş'}</td>
                    <td style="color: ${payment.type === 'income' ? 'var(--success)' : 'var(--danger)'};">
                        ${payment.type === 'income' ? '+' : '-'}${formatCurrency(payment.amount)}
                    </td>
                    <td>${typeText}</td>
                `;
            });
        }

        // REPORTS FUNCTIONS
        function generateReport() {
            const year = document.getElementById('reportYear').value;
            const month = document.getElementById('reportMonth').value;

            const companyInvoices = invoices.filter(inv => {
                if (activeCompanyId && inv.companyId !== activeCompanyId) return false;
                
                const invDate = new Date(inv.date);
                const invYear = invDate.getFullYear().toString();
                const invMonth = (invDate.getMonth() + 1).toString().padStart(2, '0');

                if (invYear !== year) return false;
                if (month && invMonth !== month) return false;

                return true;
            });

            const salesInvoices = companyInvoices.filter(inv => inv.type === 'sales');
            const purchaseInvoices = companyInvoices.filter(inv => inv.type === 'purchase');

            const totalIncome = salesInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
            const totalExpense = purchaseInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
            const netProfit = totalIncome - totalExpense;

            const salesVAT = salesInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
            const purchaseVAT = purchaseInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
            const totalVAT = salesVAT - purchaseVAT;

            const corporateTax = netProfit > 0 ? netProfit * 0.20 : 0;

            const periodText = month ? `${getMonthName(month)} ${year}` : `${year} Yılı`;

            const html = `
                <div class="card">
                    <h3>📊 ${periodText} Dönemi Raporu</h3>
                    
                    <div class="grid-3">
                        <div class="stat-card success">
                            <h4>Satış Geliri</h4>
                            <div class="amount">${formatCurrency(totalIncome)}</div>
                            <small>${salesInvoices.length} Fatura</small>
                        </div>
                        <div class="stat-card danger">
                            <h4>Alış Gideri</h4>
                            <div class="amount">${formatCurrency(totalExpense)}</div>
                            <small>${purchaseInvoices.length} Fatura</small>
                        </div>
                        <div class="stat-card">
                            <h4>Net Kar/Zarar</h4>
                            <div class="amount">${formatCurrency(netProfit)}</div>
                        </div>
                    </div>

                    <div class="grid-2" style="margin-top:20px;">
                        <div class="stat-card warning">
                            <h4>Ödenecek KDV</h4>
                            <div class="amount">${formatCurrency(totalVAT)}</div>
                            <small>Satış KDV - Alış KDV</small>
                        </div>
                        <div class="stat-card purple">
                            <h4>Tahmini Kurumlar Vergisi</h4>
                            <div class="amount">${formatCurrency(corporateTax)}</div>
                            <small>Net Kar x %20</small>
                        </div>
                    </div>

                    <div style="margin-top:30px;">
                        <h4>📋 Detaylı Fatura Listesi</h4>
                        ${companyInvoices.length === 0 ? '<p style="text-align:center; padding:20px; color:#6b7280;">Bu dönemde fatura yok.</p>' : `
                        <table>
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>No</th>
                                    <th>Tür</th>
                                    <th>Cari</th>
                                    <th>Ara Toplam</th>
                                    <th>KDV</th>
                                    <th>Toplam</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${companyInvoices.map(inv => {
                                    const account = accounts.find(a => a.id === inv.accountId);
                                    const typeText = inv.type === 'sales' ? '📗 Satış' : '📕 Alış';
                                    const remaining = inv.total - (inv.paidAmount || 0);
                                    let statusText = remaining <= 0 ? 'Ödendi' : inv.paidAmount > 0 ? 'Kısmi' : 'Ödenmedi';
                                    return `
                                        <tr>
                                            <td>${formatDate(inv.date)}</td>
                                            <td>${inv.invoiceNo}</td>
                                            <td>${typeText}</td>
                                            <td>${account ? account.name : 'Silinmiş'}</td>
                                            <td>${formatCurrency(inv.subtotal)}</td>
                                            <td>${formatCurrency(inv.vatAmount)}</td>
                                            <td><strong>${formatCurrency(inv.total)}</strong></td>
                                            <td>${statusText}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        `}
                    </div>
                </div>
            `;

            document.getElementById('reportResults').innerHTML = html;
        }

        function generateStatement() {
            const accountId = document.getElementById('statementAccount').value;
            const startDate = document.getElementById('statementStartDate').value;
            const endDate = document.getElementById('statementEndDate').value;

            if (!accountId) {
                alert('⚠️ Lütfen bir cari hesap seçin!');
                return;
            }

            const account = accounts.find(a => a.id === accountId);
            if (!account) return;

            let accountTransactions = [];

            // Add invoices
            invoices.filter(inv => inv.accountId === accountId).forEach(inv => {
                if (startDate && inv.date < startDate) return;
                if (endDate && inv.date > endDate) return;
                
                accountTransactions.push({
                    date: inv.date,
                    type: 'invoice',
                    description: `Fatura: ${inv.invoiceNo}`,
                    debit: inv.type === 'sales' ? inv.total : 0,
                    credit: inv.type === 'purchase' ? inv.total : 0,
                    reference: inv.invoiceNo
                });
            });

            // Add payments
            payments.filter(p => p.accountId === accountId).forEach(p => {
                if (startDate && p.date < startDate) return;
                if (endDate && p.date > endDate) return;
                
                accountTransactions.push({
                    date: p.date,
                    type: 'payment',
                    description: p.description || 'Ödeme',
                    debit: p.type === 'expense' ? p.amount : 0,
                    credit: p.type === 'income' ? p.amount : 0,
                    reference: p.invoiceId ? invoices.find(inv => inv.id === p.invoiceId)?.invoiceNo : '-'
                });
            });

            accountTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));

            let balance = 0;
            const rows = accountTransactions.map(t => {
                balance += (t.debit - t.credit);
                return `
                    <tr>
                        <td>${formatDate(t.date)}</td>
                        <td>${t.reference}</td>
                        <td>${t.description}</td>
                        <td style="color: var(--danger); font-weight:600;">${t.debit > 0 ? formatCurrency(t.debit) : '-'}</td>
                        <td style="color: var(--success); font-weight:600;">${t.credit > 0 ? formatCurrency(t.credit) : '-'}</td>
                        <td style="font-weight:700;">${formatCurrency(balance)}</td>
                    </tr>
                `;
            }).join('');

            const html = `
                <div style="margin-top:20px;">
                    <h4>📋 ${account.name} - Cari Ekstre</h4>
                    <p><strong>Dönem:</strong> ${startDate ? formatDate(startDate) : 'Başlangıç'} - ${endDate ? formatDate(endDate) : 'Bugün'}</p>
                    <p><strong>Güncel Bakiye:</strong> <span style="color: ${balance >= 0 ? 'var(--success)' : 'var(--danger)'}; font-size:1.8em; font-weight:700;">${formatCurrency(balance)}</span></p>
                    
                    ${accountTransactions.length === 0 ? '<p style="text-align:center; padding:20px; color:#6b7280;">Bu dönemde işlem yok.</p>' : `
                    <table>
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Referans</th>
                                <th>Açıklama</th>
                                <th>Borç</th>
                                <th>Alacak</th>
                                <th>Bakiye</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                    `}
                </div>
            `;

            document.getElementById('statementResults').innerHTML = html;
        }

        // DATA MANAGEMENT
        function exportData() {
            const data = {
                companies: companies,
                accounts: accounts,
                invoices: invoices,
                payments: payments,
                activeCompanyId: activeCompanyId,
                exportDate: new Date().toISOString(),
                version: '2.0.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `muhasebe-yedek-v2-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert('✅ Veriler başarıyla dışa aktarıldı!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.companies || !data.accounts || !data.invoices) {
                        alert('⚠️ Geçersiz yedek dosyası!');
                        return;
                    }

                    if (confirm('⚠️ Mevcut tüm veriler silinecek ve yedekten geri yüklenecek. Devam etmek istiyor musunuz?')) {
                        companies = data.companies;
                        accounts = data.accounts;
                        invoices = data.invoices;
                        payments = data.payments || [];
                        activeCompanyId = data.activeCompanyId;

                        localStorage.setItem('companies', JSON.stringify(companies));
                        localStorage.setItem('accounts', JSON.stringify(accounts));
                        localStorage.setItem('invoices', JSON.stringify(invoices));
                        localStorage.setItem('payments', JSON.stringify(payments));
                        localStorage.setItem('activeCompanyId', activeCompanyId);

                        initializeApp();
                        
                        alert('✅ Veriler başarıyla içe aktarıldı!');
                    }
                } catch (error) {
                    alert('❌ Dosya okunamadı! Lütfen geçerli bir yedek dosyası seçin.');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        function clearAllData() {
            if (!confirm('⚠️ TÜM VERİLER SİLİNECEK! Bu işlem geri alınamaz. Devam etmek istiyor musunuz?')) {
                return;
            }

            if (!confirm('⚠️⚠️⚠️ SON UYARI! Tüm firmalar, cari hesaplar, faturalar ve ödemeler kalıcı olarak silinecek. EMİN MİSİNİZ?')) {
                return;
            }

            localStorage.clear();

            companies = [];
            accounts = [];
            invoices = [];
            payments = [];
            activeCompanyId = null;

            initializeApp();

            alert('✅ Tüm veriler silindi!');
        }

function populateSelects() {
     populateCompanySelects();
    populateAccountSelects();
    populatePaymentAccounts();

    // Teklif formu için cari hesapları doldur
    const proposalCariSelect = document.getElementById('proposalCariAccount');
    if (proposalCariSelect) {
        proposalCariSelect.innerHTML = '<option value="">Cari hesap seçiniz...</option>';
        
        let accountsToShow = accounts;
        if (activeCompanyId) {
            accountsToShow = accounts.filter(a => a.companyId === activeCompanyId);
        }
        
        accountsToShow.forEach(account => {
            const option = document.createElement('option');
            option.value = account.id;
            option.textContent = `${account.name} ${account.taxNo ? '(' + account.taxNo + ')' : ''}`;
            proposalCariSelect.appendChild(option);
        });
    }
}

function populateAccountSelects() {
    // Invoice account select
    const invoiceAccountSelect = document.getElementById('invoiceAccount');
    if (invoiceAccountSelect) {
        const currentValue = invoiceAccountSelect.value;
        invoiceAccountSelect.innerHTML = '<option value="">Cari Hesap Seçin</option>';
        
        accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId).forEach(account => {
            const option = new Option(
                `${account.name} (${account.type === 'customer' ? 'Müşteri' : 'Tedarikçi'})`,
                account.id
            );
            invoiceAccountSelect.add(option);
        });
        
        if (currentValue) {
            invoiceAccountSelect.value = currentValue;
        }
    }
}

function populatePaymentAccounts() {
    const select = document.getElementById('paymentAccount');
    if (!select) return;
    
    select.innerHTML = '<option value="">Seçiniz</option>';
    
    const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
    companyAccounts.forEach(account => {
        const option = new Option(
            `${account.name} (${account.type === 'customer' ? 'Müşteri' : 'Tedarikçi'})`,
            account.id
        );
        select.add(option);
    });
}

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR');
        }

        function getMonthName(month) {
            const months = {
                '01': 'Ocak', '02': 'Şubat', '03': 'Mart', '04': 'Nisan',
                '05': 'Mayıs', '06': 'Haziran', '07': 'Temmuz', '08': 'Ağustos',
                '09': 'Eylül', '10': 'Ekim', '11': 'Kasım', '12': 'Aralık'
            };
            return months[month] || month;
        }

function showTransactionDetailsModal(transactions) {
    console.log('🔵 showTransactionDetailsModal çağrıldı');
    console.log('📊 Gelen transaction sayısı:', transactions.length);

    if (!transactions || transactions.length === 0) {
        console.error('❌ Transactions boş veya undefined!');
        alert('Gösterilecek işlem bulunamadı!');
        return;
    }

    const modal = document.getElementById('transactionDetailsModal');
    const container = document.getElementById('transactionDetailsContainer');

    if (!modal || !container) {
        console.error('❌ Modal veya Container elementi bulunamadı!');
        return;
    }

    console.log('✅ Modal ve Container elementleri bulundu');

    // Store transactions globally
    pendingTransactions = transactions;

    // Container'ı temizle
    container.innerHTML = '';

    // ✅ EŞLEŞME İSTATİSTİKLERİ
    let autoMatchedCount = 0;
    let manualMatchCount = 0;

    // ✅ HER TRANSACTION İÇİN OTOMATİK EŞLEŞTIRME YAP
    transactions.forEach((tx, index) => {
        // Otomatik cari hesap eşleştirme
        const matchResult = findMatchingAccountForTransaction(tx);
        tx.suggestedAccount = matchResult.account;
        tx.matchConfidence = matchResult.confidence;
        tx.matchReason = matchResult.reason;

        if (matchResult.account) {
            autoMatchedCount++;
        } else {
            manualMatchCount++;
        }

        console.log(`📝 Transaction ${index + 1}:`, {
            amount: tx.amount,
            description: tx.description.substring(0, 50),
            matchedAccount: matchResult.account?.name || 'YOK',
            confidence: matchResult.confidence,
            reason: matchResult.reason
        });
    });

    // Özet istatistik
    const totalCount = transactions.length;
    const matchPercentage = Math.round((autoMatchedCount / totalCount) * 100);

    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'alert alert-success';
    summaryDiv.style.cssText = 'margin-bottom: 20px;';
    summaryDiv.innerHTML = `
        <strong>✅ ${totalCount} banka işlemi başarıyla okundu!</strong><br>
        <div style="margin-top: 10px; display: flex; gap: 20px; font-size: 0.95em;">
            <span style="color: var(--success);">✅ ${autoMatchedCount} otomatik eşleşti (%${matchPercentage})</span>
            ${manualMatchCount > 0 ? `<span style="color: var(--warning);">⚠️ ${manualMatchCount} manuel seçim gerekli</span>` : ''}
        </div>
    `;
    container.appendChild(summaryDiv);

    // Her transaction için kart oluştur
    transactions.forEach((tx, index) => {
        const card = document.createElement('div');
        card.className = 'transaction-detail-card';
        
        // ✅ Eşleşme durumuna göre renk
        const borderColor = tx.suggestedAccount ? '#10b981' : '#f59e0b';
        const bgGradient = tx.suggestedAccount 
            ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' 
            : 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';

        card.style.cssText = `
            background: ${bgGradient};
            border-left: 4px solid ${borderColor};
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        `;

        const amountColor = tx.amount >= 0 ? '#00b894' : '#d63031';
        const amountPrefix = tx.amount >= 0 ? '+' : '';
        const formattedAmount = `${amountPrefix}₺${Math.abs(tx.amount).toLocaleString('tr-TR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        })}`;

        // Güven skoru badge
        const confidenceBadge = tx.suggestedAccount 
            ? `<span class="badge badge-${tx.matchConfidence >= 90 ? 'success' : tx.matchConfidence >= 70 ? 'warning' : 'danger'}" style="font-size: 0.9em;">
                ${tx.matchConfidence}% Eşleşme
               </span>`
            : '<span class="badge badge-danger" style="font-size: 0.9em;">Manuel Seçim Gerekli</span>';

        // Get current account list for dropdown
        const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
        const accountOptions = companyAccounts.map(acc => 
            `<option value="${acc.id}" ${tx.suggestedAccount && tx.suggestedAccount.id === acc.id ? 'selected' : ''}>
                ${acc.name} (${acc.type === 'customer' ? 'Müşteri' : 'Tedarikçi'})
            </option>`
        ).join('');

        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <div style="font-size: 18px; font-weight: bold; color: ${amountColor};">
                            ${formattedAmount}
                        </div>
                        ${confidenceBadge}
                    </div>
                    <div style="font-size: 14px; color: #2d3436; margin-bottom: 4px;">
                        📅 ${tx.date || 'Tarih yok'}
                    </div>
                    <div style="font-size: 13px; color: #636e72; margin-bottom: 8px;">
                        💳 ${tx.channel || 'Kanal bilgisi yok'} | ${tx.type || 'İşlem tipi yok'}
                    </div>
                    ${tx.suggestedAccount ? `
                        <div style="font-size: 0.9em; color: var(--success); margin-top: 8px; padding: 8px; background: rgba(16, 185, 129, 0.15); border-radius: 6px;">
                            ✅ <strong>Otomatik Eşleşti:</strong> ${tx.suggestedAccount.name}<br>
                            <small style="opacity: 0.8;">Sebep: ${tx.matchReason}</small>
                        </div>
                    ` : `
                        <div style="font-size: 0.9em; color: var(--danger); margin-top: 8px; padding: 8px; background: rgba(239, 68, 68, 0.15); border-radius: 6px;">
                            ⚠️ Cari hesap bulunamadı - Lütfen manuel seçin
                        </div>
                    `}
                </div>
                <div style="background: white; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #2d3436; font-weight: 500;">
                    Bakiye: ₺${(tx.balance || 0).toLocaleString('tr-TR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    })}
                </div>
            </div>
            <div style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 6px; font-size: 13px; color: #2d3436; line-height: 1.5; margin-bottom: 12px;">
                📝 ${tx.description || 'Açıklama yok'}
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="display: block; font-size: 12px; color: #636e72; margin-bottom: 5px;">
                        Cari Hesap ${tx.suggestedAccount ? '(✅ Otomatik)' : '(⚠️ Manuel)'}
                    </label>
                    <select class="cari-hesap-select" data-index="${index}" style="width: 100%; padding: 8px; border: 2px solid ${tx.suggestedAccount ? 'var(--success)' : 'var(--danger)'}; border-radius: 4px; background: white; font-weight: ${tx.suggestedAccount ? '600' : 'normal'};">
                        <option value="">Cari Hesap Seçin</option>
                        ${accountOptions}
                    </select>
                </div>
                <div>
                    <label style="display: block; font-size: 12px; color: #636e72; margin-bottom: 5px;">
                        Kategori (Opsiyonel)
                    </label>
                    <select class="fatura-select" data-index="${index}" style="width: 100%; padding: 8px; border: 1px solid #dfe6e9; border-radius: 4px; background: white;">
                        <option value="">Genel Ödeme</option>
                        <option value="Kira Ödemesi">Kira Ödemesi</option>
                        <option value="Maaş Ödemesi">Maaş Ödemesi</option>
                        <option value="Hizmet Bedeli">Hizmet Bedeli</option>
                        <option value="Fatura Ödemesi">Fatura Ödemesi</option>
                        <option value="Vergi/SGK">Vergi/SGK</option>
                        <option value="Banka Ücreti">Banka Ücreti</option>
                        <option value="Diğer">Diğer</option>
                    </select>
                </div>
            </div>
        `;

        container.appendChild(card);
    });

    // ✅ EKLE: Kaydetme butonu
    const saveButtonHTML = `
        <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
            <button class="btn btn-secondary" onclick="closeTransactionDetailsModal()">
                ✖️ İptal
            </button>
            <button class="btn btn-success" onclick="confirmImportTransactions()" style="font-size: 16px; padding: 12px 30px;">
                💾 ${transactions.length} İşlemi Kaydet
            </button>
        </div>
    `;
    
    container.innerHTML += saveButtonHTML;
    
    // Global'e kaydet
    window.pendingTransactions = transactions;

    // Modal'ı göster
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.style.opacity = '1';
    }, 10);
}

// ✅ Banka işlemlerini Firebase'e kaydet
async function confirmImportTransactions() {
    console.log('💾 Banka işlemleri kaydediliyor...');
    
    if (!window.pendingTransactions || window.pendingTransactions.length === 0) {
        alert('❌ Kaydedilecek işlem yok!');
        return;
    }
    
    if (!activeCompanyId) {
        alert('❌ Lütfen bir firma seçin!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('❌ Lütfen giriş yapın!');
        return;
    }
    
    try {
        const batch = db.batch();
        const now = new Date().toISOString();
        let savedCount = 0;
        let skippedCount = 0;
        
        for (let i = 0; i < window.pendingTransactions.length; i++) {
            const trans = window.pendingTransactions[i];
            
            const accountSelect = document.querySelector(`.cari-hesap-select[data-index="${i}"]`);
            const accountId = accountSelect ? accountSelect.value : trans.suggestedAccount?.id;
            
            if (!accountId || accountId === '' || accountId === 'YOK') {
                console.log(`⚠️ İşlem ${i} atlandı: Cari hesap seçilmedi`);
                skippedCount++;
                continue;
            }
            
            const paymentRef = db.collection('companies').doc(activeCompanyId)
                .collection('payments').doc();
            
            const paymentData = {
                id: paymentRef.id,
                companyId: activeCompanyId,
                date: trans.date,
                accountId: accountId,
                amount: Math.abs(trans.amount),
                type: trans.amount > 0 ? 'income' : 'expense',
                description: trans.description,
                source: 'bank',
                createdAt: now,
                createdBy: auth.currentUser.uid
            };
            
            batch.set(paymentRef, paymentData);
            payments.push(paymentData);
            
            savedCount++;
            console.log(`✅ İşlem ${i} hazırlandı: ${paymentData.amount} TL`);
        }
        
        if (savedCount > 0) {
            await batch.commit();
            console.log(`✅ ${savedCount} işlem Firebase'e kaydedildi`);
        }
        
        closeTransactionDetailsModal();
        
        await loadPayments();
        await loadAccounts();
        updateDashboard();
        
        if (skippedCount > 0) {
            alert(`✅ ${savedCount} işlem kaydedildi\n⚠️ ${skippedCount} işlem atlandı (cari hesap seçilmedi)`);
        } else {
            alert(`✅ ${savedCount} banka işlemi başarıyla kaydedildi!`);
        }
        
    } catch (error) {
        console.error('❌ Firebase kaydetme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

function closeTransactionDetailsModal() {
    console.log('🔴 Modal kapatılıyor...');
    const modal = document.getElementById('transactionDetailsModal');
    if (modal) {
        modal.style.display = 'none';
    }
    window.pendingTransactions = null;
    console.log('✅ Modal kapatıldı');
}

// ========================================
// BANKA İŞLEMİ OTOMATİK EŞLEŞTIRME
// ========================================

function findMatchingAccountForTransaction(transaction) {
    const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
    
    if (companyAccounts.length === 0) {
        return { account: null, confidence: 0, reason: 'Cari hesap yok' };
    }

    const description = transaction.description.toUpperCase();
    const amount = Math.abs(transaction.amount);

    console.log(`\n🔍 Eşleştirme: "${description.substring(0, 80)}" | Tutar: ${amount}`);

    // ========================================
    // 1. BANKA ÜCRETLERİ (Otomatik Atla veya Özel Cari)
    // ========================================
    if (description.match(/BSMV|KOMİSYON.*H\d{13}|MASRAF.*H\d{13}|ÜCRET.*H\d{13}/i)) {
        // Eğer "Banka Ücretleri" carisi varsa otomatik eşleştir
        const bankFeesAccount = companyAccounts.find(a => 
            a.name.toUpperCase().includes('BANKA') && 
            (a.name.toUpperCase().includes('ÜCRET') || a.name.toUpperCase().includes('GİDER'))
        );
        
        if (bankFeesAccount) {
            return { 
                account: bankFeesAccount, 
                confidence: 100, 
                reason: 'Banka ücreti - Otomatik atandı' 
            };
        }
        
        return { 
            account: null, 
            confidence: 0, 
            reason: 'Banka ücreti - "Banka Ücretleri" carisi oluşturun' 
        };
    }

    // ========================================
    // 2. FATURA ÖDEMELERİ (NRC Numaralı)
    // ========================================
    // Format: "//NRC2025000000285//20250721/F110//*CAMİŞ MADENCİLİK ANONİM ŞİRKETİ*..."
    const nrcMatch = description.match(/NRC\d{13}/);
    if (nrcMatch) {
        const nrcNo = nrcMatch[0];
        console.log(`📄 NRC Fatura Numarası bulundu: ${nrcNo}`);
        
        // Faturayı bul
        const matchedInvoice = invoices.find(inv => 
            inv.invoiceNo && inv.invoiceNo.toUpperCase().includes(nrcNo)
        );
        
        if (matchedInvoice) {
            const invoiceAccount = accounts.find(a => a.id === matchedInvoice.accountId);
            if (invoiceAccount) {
                console.log(`✅ FATURA EŞLEŞME: ${nrcNo} → ${invoiceAccount.name}`);
                return { 
                    account: invoiceAccount, 
                    confidence: 100, 
                    reason: `Fatura ${nrcNo} ile eşleşti` 
                };
            }
        }
        
        // Fatura bulunamadıysa firma adından eşleştir
        const companyMatch = description.match(/\/\/\*([^*]+)\*/);
        if (companyMatch) {
            const companyName = companyMatch[1].trim();
            const result = findAccountByName(companyName, companyAccounts);
            if (result.account) {
                return { 
                    account: result.account, 
                    confidence: result.confidence, 
                    reason: `NRC fatura - Firma adı eşleşti: ${companyName}` 
                };
            }
        }
    }

    // ========================================
    // 3. İSİM*IBAN FORMATI
    // ========================================
    // Format: "AYŞENUR ATEŞ DEMİRKAN*TR270006400000115220278205*..."
    const nameIbanMatch = description.match(/^([^*]+)\*TR\d{24}/);
    if (nameIbanMatch) {
        const name = nameIbanMatch[1].trim();
        console.log(`👤 Format: İsim*IBAN → "${name}"`);
        
        const result = findAccountByName(name, companyAccounts);
        if (result.account) {
            return { 
                account: result.account, 
                confidence: result.confidence, 
                reason: `İsim eşleşti: ${name}` 
            };
        }
    }

    // ========================================
    // 4. İSİM*AÇIKLAMA FORMATI (IBAN yok)
    // ========================================
    // Format: "ZET AŞ*ZET LOJİSTİK HAZIR BETON..."
    const nameStarMatch = description.match(/^([A-ZÇĞİÖŞÜa-zçğıöşü\s\.]+)\*/);
    if (nameStarMatch) {
        const name = nameStarMatch[1].trim();
        
        // "ÜCRET" gibi kelimeler değilse
        if (!name.match(/ÜCRET|BSMV|KOMİSYON|MASRAF/i)) {
            console.log(`👤 Format: İsim*Açıklama → "${name}"`);
            
            const result = findAccountByName(name, companyAccounts);
            if (result.account) {
                return { 
                    account: result.account, 
                    confidence: result.confidence, 
                    reason: `İsim eşleşti: ${name}` 
                };
            }
        }
    }

    // ========================================
    // 5. TUTAR BAZLI EŞLEŞTIRME (Bekleyen Faturalar)
    // ========================================
    const unpaidInvoices = invoices.filter(inv => {
        const remaining = inv.total - (inv.paidAmount || 0);
        return remaining > 0 && Math.abs(remaining - amount) < 1; // 1 TL tolerans
    });

    if (unpaidInvoices.length === 1) {
        const invoice = unpaidInvoices[0];
        const invoiceAccount = accounts.find(a => a.id === invoice.accountId);
        
        if (invoiceAccount) {
            console.log(`✅ TUTAR EŞLEŞME: ${amount} TL → ${invoiceAccount.name} (Fatura: ${invoice.invoiceNo})`);
            return { 
                account: invoiceAccount, 
                confidence: 85, 
                reason: `Bekleyen fatura tutarı eşleşti (${invoice.invoiceNo})` 
            };
        }
    }

    // ========================================
    // 6. ACİL DURUMLAR (Maaş, Kira vb.)
    // ========================================
    if (description.includes('MAAŞ') || description.includes('MAA')) {
        const salaryAccount = companyAccounts.find(a => 
            a.name.toUpperCase().includes('PERSONEL') || 
            a.name.toUpperCase().includes('MAAŞ')
        );
        
        if (salaryAccount) {
            return { 
                account: salaryAccount, 
                confidence: 90, 
                reason: 'Maaş ödemesi tespit edildi' 
            };
        }
    }

    if (description.includes('KİRA')) {
        const rentAccount = companyAccounts.find(a => 
            a.name.toUpperCase().includes('KİRA')
        );
        
        if (rentAccount) {
            return { 
                account: rentAccount, 
                confidence: 90, 
                reason: 'Kira ödemesi tespit edildi' 
            };
        }
    }

    console.log(`❌ Eşleşme bulunamadı`);
    return { account: null, confidence: 0, reason: 'Otomatik eşleştirme başarısız' };
}

// ========================================
// YARDIMCI FONKSİYON: İsimden Cari Bulma
// ========================================

function findAccountByName(searchName, accountList) {
    const cleanName = (name) => {
        return name.toUpperCase()
            .replace(/\s+/g, ' ')
            .replace(/\./g, '')
            .replace(/LTD\.?\s*ŞTİ\.?/gi, '')
            .replace(/LİMİTED\s*ŞİRKETİ/gi, '')
            .replace(/A\.?\s*Ş\.?/gi, '')
            .replace(/ANONİM\s*ŞİRKETİ/gi, '')
            .replace(/SANAYİ/gi, '')
            .replace(/TİCARET/gi, '')
            .replace(/VE/gi, '')
            .trim();
    };

    const cleanedSearch = cleanName(searchName);

    // 1. TAM EŞLEŞME
    for (let account of accountList) {
        if (cleanName(account.name) === cleanedSearch) {
            console.log(`✅ TAM EŞLEŞME (100%): "${searchName}" → "${account.name}"`);
            return { account: account, confidence: 100 };
        }
    }

    // 2. TAM İÇERME
    for (let account of accountList) {
        const accountName = cleanName(account.name);
        if (accountName.includes(cleanedSearch) || cleanedSearch.includes(accountName)) {
            console.log(`✅ TAM İÇERME (95%): "${searchName}" → "${account.name}"`);
            return { account: account, confidence: 95 };
        }
    }

    // 3. İLK KELİME EŞLEŞME
    const firstWord = cleanedSearch.split(/\s+/)[0];
    if (firstWord.length >= 4) {
        let matches = [];
        
        for (let account of accountList) {
            const accountFirstWord = cleanName(account.name).split(/\s+/)[0];
            if (firstWord === accountFirstWord) {
                matches.push(account);
            }
        }
        
        if (matches.length === 1) {
            console.log(`✅ İLK KELİME (90%): "${searchName}" → "${matches[0].name}"`);
            return { account: matches[0], confidence: 90 };
        }
    }

    // 4. ÇOK KELİMELİ EŞLEŞME
    const words = cleanedSearch.split(/\s+/).filter(w => w.length > 2).slice(0, 3);
    
    if (words.length >= 2) {
        let bestMatch = null;
        let bestScore = 0;
        
        for (let account of accountList) {
            const accountName = cleanName(account.name);
            let matchCount = 0;
            
            for (let word of words) {
                if (accountName.includes(word)) {
                    matchCount++;
                }
            }
            
            const score = matchCount / words.length;
            if (score >= 0.66 && score > bestScore) {
                bestScore = score;
                bestMatch = account;
            }
        }
        
        if (bestMatch) {
            const confidence = Math.round(bestScore * 85);
            console.log(`✅ ÇOK KELİMELİ (${confidence}%): "${searchName}" → "${bestMatch.name}"`);
            return { account: bestMatch, confidence: confidence };
        }
    }

    return { account: null, confidence: 0 };
}

function closeTransactionDetailsModal() {
    console.log('🔴 Modal kapatılıyor...');
    const modal = document.getElementById('transactionDetailsModal');
    
    if (modal) {
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.style.display = 'none';
            pendingTransactions = [];
            console.log('✅ Modal kapatıldı');
        }, 300);
    }
}

// ===============================
// CSV'den ödeme import işlemi
// ===============================
async function saveAllTransactions() {
    if (!window.pendingTransactions || window.pendingTransactions.length === 0) {
        alert('❌ Kaydedilecek işlem yok!');
        return;
    }
    if (!activeCompanyId) {
        alert('❌ Lütfen bir firma seçin!');
        return;
    }
    if (!auth.currentUser) {
        alert('❌ Lütfen giriş yapın!');
        return;
    }

    // Mevcut ödemelerin unique key dizisini oluştur
    const existingKeys = payments.map(getPaymentUniqueKey);
    const filteredTransactions = [];
    let skippedCount = 0;

    window.pendingTransactions.forEach(tx => {
        // Cari hesap zorunlu!
        const accountId = tx.accountId || tx.suggestedAccount?.id;
        if (!accountId) return;
        tx.accountId = accountId;

        const txKey = getPaymentUniqueKey(tx);
        if (existingKeys.includes(txKey)) {
            skippedCount++;
        } else {
            filteredTransactions.push(tx);
            existingKeys.push(txKey);
        }
    });

    if (filteredTransactions.length === 0) {
        alert(`⚠️ Tüm işlemler zaten kayıtlı, yeni ödeme eklenmedi.`);
        return;
    }

    // Firebase batch ile ekle
    const batch = db.batch();
    const now = new Date().toISOString();
    filteredTransactions.forEach(tx => {
        const paymentRef = db.collection('companies').doc(activeCompanyId)
            .collection('payments').doc();
        const paymentData = {
            id: paymentRef.id,
            companyId: activeCompanyId,
            date: tx.date,
            time: tx.time || "",
            accountId: tx.accountId,
            amount: Math.abs(tx.amount),
            type: tx.amount > 0 ? 'income' : 'expense',
            description: tx.description,
            referenceCode: tx.referenceCode || "",
            source: tx.source || 'bank',
            createdAt: now,
            createdBy: auth.currentUser.uid
        };
        batch.set(paymentRef, paymentData);
        payments.push(paymentData);
    });

    await batch.commit();
    await loadPayments();
    await loadAccounts();
    updateDashboard();

    alert(`✅ ${filteredTransactions.length} yeni ödeme eklendi\n⚠️ ${skippedCount} işlem zaten vardı, atlandı!`);
}

// ========================================
// CARİ HESAP KARTI MODAL
// ========================================

let currentAccountCardId = null;
let accountCardTransactions = [];

function viewAccountCard(accountId) {
    currentAccountCardId = accountId;
    const account = accounts.find(a => a.id === accountId);
    
    if (!account) {
        alert('❌ Cari hesap bulunamadı!');
        return;
    }

    // Modal başlığı ve bilgileri
    document.getElementById('accountCardTitle').innerHTML = `📊 Cari Hesap Kartı - ${account.name}`;
    document.getElementById('cardAccountName').textContent = account.name;
    document.getElementById('cardAccountType').innerHTML = `<span class="badge badge-${account.type === 'customer' ? 'success' : 'warning'}">${account.type === 'customer' ? 'Müşteri' : 'Tedarikçi'}</span>`;
    
    const balanceColor = account.balance >= 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('cardAccountBalance').innerHTML = `<span style="color: ${balanceColor}">${formatCurrency(account.balance)}</span>`;
    
    document.getElementById('cardAccountPhone').textContent = account.phone || '-';
    document.getElementById('cardAccountEmail').textContent = account.email || '-';
    document.getElementById('cardAccountTaxNo').textContent = account.taxNo || '-';

    // Yıl seçeneklerini doldur
    populateYearOptions();

    // Tüm işlemleri yükle
    loadAccountCardTransactions();

    // Modal'ı aç
    document.getElementById('accountCardModal').classList.add('active');
}

function closeAccountCardModal() {
    document.getElementById('accountCardModal').classList.remove('active');
    currentAccountCardId = null;
    accountCardTransactions = [];
}

function populateYearOptions() {
    const select = document.getElementById('cardFilterYear');
    select.innerHTML = '<option value="">Tüm Yıllar</option>';
    
    // Mevcut işlemlerden yılları çıkar
    const years = new Set();
    
    invoices.forEach(inv => {
        if (inv.accountId === currentAccountCardId) {
            const year = new Date(inv.date).getFullYear();
            years.add(year);
        }
    });
    
    payments.forEach(p => {
        if (p.accountId === currentAccountCardId) {
            const year = new Date(p.date).getFullYear();
            years.add(year);
        }
    });
    
    // Yılları sırala ve ekle
    Array.from(years).sort((a, b) => b - a).forEach(year => {
        const option = new Option(year, year);
        select.add(option);
    });
}

function loadAccountCardTransactions() {
    accountCardTransactions = [];
    
    // Faturaları ekle
    invoices.filter(inv => inv.accountId === currentAccountCardId).forEach(inv => {
        const company = companies.find(c => c.id === inv.companyId);
        accountCardTransactions.push({
            date: inv.date,
            type: 'invoice',
            subType: inv.type,
            reference: inv.invoiceNo,
            description: `${inv.type === 'sales' ? '📗 Satış' : '📕 Alış'} Faturası - ${company ? company.name : 'Bilinmiyor'}`,
            debit: inv.type === 'sales' ? inv.total : 0,
            credit: inv.type === 'purchase' ? inv.total : 0,
            invoiceId: inv.id,
            paymentId: null
        });
    });
    
    // Ödemeleri ekle
    payments.filter(p => p.accountId === currentAccountCardId).forEach(p => {
        const invoice = p.invoiceId ? invoices.find(inv => inv.id === p.invoiceId) : null;
        const company = companies.find(c => c.id === p.companyId);
        
        accountCardTransactions.push({
            date: p.date,
            type: 'payment',
            subType: p.type,
            reference: invoice ? invoice.invoiceNo : 'Genel Ödeme',
            description: `${p.type === 'income' ? '💰 Tahsilat' : '💸 Ödeme'} - ${p.description || (company ? company.name : 'Bilinmiyor')}`,
            debit: p.type === 'expense' ? p.amount : 0,
            credit: p.type === 'income' ? p.amount : 0,
            invoiceId: p.invoiceId,
            paymentId: p.id,
            source: p.source
        });
    });
    
    // Tarihe göre sırala
    accountCardTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // ⬇️ YENİ EKLEME: Gerçek bakiyeyi hesapla ve güncelle
    let calculatedBalance = 0;
    accountCardTransactions.forEach(t => {
        calculatedBalance += (t.debit - t.credit);
    });
    
    // Cari kart üstündeki bakiyeyi güncelle
    const account = accounts.find(a => a.id === currentAccountCardId);
    if (account) {
        const balanceColor = calculatedBalance >= 0 ? 'var(--success)' : 'var(--danger)';
        document.getElementById('cardAccountBalance').innerHTML = `<span style="color: ${balanceColor}">${formatCurrency(calculatedBalance)}</span>`;
        
        // ⚠️ BONUS: Eğer hesaplanan bakiye account.balance ile uyuşmuyorsa uyar
        if (Math.abs(calculatedBalance - account.balance) > 0.01) {
            console.warn(
                `⚠️ Bakiye uyuşmazlığı tespit edildi!\n` +
                `Cari: ${account.name}\n` +
                `Veritabanı bakiyesi: ${account.balance}\n` +
                `Hesaplanan bakiye: ${calculatedBalance}\n` +
                `Fark: ${calculatedBalance - account.balance}`
            );
        }
    }
    
    filterAccountCard();
}

// ========================================
// BAKİYE YENİDEN HESAPLAMA (SADECE BAKİYELERİ DÜZELTIR)
// ========================================
async function recalculateAccountBalances() {
    if (!confirm(
        '⚠️ Tüm cari hesapların bakiyelerini yeniden hesaplamak istediğinize emin misiniz?\n\n' +
        'Bu işlem:\n' +
        '✅ Fatura ve ödemelere göre bakiyeleri düzeltecektir\n' +
        '❌ Ödeme kayıtlarını değiştirmeyecektir\n\n' +
        'Devam etmek istiyor musunuz?'
    )) {
        return;
    }
    
    try {
        const batch = db.batch();
        let correctedCount = 0;
        
        for (const account of accounts) {
            console.log(`\n🔍 ${account.name} kontrol ediliyor...`);
            
            // Bu cariye ait faturaları topla
            let calculatedBalance = 0;
            
            // 1. Faturalardan hesapla
            const accountInvoices = invoices.filter(inv => 
                inv.accountId === account.id && 
                inv.status !== 'deleted' && 
                inv.status !== 'passive'
            );
            
            accountInvoices.forEach(inv => {
                const unpaidAmount = inv.total - (inv.paidAmount || 0);
                if (inv.type === 'sales') {
                    calculatedBalance += unpaidAmount; // Müşteri borcu
                    console.log(`  📗 Satış: ${inv.invoiceNo} → +${formatCurrency(unpaidAmount)}`);
                } else {
                    calculatedBalance -= unpaidAmount; // Tedarikçi alacağı
                    console.log(`  📕 Alış: ${inv.invoiceNo} → -${formatCurrency(unpaidAmount)}`);
                }
            });
            
            // 2. Faturasız ödemeleri ekle (genel ödemeler)
            const accountPayments = payments.filter(p => 
                p.accountId === account.id && 
                !p.invoiceId && // Sadece faturasız ödemeler
                p.status !== 'deleted'
            );
            
            accountPayments.forEach(p => {
                if (p.type === 'income') {
                    calculatedBalance -= p.amount; // Tahsilat (borç azalır)
                    console.log(`  💰 Tahsilat: ${p.description} → -${formatCurrency(p.amount)}`);
                } else {
                    calculatedBalance += p.amount; // Ödeme (alacak azalır)
                    console.log(`  💸 Ödeme: ${p.description} → +${formatCurrency(p.amount)}`);
                }
            });
            
            console.log(`  📊 Hesaplanan: ${formatCurrency(calculatedBalance)}`);
            console.log(`  💾 Mevcut: ${formatCurrency(account.balance)}`);
            
            // Eğer fark varsa düzelt
            if (Math.abs(calculatedBalance - account.balance) > 0.01) {
                console.log(`  🔧 DÜZELTME GEREKİYOR!`);
                
                const accountRef = db.collection('companies')
                    .doc(activeCompanyId)
                    .collection('accounts')
                    .doc(account.id);
                
                batch.update(accountRef, { balance: calculatedBalance });
                account.balance = calculatedBalance;
                correctedCount++;
            } else {
                console.log(`  ✅ Bakiye doğru`);
            }
        }
        
        if (correctedCount > 0) {
            await batch.commit();
            await loadAccounts();
            
            // Eğer cari kartı açıksa yenile
            if (currentAccountCardId) {
                loadAccountCardTransactions();
                filterAccountCard();
            }
            
            updateDashboard();
            alert(`✅ ${correctedCount} cari hesabın bakiyesi düzeltildi!`);
        } else {
            alert('✅ Tüm bakiyeler doğru, düzeltme yapılmadı.');
        }
        
    } catch (error) {
        console.error('Bakiye düzeltme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

function filterAccountCard() {
    const year = document.getElementById('cardFilterYear').value;
    const startDate = document.getElementById('cardFilterStartDate').value;
    const endDate = document.getElementById('cardFilterEndDate').value;
    const filterType = document.getElementById('cardFilterType').value;
    
    let filtered = [...accountCardTransactions];
    
    // Yıl filtresi
    if (year) {
        filtered = filtered.filter(t => new Date(t.date).getFullYear().toString() === year);
    }
    
    // Tarih aralığı filtresi
    if (startDate) {
        filtered = filtered.filter(t => t.date >= startDate);
    }
    if (endDate) {
        filtered = filtered.filter(t => t.date <= endDate);
    }
    
    // İşlem tipi filtresi
    if (filterType === 'invoice') {
        filtered = filtered.filter(t => t.type === 'invoice');
    } else if (filterType === 'payment') {
        filtered = filtered.filter(t => t.type === 'payment');
    } else if (filterType === 'income') {
        filtered = filtered.filter(t => t.credit > 0);
    } else if (filterType === 'expense') {
        filtered = filtered.filter(t => t.debit > 0);
    }
    
    renderAccountCardTable(filtered);
    updateAccountCardStats(filtered);
}

function renderAccountCardTable(transactions) {
    const tbody = document.querySelector('#accountCardTable tbody');
    tbody.innerHTML = '';
    
    if (transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#6b7280;">Bu filtreye uygun işlem bulunamadı.</td></tr>';
        return;
    }
    
    let balance = 0;
    
    transactions.forEach(t => {
        balance += (t.debit - t.credit);
        
        // Tip badge'i
        let typeBadge = '';
        if (t.type === 'invoice') {
            typeBadge = `<span class="badge badge-${t.subType === 'sales' ? 'success' : 'warning'}">Fatura</span>`;
        } else {
            typeBadge = `<span class="badge badge-${t.subType === 'income' ? 'success' : 'danger'}">Ödeme</span>`;
            if (t.source === 'bank') {
                typeBadge += ' <span class="badge badge-info" style="font-size:0.8em;">Banka</span>';
            }
        }
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${formatDate(t.date)}</td>
            <td>${typeBadge}</td>
            <td><strong>${t.reference}</strong></td>
            <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${t.description}</td>
            <td style="color: var(--danger); font-weight: 600;">${t.debit > 0 ? formatCurrency(t.debit) : '-'}</td>
            <td style="color: var(--success); font-weight: 600;">${t.credit > 0 ? formatCurrency(t.credit) : '-'}</td>
            <td style="font-weight: 700; color: ${balance >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(balance)}</td>
            <td>
                ${t.invoiceId ? `<button class="btn btn-info btn-sm" onclick="viewInvoice('${t.invoiceId}')" title="Faturayı Görüntüle">👁️</button>` : ''}
                ${t.paymentId ? `
                    <button class="btn btn-warning btn-sm" onclick="editPayment('${t.paymentId}')" title="Ödeme Düzenle">✏️</button>
                ` : ''}
            </td>
        `;
    });
}

function updateAccountCardStats(transactions) {
    let totalIncome = 0;
    let totalExpense = 0;
    let totalInvoices = 0;
    let incomeCount = 0;
    let expenseCount = 0;
    let invoiceCount = 0;
    
    transactions.forEach(t => {
        if (t.credit > 0) {
            totalIncome += t.credit;
            incomeCount++;
        }
        if (t.debit > 0) {
            totalExpense += t.debit;
            expenseCount++;
        }
        if (t.type === 'invoice') {
            totalInvoices += (t.debit || t.credit);
            invoiceCount++;
        }
    });
    
    const netBalance = totalIncome - totalExpense;
    
    document.getElementById('cardTotalIncome').textContent = formatCurrency(totalIncome);
    document.getElementById('cardIncomeCount').textContent = `${incomeCount} işlem`;
    
    document.getElementById('cardTotalExpense').textContent = formatCurrency(totalExpense);
    document.getElementById('cardExpenseCount').textContent = `${expenseCount} işlem`;
    
    document.getElementById('cardTotalInvoices').textContent = formatCurrency(totalInvoices);
    document.getElementById('cardInvoiceCount').textContent = `${invoiceCount} fatura`;
    
    const netBalanceColor = netBalance >= 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('cardNetBalance').innerHTML = `<span style="color: ${netBalanceColor}">${formatCurrency(netBalance)}</span>`;
}

function clearAccountCardFilters() {
    document.getElementById('cardFilterYear').value = '';
    document.getElementById('cardFilterStartDate').value = '';
    document.getElementById('cardFilterEndDate').value = '';
    document.getElementById('cardFilterType').value = '';
    filterAccountCard();
}

function viewPaymentDetail(paymentId) {
    const payment = payments.find(p => p.id === paymentId);
    if (!payment) {
        alert('❌ Ödeme kaydı bulunamadı!');
        return;
    }
    
    const account = accounts.find(a => a.id === payment.accountId);
    const invoice = payment.invoiceId ? invoices.find(inv => inv.id === payment.invoiceId) : null;
    const company = companies.find(c => c.id === payment.companyId);
    
    const details = `
📋 ÖDEME DETAYI

Tarih: ${formatDate(payment.date)}
Cari: ${account ? account.name : 'Bilinmiyor'}
Firma: ${company ? company.name : 'Bilinmiyor'}
Tutar: ${formatCurrency(payment.amount)}
Tip: ${payment.type === 'income' ? '💰 Tahsilat (Gelen)' : '💸 Ödeme (Giden)'}
${invoice ? `Fatura: ${invoice.invoiceNo}` : 'Fatura: Genel Ödeme'}
Kaynak: ${payment.source === 'manual' ? '✍️ Manuel' : '🏦 Banka'}
Açıklama: ${payment.description || '-'}
Kayıt Tarihi: ${new Date(payment.createdAt).toLocaleString('tr-TR')}
    `;
    
    alert(details);
}

function exportAccountCard() {
    const account = accounts.find(a => a.id === currentAccountCardId);
    if (!account) return;
    
    const year = document.getElementById('cardFilterYear').value;
    const startDate = document.getElementById('cardFilterStartDate').value;
    const endDate = document.getElementById('cardFilterEndDate').value;
    
    // Filtered transactions al
    let filtered = [...accountCardTransactions];
    
    if (year) {
        filtered = filtered.filter(t => new Date(t.date).getFullYear().toString() === year);
    }
    if (startDate) {
        filtered = filtered.filter(t => t.date >= startDate);
    }
    if (endDate) {
        filtered = filtered.filter(t => t.date <= endDate);
    }
    
    // CSV oluştur
    let csv = 'Tarih,İşlem Tipi,Referans,Açıklama,Borç,Alacak,Bakiye\n';
    
    let balance = 0;
    filtered.forEach(t => {
        balance += (t.debit - t.credit);
        
        const typeText = t.type === 'invoice' ? 'Fatura' : 'Ödeme';
        const debitText = t.debit > 0 ? t.debit.toFixed(2) : '';
        const creditText = t.credit > 0 ? t.credit.toFixed(2) : '';
        
        csv += `${t.date},${typeText},${t.reference},"${t.description.replace(/"/g, '""')}",${debitText},${creditText},${balance.toFixed(2)}\n`;
    });
    
    // Download
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `cari-hesap-${account.name}-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    
    alert('✅ Cari hesap kartı Excel\'e aktarıldı!');
}

// ========================================
// FİRMA DÖKÜMAN YÖNETİMİ
// ========================================

function addCompanyDocument() {
    const docId = Date.now() + Math.random();
    
    companyDocuments.push({
        id: docId,
        name: '',
        file: null,
        fileName: '',
        fileSize: 0,
        fileType: '',
        uploadDate: new Date().toISOString()
    });
    
    renderCompanyDocuments();
}

function renderCompanyDocuments() {
    const container = document.getElementById('companyDocumentsList');
    container.innerHTML = '';
    
    if (companyDocuments.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; font-style: italic;">Henüz döküman eklenmedi.</p>';
        return;
    }
    
    companyDocuments.forEach((doc, index) => {
        const div = document.createElement('div');
        div.style.cssText = 'border: 2px solid #e5e7eb; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f9fafb;';
        
        div.innerHTML = `
            <div class="grid-2" style="align-items: end;">
                <div class="form-group" style="margin: 0;">
                    <label>Döküman Adı</label>
                    <input type="text" 
                           value="${doc.name}" 
                           onchange="updateCompanyDocName(${index}, this.value)" 
                           placeholder="Örn: Ticaret Sicil Gazetesi"
                           style="margin: 0;">
                </div>
                <div class="form-group" style="margin: 0;">
                    <label>Dosya Seç</label>
                    <input type="file" 
                           onchange="handleCompanyDocFile(${index}, this.files[0])"
                           accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                           style="margin: 0;">
                </div>
            </div>
            ${doc.fileName ? `
                <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 0.9em;">
                    📄 <strong>${doc.fileName}</strong> 
                    (${formatFileSize(doc.fileSize)})
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeCompanyDocument(${index})" style="float: right;">
                        🗑️ Kaldır
                    </button>
                </div>
            ` : ''}
        `;
        
        container.appendChild(div);
    });
}

function updateCompanyDocName(index, name) {
    companyDocuments[index].name = name;
}

function handleCompanyDocFile(index, file) {
    if (!file) return;
    
    // Dosya boyut kontrolü (max 10MB per file)
    if (file.size > 10 * 1024 * 1024) {
        alert('⚠️ Dosya boyutu 10 MB\'dan küçük olmalıdır!');
        return;
    }
    
    // Dosya tipini kontrol et
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg', 
                          'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    
    if (!allowedTypes.includes(file.type)) {
        alert('⚠️ Sadece PDF, JPG, PNG, DOC, DOCX dosyaları yüklenebilir!');
        return;
    }
    
    // FileReader ile base64'e çevir
    const reader = new FileReader();
    reader.onload = function(e) {
        companyDocuments[index].file = e.target.result; // base64
        companyDocuments[index].fileName = file.name;
        companyDocuments[index].fileSize = file.size;
        companyDocuments[index].fileType = file.type;
        
        renderCompanyDocuments();
    };
    reader.readAsDataURL(file);
}

function removeCompanyDocument(index) {
    if (confirm('Bu dökümanı kaldırmak istediğinizden emin misiniz?')) {
        companyDocuments.splice(index, 1);
        renderCompanyDocuments();
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// ========================================
// CARİ DÖKÜMAN YÖNETİMİ
// ========================================

function addAccountDocument() {
    if (accountDocuments.length >= MAX_ACCOUNT_DOCS) {
        alert('⚠️ Maksimum 5 döküman ekleyebilirsiniz!');
        return;
    }
    
    const totalSize = accountDocuments.reduce((sum, doc) => sum + doc.fileSize, 0);
    if (totalSize >= MAX_ACCOUNT_SIZE) {
        alert('⚠️ Toplam döküman boyutu 3 MB\'ı aşamaz!');
        return;
    }
    
    const docId = Date.now() + Math.random();
    
    accountDocuments.push({
        id: docId,
        name: '',
        file: null,
        fileName: '',
        fileSize: 0,
        fileType: '',
        uploadDate: new Date().toISOString()
    });
    
    renderAccountDocuments();
}

function renderAccountDocuments() {
    const container = document.getElementById('accountDocumentsList');
    container.innerHTML = '';
    
    if (accountDocuments.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; font-style: italic;">Henüz döküman eklenmedi.</p>';
    } else {
        accountDocuments.forEach((doc, index) => {
            const div = document.createElement('div');
            div.style.cssText = 'border: 2px solid #e5e7eb; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f9fafb;';
            
            div.innerHTML = `
                <div class="grid-2" style="align-items: end;">
                    <div class="form-group" style="margin: 0;">
                        <label>Döküman Adı</label>
                        <input type="text" 
                               value="${doc.name}" 
                               onchange="updateAccountDocName(${index}, this.value)" 
                               placeholder="Örn: Sözleşme"
                               style="margin: 0;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Dosya Seç</label>
                        <input type="file" 
                               onchange="handleAccountDocFile(${index}, this.files[0])"
                               accept=".pdf,.jpg,.jpeg,.png"
                               style="margin: 0;">
                    </div>
                </div>
                ${doc.fileName ? `
                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 0.9em;">
                        📄 <strong>${doc.fileName}</strong> 
                        (${formatFileSize(doc.fileSize)})
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeAccountDocument(${index})" style="float: right;">
                            🗑️ Kaldır
                        </button>
                    </div>
                ` : ''}
            `;
            
            container.appendChild(div);
        });
    }
    
    // Buton güncelle
    const totalSize = accountDocuments.reduce((sum, doc) => sum + doc.fileSize, 0);
    document.getElementById('addAccountDocBtn').textContent = `➕ Döküman Ekle (${accountDocuments.length}/${MAX_ACCOUNT_DOCS})`;
    document.getElementById('addAccountDocBtn').disabled = accountDocuments.length >= MAX_ACCOUNT_DOCS || totalSize >= MAX_ACCOUNT_SIZE;
    document.getElementById('accountDocSize').textContent = formatFileSize(totalSize);
    
    // Boyut uyarısı
    const sizeInfo = document.getElementById('accountDocSizeInfo');
    if (totalSize > MAX_ACCOUNT_SIZE * 0.9) {
        sizeInfo.style.color = 'var(--danger)';
    } else if (totalSize > MAX_ACCOUNT_SIZE * 0.7) {
        sizeInfo.style.color = 'var(--warning)';
    } else {
        sizeInfo.style.color = '#6b7280';
    }
}

function updateAccountDocName(index, name) {
    accountDocuments[index].name = name;
}

function handleAccountDocFile(index, file) {
    if (!file) return;
    
    // Mevcut toplam boyut
    const currentTotalSize = accountDocuments.reduce((sum, doc, idx) => {
        return idx === index ? sum : sum + doc.fileSize;
    }, 0);
    
    // Yeni dosya ile birlikte toplam boyut kontrolü
    if (currentTotalSize + file.size > MAX_ACCOUNT_SIZE) {
        alert(`⚠️ Toplam döküman boyutu ${formatFileSize(MAX_ACCOUNT_SIZE)} sınırını aşıyor!\n\nMevcut: ${formatFileSize(currentTotalSize)}\nYeni dosya: ${formatFileSize(file.size)}`);
        return;
    }
    
    // Dosya boyut kontrolü (max 2MB per file)
    if (file.size > 2 * 1024 * 1024) {
        alert('⚠️ Tek dosya boyutu 2 MB\'dan küçük olmalıdır!');
        return;
    }
    
    // Dosya tipini kontrol et (sadece PDF ve resim)
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg'];
    
    if (!allowedTypes.includes(file.type)) {
        alert('⚠️ Sadece PDF, JPG, PNG dosyaları yüklenebilir!');
        return;
    }
    
    // FileReader ile base64'e çevir
    const reader = new FileReader();
    reader.onload = function(e) {
        accountDocuments[index].file = e.target.result; // base64
        accountDocuments[index].fileName = file.name;
        accountDocuments[index].fileSize = file.size;
        accountDocuments[index].fileType = file.type;
        
        renderAccountDocuments();
    };
    reader.readAsDataURL(file);
}

function removeAccountDocument(index) {
    if (confirm('Bu dökümanı kaldırmak istediğinizden emin misiniz?')) {
        accountDocuments.splice(index, 1);
        renderAccountDocuments();
    }
}

// ========================================
// DÖKÜMAN GÖRÜNTÜLEME
// ========================================

let currentDocuments = [];
let currentDocumentData = null;

function viewCompanyDocuments(companyId) {
    const company = companies.find(c => c.id === companyId);
    if (!company || !company.documents || company.documents.length === 0) {
        alert('❌ Bu firmaya ait döküman bulunamadı!');
        return;
    }
    
    currentDocuments = company.documents;
    
    document.getElementById('documentsModalTitle').textContent = `📎 ${company.name} - Dökümanlar`;
    
    renderDocumentsList();
    
    document.getElementById('documentsModal').classList.add('active');
}

function viewAccountDocuments(accountId) {
    const account = accounts.find(a => a.id === accountId);
    if (!account || !account.documents || account.documents.length === 0) {
        alert('❌ Bu cari hesaba ait döküman bulunamadı!');
        return;
    }
    
    currentDocuments = account.documents;
    
    document.getElementById('documentsModalTitle').textContent = `📎 ${account.name} - Dökümanlar`;
    
    renderDocumentsList();
    
    document.getElementById('documentsModal').classList.add('active');
}

function renderDocumentsList() {
    const container = document.getElementById('documentsListView');
    container.innerHTML = '';
    
    if (currentDocuments.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#6b7280;">Döküman bulunamadı.</p>';
        return;
    }
    
    currentDocuments.forEach((doc, index) => {
        const card = document.createElement('div');
        card.style.cssText = `
            border: 2px solid #e5e7eb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        `;
        
        card.onmouseover = function() {
            this.style.borderColor = '#2563eb';
            this.style.boxShadow = '0 4px 12px rgba(37, 99, 235, 0.2)';
        };
        
        card.onmouseout = function() {
            this.style.borderColor = '#e5e7eb';
            this.style.boxShadow = 'none';
        };
        
        const fileIcon = getFileIcon(doc.fileType);
        const uploadDate = new Date(doc.uploadDate).toLocaleDateString('tr-TR');
        
        card.innerHTML = `
            <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 2.5em;">${fileIcon}</div>
                    <div>
                        <h4 style="margin: 0; color: var(--primary);">${doc.name || 'İsimsiz Döküman'}</h4>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">
                            📄 ${doc.fileName} • ${formatFileSize(doc.fileSize)} • ${uploadDate}
                        </p>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-info btn-sm" onclick="viewDocument(${index})" title="Görüntüle">
                    👁️ Görüntüle
                </button>
                <button class="btn btn-success btn-sm" onclick="downloadDocument(${index})" title="İndir">
                    📥 İndir
                </button>
            </div>
        `;
        
        container.appendChild(card);
    });
}

function getFileIcon(fileType) {
    if (fileType.includes('pdf')) return '📕';
    if (fileType.includes('image')) return '🖼️';
    if (fileType.includes('word') || fileType.includes('doc')) return '📄';
    return '📎';
}

function viewDocument(index) {
    const doc = currentDocuments[index];
    currentDocumentData = doc;
    
    document.getElementById('documentViewerTitle').textContent = `📄 ${doc.name}`;
    
    const content = document.getElementById('documentViewerContent');
    content.innerHTML = '';
    
    if (doc.fileType.includes('image')) {
        // Resim göster
        const img = document.createElement('img');
        img.src = doc.file;
        img.style.maxWidth = '100%';
        img.style.borderRadius = '8px';
        img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        content.appendChild(img);
    } else if (doc.fileType.includes('pdf')) {
        // PDF göster
        const iframe = document.createElement('iframe');
        iframe.src = doc.file;
        iframe.style.width = '100%';
        iframe.style.height = '600px';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        content.appendChild(iframe);
    } else {
        // Diğer dosya tipleri için download butonu
        content.innerHTML = `
            <div style="padding: 40px; text-align: center;">
                <div style="font-size: 4em; margin-bottom: 20px;">📄</div>
                <h3>${doc.fileName}</h3>
                <p style="color: #6b7280; margin: 20px 0;">Bu dosya türü önizlenemez.</p>
                <button class="btn btn-success" onclick="downloadDocument(${index})">
                    📥 Dosyayı İndir
                </button>
            </div>
        `;
    }
    
    document.getElementById('documentViewerModal').classList.add('active');
}

function downloadDocument(index) {
    const doc = currentDocuments[index];
    
    // Base64'ten blob oluştur
    const byteString = atob(doc.file.split(',')[1]);
    const mimeString = doc.file.split(',')[0].split(':')[1].split(';')[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    
    const blob = new Blob([ab], { type: mimeString });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = doc.fileName;
    link.click();
    
    URL.revokeObjectURL(url);
}

function downloadCurrentDocument() {
    if (currentDocumentData) {
        const index = currentDocuments.indexOf(currentDocumentData);
        downloadDocument(index);
    }
}

function closeDocumentsModal() {
    document.getElementById('documentsModal').classList.remove('active');
    currentDocuments = [];
}

function closeDocumentViewer() {
    document.getElementById('documentViewerModal').classList.remove('active');
    currentDocumentData = null;
}

// ========================================
// FİRMA DETAY MODAL
// ========================================

let currentDetailCompanyId = null;

function viewCompanyDetail(companyId) {
    const company = companies.find(c => c.id === companyId);
    
    if (!company) {
        alert('❌ Firma bulunamadı!');
        return;
    }
    
    currentDetailCompanyId = companyId;
    
    // Başlık
    document.getElementById('companyDetailTitle').textContent = `🏢 ${company.name}`;
    
    // Temel Bilgiler
    document.getElementById('detailCompanyName').textContent = company.name;
    document.getElementById('detailCompanySector').textContent = company.sector || 'Sektör belirtilmemiş';
    document.getElementById('detailCompanyNameFull').textContent = company.name;
    document.getElementById('detailCompanySectorFull').innerHTML = company.sector 
        ? `<span class="badge badge-info" style="font-size: 1em;">${company.sector}</span>` 
        : '<span style="color: #6b7280;">Belirtilmemiş</span>';
    
    // Vergi Bilgileri
    document.getElementById('detailCompanyTaxNo').textContent = company.taxNo || '-';
    document.getElementById('detailCompanyTaxOffice').textContent = company.taxOffice || '-';
    
    // İletişim Bilgileri
    document.getElementById('detailCompanyPhone').textContent = company.phone || '-';
    
    const emailEl = document.getElementById('detailCompanyEmail');
    if (company.email) {
        emailEl.innerHTML = `<a href="mailto:${company.email}" style="color: var(--primary);">${company.email}</a>`;
    } else {
        emailEl.textContent = '-';
    }
    
    const websiteEl = document.getElementById('detailCompanyWebsite');
    if (company.website) {
        websiteEl.innerHTML = `<a href="${company.website}" target="_blank" style="color: var(--primary);">${company.website}</a>`;
    } else {
        websiteEl.textContent = '-';
    }
    
    document.getElementById('detailCompanyAddress').textContent = company.address || '-';
    
    // Dökümanlar
    if (company.documents && company.documents.length > 0) {
        document.getElementById('detailCompanyDocumentsCard').style.display = 'block';
        document.getElementById('detailViewDocsBtn').style.display = 'inline-block';
        
        const docsContainer = document.getElementById('detailCompanyDocuments');
        docsContainer.innerHTML = '';
        
        company.documents.forEach((doc, index) => {
            const docDiv = document.createElement('div');
            docDiv.style.cssText = 'display: flex; align-items: center; padding: 12px; background: white; border-radius: 6px; margin-bottom: 10px; border: 1px solid #e5e7eb;';
            
            const fileIcon = getFileIcon(doc.fileType);
            
            docDiv.innerHTML = `
                <div style="font-size: 2em; margin-right: 15px;">${fileIcon}</div>
                <div style="flex: 1;">
                    <strong>${doc.name || 'İsimsiz Döküman'}</strong>
                    <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        ${doc.fileName} • ${formatFileSize(doc.fileSize)}
                    </p>
                </div>
                <span class="badge badge-info">${index + 1}</span>
            `;
            
            docsContainer.appendChild(docDiv);
        });
    } else {
        document.getElementById('detailCompanyDocumentsCard').style.display = 'none';
        document.getElementById('detailViewDocsBtn').style.display = 'none';
    }
    
    // Kayıt Logları
    if (company.createdAt) {
        const createdDate = new Date(company.createdAt).toLocaleString('tr-TR');
        const createdBy = company.createdBy || 'Bilinmiyor';
        document.getElementById('detailCompanyCreated').innerHTML = `
            <span style="color: var(--success); font-weight: 600;">${createdDate}</span><br>
            <span style="font-size: 0.9em; color: #6b7280;">Oluşturan: ${createdBy}</span>
        `;
    } else {
        document.getElementById('detailCompanyCreated').textContent = '-';
    }
    
    if (company.updatedAt && company.updatedAt !== company.createdAt) {
        const updatedDate = new Date(company.updatedAt).toLocaleString('tr-TR');
        const updatedBy = company.updatedBy || 'Bilinmiyor';
        document.getElementById('detailCompanyUpdated').innerHTML = `
            <span style="color: var(--warning); font-weight: 600;">${updatedDate}</span><br>
            <span style="font-size: 0.9em; color: #6b7280;">Güncelleyen: ${updatedBy}</span>
        `;
    } else {
        document.getElementById('detailCompanyUpdated').innerHTML = '<span style="color: #6b7280;">Güncelleme yapılmamış</span>';
    }
    
    // Cari Hesap Sayısı
    const companyAccounts = accounts.filter(a => a.companyId === companyId);
    document.getElementById('detailAccountCount').textContent = companyAccounts.length;
    
    // Finansal Özet
    calculateCompanyFinancials(companyId);
    
    // Cari Hesaplar Listesi
    renderCompanyAccountsList(companyAccounts);
    
    // Modal'ı aç
    document.getElementById('companyDetailModal').classList.add('active');
}

function calculateCompanyFinancials(companyId) {
    const companyInvoices = invoices.filter(inv => inv.companyId === companyId);
    const companyPayments = payments.filter(p => p.companyId === companyId);
    
    const salesInvoices = companyInvoices.filter(inv => inv.type === 'sales');
    const purchaseInvoices = companyInvoices.filter(inv => inv.type === 'purchase');
    
    const totalIncome = salesInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
    const totalExpense = purchaseInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
    const netProfit = totalIncome - totalExpense;
    
    const totalPaymentsAmount = companyPayments.reduce((sum, p) => sum + p.amount, 0);
    
    document.getElementById('detailTotalIncome').textContent = formatCurrency(totalIncome);
    document.getElementById('detailIncomeInvoices').textContent = `${salesInvoices.length} fatura`;
    
    document.getElementById('detailTotalExpense').textContent = formatCurrency(totalExpense);
    document.getElementById('detailExpenseInvoices').textContent = `${purchaseInvoices.length} fatura`;
    
    const netProfitEl = document.getElementById('detailNetProfit');
    netProfitEl.textContent = formatCurrency(netProfit);
    netProfitEl.style.color = netProfit >= 0 ? 'var(--success)' : 'var(--danger)';
    
    document.getElementById('detailTotalPayments').textContent = formatCurrency(totalPaymentsAmount);
    document.getElementById('detailPaymentCount').textContent = `${companyPayments.length} ödeme`;
}

function renderCompanyAccountsList(companyAccounts) {
    const container = document.getElementById('detailCompanyAccountsList');
    
    if (companyAccounts.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Bu firmaya ait cari hesap bulunmuyor.</p>';
        return;
    }
    
    container.innerHTML = '';
    
    companyAccounts.forEach(account => {
        const accountDiv = document.createElement('div');
        accountDiv.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.3s;
        `;
        
        accountDiv.onmouseover = function() {
            this.style.borderColor = '#2563eb';
            this.style.boxShadow = '0 4px 12px rgba(37, 99, 235, 0.2)';
        };
        
        accountDiv.onmouseout = function() {
            this.style.borderColor = '#e5e7eb';
            this.style.boxShadow = 'none';
        };
        
const typeText = account.type === 'customer'
    ? 'Müşteri'
    : account.type === 'supplier'
    ? 'Tedarikçi'
    : 'Personel';

const typeBadge = account.type === 'customer'
    ? 'success'
    : account.type === 'supplier'
    ? 'warning'
    : 'info';

        const balanceColor = account.balance >= 0 ? 'var(--success)' : 'var(--danger)';
        
        accountDiv.innerHTML = `
            <div style="flex: 1;">
                <h4 style="margin: 0 0 5px 0; color: var(--primary);">${account.name}</h4>
                <div style="display: flex; gap: 10px; font-size: 0.9em; color: #6b7280;">
                    <span class="badge badge-${typeBadge}">${typeText}</span>
                    ${account.phone ? `<span>📱 ${account.phone}</span>` : ''}
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 1.5em; font-weight: 700; color: ${balanceColor}; margin-bottom: 5px;">
                    ${formatCurrency(account.balance)}
                </div>
                <button class="btn btn-info btn-sm" onclick="viewAccountCardFromCompanyDetail('${account.id}')">
                    📊 Hesap Kartı
                </button>
            </div>
        `;
        
        container.appendChild(accountDiv);
    });
}

function editCompanyFromDetail() {
    closeCompanyDetailModal();
    showTab('companies');
    document.querySelector('.tab[onclick*="companies"]').click();
    setTimeout(() => {
        editCompany(currentDetailCompanyId);
    }, 300);
}

function viewCompanyAccountsFromDetail() {
    closeCompanyDetailModal();
    viewCompanyAccounts(currentDetailCompanyId);
}

function viewCompanyDocumentsFromDetail() {
    viewCompanyDocuments(currentDetailCompanyId);
}

function viewAccountCardFromCompanyDetail(accountId) {
    viewAccountCard(accountId);
}

function closeCompanyDetailModal() {
    document.getElementById('companyDetailModal').classList.remove('active');
    currentDetailCompanyId = null;
}

// ========================================
// E-FATURA İMPORT SİSTEMİ
// ========================================

// MODAL AÇMA - HER SEFERİNDE TEMİZLENİR
function openImportInvoiceModal() {
    // Eski modal varsa kapat ve inputu sıfırla
    closeImportInvoiceModal();

    if (!activeCompanyId) {
        alert('⚠️ Lütfen önce bir firma seçin!');
        return;
    }
    document.getElementById('importInvoiceModal').classList.add('active');
    // Dosya inputunu sıfırla
    const input = document.getElementById('invoiceExcelFile');
    if (input) input.value = '';
}

// MODAL KAPATMA - HER SEFERİNDE TEMİZLENİR
function closeImportInvoiceModal() {
    const modal = document.getElementById('importInvoiceModal');
    if (modal) modal.classList.remove('active');
    const input = document.getElementById('invoiceExcelFile');
    if (input) input.value = '';
}

function updateInvoiceTypeSelection() {
    const selectedType = document.querySelector('input[name="invoiceImportType"]:checked').value;
    currentInvoiceType = selectedType;
    console.log('Fatura türü seçildi:', selectedType === 'sales' ? 'Giden (Satış)' : 'Gelen (Alış)');
}

function handleInvoiceExcelDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        processInvoiceFile(files[0]);
    }
}

// Dosya Yükleme Handler
function importInvoiceExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    processInvoiceFile(file);
}

async function processInvoiceFile(file) {
    if (!file) { alert("Dosya seçilmedi!"); return; }
    try {
        await saveImportedFileToStorage(file, "invoices");
        await loadInvoices(); // Import öncesi güncel veri!
    } catch (err) {
        console.error("Fatura dosya kaydedilemedi:", err);
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            parseEInvoiceCSV(e.target.result); // Modal açma parse fonksiyonu içinde zaten var!
        } catch (err) {
            console.error("Fatura dosya parse hatası:", err);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

// Dosya inputu resetlemek için (drag-drop veya tekrar yüklemede)
function resetInvoiceExcelInput() {
    const input = document.getElementById('invoiceExcelFile');
    if (input) input.value = '';
}

function parseEInvoiceCSV(content) {
    console.log('📊 E-Fatura CSV Parse başlıyor...');

    // Satır sonlarını normalize et
    content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);

    console.log('Toplam satır:', lines.length);
    console.log('İlk satır (header):', lines[0]);

    // Delimiter algıla
    let delimiter = ';';
    if (lines[0].includes(',')) delimiter = ',';

    // Header kontrolü
    const header = lines[0].toLowerCase();
    if (!header.includes('fatura') || !header.includes('tutar')) {
        alert('⚠️ Bu dosya E-Fatura formatında görünmüyor!\n\nBeklenen sütunlar: Alıcı Adı, Fatura Numarası, Fatura Tarihi, Tutar');
        return;
    }

    parsedInvoices = [];

    // Satırları parse et (Header'ı atla)
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        const parts = line.split(delimiter);
        console.log(`Satır ${i}:`, parts);

        if (parts.length < 7) {
            console.log(`⚠️ Satır ${i} atlandı: Yeterli sütun yok (${parts.length})`);
            continue;
        }

        const aliciAdi = parts[0]?.trim() || '';
        const faturaNo = parts[1]?.trim() || '';
        const faturaTarihi = parts[2]?.trim() || '';
        const olusturmaTarihi = parts[3]?.trim() || '';
        const senaryo = parts[4]?.trim() || '';
        const durum = parts[5]?.trim() || '';
        const tutarStr = parts[6]?.trim() || '';

        // Tutar parse (Türkçe format: 10737,6)
        const tutar = parseTurkishNumber(tutarStr);

        if (!aliciAdi || !faturaNo || !faturaTarihi || tutar === 0) {
            console.log(`⚠️ Satır ${i} atlandı: Eksik veri`);
            continue;
        }

        const standardDate = parseEInvoiceDate(faturaTarihi);

        if (!standardDate) {
            console.log(`⚠️ Satır ${i} atlandı: Geçersiz tarih formatı`);
            continue;
        }

        // Cari hesap eşleştirme
        const matchedAccount = findMatchingAccount(aliciAdi);

        parsedInvoices.push({
            aliciAdi: aliciAdi,
            faturaNo: faturaNo,
            faturaTarihi: standardDate,
            olusturmaTarihi: parseEInvoiceDate(olusturmaTarihi),
            senaryo: senaryo,
            durum: durum,
            tutar: tutar,
            matchedAccount: matchedAccount,
            confidence: matchedAccount ? calculateMatchConfidence(aliciAdi, matchedAccount) : 0
        });

        console.log(`✅ Fatura ${i} parse edildi:`, parsedInvoices[parsedInvoices.length - 1]);
    }

    console.log(`\n📊 Toplam ${parsedInvoices.length} fatura başarıyla okundu!`);

    if (parsedInvoices.length === 0) {
        alert('❌ Dosyada geçerli fatura bulunamadı!');
        return;
    }

    // Eşleştirme modal'ını aç
    closeImportInvoiceModal();
    showInvoiceMatchModal();
}

function parseEInvoiceDate(dateStr) {
    // Format: 30.09.2025 veya 19.09.2025
    const match = dateStr.match(/(\d{1,2})\.(\d{1,2})\.(\d{4})/);
    
    if (match) {
        const day = match[1].padStart(2, '0');
        const month = match[2].padStart(2, '0');
        const year = match[3];
        return `${year}-${month}-${day}`;
    }
    
    return null;
}

function findMatchingAccount(companyName) {
    const companyAccounts = accounts.filter(a => a.companyId === activeCompanyId);
    
    if (companyAccounts.length === 0) return null;

    // Arama için temizleme
    const cleanName = (name) => {
        return name.toUpperCase()
            .replace(/\s+/g, ' ') // Çoklu boşlukları tek boşluğa
            .replace(/\./g, '') // Noktaları kaldır
            .replace(/LTD\.?\s*ŞTİ\.?/gi, '')
            .replace(/LİMİTED\s*ŞİRKETİ/gi, '')
            .replace(/A\.?\s*Ş\.?/gi, '')
            .replace(/ANONİM\s*ŞİRKETİ/gi, '')
            .replace(/SANAYİ/gi, '')
            .replace(/SANAYİİ/gi, '')
            .replace(/TİCARET/gi, '')
            .replace(/VE/gi, '')
            .replace(/İNŞAAT/gi, '')
            .replace(/PAZARLAMA/gi, '')
            .replace(/ÜRETİM/gi, '')
            .replace(/ÜNVAN\s*:/gi, '')
            .trim();
    };

    const searchName = cleanName(companyName);
    console.log('🔍 Aranan firma (temizlenmiş):', searchName);

    // 1. TAM EŞLEŞME
    for (let account of companyAccounts) {
        const accountName = cleanName(account.name);
        
        if (accountName === searchName) {
            console.log(`✅ TAM EŞLEŞME (100%): "${companyName}" → "${account.name}"`);
            return account;
        }
    }

    // 2. TAM İÇERME (Biri diğerini tamamen içeriyor)
    for (let account of companyAccounts) {
        const accountName = cleanName(account.name);
        
        if (accountName.includes(searchName) || searchName.includes(accountName)) {
            console.log(`✅ TAM İÇERME (95%): "${companyName}" → "${account.name}"`);
            return account;
        }
    }

    // 3. İLK KELİME EŞLEŞME (Firma adının ilk kelimesi benzersizse)
    const searchFirstWord = searchName.split(/\s+/)[0];
    if (searchFirstWord.length >= 4) {
        let matches = [];
        
        for (let account of companyAccounts) {
            const accountName = cleanName(account.name);
            const accountFirstWord = accountName.split(/\s+/)[0];
            
            if (searchFirstWord === accountFirstWord) {
                matches.push(account);
            }
        }
        
        // Eğer tek bir eşleşme varsa, güvenli
        if (matches.length === 1) {
            console.log(`✅ İLK KELİME EŞLEŞME (90%): "${companyName}" → "${matches[0].name}"`);
            return matches[0];
        }
    }

    // 4. ÇOK KELİMELİ EŞLEŞME (İlk 3 kelimenin 2'si eşleşmeli)
    const searchWords = searchName.split(/\s+/).filter(w => w.length > 2).slice(0, 3);
    
    if (searchWords.length >= 2) {
        let bestMatch = null;
        let bestScore = 0;
        
        for (let account of companyAccounts) {
            const accountName = cleanName(account.name);
            let matchCount = 0;
            
            for (let word of searchWords) {
                if (accountName.includes(word)) {
                    matchCount++;
                }
            }
            
            const score = matchCount / searchWords.length;
            
            if (score >= 0.66 && score > bestScore) { // En az %66 eşleşme
                bestScore = score;
                bestMatch = account;
            }
        }
        
        if (bestMatch) {
            console.log(`✅ ÇOK KELİMELİ EŞLEŞME (${Math.round(bestScore * 100)}%): "${companyName}" → "${bestMatch.name}"`);
            return bestMatch;
        }
    }

    // 5. FUZZY EŞLEŞME (En az 5 karakterlik kelimeler)
    const searchLongWords = searchName.split(/\s+/).filter(w => w.length >= 5);
    
    if (searchLongWords.length > 0) {
        for (let account of companyAccounts) {
            const accountName = cleanName(account.name);
            
            for (let word of searchLongWords) {
                if (accountName.includes(word)) {
                    console.log(`⚠️ FUZZY EŞLEŞME (70%): "${companyName}" → "${account.name}" (Kelime: "${word}")`);
                    return account;
                }
            }
        }
    }

    console.log(`❌ EŞLEŞME YOK: "${companyName}"`);
    return null;
}

function calculateMatchConfidence(companyName, account) {
    const cleanName = (name) => {
        return name.toUpperCase()
            .replace(/\s+/g, ' ')
            .replace(/\./g, '')
            .replace(/LTD\.?\s*ŞTİ\.?/gi, '')
            .replace(/LİMİTED\s*ŞİRKETİ/gi, '')
            .replace(/A\.?\s*Ş\.?/gi, '')
            .replace(/ANONİM\s*ŞİRKETİ/gi, '')
            .replace(/SANAYİ/gi, '')
            .replace(/TİCARET/gi, '')
            .replace(/VE/gi, '')
            .trim();
    };

    const searchName = cleanName(companyName);
    const accountName = cleanName(account.name);
    
    // Tam eşleşme
    if (accountName === searchName) return 100;
    
    // Tam içerme
    if (accountName.includes(searchName) || searchName.includes(accountName)) return 95;
    
    // İlk kelime eşleşmesi
    const searchFirstWord = searchName.split(/\s+/)[0];
    const accountFirstWord = accountName.split(/\s+/)[0];
    if (searchFirstWord === accountFirstWord && searchFirstWord.length >= 4) return 90;
    
    // Kelime eşleşme oranı
    const searchWords = searchName.split(/\s+/).filter(w => w.length > 2);
    let matchCount = 0;
    
    for (let word of searchWords) {
        if (accountName.includes(word)) {
            matchCount++;
        }
    }
    
    if (searchWords.length > 0) {
        return Math.round((matchCount / searchWords.length) * 85);
    }
    
    return 50; // Fuzzy eşleşme
}

function showInvoiceMatchModal() {
    const typeText = currentInvoiceType === 'sales' ? 'Giden (Satış)' : 'Gelen (Alış)';
    document.getElementById('invoiceMatchTitle').textContent = `🔄 ${typeText} Fatura Eşleştirme`;
    
    // ✅ EŞLEŞME İSTATİSTİKLERİ
    const totalCount = parsedInvoices.length;
    const matchedCount = parsedInvoices.filter(inv => inv.matchedAccount).length;
    const unmatchedCount = totalCount - matchedCount;
    const matchPercentage = Math.round((matchedCount / totalCount) * 100);

    document.getElementById('matchedInvoiceCount').textContent = totalCount;
    document.getElementById('saveInvoiceCount').textContent = totalCount;

    // Özet bilgiyi güncelle
    const summaryHtml = `
        <strong>✅ ${totalCount} fatura başarıyla okundu!</strong><br>
        <div style="margin-top: 10px; display: flex; gap: 20px; font-size: 0.95em;">
            <span style="color: var(--success);">✅ ${matchedCount} otomatik eşleşti (%${matchPercentage})</span>
            ${unmatchedCount > 0 ? `<span style="color: var(--warning);">⚠️ ${unmatchedCount} manuel seçim gerekli</span>` : ''}
        </div>
    `;
    document.getElementById('invoiceMatchSummary').innerHTML = summaryHtml;

    const matchList = document.getElementById('invoiceMatchList');
    matchList.innerHTML = '';

    parsedInvoices.forEach((invoice, index) => {
        // ✅ OTOMATIK VADE TARİHİ HESAPLA (Fatura tarihinden 7 gün sonra)
        const invoiceDate = new Date(invoice.faturaTarihi);
        const dueDate = new Date(invoiceDate);
        dueDate.setDate(dueDate.getDate() + 7);
        const dueDateStr = dueDate.toISOString().split('T')[0]; // YYYY-MM-DD format

        const card = document.createElement('div');
        card.style.cssText = `
            border: 2px solid ${invoice.matchedAccount ? '#10b981' : '#f59e0b'};
            background: ${invoice.matchedAccount ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' : 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)'};
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        `;

        const confidenceBadge = invoice.matchedAccount 
            ? `<span class="badge badge-${invoice.confidence >= 90 ? 'success' : invoice.confidence >= 70 ? 'warning' : 'danger'}" style="font-size: 0.9em;">
                ${invoice.confidence}% Eşleşme
               </span>`
            : '<span class="badge badge-danger" style="font-size: 0.9em;">Manuel Seçim Gerekli</span>';

        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <strong style="font-size: 1.2em; color: var(--primary);">${invoice.faturaNo}</strong>
                        <span class="badge badge-info">${invoice.durum}</span>
                        ${confidenceBadge}
                    </div>
                    <div style="font-size: 0.95em; color: #1f2937; margin-bottom: 5px;">
                        <strong>📅 Fatura Tarihi:</strong> ${formatDate(invoice.faturaTarihi)}
                        <span style="margin-left: 15px; color: var(--warning);"><strong>⏰ Vade:</strong> ${formatDate(dueDateStr)}</span>
                    </div>
                    <div style="font-size: 0.95em; color: #1f2937; margin-bottom: 5px;">
                        <strong>🏢 Firma (E-Fatura):</strong> ${invoice.aliciAdi}
                    </div>
                    ${invoice.matchedAccount ? `
                        <div style="font-size: 0.9em; color: var(--success); margin-top: 8px; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
                            ✅ <strong>Otomatik Eşleşti:</strong> ${invoice.matchedAccount.name}
                        </div>
                    ` : `
                        <div style="font-size: 0.9em; color: var(--danger); margin-top: 8px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px;">
                            ⚠️ Cari hesap bulunamadı - Lütfen manuel seçin
                        </div>
                    `}
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 2em; font-weight: 700; color: ${currentInvoiceType === 'sales' ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 5px;">
                        ${formatCurrency(invoice.tutar)}
                    </div>
                    <div style="font-size: 0.85em; color: #6b7280;">KDV Dahil</div>
                </div>
            </div>

            <div class="grid-2" style="margin-top: 15px;">
                <div class="form-group" style="margin: 0;">
                    <label>Cari Hesap ${invoice.matchedAccount ? '(✅ Otomatik Eşleşti)' : '(⚠️ Manuel Seçin)'}</label>
                    <select id="invoiceAccount_${index}" style="font-weight: ${invoice.matchedAccount ? '600' : 'normal'}; background: white; border-color: ${invoice.matchedAccount ? 'var(--success)' : 'var(--danger)'};">
                        <option value="">Cari Hesap Seçin</option>
                        ${accounts.filter(a => a.companyId === activeCompanyId).map(a => 
                            `<option value="${a.id}" ${invoice.matchedAccount && invoice.matchedAccount.id === a.id ? 'selected' : ''}>
                                ${a.name} (${a.type === 'customer' ? 'Müşteri' : 'Tedarikçi'})
                            </option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label>⏰ Vade Tarihi (Otomatik: +7 gün)</label>
                    <input type="date" id="invoiceDueDate_${index}" value="${dueDateStr}" style="background: white;">
                </div>
            </div>

            <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
                <label>Açıklama/Notlar (Opsiyonel)</label>
                <textarea id="invoiceDescription_${index}" rows="2" placeholder="Fatura ile ilgili notlar..." style="background: white;"></textarea>
            </div>
        `;

        matchList.appendChild(card);
    });

    document.getElementById('invoiceMatchModal').classList.add('active');
}

function closeInvoiceMatchModal() {
    document.getElementById('invoiceMatchModal').classList.remove('active');
    parsedInvoices = [];
}

// ===============================
// CSV'den fatura import işlemi
// ===============================
async function saveAllInvoices(importedInvoices) {
    if (!importedInvoices || importedInvoices.length === 0) {
        alert('❌ Kaydedilecek fatura yok!');
        return;
    }
    if (!activeCompanyId) {
        alert('❌ Lütfen bir firma seçin!');
        return;
    }
    if (!auth.currentUser) {
        alert('❌ Lütfen giriş yapın!');
        return;
    }

    // Mevcut fatura unique key dizisini oluştur
    const existingKeys = invoices.map(getInvoiceUniqueKey);
    const filteredInvoices = [];
    let skippedCount = 0;

    importedInvoices.forEach(inv => {
        const invKey = getInvoiceUniqueKey(inv);
        if (existingKeys.includes(invKey)) {
            skippedCount++;
        } else {
            filteredInvoices.push(inv);
            existingKeys.push(invKey);
        }
    });

    if (filteredInvoices.length === 0) {
        alert(`⚠️ Tüm faturalar zaten kayıtlı, yeni fatura eklenmedi.`);
        return;
    }

    // Firebase batch ile ekle
    const batch = db.batch();
    const now = new Date().toISOString();
    filteredInvoices.forEach(inv => {
        const invoiceRef = db.collection('companies').doc(activeCompanyId)
            .collection('invoices').doc();
        const invoiceData = {
            id: invoiceRef.id,
            invoiceNo: inv.invoiceNo,
            companyId: activeCompanyId,
            accountId: inv.accountId,
            date: inv.date,
            total: inv.total,
            type: inv.type || 'sales',
            status: 'unpaid',
            description: inv.description || '',
            createdAt: now,
            createdBy: auth.currentUser.uid
        };
        batch.set(invoiceRef, invoiceData);
        invoices.push(invoiceData);
    });

    await batch.commit();
    await loadInvoices();
    await loadAccounts();
    updateDashboard();

    alert(`✅ ${filteredInvoices.length} yeni fatura eklendi\n⚠️ ${skippedCount} fatura zaten vardı, atlandı!`);
}

function scrollToInvoiceForm() {
    document.getElementById('invoiceFormCard').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
    });
    
    // Formu vurgula (1 saniye)
    const formCard = document.getElementById('invoiceFormCard');
    const originalBorder = formCard.style.border;
    formCard.style.border = '3px solid var(--primary)';
    formCard.style.boxShadow = '0 0 20px rgba(37, 99, 235, 0.4)';
    
    setTimeout(() => {
        formCard.style.border = originalBorder;
        formCard.style.boxShadow = '';
    }, 1500);
}

// ========================================
// PURCHASES (ALIŞLAR) FONKSİYONLARI
// ========================================

function calculatePurchaseTotal() {
    const amount = parseFloat(document.getElementById('purchaseAmount').value) || 0;
    const vatRate = parseFloat(document.getElementById('purchaseVATRate').value) || 0;
    
    const vatAmount = amount * (vatRate / 100);
    const total = amount + vatAmount;
    
    document.getElementById('purchaseVATAmount').value = vatAmount.toFixed(2);
    document.getElementById('purchaseTotalDisplay').textContent = formatCurrency(total);
}

function handlePurchaseReceipt(input) {
    const file = input.files[0];
    if (!file) {
        currentPurchaseReceipt = null;
        document.getElementById('purchaseReceiptPreview').innerHTML = '';
        return;
    }
    
    // Boyut kontrolü (5 MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('⚠️ Fiş boyutu 5 MB\'dan küçük olmalıdır!');
        input.value = '';
        return;
    }
    
    // ✅ Artık dosyayı direkt saklıyoruz (Base64'e çevirmeye gerek yok)
    currentPurchaseReceipt = file;
    
    // Önizleme
    const preview = document.getElementById('purchaseReceiptPreview');
    
    if (file.type.includes('image')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <div style="border: 2px solid var(--success); padding: 10px; border-radius: 8px; background: white;">
                    <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        📄 ${file.name} (${formatFileSize(file.size)})
                    </p>
                    <button type="button" onclick="clearPurchaseReceipt()" class="btn btn-danger btn-sm" style="margin-top:5px;">✖ Kaldır</button>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = `
            <div style="border: 2px solid var(--success); padding: 15px; border-radius: 8px; background: white; text-align:center;">
                <div style="font-size: 3em;">📄</div>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                    ${file.name} (${formatFileSize(file.size)})
                </p>
                <button type="button" onclick="clearPurchaseReceipt()" class="btn btn-danger btn-sm" style="margin-top:5px;">✖ Kaldır</button>
            </div>
        `;
    }
}

function clearPurchaseReceipt() {
    currentPurchaseReceipt = null;
    document.getElementById('purchaseReceipt').value = '';
    document.getElementById('purchaseReceiptPreview').innerHTML = '';
}

async function savePurchase(e) {
    e.preventDefault();
    
    if (!activeCompanyId) {
        alert('⚠️ Lütfen önce bir firma seçin!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    const purchaseId = document.getElementById('purchaseId').value;
    const now = new Date().toISOString();
    
    const amount = parseFloat(document.getElementById('purchaseAmount').value);
    const vatRate = parseFloat(document.getElementById('purchaseVATRate').value);
    const vatAmount = amount * (vatRate / 100);
    const total = amount + vatAmount;
    
    try {
        let receiptUrl = null;
        
        // Eğer yeni fiş yüklendiyse Storage'a yükle
        if (currentPurchaseReceipt && currentPurchaseReceipt instanceof File) {
            const tempId = purchaseId || Date.now().toString();
            const fileName = `${Date.now()}_${currentPurchaseReceipt.name}`;
            const storageRef = storage.ref(`companies/${activeCompanyId}/purchases/${tempId}/${fileName}`);
            
            const snapshot = await storageRef.put(currentPurchaseReceipt);
            receiptUrl = await snapshot.ref.getDownloadURL();
            
            console.log('✅ Alış fişi yüklendi:', receiptUrl);
        }
        
        let purchaseData;
        
        if (purchaseId) {
            // Update existing
            const purchase = purchases.find(p => p.id === purchaseId);
            
            const updatedData = {
                date: document.getElementById('purchaseDate').value,
                category: document.getElementById('purchaseCategory').value,
                description: document.getElementById('purchaseDescription').value,
                supplier: document.getElementById('purchaseSupplier').value,
                amount: amount,
                vatRate: vatRate,
                vatAmount: vatAmount,
                total: total,
                paymentMethod: document.getElementById('purchasePaymentMethod').value,
                receiptUrl: receiptUrl || purchase.receiptUrl,
                updatedAt: now,
                updatedBy: auth.currentUser.uid
            };
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('purchases').doc(purchaseId).update(updatedData);
            
            Object.assign(purchase, updatedData);
            purchaseData = purchase;
            
        } else {
            // Create new
            const newPurchaseRef = db.collection('companies').doc(activeCompanyId)
                .collection('purchases').doc();
            const newPurchaseId = newPurchaseRef.id;
            
            const newPurchase = {
                id: newPurchaseId,
                companyId: activeCompanyId,
                date: document.getElementById('purchaseDate').value,
                category: document.getElementById('purchaseCategory').value,
                description: document.getElementById('purchaseDescription').value,
                supplier: document.getElementById('purchaseSupplier').value || '',
                amount: amount,
                vatRate: vatRate,
                vatAmount: vatAmount,
                total: total,
                paymentMethod: document.getElementById('purchasePaymentMethod').value,
                receiptUrl: receiptUrl,
                createdAt: now,
                createdBy: auth.currentUser.uid
            };
            
            await newPurchaseRef.set(newPurchase);
            
            purchases.push(newPurchase);
            purchaseData = newPurchase;
        }
        
        document.getElementById('purchaseForm').reset();
        document.getElementById('purchaseId').value = '';
        document.getElementById('purchaseDate').valueAsDate = new Date();
        currentPurchaseReceipt = null;
        document.getElementById('purchaseReceiptPreview').innerHTML = '';
        cancelPurchaseEdit();
        
        await loadPurchases();
        updateDashboard();
        
        alert('✅ Alış başarıyla kaydedildi!');
        
    } catch (error) {
        console.error('Alış kayıt hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

async function loadPurchases() {
    if (!activeCompanyId || !auth.currentUser) {
        purchases = [];
        renderPurchasesTable();
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('purchases').orderBy('date', 'desc').get();
        
        purchases = [];
        snapshot.forEach(doc => {
            purchases.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('✅ Alışlar yüklendi:', purchases.length);
        
    } catch (error) {
        console.error('❌ Alış yükleme hatası:', error);
        purchases = [];
    }
    
    renderPurchasesTable();
}

function updatePurchaseStats(purchaseList) {
    const totalAmount = purchaseList.reduce((sum, p) => sum + p.total, 0);
    const subtotal = purchaseList.reduce((sum, p) => sum + p.amount, 0);
    const totalVAT = purchaseList.reduce((sum, p) => sum + p.vatAmount, 0);
    const average = purchaseList.length > 0 ? totalAmount / purchaseList.length : 0;
    
    document.getElementById('purchasesTotalAmount').textContent = formatCurrency(totalAmount);
    document.getElementById('purchasesCount').textContent = `${purchaseList.length} kayıt`;
    document.getElementById('purchasesSubtotal').textContent = formatCurrency(subtotal);
    document.getElementById('purchasesTotalVAT').textContent = formatCurrency(totalVAT);
    document.getElementById('purchasesAverage').textContent = formatCurrency(average);
}

function editPurchase(id) {
    const purchase = purchases.find(p => p.id === id);
    if (!purchase) return;
    
    document.getElementById('purchaseId').value = purchase.id;
    document.getElementById('purchaseDate').value = purchase.date;
    document.getElementById('purchaseCategory').value = purchase.category;
    document.getElementById('purchaseDescription').value = purchase.description;
    document.getElementById('purchaseSupplier').value = purchase.supplier || '';
    document.getElementById('purchaseAmount').value = purchase.amount;
    document.getElementById('purchaseVATRate').value = purchase.vatRate;
    document.getElementById('purchasePaymentMethod').value = purchase.paymentMethod;
    
    // ✅ Mevcut fişi göster (URL veya Base64)
    const preview = document.getElementById('purchaseReceiptPreview');
    
    if (purchase.receiptUrl) {
        // Yeni sistem: Firebase Storage URL
        const isPDF = purchase.receiptUrl.toLowerCase().includes('.pdf');
        
        if (isPDF) {
            preview.innerHTML = `
                <div style="border: 2px solid var(--info); padding: 15px; border-radius: 8px; background: white; text-align:center;">
                    <div style="font-size: 3em;">📄</div>
                    <p style="margin: 10px 0; font-size: 0.9em; color: #6b7280;">Mevcut PDF Fiş</p>
                    <button type="button" onclick="viewPurchaseReceipt('${purchase.id}')" class="btn btn-sm">👁️ Görüntüle</button>
                    <p style="margin-top:10px; font-size:0.85em; color:#6b7280;">Yeni fiş yüklerseniz eski fiş silinir.</p>
                </div>
            `;
        } else {
            preview.innerHTML = `
                <div style="border: 2px solid var(--info); padding: 10px; border-radius: 8px; background: white;">
                    <img src="${purchase.receiptUrl}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">Mevcut Fiş</p>
                    <p style="margin-top:5px; font-size:0.85em; color:#6b7280;">Yeni fiş yüklerseniz eski fiş silinir.</p>
                </div>
            `;
        }
        
        // Not: Eski fişi sakla (değiştirmezse aynı kalacak)
        currentPurchaseReceipt = null;
        
    } else if (purchase.receipt && purchase.receipt.file) {
        // Eski sistem: Base64
        if (purchase.receipt.fileType.includes('image')) {
            preview.innerHTML = `
                <div style="border: 2px solid var(--warning); padding: 10px; border-radius: 8px; background: white;">
                    <img src="${purchase.receipt.file}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        📄 ${purchase.receipt.fileName} (${formatFileSize(purchase.receipt.fileSize)})
                    </p>
                    <p style="margin-top:5px; font-size:0.85em; color:#f59e0b;">⚠️ Eski format (Base64)</p>
                </div>
            `;
        }
        currentPurchaseReceipt = null;
    } else {
        preview.innerHTML = '<p style="color:#6b7280;">Fiş yok</p>';
        currentPurchaseReceipt = null;
    }
    
    calculatePurchaseTotal();
    
    document.getElementById('savePurchaseBtn').textContent = '💾 Güncelle';
    document.getElementById('cancelPurchaseBtn').style.display = 'inline-block';
    
    scrollToPurchaseForm();
}

async function deletePurchase(id) {
    if (!confirm('Bu alış kaydını silmek istediğinizden emin misiniz?')) return;
    
    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    try {
        await db.collection('companies').doc(activeCompanyId)
            .collection('purchases').doc(id).delete();
        
        purchases = purchases.filter(p => p.id !== id);
        
        await loadPurchases();
        updateDashboard();
        
        alert('✅ Alış kaydı silindi!');
        
    } catch (error) {
        console.error('Alış silme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

function cancelPurchaseEdit() {
    document.getElementById('purchaseForm').reset();
    document.getElementById('purchaseId').value = '';
    document.getElementById('purchaseDate').valueAsDate = new Date();
    document.getElementById('savePurchaseBtn').textContent = '💾 Alışı Kaydet';
    document.getElementById('cancelPurchaseBtn').style.display = 'none';
    currentPurchaseReceipt = null;
    document.getElementById('purchaseReceiptPreview').innerHTML = '';
    calculatePurchaseTotal();
}

function scrollToPurchaseForm() {
    document.getElementById('purchaseFormCard').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
    });
    
    const formCard = document.getElementById('purchaseFormCard');
    const originalBorder = formCard.style.border;
    formCard.style.border = '3px solid var(--primary)';
    formCard.style.boxShadow = '0 0 20px rgba(37, 99, 235, 0.4)';
    
    setTimeout(() => {
        formCard.style.border = originalBorder;
        formCard.style.boxShadow = '';
    }, 1500);
}

function filterPurchases() {
    const startDate = document.getElementById('filterPurchaseStartDate').value;
    const endDate = document.getElementById('filterPurchaseEndDate').value;
    const category = document.getElementById('filterPurchaseCategory').value;
    const paymentMethod = document.getElementById('filterPurchasePayment').value;
    
    let filtered = purchases.filter(p => !activeCompanyId || p.companyId === activeCompanyId);
    
    if (startDate) filtered = filtered.filter(p => p.date >= startDate);
    if (endDate) filtered = filtered.filter(p => p.date <= endDate);
    if (category) filtered = filtered.filter(p => p.category === category);
    if (paymentMethod) filtered = filtered.filter(p => p.paymentMethod === paymentMethod);
    
    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const tbody = document.querySelector('#purchasesTable tbody');
    tbody.innerHTML = '';
    
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px;">Sonuç bulunamadı.</td></tr>';
        updatePurchaseStats([]);
        return;
    }
    
    filtered.forEach(purchase => {
        const paymentMethodText = {
            'cash': '💵 Nakit',
            'card': '💳 Kart',
            'transfer': '🏦 Havale'
        }[purchase.paymentMethod] || purchase.paymentMethod;
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${formatDate(purchase.date)}</td>
            <td><span class="badge badge-info">${purchase.category}</span></td>
            <td><strong>${purchase.description}</strong></td>
            <td>${purchase.supplier || '-'}</td>
            <td>${formatCurrency(purchase.amount)}</td>
            <td>${formatCurrency(purchase.vatAmount)} <small>(%${purchase.vatRate})</small></td>
            <td style="font-weight: 700; color: var(--danger);">${formatCurrency(purchase.total)}</td>
            <td>${paymentMethodText}</td>
            <td>
                ${purchase.receipt ? `
                    <button class="btn btn-info btn-sm" onclick="viewPurchaseReceipt('${purchase.id}')">📄</button>
                ` : '<span style="color:#6b7280;">-</span>'}
            </td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editPurchase('${purchase.id}')">✏️</button>
                <button class="btn btn-danger btn-sm" onclick="deletePurchase('${purchase.id}')">🗑️</button>
            </td>
        `;
    });
    
    updatePurchaseStats(filtered);
}

function clearPurchaseFilters() {
    document.getElementById('filterPurchaseStartDate').value = '';
    document.getElementById('filterPurchaseEndDate').value = '';
    document.getElementById('filterPurchaseCategory').value = '';
    document.getElementById('filterPurchasePayment').value = '';
    loadPurchases();
}

function viewPurchaseReceipt(id) {
    const purchase = purchases.find(p => p.id === id);
    
    if (!purchase) {
        alert('⚠️ Alış kaydı bulunamadı!');
        return;
    }
    
    // ✅ Önce yeni sistem (receiptUrl), yoksa eski sistem (receipt.file)
    let receiptSource = null;
    let isPDF = false;
    
    if (purchase.receiptUrl) {
        // Yeni sistem: Firebase Storage URL
        receiptSource = purchase.receiptUrl;
        isPDF = purchase.receiptUrl.toLowerCase().includes('.pdf');
    } else if (purchase.receipt && purchase.receipt.file) {
        // Eski sistem: Base64
        receiptSource = purchase.receipt.file;
        isPDF = purchase.receipt.fileType && purchase.receipt.fileType.includes('pdf');
    } else {
        alert('⚠️ Bu alışa ait fiş yok!');
        return;
    }
    
    document.getElementById('documentViewerTitle').textContent = `📄 Fiş - ${purchase.description}`;
    
    const content = document.getElementById('documentViewerContent');
    content.innerHTML = '';
    
    if (isPDF) {
        const iframe = document.createElement('iframe');
        iframe.src = receiptSource;
        iframe.style.width = '100%';
        iframe.style.height = '600px';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        content.appendChild(iframe);
    } else {
        const img = document.createElement('img');
        img.src = receiptSource;
        img.style.maxWidth = '100%';
        img.style.borderRadius = '8px';
        img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        content.appendChild(img);
        
        // İndirme butonu ekle
        const downloadBtn = document.createElement('a');
        downloadBtn.href = receiptSource;
        downloadBtn.download = `fis_${purchase.id}.jpg`;
        downloadBtn.target = '_blank';
        downloadBtn.className = 'btn btn-primary';
        downloadBtn.style.marginTop = '20px';
        downloadBtn.innerHTML = '📥 İndir';
        content.appendChild(downloadBtn);
    }
    
    currentDocumentData = { file: receiptSource, fileName: purchase.description };
    document.getElementById('documentViewerModal').classList.add('active');
}

// ========================================
// ALIŞ EXCEL İMPORT FONKSİYONLARI
// ========================================

// ========================================
// ALIŞ EXCEL İMPORT SİSTEMİ
// ========================================

function openImportPurchasesModal() {
    if (!activeCompanyId) {
        alert('⚠️ Lütfen önce bir firma seçin!');
        return;
    }
    
    const modalHtml = `
        <div class="modal active" id="purchasesImportModal" style="display: flex;">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3>📤 Alış Listesi İçe Aktar (Excel/CSV)</h3>
                    <button class="close-modal" onclick="closePurchasesImportModal()">✖</button>
                </div>
                
                <div style="padding: 30px;">
                    <!-- Örnek Format -->
                    <div class="alert alert-info">
                        <strong>📋 Excel/CSV Formatı</strong>
                        <p style="margin: 10px 0 5px 0; font-size: 0.95em;">
                            Aşağıdaki sütun sırasını kullanın (başlık satırı olmalı):
                        </p>
                    </div>
                    
                    <div style="overflow-x: auto; margin-bottom: 20px;">
                        <table style="font-size: 0.85em; width: 100%; border: 2px solid var(--primary);">
                            <thead style="background: var(--primary); color: white;">
                                <tr>
                                    <th>Tarih</th>
                                    <th>Kategori</th>
                                    <th>Açıklama</th>
                                    <th>Tedarikçi</th>
                                    <th>Tutar</th>
                                    <th>KDV%</th>
                                    <th>Ödeme</th>
                                </tr>
                            </thead>
                            <tbody style="background: white;">
                                <tr>
                                    <td>2025-01-15</td>
                                    <td>Kırtasiye</td>
                                    <td>A4 Kağıt</td>
                                    <td>Migros</td>
                                    <td>250.00</td>
                                    <td>20</td>
                                    <td>Nakit</td>
                                </tr>
                                <tr>
                                    <td>2025-01-16</td>
                                    <td>Yakıt</td>
                                    <td>Motorin 50L</td>
                                    <td>Shell</td>
                                    <td>1850.50</td>
                                    <td>20</td>
                                    <td>Kart</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Kategoriler Rehberi -->
                    <div class="card" style="background: #f9fafb; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">🏷️ Kullanılabilir Kategoriler</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 0.9em;">
                            <div>📎 Kırtasiye</div>
                            <div>⛽ Yakıt</div>
                            <div>🍽️ Yemek</div>
                            <div>🧹 Temizlik</div>
                            <div>📦 Kargo</div>
                            <div>💡 Elektrik</div>
                            <div>💧 Su</div>
                            <div>🌐 İnternet</div>
                            <div>📱 Telefon</div>
                            <div>🔧 Bakım-Onarım</div>
                            <div>🚗 Ulaşım</div>
                            <div>📋 Diğer</div>
                        </div>
                    </div>

                    <!-- Ödeme Yöntemleri -->
                    <div class="card" style="background: #f9fafb; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">💳 Ödeme Yöntemleri</h4>
                        <div style="display: flex; gap: 20px; font-size: 0.9em;">
                            <div>💵 <strong>Nakit</strong></div>
                            <div>💳 <strong>Kart</strong></div>
                            <div>🏦 <strong>Havale</strong></div>
                        </div>
                    </div>

                    <!-- Dosya Yükleme -->
                    <div class="file-upload-area" 
                         onclick="document.getElementById('purchasesExcelFile').click()" 
                         style="cursor: pointer; margin-bottom: 20px;">
                        <h3>📂 CSV/Excel Dosyasını Yükle</h3>
                        <p style="margin: 10px 0; color: #6b7280;">Dosyanızı sürükleyin veya tıklayın</p>
                        <p style="font-size: 0.9em; color: #9ca3af;">Desteklenen format: .csv</p>
                        <input type="file" 
                               id="purchasesExcelFile" 
                               accept=".csv" 
                               style="display:none;" 
                               onchange="processPurchasesExcel(event)">
                    </div>

                    <!-- Örnek Dosya İndir -->
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="downloadPurchaseTemplate()">
                            📥 Örnek CSV Şablonunu İndir
                        </button>
                        <button class="btn btn-secondary" onclick="closePurchasesImportModal()">
                            ✖️ İptal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Modal'ı sayfaya ekle
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closePurchasesImportModal() {
    const modal = document.getElementById('purchasesImportModal');
    if (modal) {
        modal.remove();
    }
}

function downloadPurchaseTemplate() {
    const csv = `Tarih,Kategori,Açıklama,Tedarikçi,Tutar,KDV%,Ödeme
2025-01-15,Kırtasiye,A4 Kağıt 5 paket,Migros,250.00,20,Nakit
2025-01-16,Yakıt,Motorin 50L,Shell,1850.50,20,Kart
2025-01-17,Yemek,Personel yemeği,Yemek Sepeti,450.00,10,Kart
2025-01-18,Elektrik,Ocak faturası,BEDAŞ,980.00,20,Havale
2025-01-19,Temizlik,Temizlik malzemesi,BİM,125.75,20,Nakit
2025-01-20,Kargo,Kargo ödemesi,MNG,85.00,20,Kart`;
    
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `alislar-sablonu-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    
    alert('✅ Örnek CSV şablonu indirildi!\n\nDosyayı açıp düzenleyebilir, ardından tekrar yükleyebilirsiniz.');
}

async function processPurchasesExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    try {
        await saveImportedFileToStorage(file, "purchases");
    } catch (err) {
        console.error("Alış dosya kaydedilemedi:", err);
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            parsePurchasesCSV(e.target.result);
        } catch (err) {
            console.error("Alış dosya parse hatası:", err);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

function parsePurchasesCSV(content) {
    const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);

    // Noktalı virgül veya virgül ayraç desteği!
    // Otomatik algıla: ilk satırda ";" varsa split(";"), yoksa split(",")
    const delimiter = lines[0].includes(';') ? ';' : ',';

    // Başlık kontrolü (dilersen delimiter ile split ederek de kontrol edebilirsin)
    const header = lines[0].toLowerCase();
    if (!header.includes('tarih') || !header.includes('kategori') || !header.includes('açıklama')) {
        alert('⚠️ CSV başlık satırı hatalı!');
        return;
    }

    let importedPurchases = [];
    let errorCount = 0;

    for (let i = 1; i < lines.length; i++) {
        // Satırı sütunlara böl
        const parts = lines[i].split(delimiter);
        if (parts.length < 7) { // Sütun sayısı kontrolü
            errorCount++;
            continue;
        }

        // Sütunlar: Tarih;Kategori;Açıklama;Tedarikçi;Tutar;KDV%;Ödeme
        const tarih = parts[0].trim();
        const kategori = parts[1].trim();
        const aciklama = parts[2].trim();
        const tedarikci = parts[3].trim();
        const tutar = parseFloat(parts[4].replace(',', '.'));
        const kdvOrani = parseFloat(parts[5].replace(',', '.'));
        const odeme = parts[6].trim();

        // Validasyon
        if (!tarih || !kategori || !aciklama || isNaN(tutar) || isNaN(kdvOrani)) {
            errorCount++;
            continue;
        }

        // KDV ve toplam otomatik hesaplanır
        const kdvTutari = tutar * (kdvOrani / 100);
        const toplamTutar = tutar + kdvTutari;

        // Ödeme türü
        let paymentMethod = 'cash';
        const odemeUpper = odeme.toUpperCase();
        if (odemeUpper.includes('KART')) paymentMethod = 'card';
        else if (odemeUpper.includes('HAVALE') || odemeUpper.includes('EFT') || odemeUpper.includes('TRANSFER')) paymentMethod = 'transfer';

        importedPurchases.push({
            date: tarih,
            category: kategori,
            description: aciklama,
            supplier: tedarikci,
            amount: tutar,
            vatRate: kdvOrani,
            vatAmount: kdvTutari,
            total: toplamTutar,
            paymentMethod: paymentMethod
        });
    }

    showPurchasesConfirmModal(importedPurchases, errorCount);
}

function showPurchasesConfirmModal(importedPurchases, errorCount) {
    closePurchasesImportModal();
    
    const totalAmount = importedPurchases.reduce((sum, p) => sum + p.total, 0);
    const totalVAT = importedPurchases.reduce((sum, p) => sum + p.vatAmount, 0);
    
    const summaryHtml = errorCount > 0 
        ? `<div class="alert alert-warning">
            <strong>⚠️ ${errorCount} satır hatalı olduğu için atlandı!</strong>
           </div>`
        : '';
    
    const modalHtml = `
        <div class="modal active" id="purchasesConfirmModal" style="display: flex;">
            <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h3>✅ Alışları Onaylayın (${importedPurchases.length} Kayıt)</h3>
                    <button class="close-modal" onclick="closePurchasesConfirmModal()">✖</button>
                </div>
                
                <div style="padding: 20px;">
                    ${summaryHtml}
                    
                    <div class="alert alert-success">
                        <strong>📊 Özet İstatistikler</strong>
                        <div style="margin-top: 10px; display: flex; gap: 30px; font-size: 1.1em;">
                            <span>💰 Toplam Harcama: <strong>${formatCurrency(totalAmount)}</strong></span>
                            <span>📋 KDV Toplamı: <strong>${formatCurrency(totalVAT)}</strong></span>
                            <span>📝 Kayıt Sayısı: <strong>${importedPurchases.length}</strong></span>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Kategori</th>
                                    <th>Açıklama</th>
                                    <th>Tedarikçi</th>
                                    <th>KDV Hariç</th>
                                    <th>KDV</th>
                                    <th>Toplam</th>
                                    <th>Ödeme</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${importedPurchases.map((p, index) => {
                                    const paymentIcon = {
                                        'cash': '💵 Nakit',
                                        'card': '💳 Kart',
                                        'transfer': '🏦 Havale'
                                    }[p.paymentMethod];
                                    
                                    return `
                                        <tr style="background: ${index % 2 === 0 ? 'white' : '#f9fafb'};">
                                            <td>${formatDate(p.date)}</td>
                                            <td><span class="badge badge-info">${p.category}</span></td>
                                            <td><strong>${p.description}</strong></td>
                                            <td>${p.supplier || '-'}</td>
                                            <td>${formatCurrency(p.amount)}</td>
                                            <td>${formatCurrency(p.vatAmount)} <small>(%${p.vatRate})</small></td>
                                            <td style="font-weight: 700; color: var(--danger);">${formatCurrency(p.total)}</td>
                                            <td>${paymentIcon}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                        <button class="btn btn-secondary" onclick="closePurchasesConfirmModal()">
                            ✖️ İptal
                        </button>
                        <button class="btn btn-success" onclick="saveImportedPurchases()" style="font-size: 16px; padding: 12px 30px;">
                            💾 ${importedPurchases.length} Alışı Kaydet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
    
    // Global'e kaydet
    window.tempImportedPurchases = importedPurchases;
}

function closePurchasesConfirmModal() {
    const modal = document.getElementById('purchasesConfirmModal');
    if (modal) {
        modal.remove();
    }
    window.tempImportedPurchases = null;
}

async function saveImportedPurchases() {
    if (!window.tempImportedPurchases || window.tempImportedPurchases.length === 0) {
        alert('❌ Kaydedilecek alış bulunamadı!');
        return;
    }
    
    if (!activeCompanyId || !auth.currentUser) {
        alert('❌ Lütfen giriş yapın!');
        return;
    }
    
    try {
        const batch = db.batch();
        const now = new Date().toISOString();
        let savedCount = 0;
        
        for (const p of window.tempImportedPurchases) {
            const newPurchaseRef = db.collection('companies').doc(activeCompanyId)
                .collection('purchases').doc();
            
            const purchase = {
                id: newPurchaseRef.id,
                companyId: activeCompanyId,
                date: p.date,
                category: p.category,
                description: p.description,
                supplier: p.supplier || '',
                amount: p.amount,
                vatRate: p.vatRate,
                vatAmount: p.vatAmount,
                total: p.total,
                paymentMethod: p.paymentMethod,
                receiptUrl: null,
                createdAt: now,
                createdBy: auth.currentUser.uid
            };
            
            batch.set(newPurchaseRef, purchase);
            purchases.push(purchase);
            savedCount++;
        }
        
        if (savedCount > 0) {
            await batch.commit();
        }
        
        closePurchasesConfirmModal();
        
        await loadPurchases();
        updateDashboard();
        
        alert(`✅ ${savedCount} alış kaydı başarıyla eklendi!`);
        
    } catch (error) {
        console.error('Alış kayıt hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

// ========================================
// TEKLİF DOSYASI YÖNETİMİ FONKSİYONLARI
// ========================================

const TEKLIF_PREFIX = "2025-Ç-";
async function getNextTeklifNo() {
    // Firestore örneği
    const tekliflerRef = firebase.firestore().collection("proposals");
    const snapshot = await tekliflerRef.orderBy("number", "desc").limit(1).get();
    if (snapshot.empty) return TEKLIF_PREFIX + "001";
    const lastNum = snapshot.docs[0].data().number;
    // Son 3 haneyi alıp artır
    let lastSeq = parseInt(lastNum.split("-")[2], 10);
    let nextSeq = (lastSeq + 1).toString().padStart(3, "0");
    return TEKLIF_PREFIX + nextSeq;
}

// Fonksiyon: Teklif modalı açılırken otomatik numara
async function openAddProposalModal() {
    document.getElementById('proposalFormModal').classList.add('active');
    loadCariList();
    clearParametersTable();
    addParameterRow();
    // Otomatik teklif no doldur
    document.getElementById('proposalNumber').value = await getNextTeklifNo();
}

async function saveProposal() {
    try {
        console.log('💾 Teklif kaydediliyor...');
        
        // Teklif verilerini topla
        const teklifData = getTeklifDataFromModal();
        
        // Cari hesap bilgilerini ekle
        const selectedCariId = document.getElementById('proposalCariAccount').value;
        if (!selectedCariId) {
            alert('⚠️ Lütfen cari hesap seçiniz!');
            return;
        }
        
        const cariAccount = accounts.find(a => a.id === selectedCariId);
        if (cariAccount) {
            // ✅ undefined değerleri temizle
            teklifData.cariAccount = {
                id: cariAccount.id,
                name: cariAccount.name || '',
                taxNo: cariAccount.taxNo || '',
                phone: cariAccount.phone || '',
                email: cariAccount.email || '',
                address: cariAccount.address || '',
                contactPerson: cariAccount.contactPerson || '' // ✅ undefined yerine boş string
            };
        }
        
        // Başvuru PDF'i varsa Google Drive'a yükle
        if (currentProposalDocument && gapiInited && gisInited) {
            try {
                console.log('📤 Başvuru PDF Google Drive\'a yükleniyor...');
                const uploadResult = await uploadToGoogleDrive(
                    currentProposalDocument,
                    `basvuru_${teklifData.teklifNo}_${Date.now()}.pdf`,
                    'application/pdf'
                );
                
                teklifData.applicationDocument = {
                    fileId: uploadResult.fileId,
                    viewLink: uploadResult.webViewLink,
                    downloadLink: uploadResult.webContentLink,
                    fileName: currentProposalDocument.name,
                    uploadDate: new Date().toISOString()
                };
                
                console.log('✅ Başvuru PDF yüklendi:', uploadResult.webViewLink);
            } catch (error) {
                console.warn('⚠️ PDF yükleme başarısız, devam ediliyor:', error);
            }
        }
        
// ID yoksa yeni teklif, varsa güncelleme
const proposalId = document.getElementById('proposalId')?.value;
if (!teklifData.id && proposalId) {
    teklifData.id = proposalId; // Düzenleme modu
} else if (!teklifData.id) {
    teklifData.id = Date.now().toString(); // Yeni teklif
    teklifData.createdAt = new Date().toISOString();
    teklifData.createdBy = auth.currentUser.email;
}     

        teklifData.updatedAt = new Date().toISOString();
        teklifData.status = teklifData.status || 'taslak';
        teklifData.companyId = activeCompanyId;
        
        // ✅ Tüm undefined değerleri temizle (Firebase için)
        const cleanData = JSON.parse(JSON.stringify(teklifData, (key, value) => {
            return value === undefined ? null : value;
        }));
        
        // Firestore'a kaydet
        const currentUser = auth.currentUser;
        if (!currentUser) {
            throw new Error('Kullanıcı oturumu bulunamadı');
        }
        
        await db.collection('users')
            .doc(currentUser.uid)
            .collection('proposals')
            .doc(cleanData.id)
            .set(cleanData);
        
        console.log('✅ Teklif Firestore\'a kaydedildi');
        
        // Local array'e ekle/güncelle
        const existingIndex = proposals.findIndex(p => p.id === cleanData.id);
        if (existingIndex >= 0) {
            proposals[existingIndex] = cleanData;
        } else {
            proposals.push(cleanData);
        }
        
        alert('✅ Teklif başarıyla kaydedildi!');
        closeProposalFormModal();
        renderProposalsList();
        
        // Temizlik
        currentProposalDocument = null;
        
    } catch (error) {
        console.error('❌ Teklif kaydetme hatası:', error);
        alert('❌ Teklif kaydedilemedi: ' + error.message);
    }
}

// Teklifleri Firestore'dan yükle
async function loadProposals() {
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            console.log('⚠️ Kullanıcı girişi yok, teklifler yüklenemiyor');
            return;
        }
        
        console.log('🔄 Teklifler Firestore\'dan yükleniyor...');
        
        const snapshot = await db.collection('users')
            .doc(currentUser.uid)
            .collection('proposals')
            .orderBy('createdAt', 'desc') // ✅ En yeni önce
            .get();
        
        proposals = [];
        snapshot.forEach(doc => {
            proposals.push({ id: doc.id, ...doc.data() });
        });
        
        console.log(`✅ ${proposals.length} teklif yüklendi`);
        
        // Tabloyu render et
        renderProposalsList();
        
    } catch (error) {
        console.error('❌ Teklif yükleme hatası:', error);
        
        // Eğer createdAt index yoksa
        if (error.code === 'failed-precondition') {
            console.warn('⚠️ Firestore index oluşturuluyor...');
            // Index olmadan yükle
            const snapshot = await db.collection('users')
                .doc(auth.currentUser.uid)
                .collection('proposals')
                .get();
            
            proposals = [];
            snapshot.forEach(doc => {
                proposals.push({ id: doc.id, ...doc.data() });
            });
            
            console.log(`✅ ${proposals.length} teklif yüklendi (index olmadan)`);
            renderProposalsList();
        }
    }
}

// Teklifleri listele
function renderProposalsList() {
    const tbody = document.querySelector('#proposalsTable tbody');
    if (!tbody) {
        console.warn('⚠️ Teklif tablosu bulunamadı');
        return;
    }
    
    tbody.innerHTML = '';
    
    // Aktif firmaya göre filtrele
    let filteredProposals = proposals;
    if (activeCompanyId) {
        filteredProposals = proposals.filter(p => p.companyId === activeCompanyId);
    }
    
    if (filteredProposals.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px; color:#6b7280;">Henüz teklif kaydı yok</td></tr>';
        return;
    }
    
    filteredProposals.forEach(proposal => {
        const tr = document.createElement('tr');
        
        // Durum badge
        let statusBadge = '';
        switch(proposal.status) {
            case 'taslak':
                statusBadge = '<span style="background:#6b7280; color:white; padding:3px 8px; border-radius:4px; font-size:0.85em;">📝 Taslak</span>';
                break;
            case 'gonderildi':
                statusBadge = '<span style="background:#3b82f6; color:white; padding:3px 8px; border-radius:4px; font-size:0.85em;">📤 Gönderildi</span>';
                break;
            case 'onaylandi':
                statusBadge = '<span style="background:#10b981; color:white; padding:3px 8px; border-radius:4px; font-size:0.85em;">✅ Onaylandı</span>';
                break;
            case 'reddedildi':
                statusBadge = '<span style="background:#ef4444; color:white; padding:3px 8px; border-radius:4px; font-size:0.85em;">❌ Reddedildi</span>';
                break;
            default:
                statusBadge = '<span style="background:#6b7280; color:white; padding:3px 8px; border-radius:4px; font-size:0.85em;">-</span>';
        }
        
        tr.innerHTML = `
            <td>${proposal.teklifNo || '-'}</td>
            <td>${proposal.firmaUnvan || '-'}</td>
            <td>${proposal.basvuruTarihi || '-'}</td>
            <td style="font-weight:bold;">${proposal.genelToplam || '-'}</td>
            <td>${statusBadge}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editProposal('${proposal.id}')" title="Düzenle">
                    ✏️
                </button>
                <button class="btn btn-sm btn-success" onclick="downloadProposalPDF('${proposal.id}')" title="PDF İndir">
                    📥 PDF
                </button>
                ${proposal.applicationDocument ? `
                <button class="btn btn-sm btn-warning" onclick="window.open('${proposal.applicationDocument.viewLink}', '_blank')" title="Başvuru PDF">
                    📄 Başvuru
                </button>
                ` : ''}
                <button class="btn btn-sm btn-secondary" onclick="sendProposalEmail('${proposal.id}')" title="Mail Gönder">
                    📧 Mail
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteProposal('${proposal.id}')" title="Sil">
                    🗑️
                </button>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
    
    console.log(`✅ ${filteredProposals.length} teklif listelendi`);
}

// Teklif düzenle
function editProposal(proposalId) {
    const proposal = proposals.find(p => p.id === proposalId);
    if (!proposal) {
        alert('Teklif bulunamadı!');
        return;
    }
    
    // Teklif formunu aç
    openAddProposalModal();
    
    // Formu doldur
    document.getElementById('proposalNumber').value = proposal.teklifNo || '';
    document.getElementById('proposalApplicationNo').value = proposal.basvuruNo || '';
    document.getElementById('proposalApplicationDate').value = proposal.basvuruTarihi || '';
    
    // Cari seç
    if (proposal.cariAccount && proposal.cariAccount.id) {
        document.getElementById('proposalCariAccount').value = proposal.cariAccount.id;
        fillFromCariAccount(); // Cari bilgilerini doldur
    }
    
    // Firma bilgileri
    document.getElementById('proposalCompany').value = proposal.firmaUnvan || '';
    document.getElementById('proposalAddress').value = proposal.firmaAdres || '';
    document.getElementById('proposalPhone').value = proposal.telefon || '';
    document.getElementById('proposalEmail').value = proposal.mail || '';
    if (document.getElementById('proposalContactPerson')) {
        document.getElementById('proposalContactPerson').value = proposal.cariAccount?.contactPerson || '';
    }
    
    // Teklif içerik bilgileri
    if (document.getElementById('proposalType')) {
        document.getElementById('proposalType').value = proposal.baslikTur || 'Emisyon Ölçümü';
    }
    if (document.getElementById('proposalContent')) {
        document.getElementById('proposalContent').value = proposal.icerik || '';
    }
    if (document.getElementById('proposalPreparedBy')) {
        document.getElementById('proposalPreparedBy').value = proposal.hazirlayan || '';
    }
    if (document.getElementById('proposalContact')) {
        document.getElementById('proposalContact').value = proposal.iletisim || '';
    }
    
    // Parametreleri yükle
    clearParametersTable();
    if (proposal.parameters && proposal.parameters.length > 0) {
        proposal.parameters.forEach(param => {
            addParameterRow({
                name: param.parametre || param.name,
                adet: param.adet,
                price: param.birimFiyat || param.price,
                total: param.toplam || param.total
            });
        });
    } else {
        addParameterRow();
    }
    
    // Tutarlar
    if (document.getElementById('proposalTotal')) {
        document.getElementById('proposalTotal').value = proposal.toplam || '';
    }
    if (document.getElementById('proposalBaseFee')) {
        document.getElementById('proposalBaseFee').value = proposal.tabanFiyat || '';
    }
    if (document.getElementById('proposalDiscountedTotal')) {
        document.getElementById('proposalDiscountedTotal').value = proposal.genelToplam || '';
    }
    if (document.getElementById('proposalNotes')) {
        document.getElementById('proposalNotes').value = proposal.ekNotlar || '';
    }
    
    // ID'yi sakla (güncelleme için)
    if (!document.getElementById('proposalId')) {
        const hiddenId = document.createElement('input');
        hiddenId.type = 'hidden';
        hiddenId.id = 'proposalId';
        document.getElementById('proposalForm').appendChild(hiddenId);
    }
    document.getElementById('proposalId').value = proposal.id;
    
    // Modal başlığını değiştir
    document.getElementById('proposalFormModalTitle').textContent = '✏️ Teklif Düzenle';
    
    console.log('✅ Teklif düzenleme modu açıldı:', proposalId);
}

// Teklif sil
async function deleteProposal(proposalId) {
    if (!confirm('⚠️ Bu teklifi silmek istediğinizden emin misiniz?')) {
        return;
    }
    
    try {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            alert('Kullanıcı oturumu bulunamadı');
            return;
        }
        
        // Google Drive'dan başvuru PDF'ini sil
        const proposal = proposals.find(p => p.id === proposalId);
        if (proposal && proposal.applicationDocument && proposal.applicationDocument.fileId) {
            try {
                await deleteFromGoogleDrive(proposal.applicationDocument.fileId);
                console.log('✅ Başvuru PDF Google Drive\'dan silindi');
            } catch (error) {
                console.warn('⚠️ Google Drive\'dan dosya silinemedi:', error);
            }
        }
        
        // Firestore'dan sil
        await db.collection('users')
            .doc(currentUser.uid)
            .collection('proposals')
            .doc(proposalId)
            .delete();
        
        // Local array'den çıkar
        proposals = proposals.filter(p => p.id !== proposalId);
        
        console.log('✅ Teklif silindi:', proposalId);
        alert('✅ Teklif başarıyla silindi');
        
        renderProposalsList();
        
    } catch (error) {
        console.error('❌ Silme hatası:', error);
        alert('❌ Teklif silinemedi: ' + error.message);
    }
}

// ✅ KAYITLI TEKLİFTEN PDF OLUŞTURMA (Aynı ayarlarla)
async function downloadProposalPDF(proposalId) {
    const proposal = proposals.find(p => p.id === proposalId);
    
    if (!proposal) {
        alert('❌ Teklif bulunamadı!');
        return;
    }
    
    try {
        console.log('📄 PDF oluşturuluyor...');
        
        const teklifData = {
            teklifNo: proposal.teklifNo,
            tarih: proposal.basvuruTarihi || new Date().toLocaleDateString('tr-TR'),
            firmaUnvan: proposal.firmaUnvan,
            firmaAdres: proposal.firmaAdres || '',
            telefon: proposal.telefon || '',
            mail: proposal.mail || '',
            konu: 'MELBES',
            icerik: proposal.icerik || 'İmisyon Ölçümü Fiyat Teklifi',
            baslikTur: proposal.baslikTur || 'Emisyon Ölçümü',
            basvuruNo: proposal.basvuruNo || '',
            hazirlayan: proposal.hazirlayan || 'Göknur YAĞAN',
            iletisim: proposal.iletisim || '0 282 651 46 50',
            parameters: proposal.parameters || [],
            toplam: proposal.toplam || '0,00 TL',
            tabanFiyat: proposal.tabanFiyat || '0,00 TL',
            genelToplam: proposal.genelToplam || '0,00 TL',
            ekNotlar: proposal.ekNotlar || ''
        };
        
        fillPDFTemplate(teklifData);
        
        const element = document.getElementById('pdfTemplate');
        element.style.display = 'block';
        
        // ⏳ DOM'un render olmasını bekle
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // ✅ FİNAL OPTİMİZE PDF AYARLARI
        const opt = {
            margin: 5,  // ✅ 10'dan 5'e düşür - boş sayfaları azalt
            filename: `${teklifData.teklifNo}_Fiyat_Teklifi.pdf`,
            image: { 
                type: 'jpeg', 
                quality: 0.95
            },
            html2canvas: { 
                scale: 1.4,  // ✅ 1.5'ten 1.4'e düşür
                useCORS: true,
                letterRendering: true,
                logging: false,
                scrollY: 0,
                scrollX: 0,
                backgroundColor: '#ffffff',
                onclone: function(clonedDoc) {
                    // ✅ Clone edilen dokümandaki boşlukları kaldır
                    const clonedElement = clonedDoc.getElementById('pdfTemplate');
                    if (clonedElement) {
                        clonedElement.style.padding = '10mm 15mm';
                    }
                }
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait',
                compress: true,
                precision: 2
            },
            pagebreak: { 
                mode: ['css', 'legacy'],
                before: '.pdf-page',
                after: '.pdf-page'
            }
        };
   
        await html2pdf().set(opt).from(element).save();
        
        element.style.display = 'none';
        
        console.log('✅ PDF indirildi');
        
    } catch (error) {
        console.error('❌ PDF oluşturma hatası:', error);
        alert('❌ PDF oluşturulamadı: ' + error.message);
        
        const element = document.getElementById('pdfTemplate');
        if (element) element.style.display = 'none';
    }
}

// Cari hesaptan bilgileri otomatik doldur
function fillFromCariAccount() {
    const cariId = document.getElementById('proposalCariAccount').value;
    
    if (!cariId) {
        // Temizle
        document.getElementById('proposalCompany').value = '';
        document.getElementById('proposalAddress').value = '';
        document.getElementById('proposalPhone').value = '';
        document.getElementById('proposalEmail').value = '';
        if (document.getElementById('proposalContactPerson')) {
            document.getElementById('proposalContactPerson').value = '';
        }
        return;
    }
    
    const cariAccount = accounts.find(a => a.id === cariId);
    if (!cariAccount) {
        console.warn('Cari hesap bulunamadı:', cariId);
        return;
    }
    
    // Bilgileri doldur
    document.getElementById('proposalCompany').value = cariAccount.name || '';
    document.getElementById('proposalAddress').value = cariAccount.address || '';
    document.getElementById('proposalPhone').value = cariAccount.phone || '';
    document.getElementById('proposalEmail').value = cariAccount.email || '';
    if (document.getElementById('proposalContactPerson')) {
        document.getElementById('proposalContactPerson').value = cariAccount.contactPerson || '';
    }
    
    console.log('✅ Cari bilgileri form alanlarına dolduruldu');
}

function selectMatchingParameterInRow(row, parameterName) {
    console.log(`🔍 Eşleştirme arıyor: "${parameterName}"`);
    
    const cells = row.querySelectorAll('td');
    if (cells.length === 0) {
        console.warn('❌ Satırda hücre bulunamadı');
        return false;
    }
    
    const parameterSelect = cells[1]?.querySelector('select');
    if (!parameterSelect) {
        console.warn('❌ Parametre dropdown bulunamadı');
        return false;
    }
    
    const options = Array.from(parameterSelect.options);
    
    // Her seçenek için benzerlik skoru hesapla
    const matches = options.map(option => {
        const optionText = option.text.trim();
        const similarity = calculateSimilarity(parameterName, optionText);
        
        return {
            option: option,
            text: optionText,
            value: option.value,
            similarity: similarity
        };
    }).filter(m => m.similarity >= 70); // %70+ benzerlik
    
    // En yüksek skorlu seçeneği al
    matches.sort((a, b) => b.similarity - a.similarity);
    
    if (matches.length > 0) {
        const bestMatch = matches[0];
        console.log(`✅ En iyi eşleşme: "${bestMatch.text}" (%${bestMatch.similarity.toFixed(1)})`);
        
        parameterSelect.value = bestMatch.value;
        
        // onChange event'ini tetikle
        const event = new Event('change', { bubbles: true });
        parameterSelect.dispatchEvent(event);
        
        return true;
    } else {
        console.warn(`❌ "${parameterName}" için uygun eşleşme bulunamadı (>%70)`);
        return false;
    }
}

function getParametersTableData() {
    const rows = [];
    document.querySelectorAll('#parametersTable tbody tr').forEach(tr => {
        rows.push({
            name: tr.querySelector("select").value,
            adet: tr.querySelector(".param-qty").value,
            price: tr.querySelector(".param-price").value,
            total: tr.querySelector(".param-total").value
        });
    });
    return rows;
}

async function loadProposalsList() {
    const tekliflerRef = firebase.firestore().collection("proposals");
    const snapshot = await tekliflerRef.orderBy("createdAt", "desc").get();
    let tbody = document.querySelector("#proposalsTable tbody");
    tbody.innerHTML = "";
    snapshot.forEach(doc => {
        let d = doc.data();
        let tr = document.createElement("tr");
        tr.innerHTML = `<td>${d.number}</td><td>${d.company}</td><td>${d.applicationDate}</td><td>${d.discountedTotal}</td><td>Hazırlandı</td><td></td>`;
        tbody.appendChild(tr);
    });
}

async function uploadPDF(file, teklifNo) {
    const storageRef = firebase.storage().ref();
    const pdfRef = storageRef.child(`teklifler/${teklifNo}.pdf`);
    await pdfRef.put(file);
    const downloadURL = await pdfRef.getDownloadURL();
    return downloadURL;
}

// Modalden tüm teklif verilerini topla
function getTeklifDataFromModal() {
    console.log('🚀 getTeklifDataFromModal çalıştırılıyor...');
    
    const teklifData = {
        teklifNo: document.getElementById('proposalNumber')?.value || '',
        tarih: new Date().toLocaleDateString('tr-TR'),
        basvuruNo: document.getElementById('proposalApplicationNo')?.value || '',
        firmaUnvan: document.getElementById('proposalCompany')?.value || '',
        firmaAdres: document.getElementById('proposalAddress')?.value || '',
        telefon: document.getElementById('proposalPhone')?.value || '-',
        mail: document.getElementById('proposalEmail')?.value || '-',
        konu: 'MELBES',
        icerik: document.getElementById('proposalContent')?.value || 'İmisyon Ölçümü Fiyat Teklifi',
        baslikTur: document.getElementById('proposalType')?.value || 'Emisyon Ölçümü',
        hazirlayan: document.getElementById('proposalPreparedBy')?.value || 'Göknur YAĞAN',
        iletisim: document.getElementById('proposalContact')?.value || '0 282 651 46 50',
        parameters: [],
        toplam: document.getElementById('proposalTotal')?.value || '0,00 TL',
        tabanFiyat: document.getElementById('proposalBaseFee')?.value || '0,00 TL',
        genelToplam: document.getElementById('proposalDiscountedTotal')?.value || '0,00 TL',
        ekNotlar: document.getElementById('proposalNotes')?.value || ''
    };
    
    console.log('🔍 Tabloyu arıyorum...');
    
    const allTables = document.querySelectorAll('table');
    console.log(`📊 Sayfada ${allTables.length} tablo bulundu`);
    
    let targetTable = null;
    
    // Parametreler tablosunu bul
    for (let table of allTables) {
        const deleteButtons = table.querySelectorAll('button[onclick*="deleteProposalParameter"]');
        if (deleteButtons.length > 0) {
            targetTable = table;
            console.log('✅ Parametreler tablosu bulundu! (Sil butonundan tanındı)');
            break;
        }
    }
    
    if (!targetTable) {
        for (let table of allTables) {
            const headers = table.querySelectorAll('th');
            for (let th of headers) {
                if (th.textContent.includes('Kaynak Adı') || th.textContent.includes('Parametre')) {
                    targetTable = table;
                    console.log('✅ Parametreler tablosu bulundu! (Başlıktan tanındı)');
                    break;
                }
            }
            if (targetTable) break;
        }
    }
    
    if (!targetTable) {
        console.error('❌ Parametreler tablosu bulunamadı!');
        return teklifData;
    }
    
    const tbody = targetTable.querySelector('tbody');
    if (!tbody) {
        console.error('❌ tbody bulunamadı!');
        return teklifData;
    }
    
    const rows = tbody.querySelectorAll('tr');
    console.log(`📊 Tabloda ${rows.length} satır bulundu`);
    
// Her satırı oku kısmında değişiklik
rows.forEach((row, index) => {
    const cells = row.querySelectorAll('td');
    console.log(`\n--- SATIR ${index + 1} (${cells.length} hücre) ---`);
    
    if (cells.length >= 4) { // 4 hücre yeterli
        const getValue = (cell) => {
            if (!cell) return '';
            
            const input = cell.querySelector('input');
            const select = cell.querySelector('select');
            
            if (input) {
                return input.value;
            } else if (select) {
                return select.options[select.selectedIndex]?.text || select.value;
            } else {
                return cell.textContent.trim();
            }
        };
        
        // DOĞRU SIRALAMA
const param = {
    kaynakAdi: '', // Boş - tabloda yok
    parametre: getValue(cells[0]), // Hücre 0 = Parametre adı (Formaldehit, PAH vs.)
    standart: '', // Standart bilgisi yok
    adet: getValue(cells[1]), // Hücre 1 = Adet
    birimFiyat: getValue(cells[2]), // Hücre 2 = Birim Fiyat
    toplam: getValue(cells[3]) // Hücre 3 = Toplam
};
        
        console.log(`  📦 Parametre:`, param);
        
        // "Sil" butonunu atla
        if (param.parametre && 
            param.parametre.trim() !== '' && 
            param.parametre !== 'Sil' &&
            param.parametre !== 'Seçiniz') {
            
            teklifData.parameters.push(param);
            console.log(`  ✅ Eklendi!`);
        }
    }
});

    console.log('\n📋 SONUÇ:');
    console.log('Teklif Verileri:', teklifData);
    console.log('📊 Toplam Parametre:', teklifData.parameters.length);
    
    if (teklifData.parameters.length === 0) {
        console.error('❌ HİÇ PARAMETRE BULUNAMADI!');
    }
    
    return teklifData;
}

// PDF Template'ine verileri doldur
function fillPDFTemplate(teklifData) {
    console.log('🔄 PDF Template dolduruluyor...');
    
    // 1. Teklif No ve Tarih
    document.getElementById('pdf-teklif-no').textContent = teklifData.teklifNo;
    document.getElementById('pdf-tarih').textContent = teklifData.tarih;
    
    document.querySelectorAll('.pdf-teklif-no-copy').forEach(el => {
        el.textContent = teklifData.teklifNo;
    });
    document.querySelectorAll('.pdf-tarih-copy').forEach(el => {
        el.textContent = teklifData.tarih;
    });
    
    // 2. Sayfa 1: Kapak
    document.getElementById('pdf-firma-unvan').textContent = teklifData.firmaUnvan;
    document.getElementById('pdf-firma-adres').textContent = teklifData.firmaAdres;
    document.getElementById('pdf-telefon').textContent = teklifData.telefon;
    document.getElementById('pdf-mail').textContent = teklifData.mail;
    document.getElementById('pdf-konu').textContent = teklifData.konu;
    document.getElementById('pdf-icerik').textContent = teklifData.icerik;
    document.getElementById('pdf-basvuru-no').textContent = teklifData.basvuruNo;
    document.getElementById('pdf-hazirlayan').textContent = teklifData.hazirlayan;
    document.getElementById('pdf-iletisim').textContent = teklifData.iletisim;
    
    // 3. Sayfa 2: Başlık ve Tablo
    document.getElementById('pdf-baslik-tur').textContent = teklifData.baslikTur;
    
    // Parametreler tablosunu doldur
    const tableBody = document.querySelector('#pdf-parameters-table tbody');
    
    if (tableBody && teklifData.parameters.length > 0) {
        console.log(`📊 ${teklifData.parameters.length} parametre ekleniyor...`);
        
        let tableHTML = '';
        teklifData.parameters.forEach((p, index) => {
            tableHTML += `
    <tr>
        <td>${p.kaynakAdi || 'Tesis Geneli'}</td>
        <td>${p.parametre || ''}</td>
        <td>${p.standart || '-'}</td>
        <td style="text-align: center;">${p.adet || ''}</td>
        <td style="text-align: right;">${p.birimFiyat || ''}</td>
        <td style="text-align: right;">${p.toplam || ''}</td>
    </tr>
            `;
            console.log(`  ✓ Parametre ${index + 1}: ${p.parametre}`);
        });
        
        tableBody.innerHTML = tableHTML;
        console.log('✅ Tablo dolduruldu!');
    } else {
        console.warn('⚠️ Parametre bulunamadı!');
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Parametre eklenmemiş</td></tr>';
    }
    
    // 4. Tutarlar
    document.getElementById('pdf-toplam').textContent = teklifData.toplam;
    document.getElementById('pdf-taban-fiyat').textContent = teklifData.tabanFiyat;
    document.getElementById('pdf-genel-toplam').textContent = teklifData.genelToplam;
    
    // 5. Ek Notlar
    const ekNotlarEl = document.getElementById('pdf-ek-notlar');
    if (ekNotlarEl && teklifData.ekNotlar) {
        ekNotlarEl.textContent = '- ' + teklifData.ekNotlar;
    }
    
    console.log('✅ Template doldurma tamamlandı!');
}

// ✅ TAM DÜZELTİLMİŞ PDF OLUŞTURMA FONKSİYONU
async function createProfessionalTeklifPDF() {
    try {
        console.log('🚀 PDF oluşturma başlatılıyor...');
        
        // 1. Verileri topla
        const teklifData = getTeklifDataFromModal();
        
        // Veri kontrolü
        if (!teklifData.teklifNo) {
            alert('⚠️ Lütfen Teklif No giriniz!');
            return;
        }
        
        if (teklifData.parameters.length === 0) {
            alert('⚠️ Lütfen en az 1 parametre ekleyiniz!');
            return;
        }
        
        // 2. Template'i doldur
        fillPDFTemplate(teklifData);
        
        // 3. PDF Template elementini al
        const element = document.getElementById('pdfTemplate');
        
        if (!element) {
            alert('❌ PDF Template bulunamadı!');
            return;
        }
        
        // 4. Geçici olarak göster
        element.style.display = 'block';
        
        // ⏳ DOM'un render olmasını bekle
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // ✅ 5. OPTİMİZE EDİLMİŞ PDF AYARLARI
        const opt = {
            margin: 5,  // ✅ 10mm kenar boşluğu (0 yerine)
            filename: `${teklifData.teklifNo}_Fiyat_Teklifi.pdf`,
            image: { 
                type: 'jpeg', 
                quality: 0.95  // ✅ 0.98'den 0.95'e düşür (daha küçük dosya)
            },
            html2canvas: { 
                scale: 1.4,  // ✅ 2'den 1.5'e düşür (çok büyük olmasın)
                useCORS: true,
                letterRendering: true,
                logging: false,
                // ❌ windowWidth ve windowHeight KALDIRILDI
                // Bunlar içeriği zorla boyutlandırıyor!
                scrollY: 0,
                scrollX: 0,
                backgroundColor: '#ffffff',
		onclone: function(clonedDoc) {
                   			 // ✅ Clone edilen dokümandaki boşlukları kaldır
                    			 const clonedElement = clonedDoc.getElementById('pdfTemplate');
                   			  if (clonedElement) {
                       			  clonedElement.style.padding = '10mm 15mm';
                   			 }
                		  }
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait',
                compress: true,
                precision: 2  // ✅ Hassasiyet ekle
            },
            pagebreak: { 
                mode: ['css', 'legacy'],  // ✅ 'legacy' geri ekle
                before: '.pdf-page',
                after: '.pdf-page'
                // ❌ 'avoid' parametresi KALDIRILDI (sorun yaratıyor)
            }
        };
        
        console.log('📄 PDF oluşturuluyor...');
        
        // 6. PDF Oluştur
        await html2pdf().set(opt).from(element).save();
        
        // 7. Template'i tekrar gizle
        element.style.display = 'none';
        
        console.log('✅ PDF başarıyla oluşturuldu!');
        alert('✅ PDF başarıyla indirildi!');
        
    } catch (error) {
        console.error('❌ PDF oluşturma hatası:', error);
        alert('❌ PDF oluşturulamadı: ' + error.message);
        
        // Hata durumunda template'i gizle
        const element = document.getElementById('pdfTemplate');
        if (element) element.style.display = 'none';
    }
}

// ========================================
// CARİ HESAP EXCEL/CSV IMPORT FONKSİYONLARI
// ========================================

function openImportAccountsModal() {
    if (!activeCompanyId) {
        alert('⚠️ Lütfen önce bir firma seçin!');
        return;
    }

    const modalHtml = `
        <div class="modal active" id="accountsImportModal" style="display: flex;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>📤 Cari Hesapları Excel/CSV'den Ekle</h3>
                    <button class="close-modal" onclick="closeImportAccountsModal()">✖</button>
                </div>
                <div style="padding: 30px;">
                    <div class="alert alert-info">
                        <strong>📋 Format:</strong> Sadece 1 sütun yeterli!
                        <p style="margin: 10px 0 0 0; font-size: 0.95em;">
                            <b>Başlık:</b> Cari Adı veya Alıcı Adı<br>
                            <b>Örnek:</b>
                            <br>
                            <code>
Cari Adı<br>
BORAY PLASTİK VE AMBALAJ SAN.LTD.ŞTİ.<br>
YILPLAST PLASTİK SANAYİ VE DIŞ TİC.LTD.ŞTİ.<br>
ZET LOJİSTİK HAZIR BETON SANAYİ VE TİCARET ANONİM ŞİRKETİ
                            </code>
                        </p>
                    </div>
                    <div class="file-upload-area" 
                         onclick="document.getElementById('accountsExcelFile').click()" 
                         style="cursor: pointer; margin-bottom: 20px;">
                        <h3>📂 CSV/Excel Dosyasını Yükle</h3>
                        <p style="margin: 10px 0; color: #6b7280;">Dosyanızı sürükleyin veya tıklayın</p>
                        <input type="file" 
                               id="accountsExcelFile" 
                               accept=".csv" 
                               style="display:none;" 
                               onchange="processAccountsExcel(event)">
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeImportAccountsModal()">
                            ✖️ İptal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closeImportAccountsModal() {
    const modal = document.getElementById('accountsImportModal');
    if (modal) {
        modal.remove();
    }
}

async function processAccountsExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    try {
        await saveImportedFileToStorage(file, "accounts");
    } catch (err) {
        console.error("Cari dosya kaydedilemedi:", err);
    }
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            parseAccountsCSV(e.target.result);
        } catch (err) {
            console.error("Cari dosya parse hatası:", err);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

function parseAccountsCSV(content) {
    const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);

    // Ayraç algıla (virgül veya noktalı virgül veya tab)
    let delimiter = ',';
    if (lines[0].includes(';')) delimiter = ';';
    if (lines[0].includes('\t')) delimiter = '\t';

    // Başlık kontrolü
    const header = lines[0].toLowerCase();
    if (!header.includes('cari') && !header.includes('alıcı')) {
        alert('⚠️ İlk satır başlık olmalı: "Cari Adı" veya "Alıcı Adı"');
        return;
    }

    let importedAccounts = [];
    let errorCount = 0;

    for (let i = 1; i < lines.length; i++) {
        let name = lines[i].split(delimiter)[0]?.trim();
        if (!name || name.length < 3) { errorCount++; continue; }
        // Aynı isim varsa atla
        if (accounts.some(acc => acc.name.trim().toLowerCase() === name.toLowerCase() && acc.companyId === activeCompanyId)) {
            errorCount++;
            continue;
        }
        importedAccounts.push({
            id: Date.now().toString() + '_' + i + '_' + Math.random(),
            companyId: activeCompanyId,
            name: name,
            type: 'customer', // default: müşteri, istenirse seçilebilir!
            balance: 0,
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser ? auth.currentUser.uid : 'unknown'
        });
    }

    showAccountsConfirmModal(importedAccounts, errorCount);
}

function showAccountsConfirmModal(importedAccounts, errorCount) {
    closeImportAccountsModal();
    const summaryHtml = errorCount > 0 
        ? `<div class="alert alert-warning">
            <strong>⚠️ ${errorCount} satır hatalı veya tekrar olduğu için atlandı!</strong>
           </div>`
        : '';
    const modalHtml = `
        <div class="modal active" id="accountsConfirmModal" style="display: flex;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>✅ Cari Hesapları Onaylayın (${importedAccounts.length} Kayıt)</h3>
                    <button class="close-modal" onclick="closeAccountsConfirmModal()">✖</button>
                </div>
                <div style="padding: 20px;">
                    ${summaryHtml}
                    <div class="alert alert-success">
                        <strong>📊 Toplam ${importedAccounts.length} cari hesap eklenecek</strong>
                    </div>
                    <ul style="max-height:300px;overflow:auto;">
                        ${importedAccounts.map(acc => `<li>${acc.name}</li>`).join('')}
                    </ul>
                    <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                        <button class="btn btn-secondary" onclick="closeAccountsConfirmModal()">
                            ✖️ İptal
                        </button>
                        <button class="btn btn-success" onclick="saveImportedAccounts()" style="font-size: 16px; padding: 12px 30px;">
                            💾 Cari Hesapları Kaydet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);

    window.tempImportedAccounts = importedAccounts;
}

function closeAccountsConfirmModal() {
    const modal = document.getElementById('accountsConfirmModal');
    if (modal) {
        modal.remove();
    }
    window.tempImportedAccounts = null;
}

// ===============================
// CSV'den cari (hesap) import işlemi
// ===============================

async function saveImportedAccounts() {
    // Doğru dizi: window.tempImportedAccounts
    const accountsToSave = window.tempImportedAccounts;
    if (!accountsToSave || accountsToSave.length === 0) {
        alert('❌ Kaydedilecek cari hesap yok!');
        return;
    }
    if (!activeCompanyId) {
        alert('❌ Lütfen bir firma seçin!');
        return;
    }
    if (!auth.currentUser) {
        alert('❌ Lütfen giriş yapın!');
        return;
    }

    // Firebase'den güncel carileri çek!
    await loadAccounts();

    // Unique key algoritmasını kullan
    const existingKeys = accounts.map(getAccountUniqueKey);
    const filteredAccounts = [];
    let skippedCount = 0;

    accountsToSave.forEach(acc => {
        const accKey = getAccountUniqueKey(acc);
        if (existingKeys.includes(accKey)) {
            skippedCount++;
        } else {
            filteredAccounts.push(acc);
            existingKeys.push(accKey);
        }
    });

    if (filteredAccounts.length === 0) {
        alert(`⚠️ Tüm cari hesaplar zaten kayıtlı, yeni hesap eklenmedi.`);
        return;
    }

    // Firebase batch ile ekle
    const batch = db.batch();
    const now = new Date().toISOString();
    filteredAccounts.forEach(acc => {
        const accountRef = db.collection('companies').doc(activeCompanyId)
            .collection('accounts').doc();
        const accountData = {
            id: accountRef.id,
            companyId: activeCompanyId,
            name: acc.name,
            taxNo: acc.taxNo || "",
            type: acc.type || "customer",
            address: acc.address || "",
            phone: acc.phone || "",
            email: acc.email || "",
            balance: 0,
            createdAt: now,
            createdBy: auth.currentUser.uid
        };
        batch.set(accountRef, accountData);
        accounts.push(accountData);
    });

    await batch.commit();
    await loadAccounts();
    updateDashboard();

    alert(`✅ ${filteredAccounts.length} yeni cari hesap eklendi\n⚠️ ${skippedCount} cari zaten vardı, atlandı!`);

    // Modalı kapat
    closeAccountsConfirmModal();
}

// 1. Excel'den gelen carileri modalda önizle
async function openCariImportModal(importedAccounts) {
    await loadAccounts(); // Firebase'den güncel veri
    const existingKeys = accounts.map(getAccountUniqueKey);
    window.filteredAccounts = [];
    let skippedCount = 0;

    importedAccounts.forEach(acc => {
        const accKey = getAccountUniqueKey(acc);
        if (existingKeys.includes(accKey)) {
            skippedCount++;
        } else {
            window.filteredAccounts.push(acc);
            existingKeys.push(accKey);
        }
    });

    // Modalı aç, window.filteredAccounts'u UI'da göster
}

// Yönetici panelinde izin taleplerini listele
function loadLeaveRequestsAdminPanel() {
    const tbody = document.getElementById('adminLeaveRequestsTableBody');
    tbody.innerHTML = '';
    if (!leaveRequests || leaveRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Henüz izin talebi yok.</td></tr>';
        return;
    }
    leaveRequests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    leaveRequests.forEach(lr => {
        const person = personnel.find(p => p.id === lr.personnelId);
        const statusColor =
            lr.status === "approved" ? "success" :
            lr.status === "rejected" ? "danger" : "warning";
        const statusLabel =
            lr.status === "approved" ? "Onaylandı" :
            lr.status === "rejected" ? "Reddedildi" : "Beklemede";
        tbody.innerHTML += `
            <tr>
                <td>${person ? person.name : 'Bilinmiyor'}</td>
                <td>${formatDate(lr.startDate)} - ${formatDate(lr.endDate)}</td>
                <td>${getLeaveTypeLabel(lr.type)}</td>
                <td>${lr.description || '-'}</td>
                <td><span class="badge badge-${statusColor}">${statusLabel}</span></td>
                <td>${lr.approvedBy || lr.rejectedBy || '-'}</td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="showLeaveDetailModal('${lr.id}')">Detay/Çıktı</button>
                </td>
                <td>
                    ${lr.status === "pending"
                        ? `<button class="btn btn-success btn-sm" onclick="approveLeaveRequest('${lr.id}')">Onayla</button>
                           <button class="btn btn-danger btn-sm" onclick="rejectLeaveRequest('${lr.id}')">Reddet</button>`
                        : ''
                    }
                </td>
            </tr>
        `;
    });
}
function getLeaveTypeLabel(type) {
    switch(type) {
        case "annual": return "Yıllık İzin";
        case "sick": return "Hastalık İzni";
        case "unpaid": return "Ücretsiz İzin";
        default: return "Diğer";
    }
}


// İzin detay modalı ve çıktı alma
function showLeaveDetailModal(id) {
    const lr = leaveRequests.find(l => l.id === id);
    if (!lr) return;
    const person = personnel.find(p => p.id === lr.personnelId);
    const statusLabel = lr.status === "approved" ? "Onaylandı" : lr.status === "rejected" ? "Reddedildi" : "Beklemede";
    const approveInfo = lr.status === "approved"
        ? `<strong>Onaylayan:</strong> ${lr.approvedBy}<br><strong>Onay Tarihi:</strong> ${formatDate(lr.approvedAt)}`
        : lr.status === "rejected"
        ? `<strong>Reddeden:</strong> ${lr.rejectedBy}<br><strong>Red Tarihi:</strong> ${formatDate(lr.rejectedAt)}`
        : '';
    const modalHtml = `
        <div id="leaveDetailModal" class="modal active" style="display:flex;">
            <div class="modal-content" style="max-width:600px;">
                <div class="modal-header">
                    <h3>İzin Talebi Detayı ve Çıktısı</h3>
                    <button class="close-modal" onclick="closeLeaveDetailModal()">✖</button>
                </div>
                <div style="padding:20px;">
                    <table style="width:100%;margin-bottom:15px;">
                        <tr><td><strong>Personel:</strong></td><td>${person ? person.name : 'Bilinmiyor'}</td></tr>
                        <tr><td><strong>İzin Tipi:</strong></td><td>${getLeaveTypeLabel(lr.type)}</td></tr>
                        <tr><td><strong>Başlangıç Tarihi:</strong></td><td>${formatDate(lr.startDate)}</td></tr>
                        <tr><td><strong>Bitiş Tarihi:</strong></td><td>${formatDate(lr.endDate)}</td></tr>
                        <tr><td><strong>Açıklama:</strong></td><td>${lr.description || '-'}</td></tr>
                        <tr><td><strong>Durum:</strong></td><td>${statusLabel}</td></tr>
                        <tr><td colspan="2">${approveInfo}</td></tr>
                    </table>
                    <div style="margin:30px 0 10px 0;text-align:center;">
                        <strong>İmza:</strong>
                        <div style="border-bottom:1px solid #888;width:220px;margin:12px auto 0 auto;height:32px;"></div>
                    </div>
                    <div style="text-align:center;">
                        <button class="btn btn-success" onclick="printLeaveDetail('${lr.id}')">🖨️ Çıktı Al</button>
                        <button class="btn btn-secondary" onclick="closeLeaveDetailModal()">Kapat</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    // Modal ekle
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}
function closeLeaveDetailModal() {
    const modal = document.getElementById('leaveDetailModal');
    if (modal) modal.remove();
}
function printLeaveDetail(id) {
    const lr = leaveRequests.find(l => l.id === id);
    if (!lr) return;
    const person = personnel.find(p => p.id === lr.personnelId);
    const statusLabel = lr.status === "approved" ? "Onaylandı" : lr.status === "rejected" ? "Reddedildi" : "Beklemede";
    const approveInfo = lr.status === "approved"
        ? `Onaylayan: ${lr.approvedBy}\nOnay Tarihi: ${formatDate(lr.approvedAt)}`
        : lr.status === "rejected"
        ? `Reddeden: ${lr.rejectedBy}\nRed Tarihi: ${formatDate(lr.rejectedAt)}`
        : '';
    const printHtml = `
        <html>
        <head>
            <title>İzin Talebi Çıktısı</title>
            <meta charset="UTF-8">
            <style>
                body {font-family:Arial;padding:40px;}
                .header {font-size:1.6em;font-weight:700;margin-bottom:20px;}
                table {width:100%;margin-bottom:20px;}
                td {padding:6px;}
                .imza {margin-top:30px;}
                @media print {button {display:none !important;}}
            </style>
        </head>
        <body>
            <div class="header">İzin Talebi Formu</div>
            <table>
                <tr><td><strong>Personel:</strong></td><td>${person ? person.name : 'Bilinmiyor'}</td></tr>
                <tr><td><strong>İzin Tipi:</strong></td><td>${getLeaveTypeLabel(lr.type)}</td></tr>
                <tr><td><strong>Başlangıç Tarihi:</strong></td><td>${formatDate(lr.startDate)}</td></tr>
                <tr><td><strong>Bitiş Tarihi:</strong></td><td>${formatDate(lr.endDate)}</td></tr>
                <tr><td><strong>Açıklama:</strong></td><td>${lr.description || '-'}</td></tr>
                <tr><td><strong>Durum:</strong></td><td>${statusLabel}</td></tr>
                <tr><td colspan="2">${approveInfo}</td></tr>
            </table>
            <div class="imza">
                <strong>İmza:</strong>
                <div style="border-bottom:1.5px solid #444;width:240px;height:32px;margin-top:20px;"></div>
            </div>
            <div style="text-align:center;margin-top:24px;">
                <button onclick="window.print()" style="padding:12px 40px;font-size:1.2em;">🖨️ Yazdır</button>
                <button onclick="window.close()" style="padding:12px 40px;font-size:1.2em;margin-left:12px;">Kapat</button>
            </div>
        </body>
        </html>
    `;
    const win = window.open('', 'İzinTalebi', 'width=800,height=600');
    win.document.write(printHtml);
}

// Personel paneli için erişim (örnek, sistemde oturum yoksa basit bir modal ile açılabilir)
function openPersonnelLeavePanel(personnelId) {
    // Sadece kendi izinleri ve talep formu gösterilecek
    const myLeaves = leaveRequests.filter(lr => lr.personnelId === personnelId);
    let leavesHtml = myLeaves.length === 0
        ? '<tr><td colspan="6" style="text-align:center;">Henüz talep yok.</td></tr>'
        : myLeaves.map(lr => `
            <tr>
                <td>${getLeaveTypeLabel(lr.type)}</td>
                <td>${formatDate(lr.startDate)} - ${formatDate(lr.endDate)}</td>
                <td>${lr.description || '-'}</td>
                <td><span class="badge badge-${lr.status === "approved" ? "success" : lr.status === "rejected" ? "danger" : "warning"}">
                    ${lr.status === "approved" ? "Onaylandı" : lr.status === "rejected" ? "Reddedildi" : "Beklemede"}
                </span></td>
                <td>${lr.approvedBy || lr.rejectedBy || '-'}</td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="showLeaveDetailModal('${lr.id}')">Detay/Çıktı</button>
                </td>
            </tr>
        `).join('');
    const modalHtml = `
        <div id="personnelLeavePanelModal" class="modal active" style="display:flex;">
            <div class="modal-content" style="max-width:700px;">
                <div class="modal-header">
                    <h3>👤 Personel İzin Paneli</h3>
                    <button class="close-modal" onclick="closePersonnelLeavePanelModal()">✖</button>
                </div>
                <div style="padding:20px;">
                    <h4>İzin Taleplerim</h4>
                    <table style="width:100%;margin-bottom:15px;">
                        <tr>
                            <th>Tip</th><th>Tarih</th><th>Açıklama</th><th>Durum</th><th>Onaylayan</th><th>Detay</th>
                        </tr>
                        ${leavesHtml}
                    </table>
                    <hr>
                    <h4>Yeni İzin Talebi Oluştur</h4>
                    <form onsubmit="submitPersonnelLeaveRequest(event, '${personnelId}')">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                            <div>
                                <label>Tip</label>
                                <select name="leaveType" required>
                                    <option value="">Seçiniz</option>
                                    <option value="annual">Yıllık</option>
                                    <option value="sick">Hastalık</option>
                                    <option value="unpaid">Ücretsiz</option>
                                    <option value="other">Diğer</option>
                                </select>
                            </div>
                            <div>
                                <label>Başlangıç</label>
                                <input type="date" name="leaveStartDate" required>
                            </div>
                            <div>
                                <label>Bitiş</label>
                                <input type="date" name="leaveEndDate" required>
                            </div>
                            <div>
                                <label>Açıklama</label>
                                <input type="text" name="leaveDescription">
                            </div>
                        </div>
                        <div style="margin-top:20px;text-align:right;">
                            <button type="submit" class="btn btn-primary">Talep Oluştur</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}
function closePersonnelLeavePanelModal() {
    const modal = document.getElementById('personnelLeavePanelModal');
    if (modal) modal.remove();
}
function submitPersonnelLeaveRequest(event, personnelId) {
    event.preventDefault();
    const form = event.target;
    const leaveType = form.leaveType.value;
    const leaveStartDate = form.leaveStartDate.value;
    const leaveEndDate = form.leaveEndDate.value;
    const leaveDescription = form.leaveDescription.value;
    if (!leaveType || !leaveStartDate || !leaveEndDate) {
        alert("Eksik bilgi!");
        return;
    }
    leaveRequests.push({
        id: Date.now().toString(),
        personnelId: personnelId,
        type: leaveType,
        startDate: leaveStartDate,
        endDate: leaveEndDate,
        description: leaveDescription,
        status: "pending",
        approvedBy: "",
        approvedAt: "",
        rejectedBy: "",
        rejectedAt: "",
        createdAt: new Date().toISOString()
    });
    localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
    closePersonnelLeavePanelModal();
    alert("İzin talebi oluşturuldu. Yönetici onayını bekleyin.");
}

// ========================================
// PERSONEL FONKSİYONLARI
// ========================================

function openAddPersonnelModal() {
    document.getElementById('personnelForm').reset();
    document.getElementById('personnelId').value = '';
    document.getElementById('personnelFormModalTitle').textContent = '➕ Yeni Personel Ekle';
    document.getElementById('personnelFormModal').classList.add('active');
}

function closePersonnelFormModal() {
    document.getElementById('personnelFormModal').classList.remove('active');
}

async function savePersonnel(e) {
    e.preventDefault();
    
    if (!activeCompanyId) {
        alert('⚠️ Lütfen önce bir firma seçin!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    const personnelId = document.getElementById('personnelId').value;
    const now = new Date().toISOString();
    
    try {
        const personnelData = {
            companyId: activeCompanyId,  // ✅ EKLE
            name: document.getElementById('personnelName').value,
            tcNo: document.getElementById('personnelTCNo').value,
            position: document.getElementById('personnelPosition').value,
            phone: document.getElementById('personnelPhone').value,
            salary: parseFloat(document.getElementById('personnelSalary').value),
            sgkRate: parseFloat(document.getElementById('personnelSGKRate').value),
            startDate: document.getElementById('personnelStartDate').value,
            status: document.getElementById('personnelStatus').value,
            address: document.getElementById('personnelAddress').value,
            updatedAt: now,
            updatedBy: auth.currentUser.uid
        };
        
        if (personnelId) {
            // Update
            await db.collection('companies').doc(activeCompanyId)
                .collection('personnel').doc(personnelId).update(personnelData);
            
            const person = personnel.find(p => p.id === personnelId);
            Object.assign(person, personnelData);
            
        } else {
            // Create
            personnelData.createdAt = now;
            personnelData.createdBy = auth.currentUser.uid;
            
            const newPersonnelRef = db.collection('companies').doc(activeCompanyId)
                .collection('personnel').doc();
            personnelData.id = newPersonnelRef.id;
            
            await newPersonnelRef.set(personnelData);
            personnel.push(personnelData);  // ✅ Local array'e ekle
        }
        
        closePersonnelFormModal();
        
        // ✅ RENDER FONKSİYONLARINI ÇAĞIR
        await loadPersonnel();
        renderPersonnelTable();  // ✅ EKLE
        populatePersonnelSelects();  // ✅ EKLE
        populateYearPersonnelSelect();  // ✅ EKLE (yıllık tablo için)
        updatePersonnelStats();
        
        alert('✅ Personel kaydedildi!');
        
    } catch (error) {
        console.error('Personel kayıt hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

async function loadPersonnel() {
    if (!activeCompanyId || !auth.currentUser) {
        personnel = [];
        renderPersonnelTable();
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('personnel').get();
        
        personnel = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            personnel.push({ 
                id: doc.id, 
                ...data,
                companyId: data.companyId || activeCompanyId  // ✅ Fallback
            });
        });
        
        console.log('✅ Personel yüklendi:', personnel.length);
        
    } catch (error) {
        console.error('❌ Personel yükleme hatası:', error);
        personnel = [];
    }
    
    renderPersonnelTable();  // ✅ EKLE
    populatePersonnelSelects();  // ✅ EKLE
}

async function loadAttendanceRecords() {
    if (!activeCompanyId || !auth.currentUser) {
        attendanceRecords = [];
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('attendance').get();
        
        attendanceRecords = [];
        snapshot.forEach(doc => {
            attendanceRecords.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('✅ Devamsızlık kayıtları yüklendi:', attendanceRecords.length);
        
    } catch (error) {
        console.error('❌ Devamsızlık yükleme hatası:', error);
        attendanceRecords = [];
    }
}

async function loadLeaveRequests() {
    if (!activeCompanyId || !auth.currentUser) {
        leaveRequests = [];
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('leaveRequests').get();
        
        leaveRequests = [];
        snapshot.forEach(doc => {
            leaveRequests.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('✅ İzin talepleri yüklendi:', leaveRequests.length);
        
    } catch (error) {
        console.error('❌ İzin talebi yükleme hatası:', error);
        leaveRequests = [];
    }
}

function editPersonnel(id) {
    const person = personnel.find(p => p.id === id);
    if (!person) return;
    
    document.getElementById('personnelId').value = person.id;
    document.getElementById('personnelName').value = person.name;
    document.getElementById('personnelTCNo').value = person.tcNo;
    document.getElementById('personnelPosition').value = person.position;
    document.getElementById('personnelPhone').value = person.phone || '';
    document.getElementById('personnelSalary').value = person.salary;
    document.getElementById('personnelSGKRate').value = person.sgkRate;
    document.getElementById('personnelStartDate').value = person.startDate;
    document.getElementById('personnelStatus').value = person.status;
    document.getElementById('personnelAddress').value = person.address || '';
    
    document.getElementById('personnelFormModalTitle').textContent = '✏️ Personel Düzenle';
    document.getElementById('personnelFormModal').classList.add('active');
}

async function deletePersonnel(id) {
    if (!confirm('Bu personeli silmek istediğinizden emin misiniz?')) return;
    
    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    try {
        await db.collection('companies').doc(activeCompanyId)
            .collection('personnel').doc(id).delete();
        
        personnel = personnel.filter(p => p.id !== id);
        
        await loadPersonnel();
        populatePersonnelSelects();
        updatePersonnelStats();
        
        alert('✅ Personel silindi!');
        
    } catch (error) {
        console.error('Personel silme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

function populatePersonnelSelects() {
    const selectIds = [
        'attendancePersonnelSelect',
        'salaryPersonnelSelect',
        'yearPersonnelSelect'
    ];
    
    selectIds.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) {
            console.warn(`${selectId} elementi bulunamadı!`);
            return;
        }
        
        // İlk seçeneği koru
        const firstOption = select.querySelector('option:first-child');
        const firstOptionHtml = firstOption ? firstOption.outerHTML : '<option value="">Seçiniz</option>';
        
        select.innerHTML = firstOptionHtml;
        
        // Aktif personeli filtrele
        const activePersonnel = personnel.filter(p => 
            p.status === 'active' && 
            (!activeCompanyId || p.companyId === activeCompanyId)
        );
        
        activePersonnel.forEach(person => {
            const option = document.createElement('option');
            option.value = person.id;
            option.textContent = person.name;
            select.appendChild(option);
        });
        
        console.log(`✅ ${selectId} dolduruldu:`, activePersonnel.length, 'personel');
    });
}

// Ay adını bulmak için yardımcı fonksiyon
function getMonthName(monthNum) {
    const months = ["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];
    return months[parseInt(monthNum,10)-1];
}

// Toplam maliyeti hesapla ve göster
function updateSalaryTotalCost() {
    const ayVal = document.getElementById('salaryMonth').value; // YYYY-MM
    if (!ayVal) return;
    const ayAd = getMonthName(ayVal.split('-')[1]);
    const netMaas = parseFloat(document.getElementById('salaryNetInput').value) || 0;
    const ekKazanc = parseFloat(document.getElementById('salaryExtraInput').value) || 0;
    if (!salaryTableData[ayAd]) {
        document.getElementById('salaryTotalCostDisplay').value = 'CSV tablo yok!';
        return;
    }
    const hesap = hesaplaIsverenMaliyetiCSV(ayAd, netMaas, ekKazanc);
    if (hesap) {
        document.getElementById('salaryTotalCostDisplay').value = hesap.toplamIsveren.toFixed(2) + ' ₺';
    } else {
        document.getElementById('salaryTotalCostDisplay').value = 'Hesaplama yok!';
    }
}

function updatePersonnelStats() {
    const activeCount = personnel.filter(p => p.status === 'active').length;
    const monthlySalary = personnel
        .filter(p => p.status === 'active')
        .reduce((sum, p) => sum + p.salary, 0);
    const monthlySGK = personnel
        .filter(p => p.status === 'active')
        .reduce((sum, p) => sum + (p.salary * p.sgkRate / 100), 0);
    
    // Bu ay izin günü hesabı
    const today = new Date();
    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    const monthlyLeaves = leaveRequests.filter(leave => {
        const leaveMonth = leave.startDate.substring(0, 7);
        return leaveMonth === currentMonth;
    });
    const totalLeaveDays = monthlyLeaves.reduce((sum, leave) => {
        const start = new Date(leave.startDate);
        const end = new Date(leave.endDate);
        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        return sum + days;
    }, 0);
    
    document.getElementById('activePersonnelCount').textContent = activeCount;
    document.getElementById('monthlySalaryTotal').textContent = formatCurrency(monthlySalary);
    document.getElementById('monthlySGKTotal').textContent = formatCurrency(monthlySGK);
    document.getElementById('monthlyLeaveCount').textContent = totalLeaveDays;
}

// ========================================
// DEVAMSIZLIK TAKİBİ
// ========================================

function loadPersonnelAttendance() {
    const personnelId = document.getElementById('attendancePersonnelSelect').value;
    
    if (!personnelId) {
        document.getElementById('attendanceSection').style.display = 'none';
        return;
    }
    
    document.getElementById('attendanceSection').style.display = 'block';
    
    const today = new Date();
    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    
    const records = attendanceRecords.filter(r => 
        r.personnelId === personnelId && r.date.startsWith(currentMonth)
    );
    
    const recordsDiv = document.getElementById('attendanceRecords');
    recordsDiv.innerHTML = '';
    
    if (records.length === 0) {
        recordsDiv.innerHTML = '<p style="color:#6b7280;">Bu ay henüz kayıt yok.</p>';
        return;
    }
    
    records.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    records.forEach(record => {
        const div = document.createElement('div');
        div.style.cssText = 'padding:10px; margin:5px 0; border-radius:6px; background:#f9fafb; border-left:4px solid ' + (record.status === 'present' ? 'var(--success)' : 'var(--danger)');
        div.innerHTML = `
            <strong>${formatDate(record.date)}</strong> - 
            <span style="color:${record.status === 'present' ? 'var(--success)' : 'var(--danger)'};">
                ${record.status === 'present' ? '✅ Geldi' : '❌ Gelmedi'}
            </span>
        `;
        recordsDiv.appendChild(div);
    });
}

async function markAttendance(status) {
    const personnelId = document.getElementById('attendancePersonnelSelect').value;
    if (!personnelId) return;
    
    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    const today = new Date().toISOString().split('T')[0];
    
    try {
        // Bugün için kayıt var mı kontrol et
        const existingRecord = attendanceRecords.find(r => 
            r.personnelId === personnelId && r.date === today
        );
        
        if (existingRecord) {
            // Update
            existingRecord.status = status;
            existingRecord.updatedAt = new Date().toISOString();
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('attendance').doc(existingRecord.id).update({
                    status: status,
                    updatedAt: existingRecord.updatedAt
                });
        } else {
            // Create
            const newRecordRef = db.collection('companies').doc(activeCompanyId)
                .collection('attendance').doc();
            
            const newRecord = {
                id: newRecordRef.id,
                personnelId: personnelId,
                date: today,
                status: status,
                createdAt: new Date().toISOString(),
                createdBy: auth.currentUser.uid
            };
            
            await newRecordRef.set(newRecord);
            attendanceRecords.push(newRecord);
        }
        
        loadPersonnelAttendance();
        alert(`✅ Devamsızlık kaydedildi: ${status === 'present' ? 'Geldi' : 'Gelmedi'}`);
        
    } catch (error) {
        console.error('Devamsızlık kayıt hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

// ========================================
// İZİN TALEPLERİ
// ========================================

function openLeaveRequestModal() {
    const personnelId = document.getElementById('attendancePersonnelSelect').value;
    if (!personnelId) {
        alert('⚠️ Lütfen önce personel seçin!');
        return;
    }
    
    document.getElementById('leaveRequestForm').reset();
    document.getElementById('leaveRequestModal').classList.add('active');
}

function closeLeaveRequestModal() {
    document.getElementById('leaveRequestModal').classList.remove('active');
}

async function saveLeaveRequest(e) {
    e.preventDefault();
    
    if (!activeCompanyId) {
        alert('⚠️ Lütfen önce bir firma seçin!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    const personnelId = document.getElementById('attendancePersonnelSelect').value;
    
    try {
        const newLeaveRef = db.collection('companies').doc(activeCompanyId)
            .collection('leaveRequests').doc();
        
        const leaveRequest = {
            id: newLeaveRef.id,
            personnelId: personnelId,
            type: document.getElementById('leaveType').value,
            startDate: document.getElementById('leaveStartDate').value,
            endDate: document.getElementById('leaveEndDate').value,
            description: document.getElementById('leaveDescription').value,
            status: 'pending',
            createdAt: new Date().toISOString(),
            createdBy: auth.currentUser.uid
        };
        
        await newLeaveRef.set(leaveRequest);
        leaveRequests.push(leaveRequest);
        
        closeLeaveRequestModal();
        updatePersonnelStats();
        
        alert('✅ İzin talebi oluşturuldu!');
        
    } catch (error) {
        console.error('İzin talebi kayıt hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

async function approveLeaveRequest(id) {
    const lr = leaveRequests.find(l => l.id === id);
    if (!lr || lr.status !== "pending") return;
    
    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    try {
        const updatedData = {
            status: "approved",
            approvedBy: auth.currentUser.email,
            approvedAt: new Date().toISOString()
        };
        
        await db.collection('companies').doc(activeCompanyId)
            .collection('leaveRequests').doc(id).update(updatedData);
        
        Object.assign(lr, updatedData);
        
        loadLeaveRequestsAdminPanel();
        updatePersonnelStats();
        alert("✅ İzin talebi onaylandı.");
        
    } catch (error) {
        console.error('İzin onaylama hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

async function rejectLeaveRequest(id) {
    const lr = leaveRequests.find(l => l.id === id);
    if (!lr || lr.status !== "pending") return;
    
    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    try {
        const updatedData = {
            status: "rejected",
            rejectedBy: auth.currentUser.email,
            rejectedAt: new Date().toISOString()
        };
        
        await db.collection('companies').doc(activeCompanyId)
            .collection('leaveRequests').doc(id).update(updatedData);
        
        Object.assign(lr, updatedData);
        
        loadLeaveRequestsAdminPanel();
        updatePersonnelStats();
        alert("✅ İzin talebi reddedildi.");
        
    } catch (error) {
        console.error('İzin reddetme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

// ========================================
// MAAŞ ÖDEMELERİ
// ========================================

// Maaş ödeme işleminde yeni mantık
async function processSalaryPayments() {
    const monthVal = document.getElementById('salaryMonth').value; // YYYY-MM
    if (!monthVal) {
        alert('⚠️ Lütfen ay seçin!');
        return;
    }
    
    if (!activeCompanyId || !auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    const ayAd = getMonthName(monthVal.split('-')[1]);
    const personnelId = document.getElementById('salaryPersonnelSelect').value;
    let personnelToProcess = personnel.filter(p => p.status === 'active');
    
    if (personnelId) {
        personnelToProcess = personnelToProcess.filter(p => p.id === personnelId);
    }
    
    if (personnelToProcess.length === 0) {
        alert('⚠️ İşlenecek personel yok!');
        return;
    }
    
    const netMaas = parseFloat(document.getElementById('salaryNetInput').value) || 0;
    const ekKazanc = parseFloat(document.getElementById('salaryExtraInput').value) || 0;
    
    if (!netMaas || !salaryTableData[ayAd]) {
        alert('⚠️ Net maaş ve CSV tablo gerekli!');
        return;
    }
    
    try {
        let processedCount = 0;
        const batch = db.batch();
        
        for (const person of personnelToProcess) {
            // Bu ay için ödeme yapılmış mı kontrol et
            const existingPayment = salaryPayments.find(sp =>
                sp.personnelId === person.id && sp.month === monthVal
            );
            
            if (existingPayment) continue;
            
            const hesap = hesaplaIsverenMaliyetiCSV(ayAd, netMaas, ekKazanc);
            
            const newPaymentRef = db.collection('companies').doc(activeCompanyId)
                .collection('salaryPayments').doc();
            
            const paymentData = {
                id: newPaymentRef.id,
                personnelId: person.id,
                month: monthVal,
                netSalary: netMaas,
                extraIncome: ekKazanc,
                totalEmployerCost: hesap.toplamIsveren,
                paidDate: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                createdBy: auth.currentUser.uid
            };
            
            batch.set(newPaymentRef, paymentData);
            salaryPayments.push(paymentData);
            processedCount++;
        }
        
        if (processedCount > 0) {
            await batch.commit();
        }
        
        await loadSalaryPayments();
        alert(`✅ ${processedCount} personelin maaşı işlendi!`);
        
    } catch (error) {
        console.error('Maaş işleme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

async function handleSalaryCSVUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!activeCompanyId || !auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const content = e.target.result;
            const parsedData = parseSalaryCSV(content);
            salaryTableData = parsedData;
            
            // Firebase'e kaydet
            await db.collection('companies').doc(activeCompanyId)
                .collection('settings').doc('salaryTable').set({
                    tableData: parsedData,
                    uploadedAt: new Date().toISOString(),
                    uploadedBy: auth.currentUser.uid
                });
            
            document.getElementById('salaryTableStatus').textContent = '✅ CSV başarıyla yüklendi ve kaydedildi!';
            
        } catch (error) {
            console.error('CSV yükleme hatası:', error);
            alert('❌ Hata: ' + error.message);
        }
    };
    reader.readAsText(file, 'UTF-8');
}

async function loadSalaryPayments() {
    if (!activeCompanyId || !auth.currentUser) {
        salaryPayments = [];
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('salaryPayments').get();
        
        salaryPayments = [];
        snapshot.forEach(doc => {
            salaryPayments.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('✅ Maaş ödemeleri yüklendi:', salaryPayments.length);
        
        const tbody = document.querySelector('#salaryPaymentsTable tbody');
        if (tbody) {
            tbody.innerHTML = '';
            
            if (salaryPayments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Henüz maaş ödemesi yok.</td></tr>';
                return;
            }
            
            const sorted = [...salaryPayments].sort((a, b) => new Date(b.paidDate) - new Date(a.paidDate));
            
            sorted.forEach(payment => {
                const person = personnel.find(p => p.id === payment.personnelId);
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(payment.paidDate)}</td>
                    <td><strong>${person ? person.name : 'Silinmiş'}</strong></td>
                    <td>${formatCurrency(payment.netSalary)}</td>
                    <td>${formatCurrency(payment.extraIncome || 0)}</td>
                    <td style="color:var(--success); font-weight:700;">${formatCurrency(payment.totalEmployerCost)}</td>
                    <td><span class="badge badge-success">Ödendi</span></td>
                `;
            });
        }
        
    } catch (error) {
        console.error('❌ Maaş ödemesi yükleme hatası:', error);
        salaryPayments = [];
    }
}

async function loadSalaryTable() {
    if (!activeCompanyId || !auth.currentUser) {
        salaryTableData = {};
        return;
    }
    
    try {
        const doc = await db.collection('companies').doc(activeCompanyId)
            .collection('settings').doc('salaryTable').get();
        
        if (doc.exists) {
            salaryTableData = doc.data().tableData || {};
            console.log('✅ Maaş tablosu yüklendi');
        } else {
            salaryTableData = {};
            console.log('ℹ️ Maaş tablosu bulunamadı');
        }
        
    } catch (error) {
        console.error('❌ Maaş tablosu yükleme hatası:', error);
        salaryTableData = {};
    }
}

// CSV örneği indirme
function downloadSalaryExample() {
    const csv = `Ay;Brüt;SSK İşçi;İşsizlik İşçi;Aylık Gelir Vergisi;Damga Vergisi;Kümülatif Toplam;Net;AGİ;Toplam Net Ele Geçen;SSK İşveren;İşsizlik İşveren;Toplam Maliyet;Asgari Ücret Gelir Vergisi İstisnası;Asgari Ücret Damga Vergisi İstisnası
Ocak;45000;6300;450;5737,5;341,55;38250;32170,95;0;35684,03;9337,5;900;55237,5;3315,7;197,38
Şubat;45000;6300;450;5737,5;341,55;76500;32170,95;0;35684,03;9337,5;900;55237,5;3315,7;197,38
Mart;45000;6300;450;5737,5;341,55;114750;32170,95;0;35684,03;9337,5;900;55237,5;3315,7;197,38
...`; // Tüm aylar için doldurabilirsin
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `maas-tablosu-ornegi.csv`;
    link.click();
    URL.revokeObjectURL(url);
}

function normalizeMonthName(raw) {
    const map = {
        " ubat": "Şubat",
        "Mart": "Mart",
        "Nisan": "Nisan",
        "May s": "Mayıs",
        "Haziran": "Haziran",
        "Temmuz": "Temmuz",
        "A ustos": "Ağustos",
        "Eyl l": "Eylül",
        "Ekim": "Ekim",
        "Kas m": "Kasım",
        "Aral k": "Aralık",
        "Ocak": "Ocak"
    };
    let clean = raw.trim();
    return map[clean] || clean;
}

// CSV parsing fonksiyonu
function parseSalaryCSV(content) {
    const lines = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
    let header = null;
    let result = {};
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const parts = line.split(';');
        // Header satırını bul
        if (!header && parts[0].match(/Ay|Ocak|Şubat|Mart|Nisan|Mayıs|Haziran|Temmuz|Ağustos|Eylül|Ekim|Kasım|Aralık| ubat|May s|A ustos|Eyl l|Kas m|Aral k/)) {
            header = parts;
            continue;
        }
        // Data satırı
        if (header && parts.length === header.length) {
            const ayRaw = parts[0];
            const ay = normalizeMonthName(ayRaw);
            result[ay] = {};
            for (let j = 1; j < header.length; j++) {
                const key = header[j].replace(/\s+/g, '_').toLowerCase();
                const val = parts[j].replace(',', '.');
                result[ay][key] = parseFloat(val) || 0;
            }
        }
    }
    return result;
}

// Maaş ödeme/hesaplama fonksiyonu (ay, net maaş, ek kazanç)
function hesaplaIsverenMaliyetiCSV(ay, netMaas, ekKazanc) {
    if (!salaryTableData[ay]) return null;
    // CSV'den tablodaki net ve işveren maliyeti
    const data = salaryTableData[ay];
    const tablonet = data.net;
    const tabloisveren = data.toplam_maliyet || data['toplam_maliyet'];
    // Oranla: Net maaş farklıysa, işveren maliyetini orantıla
    const oran = netMaas / tablonet;
    const toplamIsveren = tabloisveren * oran + (ekKazanc || 0);
    return {
        netMaas: netMaas,
        ekKazanc: ekKazanc || 0,
        toplamIsveren: toplamIsveren,
        tabloSatir: data
    };
}

function populateYearPersonnelSelect() {
    const select = document.getElementById('yearPersonnelSelect');
    if (!select) {
        console.warn('yearPersonnelSelect elementi bulunamadı!');
        return;
    }
    
    // Temizle
    select.innerHTML = '';
    
    // Sadece aktif personeli göster
    const activePersonnel = personnel.filter(p => 
        p.status === 'active' && 
        (!activeCompanyId || p.companyId === activeCompanyId)
    );
    
    if (activePersonnel.length === 0) {
        select.innerHTML = '<option value="">Personel yok</option>';
        return;
    }
    
    // İlk seçenek
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Personel Seçin';
    select.appendChild(defaultOption);
    
    // Personel seçenekleri
    activePersonnel.forEach(person => {
        const option = document.createElement('option');
        option.value = person.id;
        option.textContent = person.name;
        select.appendChild(option);
    });
    
    console.log('✅ yearPersonnelSelect dolduruldu:', activePersonnel.length, 'personel');
}

// Maaş değişiklikleri örnek veri (personel objesinde salaryHistory alanı olmalı!)
/*
personnel = [{
    id: "123",
    name: "Ali Veli",
    startDate: "2025-03-15",
    salaryHistory: [
        { from: "2025-03", net: 32000 },
        { from: "2025-07", net: 35000 }
    ],
    // ...
}]
*/

// Yıllık tablo render fonksiyonu
function renderYearlySalaryTable() {
    const year = document.getElementById('yearSalarySelect').value;
    const personnelId = document.getElementById('yearPersonnelSelect').value;
    const person = personnel.find(p => p.id === personnelId);
    if (!person || !salaryTableData) {
        document.getElementById('yearlySalaryTableSection').innerHTML = '<div class="alert alert-danger">Personel veya maaş tablosu eksik!</div>';
        return;
    }

    // İşe başlama tarihi
    const startDate = new Date(person.startDate);
    const startYear = startDate.getFullYear();
    const startMonth = startDate.getMonth() + 1;

    // Maaş değişikliklerini sırala
    const salaryHistory = person.salaryHistory || [{ from: `${startYear}-${String(startMonth).padStart(2, '0')}`, net: person.salary }];
    salaryHistory.sort((a, b) => a.from.localeCompare(b.from));

    // Aylar
    const aylar = ['01','02','03','04','05','06','07','08','09','10','11','12'];
    let rows = '';
    let currentNet = null;
    let historyIdx = 0;

    for (let i = 0; i < aylar.length; i++) {
        const ayNum = aylar[i];
        const ayAd = getMonthName(ayNum);
        const ayLabel = `${ayAd} ${year}`;
        const monthStr = `${year}-${ayNum}`;
        const ayStartDate = new Date(`${year}-${ayNum}-01`);

        // İşe başlama öncesi aylar
        if (ayStartDate < startDate) {
            rows += `<tr style="background:#f3f4f6;color:#888;">
                <td>${ayLabel}</td>
                <td colspan="6" style="text-align:center;">Çalışmadı</td>
            </tr>`;
            continue;
        }

        // Maaş değişikliği kontrolü
        while (historyIdx < salaryHistory.length && salaryHistory[historyIdx].from <= monthStr) {
            currentNet = salaryHistory[historyIdx].net;
            historyIdx++;
        }

        // Ek kazanç ve dekontlar localStorage'da
        const dekontKey = `salaryReceipt_${person.id}_${monthStr}`;
        const dekontData = JSON.parse(localStorage.getItem(dekontKey) || 'null');
        const ekKazancKey = `salaryExtra_${person.id}_${monthStr}`;
        const ekKazanc = parseFloat(localStorage.getItem(ekKazancKey) || '0');

        // Toplam maliyet hesapla
        const ayCSV = salaryTableData[ayAd];
        let toplamMaaliyet = ayCSV && ayCSV.net ? (ayCSV.toplam_maliyet * (currentNet / ayCSV.net) + ekKazanc) : 0;

        // Durum ve ödeme tarihi
        const durum = dekontData ? '<span class="badge badge-success">Ödendi</span>' : '<span class="badge badge-danger">Ödenmedi</span>';
        const odemeTarihi = dekontData ? formatDate(dekontData.uploadDate) : '-';

        // Dekont alanı
        const dekontHtml = dekontData
            ? `<button class="btn btn-info btn-sm" onclick="viewSalaryReceipt('${person.id}','${monthStr}')">Görüntüle</button>`
            : `<input type="file" onchange="uploadSalaryReceipt(event,'${person.id}','${monthStr}')">`;

        rows += `<tr>
            <td>${ayLabel}</td>
            <td>${currentNet ? formatCurrency(currentNet) : '-'}</td>
            <td>
                <input type="number" min="0" step="0.01" style="width:90px;" value="${ekKazanc}" onchange="saveSalaryExtra(this.value,'${person.id}','${monthStr}')">
            </td>
            <td>${toplamMaaliyet ? formatCurrency(toplamMaaliyet) : '-'}</td>
            <td>${durum}</td>
            <td>${dekontHtml}</td>
            <td>${odemeTarihi}</td>
        </tr>`;
    }

    // Tablo template
    const html = `
        <table>
            <thead>
                <tr>
                    <th>Ay</th>
                    <th>Net Maaş</th>
                    <th>Ek Kazanç</th>
                    <th>Toplam Maliyet</th>
                    <th>Durum</th>
                    <th>Dekont</th>
                    <th>Ödeme Tarihi</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
    document.getElementById('yearlySalaryTableSection').innerHTML = html;
}

// Ek kazancı kaydet
function saveSalaryExtra(val, personId, monthStr) {
    localStorage.setItem(`salaryExtra_${personId}_${monthStr}`, val);
    renderYearlySalaryTable();
}

// Dekont yükleme
function uploadSalaryReceipt(event, personId, monthStr) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = {
            base64: e.target.result,
            uploadDate: new Date().toISOString()
        };
        localStorage.setItem(`salaryReceipt_${personId}_${monthStr}`, JSON.stringify(data));
        renderYearlySalaryTable();
    };
    reader.readAsDataURL(file);
}

// Dekont görüntüleme
function viewSalaryReceipt(personId, monthStr) {
    const key = `salaryReceipt_${personId}_${monthStr}`;
    const data = JSON.parse(localStorage.getItem(key));
    if (!data) return;
    const modalHtml = `
        <div id="salaryReceiptModal" class="modal active" style="display:flex;">
            <div class="modal-content" style="max-width:700px;">
                <div class="modal-header">
                    <h3>Dekont Görüntüle</h3>
                    <button class="close-modal" onclick="closeSalaryReceiptModal()">✖</button>
                </div>
                <div style="padding:20px;text-align:center;">
                    <img src="${data.base64}" style="max-width:100%;border-radius:8px;">
                    <div style="margin-top:18px;color:#888;">Yükleme tarihi: ${formatDate(data.uploadDate)}</div>
                </div>
            </div>
        </div>
    `;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closeSalaryReceiptModal() {
    const modal = document.getElementById('salaryReceiptModal');
    if (modal) modal.remove();
}

// Sayfa yüklendiğinde kullanıcı kontrolü
auth.onAuthStateChanged((user) => {
    if (user) {
        // Kullanıcı giriş yapmış
        document.getElementById('authModal').style.display = 'none';
        initializeApp(user);
    } else {
        // Kullanıcı giriş yapmamış
        document.getElementById('authModal').style.display = 'flex';
    }
});

// Kayıt olma
async function registerUser() {
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    
    if (!name || !email || !password) {
        alert('⚠️ Tüm alanları doldurun!');
        return;
    }
    
    if (password.length < 6) {
        alert('⚠️ Şifre en az 6 karakter olmalı!');
        return;
    }
    
    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Kullanıcı profilini Firestore'a kaydet
        await db.collection('users').doc(user.uid).set({
            name: name,
            email: email,
            role: 'admin', // İlk kullanıcı admin
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            companies: []
        });
        
        alert('✅ Kayıt başarılı! Hoş geldiniz.');
    } catch (error) {
        console.error('Kayıt hatası:', error);
        if (error.code === 'auth/email-already-in-use') {
            alert('⚠️ Bu email zaten kullanımda!');
        } else {
            alert('❌ Kayıt hatası: ' + error.message);
        }
    }
}

// Giriş yapma
async function loginUser() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        alert('⚠️ Email ve şifre gerekli!');
        return;
    }
    
    try {
        await auth.signInWithEmailAndPassword(email, password);
        alert('✅ Giriş başarılı!');
    } catch (error) {
        console.error('Giriş hatası:', error);
        if (error.code === 'auth/user-not-found') {
            alert('⚠️ Kullanıcı bulunamadı!');
        } else if (error.code === 'auth/wrong-password') {
            alert('⚠️ Yanlış şifre!');
        } else {
            alert('❌ Giriş hatası: ' + error.message);
        }
    }
}

// Google ile giriş
async function loginWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    
    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        // İlk girişse Firestore'a kaydet
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (!userDoc.exists) {
            await db.collection('users').doc(user.uid).set({
                name: user.displayName,
                email: user.email,
                role: 'admin',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                companies: []
            });
        }
        
        alert('✅ Google girişi başarılı!');
    } catch (error) {
        console.error('Google giriş hatası:', error);
        alert('❌ Google giriş hatası: ' + error.message);
    }
}

// Çıkış yapma
async function logoutUser() {
    if (confirm('Çıkış yapmak istediğinize emin misiniz?')) {
        await auth.signOut();
        location.reload();
    }
}

// Form değiştirme
function toggleAuthMode() {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const title = document.getElementById('authTitle');
    
    if (loginForm.style.display === 'none') {
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        title.textContent = '🔐 Giriş Yap';
    } else {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        title.textContent = '📝 Kayıt Ol';
    }
}

async function initializeApp(user) {
    if (!user) {
        console.error('User undefined!');
        return;
    }
    
    console.log('🔄 Veriler Firebase\'den yükleniyor...');
    
    try {
        // 1. Tarih inputlarını bugüne ayarla (önce UI hazırla)
        const today = new Date();
        if (document.getElementById('invoiceDate')) {
            document.getElementById('invoiceDate').valueAsDate = today;
        }
        if (document.getElementById('paymentDate')) {
            document.getElementById('paymentDate').valueAsDate = today;
        }
        if (document.getElementById('purchaseDate')) {
            document.getElementById('purchaseDate').valueAsDate = today;
        }
        
        const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
        if (document.getElementById('salaryMonth')) {
            document.getElementById('salaryMonth').value = currentMonth;
        }
        
        // 2. Kullanıcı profilini yükle
        await loadUserData(user.uid);
        
        // 3. Kullanıcının firmalarını yükle
        await loadCompanies();
        
        // 4. Aktif firma yoksa ve firma varsa, ilkini aktif yap
        if (!activeCompanyId && companies.length > 0) {
            activeCompanyId = companies[0].id;
        }
        
        // 5. Tüm verileri paralel yükle
        await Promise.all([
            loadAccounts(),
            loadInvoices(),
            loadPayments(),
            loadPurchases(),
            loadPersonnel(),
            loadAttendanceRecords(),
            loadLeaveRequests(),
            loadSalaryPayments(),
            loadSalaryTable(),
            loadProposals() // ✅ TEKLİFLER
        ]);
        
        // 6. UI'ı güncelle
        updateDashboard();
        populateSelects();
        populatePersonnelSelects();
        
        // 7. Form handlers'ı kur
        setupFormHandlers();
        
        // 8. Google API başlat
        gapiLoaded();
        gisLoaded();
        
        console.log('✅ Tüm veriler Firebase\'den yüklendi!');
        
    } catch (error) {
        console.error('❌ Başlatma hatası:', error);
        throw error;
    }
}

// Kullanıcı verilerini yükle
async function loadUserData(userId) {
    try {
        const userDoc = await db.collection('users').doc(userId).get();
        const userData = userDoc.data();
        
        if (!userData) {
            console.warn('Kullanıcı verisi bulunamadı!');
            return;
        }
        
        console.log('✅ Kullanıcı bilgileri yüklendi:', userData.name);
        
        // Header'a kullanıcı adı ekle
        const header = document.querySelector('.header');
        const existingUserInfo = header.querySelector('.user-info');
        if (existingUserInfo) {
            existingUserInfo.remove();
        }
        
        const userInfo = document.createElement('div');
        userInfo.className = 'user-info';
        userInfo.style.cssText = 'position:absolute; top:20px; right:20px; display:flex; align-items:center; gap:10px;';
        userInfo.innerHTML = `
            <span style="color:white; font-weight:600;">👤 ${userData.name}</span>
            <button class="btn btn-sm" onclick="logoutUser()" style="background:rgba(255,255,255,0.2); color:white;">Çıkış</button>
        `;
        header.style.position = 'relative';
        header.appendChild(userInfo);
        
        return userData;
        
    } catch (error) {
        console.error('❌ Kullanıcı verisi yükleme hatası:', error);
        throw error;
    }
}

function handleInvoiceReceipt(input) {
    const file = input.files[0];
    if (!file) {
        currentInvoiceReceipt = null;
        document.getElementById('invoiceReceiptPreview').innerHTML = '';
        return;
    }
    
    // Boyut kontrolü (5 MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('⚠️ Dekont boyutu 5 MB\'dan küçük olmalıdır!');
        input.value = '';
        return;
    }
    
    currentInvoiceReceipt = file;
    
    const preview = document.getElementById('invoiceReceiptPreview');
    
    if (file.type.includes('image')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <div style="border: 2px solid var(--success); padding: 10px; border-radius: 8px; background: white;">
                    <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        📄 ${file.name} (${formatFileSize(file.size)})
                    </p>
                    <button type="button" onclick="clearInvoiceReceipt()" class="btn btn-danger btn-sm" style="margin-top:5px;">✖ Kaldır</button>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = `
            <div style="border: 2px solid var(--success); padding: 15px; border-radius: 8px; background: white; text-align:center;">
                <div style="font-size: 3em;">📄</div>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                    ${file.name} (${formatFileSize(file.size)})
                </p>
                <button type="button" onclick="clearInvoiceReceipt()" class="btn btn-danger btn-sm" style="margin-top:5px;">✖ Kaldır</button>
            </div>
        `;
    }
}

function clearInvoiceReceipt() {
    currentInvoiceReceipt = null;
    document.getElementById('invoiceReceipt').value = '';
    document.getElementById('invoiceReceiptPreview').innerHTML = '';
}

function viewInvoiceReceipt(invoiceId) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    
    if (!invoice || !invoice.receiptUrl) {
        alert('⚠️ Bu faturaya ait dekont yok!');
        return;
    }
    
    const isPDF = invoice.receiptUrl.toLowerCase().includes('.pdf');
    
    const modalHtml = `
        <div id="invoiceReceiptModal" class="modal active" style="display:flex;">
            <div class="modal-content" style="max-width:900px;">
                <div class="modal-header">
                    <h3>📎 Fatura Dekont - ${invoice.invoiceNo}</h3>
                    <button class="close-modal" onclick="closeInvoiceReceiptModal()">✖</button>
                </div>
                <div style="padding:20px; text-align:center;">
                    ${isPDF 
                        ? `<iframe src="${invoice.receiptUrl}" style="width:100%; height:600px; border:none; border-radius:8px;"></iframe>`
                        : `<img src="${invoice.receiptUrl}" style="max-width:100%; border-radius:8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">`
                    }
                    <div style="margin-top:20px;">
                        <a href="${invoice.receiptUrl}" target="_blank" class="btn btn-primary" download>
                            📥 İndir
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closeInvoiceReceiptModal() {
    const modal = document.getElementById('invoiceReceiptModal');
    if (modal) modal.remove();
}

function populateCompanySelects() {
    // ✅ Sadece aktif firma dropdown'ını güncelle
    const activeCompanySelect = document.getElementById('activeCompanySelect');
    if (activeCompanySelect) {
        const currentValue = activeCompanySelect.value;
        activeCompanySelect.innerHTML = '<option value="">Firma Seçiniz</option>';
        
        companies.forEach(company => {
            const option = new Option(company.name, company.id);
            activeCompanySelect.add(option);
        });
        
        if (activeCompanyId) {
            activeCompanySelect.value = activeCompanyId;
        } else if (currentValue) {
            activeCompanySelect.value = currentValue;
        }
    }
    
    // ✅ Filtre dropdown'ını güncelle
    const filterSelect = document.getElementById('filterAccountCompany');
    if (filterSelect) {
        const currentValue = filterSelect.value;
        filterSelect.innerHTML = '<option value="">Tüm Firmalar</option>';
        
        companies.forEach(company => {
            const option = new Option(company.name, company.id);
            filterSelect.add(option);
        });
        
        if (activeCompanyId) {
            filterSelect.value = activeCompanyId;
        } else if (currentValue) {
            filterSelect.value = currentValue;
        }
    }
    
    // ✅ Cari hesap firma dropdown'ını güncelle
    const accountCompanySelect = document.getElementById('accountCompany');
    if (accountCompanySelect) {
        const currentValue = accountCompanySelect.value;
        accountCompanySelect.innerHTML = '<option value="">Firma Seçiniz</option>';
        
        companies.forEach(company => {
            const option = new Option(company.name, company.id);
            accountCompanySelect.add(option);
        });
        
        // Aktif firma varsa otomatik seç
        if (activeCompanyId && !currentValue) {
            accountCompanySelect.value = activeCompanyId;
            updateAccountCompanyInfo();
        } else if (currentValue) {
            accountCompanySelect.value = currentValue;
        }
    }
}

function closeCompanyModal() {
    const modal = document.getElementById('companyModal');
    if (modal) {
        modal.classList.remove('active');
    }
    
    // Formu temizle
    document.getElementById('companyForm').reset();
    document.getElementById('companyId').value = '';
    companyDocuments = [];
    
    // Döküman önizlemesini temizle
    const docContainer = document.getElementById('companyDocumentsContainer');
    if (docContainer) {
        docContainer.innerHTML = '';
    }
}

function renderCompanyDocuments() {
    const container = document.getElementById('companyDocumentsContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (companyDocuments.length === 0) {
        container.innerHTML = '<p style="color:#6b7280; text-align:center; padding:20px;">Henüz döküman eklenmedi</p>';
        return;
    }
    
    companyDocuments.forEach((doc, index) => {
        const docDiv = document.createElement('div');
        docDiv.style.cssText = 'border:1px solid #e5e7eb; padding:10px; border-radius:5px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;';
        docDiv.innerHTML = `
            <div>
                <strong>${doc.name}</strong>
                <div style="font-size:0.85em; color:#6b7280;">${formatFileSize(doc.fileSize)}</div>
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeCompanyDocument(${index})">🗑️</button>
        `;
        container.appendChild(docDiv);
    });
}

function removeCompanyDocument(index) {
    companyDocuments.splice(index, 1);
    renderCompanyDocuments();
}

function setupFormHandlers() {
    const companyForm = document.getElementById('companyForm');
    if (companyForm && typeof saveCompany === 'function') {
        companyForm.removeEventListener('submit', saveCompany);
        companyForm.addEventListener('submit', saveCompany);
    }
    
    const accountForm = document.getElementById('accountForm');
    if (accountForm && typeof saveAccount === 'function') {
        accountForm.removeEventListener('submit', saveAccount);
        accountForm.addEventListener('submit', saveAccount);
    }
    
    const invoiceForm = document.getElementById('invoiceForm');
    if (invoiceForm && typeof saveInvoice === 'function') {
        invoiceForm.removeEventListener('submit', saveInvoice);
        invoiceForm.addEventListener('submit', saveInvoice);
    }
    
    const paymentForm = document.getElementById('paymentForm');
    if (paymentForm && typeof savePayment === 'function') {
        paymentForm.removeEventListener('submit', savePayment);
        paymentForm.addEventListener('submit', savePayment);
    }
    
    const purchaseForm = document.getElementById('purchaseForm');
    if (purchaseForm && typeof savePurchase === 'function') {
        purchaseForm.removeEventListener('submit', savePurchase);
        purchaseForm.addEventListener('submit', savePurchase);
    }
    
    const personnelForm = document.getElementById('personnelForm');
    if (personnelForm && typeof savePersonnel === 'function') {
        personnelForm.removeEventListener('submit', savePersonnel);
        personnelForm.addEventListener('submit', savePersonnel);
    }
    
    const editPaymentForm = document.getElementById('editPaymentForm');
    if (editPaymentForm && typeof updatePayment === 'function') {
        editPaymentForm.removeEventListener('submit', updatePayment);
        editPaymentForm.addEventListener('submit', updatePayment);
    }
    
    console.log('✅ Form handlers kuruldu');
}

// ========================================
// ÖDEME DÜZENLEME FONKSİYONLARI
// ========================================

function loadEditPaymentInvoices() {
    const accountId = document.getElementById('editPaymentAccount').value;
    const select = document.getElementById('editPaymentInvoice');
    
    select.innerHTML = '<option value="">Genel Ödeme (Fatura Yok)</option>';
    
    if (!accountId) return;
    
    // Bu cari hesaba ait ödenmemiş veya kısmi ödenmiş faturaları getir
    const accountInvoices = invoices.filter(inv => {
        const remaining = inv.total - (inv.paidAmount || 0);
        return inv.accountId === accountId && remaining > 0;
    });
    
    accountInvoices.forEach(invoice => {
        const remaining = invoice.total - (invoice.paidAmount || 0);  // ✅ DÜZELT
        const typeIcon = invoice.type === 'sales' ? '📤' : '📥';
        const option = new Option(
            `${typeIcon} ${invoice.invoiceNo} - ${formatCurrency(remaining)} kalan`,
            invoice.id
        );
        select.add(option);
    });
    
    console.log(`✅ ${accountInvoices.length} fatura yüklendi (editPayment)`);
}

async function saveCompany(e) {
    e.preventDefault();
    
    if (!auth.currentUser) {
        alert('⚠️ Lütfen önce giriş yapın!');
        return;
    }
    
    const companyId = document.getElementById('companyId').value;
    const now = new Date().toISOString();
    const validDocs = companyDocuments.filter(doc => doc.name && doc.file);
    
    try {
        let companyData;
        
        if (companyId) {
            // Update existing company
            const company = companies.find(c => c.id === companyId);
            
            // Dökümanları Storage'a yükle
            const uploadedDocs = await uploadCompanyDocuments(companyId, validDocs);
            
            const updatedData = {
                name: document.getElementById('companyName').value,
                sector: document.getElementById('companySector').value,
                taxNo: document.getElementById('companyTaxNo').value,
                taxOffice: document.getElementById('companyTaxOffice').value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail').value,
                website: document.getElementById('companyWebsite').value,
                address: document.getElementById('companyAddress').value,
                documents: uploadedDocs,
                updatedAt: now,
                updatedBy: auth.currentUser.uid
            };
            
            await db.collection('companies').doc(companyId).update(updatedData);
            
            Object.assign(company, updatedData);
            companyData = company;
            
        } else {
            // Create new company
            const newCompanyRef = db.collection('companies').doc();
            const newCompanyId = newCompanyRef.id;
            
            // Dökümanları Storage'a yükle
            const uploadedDocs = await uploadCompanyDocuments(newCompanyId, validDocs);
            
            const newCompany = {
                id: newCompanyId,
                name: document.getElementById('companyName').value,
                sector: document.getElementById('companySector').value,
                taxNo: document.getElementById('companyTaxNo').value,
                taxOffice: document.getElementById('companyTaxOffice').value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail').value,
                website: document.getElementById('companyWebsite').value,
                address: document.getElementById('companyAddress').value,
                documents: uploadedDocs,
                createdAt: now,
                createdBy: auth.currentUser.uid,
                updatedAt: now,
                updatedBy: auth.currentUser.uid
            };
            
            await newCompanyRef.set(newCompany);
            
            // Kullanıcının firma listesine ekle
            await db.collection('users').doc(auth.currentUser.uid).update({
                companies: firebase.firestore.FieldValue.arrayUnion(newCompanyId)
            });
            
            companies.push(newCompany);
            
            // İlk firma ise aktif yap
            if (!activeCompanyId) {
                activeCompanyId = newCompanyId;
            }
            
            companyData = newCompany;
        }
        
        document.getElementById('companyForm').reset();
        document.getElementById('companyId').value = '';
        companyDocuments = [];
        renderCompanyDocuments();
        closeCompanyFormModal();
        
        await loadCompanies();
        populateCompanySelects();
        
        alert('✅ Firma başarıyla kaydedildi!');
        
    } catch (error) {
        console.error('Firma kayıt hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}


// ===============================
// TEKRAR EDEN KAYIT ENGELLEME MODÜLÜ
// ===============================

// Ödeme duplicate kontrolü - sadece aktif kayıtlar!
function getPaymentUniqueKey(payment) {
    const time = payment.date + " " + (payment.time || "00:00:00");
    return `${time}_${payment.amount}_${payment.accountId}_${payment.referenceCode || ""}`;
}

function isDuplicatePayment(payment, paymentsArray) {
    const key = getPaymentUniqueKey(payment);
    // Sadece aktif ödeme kayıtları!
    return paymentsArray
        .filter(p => !p.status || (p.status !== "deleted" && p.status !== "passive"))
        .some(existing => getPaymentUniqueKey(existing) === key);
}

// Fatura duplicate kontrolü - sadece aktif kayıtlar!
function getInvoiceUniqueKey(invoice) {
    return `${invoice.invoiceNo}_${invoice.date}_${invoice.total}`;
}

function isDuplicateInvoice(invoice, invoicesArray) {
    const key = getInvoiceUniqueKey(invoice);
    return invoicesArray
        .filter(inv => !inv.status || (inv.status !== "deleted" && inv.status !== "passive"))
        .some(existing => getInvoiceUniqueKey(existing) === key);
}

// Cari duplicate kontrolü - sadece aktif kayıtlar!
function getAccountUniqueKey(account) {
    return `${account.name.trim().toUpperCase()}_${account.taxNo || ""}`;
}

function isDuplicateAccount(account, accountsArray) {
    const key = getAccountUniqueKey(account);
    // Sadece aktif (status !== 'passive' && status !== 'deleted')
    return accountsArray
        .filter(a => a.status !== "passive" && a.status !== "deleted")
        .some(existing => getAccountUniqueKey(existing) === key);
}

// Cariyi pasif yapma
async function setAccountPassive(accountId) {
    await db.collection('companies').doc(activeCompanyId)
        .collection('accounts').doc(accountId).update({ status: "passive" });
    const account = accounts.find(a => a.id === accountId);
    if (account) account.status = "passive";
    await loadAccounts();
    renderAccountsTable();
    alert("Cari hesap pasif yapıldı!");
}

// Pasif cariler modalı
function showPassiveAccountsModal() {
    const passiveAccounts = accounts.filter(a => a.status === "passive" && a.companyId === activeCompanyId);
    let html = `
        <div class="modal active" id="passiveAccountsModal" style="display:flex;">
            <div class="modal-content" style="max-width:600px;">
                <div class="modal-header">
                    <h3>🗃️ Pasif Cariler</h3>
                    <button class="close-modal" onclick="closePassiveAccountsModal()">✖</button>
                </div>
                <div style="padding:20px;">
                    <ul>
                        ${passiveAccounts.map(acc => `
                        <li>
                            <strong>${acc.name}</strong>
                            <button class="btn btn-success btn-sm" onclick="activatePassiveAccount('${acc.id}')">Aktif Yap</button>
                        </li>
                        `).join('')}
                    </ul>
                </div>
            </div>
        </div>
    `;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closePassiveAccountsModal() {
    const modal = document.getElementById('passiveAccountsModal');
    if (modal) modal.remove();
}

async function activatePassiveAccount(accountId) {
    await db.collection('companies').doc(activeCompanyId)
        .collection('accounts').doc(accountId).update({ status: "active" });
    const account = accounts.find(a => a.id === accountId);
    if (account) account.status = "active";
    await loadAccounts();
    renderAccountsTable();
    closePassiveAccountsModal();
    alert("Cari hesap tekrar aktif!");
}

// Cari kartta eski verilerle eşleştir
async function matchOldDataWithNewAccount(newAccountId) {
    try {
        console.log('matchOldDataWithNewAccount ÇAĞRILDI - newAccountId:', newAccountId);

        const newAccount = accounts.find(a => a.id === newAccountId);
        if (!newAccount) {
            alert('Yeni cari bulunamadı!');
            return;
        }

        // 1. Adı ve companyId aynı olan, kendisi harici tüm cariler (aktif/pasif farketmez)
        const candidates = accounts.filter(a =>
            a.id !== newAccount.id &&
            a.companyId === newAccount.companyId &&
            a.name.trim().toLowerCase() === newAccount.name.trim().toLowerCase()
        );

        console.log('Eski aday cariler:', candidates);

        // 2. Fatura veya ödeme kaydı olan ilk cariyi bul
        let oldAccount = null;
        for (const candidate of candidates) {
            const hasInvoices = invoices.some(inv => inv.accountId === candidate.id);
            const hasPayments = payments.some(pay => pay.accountId === candidate.id);
            if (hasInvoices || hasPayments) {
                oldAccount = candidate;
                break;
            }
        }

        if (!oldAccount) {
            alert("Adı aynı olan eski cari bulunamadı veya adına bağlı fatura/ödeme yok.");
            return;
        }

        // 3. Tüm fatura/ödemelerin accountId'sini yeniye taşı
        const batch = db.batch();
        let transferCount = 0;

        invoices.filter(inv => inv.accountId === oldAccount.id)
            .forEach(inv => {
                batch.update(
                    db.collection('companies').doc(activeCompanyId).collection('invoices').doc(inv.id),
                    { accountId: newAccountId }
                );
                transferCount++;
            });
        payments.filter(pay => pay.accountId === oldAccount.id)
            .forEach(pay => {
                batch.update(
                    db.collection('companies').doc(activeCompanyId).collection('payments').doc(pay.id),
                    { accountId: newAccountId }
                );
                transferCount++;
            });

        await batch.commit();
        await loadInvoices();
        await loadPayments();
        await loadAccounts();

        console.log('Fatura/Ödeme transferi bitti, toplam:', transferCount);
        alert(`Eski cari (${oldAccount.name})'ye bağlı ${transferCount} hareket yeni cariye aktarıldı!`);
    } catch (e) {
        console.error("matchOldDataWithNewAccount HATASI:", e);
        alert("Hata: " + e.message);
    }
}

// Dosyayı Storage'a ve imports koleksiyonuna kaydeden fonksiyon
async function saveImportedFileToStorage(file, type) {
    if (!auth.currentUser || !activeCompanyId || !file) return;
    try {
        const timestamp = new Date().toISOString();
        const fileName = `${type}_${activeCompanyId}_${timestamp}_${file.name}`;
        const storageRef = storage.ref(`imports/${activeCompanyId}/${fileName}`);
        const snapshot = await storageRef.put(file);
        const downloadURL = await snapshot.ref.getDownloadURL();
        await db.collection('imports').add({
            companyId: activeCompanyId,
            userId: auth.currentUser.uid,
            type,
            fileName,
            downloadURL,
            timestamp
        });
        console.log(`✅ Import dosyası kaydedildi: ${downloadURL}`);
    } catch (err) {
        console.error("Dosya Storage'a veya Firestore'a kaydedilemedi:", err);
    }
}

async function showTrashModal() {
    if (!activeCompanyId) {
        alert('❌ Lütfen bir firma seçin!');
        return;
    }
    
    try {
        // Silinmiş faturaları çek (indexsiz)
        const snapshot = await db.collection('companies')
            .doc(activeCompanyId)
            .collection('invoices')
            .where('status', '==', 'deleted')
            .get();
        
        // Client-side sıralama
        const deletedInvoices = [];
        snapshot.forEach(doc => {
            deletedInvoices.push({ id: doc.id, ...doc.data() });
        });
        
        // Silme tarihine göre sırala (en yeni önce)
        deletedInvoices.sort((a, b) => {
            const dateA = new Date(a.deletedAt || 0);
            const dateB = new Date(b.deletedAt || 0);
            return dateB - dateA;
        });
        
        if (deletedInvoices.length === 0) {
            alert('✅ Çöp kutusu boş!');
            return;
        }
        
        // Modal içeriği oluştur
        let modalHtml = `
            <div class="modal active" id="trashModal">
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h3>🗑️ Çöp Kutusu (${deletedInvoices.length} fatura)</h3>
                        <button class="close-modal" onclick="closeTrashModal()">✖</button>
                    </div>
                    <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Fatura No</th>
                                    <th>Tarih</th>
                                    <th>Tutar</th>
                                    <th>Silinme Tarihi</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
        `;
        
        deletedInvoices.forEach(inv => {
            const deleteDate = new Date(inv.permanentDeleteDate);
            const daysLeft = Math.ceil((deleteDate - new Date()) / (1000 * 60 * 60 * 24));
            
            modalHtml += `
                <tr>
                    <td>${inv.invoiceNo}</td>
                    <td>${formatDate(inv.date)}</td>
                    <td>${formatCurrency(inv.total)}</td>
                    <td>
                        ${formatDate(inv.deletedAt)}<br>
                        <small style="color: ${daysLeft < 7 ? 'red' : '#6b7280'};">
                            ${daysLeft > 0 ? daysLeft + ' gün kaldı' : 'Süresi dolmuş'}
                        </small>
                    </td>
                    <td>
                        <button class="btn btn-success btn-sm" onclick="restoreInvoice('${inv.id}')">
                            ♻️ Geri Yükle
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="permanentDeleteFromTrash('${inv.id}')">
                            🗑️ Kalıcı Sil
                        </button>
                    </td>
                </tr>
            `;
        });
        
        modalHtml += `
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
    } catch (error) {
        console.error('Çöp kutusu hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

function closeTrashModal() {
    const modal = document.getElementById('trashModal');
    if (modal) modal.remove();
}

async function restoreInvoice(id) {
    if (!confirm('Bu faturayı geri yüklemek istediğinize emin misiniz?')) {
        return;
    }
    
    try {
        // Fatura verisini al
        const doc = await db.collection('companies')
            .doc(activeCompanyId)
            .collection('invoices')
            .doc(id)
            .get();
        
        const invoice = doc.data();
        
        // Status'u eski haline getir
        await db.collection('companies').doc(activeCompanyId)
            .collection('invoices').doc(id).update({
                status: invoice.previousStatus || 'unpaid',
                deletedAt: firebase.firestore.FieldValue.delete(),
                deletedBy: firebase.firestore.FieldValue.delete(),
                permanentDeleteDate: firebase.firestore.FieldValue.delete(),
                previousStatus: firebase.firestore.FieldValue.delete(),
                restoredAt: new Date().toISOString(),
                restoredBy: auth.currentUser.uid
            });
        
        // Cari bakiyesini düzelt
        const account = accounts.find(a => a.id === invoice.accountId);
        if (account) {
            const remainingAmount = invoice.total - (invoice.paidAmount || 0);
            
            if (invoice.type === 'sales') {
                account.balance += remainingAmount;
            } else {
                account.balance -= remainingAmount;
            }
            
            await db.collection('companies').doc(activeCompanyId)
                .collection('accounts').doc(account.id).update({
                    balance: account.balance
                });
        }
        
        closeTrashModal();
        await loadInvoices();
        await loadAccounts();
        updateDashboard();
        
        alert('✅ Fatura geri yüklendi!');
        
    } catch (error) {
        console.error('Geri yükleme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

async function permanentDeleteFromTrash(id) {
    if (!confirm('⚠️ Bu faturayı KALICI olarak silmek istediğinize emin misiniz?\n\nBu işlem GERİ ALINAMAZ!')) {
        return;
    }
    
    try {
        await db.collection('companies')
            .doc(activeCompanyId)
            .collection('invoices')
            .doc(id)
            .delete();
        
        closeTrashModal();
        alert('✅ Fatura kalıcı olarak silindi!');
        showTrashModal(); // Modal'ı yenile
        
    } catch (error) {
        console.error('Kalıcı silme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

async function saveInvoicesFromModal() {
    if (!parsedInvoices || parsedInvoices.length === 0) {
        alert('❌ Kaydedilecek fatura yok!');
        return;
    }
    
    // Modal'daki seçimleri topla
    const invoicesToSave = [];
    
    for (let i = 0; i < parsedInvoices.length; i++) {
        const invoice = parsedInvoices[i];
        
        // Kullanıcının seçtiği cari hesabı al
        const selectedAccountId = document.getElementById(`invoiceAccount_${i}`)?.value;
        
        if (!selectedAccountId) {
            alert(`⚠️ ${invoice.faturaNo} için cari hesap seçilmedi!`);
            return;
        }
        
        // Vade tarihini al
        const dueDate = document.getElementById(`invoiceDueDate_${i}`)?.value;
        
        // Açıklama al
        const description = document.getElementById(`invoiceDescription_${i}`)?.value || '';
        
        invoicesToSave.push({
            invoiceNo: invoice.faturaNo,
            date: invoice.faturaTarihi,
            dueDate: dueDate,
            accountId: selectedAccountId,
            total: invoice.tutar,
            type: currentInvoiceType, // 'sales' veya 'purchase'
            description: description,
            status: 'unpaid',
            paidAmount: 0,
            items: [{
                description: invoice.aliciAdi,
                quantity: 1,
                unitPrice: invoice.tutar,
                vatRate: 0,
                amount: invoice.tutar,
                vatAmount: 0
            }]
        });
    }
    
    console.log('📤 Kaydedilecek faturalar:', invoicesToSave);
    
    // Asıl kaydetme fonksiyonunu çağır
    await saveAllInvoices(invoicesToSave);
}

// Asıl kaydetme fonksiyonu
async function saveAllInvoices(importedInvoices) {
    if (!importedInvoices || importedInvoices.length === 0) {
        alert('❌ Kaydedilecek fatura yok!');
        return;
    }
    if (!activeCompanyId) {
        alert('❌ Lütfen bir firma seçin!');
        return;
    }
    if (!auth.currentUser) {
        alert('❌ Lütfen giriş yapın!');
        return;
    }

    console.log('🔍 Duplicate kontrolü başlıyor...');
    console.log('Mevcut faturalar:', invoices.length);
    
    // ⬇️ ÖNEMLİ: Duplicate kontrolünden önce verileri yenile
    await loadInvoices();
    
    // Mevcut fatura unique key dizisini oluştur
    const existingKeys = invoices.map(getInvoiceUniqueKey);
    console.log('Mevcut unique key\'ler:', existingKeys);
    
    const filteredInvoices = [];
    let skippedCount = 0;

    importedInvoices.forEach(inv => {
        const invKey = getInvoiceUniqueKey(inv);
        console.log(`Kontrol ediliyor: ${invKey}`);
        
        if (existingKeys.includes(invKey)) {
            console.log(`❌ Duplicate bulundu: ${invKey}`);
            skippedCount++;
        } else {
            console.log(`✅ Yeni fatura: ${invKey}`);
            filteredInvoices.push(inv);
            existingKeys.push(invKey);
        }
    });

    if (filteredInvoices.length === 0) {
        alert(`⚠️ Tüm faturalar zaten kayıtlı, yeni fatura eklenmedi.\n\n${skippedCount} fatura atlandı.`);
        closeInvoiceMatchModal();
        return;
    }

    try {
        // Firebase batch ile ekle
        const batch = db.batch();
        const now = new Date().toISOString();
        
        filteredInvoices.forEach(inv => {
            const invoiceRef = db.collection('companies').doc(activeCompanyId)
                .collection('invoices').doc();
            
            const invoiceData = {
                id: invoiceRef.id,
                invoiceNo: inv.invoiceNo,
                companyId: activeCompanyId,
                accountId: inv.accountId,
                date: inv.date,
                dueDate: inv.dueDate || inv.date,
                total: inv.total,
                subtotal: inv.total, // KDV dahil olarak varsayıyoruz
                vatAmount: 0,
                type: inv.type || currentInvoiceType,
                status: 'unpaid',
                paidAmount: 0,
                description: inv.description || '',
                items: inv.items || [{
                    description: 'E-Fatura',
                    quantity: 1,
                    unitPrice: inv.total,
                    vatRate: 0,
                    amount: inv.total,
                    vatAmount: 0
                }],
                createdAt: now,
                createdBy: auth.currentUser.uid
            };
            
            batch.set(invoiceRef, invoiceData);
            
            console.log('✅ Batch\'e eklendi:', invoiceData.invoiceNo);
        });

        // Commit işlemi
        await batch.commit();
        console.log('✅ Batch commit tamamlandı');
        
        // Verileri yenile
        await loadInvoices();
        await loadAccounts();
        updateDashboard();
        
        // Modal'ı kapat
        closeInvoiceMatchModal();
        
        alert(
            `✅ ${filteredInvoices.length} yeni fatura eklendi!\n` +
            (skippedCount > 0 ? `⚠️ ${skippedCount} fatura zaten vardı, atlandı.` : '')
        );
        
    } catch (error) {
        console.error('❌ Fatura kaydetme hatası:', error);
        alert('❌ Hata: ' + error.message);
    }
}

// Cari hesap listesi örnek (Firebase ile doldurulacak)
const CARI_LIST = [
    "HEMA OTOMOTİV SİSTEMLERİ A.Ş. ÇERKEZKÖY ŞUBESİ",
    "KALE MADEN SANAYİ",
    "ABC TİCARET LTD. ŞTİ."
];

function loadCariList() {
    let select = document.getElementById('proposalCari');
    if (!select) return;
    select.innerHTML = '<option value="">Cari seçiniz</option>';
    CARI_LIST.forEach(cari => {
        let opt = document.createElement('option');
        opt.value = cari;
        opt.textContent = cari;
        select.appendChild(opt);
    });
}

function openAddProposalModal() {
    document.getElementById('proposalFormModal').classList.add('active');
    loadCariList();
    clearParametersTable();
    addParameterRow(); // En az bir satır olsun
}

function closeProposalFormModal() {
    document.getElementById('proposalFormModal').classList.remove('active');
    document.getElementById('documentParseResult').innerHTML = '';
    document.getElementById('proposalForm').reset();
    clearParametersTable();
}

function clearParametersTable() {
    document.querySelector('#parametersTable tbody').innerHTML = '';
}

// Levenshtein distance (benzerlik skoru)
function levenshtein(a, b) {
    if (a.length === 0) return b.length;
    if (b.length === 0) return a.length;
    let matrix = [];
    for (let i = 0; i <= b.length; i++) matrix[i] = [i];
    for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
    for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
            if (b.charAt(i-1) === a.charAt(j-1)) {
                matrix[i][j] = matrix[i-1][j-1];
            } else {
                matrix[i][j] = Math.min(
                    matrix[i-1][j-1]+1,
                    matrix[i][j-1]+1,
                    matrix[i-1][j]+1
                );
            }
        }
    }
    return matrix[b.length][a.length];
}

function similarity(a, b) {
    let maxLen = Math.max(a.length, b.length);
    if (maxLen === 0) return 1.0;
    return (maxLen - levenshtein(a, b)) / maxLen;
}

// Parametre eşleşmesini fuzzy hale getir
function fuzzyParameterMatch(paramName) {
    paramName = paramName.trim().toLowerCase();
    let bestSim = 0;
    let bestParam = PARAMS_CATALOG[0];
    for (const p of PARAMS_CATALOG) {
        let sim = similarity(paramName, p.name.trim().toLowerCase());
        if (sim > bestSim) {
            bestSim = sim;
            bestParam = p;
        }
    }
    return (bestSim >= 0.7) ? bestParam : null; // %70 eşik
}

// Parametre eklerken kullandığın yerde:
function addParameterRow(paramData={}) {
    let tbody = document.querySelector('#parametersTable tbody');
    let tr = document.createElement('tr');
    
    // ⭐ Parametre adını farklı alanlardan al
    const parameterName = paramData.parametre || paramData.name || paramData.parameter;
    
    // Parametre dropdown
    let paramCell = document.createElement('td');
    let select = document.createElement('select');
    PARAMS_CATALOG.forEach(p => {
        let opt = document.createElement('option');
        opt.value = p.name;
        opt.textContent = p.name;
        select.appendChild(opt);
    });
    
    // ⭐ Fuzzy eşleşme ile otomatik seçim
    let fuzzyParam = parameterName ? fuzzyParameterMatch(parameterName) : null;
    
    console.log('📥 Gelen paramData:', paramData);
    console.log('🔍 Aranan parametre:', parameterName);
    console.log('✅ Bulunan eşleşme:', fuzzyParam);
    
    select.value = fuzzyParam ? fuzzyParam.name : (parameterName || PARAMS_CATALOG[0].name);
    
    select.onchange = function(){
        let fiyat = PARAMS_CATALOG.find(p=>p.name===select.value)?.price || 0;
        tr.querySelector('.param-price').value = fiyat;
        calculateRowTotal(tr);
    }
    paramCell.appendChild(select);
    
    // Adet
    let adetCell = document.createElement('td');
    let adetInput = document.createElement('input');
    adetInput.type = 'number';
    adetInput.min = 1;
    adetInput.value = paramData.adet || 1;
    adetInput.className = 'param-qty';
    adetInput.oninput = ()=>calculateRowTotal(tr);
    adetCell.appendChild(adetInput);
    
    // Fiyat
    let priceCell = document.createElement('td');
    let priceInput = document.createElement('input');
    priceInput.type = 'number';
    priceInput.min = 0;
    priceInput.value = fuzzyParam ? fuzzyParam.price : (paramData.price || paramData.birimFiyat || 0);
    priceInput.className = 'param-price';
    priceInput.oninput = ()=>calculateRowTotal(tr);
    priceCell.appendChild(priceInput);
    
    // Toplam
    let totalCell = document.createElement('td');
    let totalInput = document.createElement('input');
    totalInput.type = 'number';
    totalInput.min = 0;
    totalInput.value = paramData.total || paramData.toplam || (priceInput.value * adetInput.value);
    totalInput.className = 'param-total';
    totalInput.readOnly = true;
    totalCell.appendChild(totalInput);
    
    // Sil butonu
    let removeCell = document.createElement('td');
    let removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.className = 'btn btn-danger btn-sm';
    removeBtn.textContent = 'Sil';
    removeBtn.onclick = ()=>tr.remove();
    removeCell.appendChild(removeBtn);
    
    tr.appendChild(paramCell);
    tr.appendChild(adetCell);
    tr.appendChild(priceCell);
    tr.appendChild(totalCell);
    tr.appendChild(removeCell);
    
    tbody.appendChild(tr);
    calculateRowTotal(tr);
    
    // ⭐ Kullanıcıya otomatik eşleşen parametre bilgisini göster
if (parameterName && fuzzyParam && fuzzyParam.similarity && fuzzyParam.name !== parameterName) {
    let info = document.createElement('div');
    info.style.color = "orange";
    info.style.fontSize = "11px";
    info.style.marginTop = "5px";
    info.textContent = `📌 "${parameterName}" → "${fuzzyParam.name}" olarak eşleştirildi (%${fuzzyParam.similarity.toFixed(0)})`;
    paramCell.appendChild(info);
}
}

function calculateRowTotal(tr) {
    let adet = Number(tr.querySelector('.param-qty').value);
    let fiyat = Number(tr.querySelector('.param-price').value);
    let total = adet * fiyat;
    tr.querySelector('.param-total').value = total;
    calculateGlobals();
}
function calculateGlobals() {
    // KDV Hariç Toplam ve indirimli toplamı otomatik bul
    let rows = document.querySelectorAll('#parametersTable tbody tr');
    let sum = 0;
    rows.forEach(row=>{
        sum += Number(row.querySelector('.param-total').value);
    });
    document.getElementById('proposalTotal').value = sum;
    // İndirimli KDV hariç toplam (örnek: %10 indirim)
    let discounted = sum * 0.9;
    document.getElementById('proposalDiscountedTotal').value = discounted.toFixed(2);
}

// PDF/görsel yükleme ve parse
async function handleDocumentUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // Global değişkene kaydet (Google Drive için)
    uploadedFile = file;
    currentProposalDocument = file;
    
    document.getElementById('documentParseResult').innerHTML = '<span style="color:blue;">İşleniyor...</span>';
    
    if (file.type === "application/pdf") {
        const reader = new FileReader();
        reader.onload = async function(e) {
            const typedarray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let textContent = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                textContent += content.items.map(item => item.str).join(" ") + "\n";
            }
            parseProposalContent(textContent);
            document.getElementById('documentParseResult').innerHTML = '<span style="color:green;">✅ PDF yüklendi ve parse edildi!</span>';
        };
        reader.readAsArrayBuffer(file);
    } else if (file.type.startsWith("image/")) {
        Tesseract.recognize(file, 'tur').then(({ data: { text } }) => {
            parseProposalContent(text);
            document.getElementById('documentParseResult').innerHTML = '<span style="color:green;">✅ Görsel yüklendi ve parse edildi!</span>';
        });
    } else {
        document.getElementById('documentParseResult').innerHTML = '<span style="color:red;">❌ Desteklenmeyen dosya formatı!</span>';
    }
}

function parseProposalContent(text) {
    document.getElementById('documentParseResult').innerHTML = '<pre style="background:#f3f4f6; padding:10px; border-radius:8px; max-height:250px; overflow:auto;">'+text+'</pre>';
    let appNo = (text.match(/Başvuru No[:\s]*([A-Z0-9]+)/) || [])[1] || "";
    let appDate = (text.match(/Başvuru Tarihi[:\s]*([0-9.:\s]+)/) || [])[1] || "";
    let company = (text.match(/Tesis[:\s]*([A-ZÇĞİÖŞÜa-zçğıöşü0-9(). -]+)/) || [])[1] || "";
    let lab = (text.match(/Laboratuvar[:\s]*([A-ZÇĞİÖŞÜa-zçğıöşü0-9(). -]*)/) || [])[1] || "";

    // Parametreler tablosunu bul, satırlara ayır
    let paramRows = [];
    let tableStart = text.indexOf("Parametreler");
    let tableEnd = text.indexOf("Taban Fiyat");
    if (tableStart > -1 && tableEnd > tableStart) {
        let tableText = text.substring(tableStart, tableEnd);
        let lines = tableText.split("\n").filter(l => l.trim().length > 0);
        for (let line of lines) {
            // Başlık satırlarını atla
            if (line.match(/Parametre[\s]*Adet[\s]*Fiyat[\s]*Toplam/i)) continue;
            // Satırda parametre adı + 3 rakam aranıyor mu?
            let m = line.match(/^(.*?)(\d+)[\s]+([\d.,]+)[\s]*₺?[\s]+([\d.,]+)[\s]*₺?$/);
            if (m) {
                paramRows.push({
                    name: m[1].trim(),
                    adet: m[2],
                    price: m[3].replace(/\./g,'').replace(',','.'),
                    total: m[4].replace(/\./g,'').replace(',','.')
                });
            } else {
                // Alternatif: satırda birden fazla sayı varsa
                let numbers = line.match(/(\d[\d.,]*)/g);
                if (numbers && numbers.length >= 3) {
                    let name = line.split(numbers[0])[0].trim();
                    paramRows.push({
                        name: name,
                        adet: numbers[0],
                        price: numbers[1].replace(/\./g,'').replace(',','.'),
                        total: numbers[2].replace(/\./g,'').replace(',','.')
                    });
                }
            }
        }
    }

    document.getElementById('proposalApplicationNo').value = appNo.trim();
    document.getElementById('proposalApplicationDate').value = appDate.trim();
    document.getElementById('proposalCompany').value = company.trim();
    document.getElementById('proposalLab').value = lab.trim();

    clearParametersTable();
    if (paramRows.length) {
        paramRows.forEach(row=>addParameterRow(row));
    } else {
        addParameterRow();
    }
    calculateGlobals();
}

// Cari/firma eşleşme kontrolü
function checkCompanyMatch() {
    let cari = document.getElementById('proposalCari').value;
    let firma = document.getElementById('proposalCompany').value;
    let warning = document.getElementById('companyMatchWarning');
    if (cari && firma && cari !== firma) {
        warning.style.display = 'inline';
    } else {
        warning.style.display = 'none';
    }
}

function showTab(tabId) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.querySelector('.tab[onclick="showTab(\''+tabId+'\')"]').classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

let uploadedFile = null;

// PDF.js ile pozisyon bazlı parse
function parseWithPDFjs() {
    if (!uploadedFile) return alert("Önce bir dosya yükleyin!");
    const reader = new FileReader();
    reader.onload = async function(e) {
        const typedarray = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument(typedarray).promise;
        let paramRows = [];
        let fullText = "";
        
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            
            // Blokları y pozisyonuna göre grupla (satır bulma)
            let lines = {};
            content.items.forEach(item => {
                let y = Math.round(item.transform[5]);
                if (!lines[y]) lines[y] = [];
                lines[y].push(item.str);
            });
            
            Object.values(lines).forEach(cols => {
                let line = cols.join(' ').trim();
                fullText += line + "\n";
                
                // ⭐ AKILLI REGEX - İlk bağımsız sayıya kadar her şey parametre adı
                let m = line.match(/^(.+?)\s+(\d+)\s+([\d.,]+)\s*₺?\s+([\d.,]+)\s*₺?$/);
                
                if (m) {
                    const paramName = m[1].trim();
                    
                    // Başlık satırlarını atla
                    if (paramName.match(/parametre|adet|fiyat|toplam|başvuru|tesis|laboratuvar/i)) {
                        return;
                    }
                    
                    paramRows.push({
                        name: paramName,
                        adet: m[2],
                        price: m[3].replace(/₺/g, '').replace(/\./g,'').replace(',','.').trim(),
                        total: m[4].replace(/₺/g, '').replace(/\./g,'').replace(',','.').trim()
                    });
                    
                    console.log(`✅ Parse edildi: "${paramName}" | Adet: ${m[2]} | Fiyat: ${m[3]}`);
                }
            });
        }
        
        console.log(`\n📊 Toplam ${paramRows.length} parametre bulundu`);
        
        document.getElementById('documentParseResult').innerHTML = 
            '<pre style="background:#f3f4f6; padding:10px; border-radius:8px; max-height:250px; overflow:auto;">PDF.js çıktısı:\n'+fullText+'</pre>';
        
        fillProposalFields(fullText, paramRows);
    };
    reader.readAsArrayBuffer(uploadedFile);
}

// PDF'yi görsele çevirip OCR ile parse
function parseWithOCR() {
    if (!uploadedFile) return alert("Önce bir dosya yükleyin!");
    const reader = new FileReader();
    reader.onload = async function(e) {
        const typedarray = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument(typedarray).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const viewport = page.getViewport({ scale: 2.0 });
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({canvasContext: context, viewport: viewport}).promise;
            // Canvas'ı Tesseract.js ile OCR yap
            const { data: { text } } = await Tesseract.recognize(canvas, 'tur');
            document.getElementById('documentParseResult').innerHTML = '<pre style="background:#f3f4f6; padding:10px; border-radius:8px; max-height:250px; overflow:auto;">OCR çıktısı:\n'+text+'</pre>';
            fillProposalFields(text, null); // OCR'dan satır parse etmeyi aşağıda yapacağız
        }
    };
    reader.readAsArrayBuffer(uploadedFile);
}

// Parse edilen metni kutucuklara ve tabloya aktar
function fillProposalFields(text, paramRows) {
    let appNo = (text.match(/Başvuru No[:\s]*([A-Z0-9]+)/) || [])[1] || "";
    let appDate = (text.match(/Başvuru Tarihi[:\s]*([0-9.:\s]+)/) || [])[1] || "";
    let company = (text.match(/Tesis[:\s]*([A-ZÇĞİÖŞÜa-zçğıöşü0-9(). -]+)/) || [])[1] || "";
    let lab = (text.match(/Laboratuvar[:\s]*([A-ZÇĞİÖŞÜa-zçğıöşü0-9(). -]*)/) || [])[1] || "";
    
    document.getElementById('proposalApplicationNo').value = appNo.trim();
    document.getElementById('proposalApplicationDate').value = appDate.trim();
    document.getElementById('proposalCompany').value = company.trim();
    document.getElementById('proposalLab').value = lab.trim();
    
    clearParametersTable();
    
    // PDF.js parse ile paramRows varsa tabloya ekle
    if (paramRows && paramRows.length) {
        console.log(`📊 ${paramRows.length} parametre bulundu, tabloya ekleniyor...`);
        paramRows.forEach(row => {
            console.log(`  ➕ Ekleniyor:`, row);
            addParameterRow(row);
        });
    } else {
        // Fallback: OCR parse
        let lines = text.split("\n").filter(l => l.trim().length > 0);
        
        for (let line of lines) {
            // Başlık satırlarını atla
            if (line.match(/parametre|adet|fiyat|toplam|başvuru|tesis|laboratuvar/i)) continue;
            
            // ⭐ AKILLI REGEX
            let m = line.match(/^(.+?)\s+(\d+)\s+([\d.,]+)\s*₺?\s+([\d.,]+)\s*₺?$/);
            
            if (m) {
                addParameterRow({
                    name: m[1].trim(),
                    adet: m[2],
                    price: m[3].replace(/₺/g, '').replace(/\./g,'').replace(',','.').trim(),
                    total: m[4].replace(/₺/g, '').replace(/\./g,'').replace(',','.').trim()
                });
            }
        }
    }
    
    calculateGlobals();
}

function toggleFirmaDetay() {
    const section = document.getElementById('firmaDetaySection');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
}

// ========================================
// EVENT LISTENERS
// ========================================

document.getElementById('personnelForm').addEventListener('submit', savePersonnel);
document.getElementById('leaveRequestForm').addEventListener('submit', saveLeaveRequest);

// Inputlarda değişiklik olunca otomatik hesapla
document.getElementById('salaryNetInput').addEventListener('input', updateSalaryTotalCost);
document.getElementById('salaryExtraInput').addEventListener('input', updateSalaryTotalCost);
document.getElementById('salaryMonth').addEventListener('change', updateSalaryTotalCost);

// Sayfa yüklendiğinde bu ayı otomatik seç
// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    // ✅ Sadece UI hazırlama işleri
    // Veri yükleme tamamen Firebase auth'dan sonra yapılacak
    
    // Tarih inputlarını bugüne ayarla
    const today = new Date();
    
    const invoiceDateInput = document.getElementById('invoiceDate');
    if (invoiceDateInput) {
        invoiceDateInput.valueAsDate = today;
    }
    
    const paymentDateInput = document.getElementById('paymentDate');
    if (paymentDateInput) {
        paymentDateInput.valueAsDate = today;
    }
    
    const purchaseDateInput = document.getElementById('purchaseDate');
    if (purchaseDateInput) {
        purchaseDateInput.valueAsDate = today;
    }
    
    // ✅ Maaş ayı otomatik seç
    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    const salaryMonthInput = document.getElementById('salaryMonth');
    if (salaryMonthInput) {
        salaryMonthInput.value = currentMonth;
    }
       
    const editPaymentForm = document.getElementById('editPaymentForm');
    if (editPaymentForm) {
        editPaymentForm.addEventListener('submit', updatePayment);
    }

    console.log('✅ UI hazırlandı, Firebase auth bekleniyor...');
});

// Firebase Authentication State Listener
auth.onAuthStateChanged(async (user) => {
    if (user) {
        console.log('✅ Kullanıcı giriş yaptı:', user.email);
        document.getElementById('authModal').style.display = 'none';
        
        try {
            await initializeApp(user);
        } catch (error) {
            console.error('❌ Başlatma hatası:', error);
            alert('❌ Veri yükleme hatası. Lütfen sayfayı yenileyin.');
        }
        
    } else {
        console.log('⚠️ Kullanıcı giriş yapmamış');
        document.getElementById('authModal').style.display = 'flex';
        
        companies = [];
        accounts = [];
        invoices = [];
        payments = [];
        purchases = [];
        personnel = [];
        attendanceRecords = [];
        leaveRequests = [];
        salaryPayments = [];
        salaryTableData = {};
        activeCompanyId = null;
    }
});

</script>
</body>
</html>