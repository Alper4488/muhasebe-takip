<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Muhasebe Takip Sistemi v2.0</title>

<!-- Firebase SDK'larƒ± -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f3f4f6;
            --white: #ffffff;
            --border: #e5e7eb;
            --purple: #8b5cf6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--white);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .version-badge {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            background: var(--dark);
            border-bottom: 3px solid var(--primary);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            padding: 18px 20px;
            background: var(--dark);
            color: var(--white);
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            min-width: 140px;
        }

        .tab:hover {
            background: #374151;
        }

        .tab.active {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .content {
            padding: 30px;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
            display: inline-block;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .btn-success {
            background: var(--success);
            color: var(--white);
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--white);
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-warning {
            background: var(--warning);
            color: var(--white);
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-info {
            background: var(--info);
            color: var(--white);
        }

        .btn-info:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: var(--white);
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .card {
            background: var(--white);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .card h3 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid var(--primary);
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: var(--white);
            border-radius: 8px;
            overflow: hidden;
        }

        thead {
            background: var(--primary);
            color: var(--white);
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            font-size: 14px;
        }

        tbody tr:hover {
            background: var(--light);
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: var(--white);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(37, 99, 235, 0.3);
        }

        .stat-card h4 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .amount {
            font-size: 2em;
            font-weight: 700;
        }

        .stat-card small {
            opacity: 0.8;
            font-size: 0.85em;
        }

        .stat-card.success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        }

        .stat-card.danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        }

        .stat-card.warning {
            background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        }

        .stat-card.purple {
            background: linear-gradient(135deg, var(--purple) 0%, #6d28d9 100%);
        }

        .invoice-items {
            margin-top: 20px;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            background: var(--light);
        }

        .invoice-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: end;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid var(--success);
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid var(--info);
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid var(--warning);
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid var(--danger);
        }

        .filters {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .company-selector {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: var(--success);
            color: var(--white);
        }

        .badge-danger {
            background: var(--danger);
            color: var(--white);
        }

        .badge-warning {
            background: var(--warning);
            color: var(--white);
        }

        .badge-info {
            background: var(--info);
            color: var(--white);
        }

        .badge-secondary {
            background: #6b7280;
            color: var(--white);
        }

        .export-section {
            background: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--white);
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h3 {
            color: var(--primary);
            margin: 0;
        }

        .close-modal {
            background: var(--danger);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
        }

        .payment-match-item {
            background: white;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .payment-match-item.matched {
            border-color: var(--success);
            background: #d1fae5;
        }

        .payment-match-item.unmatched {
            border-color: var(--warning);
            background: #fef3c7;
        }

        .file-upload-area {
            border: 3px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: var(--light);
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: #dbeafe;
        }

        .file-upload-area.drag-over {
            border-color: var(--success);
            background: #d1fae5;
        }

        @media (max-width: 768px) {
            .grid-2, .grid-3, .grid-4 {
                grid-template-columns: 1fr;
            }

            .invoice-item {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                min-width: 100%;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .version-badge {
                position: static;
                display: block;
                margin-top: 10px;
            }
        }

        .status-paid {
            color: var(--success);
            font-weight: 600;
        }

        .status-partial {
            color: var(--warning);
            font-weight: 600;
        }

        .status-unpaid {
            color: var(--danger);
            font-weight: 600;
        }

        .overdue {
            background: #fee2e2;
            color: var(--danger);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--light);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            transition: width 0.3s;
        }
    </style>
</head>
<body>

<!-- AUTH MODAL -->
<div id="authModal" class="modal active" style="display:none;">
    <div class="modal-content" style="max-width: 450px;">
        <div class="modal-header">
            <h3 id="authTitle">üîê Giri≈ü Yap</h3>
        </div>
        <div style="padding: 20px;">
            <!-- Login Form -->
            <div id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" placeholder="ornek@mail.com" required>
                </div>
                <div class="form-group">
                    <label>≈ûifre</label>
                    <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button class="btn btn-primary" onclick="loginUser()" style="width:100%; margin-bottom:10px;">
                    Giri≈ü Yap
                </button>
                <button class="btn" onclick="loginWithGoogle()" style="width:100%; margin-bottom:10px;">
                    üîµ Google ile Giri≈ü
                </button>
                <p style="text-align:center; margin-top:15px; color:#6b7280;">
                    Hesabƒ±n yok mu? 
                    <a href="#" onclick="toggleAuthMode()" style="color:var(--primary);">Kayƒ±t Ol</a>
                </p>
            </div>

            <!-- Register Form -->
            <div id="registerForm" style="display:none;">
                <div class="form-group">
                    <label>Ad Soyad</label>
                    <input type="text" id="registerName" placeholder="Ahmet Yƒ±lmaz" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="registerEmail" placeholder="ornek@mail.com" required>
                </div>
                <div class="form-group">
                    <label>≈ûifre (min 6 karakter)</label>
                    <input type="password" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button class="btn btn-primary" onclick="registerUser()" style="width:100%; margin-bottom:10px;">
                    Kayƒ±t Ol
                </button>
                <p style="text-align:center; margin-top:15px; color:#6b7280;">
                    Hesabƒ±n var mƒ±? 
                    <a href="#" onclick="toggleAuthMode()" style="color:var(--primary);">Giri≈ü Yap</a>
                </p>
            </div>
        </div>
    </div>
</div>



    <div class="container">
        <div class="header">
            <span class="version-badge">v2.0 Pro</span>
            <h1>üíº Muhasebe Takip Sistemi</h1>
            <p>Profesyonel Fatura, Cari ve √ñdeme Y√∂netimi</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')">üìä Dashboard</button>
            <button class="tab" onclick="showTab('companies')">üè¢ Firmalar</button>
            <button class="tab" onclick="showTab('accounts')">üë• Cari Hesaplar</button>
            <button class="tab" onclick="showTab('invoices')">üìÑ Faturalar</button>
    	    <button class="tab" onclick="showTab('purchases')">üí∏ Alƒ±≈ülar</button>
            <button class="tab" onclick="showTab('payments')">üí∞ √ñdemeler</button>
            <button class="tab" onclick="showTab('reports')">üìà Raporlar</button>
	    <button class="tab" onclick="showTab('personnel')">üë• Personel</button>
            <button class="tab" onclick="showTab('settings')">‚öôÔ∏è Ayarlar</button>
        </div>

        <div class="content">
            <!-- DASHBOARD TAB -->
            <div id="dashboard" class="tab-content active">
                <div class="company-selector">
                    <label>Aktif Firma:</label>
                    <select id="activeCompanySelect" onchange="changeActiveCompany()">
                        <option value="">Firma Se√ßiniz</option>
                    </select>
                </div>

                <div class="grid-4">
                    <div class="stat-card success">
                        <h4>Toplam Gelir</h4>
                        <div class="amount" id="totalIncome">0.00 ‚Ç∫</div>
                    </div>
                    <div class="stat-card danger">
                        <h4>Toplam Gider</h4>
                        <div class="amount" id="totalExpense">0.00 ‚Ç∫</div>
                    </div>
                    <div class="stat-card">
                        <h4>Net Kar/Zarar</h4>
                        <div class="amount" id="netProfit">0.00 ‚Ç∫</div>
                    </div>
                    <div class="stat-card warning">
                        <h4>Tahsil Edilecek</h4>
                        <div class="amount" id="receivables">0.00 ‚Ç∫</div>
                    </div>
                </div>

                <div class="grid-3">
                    <div class="stat-card warning">
                        <h4>√ñdenecek KDV</h4>
                        <div class="amount" id="totalVAT">0.00 ‚Ç∫</div>
                    </div>
                    <div class="stat-card purple">
                        <h4>Kurumlar Vergisi (%20)</h4>
                        <div class="amount" id="corporateTax">0.00 ‚Ç∫</div>
                    </div>
                    <div class="stat-card info">
                        <h4>Toplam √ñdeme</h4>
                        <div class="amount" id="totalPayments">0.00 ‚Ç∫</div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <h3>Son Faturalar</h3>
                        <table id="recentInvoices">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>No</th>
                                    <th>Cari</th>
                                    <th>Tutar</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div class="card">
                        <h3>Son √ñdemeler</h3>
                        <table id="recentPayments">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Cari</th>
                                    <th>Tutar</th>
                                    <th>Tip</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>


<!-- COMPANIES TAB - YENƒ∞ TASARIM -->
<div id="companies" class="tab-content">
    <!-- √úst Ba≈ülƒ±k ve Butonlar -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">üè¢ Firmalar</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalCompaniesCount">0</strong> firma kayƒ±tlƒ±</p>
        </div>
        <button class="btn btn-primary" onclick="openAddCompanyModal()" style="font-size: 16px; padding: 12px 25px;">
            ‚ûï Yeni Firma Ekle
        </button>
    </div>

    <!-- Firma Listesi -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>üìä Kayƒ±tlƒ± Firmalar</h3>
            <input type="text" id="searchCompany" placeholder="üîç Firma ara..." 
                   oninput="searchCompanies()" 
                   style="width: 300px; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
        </div>
        
        <table id="companiesTable">
            <thead>
                <tr>
                    <th>√únvan</th>
                    <th>Sekt√∂r</th>
                    <th>Vergi No</th>
                    <th>Vergi Dairesi</th>
                    <th>Telefon</th>
                    <th>Cari Sayƒ±sƒ±</th>
                    <th>D√∂k√ºman</th>
                    <th>ƒ∞≈ülemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- ACCOUNTS TAB - YENƒ∞ TASARIM -->
<div id="accounts" class="tab-content">
    <!-- √úst Ba≈ülƒ±k ve Butonlar -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">üë• Cari Hesaplar</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalAccountsCount">0</strong> cari hesap kayƒ±tlƒ±</p>
        </div>
        <button class="btn btn-primary" onclick="openAddAccountModal()" style="font-size: 16px; padding: 12px 25px;">
            ‚ûï Yeni Cari Hesap Ekle
        </button>
	<button class="btn btn-success" onclick="openImportAccountsModal()" style="font-size: 16px; padding: 12px 25px;">
    	    üì§ Cari Hesaplarƒ± Excel'den Ekle
	</button>
    </div>

    <!-- Cari Hesaplar Listesi -->
    <div class="card">
        <h3>üìã Cari Hesap Listesi</h3>
        
        <!-- Fƒ∞LTRELER -->
        <div class="filters">
            <div class="grid-4">
                <div class="form-group">
                    <label>üè¢ Firma Filtrele</label>
                    <select id="filterAccountCompany" onchange="filterAccountsByCompany()">
                        <option value="">T√ºm Firmalar</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>T√ºr Filtrele</label>
                    <select id="filterAccountType" onchange="filterAccountsByCompany()">
                        <option value="">T√ºm√º</option>
                        <option value="customer">M√º≈üteri</option>
                        <option value="supplier">Tedarik√ßi</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ara</label>
                    <input type="text" id="searchAccount" placeholder="Cari adƒ± ara..." oninput="filterAccountsByCompany()">
                </div>
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-warning" onclick="clearAccountFilters()" style="width: 100%;">
                        üîÑ Temizle
                    </button>
                </div>
            </div>
        </div>
        
        <table id="accountsTable">
            <thead>
                <tr>
                    <th>Firma</th>
                    <th>Cari Adƒ±</th>
                    <th>T√ºr</th>
                    <th>Telefon</th>
                    <th>Bakiye</th>
                    <th>D√∂k√ºman</th>
                    <th>ƒ∞≈ülemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<!-- Fƒ∞RMA EKLEME/D√úZENLEME MODAL -->
<div id="companyFormModal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="companyFormModalTitle">‚ûï Yeni Firma Ekle</h3>
            <button class="close-modal" onclick="closeCompanyFormModal()">‚úñ</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="companyForm" enctype="multipart/form-data">
                <input type="hidden" id="companyId">
                
                <!-- Temel Bilgiler -->
                <div class="alert alert-info">
                    <strong>üìã Temel Bilgiler</strong>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Firma √únvanƒ± *</label>
                        <input type="text" id="companyName" required placeholder="√ñrn: ABC Ticaret Ltd. ≈ûti.">
                    </div>
                    <div class="form-group">
                        <label>Sekt√∂r</label>
                        <select id="companySector">
                            <option value="">Se√ßiniz</option>
                            <option value="ƒ∞n≈üaat">ƒ∞n≈üaat</option>
                            <option value="Ticaret">Ticaret</option>
                            <option value="√úretim">√úretim</option>
                            <option value="Hizmet">Hizmet</option>
                            <option value="Danƒ±≈ümanlƒ±k">Danƒ±≈ümanlƒ±k</option>
                            <option value="Lojistik">Lojistik</option>
                            <option value="Gƒ±da">Gƒ±da</option>
                            <option value="Teknoloji">Teknoloji</option>
                            <option value="Eƒüitim">Eƒüitim</option>
                            <option value="Saƒülƒ±k">Saƒülƒ±k</option>
                            <option value="Diƒüer">Diƒüer</option>
                        </select>
                    </div>
                </div>
                
                <!-- Vergi Bilgileri -->
                <div class="alert alert-warning" style="margin-top: 20px;">
                    <strong>üíº Vergi Bilgileri</strong>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Vergi Numarasƒ± *</label>
                        <input type="text" id="companyTaxNo" required placeholder="10 haneli vergi numarasƒ±" maxlength="10">
                    </div>
                    <div class="form-group">
                        <label>Vergi Dairesi *</label>
                        <input type="text" id="companyTaxOffice" required placeholder="√ñrn: Kadƒ±k√∂y Vergi Dairesi">
                    </div>
                </div>
                
                <!-- ƒ∞leti≈üim Bilgileri -->
                <div class="alert alert-success" style="margin-top: 20px;">
                    <strong>üìû ƒ∞leti≈üim Bilgileri</strong>
                </div>
                
                <div class="grid-3">
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="tel" id="companyPhone" placeholder="0XXX XXX XX XX">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="companyEmail" placeholder="info@firma.com">
                    </div>
                    <div class="form-group">
                        <label>Website</label>
                        <input type="url" id="companyWebsite" placeholder="https://www.firma.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Adres *</label>
                    <textarea id="companyAddress" rows="3" required placeholder="Tam adres bilgisi..."></textarea>
                </div>
                
                <!-- D√∂k√ºmanlar -->
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>üìé D√∂k√ºmanlar (ƒ∞steƒüe Baƒülƒ±)</strong>
                    <p style="font-size: 0.9em; margin-top: 5px;">Ticaret Sicil Gazetesi, ƒ∞mza Sirk√ºleri, Vergi Levhasƒ± vb.</p>
                </div>
                
                <div id="companyDocumentsList"></div>
                <button type="button" class="btn btn-success" onclick="addCompanyDocument()">
                    ‚ûï Yeni D√∂k√ºman Ekle
                </button>
                
                <!-- Log Bilgisi (D√ºzenleme modunda g√∂ster) -->
                <div id="companyLogInfo" style="display: none; margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px; font-size: 0.9em;">
                    <strong>üìù Kayƒ±t Bilgileri:</strong>
                    <p id="companyCreatedInfo" style="margin: 5px 0;"></p>
                    <p id="companyUpdatedInfo" style="margin: 5px 0;"></p>
                </div>
                
                <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" class="btn btn-secondary" onclick="closeCompanyFormModal()">
                        ‚úñÔ∏è ƒ∞ptal
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveCompanyBtn">
                        üíæ Firma Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- CARƒ∞ HESAP EKLEME/D√úZENLEME MODAL -->
<div id="accountFormModal" class="modal">
    <div class="modal-content" style="max-width: 900px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="accountFormModalTitle">‚ûï Yeni Cari Hesap Ekle</h3>
            <button class="close-modal" onclick="closeAccountFormModal()">‚úñ</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="accountForm">
                <input type="hidden" id="accountId">
                <input type="hidden" id="accountCompanyId">
                
                <!-- Firma Bilgisi -->
                <div class="alert alert-info" id="accountCompanyInfo">
                    <strong>üè¢ Firma:</strong> <span id="accountActiveCompanyName">Se√ßiniz</span>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>üè¢ Firma *</label>
                        <select id="accountCompany" required onchange="updateAccountCompanyInfo()">
                            <option value="">Firma Se√ßiniz</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cari Adƒ± *</label>
                        <input type="text" id="accountName" required placeholder="√ñrn: ABC Tedarik Ltd. ≈ûti.">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>T√ºr *</label>
                        <select id="accountType" required>
                            <option value="">Se√ßiniz</option>
                            <option value="customer">M√º≈üteri</option>
                            <option value="supplier">Tedarik√ßi</option>
    			    <option value="personnel">Personel</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vergi/TC No</label>
                        <input type="text" id="accountTaxNo" placeholder="10 veya 11 haneli">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="tel" id="accountPhone" placeholder="0XXX XXX XX XX">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="accountEmail" placeholder="info@cari.com">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Adres</label>
                    <textarea id="accountAddress" rows="3" placeholder="Adres bilgisi..."></textarea>
                </div>
                
                <!-- D√∂k√ºmanlar -->
                <div class="alert alert-info" style="margin-top: 20px;">
                    <strong>üìé D√∂k√ºmanlar (Maks. 5 adet, Toplam 3 MB)</strong>
                    <p style="font-size: 0.9em; margin-top: 5px;">S√∂zle≈üme, Fatura √∂rneƒüi, √ñn yazƒ±≈ümalar vb.</p>
                </div>
                
                <div id="accountDocumentsList"></div>
                <button type="button" class="btn btn-success" onclick="addAccountDocument()" id="addAccountDocBtn">
                    ‚ûï D√∂k√ºman Ekle (0/5)
                </button>
                
                <div id="accountDocSizeInfo" style="margin-top: 10px; font-size: 0.9em; color: #6b7280;">
                    Toplam boyut: <strong id="accountDocSize">0 KB</strong> / 3 MB
                </div>
                
                <!-- Log Bilgisi -->
                <div id="accountLogInfo" style="display: none; margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px; font-size: 0.9em;">
                    <strong>üìù Kayƒ±t Bilgileri:</strong>
                    <p id="accountCreatedInfo" style="margin: 5px 0;"></p>
                    <p id="accountUpdatedInfo" style="margin: 5px 0;"></p>
                </div>
                
                <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <button type="button" class="btn btn-secondary" onclick="closeAccountFormModal()">
                        ‚úñÔ∏è ƒ∞ptal
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveAccountBtn">
                        üíæ Cari Kaydet
                    </button>
                </div>f
            </form>
        </div>
    </div>
</div>


<!-- INVOICES TAB -->
<div id="invoices" class="tab-content">
    <!-- √úST BA≈ûLIK VE BUTONLAR -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">üìÑ Faturalar</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalInvoicesCount">0</strong> fatura kayƒ±tlƒ±</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="openImportInvoiceModal()" style="font-size: 16px; padding: 12px 25px;">
                üì§ E-Fatura ƒ∞√ße Aktar (CSV)
            </button>
            <button class="btn btn-primary" onclick="scrollToInvoiceForm()" style="font-size: 16px; padding: 12px 25px;">
                ‚ûï Manuel Fatura Ekle
            </button>
        </div>
    </div>

    <!-- FATURA Lƒ∞STESƒ∞ (√ñnce listeler g√∂sterilsin) -->
    <div class="card">
        <h3>üìã Fatura Listesi</h3>
        
        <!-- Fƒ∞LTRELER -->
        <div class="filters">
            <div class="grid-4">
                <div class="form-group">
                    <label>Ba≈ülangƒ±√ß Tarihi</label>
                    <input type="date" id="filterStartDate">
                </div>
                <div class="form-group">
                    <label>Biti≈ü Tarihi</label>
                    <input type="date" id="filterEndDate">
                </div>
                <div class="form-group">
                    <label>Fatura T√ºr√º</label>
                    <select id="filterType">
                        <option value="">T√ºm√º</option>
                        <option value="sales">Satƒ±≈ü</option>
                        <option value="purchase">Alƒ±≈ü</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>√ñdeme Durumu</label>
                    <select id="filterPaymentStatus">
                        <option value="">T√ºm√º</option>
                        <option value="paid">√ñdendi</option>
                        <option value="partial">Kƒ±smi</option>
                        <option value="unpaid">√ñdenmedi</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-info" onclick="filterInvoices()">üîç Filtrele</button>
            <button class="btn btn-warning" onclick="clearInvoiceFilters()">üîÑ Temizle</button>
        </div>
        
        <table id="invoicesTable">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>No</th>
                    <th>T√ºr</th>
                    <th>Cari</th>
                    <th>Toplam</th>
                    <th>√ñdenen</th>
                    <th>Kalan</th>
                    <th>Durum</th>
                    <th>ƒ∞≈ülemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- MANUEL FATURA EKLEME FORMU (A≈üaƒüƒ±da) -->
    <div class="card" id="invoiceFormCard">
        <h3>‚ûï Yeni Fatura Ekle (Manuel)</h3>
        <form id="invoiceForm">
                 <input type="hidden" id="invoiceId">
                        <div class="grid-4">
                            <div class="form-group">
                                <label>Fatura T√ºr√º *</label>
                                <select id="invoiceType" required>
                                    <option value="">Se√ßiniz</option>
                                    <option value="sales">Satƒ±≈ü Faturasƒ±</option>
                                    <option value="purchase">Alƒ±≈ü Faturasƒ±</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Fatura No *</label>
                                <input type="text" id="invoiceNo" required>
                            </div>
                            <div class="form-group">
                                <label>Tarih *</label>
                                <input type="date" id="invoiceDate" required>
                            </div>
                            <div class="form-group">
                                <label>Vade Tarihi</label>
                                <input type="date" id="invoiceDueDate">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Cari Hesap *</label>
                            <select id="invoiceAccount" required>
                                <option value="">Se√ßiniz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>A√ßƒ±klama</label>
                            <textarea id="invoiceDescription" rows="2"></textarea>
                        </div>

                        <div class="invoice-items">
                            <h4 style="margin-bottom:15px;">Fatura Kalemleri</h4>
                            <div id="invoiceItemsList"></div>
                            <button type="button" class="btn btn-success" onclick="addInvoiceItem()">‚ûï Kalem Ekle</button>
                        </div>

                        <div class="grid-3" style="margin-top: 20px;">
                            <div class="stat-card">
                                <h4>Ara Toplam</h4>
                                <div class="amount" id="invoiceSubtotal">0.00 ‚Ç∫</div>
                            </div>
                            <div class="stat-card warning">
                                <h4>KDV</h4>
                                <div class="amount" id="invoiceVAT">0.00 ‚Ç∫</div>
                            </div>
                            <div class="stat-card success">
                                <h4>Genel Toplam</h4>
                                <div class="amount" id="invoiceTotal">0.00 ‚Ç∫</div>
                            </div>
                        </div>

            <!-- ‚úÖ BURAYA EKLE - FATURA DEKONTI Y√úKLEME -->
            <div class="form-group" style="margin-top: 20px;">
                <label>üìé Fatura Dekontƒ± (Opsiyonel - Maks 5 MB)</label>
                <input type="file" id="invoiceReceipt" accept="image/*,.pdf" onchange="handleInvoiceReceipt(this)">
                <div id="invoiceReceiptPreview" style="margin-top: 10px;"></div>
            </div>
            <!-- ‚úÖ BURAYA KADAR -->

                        <button type="submit" class="btn btn-primary" style="margin-top: 20px;" id="saveInvoiceBtn">üíæ Fatura Kaydet</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelInvoiceEdit()" id="cancelInvoiceBtn" style="display:none;">‚úñÔ∏è ƒ∞ptal</button>
                    </form>
                </div>

                <div class="card">
                    <h3>Fatura Listesi</h3>
                    <div class="filters">
                        <div class="grid-4">
                            <div class="form-group">
                                <label>Ba≈ülangƒ±√ß Tarihi</label>
                                <input type="date" id="filterStartDate">
                            </div>
                            <div class="form-group">
                                <label>Biti≈ü Tarihi</label>
                                <input type="date" id="filterEndDate">
                            </div>
                            <div class="form-group">
                                <label>Fatura T√ºr√º</label>
                                <select id="filterType">
                                    <option value="">T√ºm√º</option>
                                    <option value="sales">Satƒ±≈ü</option>
                                    <option value="purchase">Alƒ±≈ü</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>√ñdeme Durumu</label>
                                <select id="filterPaymentStatus">
                                    <option value="">T√ºm√º</option>
                                    <option value="paid">√ñdendi</option>
                                    <option value="partial">Kƒ±smi</option>
                                    <option value="unpaid">√ñdenmedi</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-info" onclick="filterInvoices()">üîç Filtrele</button>
                        <button class="btn btn-warning" onclick="clearInvoiceFilters()">üîÑ Temizle</button>
                    </div>
                    <table id="invoicesTable">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>No</th>
                                <th>T√ºr</th>
                                <th>Cari</th>
                                <th>Toplam</th>
                                <th>√ñdenen</th>
                                <th>Kalan</th>
                                <th>Durum</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- PAYMENTS TAB -->
            <div id="payments" class="tab-content">
                <div class="card">
                    <h3>üí∞ √ñdeme ve Tahsilat Y√∂netimi</h3>
                    
                    <div class="grid-2">
                        <div class="file-upload-area" onclick="document.getElementById('bankFileInput').click()" ondragover="handleDragOver(event)" ondrop="handleDrop(event)">
                            <h3>üì§ Banka √ñzeti Y√ºkle</h3>
                            <p style="margin: 10px 0; color: #6b7280;">Excel veya CSV dosyanƒ±zƒ± s√ºr√ºkleyin veya tƒ±klayƒ±n</p>
                            <p style="font-size: 0.9em; color: #9ca3af;">Desteklenen format: Ziraat Bankasƒ±, Excel, CSV</p>
                            <input type="file" id="bankFileInput" accept=".xlsx,.xls,.csv" style="display:none;" onchange="importBankStatement(event)">
                        </div>

                        <div style="background: var(--light); padding: 20px; border-radius: 8px;">
                            <h3>‚ûï Manuel √ñdeme Ekle</h3>
                            <button class="btn btn-primary" onclick="openPaymentModal()" style="margin-top: 15px; width: 100%;">Yeni √ñdeme/Tahsilat</button>
                            <div style="margin-top: 15px; font-size: 0.9em; color: #6b7280;">
                                <p>‚úì Hƒ±zlƒ± √∂deme kaydƒ±</p>
                                <p>‚úì Faturaya baƒülama</p>
                                <p>‚úì Kƒ±smi √∂deme desteƒüi</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>√ñdeme Ge√ßmi≈üi</h3>
                    <div class="filters">
                        <div class="grid-3">
                            <div class="form-group">
                                <label>Ba≈ülangƒ±√ß Tarihi</label>
                                <input type="date" id="paymentFilterStart">
                            </div>
                            <div class="form-group">
                                <label>Biti≈ü Tarihi</label>
                                <input type="date" id="paymentFilterEnd">
                            </div>
                            <div class="form-group">
                                <label>Cari</label>
                                <select id="paymentFilterAccount">
                                    <option value="">T√ºm√º</option>
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-info" onclick="filterPayments()">üîç Filtrele</button>
                        <button class="btn btn-warning" onclick="clearPaymentFilters()">üîÑ Temizle</button>
                    </div>
                    <table id="paymentsTable">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Cari</th>
                                <th>Tutar</th>
                                <th>Tip</th>
                                <th>Fatura</th>
                                <th>A√ßƒ±klama</th>
                                <th>Kaynak</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- REPORTS TAB -->
            <div id="reports" class="tab-content">
                <div class="card">
                    <h3>Rapor Parametreleri</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Yƒ±l</label>
                            <select id="reportYear">
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ay</label>
                            <select id="reportMonth">
                                <option value="">T√ºm Yƒ±l</option>
                                <option value="01">Ocak</option>
                                <option value="02">≈ûubat</option>
                                <option value="03">Mart</option>
                                <option value="04">Nisan</option>
                                <option value="05">Mayƒ±s</option>
                                <option value="06">Haziran</option>
                                <option value="07">Temmuz</option>
                                <option value="08">Aƒüustos</option>
                                <option value="09">Eyl√ºl</option>
                                <option value="10">Ekim</option>
                                <option value="11">Kasƒ±m</option>
                                <option value="12">Aralƒ±k</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-primary" onclick="generateReport()">üìä Rapor Olu≈ütur</button>
                        </div>
                    </div>
                </div>

                <div id="reportResults"></div>

                <div class="card">
                    <h3>Cari Ekstre</h3>
                    <div class="grid-3">
                        <div class="form-group">
                            <label>Cari Se√ßiniz</label>
                            <select id="statementAccount">
                                <option value="">Se√ßiniz</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Ba≈ülangƒ±√ß Tarihi</label>
                            <input type="date" id="statementStartDate">
                        </div>
                        <div class="form-group">
                            <label>Biti≈ü Tarihi</label>
                            <input type="date" id="statementEndDate">
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="generateStatement()">üìã Ekstre G√∂r√ºnt√ºle</button>
                    <div id="statementResults"></div>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div id="settings" class="tab-content">
                <div class="card">
                    <h3>Veri Y√∂netimi</h3>
                    <div class="export-section">
                        <h4>üíæ Yedekleme ve Geri Y√ºkleme</h4>
                        <p>T√ºm verilerinizi yedekleyin veya √∂nceki bir yedekten geri y√ºkleyin.</p>
                        <button class="btn btn-success" onclick="exportData()">üì• Verileri Dƒ±≈üa Aktar</button>
                        <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">üì§ Verileri ƒ∞√ße Aktar</button>
                        <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importData(event)">
                    </div>
                </div>

<div class="card">
    <h3>Maa≈ü Hesaplama Tablosu (CSV Y√ºkle)</h3>
    <div style="margin-bottom:15px;">
        <input type="file" id="salaryTableCSV" accept=".csv" onchange="handleSalaryCSVUpload(event)">
        <button class="btn btn-info" onclick="downloadSalaryExample()">üì• √ñrnek CSV ƒ∞ndir</button>
        <span id="salaryTableStatus" style="margin-left:10px; color:green;"></span>
    </div>
</div>

                <div class="card">
                    <h3>‚ö†Ô∏è Tehlikeli ƒ∞≈ülemler</h3>
                    <div class="alert alert-info">
                        <strong>Uyarƒ±:</strong> A≈üaƒüƒ±daki i≈ülemler geri alƒ±namaz. Devam etmeden √∂nce verilerinizi yedeklediƒüinizden emin olun.
                    </div>
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è T√ºm Verileri Sil</button>
                </div>

                <div class="card">
                    <h3>‚ÑπÔ∏è Hakkƒ±nda</h3>
                    <p><strong>Muhasebe Takip Sistemi v2.0</strong></p>
                    <p>‚úÖ √áoklu firma desteƒüi</p>
                    <p>‚úÖ Geli≈ümi≈ü √∂deme takibi</p>
                    <p>‚úÖ Banka √∂zeti import</p>
                    <p>‚úÖ Akƒ±llƒ± e≈üle≈ütirme</p>
                    <p>‚úÖ Vade takibi</p>
                    <p>‚úÖ Kƒ±smi √∂deme desteƒüi</p>
                    <p style="margin-top: 15px; color: #6b7280;">Veriler LocalStorage'da g√ºvenle saklanƒ±r.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- PAYMENT MODAL -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí∞ Yeni √ñdeme/Tahsilat</h3>
                <button class="close-modal" onclick="closePaymentModal()">‚úñ</button>
            </div>
            <form id="paymentForm">
                <input type="hidden" id="paymentId">
                <div class="form-group">
                    <label>Tarih *</label>
                    <input type="date" id="paymentDate" required>
                </div>
                <div class="form-group">
                    <label>Cari *</label>
                    <select id="paymentAccount" required onchange="loadAccountInvoices()">
                        <option value="">Se√ßiniz</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tutar *</label>
                    <input type="number" id="paymentAmount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label>Tip *</label>
                    <select id="paymentType" required>
                        <option value="income">Tahsilat (Gelen)</option>
                        <option value="expense">√ñdeme (Giden)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Faturaya Baƒüla</label>
                    <select id="paymentInvoice">
                        <option value="">Genel √ñdeme (Fatura Yok)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>A√ßƒ±klama</label>
                    <textarea id="paymentDescription" rows="3"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">üíæ Kaydet</button>
                <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">‚úñÔ∏è ƒ∞ptal</button>
            </form>
        </div>
    </div>

    <!-- BANK IMPORT MODAL -->
    <div id="bankImportModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3>üì§ Banka √ñzeti E≈üle≈ütirme</h3>
                <button class="close-modal" onclick="closeBankImportModal()">‚úñ</button>
            </div>
            <div id="bankImportContent"></div>
        </div>
    </div>

<!-- Transaction Details Modal -->
<div id="transactionDetailsModal" style="
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    justify-content: center;
    align-items: center;
    opacity: 0;
    transition: opacity 0.3s ease;
">
    <div style="
        background: white;
        border-radius: 12px;
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    ">
        <!-- Header -->
        <div style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        ">
            <h3 style="margin: 0; font-size: 20px;">üí∞ Banka ƒ∞≈ülemleri</h3>
            <button onclick="closeTransactionDetailsModal()" style="
                background: rgba(255,255,255,0.2);
                border: none;
                color: white;
                font-size: 24px;
                cursor: pointer;
                width: 36px;
                height: 36px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background 0.3s;
            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
               onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                √ó
            </button>
        </div>

        <!-- Scrollable Content -->
        <div id="transactionDetailsContainer" style="
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        ">
            <!-- Transactions will be inserted here -->
        </div>

        <!-- Footer -->
        <div style="
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        ">
            <button onclick="closeTransactionDetailsModal()" style="
                padding: 10px 20px;
                background: #6c757d;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
            ">
                ƒ∞ptal
            </button>
            <button onclick="saveAllTransactions()" style="
                padding: 10px 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                font-weight: 500;
            ">
                üíæ T√ºm√ºn√º Kaydet
            </button>
        </div>
    </div>
</div>

<!-- CARI HESAP KARTI MODAL -->
<div id="accountCardModal" class="modal">
    <div class="modal-content" style="max-width: 1200px; max-height: 95vh;">
        <div class="modal-header">
            <h3 id="accountCardTitle">üìä Cari Hesap Kartƒ±</h3>
            <button class="close-modal" onclick="closeAccountCardModal()">‚úñ</button>
        </div>
        
        <div style="padding: 20px;">
            <!-- Cari Bilgileri -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="grid-3">
                    <div>
                        <strong>Cari Adƒ±:</strong>
                        <p id="cardAccountName" style="font-size: 1.2em; color: var(--primary); margin-top: 5px;">-</p>
                    </div>
                    <div>
                        <strong>T√ºr:</strong>
                        <p id="cardAccountType" style="margin-top: 5px;">-</p>
                    </div>
                    <div>
                        <strong>G√ºncel Bakiye:</strong>
                        <p id="cardAccountBalance" style="font-size: 1.5em; font-weight: 700; margin-top: 5px;">-</p>
                    </div>
                </div>
                <div class="grid-3" style="margin-top: 15px;">
                    <div>
                        <strong>Telefon:</strong>
                        <p id="cardAccountPhone" style="margin-top: 5px;">-</p>
                    </div>
                    <div>
                        <strong>Email:</strong>
                        <p id="cardAccountEmail" style="margin-top: 5px;">-</p>
                    </div>
                    <div>
                        <strong>Vergi No:</strong>
                        <p id="cardAccountTaxNo" style="margin-top: 5px;">-</p>
                    </div>
                </div>
            </div>

            <!-- Filtreler -->
            <div class="filters" style="margin-bottom: 20px;">
                <div class="grid-4">
                    <div class="form-group">
                        <label>üìÖ Yƒ±l</label>
                        <select id="cardFilterYear" onchange="filterAccountCard()">
                            <option value="">T√ºm Yƒ±llar</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>üìÜ Ba≈ülangƒ±√ß Tarihi</label>
                        <input type="date" id="cardFilterStartDate" onchange="filterAccountCard()">
                    </div>
                    <div class="form-group">
                        <label>üìÜ Biti≈ü Tarihi</label>
                        <input type="date" id="cardFilterEndDate" onchange="filterAccountCard()">
                    </div>
                    <div class="form-group">
                        <label>üìã ƒ∞≈ülem Tipi</label>
                        <select id="cardFilterType" onchange="filterAccountCard()">
                            <option value="">T√ºm√º</option>
                            <option value="invoice">Sadece Faturalar</option>
                            <option value="payment">Sadece √ñdemeler</option>
                            <option value="income">Sadece Gelirler (Tahsilat)</option>
                            <option value="expense">Sadece Giderler (√ñdeme)</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-warning" onclick="clearAccountCardFilters()">üîÑ Filtreleri Temizle</button>
                <button class="btn btn-success" onclick="exportAccountCard()">üì• Excel'e Aktar</button>
            </div>

            <!-- √ñzet ƒ∞statistikler -->
            <div class="grid-4" style="margin-bottom: 20px;" id="cardStats">
                <div class="stat-card success">
                    <h4>Toplam Gelir</h4>
                    <div class="amount" id="cardTotalIncome">0.00 ‚Ç∫</div>
                    <small id="cardIncomeCount">0 i≈ülem</small>
                </div>
                <div class="stat-card danger">
                    <h4>Toplam Gider</h4>
                    <div class="amount" id="cardTotalExpense">0.00 ‚Ç∫</div>
                    <small id="cardExpenseCount">0 i≈ülem</small>
                </div>
                <div class="stat-card warning">
                    <h4>Fatura Toplamƒ±</h4>
                    <div class="amount" id="cardTotalInvoices">0.00 ‚Ç∫</div>
                    <small id="cardInvoiceCount">0 fatura</small>
                </div>
                <div class="stat-card info">
                    <h4>Net Bakiye</h4>
                    <div class="amount" id="cardNetBalance">0.00 ‚Ç∫</div>
                    <small>Gelir - Gider</small>
                </div>
            </div>

            <!-- ƒ∞≈ülem Listesi -->
            <div style="overflow-y: auto; max-height: 400px;">
                <table id="accountCardTable">
                    <thead style="position: sticky; top: 0; background: var(--primary); z-index: 10;">
                        <tr>
                            <th>Tarih</th>
                            <th>ƒ∞≈ülem Tipi</th>
                            <th>Referans</th>
                            <th>A√ßƒ±klama</th>
                            <th>Bor√ß</th>
                            <th>Alacak</th>
                            <th>Bakiye</th>
                            <th>ƒ∞≈ülem</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- D√ñK√úMAN G√ñR√úNT√úLEME MODAL -->
<div id="documentsModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="documentsModalTitle">üìé D√∂k√ºmanlar</h3>
            <button class="close-modal" onclick="closeDocumentsModal()">‚úñ</button>
        </div>
        
        <div style="padding: 20px;">
            <div id="documentsListView"></div>
        </div>
    </div>
</div>

<!-- D√ñK√úMAN DETAY MODAL (PDF/Resim G√∂r√ºnt√ºleme) -->
<div id="documentViewerModal" class="modal">
    <div class="modal-content" style="max-width: 1000px; max-height: 95vh;">
        <div class="modal-header">
            <h3 id="documentViewerTitle">üìÑ D√∂k√ºman G√∂r√ºnt√ºle</h3>
            <button class="close-modal" onclick="closeDocumentViewer()">‚úñ</button>
        </div>
        
        <div style="padding: 20px; overflow: auto; max-height: calc(95vh - 100px);">
            <div id="documentViewerContent" style="text-align: center;"></div>
        </div>
        
        <div style="padding: 15px 20px; background: #f8f9fa; border-top: 1px solid #dee2e6; text-align: center;">
            <button class="btn btn-success" onclick="downloadCurrentDocument()">
                üì• ƒ∞ndir
            </button>
            <button class="btn btn-secondary" onclick="closeDocumentViewer()">
                ‚úñÔ∏è Kapat
            </button>
        </div>
    </div>
</div>

<!-- Fƒ∞RMA DETAY G√ñR√úNT√úLEME MODAL -->
<div id="companyDetailModal" class="modal">
    <div class="modal-content" style="max-width: 1000px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="companyDetailTitle">üè¢ Firma Detaylarƒ±</h3>
            <button class="close-modal" onclick="closeCompanyDetailModal()">‚úñ</button>
        </div>
        
        <div style="padding: 30px;">
            <!-- Firma √ñzet Kartƒ± -->
            <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 20px;">
                <div class="grid-2">
                    <div>
                        <h2 id="detailCompanyName" style="margin: 0 0 10px 0; color: white;">-</h2>
                        <p id="detailCompanySector" style="margin: 0; opacity: 0.9;">-</p>
                    </div>
                    <div style="text-align: right;">
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; display: inline-block;">
                            <div style="font-size: 0.9em; opacity: 0.9;">Toplam Cari Hesap</div>
                            <div id="detailAccountCount" style="font-size: 2.5em; font-weight: 700; margin-top: 5px;">0</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Temel Bilgiler -->
            <div class="card">
                <h3 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px;">
                    üìã Temel Bilgiler
                </h3>
                <div class="grid-2">
                    <div>
                        <p><strong>üè¢ Firma √únvanƒ±:</strong></p>
                        <p id="detailCompanyNameFull" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                    <div>
                        <p><strong>üè≠ Sekt√∂r:</strong></p>
                        <p id="detailCompanySectorFull" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                </div>
            </div>

            <!-- Vergi Bilgileri -->
            <div class="card">
                <h3 style="color: var(--warning); border-bottom: 2px solid var(--warning); padding-bottom: 10px; margin-bottom: 20px;">
                    üíº Vergi Bilgileri
                </h3>
                <div class="grid-2">
                    <div>
                        <p><strong>Vergi Numarasƒ±:</strong></p>
                        <p id="detailCompanyTaxNo" style="color: #1f2937; font-size: 1.1em; font-family: monospace;">-</p>
                    </div>
                    <div>
                        <p><strong>Vergi Dairesi:</strong></p>
                        <p id="detailCompanyTaxOffice" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                </div>
            </div>

            <!-- ƒ∞leti≈üim Bilgileri -->
            <div class="card">
                <h3 style="color: var(--success); border-bottom: 2px solid var(--success); padding-bottom: 10px; margin-bottom: 20px;">
                    üìû ƒ∞leti≈üim Bilgileri
                </h3>
                <div class="grid-3">
                    <div>
                        <p><strong>üì± Telefon:</strong></p>
                        <p id="detailCompanyPhone" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                    <div>
                        <p><strong>üìß Email:</strong></p>
                        <p id="detailCompanyEmail" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                    <div>
                        <p><strong>üåê Website:</strong></p>
                        <p id="detailCompanyWebsite" style="color: #1f2937; font-size: 1.1em;">-</p>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <p><strong>üìç Adres:</strong></p>
                    <p id="detailCompanyAddress" style="color: #1f2937; font-size: 1.1em; line-height: 1.6;">-</p>
                </div>
            </div>

            <!-- D√∂k√ºmanlar -->
            <div class="card" id="detailCompanyDocumentsCard" style="display: none;">
                <h3 style="color: var(--info); border-bottom: 2px solid var(--info); padding-bottom: 10px; margin-bottom: 20px;">
                    üìé D√∂k√ºmanlar
                </h3>
                <div id="detailCompanyDocuments"></div>
            </div>

            <!-- Kayƒ±t Loglarƒ± -->
            <div class="card" style="background: #f9fafb;">
                <h3 style="color: #6b7280; border-bottom: 2px solid #e5e7eb; padding-bottom: 10px; margin-bottom: 20px;">
                    üìù Kayƒ±t Bilgileri
                </h3>
                <div class="grid-2">
                    <div>
                        <p><strong>Olu≈üturulma:</strong></p>
                        <p id="detailCompanyCreated" style="color: #1f2937;">-</p>
                    </div>
                    <div>
                        <p><strong>Son G√ºncelleme:</strong></p>
                        <p id="detailCompanyUpdated" style="color: #1f2937;">-</p>
                    </div>
                </div>
            </div>

            <!-- Finansal √ñzet -->
            <div class="card">
                <h3 style="color: var(--purple); border-bottom: 2px solid var(--purple); padding-bottom: 10px; margin-bottom: 20px;">
                    üí∞ Finansal √ñzet
                </h3>
                <div class="grid-4">
                    <div class="stat-card success">
                        <h4>Toplam Gelir</h4>
                        <div class="amount" id="detailTotalIncome">0.00 ‚Ç∫</div>
                        <small id="detailIncomeInvoices">0 fatura</small>
                    </div>
                    <div class="stat-card danger">
                        <h4>Toplam Gider</h4>
                        <div class="amount" id="detailTotalExpense">0.00 ‚Ç∫</div>
                        <small id="detailExpenseInvoices">0 fatura</small>
                    </div>
                    <div class="stat-card">
                        <h4>Net Kar/Zarar</h4>
                        <div class="amount" id="detailNetProfit">0.00 ‚Ç∫</div>
                    </div>
                    <div class="stat-card warning">
                        <h4>Toplam √ñdeme</h4>
                        <div class="amount" id="detailTotalPayments">0.00 ‚Ç∫</div>
                        <small id="detailPaymentCount">0 √∂deme</small>
                    </div>
                </div>
            </div>

            <!-- Cari Hesaplar Listesi -->
            <div class="card">
                <h3 style="color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px;">
                    üë• Cari Hesaplar
                </h3>
                <div id="detailCompanyAccountsList"></div>
            </div>

            <!-- ƒ∞≈ülem Butonlarƒ± -->
            <div style="margin-top: 30px; text-align: center; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <button class="btn btn-warning" onclick="editCompanyFromDetail()">
                    ‚úèÔ∏è D√ºzenle
                </button>
                <button class="btn btn-success" onclick="viewCompanyAccountsFromDetail()">
                    üë• Cari Hesaplara Git
                </button>
                <button class="btn btn-info" onclick="viewCompanyDocumentsFromDetail()" id="detailViewDocsBtn" style="display: none;">
                    üìé D√∂k√ºmanlarƒ± G√∂r√ºnt√ºle
                </button>
                <button class="btn btn-secondary" onclick="closeCompanyDetailModal()">
                    ‚úñÔ∏è Kapat
                </button>
            </div>
        </div>
    </div>
</div>

<!-- E-FATURA ƒ∞√áE AKTARMA MODAL -->
<div id="importInvoiceModal" class="modal">
    <div class="modal-content" style="max-width: 1200px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3>üì§ E-Fatura ƒ∞√ße Aktarma (Excel/CSV)</h3>
            <button class="close-modal" onclick="closeImportInvoiceModal()">‚úñ</button>
        </div>
        
        <div style="padding: 30px;">
            <!-- Y√ºkleme Alanƒ± -->
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è E-Fatura Formatƒ± Hakkƒ±nda</strong>
                <p style="margin: 10px 0 0 0; font-size: 0.95em;">
                    E-Fatura sisteminizden aldƒ±ƒüƒ±nƒ±z <strong>CSV</strong> veya <strong>Excel</strong> dosyasƒ±nƒ± y√ºkleyin.<br>
                    Sistem otomatik olarak fatura bilgilerini okuyacak ve <strong>cari hesaplarla e≈üle≈ütirecektir</strong>.
                </p>
            </div>

            <!-- Fatura T√ºr√º Se√ßimi -->
            <div class="card" style="margin-bottom: 20px;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">üìã Fatura T√ºr√º Se√ßin</h4>
                <div style="display: flex; gap: 20px;">
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; flex: 1; transition: all 0.3s;">
                        <input type="radio" name="invoiceImportType" value="sales" checked onchange="updateInvoiceTypeSelection()" style="margin-right: 10px; width: 20px; height: 20px;">
                        <div>
                            <strong style="color: var(--success); font-size: 1.1em;">üìó Giden Fatura (Satƒ±≈ü)</strong>
                            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">M√º≈üterilerinize d√ºzenlenen faturalar</p>
                        </div>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer; padding: 15px; border: 2px solid #e5e7eb; border-radius: 8px; flex: 1; transition: all 0.3s;">
                        <input type="radio" name="invoiceImportType" value="purchase" onchange="updateInvoiceTypeSelection()" style="margin-right: 10px; width: 20px; height: 20px;">
                        <div>
                            <strong style="color: var(--danger); font-size: 1.1em;">üìï Gelen Fatura (Alƒ±≈ü)</strong>
                            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">Tedarik√ßilerinizden gelen faturalar</p>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Dosya Y√ºkleme -->
            <div class="file-upload-area" 
                 onclick="document.getElementById('invoiceExcelFile').click()" 
                 ondragover="handleDragOver(event)" 
                 ondrop="handleInvoiceExcelDrop(event)"
                 style="cursor: pointer;">
                <h3>üìÇ CSV/Excel Dosyasƒ±nƒ± Y√ºkle</h3>
                <p style="margin: 10px 0; color: #6b7280;">Dosyanƒ±zƒ± s√ºr√ºkleyin veya tƒ±klayƒ±n</p>
                <p style="font-size: 0.9em; color: #9ca3af;">Desteklenen format: .csv, .xlsx, .xls</p>
                <input type="file" 
                       id="invoiceExcelFile" 
                       accept=".csv,.xlsx,.xls" 
                       style="display:none;" 
                       onchange="importInvoiceExcel(event)">
            </div>

            <!-- √ñrnek Format G√∂sterimi -->
            <div class="card" style="margin-top: 20px; background: #f9fafb;">
                <h4 style="color: var(--primary); margin-bottom: 15px;">üìã Beklenen Format (E-Fatura Standart)</h4>
                <p style="font-size: 0.9em; color: #6b7280; margin-bottom: 10px;">
                    CSV/Excel dosyanƒ±zda ≈üu s√ºtunlar olmalƒ±dƒ±r:
                </p>
                <div style="overflow-x: auto;">
                    <table style="font-size: 0.85em; width: 100%;">
                        <thead style="background: var(--primary); color: white;">
                            <tr>
                                <th>Alƒ±cƒ± Adƒ±</th>
                                <th>Fatura Numarasƒ±</th>
                                <th>Fatura Tarihi</th>
                                <th>Olu≈üturma Tarihi</th>
                                <th>Senaryo</th>
                                <th>Durum</th>
                                <th>Tutar</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>√ñRNEK Fƒ∞RMA A.≈û.</td>
                                <td>NRC2025000000369</td>
                                <td>30.09.2025</td>
                                <td>19.09.2025</td>
                                <td>TICARIFATURA</td>
                                <td>G√∂nderildi</td>
                                <td>10737,6</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FATURA E≈ûLE≈ûTƒ∞RME MODAL -->
<div id="invoiceMatchModal" class="modal">
    <div class="modal-content" style="max-width: 1400px; max-height: 95vh; overflow-y: auto;">
        <div class="modal-header">
            <h3 id="invoiceMatchTitle">üîÑ Fatura E≈üle≈ütirme</h3>
            <button class="close-modal" onclick="closeInvoiceMatchModal()">‚úñ</button>
        </div>
        
        <div style="padding: 20px;">
            <div class="alert alert-success" id="invoiceMatchSummary">
                <strong>‚úÖ <span id="matchedInvoiceCount">0</span> fatura ba≈üarƒ±yla okundu!</strong>
            </div>

            <!-- E≈üle≈ütirme Listesi -->
            <div id="invoiceMatchList"></div>

            <!-- Alt Butonlar -->
            <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                <button class="btn btn-secondary" onclick="closeInvoiceMatchModal()">
                    ‚úñÔ∏è ƒ∞ptal
                </button>
                <button class="btn btn-success" onclick="saveAllInvoices()" style="font-size: 16px; padding: 12px 30px;">
                    üíæ <span id="saveInvoiceCount">0</span> Faturayƒ± Kaydet
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PURCHASES TAB - YENƒ∞ -->
<div id="purchases" class="tab-content">
    <!-- √úst Ba≈ülƒ±k ve Butonlar -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">üí∏ Alƒ±≈ülar (Nakit/Fi≈ü)</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalPurchasesCount">0</strong> alƒ±≈ü kaydƒ±</p>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-success" onclick="openImportPurchasesModal()" style="font-size: 16px; padding: 12px 25px;">
                üì§ Excel'den ƒ∞√ße Aktar
            </button>
            <button class="btn btn-primary" onclick="scrollToPurchaseForm()" style="font-size: 16px; padding: 12px 25px;">
                ‚ûï Yeni Alƒ±≈ü Ekle
            </button>
        </div>
    </div>

    <!-- ALI≈û Lƒ∞STESƒ∞ -->
    <div class="card">
        <h3>üìã Alƒ±≈ü Listesi</h3>
        
        <!-- Fƒ∞LTRELER -->
        <div class="filters">
            <div class="grid-4">
                <div class="form-group">
                    <label>üìÖ Ba≈ülangƒ±√ß Tarihi</label>
                    <input type="date" id="filterPurchaseStartDate">
                </div>
                <div class="form-group">
                    <label>üìÖ Biti≈ü Tarihi</label>
                    <input type="date" id="filterPurchaseEndDate">
                </div>
                <div class="form-group">
                    <label>üè∑Ô∏è Kategori</label>
                    <select id="filterPurchaseCategory">
                        <option value="">T√ºm√º</option>
                        <option value="Kƒ±rtasiye">Kƒ±rtasiye</option>
                        <option value="Yakƒ±t">Yakƒ±t</option>
                        <option value="Yemek">Yemek</option>
                        <option value="Temizlik">Temizlik</option>
                        <option value="Kargo">Kargo</option>
                        <option value="Elektrik">Elektrik</option>
                        <option value="Su">Su</option>
                        <option value="ƒ∞nternet">ƒ∞nternet</option>
                        <option value="Telefon">Telefon</option>
                        <option value="Bakƒ±m-Onarƒ±m">Bakƒ±m-Onarƒ±m</option>
                        <option value="Ula≈üƒ±m">Ula≈üƒ±m</option>
                        <option value="Diƒüer">Diƒüer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üí≥ √ñdeme Y√∂ntemi</label>
                    <select id="filterPurchasePayment">
                        <option value="">T√ºm√º</option>
                        <option value="cash">Nakit</option>
                        <option value="card">Kart</option>
                        <option value="transfer">Havale/EFT</option>
                    </select>
                </div>
            </div>
            <button class="btn btn-info" onclick="filterPurchases()">üîç Filtrele</button>
            <button class="btn btn-warning" onclick="clearPurchaseFilters()">üîÑ Temizle</button>
        </div>
        
        <!-- √ñZET ƒ∞STATƒ∞STƒ∞KLER -->
        <div class="grid-4" style="margin: 20px 0;">
            <div class="stat-card danger">
                <h4>Toplam Harcama</h4>
                <div class="amount" id="purchasesTotalAmount">0.00 ‚Ç∫</div>
                <small id="purchasesCount">0 kayƒ±t</small>
            </div>
            <div class="stat-card">
                <h4>KDV Hari√ß</h4>
                <div class="amount" id="purchasesSubtotal">0.00 ‚Ç∫</div>
            </div>
            <div class="stat-card warning">
                <h4>Toplam KDV</h4>
                <div class="amount" id="purchasesTotalVAT">0.00 ‚Ç∫</div>
                <small>Mahsup edilecek</small>
            </div>
            <div class="stat-card purple">
                <h4>Ortalama ƒ∞≈ülem</h4>
                <div class="amount" id="purchasesAverage">0.00 ‚Ç∫</div>
            </div>
        </div>
        
        <table id="purchasesTable">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>Kategori</th>
                    <th>A√ßƒ±klama</th>
                    <th>Tedarik√ßi</th>
                    <th>KDV Hari√ß</th>
                    <th>KDV</th>
                    <th>Toplam</th>
                    <th>√ñdeme</th>
                    <th>Fi≈ü</th>
                    <th>ƒ∞≈ülemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- ALI≈û EKLEME FORMU -->
    <div class="card" id="purchaseFormCard">
        <h3>‚ûï Yeni Alƒ±≈ü Ekle</h3>
        <form id="purchaseForm">
            <input type="hidden" id="purchaseId">
            
            <div class="grid-3">
                <div class="form-group">
                    <label>üìÖ Tarih *</label>
                    <input type="date" id="purchaseDate" required>
                </div>
                <div class="form-group">
                    <label>üè∑Ô∏è Kategori *</label>
                    <select id="purchaseCategory" required>
                        <option value="">Se√ßiniz</option>
                        <option value="Kƒ±rtasiye">üìé Kƒ±rtasiye</option>
                        <option value="Yakƒ±t">‚õΩ Yakƒ±t</option>
                        <option value="Yemek">üçΩÔ∏è Yemek</option>
                        <option value="Temizlik">üßπ Temizlik</option>
                        <option value="Kargo">üì¶ Kargo</option>
                        <option value="Elektrik">üí° Elektrik</option>
                        <option value="Su">üíß Su</option>
                        <option value="ƒ∞nternet">üåê ƒ∞nternet</option>
                        <option value="Telefon">üì± Telefon</option>
                        <option value="Bakƒ±m-Onarƒ±m">üîß Bakƒ±m-Onarƒ±m</option>
                        <option value="Ula≈üƒ±m">üöó Ula≈üƒ±m</option>
                        <option value="Diƒüer">üìã Diƒüer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üí≥ √ñdeme Y√∂ntemi *</label>
                    <select id="purchasePaymentMethod" required>
                        <option value="">Se√ßiniz</option>
                        <option value="cash">üíµ Nakit</option>
                        <option value="card">üí≥ Kredi/Banka Kartƒ±</option>
                        <option value="transfer">üè¶ Havale/EFT</option>
                    </select>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="form-group">
                    <label>A√ßƒ±klama *</label>
                    <input type="text" id="purchaseDescription" required placeholder="√ñrn: A4 kaƒüƒ±t, toner">
                </div>
                <div class="form-group">
                    <label>Tedarik√ßi (Opsiyonel)</label>
                    <input type="text" id="purchaseSupplier" placeholder="√ñrn: Migros, Bƒ∞M">
                </div>
            </div>
            
            <div class="grid-3">
                <div class="form-group">
                    <label>üí∞ Tutar (KDV Hari√ß) *</label>
                    <input type="number" id="purchaseAmount" step="0.01" required onchange="calculatePurchaseTotal()">
                </div>
                <div class="form-group">
                    <label>KDV Oranƒ± *</label>
                    <select id="purchaseVATRate" required onchange="calculatePurchaseTotal()">
                        <option value="0">%0</option>
                        <option value="1">%1</option>
                        <option value="10">%10</option>
                        <option value="20" selected>%20</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>KDV Tutarƒ±</label>
                    <input type="number" id="purchaseVATAmount" step="0.01" readonly style="background: #f3f4f6;">
                </div>
            </div>
            
            <div class="alert alert-info">
                <strong>üíµ Toplam √ñdenecek:</strong> 
                <span id="purchaseTotalDisplay" style="font-size: 1.5em; font-weight: 700; color: var(--danger);">0.00 ‚Ç∫</span>
            </div>
            
            <!-- Fƒ∞≈û Y√úKLEME -->
            <div class="form-group">
                <label>üìÑ Fi≈ü/Dekont Y√ºkle (Opsiyonel - Maks 2 MB)</label>
                <input type="file" id="purchaseReceipt" accept="image/*,.pdf" onchange="handlePurchaseReceipt(this)">
                <div id="purchaseReceiptPreview" style="margin-top: 10px;"></div>
            </div>
            
            <div style="margin-top: 20px;">
                <button type="submit" class="btn btn-primary" id="savePurchaseBtn">üíæ Alƒ±≈üƒ± Kaydet</button>
                <button type="button" class="btn btn-secondary" onclick="cancelPurchaseEdit()" id="cancelPurchaseBtn" style="display:none;">‚úñÔ∏è ƒ∞ptal</button>
            </div>
        </form>
    </div>
</div>

<!-- PERSONNEL TAB -->
<div id="personnel" class="tab-content">
    <!-- √úst Ba≈ülƒ±k -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <div>
            <h2 style="margin: 0; color: var(--primary);">üë• Personel Y√∂netimi</h2>
            <p style="margin: 5px 0 0 0; color: #6b7280;">Toplam <strong id="totalPersonnelCount">0</strong> personel</p>
        </div>
        <button class="btn btn-primary" onclick="openAddPersonnelModal()">
            ‚ûï Yeni Personel Ekle
        </button>
    </div>

    <!-- ƒ∞statistik Kartlarƒ± -->
    <div class="grid-4" style="margin-bottom: 20px;">
        <div class="stat-card">
            <h4>Toplam Personel</h4>
            <div class="amount" id="activePersonnelCount">0</div>
            <small>Aktif √ßalƒ±≈üan</small>
        </div>
        <div class="stat-card danger">
            <h4>Bu Ay Maa≈ü</h4>
            <div class="amount" id="monthlySalaryTotal">0.00 ‚Ç∫</div>
        </div>
        <div class="stat-card warning">
            <h4>Bu Ay SGK</h4>
            <div class="amount" id="monthlySGKTotal">0.00 ‚Ç∫</div>
        </div>
        <div class="stat-card success">
            <h4>Bu Ay ƒ∞zin</h4>
            <div class="amount" id="monthlyLeaveCount">0</div>
            <small>g√ºn</small>
        </div>
    </div>

    <!-- Personel Listesi -->
    <div class="card">
        <h3>üìã Personel Listesi</h3>
        <table id="personnelTable">
            <thead>
                <tr>
                    <th>Ad Soyad</th>
                    <th>Pozisyon</th>
                    <th>Maa≈ü</th>
                    <th>SGK (%</th>
                    <th>ƒ∞≈üe Ba≈ülama</th>
                    <th>Durum</th>
                    <th>ƒ∞≈ülemler</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <!-- Devamsƒ±zlƒ±k ve ƒ∞zin Takibi -->
    <div class="card">
        <h3>üìÖ Bu Ay Devamsƒ±zlƒ±k & ƒ∞zin Takibi</h3>
        
        <div style="margin-bottom: 20px;">
            <label>Personel Se√ßin:</label>
            <select id="attendancePersonnelSelect" onchange="loadPersonnelAttendance()">
                <option value="">Personel Se√ßiniz</option>
            </select>
        </div>

        <div id="attendanceSection" style="display: none;">
            <div class="grid-2" style="margin-bottom: 20px;">
                <button class="btn btn-success" onclick="markAttendance('present')">
                    ‚úÖ Geldi
                </button>
                <button class="btn btn-danger" onclick="markAttendance('absent')">
                    ‚ùå Gelmedi
                </button>
            </div>

            <button class="btn btn-warning" onclick="openLeaveRequestModal()">
                üèñÔ∏è ƒ∞zin Talebi Olu≈ütur
            </button>

            <div style="margin-top: 20px;">
                <h4>Bu Ayki Kayƒ±tlar:</h4>
                <div id="attendanceRecords"></div>
            </div>
        </div>
    </div>

<div class="card">
  <h3>ƒ∞zin Talepleri (Y√∂netici Paneli)</h3>
  <table>
    <thead>
      <tr>
        <th>Personel</th><th>Tarih</th><th>Tip</th><th>A√ßƒ±klama</th>
        <th>Durum</th><th>Onaylayan</th><th>Detay</th><th>ƒ∞≈ülem</th>
      </tr>
    </thead>
    <tbody id="adminLeaveRequestsTableBody"></tbody>
  </table>
</div>

<!-- PERSONEL TAB - MAA≈û √ñDEMELERƒ∞ REVƒ∞ZE -->
<div class="card">
    <h3>üí∞ Maa≈ü √ñdemeleri (Netten ƒ∞≈üveren Maliyeti)</h3>
    <div class="grid-3" style="margin-bottom: 20px;">
        <div class="form-group">
            <label>üìÖ Ay</label>
            <input type="month" id="salaryMonth" value="">
        </div>
        <div class="form-group">
            <label>üë§ Personel</label>
            <select id="salaryPersonnelSelect">
                <option value="">T√ºm Personel</option>
            </select>
        </div>
        <div class="form-group">
            <label>&nbsp;</label>
            <button class="btn btn-primary" onclick="processSalaryPayments()" style="width: 100%;">
                üí∏ Maa≈ü √ñdemelerini ƒ∞≈üle
            </button>
        </div>
    </div>
    <!-- Yeni UI alanlarƒ± -->
    <div class="grid-3" style="margin-bottom: 20px;">
        <div class="form-group">
            <label>Net Maa≈ü (‚Ç∫)</label>
            <input type="number" id="salaryNetInput" step="0.01" required>
        </div>
        <div class="form-group">
            <label>Ek Kazan√ß (‚Ç∫)</label>
            <input type="number" id="salaryExtraInput" step="0.01" value="0">
        </div>
        <div class="form-group">
            <label>Toplam ƒ∞≈üveren Maliyeti (‚Ç∫)</label>
            <input type="text" id="salaryTotalCostDisplay" readonly style="background:#f3f4f6;">
        </div>
    </div>
    <!-- Rapor tablosu -->
    <table id="salaryPaymentsTable">
        <thead>
            <tr>
                <th>Tarih</th>
                <th>Personel</th>
                <th>Net Maa≈ü</th>
                <th>Ek Kazan√ß</th>
                <th>Toplam ƒ∞≈üveren Maliyeti</th>
                <th>Durum</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

    <!-- Yƒ±llƒ±k maa≈ü tablosu -->
    <div class="card">
        <h3>üë§ Personel Yƒ±llƒ±k Maa≈ü Tablosu ve Dekont Y√ºkleme</h3>
        <div class="grid-3" style="margin-bottom: 20px;">
            <div class="form-group">
                <label>Yƒ±l</label>
                <select id="yearSalarySelect">
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
            </div>
            <div class="form-group">
                <label>Personel</label>
                <select id="yearPersonnelSelect"></select>
            </div>
            <div class="form-group">
                <label>&nbsp;</label>
                <button class="btn btn-info" onclick="renderYearlySalaryTable()">Yƒ±lƒ± Listele</button>
            </div>
        </div>
        <div id="yearlySalaryTableSection"></div>
    </div>

<!-- PERSONEL EKLEME/D√úZENLEME MODAL -->
<div id="personnelFormModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="personnelFormModalTitle">‚ûï Yeni Personel Ekle</h3>
            <button class="close-modal" onclick="closePersonnelFormModal()">‚úñ</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="personnelForm">
                <input type="hidden" id="personnelId">
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Ad Soyad *</label>
                        <input type="text" id="personnelName" required>
                    </div>
                    <div class="form-group">
                        <label>TC Kimlik No *</label>
                        <input type="text" id="personnelTCNo" maxlength="11" required>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Pozisyon *</label>
                        <input type="text" id="personnelPosition" required>
                    </div>
                    <div class="form-group">
                        <label>Telefon</label>
                        <input type="tel" id="personnelPhone">
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Br√ºt Maa≈ü (‚Ç∫) *</label>
                        <input type="number" id="personnelSalary" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>SGK Oranƒ± (%) *</label>
                        <input type="number" id="personnelSGKRate" value="14" step="0.01" required>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>ƒ∞≈üe Ba≈ülama Tarihi *</label>
                        <input type="date" id="personnelStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>Durum</label>
                        <select id="personnelStatus">
                            <option value="active">Aktif</option>
                            <option value="inactive">Pasif</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Adres</label>
                    <textarea id="personnelAddress" rows="2"></textarea>
                </div>
                
                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closePersonnelFormModal()">
                        ‚úñÔ∏è ƒ∞ptal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        üíæ Kaydet
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ƒ∞Zƒ∞N TALEBƒ∞ MODAL -->
<div id="leaveRequestModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3>üèñÔ∏è ƒ∞zin Talebi Olu≈ütur</h3>
            <button class="close-modal" onclick="closeLeaveRequestModal()">‚úñ</button>
        </div>
        
        <div style="padding: 20px;">
            <form id="leaveRequestForm">
                <div class="form-group">
                    <label>ƒ∞zin T√ºr√º *</label>
                    <select id="leaveType" required>
                        <option value="">Se√ßiniz</option>
                        <option value="annual">Yƒ±llƒ±k ƒ∞zin</option>
                        <option value="sick">Hastalƒ±k ƒ∞zni</option>
                        <option value="unpaid">√úcretsiz ƒ∞zin</option>
                        <option value="other">Diƒüer</option>
                    </select>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>Ba≈ülangƒ±√ß *</label>
                        <input type="date" id="leaveStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>Biti≈ü *</label>
                        <input type="date" id="leaveEndDate" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>A√ßƒ±klama</label>
                    <textarea id="leaveDescription" rows="3"></textarea>
                </div>
                
                <div style="text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeLeaveRequestModal()">
                        ‚úñÔ∏è ƒ∞ptal
                    </button>
                    <button type="submit" class="btn btn-primary">
                        üíæ ƒ∞zin Olu≈ütur
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>


    <script>

// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyDjIhTD6qJFnXITxQQ1z3KiFk-zS8mGhWU",
  authDomain: "muhasebe-takip-sistemi.firebaseapp.com",
  projectId: "muhasebe-takip-sistemi",
  storageBucket: "muhasebe-takip-sistemi.firebasestorage.app",
  messagingSenderId: "120946847757",
  appId: "1:120946847757:web:6b0da047efc34534bda544",
  measurementId: "G-M0CJHK3HWN"
};

// Firebase'i ba≈ülat
firebase.initializeApp(firebaseConfig);

// Servisleri hazƒ±rla
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

console.log('‚úÖ Firebase baƒülantƒ±sƒ± ba≈üarƒ±lƒ±!');

// GLOBAL DATA STORE
let companies = JSON.parse(localStorage.getItem('companies')) || [];
let accounts = JSON.parse(localStorage.getItem('accounts')) || [];
let invoices = JSON.parse(localStorage.getItem('invoices')) || [];
let payments = JSON.parse(localStorage.getItem('payments')) || [];
let activeCompanyId = localStorage.getItem('activeCompanyId') || null;
let currentInvoiceReceipt = null; // Invoice dekontƒ± i√ßin

// Global deƒüi≈ükenlere ekleyin
let companyDocuments = [];
let accountDocuments = [];
const MAX_ACCOUNT_DOCS = 5;
const MAX_ACCOUNT_SIZE = 3 * 1024 * 1024; // 3 MB
const currentUser = 'Alper4488'; // ƒ∞leride oturum sisteminden gelecek

// ========================================
// GLOBAL YARDIMCI FONKSƒ∞YONLAR
// ========================================

// T√ºrk√ße sayƒ± formatƒ±nƒ± parse et (10.737,6 ‚Üí 10737.6)
function parseTurkishNumber(str) {
    if (!str || typeof str !== 'string') return 0;
    
    str = str.trim();
    str = str.replace(/[^\d,.\-+]/g, ''); // Sadece sayƒ±, virg√ºl, nokta ve i≈üaret
    str = str.replace(/\./g, ''); // Binlik ayracƒ± noktayƒ± kaldƒ±r
    str = str.replace(',', '.'); // Virg√ºl√º noktaya √ßevir
    
    let num = parseFloat(str);
    console.log(`Parse: "${str}" ‚Üí ${num}`);
    return isNaN(num) ? 0 : num;
}

// INITIALIZATION
document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});


function initializeApp() {
    document.getElementById('invoiceDate').valueAsDate = new Date();
    document.getElementById('paymentDate').valueAsDate = new Date();
    
    loadCompanies();
    loadAccounts();
    loadInvoices();
    loadPayments();
    updateDashboard();
    populateSelects();
    
    addInvoiceItem();
    setupFormHandlers();
    
    // Aktif firma varsa cari form'da otomatik se√ß
    if (activeCompanyId) {
        const accountCompanySelect = document.getElementById('accountCompany');
        if (accountCompanySelect) {
            accountCompanySelect.value = activeCompanyId;
            updateAccountCompanyInfo();
        }
        
        // Filtre de otomatik se√ßili olsun
        const filterSelect = document.getElementById('filterAccountCompany');
        if (filterSelect) {
            filterSelect.value = activeCompanyId;
        }
    }
    loadPurchases();
    document.getElementById('purchaseDate').valueAsDate = new Date();

    // ‚úÖ PERSONEL mod√ºl√ºn√º y√ºkle
    loadPersonnel();
    populatePersonnelSelects();
    updatePersonnelStats();
    loadSalaryPayments();
}

        function setupFormHandlers() {
            document.getElementById('companyForm').addEventListener('submit', saveCompany);
            document.getElementById('accountForm').addEventListener('submit', saveAccount);
            document.getElementById('invoiceForm').addEventListener('submit', saveInvoice);
            document.getElementById('paymentForm').addEventListener('submit', savePayment);
    	    document.getElementById('purchaseForm').addEventListener('submit', savePurchase);
        }

        // TAB NAVIGATION
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            // Reload data when switching to payments tab
            if (tabName === 'payments') {
                loadPayments();
            }
 	    if (tabName === 'personnel') {
    		loadLeaveRequestsAdminPanel();
  	    }
        }

        // COMPANY FUNCTIONS

async function saveCompany(e) {
    e.preventDefault();
    
    if (!auth.currentUser) {
        alert('‚ö†Ô∏è L√ºtfen √∂nce giri≈ü yapƒ±n!');
        return;
    }
    
    const companyId = document.getElementById('companyId').value;
    const now = new Date().toISOString();
    
    // D√∂k√ºman validasyonu
    const validDocs = companyDocuments.filter(doc => doc.name && doc.file);
    
    try {
        let companyData;
        
        if (companyId) {
            // Update existing company
            const company = companies.find(c => c.id === companyId);
            
            company.name = document.getElementById('companyName').value;
            company.taxNo = document.getElementById('companyTaxNo').value;
            company.taxOffice = document.getElementById('companyTaxOffice').value;
            company.phone = document.getElementById('companyPhone').value;
            company.email = document.getElementById('companyEmail')?.value || '';
            company.website = document.getElementById('companyWebsite')?.value || '';
            company.sector = document.getElementById('companySector')?.value || '';
            company.address = document.getElementById('companyAddress')?.value || '';
            company.iban = document.getElementById('companyIBAN')?.value || '';
            company.documents = validDocs;
            company.updatedAt = now;
            company.updatedBy = auth.currentUser.uid;
            
            companyData = company;
        } else {
            // Create new company
            const newCompany = {
                id: Date.now().toString(),
                name: document.getElementById('companyName').value,
                taxNo: document.getElementById('companyTaxNo').value,
                taxOffice: document.getElementById('companyTaxOffice').value,
                phone: document.getElementById('companyPhone').value,
                email: document.getElementById('companyEmail')?.value || '',
                website: document.getElementById('companyWebsite')?.value || '',
                sector: document.getElementById('companySector')?.value || '',
                address: document.getElementById('companyAddress')?.value || '',
                iban: document.getElementById('companyIBAN')?.value || '',
                documents: validDocs,
                createdAt: now,
                createdBy: auth.currentUser.uid,
                members: [auth.currentUser.uid], // ‚úÖ Kullanƒ±cƒ±yƒ± √ºye olarak ekle
                admins: [auth.currentUser.uid]   // ‚úÖ Kullanƒ±cƒ±yƒ± admin olarak ekle
            };
            
            companies.push(newCompany);
            companyData = newCompany;
            
            // ‚úÖ ƒ∞lk firma ise otomatik aktif yap
            if (companies.length === 1) {
                activeCompanyId = newCompany.id;
            }
        }
        
        // ‚úÖ Firestore'a kaydet
        await db.collection('companies').doc(companyData.id).set(companyData);
        
        // ‚úÖ Kullanƒ±cƒ±nƒ±n firma listesine ekle
        const userRef = db.collection('users').doc(auth.currentUser.uid);
        await userRef.update({
            companies: firebase.firestore.FieldValue.arrayUnion(companyData.id)
        });
        
        // LocalStorage'a da kaydet (offline kullanƒ±m i√ßin)
        localStorage.setItem('companies', JSON.stringify(companies));
        localStorage.setItem('activeCompanyId', activeCompanyId);
        
        // Formu temizle
        document.getElementById('companyForm').reset();
        document.getElementById('companyId').value = '';
        companyDocuments = [];
        renderCompanyDocuments();
        
        closeCompanyModal();
        loadCompanies();
        updateDashboard();
        
        alert('‚úÖ Firma ba≈üarƒ±yla kaydedildi!');
        
    } catch (error) {
        console.error('Firma kayƒ±t hatasƒ±:', error);
        alert('‚ùå Hata: ' + error.message);
    }
}

// ========================================
// Fƒ∞RMA MODAL Y√ñNETƒ∞Mƒ∞
// ========================================

function openAddCompanyModal() {
    // Form temizle
    document.getElementById('companyForm').reset();
    document.getElementById('companyId').value = '';
    companyDocuments = [];
    renderCompanyDocuments();
    
    // Ba≈ülƒ±k deƒüi≈ütir
    document.getElementById('companyFormModalTitle').textContent = '‚ûï Yeni Firma Ekle';
    document.getElementById('saveCompanyBtn').textContent = 'üíæ Firma Kaydet';
    
    // Log bilgilerini gizle
    document.getElementById('companyLogInfo').style.display = 'none';
    
    // Modal'ƒ± a√ß
    document.getElementById('companyFormModal').classList.add('active');
}

function closeCompanyFormModal() {
    document.getElementById('companyFormModal').classList.remove('active');
    document.getElementById('companyForm').reset();
    document.getElementById('companyId').value = '';
    companyDocuments = [];
    renderCompanyDocuments();
}

function editCompany(id) {
    const company = companies.find(c => c.id === id);
    if (!company) return;

    document.getElementById('companyId').value = company.id;
    document.getElementById('companyName').value = company.name;
    document.getElementById('companyTaxNo').value = company.taxNo;
    document.getElementById('companyTaxOffice').value = company.taxOffice || '';
    document.getElementById('companyPhone').value = company.phone || '';
    document.getElementById('companyEmail').value = company.email || '';
    document.getElementById('companyWebsite').value = company.website || '';
    document.getElementById('companyAddress').value = company.address || '';
    document.getElementById('companySector').value = company.sector || '';

    // D√∂k√ºmanlarƒ± y√ºkle
    companyDocuments = company.documents ? JSON.parse(JSON.stringify(company.documents)) : [];
    renderCompanyDocuments();

    // Log bilgilerini g√∂ster
    if (company.createdAt) {
        const createdDate = new Date(company.createdAt).toLocaleString('tr-TR');
        const createdBy = company.createdBy || 'Bilinmiyor';
        document.getElementById('companyCreatedInfo').innerHTML = `üìù Olu≈üturulma: <strong>${createdDate}</strong> - <em>${createdBy}</em>`;
        
        if (company.updatedAt && company.updatedAt !== company.createdAt) {
            const updatedDate = new Date(company.updatedAt).toLocaleString('tr-TR');
            const updatedBy = company.updatedBy || 'Bilinmiyor';
            document.getElementById('companyUpdatedInfo').innerHTML = `üîÑ Son G√ºncelleme: <strong>${updatedDate}</strong> - <em>${updatedBy}</em>`;
        } else {
            document.getElementById('companyUpdatedInfo').innerHTML = '';
        }
        
        document.getElementById('companyLogInfo').style.display = 'block';
    }

    // Ba≈ülƒ±k deƒüi≈ütir
    document.getElementById('companyFormModalTitle').textContent = '‚úèÔ∏è Firma D√ºzenle - ' + company.name;
    document.getElementById('saveCompanyBtn').textContent = 'üíæ G√ºncelle';

    // Modal'ƒ± a√ß
    document.getElementById('companyFormModal').classList.add('active');
}

function cancelCompanyEdit() {
    closeCompanyFormModal();
}

// ========================================
// CARƒ∞ HESAP MODAL Y√ñNETƒ∞Mƒ∞
// ========================================

function openAddAccountModal() {
    // Firma kontrol√º
    if (companies.length === 0) {
        alert('‚ö†Ô∏è √ñnce en az bir firma eklemelisiniz!');
        showTab('companies');
        document.querySelector('.tab[onclick*="companies"]').click();
        return;
    }
    
    // Form temizle
    document.getElementById('accountForm').reset();
    document.getElementById('accountId').value = '';
    accountDocuments = [];
    renderAccountDocuments();
    
    // Aktif firma varsa otomatik se√ß
    if (activeCompanyId) {
        document.getElementById('accountCompany').value = activeCompanyId;
        updateAccountCompanyInfo();
    }
    
    // Ba≈ülƒ±k deƒüi≈ütir
    document.getElementById('accountFormModalTitle').textContent = '‚ûï Yeni Cari Hesap Ekle';
    document.getElementById('saveAccountBtn').textContent = 'üíæ Cari Kaydet';
    
    // Log bilgilerini gizle
    document.getElementById('accountLogInfo').style.display = 'none';
    
    // Modal'ƒ± a√ß
    document.getElementById('accountFormModal').classList.add('active');
}

function closeAccountFormModal() {
    document.getElementById('accountFormModal').classList.remove('active');
    document.getElementById('accountForm').reset();
    document.getElementById('accountId').value = '';
    accountDocuments = [];
    renderAccountDocuments();
}

function editAccount(id) {
    const account = accounts.find(a => a.id === id);
    if (!account) return;

    document.getElementById('accountId').value = account.id;
    document.getElementById('accountCompany').value = account.companyId;
    document.getElementById('accountName').value = account.name;
    document.getElementById('accountType').value = account.type;
    document.getElementById('accountTaxNo').value = account.taxNo || '';
    document.getElementById('accountPhone').value = account.phone || '';
    document.getElementById('accountEmail').value = account.email || '';
    document.getElementById('accountAddress').value = account.address || '';

    // D√∂k√ºmanlarƒ± y√ºkle
    accountDocuments = account.documents ? JSON.parse(JSON.stringify(account.documents)) : [];
    renderAccountDocuments();

    updateAccountCompanyInfo();

    // Log bilgilerini g√∂ster
    if (account.createdAt) {
        const createdDate = new Date(account.createdAt).toLocaleString('tr-TR');
        const createdBy = account.createdBy || 'Bilinmiyor';
        document.getElementById('accountCreatedInfo').innerHTML = `üìù Olu≈üturulma: <strong>${createdDate}</strong> - <em>${createdBy}</em>`;
        
        if (account.updatedAt && account.updatedAt !== account.createdAt) {
            const updatedDate = new Date(account.updatedAt).toLocaleString('tr-TR');
            const updatedBy = account.updatedBy || 'Bilinmiyor';
            document.getElementById('accountUpdatedInfo').innerHTML = `üîÑ Son G√ºncelleme: <strong>${updatedDate}</strong> - <em>${updatedBy}</em>`;
        } else {
            document.getElementById('accountUpdatedInfo').innerHTML = '';
        }
        
        document.getElementById('accountLogInfo').style.display = 'block';
    }

    // Ba≈ülƒ±k deƒüi≈ütir
    document.getElementById('accountFormModalTitle').textContent = '‚úèÔ∏è Cari Hesap D√ºzenle - ' + account.name;
    document.getElementById('saveAccountBtn').textContent = 'üíæ G√ºncelle';

    // Modal'ƒ± a√ß
    document.getElementById('accountFormModal').classList.add('active');
}

function cancelAccountEdit() {
    closeAccountFormModal();
}

// ========================================
// ARAMA FONKSƒ∞YONLARI
// ========================================

function searchCompanies() {
    const searchTerm = document.getElementById('searchCompany').value.toLowerCase();
    const tbody = document.querySelector('#companiesTable tbody');
    const rows = tbody.getElementsByTagName('tr');
    
    let visibleCount = 0;
    
    for (let row of rows) {
        const companyName = row.cells[0]?.textContent.toLowerCase() || '';
        const sector = row.cells[1]?.textContent.toLowerCase() || '';
        const taxNo = row.cells[2]?.textContent.toLowerCase() || '';
        
        if (companyName.includes(searchTerm) || sector.includes(searchTerm) || taxNo.includes(searchTerm)) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    }
}

function clearAccountFilters() {
    document.getElementById('filterAccountCompany').value = '';
    document.getElementById('filterAccountType').value = '';
    document.getElementById('searchAccount').value = '';
    filterAccountsByCompany();
}

async function loadCompanies() {
    if (!auth.currentUser) {
        console.log('‚ö†Ô∏è Kullanƒ±cƒ± yok, firmalar y√ºklenmiyor');
        companies = [];
        return;
    }
    
    try {
        const userDoc = await db.collection('users').doc(auth.currentUser.uid).get();
        const userData = userDoc.data();
        
        if (userData && userData.companies && userData.companies.length > 0) {
            const companiesSnapshot = await db.collection('companies')
                .where(firebase.firestore.FieldPath.documentId(), 'in', userData.companies)
                .get();
            
            companies = [];
            companiesSnapshot.forEach(doc => {
                companies.push({ id: doc.id, ...doc.data() });
            });
            
            console.log('‚úÖ Firmalar y√ºklendi:', companies.length);
        } else {
            companies = [];
            console.log('‚ÑπÔ∏è Kullanƒ±cƒ±ya ait firma yok');
        }
        
    } catch (error) {
        console.error('‚ùå Firma y√ºkleme hatasƒ±:', error);
        companies = [];
    }
    
    // ‚úÖ Render ve populate fonksiyonlarƒ±nƒ± √ßaƒüƒ±r
    renderCompaniesTable();
    populateCompanySelects(); // ‚úÖ ≈ûimdi bu fonksiyon var
}

// ========================================
// RENDER FONKSIYONLARI (Firebase ƒ∞√ßin Ayrƒ±lmƒ±≈ü)
// ========================================

function renderCompaniesTable() {
    const tbody = document.querySelector('#companiesTable tbody');
    if (!tbody) {
        console.warn('Companies table tbody bulunamadƒ±');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (companies.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">üè¢</div><h3>Hen√ºz firma yok</h3><p>Yeni firma eklemek i√ßin "Yeni Firma Ekle" butonunu kullanƒ±n.</p></td></tr>';
        return;
    }
    
    companies.forEach(company => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${company.name}</strong></td>
            <td>${company.taxNo || '-'}</td>
            <td>${company.phone || '-'}</td>
            <td>${company.sector || '-'}</td>
            <td>
                <button class="btn btn-sm btn-info" onclick="setActiveCompany('${company.id}')" title="Aktif Yap">
                    ${activeCompanyId === company.id ? '‚úÖ' : '‚≠ï'}
                </button>
            </td>
            <td>
                <button class="btn btn-sm" onclick="viewCompanyDetail('${company.id}')" title="Detay">üëÅÔ∏è</button>
                <button class="btn btn-warning btn-sm" onclick="editCompany('${company.id}')" title="D√ºzenle">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-sm" onclick="deleteCompany('${company.id}')" title="Sil">üóëÔ∏è</button>
            </td>
        `;
    });
    
    console.log('‚úÖ Firma tablosu render edildi');
}

function renderAccountsTable() {
    const tbody = document.querySelector('#accountsTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
    
    if (companyAccounts.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">üë•</div><h3>Hen√ºz cari hesap yok</h3><p>Yeni cari hesap eklemek i√ßin "Yeni Cari Ekle" butonunu kullanƒ±n.</p></td></tr>';
        return;
    }
    
    companyAccounts.forEach(account => {
        const typeText = account.type === 'customer' ? 'M√º≈üteri' : account.type === 'supplier' ? 'Tedarik√ßi' : 'Personel';
        const typeClass = account.type === 'customer' ? 'success' : account.type === 'supplier' ? 'warning' : 'info';
        const balanceColor = (account.balance || 0) >= 0 ? 'var(--success)' : 'var(--danger)';
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${account.name}</strong></td>
            <td><span class="badge badge-${typeClass}">${typeText}</span></td>
            <td>${account.phone || '-'}</td>
            <td>${account.email || '-'}</td>
            <td style="font-weight:700; color:${balanceColor};">${formatCurrency(account.balance || 0)}</td>
            <td>
                <button class="btn btn-sm" onclick="viewAccountCard('${account.id}')" title="Hesap Kartƒ±">üìä</button>
                <button class="btn btn-warning btn-sm" onclick="editAccount('${account.id}')" title="D√ºzenle">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-sm" onclick="deleteAccount('${account.id}')" title="Sil">üóëÔ∏è</button>
            </td>
        `;
    });
}

function renderInvoicesTable() {
    const tbody = document.querySelector('#invoicesTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    const companyInvoices = invoices
        .filter(inv => !activeCompanyId || inv.companyId === activeCompanyId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

    const totalCountElement = document.getElementById('totalInvoicesCount');
    if (totalCountElement) {
        totalCountElement.textContent = companyInvoices.length;
    }

    if (companyInvoices.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">üìÑ</div><h3>Hen√ºz fatura yok</h3><p>Yeni fatura eklemek veya E-Fatura import yapmak i√ßin yukarƒ±daki butonlarƒ± kullanƒ±n.</p></td></tr>';
        if (typeof updateRecentInvoices === 'function') {
            updateRecentInvoices();
        }
        return;
    }

    companyInvoices.forEach(invoice => {
        const account = accounts.find(a => a.id === invoice.accountId);
        const typeText = invoice.type === 'sales' ? 'üì§ Giden' : 'üì• Gelen';
        const typeColor = invoice.type === 'sales' ? 'var(--success)' : 'var(--danger)';
        
        const remaining = invoice.total - (invoice.paidAmount || 0);
        const paidAmountText = invoice.paidAmount > 0 ? formatCurrency(invoice.paidAmount) : '-';
        
        let statusText = '√ñdenmedi';
        let statusClass = 'badge-danger';
        
        if (invoice.status === 'paid' || remaining <= 0) {
            statusText = '√ñdendi';
            statusClass = 'badge-success';
        } else if (invoice.status === 'partial' || invoice.paidAmount > 0) {
            statusText = 'Kƒ±smi';
            statusClass = 'badge-warning';
        }

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${invoice.invoiceNo}</strong></td>
            <td>${formatDate(invoice.date)}</td>
            <td style="color: ${typeColor};">${typeText}</td>
            <td>${account ? account.name : 'Silinmi≈ü'}</td>
            <td style="font-weight: 700;">${formatCurrency(invoice.total)}</td>
            <td>${paidAmountText}</td>
            <td style="color: ${remaining > 0 ? 'var(--danger)' : 'var(--success)'};">
                ${formatCurrency(remaining)}
            </td>
            <td><span class="badge ${statusClass}">${statusText}</span></td>
            <td style="white-space: nowrap;">
                ${invoice.receiptUrl ? `
                    <button class="btn btn-sm btn-info" onclick="viewInvoiceReceipt('${invoice.id}')" title="Dekontu G√∂r√ºnt√ºle">
                        üìé
                    </button>
                ` : ''}
                <button class="btn btn-sm" onclick="viewInvoice('${invoice.id}')" title="Detay">üëÅÔ∏è</button>
                <button class="btn btn-info btn-sm" onclick="editInvoice('${invoice.id}')" title="D√ºzenle">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice.id}')" title="Sil">üóëÔ∏è</button>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    if (typeof updateRecentInvoices === 'function') {
        updateRecentInvoices();
    }
}

function renderPurchasesTable() {
    const tbody = document.querySelector('#purchasesTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const companyPurchases = purchases
        .filter(p => !activeCompanyId || p.companyId === activeCompanyId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const totalCountElement = document.getElementById('totalPurchasesCount');
    if (totalCountElement) {
        totalCountElement.textContent = companyPurchases.length;
    }
    
    if (companyPurchases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">üí∏</div><h3>Hen√ºz alƒ±≈ü kaydƒ± yok</h3><p>Yeni alƒ±≈ü eklemek i√ßin yukarƒ±daki butonu kullanƒ±n.</p></td></tr>';
        if (typeof updatePurchaseStats === 'function') {
            updatePurchaseStats([]);
        }
        return;
    }
    
    companyPurchases.forEach(purchase => {
        const paymentMethodText = {
            'cash': 'üíµ Nakit',
            'card': 'üí≥ Kart',
            'transfer': 'üè¶ Havale'
        }[purchase.paymentMethod] || purchase.paymentMethod;
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${formatDate(purchase.date)}</td>
            <td><span class="badge badge-info">${purchase.category}</span></td>
            <td><strong>${purchase.description}</strong></td>
            <td>${purchase.supplier || '-'}</td>
            <td>${formatCurrency(purchase.amount)}</td>
            <td>${formatCurrency(purchase.vatAmount)} <small>(%${purchase.vatRate})</small></td>
            <td style="font-weight: 700; color: var(--danger);">${formatCurrency(purchase.total)}</td>
            <td>${paymentMethodText}</td>
            <td>
                ${(purchase.receiptUrl || (purchase.receipt && purchase.receipt.file)) ? `
                    <button class="btn btn-info btn-sm" onclick="viewPurchaseReceipt('${purchase.id}')" title="Fi≈üi G√∂r√ºnt√ºle">
                        üìÑ
                    </button>
                ` : '<span style="color:#6b7280;">-</span>'}
            </td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editPurchase('${purchase.id}')" title="D√ºzenle">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-sm" onclick="deletePurchase('${purchase.id}')" title="Sil">üóëÔ∏è</button>
            </td>
        `;
    });
    
    if (typeof updatePurchaseStats === 'function') {
        updatePurchaseStats(companyPurchases);
    }
}

function renderPaymentsTable() {
    const tbody = document.querySelector('#paymentsTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const companyPayments = payments
        .filter(p => !activeCompanyId || p.companyId === activeCompanyId)
        .sort((a, b) => new Date(b.date) - new Date(a.date));
    
    if (companyPayments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">üí∞</div><h3>Hen√ºz √∂deme kaydƒ± yok</h3></td></tr>';
        return;
    }
    
    companyPayments.forEach(payment => {
        const account = accounts.find(a => a.id === payment.accountId);
        const typeText = payment.type === 'income' ? 'üì• Tahsilat' : 'üì§ √ñdeme';
        const typeColor = payment.type === 'income' ? 'var(--success)' : 'var(--danger)';
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${formatDate(payment.date)}</td>
            <td style="color:${typeColor};">${typeText}</td>
            <td>${account ? account.name : 'Silinmi≈ü'}</td>
            <td style="font-weight:700; color:${typeColor};">${formatCurrency(payment.amount)}</td>
            <td>${payment.description || '-'}</td>
            <td>
                <button class="btn btn-danger btn-sm" onclick="deletePayment('${payment.id}')" title="Sil">üóëÔ∏è</button>
            </td>
        `;
    });
}

function renderPersonnelTable() {
    const tbody = document.querySelector('#personnelTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const companyPersonnel = personnel.filter(p => !activeCompanyId || p.companyId === activeCompanyId);
    
    if (companyPersonnel.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px; color:#6b7280;"><div style="font-size:3em; margin-bottom:10px;">üë•</div><h3>Hen√ºz personel kaydƒ± yok</h3></td></tr>';
        return;
    }
    
    companyPersonnel.forEach(person => {
        const statusClass = person.status === 'active' ? 'success' : 'danger';
        const statusText = person.status === 'active' ? 'Aktif' : 'Pasif';
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td><strong>${person.name}</strong></td>
            <td>${person.position || '-'}</td>
            <td>${person.phone || '-'}</td>
            <td>${formatDate(person.startDate)}</td>
            <td><span class="badge badge-${statusClass}">${statusText}</span></td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editPersonnel('${person.id}')" title="D√ºzenle">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-sm" onclick="deletePersonnel('${person.id}')" title="Sil">üóëÔ∏è</button>
            </td>
        `;
    });
}

async function loadAccounts() {
    if (!activeCompanyId || !auth.currentUser) {
        accounts = [];
        renderAccountsTable(); // ‚úÖ Render √ßaƒüƒ±r
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('accounts').get();
        
        accounts = [];
        snapshot.forEach(doc => {
            accounts.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('‚úÖ Cari hesaplar y√ºklendi:', accounts.length);
        
    } catch (error) {
        console.error('‚ùå Cari hesap y√ºkleme hatasƒ±:', error);
        accounts = [];
    }
    
    renderAccountsTable(); // ‚úÖ Render √ßaƒüƒ±r
}

async function loadInvoices() {
    if (!activeCompanyId || !auth.currentUser) {
        invoices = [];
        renderInvoicesTable(); // ‚úÖ Render √ßaƒüƒ±r
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('invoices').orderBy('date', 'desc').get();
        
        invoices = [];
        snapshot.forEach(doc => {
            invoices.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('‚úÖ Faturalar y√ºklendi:', invoices.length);
        
    } catch (error) {
        console.error('‚ùå Fatura y√ºkleme hatasƒ±:', error);
        invoices = [];
    }
    
    renderInvoicesTable(); // ‚úÖ Render √ßaƒüƒ±r
}

// Firmadan Cari Hesaplara Ge√ßi≈ü Fonksiyonu
function viewCompanyAccounts(companyId) {
    // Firma se√ßimini g√ºncelle
    activeCompanyId = companyId;
    localStorage.setItem('activeCompanyId', activeCompanyId);
    
    // Filtre se√ßimini ayarla
    const filterSelect = document.getElementById('filterAccountCompany');
    if (filterSelect) {
        filterSelect.value = companyId;
    }
    
    // Cari Hesaplar sekmesine ge√ß
    showTab('accounts');
    document.querySelector('.tab[onclick*="accounts"]').click();
    
    // Tabloyu g√ºncelle
    populateSelects();
    loadAccounts();
    updateDashboard();
    
    // Bilgilendirme
    const company = companies.find(c => c.id === companyId);
    const accountCount = accounts.filter(a => a.companyId === companyId).length;
    
    setTimeout(() => {
        alert(`üìä ${company.name}\n\n${accountCount} cari hesap g√∂steriliyor.`);
    }, 300);
}

async function deleteCompany(id) {
    if (!confirm('Bu firmayƒ± ve t√ºm ilgili verileri silmek istediƒüinizden emin misiniz?')) {
        return;
    }
    
    try {
        // ‚úÖ Firestore'dan sil
        await db.collection('companies').doc(id).delete();
        
        // ‚úÖ Kullanƒ±cƒ±nƒ±n firma listesinden √ßƒ±kar
        const userRef = db.collection('users').doc(auth.currentUser.uid);
        await userRef.update({
            companies: firebase.firestore.FieldValue.arrayRemove(id)
        });
        
        // LocalStorage'dan sil
        companies = companies.filter(c => c.id !== id);
        
        // ƒ∞lgili verileri sil
        invoices = invoices.filter(inv => inv.companyId !== id);
        accounts = accounts.filter(acc => acc.companyId !== id);
        payments = payments.filter(pay => pay.companyId !== id);
        purchases = purchases.filter(pur => pur.companyId !== id);
        
        localStorage.setItem('companies', JSON.stringify(companies));
        localStorage.setItem('invoices', JSON.stringify(invoices));
        localStorage.setItem('accounts', JSON.stringify(accounts));
        localStorage.setItem('payments', JSON.stringify(payments));
        localStorage.setItem('purchases', JSON.stringify(purchases));
        
        // Aktif firma silinmi≈üse temizle
        if (activeCompanyId === id) {
            activeCompanyId = null;
            localStorage.removeItem('activeCompanyId');
        }
        
        loadCompanies();
        updateDashboard();
        
        alert('‚úÖ Firma ve ilgili t√ºm veriler silindi!');
        
    } catch (error) {
        console.error('Firma silme hatasƒ±:', error);
        alert('‚ùå Hata: ' + error.message);
    }
}


        function changeActiveCompany() {
            activeCompanyId = document.getElementById('activeCompanySelect').value;
            localStorage.setItem('activeCompanyId', activeCompanyId);
            updateDashboard();
            loadAccounts();
            loadInvoices();
            loadPayments();
            populateSelects();
        }


// ========================================
// ACCOUNT FUNCTIONS - G√úNCELLENMI≈û
// ========================================

function saveAccount(e) {
    e.preventDefault();
    const selectedCompanyId = document.getElementById('accountCompany').value;
    if (!selectedCompanyId) {
        alert('‚ö†Ô∏è L√ºtfen bir firma se√ßin!');
        return;
    }
    const accountId = document.getElementById('accountId').value;
    const now = new Date().toISOString();
    const validDocs = accountDocuments.filter(doc => doc.name && doc.file);

    if (accountId) {
        // Update existing account
        const account = accounts.find(a => a.id === accountId);
        account.companyId = selectedCompanyId;
        account.name = document.getElementById('accountName').value;
        account.type = document.getElementById('accountType').value; // <-- Personel tipi de gelir!
        account.taxNo = document.getElementById('accountTaxNo').value;
        account.phone = document.getElementById('accountPhone').value;
        account.email = document.getElementById('accountEmail')?.value || '';
        account.address = document.getElementById('accountAddress').value;
        account.documents = validDocs;
        account.updatedAt = now;
        account.updatedBy = currentUser;
    } else {
        // Create new account
        const account = {
            id: Date.now().toString(),
            companyId: selectedCompanyId,
            name: document.getElementById('accountName').value,
            type: document.getElementById('accountType').value, // <-- Personel tipi de gelir!
            taxNo: document.getElementById('accountTaxNo').value,
            phone: document.getElementById('accountPhone').value,
            email: document.getElementById('accountEmail')?.value || '',
            address: document.getElementById('accountAddress').value,
            balance: 0,
            documents: validDocs,
            createdAt: now,
            createdBy: currentUser,
            updatedAt: now,
            updatedBy: currentUser
        };
        accounts.push(account);
    }

    localStorage.setItem('accounts', JSON.stringify(accounts));
    document.getElementById('accountForm').reset();
    document.getElementById('accountId').value = '';
    accountDocuments = [];
    cancelAccountEdit();
    loadAccounts();
    populateSelects();
    alert('‚úÖ Cari hesap ba≈üarƒ±yla kaydedildi!');
}

function deleteAccount(id) {
    const account = accounts.find(a => a.id === id);
    
    // ƒ∞li≈ükili fatura kontrol√º
    const relatedInvoices = invoices.filter(inv => inv.accountId === id);
    const relatedPayments = payments.filter(p => p.accountId === id);
    
    if (relatedInvoices.length > 0 || relatedPayments.length > 0) {
        if (!confirm(`‚ö†Ô∏è Bu cari hesaba baƒülƒ± ${relatedInvoices.length} fatura ve ${relatedPayments.length} √∂deme var!\n\nSilmek istediƒüinizden emin misiniz?`)) {
            return;
        }
    } else {
        if (!confirm('Bu cari hesabƒ± silmek istediƒüinizden emin misiniz?')) {
            return;
        }
    }
    
    accounts = accounts.filter(a => a.id !== id);
    localStorage.setItem('accounts', JSON.stringify(accounts));
    loadAccounts();
    populateSelects();
    
    alert('‚úÖ Cari hesap silindi!');
}

function updateAccountCompanyInfo() {
    const companyId = document.getElementById('accountCompany').value;
    const company = companies.find(c => c.id === companyId);
    const infoDiv = document.getElementById('accountCompanyInfo');
    const infoSpan = document.getElementById('accountActiveCompanyName');
    
    if (company) {
        infoSpan.textContent = company.name;
        infoDiv.style.display = 'block';
    } else {
        infoDiv.style.display = 'none';
    }
}

function filterAccountsByCompany() {
    loadAccounts();
}

        // INVOICE FUNCTIONS
        let invoiceItems = [];

        function addInvoiceItem() {
            const item = {
                id: Date.now() + Math.random(),
                description: '',
                quantity: 1,
                unitPrice: 0,
                vatRate: 20,
                amount: 0,
                vatAmount: 0
            };

            invoiceItems.push(item);
            renderInvoiceItems();
        }

        function renderInvoiceItems() {
            const container = document.getElementById('invoiceItemsList');
            container.innerHTML = '';

            invoiceItems.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'invoice-item';
                div.innerHTML = `
                    <div class="form-group">
                        <label>A√ßƒ±klama</label>
                        <input type="text" value="${item.description}" onchange="updateInvoiceItem(${index}, 'description', this.value)" required>
                    </div>
                    <div class="form-group">
                        <label>Miktar</label>
                        <input type="number" value="${item.quantity}" onchange="updateInvoiceItem(${index}, 'quantity', this.value)" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Birim Fiyat</label>
                        <input type="number" value="${item.unitPrice}" onchange="updateInvoiceItem(${index}, 'unitPrice', this.value)" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>KDV %</label>
                        <select onchange="updateInvoiceItem(${index}, 'vatRate', this.value)">
                            <option value="0" ${item.vatRate == 0 ? 'selected' : ''}>%0</option>
                            <option value="1" ${item.vatRate == 1 ? 'selected' : ''}>%1</option>
                            <option value="8" ${item.vatRate == 8 ? 'selected' : ''}>%8</option>
                            <option value="10" ${item.vatRate == 10 ? 'selected' : ''}>%10</option>
                            <option value="18" ${item.vatRate == 18 ? 'selected' : ''}>%18</option>
                            <option value="20" ${item.vatRate == 20 ? 'selected' : ''}>%20</option>
                        </select>
                    </div>
                    <div>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeInvoiceItem(${index})">üóëÔ∏è</button>
                    </div>
                `;
                container.appendChild(div);
            });

            calculateInvoiceTotals();
        }

        function updateInvoiceItem(index, field, value) {
            invoiceItems[index][field] = field === 'description' ? value : parseFloat(value) || 0;
            calculateInvoiceTotals();
        }

        function removeInvoiceItem(index) {
            if (invoiceItems.length === 1) {
                alert('‚ö†Ô∏è En az bir fatura kalemi olmalƒ±dƒ±r!');
                return;
            }
            invoiceItems.splice(index, 1);
            renderInvoiceItems();
        }

        function calculateInvoiceTotals() {
            let subtotal = 0;
            let totalVAT = 0;

            invoiceItems.forEach(item => {
                item.amount = item.quantity * item.unitPrice;
                item.vatAmount = item.amount * (item.vatRate / 100);
                subtotal += item.amount;
                totalVAT += item.vatAmount;
            });

            const total = subtotal + totalVAT;

            document.getElementById('invoiceSubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('invoiceVAT').textContent = formatCurrency(totalVAT);
            document.getElementById('invoiceTotal').textContent = formatCurrency(total);
        }

async function saveInvoice(e) {
    e.preventDefault();

    if (!activeCompanyId) {
        alert('‚ö†Ô∏è L√ºtfen √∂nce bir firma se√ßin!');
        return;
    }

    if (invoiceItems.length === 0 || !invoiceItems[0].description) {
        alert('‚ö†Ô∏è L√ºtfen en az bir fatura kalemi ekleyin!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('‚ö†Ô∏è L√ºtfen √∂nce giri≈ü yapƒ±n!');
        return;
    }

    const invoiceId = document.getElementById('invoiceId').value;
    const subtotal = invoiceItems.reduce((sum, item) => sum + item.amount, 0);
    const vatAmount = invoiceItems.reduce((sum, item) => sum + item.vatAmount, 0);
    const total = subtotal + vatAmount;

    try {
        let receiptUrl = null;
        
        // ‚úÖ Eƒüer yeni dekont y√ºklendiyse Storage'a y√ºkle
        if (currentInvoiceReceipt && currentInvoiceReceipt instanceof File) {
            const tempId = invoiceId || Date.now().toString();
            const fileName = `${Date.now()}_${currentInvoiceReceipt.name}`;
            const storageRef = storage.ref(`companies/${activeCompanyId}/invoices/${tempId}/${fileName}`);
            
            const snapshot = await storageRef.put(currentInvoiceReceipt);
            receiptUrl = await snapshot.ref.getDownloadURL();
            
            console.log('‚úÖ Dekont y√ºklendi:', receiptUrl);
        }

        if (invoiceId) {
            // Update existing invoice
            const invoice = invoices.find(inv => inv.id === invoiceId);
            const oldTotal = invoice.total;
            const oldType = invoice.type;
            const oldAccountId = invoice.accountId;

            invoice.type = document.getElementById('invoiceType').value;
            invoice.invoiceNo = document.getElementById('invoiceNo').value;
            invoice.date = document.getElementById('invoiceDate').value;
            invoice.dueDate = document.getElementById('invoiceDueDate').value;
            invoice.accountId = document.getElementById('invoiceAccount').value;
            invoice.description = document.getElementById('invoiceDescription').value;
            invoice.items = JSON.parse(JSON.stringify(invoiceItems));
            invoice.subtotal = subtotal;
            invoice.vatAmount = vatAmount;
            invoice.total = total;
            invoice.receiptUrl = receiptUrl || invoice.receiptUrl; // ‚úÖ URL ekle/g√ºncelle
            invoice.updatedAt = new Date().toISOString();

            // Bakiye g√ºncellemeleri
            const oldAccount = accounts.find(a => a.id === oldAccountId);
            if (oldAccount) {
                if (oldType === 'sales') {
                    oldAccount.balance -= oldTotal;
                } else {
                    oldAccount.balance += oldTotal;
                }
            }

            const newAccount = accounts.find(a => a.id === invoice.accountId);
            if (newAccount) {
                if (invoice.type === 'sales') {
                    newAccount.balance += total;
                } else {
                    newAccount.balance -= total;
                }
            }
        } else {
            // Create new invoice
            const invoice = {
                id: Date.now().toString(),
                companyId: activeCompanyId,
                type: document.getElementById('invoiceType').value,
                invoiceNo: document.getElementById('invoiceNo').value,
                date: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('invoiceDueDate').value,
                accountId: document.getElementById('invoiceAccount').value,
                description: document.getElementById('invoiceDescription').value,
                items: JSON.parse(JSON.stringify(invoiceItems)),
                subtotal: subtotal,
                vatAmount: vatAmount,
                total: total,
                paidAmount: 0,
                status: 'unpaid',
                receiptUrl: receiptUrl, // ‚úÖ URL ekle
                createdAt: new Date().toISOString(),
                createdBy: auth.currentUser.uid
            };

            invoices.push(invoice);

            // Update account balance
            const account = accounts.find(a => a.id === invoice.accountId);
            if (account) {
                if (invoice.type === 'sales') {
                    account.balance += total;
                } else {
                    account.balance -= total;
                }
            }
        }
        
        // ‚úÖ Firestore'a da kaydet
        const invoiceToSave = invoices.find(inv => inv.id === (invoiceId || invoices[invoices.length - 1].id));
        await db.collection('companies').doc(activeCompanyId)
            .collection('invoices').doc(invoiceToSave.id).set(invoiceToSave);

        localStorage.setItem('invoices', JSON.stringify(invoices));
        localStorage.setItem('accounts', JSON.stringify(accounts));

        document.getElementById('invoiceForm').reset();
        document.getElementById('invoiceDate').valueAsDate = new Date();
        document.getElementById('invoiceId').value = '';
        invoiceItems = [];
        addInvoiceItem();
        cancelInvoiceEdit();
        
        // ‚úÖ Dekont temizle
        clearInvoiceReceipt();
        
        loadInvoices();
        loadAccounts();
        updateDashboard();

        alert('‚úÖ Fatura ba≈üarƒ±yla kaydedildi!');
        
    } catch (error) {
        console.error('Kayƒ±t hatasƒ±:', error);
        alert('‚ùå Hata: ' + error.message);
    }
}

        function editInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            document.getElementById('invoiceId').value = invoice.id;
            document.getElementById('invoiceType').value = invoice.type;
            document.getElementById('invoiceNo').value = invoice.invoiceNo;
            document.getElementById('invoiceDate').value = invoice.date;
            document.getElementById('invoiceDueDate').value = invoice.dueDate || '';
            document.getElementById('invoiceAccount').value = invoice.accountId;
            document.getElementById('invoiceDescription').value = invoice.description || '';

            invoiceItems = JSON.parse(JSON.stringify(invoice.items));
            renderInvoiceItems();

            document.getElementById('saveInvoiceBtn').textContent = 'üíæ G√ºncelle';
            document.getElementById('cancelInvoiceBtn').style.display = 'inline-block';

            showTab('invoices');
            document.getElementById('invoiceForm').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelInvoiceEdit() {
            document.getElementById('invoiceForm').reset();
            document.getElementById('invoiceId').value = '';
            document.getElementById('invoiceDate').valueAsDate = new Date();
            document.getElementById('saveInvoiceBtn').textContent = 'üíæ Fatura Kaydet';
            document.getElementById('cancelInvoiceBtn').style.display = 'none';
            invoiceItems = [];
            addInvoiceItem();
        }

        function viewInvoice(id) {
            const invoice = invoices.find(inv => inv.id === id);
            if (!invoice) return;

            const account = accounts.find(a => a.id === invoice.accountId);
            const company = companies.find(c => c.id === invoice.companyId);
            const typeText = invoice.type === 'sales' ? 'SATI≈û FATURASI' : 'ALI≈û FATURASI';
            
            let itemsHtml = '<table style="width:100%; margin-top:20px; border-collapse: collapse;"><thead><tr style="background:#2563eb; color:white;"><th style="padding:10px; border:1px solid #ddd;">A√ßƒ±klama</th><th style="padding:10px; border:1px solid #ddd;">Miktar</th><th style="padding:10px; border:1px solid #ddd;">Birim Fiyat</th><th style="padding:10px; border:1px solid #ddd;">KDV %</th><th style="padding:10px; border:1px solid #ddd;">Tutar</th></tr></thead><tbody>';
            
            invoice.items.forEach(item => {
                itemsHtml += `
                    <tr>
                        <td style="padding:10px; border:1px solid #ddd;">${item.description}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:center;">${item.quantity}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right;">${formatCurrency(item.unitPrice)}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:center;">%${item.vatRate}</td>
                        <td style="padding:10px; border:1px solid #ddd; text-align:right;"><strong>${formatCurrency(item.amount + item.vatAmount)}</strong></td>
                    </tr>
                `;
            });
            
            itemsHtml += '</tbody></table>';

            const remaining = invoice.total - (invoice.paidAmount || 0);
            const paymentStatusHtml = invoice.paidAmount > 0 ? `
                <div style="margin-top:20px; padding:15px; background:#dbeafe; border-radius:8px;">
                    <p><strong>√ñdeme Durumu:</strong></p>
                    <p>√ñdenen: ${formatCurrency(invoice.paidAmount)}</p>
                    <p>Kalan: ${formatCurrency(remaining)}</p>
                </div>
            ` : '';

            const content = `
                <div style="max-width: 900px; margin: 0 auto;">
                    <h2 style="color:#2563eb; border-bottom:3px solid #2563eb; padding-bottom:10px;">${typeText}</h2>
                    <div style="margin: 20px 0; padding: 20px; background: #f3f4f6; border-radius: 8px;">
                        <p><strong>Firma:</strong> ${company ? company.name : '-'}</p>
                        <p><strong>Fatura No:</strong> ${invoice.invoiceNo}</p>
                        <p><strong>Tarih:</strong> ${formatDate(invoice.date)}</p>
                        ${invoice.dueDate ? `<p><strong>Vade:</strong> ${formatDate(invoice.dueDate)}</p>` : ''}
                        <p><strong>Cari:</strong> ${account ? account.name : 'Silinmi≈ü'}</p>
                        <p><strong>A√ßƒ±klama:</strong> ${invoice.description || '-'}</p>
                    </div>
                    ${itemsHtml}
                    ${paymentStatusHtml}
                    <div style="margin-top:30px; text-align:right; padding:20px; background:#f3f4f6; border-radius:8px;">
                        <p style="font-size:1.1em;"><strong>Ara Toplam:</strong> ${formatCurrency(invoice.subtotal)}</p>
                        <p style="font-size:1.1em;"><strong>KDV:</strong> ${formatCurrency(invoice.vatAmount)}</p>
                        <hr style="margin:15px 0;">
                        <p style="font-size:2em; color:#2563eb;"><strong>TOPLAM:</strong> ${formatCurrency(invoice.total)}</p>
                    </div>
                </div>
            `;

            const win = window.open('', 'Fatura', 'width=900,height=700');
            win.document.write(`
                <html>
                    <head>
                        <title>Fatura ${invoice.invoiceNo}</title>
                        <meta charset="UTF-8">
                        <style>
                            body { font-family: Arial, sans-serif; padding: 40px; }
                            @media print { button { display: none !important; } }
                        </style>
                    </head>
                    <body>
                        ${content}
                        <div style="text-align:center; margin-top:30px;">
                            <button onclick="window.print()" style="padding:12px 30px; background:#2563eb; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px;">üñ®Ô∏è Yazdƒ±r</button>
                            <button onclick="window.close()" style="padding:12px 30px; background:#6b7280; color:white; border:none; border-radius:8px; cursor:pointer; font-size:16px; margin-left:10px;">‚úñÔ∏è Kapat</button>
                        </div>
                    </body>
                </html>
            `);
        }

function deleteInvoice(id) {
    if (!confirm('Bu faturayƒ± silmek istediƒüinizden emin misiniz?')) return;

    const invoice = invoices.find(inv => inv.id === id);
    
    if (invoice) {
        // ‚úÖ √ñnce fatura ile ili≈ükili √∂demeleri kontrol et
        const relatedPayments = payments.filter(p => p.invoiceId === id);
        
        if (relatedPayments.length > 0) {
            const totalPaid = relatedPayments.reduce((sum, p) => sum + p.amount, 0);
            
            if (!confirm(`‚ö†Ô∏è Bu faturaya ${formatCurrency(totalPaid)} √∂deme yapƒ±lmƒ±≈ü!\n\nFatura ve √∂demeler silinecek. Devam edilsin mi?`)) {
                return;
            }
            
            // √ñdemeleri de sil ve bakiyeyi d√ºzelt
            relatedPayments.forEach(payment => {
                const payAccount = accounts.find(a => a.id === payment.accountId);
                if (payAccount) {
                    if (payAccount.type === 'customer') {
                        if (payment.type === 'income') {
                            payAccount.balance += payment.amount; // Tahsilatƒ± iptal et
                        }
                    } else {
                        if (payment.type === 'expense') {
                            payAccount.balance -= payment.amount; // √ñdemeyi iptal et
                        }
                    }
                }
            });
            
            // √ñdemeleri sil
            payments = payments.filter(p => p.invoiceId !== id);
        }

        // ‚úÖ Fatura bakiyesini geri al
        const account = accounts.find(a => a.id === invoice.accountId);
        if (account) {
            // Kalan tutarƒ± geri al (√∂denmemi≈ü kƒ±sƒ±m)
            const remainingAmount = invoice.total - (invoice.paidAmount || 0);
            
            if (invoice.type === 'sales') {
                account.balance -= remainingAmount;
            } else {
                account.balance += remainingAmount;
            }
        }
    }

    invoices = invoices.filter(inv => inv.id !== id);
    
    localStorage.setItem('invoices', JSON.stringify(invoices));
    localStorage.setItem('payments', JSON.stringify(payments));
    localStorage.setItem('accounts', JSON.stringify(accounts));
    
    loadInvoices();
    loadAccounts();
    loadPayments();
    updateDashboard();

    alert('‚úÖ Fatura ve ilgili √∂demeler silindi!');
}

        function filterInvoices() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const type = document.getElementById('filterType').value;
            const status = document.getElementById('filterPaymentStatus').value;

            const tbody = document.querySelector('#invoicesTable tbody');
            tbody.innerHTML = '';

            let filtered = invoices.filter(inv => !activeCompanyId || inv.companyId === activeCompanyId);

            if (startDate) filtered = filtered.filter(inv => inv.date >= startDate);
            if (endDate) filtered = filtered.filter(inv => inv.date <= endDate);
            if (type) filtered = filtered.filter(inv => inv.type === type);
            if (status) {
                filtered = filtered.filter(inv => {
                    const remaining = inv.total - (inv.paidAmount || 0);
                    if (status === 'paid') return remaining <= 0;
                    if (status === 'partial') return inv.paidAmount > 0 && remaining > 0;
                    if (status === 'unpaid') return inv.paidAmount === 0;
                    return true;
                });
            }

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:20px;">Sonu√ß bulunamadƒ±.</td></tr>';
                return;
            }

            // Render filtered invoices (same as loadInvoices)
            filtered.forEach(invoice => {
                const account = accounts.find(a => a.id === invoice.accountId);
                const typeText = invoice.type === 'sales' ? 'üìó Satƒ±≈ü' : 'üìï Alƒ±≈ü';
                const remaining = invoice.total - (invoice.paidAmount || 0);
                
                let statusText = '√ñdenmedi';
                let statusClass = 'status-unpaid';
                if (invoice.paidAmount >= invoice.total) {
                    statusText = '√ñdendi';
                    statusClass = 'status-paid';
                } else if (invoice.paidAmount > 0) {
                    statusText = 'Kƒ±smi';
                    statusClass = 'status-partial';
                }
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(invoice.date)}</td>
                    <td><strong>${invoice.invoiceNo}</strong></td>
                    <td>${typeText}</td>
                    <td>${account ? account.name : 'Silinmi≈ü'}</td>
                    <td><strong>${formatCurrency(invoice.total)}</strong></td>
                    <td>${formatCurrency(invoice.paidAmount || 0)}</td>
                    <td style="color: ${remaining > 0 ? 'var(--danger)' : 'var(--success)'};">${formatCurrency(remaining)}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-info btn-sm" onclick="viewInvoice('${invoice.id}')">üëÅÔ∏è</button>
                        <button class="btn btn-warning btn-sm" onclick="editInvoice('${invoice.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteInvoice('${invoice.id}')">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function clearInvoiceFilters() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterPaymentStatus').value = '';
            loadInvoices();
        }

        // PAYMENT FUNCTIONS
        function openPaymentModal() {
            if (!activeCompanyId) {
                alert('‚ö†Ô∏è L√ºtfen √∂nce bir firma se√ßin!');
                return;
            }
            document.getElementById('paymentModal').classList.add('active');
            document.getElementById('paymentDate').valueAsDate = new Date();
            populatePaymentAccounts();
        }

        function closePaymentModal() {
            document.getElementById('paymentModal').classList.remove('active');
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentId').value = '';
        }

        function populatePaymentAccounts() {
            const select = document.getElementById('paymentAccount');
            select.innerHTML = '<option value="">Se√ßiniz</option>';
            
            const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
            companyAccounts.forEach(account => {
                const option = new Option(`${account.name} (${account.type === 'customer' ? 'M√º≈üteri' : 'Tedarik√ßi'})`, account.id);
                select.add(option);
            });
        }

        function loadAccountInvoices() {
            const accountId = document.getElementById('paymentAccount').value;
            const select = document.getElementById('paymentInvoice');
            select.innerHTML = '<option value="">Genel √ñdeme (Fatura Yok)</option>';

            if (!accountId) return;

            const accountInvoices = invoices.filter(inv => 
                inv.accountId === accountId && 
                (inv.total - (inv.paidAmount || 0)) > 0
            );

            accountInvoices.forEach(invoice => {
                const remaining = invoice.total - (invoice.paidAmount || 0);
                const option = new Option(
                    `${invoice.invoiceNo} - ${formatCurrency(remaining)} kalan`,
                    invoice.id
                );
                select.add(option);
            });
        }

        function savePayment(e) {
            e.preventDefault();

            const payment = {
                id: Date.now().toString(),
                companyId: activeCompanyId,
                date: document.getElementById('paymentDate').value,
                accountId: document.getElementById('paymentAccount').value,
                amount: parseFloat(document.getElementById('paymentAmount').value),
                type: document.getElementById('paymentType').value,
                invoiceId: document.getElementById('paymentInvoice').value || null,
                description: document.getElementById('paymentDescription').value,
                source: 'manual',
                createdAt: new Date().toISOString()
            };

            payments.push(payment);

            // Update invoice if linked
            if (payment.invoiceId) {
                const invoice = invoices.find(inv => inv.id === payment.invoiceId);
                if (invoice) {
                    invoice.paidAmount = (invoice.paidAmount || 0) + payment.amount;
                    
                    // Update status
                    if (invoice.paidAmount >= invoice.total) {
                        invoice.status = 'paid';
                    } else if (invoice.paidAmount > 0) {
                        invoice.status = 'partial';
                    }
                }
            }

            // Update account balance
const account = accounts.find(a => a.id === payment.accountId);
if (account) {
    if (account.type === 'customer') {
        // M√ú≈ûTERƒ∞
        if (payment.type === 'income') {
            account.balance -= payment.amount; // Tahsilat ‚Üí Bor√ß azalƒ±r
        } else {
            account.balance += payment.amount; // ƒ∞ade ‚Üí Bor√ß artar
        }
    } else {
        // TEDARƒ∞K√áƒ∞
        if (payment.type === 'expense') {
            account.balance += payment.amount; // √ñdeme ‚Üí Alacak azalƒ±r (negatiften 0'a)
        } else {
            account.balance -= payment.amount; // ƒ∞ade ‚Üí Alacak artar
        }
    }
}

            localStorage.setItem('payments', JSON.stringify(payments));
            localStorage.setItem('invoices', JSON.stringify(invoices));
            localStorage.setItem('accounts', JSON.stringify(accounts));

            closePaymentModal();
            loadPayments();
            loadInvoices();
            loadAccounts();
            updateDashboard();

            alert('‚úÖ √ñdeme ba≈üarƒ±yla kaydedildi!');
        }

async function loadPayments() {
    if (!activeCompanyId || !auth.currentUser) {
        payments = [];
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('payments').orderBy('date', 'desc').get();
        
        payments = [];
        snapshot.forEach(doc => {
            payments.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('‚úÖ √ñdemeler y√ºklendi:', payments.length);
        
    } catch (error) {
        console.error('‚ùå √ñdeme y√ºkleme hatasƒ±:', error);
        payments = [];
    }
    
    renderPaymentsTable();
}

        function deletePayment(id) {
            if (!confirm('Bu √∂deme kaydƒ±nƒ± silmek istediƒüinizden emin misiniz?')) return;

            const payment = payments.find(p => p.id === id);
            
            if (payment) {
                // Revert invoice payment
                if (payment.invoiceId) {
                    const invoice = invoices.find(inv => inv.id === payment.invoiceId);
                    if (invoice) {
                        invoice.paidAmount = (invoice.paidAmount || 0) - payment.amount;
                        if (invoice.paidAmount <= 0) {
                            invoice.status = 'unpaid';
                            invoice.paidAmount = 0;
                        } else if (invoice.paidAmount < invoice.total) {
                            invoice.status = 'partial';
                        }
                    }
                }

// Revert account balance
const account = accounts.find(a => a.id === payment.accountId);
if (account) {
    if (account.type === 'customer') {
        // M√ú≈ûTERƒ∞ - √ñdeme silinince bakiyeyi eski haline getir
        if (payment.type === 'income') {
            account.balance += payment.amount; // Tahsilat iptal ‚Üí Bor√ß tekrar artar
        } else {
            account.balance -= payment.amount; // ƒ∞ade iptal ‚Üí Bor√ß azalƒ±r
        }
    } else {
        // TEDARƒ∞K√áƒ∞
        if (payment.type === 'expense') {
            account.balance -= payment.amount; // √ñdeme iptal ‚Üí Alacak tekrar artar (daha negatif)
        } else {
            account.balance += payment.amount; // ƒ∞ade iptal ‚Üí Alacak azalƒ±r
        }
    }
}

            }

            payments = payments.filter(p => p.id !== id);
            
            localStorage.setItem('payments', JSON.stringify(payments));
            localStorage.setItem('invoices', JSON.stringify(invoices));
            localStorage.setItem('accounts', JSON.stringify(accounts));

            loadPayments();
            loadInvoices();
            loadAccounts();
            updateDashboard();

            alert('‚úÖ √ñdeme kaydƒ± silindi!');
        }

        function filterPayments() {
            const startDate = document.getElementById('paymentFilterStart').value;
            const endDate = document.getElementById('paymentFilterEnd').value;
            const accountId = document.getElementById('paymentFilterAccount').value;

            const tbody = document.querySelector('#paymentsTable tbody');
            tbody.innerHTML = '';

            let filtered = payments.filter(p => !activeCompanyId || p.companyId === activeCompanyId);

            if (startDate) filtered = filtered.filter(p => p.date >= startDate);
            if (endDate) filtered = filtered.filter(p => p.date <= endDate);
            if (accountId) filtered = filtered.filter(p => p.accountId === accountId);

            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px;">Sonu√ß bulunamadƒ±.</td></tr>';
                return;
            }

            filtered.forEach(payment => {
                const account = accounts.find(a => a.id === payment.accountId);
                const invoice = payment.invoiceId ? invoices.find(inv => inv.id === payment.invoiceId) : null;
                const typeText = payment.type === 'income' ? 'üìó Tahsilat' : 'üìï √ñdeme';
                const sourceText = payment.source === 'manual' ? 'Manuel' : 'Banka';

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(payment.date)}</td>
                    <td>${account ? account.name : 'Silinmi≈ü'}</td>
                    <td style="color: ${payment.type === 'income' ? 'var(--success)' : 'var(--danger)'};">
                        ${payment.type === 'income' ? '+' : '-'}${formatCurrency(payment.amount)}
                    </td>
                    <td>${typeText}</td>
                    <td>${invoice ? invoice.invoiceNo : '-'}</td>
                    <td>${payment.description || '-'}</td>
                    <td><span class="badge badge-${payment.source === 'manual' ? 'info' : 'success'}">${sourceText}</span></td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deletePayment('${payment.id}')">üóëÔ∏è</button>
                    </td>
                `;
            });
        }

        function clearPaymentFilters() {
            document.getElementById('paymentFilterStart').value = '';
            document.getElementById('paymentFilterEnd').value = '';
            document.getElementById('paymentFilterAccount').value = '';
            loadPayments();
        }

        // BANK IMPORT FUNCTIONS
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        }

        function importBankStatement(event) {
            const file = event.target.files[0];
            if (!file) return;
            processFile(file);
        }

function processFile(file) {
    console.log('üìÇ Dosya y√ºkleniyor:', file.name, 'Boyut:', file.size, 'bytes');
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            console.log('‚úÖ Dosya okundu, uzunluk:', content.length);
            console.log('ƒ∞lk 500 karakter:', content.substring(0, 500));
            
            if (file.name.endsWith('.csv') || file.name.endsWith('.txt')) {
                const transactions = parseCSV(content); // parseCSV'den d√∂nen deƒüeri al
                
                if (transactions && transactions.length > 0) {
                    console.log('‚úÖ Parse ba≈üarƒ±lƒ±, modal a√ßƒ±lƒ±yor...');
                    showTransactionDetailsModal(transactions); // ‚Üê BURASI √ñNEMLƒ∞
                } else {
                    alert('‚ùå CSV dosyasƒ±nda ge√ßerli i≈ülem bulunamadƒ±!');
                }
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                alert('‚ö†Ô∏è Excel dosyalarƒ± i√ßin CSV formatƒ±na √ßevirip y√ºkleyin.\n\nExcel\'de: Dosya ‚Üí Farklƒ± Kaydet ‚Üí "CSV UTF-8 (Virg√ºlle ayrƒ±lmƒ±≈ü)" se√ßin.');
            } else {
                alert('‚ùå Desteklenmeyen dosya formatƒ±!\n\nDesteklenen: .csv, .txt');
            }
        } catch (error) {
            console.error('‚ùå Hata:', error);
            alert('‚ùå Dosya okunamadƒ±: ' + error.message);
        }
    };

    reader.onerror = function() {
        console.error('‚ùå FileReader hatasƒ±');
        alert('‚ùå Dosya okuma hatasƒ±!');
    };

    reader.readAsText(file, 'UTF-8');
}


function parseCSV(content) {
    console.log('üìÇ CSV Parse i≈ülemi ba≈ülatƒ±lƒ±yor...');
    console.log('CSV Content ba≈ülangƒ±√ß:', content.substring(0, 500));

    let lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);
    console.log('Toplam satƒ±r sayƒ±sƒ±:', lines.length);

    if (lines.length === 0) {
        console.error('‚ö†Ô∏è CSV dosyasƒ± bo≈ü!');
        return [];
    }

    console.log('Header:', lines[0]);

    let parsedTransactions = [];

    // ========================================
    // ƒ∞≈ûLEM SATIRLARINI PARSE ET
    // ========================================
    console.log("\nüìù ƒ∞≈ülem satƒ±rlarƒ±nƒ± parse ediyorum...");

    for (let i = 1; i < lines.length; i++) {
        console.log(`\nSatƒ±r ${i}: ${lines[i]}`);
        
        let parts = lines[i].split(';');
        console.log('Noktalƒ± virg√ºl ile ayrƒ±ldƒ±, par√ßa sayƒ±sƒ±:', parts.length);
        console.log('Par√ßalar:', parts);

        // Eƒüer satƒ±r yeterli s√ºtuna sahip deƒüilse atla
        if (parts.length < 9) {
            console.log('‚ö†Ô∏è Bu satƒ±rda yeterli s√ºtun yok, atlanƒ±yor');
            continue;
        }

        // --- VERƒ∞ √áIKARMA (ƒ∞lk Yakla≈üƒ±m) ---
        let tarih = parts[0]?.trim() || '';
        let valor = parts[1]?.trim() || '';
        let kanal = parts[2]?.trim() || '';
        let tutarStr = parts[3]?.trim() || '';
        let bakiyeStr = parts[4]?.trim() || '';
        let islemTipi = parts[7]?.trim() || '';
        let aciklama = parts[8]?.trim() || ''; // S√ºtun 8'deki a√ßƒ±klama

        console.log('√áƒ±karƒ±lan veriler:');
        console.log('  Tarih:', tarih);
        console.log('  Tutar:', tutarStr);
        console.log('  Bakiye:', bakiyeStr);
        console.log('  A√ßƒ±klama (S√ºtun 8):', aciklama);
        console.log('  Kanal:', kanal);
        console.log('  ƒ∞≈ülem Tipi:', islemTipi);

        // --- ƒ∞Kƒ∞NCƒ∞ YAKLA≈ûIM: Farklƒ± Format Kontrol√º ---
        if (!tutarStr && parts.length >= 15) {
            tarih = parts[1]?.trim() || '';
            tutarStr = parts[3]?.trim() || '';
            bakiyeStr = parts[4]?.trim() || '';
            
            // √ñnce s√ºtun 8'i kontrol et, yoksa s√ºtun 14'√º kullan
            let sutun8 = parts[8]?.trim() || '';
            let sutun14 = parts[14]?.trim() || '';
            
            // Eƒüer s√ºtun 8 bo≈ü veya sadece referans numarasƒ± gibi g√∂r√ºn√ºyorsa
            if (!sutun8 || sutun8.match(/^\d{29,}$/)) {
                aciklama = sutun14 || sutun8 || 'A√ßƒ±klama yok';
            } else {
                aciklama = sutun8;
            }
            
            console.log('√áƒ±karƒ±lan veriler (2. yakla≈üƒ±m):');
            console.log('  Tarih:', tarih);
            console.log('  Tutar:', tutarStr);
            console.log('  Bakiye:', bakiyeStr);
            console.log('  A√ßƒ±klama:', aciklama);
        }

        // --- TUTAR PARSE ---
        let tutar = parseTurkishNumber(tutarStr);

        if (tutar === 0 || isNaN(tutar)) {
            console.log('Tutar 0 veya ge√ßersiz, atlandƒ±');
            continue;
        }

        // --- TARƒ∞H STANDARDIZASYONU ---
        let dateMatch = tarih.match(/(\d{2})\/(\d{2})\/(\d{4})/);
        let standardDate = '';
        if (dateMatch) {
            let [, day, month, year] = dateMatch;
            standardDate = `${year}-${month}-${day}`;
        } else {
            console.log('‚ö†Ô∏è Tarih formatƒ± tanƒ±nmadƒ±, atlandƒ±');
            continue;
        }

        // --- BAKƒ∞YE PARSE ---
        let bakiye = parseTurkishNumber(bakiyeStr);

        // --- A√áIKLAMA ƒ∞Yƒ∞LE≈ûTƒ∞RME ---
        // Eƒüer a√ßƒ±klama hala bo≈ü veya sadece referans numarasƒ± ise
        if (!aciklama || aciklama.match(/^\d{29,}$/)) {
            // √ñnce s√ºtun 8'i tekrar kontrol et
            if (parts[8]?.trim() && !parts[8].trim().match(/^\d{29,}$/)) {
                aciklama = parts[8].trim();
            } 
            // Sonra kanal ve i≈ülem tipini birle≈ütir
            else if (kanal || islemTipi) {
                aciklama = [kanal, islemTipi].filter(x => x).join(' - ') || 'A√ßƒ±klama yok';
            } 
            // Son √ßare: "A√ßƒ±klama yok"
            else {
                aciklama = 'A√ßƒ±klama yok';
            }
        }

        // Uzun a√ßƒ±klamalarƒ± kƒ±salt (150 karakterden uzunsa)
        if (aciklama.length > 150) {
            aciklama = aciklama.substring(0, 147) + '...';
        }

        // --- TRANSACTION KAYDET ---
        parsedTransactions.push({
            date: standardDate,
            description: aciklama,
            amount: tutar,
            balance: bakiye,
            channel: kanal || 'Bilinmiyor',
            type: islemTipi || 'Bilinmiyor'
        });

        console.log('‚úÖ Transaction eklendi:', parsedTransactions[parsedTransactions.length - 1]);
    }

    console.log('\nüìä Toplam i≈ülem sayƒ±sƒ±:', parsedTransactions.length);
    return parsedTransactions;
}

function parseAmount(amountStr) {
    try {
        // T√ºm bo≈üluklarƒ± temizle
        let cleaned = amountStr.replace(/\s/g, '');
        
        // T√ºrk√ße format: 73.000,50 veya -73.000,50
        // Binlik ayracƒ± (.) kaldƒ±r, ondalƒ±k ayracƒ± (,) noktaya √ßevir
        cleaned = cleaned.replace(/\./g, '');  // 73000,50
        cleaned = cleaned.replace(',', '.');   // 73000.50
        
        const result = parseFloat(cleaned) || 0;
        
        // Debug i√ßin
        console.log(`Parse: "${amountStr}" ‚Üí ${result}`);
        
        return result;
    } catch (e) {
        console.error('Amount parse error:', amountStr, e);
        return 0;
    }
}

function parseDate(dateStr) {
    // Format: 11/09/2025-10:32:37 veya 11.09.2025
    try {
        const datePart = dateStr.split(/[-\s]/)[0]; // Saat kƒ±smƒ±nƒ± at
        const parts = datePart.split(/[\/\.]/);
        
        if (parts.length === 3) {
            const day = parts[0].padStart(2, '0');
            const month = parts[1].padStart(2, '0');
            const year = parts[2];
            return `${year}-${month}-${day}`;
        }
    } catch (e) {
        console.error('Date parse error:', dateStr, e);
    }
    return null;
}

function extractFromTo(description, amount) {
    // A√ßƒ±klama temizleme
    let cleanDesc = description.trim();
    
    console.log(`üîç E≈üle≈ütirme: "${cleanDesc.substring(0, 80)}" | Tutar: ${amount}`);
    
    // BSMV, komisyon gibi banka √ºcretleri
    if (cleanDesc.match(/BSMV|KOMƒ∞SYON|MASRAF|√úCRET.*H\d+/i)) {
        return 'üí≥ Banka √úcreti';
    }
    
    // Format 1: "ƒ∞Sƒ∞M*TR...*A√ßƒ±klama" (En yaygƒ±n)
    // √ñrnek: "AY≈ûENUR ATE≈û DEMƒ∞RKAN*TR270006400000115220278205*NORA √áEVRE..."
    const nameIbanMatch = cleanDesc.match(/^([^*]+)\*TR\d+/i);
    if (nameIbanMatch) {
        const name = nameIbanMatch[1].trim();
        console.log(`‚úÖ Format 1 bulundu: "${name}"`);
        return name;
    }
    
    // Format 2: "ƒ∞Sƒ∞M*A√ßƒ±klama" (IBAN yok)
    // √ñrnek: "ZET A≈û*ZET LOJƒ∞STƒ∞K HAZIR BETON SANAYƒ∞..."
    const nameStarMatch = cleanDesc.match(/^([A-Z√áƒûƒ∞√ñ≈û√úa-z√ßƒüƒ±√∂≈ü√º\s\.]+)\*/);
    if (nameStarMatch) {
        const name = nameStarMatch[1].trim();
        // "√úCRET" gibi anahtar kelimeler deƒüilse
        if (!name.match(/√úCRET|BSMV|KOMƒ∞SYON/i)) {
            console.log(`‚úÖ Format 2 bulundu: "${name}"`);
            return name;
        }
    }
    
    // Format 3: "...tarafƒ±ndan aktarƒ±lan*ƒ∞Sƒ∞M*..."
    // √ñrnek: "AY≈ûENUR ATE≈û DEMƒ∞RKAN tarafƒ±ndan aktarƒ±lan*AY≈ûENUR ATE≈û DEMƒ∞RKAN*H2509..."
    const transferByMatch = cleanDesc.match(/([^*]+)\s+tarafƒ±ndan\s+aktarƒ±lan/i);
    if (transferByMatch) {
        const name = transferByMatch[1].trim();
        console.log(`‚úÖ Format 3 bulundu: "${name}"`);
        return name;
    }
    
    // Format 4: "//FATURA_NO//TARƒ∞H//*Fƒ∞RMA_ADI*..."
    // √ñrnek: "//NRC2025000000285//20250721/F110//*CAMƒ∞≈û MADENCƒ∞Lƒ∞K ANONƒ∞M ≈ûƒ∞RKETƒ∞*..."
    const invoiceMatch = cleanDesc.match(/\/\/.*?\/\/\*([^*]+)\*/);
    if (invoiceMatch) {
        const name = invoiceMatch[1].trim();
        console.log(`‚úÖ Format 4 (Fatura) bulundu: "${name}"`);
        return name;
    }
    
    // Format 5: "cari hesap ist*Fƒ∞RMA_ADI*..."
    // √ñrnek: "cari hesap ist*SENSER TEKSTƒ∞L HALI ƒ∞MALAT SANAYƒ∞..."
    const cariMatch = cleanDesc.match(/cari hesap ist\*([^*]+)/i);
    if (cariMatch) {
        const name = cariMatch[1].trim();
        console.log(`‚úÖ Format 5 (Cari) bulundu: "${name}"`);
        return name;
    }
    
    // Format 6: "Fƒ∞RMA_ADI*0046*A√ßƒ±klama*..."
    // √ñrnek: "HAYRULLAH ALTINTA≈û*0046*Danƒ±≈ümanlƒ±k hizmeti √∂demesi*..."
    const codeMatch = cleanDesc.match(/^([^*]+)\*\d{4}\*/);
    if (codeMatch) {
        const name = codeMatch[1].trim();
        console.log(`‚úÖ Format 6 (Kod) bulundu: "${name}"`);
        return name;
    }
    
    // Format 7: "Fƒ∞RMA_ADI*0062*NORA √áEVRE..." (NRC numaralƒ±)
    const nrcMatch = cleanDesc.match(/^([^*]+)\*006\d\*/);
    if (nrcMatch) {
        const name = nrcMatch[1].trim();
        console.log(`‚úÖ Format 7 (NRC) bulundu: "${name}"`);
        return name;
    }
    
    // Format 8: Fatura √∂demesi
    // √ñrnek: "100200334844 /TREPA≈û /FATURA NO:0000000910953291/K:02970"
    const billMatch = cleanDesc.match(/\/([A-Z√áƒûƒ∞√ñ≈û√ú\s]+)\s*\//);
    if (billMatch) {
        const name = billMatch[1].trim();
        console.log(`‚úÖ Format 8 (Fatura) bulundu: "${name}"`);
        return name;
    }
    
    // Hi√ßbir format e≈üle≈ümedi - ilk 50 karakter
    console.log(`‚ö†Ô∏è E≈üle≈üme bulunamadƒ±, ham a√ßƒ±klama kullanƒ±lƒ±yor`);
    return cleanDesc.substring(0, 50);
}

function categorizeTransaction(description, transactionType) {
    const desc = description.toUpperCase();
    const type = (transactionType || '').toUpperCase();
    
    // Banka √ºcretleri
    if (desc.includes('BSMV') || desc.match(/H\d{13}/)) return 'üí≥ BSMV';
    if (desc.includes('√úCRET') && desc.match(/H\d{13}/)) return 'üí≥ Banka √úcreti';
    if (desc.includes('KOMƒ∞SYON')) return 'üí≥ Komisyon';
    if (desc.includes('MASRAF')) return 'üí≥ Masraf';
    
    // Fatura √∂demeleri
    if (desc.includes('FATURA') || desc.includes('/TREPA≈û/')) return 'üßæ Fatura';
    
    // ƒ∞≈ülem tipleri
    if (type.includes('HAVALE')) return 'üí∏ Havale';
    if (type.includes('EFT')) return 'üí∏ EFT';
    if (type.includes('FAST')) return '‚ö° Fast';
    if (type.includes('POS') || desc.includes('KART')) return 'üí≥ Kart';
    if (type.includes('√áEK')) return 'üìù √áek';
    
    // Maa≈ü √∂demeleri
    if (desc.includes('MAA≈û') || desc.includes('MAA')) return 'üëî Maa≈ü';
    
    // Kira
    if (desc.includes('Kƒ∞RA')) return 'üè† Kira';
    
    return 'üìã Diƒüer';
}

        function matchTransactions(transactions) {
            const matches = [];

            transactions.forEach(transaction => {
                const match = {
                    transaction: transaction,
                    suggestedAccount: null,
                    suggestedInvoice: null,
                    confidence: 0
                };

                // Try to match with accounts based on description
                const description = transaction.description.toLowerCase();
                const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);

                for (let account of companyAccounts) {
                    const accountName = account.name.toLowerCase();
                    
                    // Simple matching - check if account name is in description
                    if (description.includes(accountName) || accountName.includes(description.split('*')[0])) {
                        match.suggestedAccount = account;
                        match.confidence = 80;
                        break;
                    }
                    
                    // Fuzzy match - check for partial matches
                    const words = accountName.split(' ');
                    for (let word of words) {
                        if (word.length > 3 && description.includes(word)) {
                            if (!match.suggestedAccount || match.confidence < 50) {
                                match.suggestedAccount = account;
                                match.confidence = 50;
                            }
                        }
                    }
                }

                // Try to match with invoices
                if (match.suggestedAccount) {
                    const accountInvoices = invoices.filter(inv => 
                        inv.accountId === match.suggestedAccount.id &&
                        Math.abs(inv.total - (inv.paidAmount || 0) - Math.abs(transaction.amount)) < 1
                    );

                    if (accountInvoices.length > 0) {
                        match.suggestedInvoice = accountInvoices[0];
                        match.confidence = 90;
                    }
                }

                matches.push(match);
            });

            showMatchingInterface(matches);
        }


function showMatchingInterface(matches) {
    const modal = document.getElementById('bankImportModal');
    const content = document.getElementById('bankImportContent');

    let html = `
        <div class="alert alert-info">
            <strong>‚úÖ ${matches.length} i≈ülem bulundu.</strong> L√ºtfen e≈üle≈ütirmeleri kontrol edin.
        </div>
        <div id="matchList">
    `;

    matches.forEach((match, index) => {
        const t = match.transaction;
        const isMatched = match.suggestedAccount !== null;
        const confidenceText = match.confidence >= 80 ? 'Y√ºksek' : match.confidence >= 50 ? 'Orta' : 'D√º≈ü√ºk';
        const confidenceColor = match.confidence >= 80 ? 'success' : match.confidence >= 50 ? 'warning' : 'danger';
        
        const amountColor = t.amount > 0 ? 'var(--success)' : 'var(--danger)';
        const amountSign = t.amount > 0 ? '+' : '';

        html += `
            <div class="payment-match-item ${isMatched ? 'matched' : 'unmatched'}">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                            <strong style="font-size: 1.1em;">${formatDate(t.date)}</strong>
                            <span style="color: ${amountColor}; font-weight: 700; font-size: 1.3em;">
                                ${amountSign}${formatCurrency(Math.abs(t.amount))}
                            </span>
                            <span class="badge badge-info">${t.category}</span>
                        </div>
                        <div style="font-size: 0.95em; margin-bottom: 5px;">
                            <strong>${t.amount > 0 ? 'üì• G√∂nderen:' : 'üì§ Alƒ±cƒ±:'}</strong> 
                            <span style="color: #1f2937; font-weight: 600;">${t.fromTo}</span>
                        </div>
                        <div style="font-size: 0.85em; color: #6b7280; font-style: italic;">
                            ${t.description.substring(0, 100)}${t.description.length > 100 ? '...' : ''}
                        </div>
                    </div>
                    ${isMatched ? `
                        <span class="badge badge-${confidenceColor}" style="margin-left: 10px;">
                            ${confidenceText} E≈üle≈üme
                        </span>
                    ` : ''}
                </div>
                
                <div class="grid-2" style="margin-top: 15px;">
                    <div class="form-group">
                        <label>Cari Hesap ${isMatched ? '(√ñnerilen)' : ''}</label>
                        <select id="matchAccount_${index}" onchange="updateMatchInvoices(${index})" style="font-weight: ${isMatched ? '600' : 'normal'};">
                            <option value="">Manuel Se√ßin</option>
                            ${accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId).map(a => 
                                `<option value="${a.id}" ${match.suggestedAccount && match.suggestedAccount.id === a.id ? 'selected' : ''}>${a.name}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Fatura (Opsiyonel)</label>
                        <select id="matchInvoice_${index}">
                            <option value="">Genel √ñdeme</option>
                        </select>
                    </div>
                </div>
            </div>
        `;
    });

    html += `
        </div>
        <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid var(--border); text-align: right;">
            <button class="btn btn-success" onclick="confirmBankImport()">
                ‚úÖ ${matches.length} ƒ∞≈ülemi Kaydet
            </button>
            <button class="btn btn-secondary" onclick="closeBankImportModal()">‚úñÔ∏è ƒ∞ptal</button>
        </div>
    `;

    content.innerHTML = html;
    modal.classList.add('active');

    // Populate invoice selects
    matches.forEach((match, index) => {
        if (match.suggestedAccount) {
            updateMatchInvoices(index, match.suggestedInvoice ? match.suggestedInvoice.id : null);
        }
    });

    window.bankMatches = matches;
}

        function updateMatchInvoices(index, selectedInvoiceId = null) {
            const accountSelect = document.getElementById(`matchAccount_${index}`);
            const invoiceSelect = document.getElementById(`matchInvoice_${index}`);
            
            const accountId = accountSelect.value;
            invoiceSelect.innerHTML = '<option value="">Genel √ñdeme</option>';

            if (!accountId) return;

            const accountInvoices = invoices.filter(inv => 
                inv.accountId === accountId && 
                (inv.total - (inv.paidAmount || 0)) > 0
            );

            accountInvoices.forEach(invoice => {
                const remaining = invoice.total - (invoice.paidAmount || 0);
                const option = new Option(
                    `${invoice.invoiceNo} - ${formatCurrency(remaining)} kalan`,
                    invoice.id
                );
                if (selectedInvoiceId && invoice.id === selectedInvoiceId) {
                    option.selected = true;
                }
                invoiceSelect.add(option);
            });
        }

        function confirmBankImport() {
            if (!window.bankMatches) return;

            let importedCount = 0;

            window.bankMatches.forEach((match, index) => {
                const accountId = document.getElementById(`matchAccount_${index}`).value;
                const invoiceId = document.getElementById(`matchInvoice_${index}`).value;

                if (!accountId) return; // Skip if no account selected

                const payment = {
                    id: Date.now().toString() + '_' + index,
                    companyId: activeCompanyId,
                    date: match.transaction.date,
                    accountId: accountId,
                    amount: Math.abs(match.transaction.amount),
                    type: match.transaction.amount > 0 ? 'income' : 'expense',
                    invoiceId: invoiceId || null,
                    description: match.transaction.description,
                    source: 'bank',
                    createdAt: new Date().toISOString()
                };

                payments.push(payment);

                // Update invoice
                if (invoiceId) {
                    const invoice = invoices.find(inv => inv.id === invoiceId);
                    if (invoice) {
                        invoice.paidAmount = (invoice.paidAmount || 0) + payment.amount;
                        if (invoice.paidAmount >= invoice.total) {
                            invoice.status = 'paid';
                        } else {
                            invoice.status = 'partial';
                        }
                    }
                }

                // Update account balance
                const account = accounts.find(a => a.id === accountId);
                if (account) {
                    if (payment.type === 'income') {
                        account.balance += payment.amount;
                    } else {
                        account.balance -= payment.amount;
                    }
                }

                importedCount++;
            });

            localStorage.setItem('payments', JSON.stringify(payments));
            localStorage.setItem('invoices', JSON.stringify(invoices));
            localStorage.setItem('accounts', JSON.stringify(accounts));

            closeBankImportModal();
            loadPayments();
            loadInvoices();
            loadAccounts();
            updateDashboard();

            alert(`‚úÖ ${importedCount} √∂deme ba≈üarƒ±yla kaydedildi!`);
        }

        function closeBankImportModal() {
            document.getElementById('bankImportModal').classList.remove('active');
            window.bankMatches = null;
        }

// updateDashboard() fonksiyonuna ekle (Satƒ±r ~1440 civarƒ±)

function updateDashboard() {
    const companyInvoices = invoices.filter(inv => !activeCompanyId || inv.companyId === activeCompanyId);
    const companyPayments = payments.filter(p => !activeCompanyId || p.companyId === activeCompanyId);
    const companyPurchases = purchases.filter(p => !activeCompanyId || p.companyId === activeCompanyId); // YENƒ∞

    const salesInvoices = companyInvoices.filter(inv => inv.type === 'sales');
    const purchaseInvoices = companyInvoices.filter(inv => inv.type === 'purchase');

    const totalIncome = salesInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
    const totalExpense = purchaseInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
    
    // YENƒ∞: Alƒ±≈ülarƒ± da giderlere ekle
    const purchasesExpense = companyPurchases.reduce((sum, p) => sum + p.amount, 0);
    const totalExpenseWithPurchases = totalExpense + purchasesExpense;
    
    const netProfit = totalIncome - totalExpenseWithPurchases;

    const salesVAT = salesInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
    const purchaseVAT = purchaseInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
    
    // YENƒ∞: Alƒ±≈ülarƒ±n KDV'sini de mahsuba ekle
    const purchasesVAT = companyPurchases.reduce((sum, p) => sum + p.vatAmount, 0);
    const totalVAT = salesVAT - (purchaseVAT + purchasesVAT);

    const corporateTax = netProfit > 0 ? netProfit * 0.20 : 0;

    const totalPaymentsAmount = companyPayments.reduce((sum, p) => sum + (p.type === 'income' ? p.amount : -p.amount), 0);
    
    const receivables = salesInvoices.reduce((sum, inv) => sum + (inv.total - (inv.paidAmount || 0)), 0);

    document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
    document.getElementById('totalExpense').textContent = formatCurrency(totalExpenseWithPurchases);
    document.getElementById('netProfit').textContent = formatCurrency(netProfit);
    document.getElementById('totalVAT').textContent = formatCurrency(totalVAT);
    document.getElementById('corporateTax').textContent = formatCurrency(corporateTax);
    document.getElementById('totalPayments').textContent = formatCurrency(totalPaymentsAmount);
    document.getElementById('receivables').textContent = formatCurrency(receivables);
}

        function updateRecentInvoices() {
            const tbody = document.querySelector('#recentInvoices tbody');
            tbody.innerHTML = '';

            const recentInvoices = invoices
                .filter(inv => !activeCompanyId || inv.companyId === activeCompanyId)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            if (recentInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:10px; color:#6b7280;">Hen√ºz fatura yok</td></tr>';
                return;
            }

            recentInvoices.forEach(invoice => {
                const account = accounts.find(a => a.id === invoice.accountId);
                const remaining = invoice.total - (invoice.paidAmount || 0);
                let statusText = remaining <= 0 ? '√ñdendi' : invoice.paidAmount > 0 ? 'Kƒ±smi' : '√ñdenmedi';
                let statusClass = remaining <= 0 ? 'status-paid' : invoice.paidAmount > 0 ? 'status-partial' : 'status-unpaid';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(invoice.date)}</td>
                    <td>${invoice.invoiceNo}</td>
                    <td>${account ? account.name : 'Silinmi≈ü'}</td>
                    <td>${formatCurrency(invoice.total)}</td>
                    <td><span class="${statusClass}">${statusText}</span></td>
                `;
            });
        }

        function updateRecentPayments() {
            const tbody = document.querySelector('#recentPayments tbody');
            tbody.innerHTML = '';

            const recentPayments = payments
                .filter(p => !activeCompanyId || p.companyId === activeCompanyId)
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 5);

            if (recentPayments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:10px; color:#6b7280;">Hen√ºz √∂deme yok</td></tr>';
                return;
            }

            recentPayments.forEach(payment => {
                const account = accounts.find(a => a.id === payment.accountId);
                const typeText = payment.type === 'income' ? 'üìó Tahsilat' : 'üìï √ñdeme';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(payment.date)}</td>
                    <td>${account ? account.name : 'Silinmi≈ü'}</td>
                    <td style="color: ${payment.type === 'income' ? 'var(--success)' : 'var(--danger)'};">
                        ${payment.type === 'income' ? '+' : '-'}${formatCurrency(payment.amount)}
                    </td>
                    <td>${typeText}</td>
                `;
            });
        }

        // REPORTS FUNCTIONS
        function generateReport() {
            const year = document.getElementById('reportYear').value;
            const month = document.getElementById('reportMonth').value;

            const companyInvoices = invoices.filter(inv => {
                if (activeCompanyId && inv.companyId !== activeCompanyId) return false;
                
                const invDate = new Date(inv.date);
                const invYear = invDate.getFullYear().toString();
                const invMonth = (invDate.getMonth() + 1).toString().padStart(2, '0');

                if (invYear !== year) return false;
                if (month && invMonth !== month) return false;

                return true;
            });

            const salesInvoices = companyInvoices.filter(inv => inv.type === 'sales');
            const purchaseInvoices = companyInvoices.filter(inv => inv.type === 'purchase');

            const totalIncome = salesInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
            const totalExpense = purchaseInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
            const netProfit = totalIncome - totalExpense;

            const salesVAT = salesInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
            const purchaseVAT = purchaseInvoices.reduce((sum, inv) => sum + inv.vatAmount, 0);
            const totalVAT = salesVAT - purchaseVAT;

            const corporateTax = netProfit > 0 ? netProfit * 0.20 : 0;

            const periodText = month ? `${getMonthName(month)} ${year}` : `${year} Yƒ±lƒ±`;

            const html = `
                <div class="card">
                    <h3>üìä ${periodText} D√∂nemi Raporu</h3>
                    
                    <div class="grid-3">
                        <div class="stat-card success">
                            <h4>Satƒ±≈ü Geliri</h4>
                            <div class="amount">${formatCurrency(totalIncome)}</div>
                            <small>${salesInvoices.length} Fatura</small>
                        </div>
                        <div class="stat-card danger">
                            <h4>Alƒ±≈ü Gideri</h4>
                            <div class="amount">${formatCurrency(totalExpense)}</div>
                            <small>${purchaseInvoices.length} Fatura</small>
                        </div>
                        <div class="stat-card">
                            <h4>Net Kar/Zarar</h4>
                            <div class="amount">${formatCurrency(netProfit)}</div>
                        </div>
                    </div>

                    <div class="grid-2" style="margin-top:20px;">
                        <div class="stat-card warning">
                            <h4>√ñdenecek KDV</h4>
                            <div class="amount">${formatCurrency(totalVAT)}</div>
                            <small>Satƒ±≈ü KDV - Alƒ±≈ü KDV</small>
                        </div>
                        <div class="stat-card purple">
                            <h4>Tahmini Kurumlar Vergisi</h4>
                            <div class="amount">${formatCurrency(corporateTax)}</div>
                            <small>Net Kar x %20</small>
                        </div>
                    </div>

                    <div style="margin-top:30px;">
                        <h4>üìã Detaylƒ± Fatura Listesi</h4>
                        ${companyInvoices.length === 0 ? '<p style="text-align:center; padding:20px; color:#6b7280;">Bu d√∂nemde fatura yok.</p>' : `
                        <table>
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>No</th>
                                    <th>T√ºr</th>
                                    <th>Cari</th>
                                    <th>Ara Toplam</th>
                                    <th>KDV</th>
                                    <th>Toplam</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${companyInvoices.map(inv => {
                                    const account = accounts.find(a => a.id === inv.accountId);
                                    const typeText = inv.type === 'sales' ? 'üìó Satƒ±≈ü' : 'üìï Alƒ±≈ü';
                                    const remaining = inv.total - (inv.paidAmount || 0);
                                    let statusText = remaining <= 0 ? '√ñdendi' : inv.paidAmount > 0 ? 'Kƒ±smi' : '√ñdenmedi';
                                    return `
                                        <tr>
                                            <td>${formatDate(inv.date)}</td>
                                            <td>${inv.invoiceNo}</td>
                                            <td>${typeText}</td>
                                            <td>${account ? account.name : 'Silinmi≈ü'}</td>
                                            <td>${formatCurrency(inv.subtotal)}</td>
                                            <td>${formatCurrency(inv.vatAmount)}</td>
                                            <td><strong>${formatCurrency(inv.total)}</strong></td>
                                            <td>${statusText}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                        `}
                    </div>
                </div>
            `;

            document.getElementById('reportResults').innerHTML = html;
        }

        function generateStatement() {
            const accountId = document.getElementById('statementAccount').value;
            const startDate = document.getElementById('statementStartDate').value;
            const endDate = document.getElementById('statementEndDate').value;

            if (!accountId) {
                alert('‚ö†Ô∏è L√ºtfen bir cari hesap se√ßin!');
                return;
            }

            const account = accounts.find(a => a.id === accountId);
            if (!account) return;

            let accountTransactions = [];

            // Add invoices
            invoices.filter(inv => inv.accountId === accountId).forEach(inv => {
                if (startDate && inv.date < startDate) return;
                if (endDate && inv.date > endDate) return;
                
                accountTransactions.push({
                    date: inv.date,
                    type: 'invoice',
                    description: `Fatura: ${inv.invoiceNo}`,
                    debit: inv.type === 'sales' ? inv.total : 0,
                    credit: inv.type === 'purchase' ? inv.total : 0,
                    reference: inv.invoiceNo
                });
            });

            // Add payments
            payments.filter(p => p.accountId === accountId).forEach(p => {
                if (startDate && p.date < startDate) return;
                if (endDate && p.date > endDate) return;
                
                accountTransactions.push({
                    date: p.date,
                    type: 'payment',
                    description: p.description || '√ñdeme',
                    debit: p.type === 'expense' ? p.amount : 0,
                    credit: p.type === 'income' ? p.amount : 0,
                    reference: p.invoiceId ? invoices.find(inv => inv.id === p.invoiceId)?.invoiceNo : '-'
                });
            });

            accountTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));

            let balance = 0;
            const rows = accountTransactions.map(t => {
                balance += (t.debit - t.credit);
                return `
                    <tr>
                        <td>${formatDate(t.date)}</td>
                        <td>${t.reference}</td>
                        <td>${t.description}</td>
                        <td style="color: var(--danger); font-weight:600;">${t.debit > 0 ? formatCurrency(t.debit) : '-'}</td>
                        <td style="color: var(--success); font-weight:600;">${t.credit > 0 ? formatCurrency(t.credit) : '-'}</td>
                        <td style="font-weight:700;">${formatCurrency(balance)}</td>
                    </tr>
                `;
            }).join('');

            const html = `
                <div style="margin-top:20px;">
                    <h4>üìã ${account.name} - Cari Ekstre</h4>
                    <p><strong>D√∂nem:</strong> ${startDate ? formatDate(startDate) : 'Ba≈ülangƒ±√ß'} - ${endDate ? formatDate(endDate) : 'Bug√ºn'}</p>
                    <p><strong>G√ºncel Bakiye:</strong> <span style="color: ${balance >= 0 ? 'var(--success)' : 'var(--danger)'}; font-size:1.8em; font-weight:700;">${formatCurrency(balance)}</span></p>
                    
                    ${accountTransactions.length === 0 ? '<p style="text-align:center; padding:20px; color:#6b7280;">Bu d√∂nemde i≈ülem yok.</p>' : `
                    <table>
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>Referans</th>
                                <th>A√ßƒ±klama</th>
                                <th>Bor√ß</th>
                                <th>Alacak</th>
                                <th>Bakiye</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                        </tbody>
                    </table>
                    `}
                </div>
            `;

            document.getElementById('statementResults').innerHTML = html;
        }

        // DATA MANAGEMENT
        function exportData() {
            const data = {
                companies: companies,
                accounts: accounts,
                invoices: invoices,
                payments: payments,
                activeCompanyId: activeCompanyId,
                exportDate: new Date().toISOString(),
                version: '2.0.0'
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `muhasebe-yedek-v2-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            URL.revokeObjectURL(url);
            
            alert('‚úÖ Veriler ba≈üarƒ±yla dƒ±≈üa aktarƒ±ldƒ±!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (!data.companies || !data.accounts || !data.invoices) {
                        alert('‚ö†Ô∏è Ge√ßersiz yedek dosyasƒ±!');
                        return;
                    }

                    if (confirm('‚ö†Ô∏è Mevcut t√ºm veriler silinecek ve yedekten geri y√ºklenecek. Devam etmek istiyor musunuz?')) {
                        companies = data.companies;
                        accounts = data.accounts;
                        invoices = data.invoices;
                        payments = data.payments || [];
                        activeCompanyId = data.activeCompanyId;

                        localStorage.setItem('companies', JSON.stringify(companies));
                        localStorage.setItem('accounts', JSON.stringify(accounts));
                        localStorage.setItem('invoices', JSON.stringify(invoices));
                        localStorage.setItem('payments', JSON.stringify(payments));
                        localStorage.setItem('activeCompanyId', activeCompanyId);

                        initializeApp();
                        
                        alert('‚úÖ Veriler ba≈üarƒ±yla i√ße aktarƒ±ldƒ±!');
                    }
                } catch (error) {
                    alert('‚ùå Dosya okunamadƒ±! L√ºtfen ge√ßerli bir yedek dosyasƒ± se√ßin.');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è T√úM VERƒ∞LER Sƒ∞Lƒ∞NECEK! Bu i≈ülem geri alƒ±namaz. Devam etmek istiyor musunuz?')) {
                return;
            }

            if (!confirm('‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è SON UYARI! T√ºm firmalar, cari hesaplar, faturalar ve √∂demeler kalƒ±cƒ± olarak silinecek. EMƒ∞N Mƒ∞Sƒ∞Nƒ∞Z?')) {
                return;
            }

            localStorage.clear();

            companies = [];
            accounts = [];
            invoices = [];
            payments = [];
            activeCompanyId = null;

            initializeApp();

            alert('‚úÖ T√ºm veriler silindi!');
        }

function populateSelects() {
    populateCompanySelects();
    populateAccountSelects();
    populatePaymentAccounts();
}

function populateAccountSelects() {
    // Invoice account select
    const invoiceAccountSelect = document.getElementById('invoiceAccount');
    if (invoiceAccountSelect) {
        const currentValue = invoiceAccountSelect.value;
        invoiceAccountSelect.innerHTML = '<option value="">Cari Hesap Se√ßin</option>';
        
        accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId).forEach(account => {
            const option = new Option(
                `${account.name} (${account.type === 'customer' ? 'M√º≈üteri' : 'Tedarik√ßi'})`,
                account.id
            );
            invoiceAccountSelect.add(option);
        });
        
        if (currentValue) {
            invoiceAccountSelect.value = currentValue;
        }
    }
}

function populatePaymentAccounts() {
    const select = document.getElementById('paymentAccount');
    if (!select) return;
    
    select.innerHTML = '<option value="">Se√ßiniz</option>';
    
    const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
    companyAccounts.forEach(account => {
        const option = new Option(
            `${account.name} (${account.type === 'customer' ? 'M√º≈üteri' : 'Tedarik√ßi'})`,
            account.id
        );
        select.add(option);
    });
}

        function formatCurrency(amount) {
            return new Intl.NumberFormat('tr-TR', {
                style: 'currency',
                currency: 'TRY',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('tr-TR');
        }

        function getMonthName(month) {
            const months = {
                '01': 'Ocak', '02': '≈ûubat', '03': 'Mart', '04': 'Nisan',
                '05': 'Mayƒ±s', '06': 'Haziran', '07': 'Temmuz', '08': 'Aƒüustos',
                '09': 'Eyl√ºl', '10': 'Ekim', '11': 'Kasƒ±m', '12': 'Aralƒ±k'
            };
            return months[month] || month;
        }

// Global variable to store parsed transactions
let pendingTransactions = [];

function showTransactionDetailsModal(transactions) {
    console.log('üîµ showTransactionDetailsModal √ßaƒürƒ±ldƒ±');
    console.log('üìä Gelen transaction sayƒ±sƒ±:', transactions.length);

    if (!transactions || transactions.length === 0) {
        console.error('‚ùå Transactions bo≈ü veya undefined!');
        alert('G√∂sterilecek i≈ülem bulunamadƒ±!');
        return;
    }

    const modal = document.getElementById('transactionDetailsModal');
    const container = document.getElementById('transactionDetailsContainer');

    if (!modal || !container) {
        console.error('‚ùå Modal veya Container elementi bulunamadƒ±!');
        return;
    }

    console.log('‚úÖ Modal ve Container elementleri bulundu');

    // Store transactions globally
    pendingTransactions = transactions;

    // Container'ƒ± temizle
    container.innerHTML = '';

    // ‚úÖ E≈ûLE≈ûME ƒ∞STATƒ∞STƒ∞KLERƒ∞
    let autoMatchedCount = 0;
    let manualMatchCount = 0;

    // ‚úÖ HER TRANSACTION ƒ∞√áƒ∞N OTOMATƒ∞K E≈ûLE≈ûTIRME YAP
    transactions.forEach((tx, index) => {
        // Otomatik cari hesap e≈üle≈ütirme
        const matchResult = findMatchingAccountForTransaction(tx);
        tx.suggestedAccount = matchResult.account;
        tx.matchConfidence = matchResult.confidence;
        tx.matchReason = matchResult.reason;

        if (matchResult.account) {
            autoMatchedCount++;
        } else {
            manualMatchCount++;
        }

        console.log(`üìù Transaction ${index + 1}:`, {
            amount: tx.amount,
            description: tx.description.substring(0, 50),
            matchedAccount: matchResult.account?.name || 'YOK',
            confidence: matchResult.confidence,
            reason: matchResult.reason
        });
    });

    // √ñzet istatistik
    const totalCount = transactions.length;
    const matchPercentage = Math.round((autoMatchedCount / totalCount) * 100);

    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'alert alert-success';
    summaryDiv.style.cssText = 'margin-bottom: 20px;';
    summaryDiv.innerHTML = `
        <strong>‚úÖ ${totalCount} banka i≈ülemi ba≈üarƒ±yla okundu!</strong><br>
        <div style="margin-top: 10px; display: flex; gap: 20px; font-size: 0.95em;">
            <span style="color: var(--success);">‚úÖ ${autoMatchedCount} otomatik e≈üle≈üti (%${matchPercentage})</span>
            ${manualMatchCount > 0 ? `<span style="color: var(--warning);">‚ö†Ô∏è ${manualMatchCount} manuel se√ßim gerekli</span>` : ''}
        </div>
    `;
    container.appendChild(summaryDiv);

    // Her transaction i√ßin kart olu≈ütur
    transactions.forEach((tx, index) => {
        const card = document.createElement('div');
        card.className = 'transaction-detail-card';
        
        // ‚úÖ E≈üle≈üme durumuna g√∂re renk
        const borderColor = tx.suggestedAccount ? '#10b981' : '#f59e0b';
        const bgGradient = tx.suggestedAccount 
            ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' 
            : 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)';

        card.style.cssText = `
            background: ${bgGradient};
            border-left: 4px solid ${borderColor};
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        `;

        const amountColor = tx.amount >= 0 ? '#00b894' : '#d63031';
        const amountPrefix = tx.amount >= 0 ? '+' : '';
        const formattedAmount = `${amountPrefix}‚Ç∫${Math.abs(tx.amount).toLocaleString('tr-TR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        })}`;

        // G√ºven skoru badge
        const confidenceBadge = tx.suggestedAccount 
            ? `<span class="badge badge-${tx.matchConfidence >= 90 ? 'success' : tx.matchConfidence >= 70 ? 'warning' : 'danger'}" style="font-size: 0.9em;">
                ${tx.matchConfidence}% E≈üle≈üme
               </span>`
            : '<span class="badge badge-danger" style="font-size: 0.9em;">Manuel Se√ßim Gerekli</span>';

        // Get current account list for dropdown
        const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
        const accountOptions = companyAccounts.map(acc => 
            `<option value="${acc.id}" ${tx.suggestedAccount && tx.suggestedAccount.id === acc.id ? 'selected' : ''}>
                ${acc.name} (${acc.type === 'customer' ? 'M√º≈üteri' : 'Tedarik√ßi'})
            </option>`
        ).join('');

        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                        <div style="font-size: 18px; font-weight: bold; color: ${amountColor};">
                            ${formattedAmount}
                        </div>
                        ${confidenceBadge}
                    </div>
                    <div style="font-size: 14px; color: #2d3436; margin-bottom: 4px;">
                        üìÖ ${tx.date || 'Tarih yok'}
                    </div>
                    <div style="font-size: 13px; color: #636e72; margin-bottom: 8px;">
                        üí≥ ${tx.channel || 'Kanal bilgisi yok'} | ${tx.type || 'ƒ∞≈ülem tipi yok'}
                    </div>
                    ${tx.suggestedAccount ? `
                        <div style="font-size: 0.9em; color: var(--success); margin-top: 8px; padding: 8px; background: rgba(16, 185, 129, 0.15); border-radius: 6px;">
                            ‚úÖ <strong>Otomatik E≈üle≈üti:</strong> ${tx.suggestedAccount.name}<br>
                            <small style="opacity: 0.8;">Sebep: ${tx.matchReason}</small>
                        </div>
                    ` : `
                        <div style="font-size: 0.9em; color: var(--danger); margin-top: 8px; padding: 8px; background: rgba(239, 68, 68, 0.15); border-radius: 6px;">
                            ‚ö†Ô∏è Cari hesap bulunamadƒ± - L√ºtfen manuel se√ßin
                        </div>
                    `}
                </div>
                <div style="background: white; padding: 8px 12px; border-radius: 6px; font-size: 13px; color: #2d3436; font-weight: 500;">
                    Bakiye: ‚Ç∫${(tx.balance || 0).toLocaleString('tr-TR', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    })}
                </div>
            </div>
            <div style="background: rgba(255,255,255,0.7); padding: 12px; border-radius: 6px; font-size: 13px; color: #2d3436; line-height: 1.5; margin-bottom: 12px;">
                üìù ${tx.description || 'A√ßƒ±klama yok'}
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div>
                    <label style="display: block; font-size: 12px; color: #636e72; margin-bottom: 5px;">
                        Cari Hesap ${tx.suggestedAccount ? '(‚úÖ Otomatik)' : '(‚ö†Ô∏è Manuel)'}
                    </label>
                    <select class="cari-hesap-select" data-index="${index}" style="width: 100%; padding: 8px; border: 2px solid ${tx.suggestedAccount ? 'var(--success)' : 'var(--danger)'}; border-radius: 4px; background: white; font-weight: ${tx.suggestedAccount ? '600' : 'normal'};">
                        <option value="">Cari Hesap Se√ßin</option>
                        ${accountOptions}
                    </select>
                </div>
                <div>
                    <label style="display: block; font-size: 12px; color: #636e72; margin-bottom: 5px;">
                        Kategori (Opsiyonel)
                    </label>
                    <select class="fatura-select" data-index="${index}" style="width: 100%; padding: 8px; border: 1px solid #dfe6e9; border-radius: 4px; background: white;">
                        <option value="">Genel √ñdeme</option>
                        <option value="Kira √ñdemesi">Kira √ñdemesi</option>
                        <option value="Maa≈ü √ñdemesi">Maa≈ü √ñdemesi</option>
                        <option value="Hizmet Bedeli">Hizmet Bedeli</option>
                        <option value="Fatura √ñdemesi">Fatura √ñdemesi</option>
                        <option value="Vergi/SGK">Vergi/SGK</option>
                        <option value="Banka √úcreti">Banka √úcreti</option>
                        <option value="Diƒüer">Diƒüer</option>
                    </select>
                </div>
            </div>
        `;

        container.appendChild(card);
    });

    // ‚úÖ EKLE: Kaydetme butonu
    const saveButtonHTML = `
        <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
            <button class="btn btn-secondary" onclick="closeTransactionDetailsModal()">
                ‚úñÔ∏è ƒ∞ptal
            </button>
            <button class="btn btn-success" onclick="confirmImportTransactions()" style="font-size: 16px; padding: 12px 30px;">
                üíæ ${transactions.length} ƒ∞≈ülemi Kaydet
            </button>
        </div>
    `;
    
    container.innerHTML += saveButtonHTML;
    
    // Global'e kaydet
    window.pendingTransactions = transactions;

    // Modal'ƒ± g√∂ster
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.style.opacity = '1';
    }, 10);
}

// ‚úÖ Banka i≈ülemlerini Firebase'e kaydet
async function confirmImportTransactions() {
    console.log('üíæ Banka i≈ülemleri kaydediliyor...');
    
    if (!window.pendingTransactions || window.pendingTransactions.length === 0) {
        alert('‚ùå Kaydedilecek i≈ülem yok!');
        return;
    }
    
    if (!activeCompanyId) {
        alert('‚ùå L√ºtfen bir firma se√ßin!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('‚ùå L√ºtfen giri≈ü yapƒ±n!');
        return;
    }
    
    try {
        const batch = db.batch();
        const now = new Date().toISOString();
        let savedCount = 0;
        let skippedCount = 0;
        
        for (let i = 0; i < window.pendingTransactions.length; i++) {
            const trans = window.pendingTransactions[i];
            
            // ‚úÖ Modal'dan se√ßilen cari hesabƒ± al
            const accountSelect = document.getElementById(`transAccount_${i}`);
            const accountId = accountSelect ? accountSelect.value : trans.matchedAccount?.id;
            
            // Cari hesap se√ßilmediyse atla
            if (!accountId || accountId === '' || accountId === 'YOK') {
                console.log(`‚ö†Ô∏è ƒ∞≈ülem ${i} atlandƒ±: Cari hesap se√ßilmedi`);
                skippedCount++;
                continue;
            }
            
            const paymentData = {
                companyId: activeCompanyId,
                date: trans.date,
                accountId: accountId,
                amount: Math.abs(trans.amount),
                type: trans.amount > 0 ? 'income' : 'expense',
                description: trans.description,
                source: 'bank',
                createdAt: now,
                createdBy: auth.currentUser.uid
            };
            
            // Firebase'e ekle
            const docRef = db.collection('companies').doc(activeCompanyId)
                .collection('payments').doc();
            
            batch.set(docRef, paymentData);
            
            savedCount++;
            console.log(`‚úÖ ƒ∞≈ülem ${i} hazƒ±rlandƒ±: ${paymentData.amount} TL`);
        }
        
        // ‚úÖ Batch'i commit et
        if (savedCount > 0) {
            await batch.commit();
            console.log(`‚úÖ ${savedCount} i≈ülem Firebase'e kaydedildi`);
        }
        
        // Modal'ƒ± kapat
        closeTransactionDetailsModal();
        
        // Verileri yenile
        await loadPayments();
        await loadAccounts();
        updateDashboard();
        
        if (skippedCount > 0) {
            alert(`‚úÖ ${savedCount} i≈ülem kaydedildi\n‚ö†Ô∏è ${skippedCount} i≈ülem atlandƒ± (cari hesap se√ßilmedi)`);
        } else {
            alert(`‚úÖ ${savedCount} banka i≈ülemi ba≈üarƒ±yla kaydedildi!`);
        }
        
    } catch (error) {
        console.error('‚ùå Firebase kaydetme hatasƒ±:', error);
        alert('‚ùå Hata: ' + error.message);
    }
}

function closeTransactionDetailsModal() {
    console.log('üî¥ Modal kapatƒ±lƒ±yor...');
    const modal = document.getElementById('transactionDetailsModal');
    if (modal) {
        modal.style.display = 'none';
    }
    window.pendingTransactions = null;
    console.log('‚úÖ Modal kapatƒ±ldƒ±');
}

// ========================================
// BANKA ƒ∞≈ûLEMƒ∞ OTOMATƒ∞K E≈ûLE≈ûTIRME
// ========================================

function findMatchingAccountForTransaction(transaction) {
    const companyAccounts = accounts.filter(a => !activeCompanyId || a.companyId === activeCompanyId);
    
    if (companyAccounts.length === 0) {
        return { account: null, confidence: 0, reason: 'Cari hesap yok' };
    }

    const description = transaction.description.toUpperCase();
    const amount = Math.abs(transaction.amount);

    console.log(`\nüîç E≈üle≈ütirme: "${description.substring(0, 80)}" | Tutar: ${amount}`);

    // ========================================
    // 1. BANKA √úCRETLERƒ∞ (Otomatik Atla veya √ñzel Cari)
    // ========================================
    if (description.match(/BSMV|KOMƒ∞SYON.*H\d{13}|MASRAF.*H\d{13}|√úCRET.*H\d{13}/i)) {
        // Eƒüer "Banka √úcretleri" carisi varsa otomatik e≈üle≈ütir
        const bankFeesAccount = companyAccounts.find(a => 
            a.name.toUpperCase().includes('BANKA') && 
            (a.name.toUpperCase().includes('√úCRET') || a.name.toUpperCase().includes('Gƒ∞DER'))
        );
        
        if (bankFeesAccount) {
            return { 
                account: bankFeesAccount, 
                confidence: 100, 
                reason: 'Banka √ºcreti - Otomatik atandƒ±' 
            };
        }
        
        return { 
            account: null, 
            confidence: 0, 
            reason: 'Banka √ºcreti - "Banka √úcretleri" carisi olu≈üturun' 
        };
    }

    // ========================================
    // 2. FATURA √ñDEMELERƒ∞ (NRC Numaralƒ±)
    // ========================================
    // Format: "//NRC2025000000285//20250721/F110//*CAMƒ∞≈û MADENCƒ∞Lƒ∞K ANONƒ∞M ≈ûƒ∞RKETƒ∞*..."
    const nrcMatch = description.match(/NRC\d{13}/);
    if (nrcMatch) {
        const nrcNo = nrcMatch[0];
        console.log(`üìÑ NRC Fatura Numarasƒ± bulundu: ${nrcNo}`);
        
        // Faturayƒ± bul
        const matchedInvoice = invoices.find(inv => 
            inv.invoiceNo && inv.invoiceNo.toUpperCase().includes(nrcNo)
        );
        
        if (matchedInvoice) {
            const invoiceAccount = accounts.find(a => a.id === matchedInvoice.accountId);
            if (invoiceAccount) {
                console.log(`‚úÖ FATURA E≈ûLE≈ûME: ${nrcNo} ‚Üí ${invoiceAccount.name}`);
                return { 
                    account: invoiceAccount, 
                    confidence: 100, 
                    reason: `Fatura ${nrcNo} ile e≈üle≈üti` 
                };
            }
        }
        
        // Fatura bulunamadƒ±ysa firma adƒ±ndan e≈üle≈ütir
        const companyMatch = description.match(/\/\/\*([^*]+)\*/);
        if (companyMatch) {
            const companyName = companyMatch[1].trim();
            const result = findAccountByName(companyName, companyAccounts);
            if (result.account) {
                return { 
                    account: result.account, 
                    confidence: result.confidence, 
                    reason: `NRC fatura - Firma adƒ± e≈üle≈üti: ${companyName}` 
                };
            }
        }
    }

    // ========================================
    // 3. ƒ∞Sƒ∞M*IBAN FORMATI
    // ========================================
    // Format: "AY≈ûENUR ATE≈û DEMƒ∞RKAN*TR270006400000115220278205*..."
    const nameIbanMatch = description.match(/^([^*]+)\*TR\d{24}/);
    if (nameIbanMatch) {
        const name = nameIbanMatch[1].trim();
        console.log(`üë§ Format: ƒ∞sim*IBAN ‚Üí "${name}"`);
        
        const result = findAccountByName(name, companyAccounts);
        if (result.account) {
            return { 
                account: result.account, 
                confidence: result.confidence, 
                reason: `ƒ∞sim e≈üle≈üti: ${name}` 
            };
        }
    }

    // ========================================
    // 4. ƒ∞Sƒ∞M*A√áIKLAMA FORMATI (IBAN yok)
    // ========================================
    // Format: "ZET A≈û*ZET LOJƒ∞STƒ∞K HAZIR BETON..."
    const nameStarMatch = description.match(/^([A-Z√áƒûƒ∞√ñ≈û√úa-z√ßƒüƒ±√∂≈ü√º\s\.]+)\*/);
    if (nameStarMatch) {
        const name = nameStarMatch[1].trim();
        
        // "√úCRET" gibi kelimeler deƒüilse
        if (!name.match(/√úCRET|BSMV|KOMƒ∞SYON|MASRAF/i)) {
            console.log(`üë§ Format: ƒ∞sim*A√ßƒ±klama ‚Üí "${name}"`);
            
            const result = findAccountByName(name, companyAccounts);
            if (result.account) {
                return { 
                    account: result.account, 
                    confidence: result.confidence, 
                    reason: `ƒ∞sim e≈üle≈üti: ${name}` 
                };
            }
        }
    }

    // ========================================
    // 5. TUTAR BAZLI E≈ûLE≈ûTIRME (Bekleyen Faturalar)
    // ========================================
    const unpaidInvoices = invoices.filter(inv => {
        const remaining = inv.total - (inv.paidAmount || 0);
        return remaining > 0 && Math.abs(remaining - amount) < 1; // 1 TL tolerans
    });

    if (unpaidInvoices.length === 1) {
        const invoice = unpaidInvoices[0];
        const invoiceAccount = accounts.find(a => a.id === invoice.accountId);
        
        if (invoiceAccount) {
            console.log(`‚úÖ TUTAR E≈ûLE≈ûME: ${amount} TL ‚Üí ${invoiceAccount.name} (Fatura: ${invoice.invoiceNo})`);
            return { 
                account: invoiceAccount, 
                confidence: 85, 
                reason: `Bekleyen fatura tutarƒ± e≈üle≈üti (${invoice.invoiceNo})` 
            };
        }
    }

    // ========================================
    // 6. ACƒ∞L DURUMLAR (Maa≈ü, Kira vb.)
    // ========================================
    if (description.includes('MAA≈û') || description.includes('MAA')) {
        const salaryAccount = companyAccounts.find(a => 
            a.name.toUpperCase().includes('PERSONEL') || 
            a.name.toUpperCase().includes('MAA≈û')
        );
        
        if (salaryAccount) {
            return { 
                account: salaryAccount, 
                confidence: 90, 
                reason: 'Maa≈ü √∂demesi tespit edildi' 
            };
        }
    }

    if (description.includes('Kƒ∞RA')) {
        const rentAccount = companyAccounts.find(a => 
            a.name.toUpperCase().includes('Kƒ∞RA')
        );
        
        if (rentAccount) {
            return { 
                account: rentAccount, 
                confidence: 90, 
                reason: 'Kira √∂demesi tespit edildi' 
            };
        }
    }

    console.log(`‚ùå E≈üle≈üme bulunamadƒ±`);
    return { account: null, confidence: 0, reason: 'Otomatik e≈üle≈ütirme ba≈üarƒ±sƒ±z' };
}

// ========================================
// YARDIMCI FONKSƒ∞YON: ƒ∞simden Cari Bulma
// ========================================

function findAccountByName(searchName, accountList) {
    const cleanName = (name) => {
        return name.toUpperCase()
            .replace(/\s+/g, ' ')
            .replace(/\./g, '')
            .replace(/LTD\.?\s*≈ûTƒ∞\.?/gi, '')
            .replace(/Lƒ∞Mƒ∞TED\s*≈ûƒ∞RKETƒ∞/gi, '')
            .replace(/A\.?\s*≈û\.?/gi, '')
            .replace(/ANONƒ∞M\s*≈ûƒ∞RKETƒ∞/gi, '')
            .replace(/SANAYƒ∞/gi, '')
            .replace(/Tƒ∞CARET/gi, '')
            .replace(/VE/gi, '')
            .trim();
    };

    const cleanedSearch = cleanName(searchName);

    // 1. TAM E≈ûLE≈ûME
    for (let account of accountList) {
        if (cleanName(account.name) === cleanedSearch) {
            console.log(`‚úÖ TAM E≈ûLE≈ûME (100%): "${searchName}" ‚Üí "${account.name}"`);
            return { account: account, confidence: 100 };
        }
    }

    // 2. TAM ƒ∞√áERME
    for (let account of accountList) {
        const accountName = cleanName(account.name);
        if (accountName.includes(cleanedSearch) || cleanedSearch.includes(accountName)) {
            console.log(`‚úÖ TAM ƒ∞√áERME (95%): "${searchName}" ‚Üí "${account.name}"`);
            return { account: account, confidence: 95 };
        }
    }

    // 3. ƒ∞LK KELƒ∞ME E≈ûLE≈ûME
    const firstWord = cleanedSearch.split(/\s+/)[0];
    if (firstWord.length >= 4) {
        let matches = [];
        
        for (let account of accountList) {
            const accountFirstWord = cleanName(account.name).split(/\s+/)[0];
            if (firstWord === accountFirstWord) {
                matches.push(account);
            }
        }
        
        if (matches.length === 1) {
            console.log(`‚úÖ ƒ∞LK KELƒ∞ME (90%): "${searchName}" ‚Üí "${matches[0].name}"`);
            return { account: matches[0], confidence: 90 };
        }
    }

    // 4. √áOK KELƒ∞MELƒ∞ E≈ûLE≈ûME
    const words = cleanedSearch.split(/\s+/).filter(w => w.length > 2).slice(0, 3);
    
    if (words.length >= 2) {
        let bestMatch = null;
        let bestScore = 0;
        
        for (let account of accountList) {
            const accountName = cleanName(account.name);
            let matchCount = 0;
            
            for (let word of words) {
                if (accountName.includes(word)) {
                    matchCount++;
                }
            }
            
            const score = matchCount / words.length;
            if (score >= 0.66 && score > bestScore) {
                bestScore = score;
                bestMatch = account;
            }
        }
        
        if (bestMatch) {
            const confidence = Math.round(bestScore * 85);
            console.log(`‚úÖ √áOK KELƒ∞MELƒ∞ (${confidence}%): "${searchName}" ‚Üí "${bestMatch.name}"`);
            return { account: bestMatch, confidence: confidence };
        }
    }

    return { account: null, confidence: 0 };
}

function closeTransactionDetailsModal() {
    console.log('üî¥ Modal kapatƒ±lƒ±yor...');
    const modal = document.getElementById('transactionDetailsModal');
    
    if (modal) {
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.style.display = 'none';
            pendingTransactions = [];
            console.log('‚úÖ Modal kapatƒ±ldƒ±');
        }, 300);
    }
}

// ‚úÖ DOƒûRU KOD
function saveAllTransactions() {
    console.log('üíæ T√ºm i≈ülemler kaydediliyor...');
    
    if (!activeCompanyId) {
        alert('‚ö†Ô∏è L√ºtfen √∂nce bir firma se√ßin!');
        return;
    }

    if (pendingTransactions.length === 0) {
        alert('‚ö†Ô∏è Kaydedilecek i≈ülem yok!');
        return;
    }

    let savedCount = 0;
    let skippedCount = 0;

    pendingTransactions.forEach((tx, index) => {
        const cariSelect = document.querySelector(`.cari-hesap-select[data-index="${index}"]`);
        const faturaSelect = document.querySelector(`.fatura-select[data-index="${index}"]`);

        const accountId = cariSelect?.value;
        const invoiceNote = faturaSelect?.value;

        if (!accountId) {
            console.log(`‚ö†Ô∏è ƒ∞≈ülem ${index + 1} atlandƒ±: Cari hesap se√ßilmedi`);
            skippedCount++;
            return;
        }

        const account = accounts.find(a => a.id === accountId);
        if (!account) {
            console.log(`‚ö†Ô∏è ƒ∞≈ülem ${index + 1} atlandƒ±: Cari hesap bulunamadƒ±`);
            skippedCount++;
            return;
        }

        // ‚úÖ DOƒûRU: tx.amount pozitifse gelir (m√º≈üteriden), negatifse gider (tedarik√ßiye)
        const paymentType = tx.amount > 0 ? 'income' : 'expense';
        const absoluteAmount = Math.abs(tx.amount);

        // Create payment record
        const payment = {
            id: Date.now().toString() + '_' + index + '_' + Math.random(),
            companyId: activeCompanyId,
            date: tx.date,
            accountId: accountId,
            amount: absoluteAmount,
            type: paymentType,
            invoiceId: null,
            description: `${tx.description.substring(0, 200)}${invoiceNote ? ' (' + invoiceNote + ')' : ''}`,
            source: 'bank',
            createdAt: new Date().toISOString()
        };

        payments.push(payment);

        // ‚úÖ DOƒûRU BAKƒ∞YE G√úNCELLEME
        if (account.type === 'customer') {
            // M√ú≈ûTERƒ∞: Tahsilat geldi ‚Üí Bor√ß azalƒ±r
            if (paymentType === 'income') {
                account.balance -= absoluteAmount;
            } else {
                // M√º≈üteriye iade yaptƒ±k ‚Üí Bor√ß artar
                account.balance += absoluteAmount;
            }
        } else {
            // TEDARƒ∞K√áƒ∞: √ñdeme yaptƒ±k ‚Üí Alacak azalƒ±r
            if (paymentType === 'expense') {
                account.balance += absoluteAmount; // Bor√ß azalƒ±r (negatiften pozitife doƒüru)
            } else {
                // Tedarik√ßiden iade aldƒ±k ‚Üí Alacak artar
                account.balance -= absoluteAmount;
            }
        }

        savedCount++;
        console.log(`‚úÖ ƒ∞≈ülem ${index + 1} kaydedildi:`, {
            amount: absoluteAmount,
            type: paymentType,
            newBalance: account.balance
        });
    });

    // Save to localStorage
    localStorage.setItem('payments', JSON.stringify(payments));
    localStorage.setItem('accounts', JSON.stringify(accounts));

    // Refresh UI
    closeTransactionDetailsModal();
    loadPayments();
    loadAccounts();
    updateDashboard();

    const message = savedCount === pendingTransactions.length
        ? `‚úÖ T√ºm ${savedCount} i≈ülem ba≈üarƒ±yla kaydedildi!`
        : `‚úÖ ${savedCount} i≈ülem kaydedildi.\n‚ö†Ô∏è ${skippedCount} i≈ülem atlandƒ± (cari hesap se√ßilmedi)`;
    
    alert(message);
}

// ========================================
// CARƒ∞ HESAP KARTI MODAL
// ========================================

let currentAccountCardId = null;
let accountCardTransactions = [];

function viewAccountCard(accountId) {
    currentAccountCardId = accountId;
    const account = accounts.find(a => a.id === accountId);
    
    if (!account) {
        alert('‚ùå Cari hesap bulunamadƒ±!');
        return;
    }

    // Modal ba≈ülƒ±ƒüƒ± ve bilgileri
    document.getElementById('accountCardTitle').innerHTML = `üìä Cari Hesap Kartƒ± - ${account.name}`;
    document.getElementById('cardAccountName').textContent = account.name;
    document.getElementById('cardAccountType').innerHTML = `<span class="badge badge-${account.type === 'customer' ? 'success' : 'warning'}">${account.type === 'customer' ? 'M√º≈üteri' : 'Tedarik√ßi'}</span>`;
    
    const balanceColor = account.balance >= 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('cardAccountBalance').innerHTML = `<span style="color: ${balanceColor}">${formatCurrency(account.balance)}</span>`;
    
    document.getElementById('cardAccountPhone').textContent = account.phone || '-';
    document.getElementById('cardAccountEmail').textContent = account.email || '-';
    document.getElementById('cardAccountTaxNo').textContent = account.taxNo || '-';

    // Yƒ±l se√ßeneklerini doldur
    populateYearOptions();

    // T√ºm i≈ülemleri y√ºkle
    loadAccountCardTransactions();

    // Modal'ƒ± a√ß
    document.getElementById('accountCardModal').classList.add('active');
}

function closeAccountCardModal() {
    document.getElementById('accountCardModal').classList.remove('active');
    currentAccountCardId = null;
    accountCardTransactions = [];
}

function populateYearOptions() {
    const select = document.getElementById('cardFilterYear');
    select.innerHTML = '<option value="">T√ºm Yƒ±llar</option>';
    
    // Mevcut i≈ülemlerden yƒ±llarƒ± √ßƒ±kar
    const years = new Set();
    
    invoices.forEach(inv => {
        if (inv.accountId === currentAccountCardId) {
            const year = new Date(inv.date).getFullYear();
            years.add(year);
        }
    });
    
    payments.forEach(p => {
        if (p.accountId === currentAccountCardId) {
            const year = new Date(p.date).getFullYear();
            years.add(year);
        }
    });
    
    // Yƒ±llarƒ± sƒ±rala ve ekle
    Array.from(years).sort((a, b) => b - a).forEach(year => {
        const option = new Option(year, year);
        select.add(option);
    });
}

function loadAccountCardTransactions() {
    accountCardTransactions = [];
    
    // Faturalarƒ± ekle
    invoices.filter(inv => inv.accountId === currentAccountCardId).forEach(inv => {
        const company = companies.find(c => c.id === inv.companyId);
        accountCardTransactions.push({
            date: inv.date,
            type: 'invoice',
            subType: inv.type, // sales or purchase
            reference: inv.invoiceNo,
            description: `${inv.type === 'sales' ? 'üìó Satƒ±≈ü' : 'üìï Alƒ±≈ü'} Faturasƒ± - ${company ? company.name : 'Bilinmiyor'}`,
            debit: inv.type === 'sales' ? inv.total : 0,
            credit: inv.type === 'purchase' ? inv.total : 0,
            invoiceId: inv.id,
            paymentId: null
        });
    });
    
    // √ñdemeleri ekle
    payments.filter(p => p.accountId === currentAccountCardId).forEach(p => {
        const invoice = p.invoiceId ? invoices.find(inv => inv.id === p.invoiceId) : null;
        const company = companies.find(c => c.id === p.companyId);
        
        accountCardTransactions.push({
            date: p.date,
            type: 'payment',
            subType: p.type, // income or expense
            reference: invoice ? invoice.invoiceNo : 'Genel √ñdeme',
            description: `${p.type === 'income' ? 'üí∞ Tahsilat' : 'üí∏ √ñdeme'} - ${p.description || (company ? company.name : 'Bilinmiyor')}`,
            debit: p.type === 'expense' ? p.amount : 0,
            credit: p.type === 'income' ? p.amount : 0,
            invoiceId: p.invoiceId,
            paymentId: p.id,
            source: p.source // manual or bank
        });
    });
    
    // Tarihe g√∂re sƒ±rala
    accountCardTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    filterAccountCard();
}

function filterAccountCard() {
    const year = document.getElementById('cardFilterYear').value;
    const startDate = document.getElementById('cardFilterStartDate').value;
    const endDate = document.getElementById('cardFilterEndDate').value;
    const filterType = document.getElementById('cardFilterType').value;
    
    let filtered = [...accountCardTransactions];
    
    // Yƒ±l filtresi
    if (year) {
        filtered = filtered.filter(t => new Date(t.date).getFullYear().toString() === year);
    }
    
    // Tarih aralƒ±ƒüƒ± filtresi
    if (startDate) {
        filtered = filtered.filter(t => t.date >= startDate);
    }
    if (endDate) {
        filtered = filtered.filter(t => t.date <= endDate);
    }
    
    // ƒ∞≈ülem tipi filtresi
    if (filterType === 'invoice') {
        filtered = filtered.filter(t => t.type === 'invoice');
    } else if (filterType === 'payment') {
        filtered = filtered.filter(t => t.type === 'payment');
    } else if (filterType === 'income') {
        filtered = filtered.filter(t => t.credit > 0);
    } else if (filterType === 'expense') {
        filtered = filtered.filter(t => t.debit > 0);
    }
    
    renderAccountCardTable(filtered);
    updateAccountCardStats(filtered);
}

function renderAccountCardTable(transactions) {
    const tbody = document.querySelector('#accountCardTable tbody');
    tbody.innerHTML = '';
    
    if (transactions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:20px; color:#6b7280;">Bu filtreye uygun i≈ülem bulunamadƒ±.</td></tr>';
        return;
    }
    
    let balance = 0;
    
    transactions.forEach(t => {
        balance += (t.debit - t.credit);
        
        const row = tbody.insertRow();
        
        // Tip badge'i
        let typeBadge = '';
        if (t.type === 'invoice') {
            typeBadge = `<span class="badge badge-${t.subType === 'sales' ? 'success' : 'warning'}">Fatura</span>`;
        } else {
            typeBadge = `<span class="badge badge-${t.subType === 'income' ? 'success' : 'danger'}">√ñdeme</span>`;
            if (t.source === 'bank') {
                typeBadge += ' <span class="badge badge-info" style="font-size:0.8em;">Banka</span>';
            }
        }
        
        row.innerHTML = `
            <td>${formatDate(t.date)}</td>
            <td>${typeBadge}</td>
            <td><strong>${t.reference}</strong></td>
            <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;">${t.description}</td>
            <td style="color: var(--danger); font-weight: 600;">${t.debit > 0 ? formatCurrency(t.debit) : '-'}</td>
            <td style="color: var(--success); font-weight: 600;">${t.credit > 0 ? formatCurrency(t.credit) : '-'}</td>
            <td style="font-weight: 700; color: ${balance >= 0 ? 'var(--success)' : 'var(--danger)'};">${formatCurrency(balance)}</td>
            <td>
                ${t.invoiceId ? `<button class="btn btn-info btn-sm" onclick="viewInvoice('${t.invoiceId}')">üëÅÔ∏è</button>` : ''}
                ${t.paymentId ? `<button class="btn btn-warning btn-sm" onclick="viewPaymentDetail('${t.paymentId}')">üìÑ</button>` : ''}
            </td>
        `;
    });
}

function updateAccountCardStats(transactions) {
    let totalIncome = 0;
    let totalExpense = 0;
    let totalInvoices = 0;
    let incomeCount = 0;
    let expenseCount = 0;
    let invoiceCount = 0;
    
    transactions.forEach(t => {
        if (t.credit > 0) {
            totalIncome += t.credit;
            incomeCount++;
        }
        if (t.debit > 0) {
            totalExpense += t.debit;
            expenseCount++;
        }
        if (t.type === 'invoice') {
            totalInvoices += (t.debit || t.credit);
            invoiceCount++;
        }
    });
    
    const netBalance = totalIncome - totalExpense;
    
    document.getElementById('cardTotalIncome').textContent = formatCurrency(totalIncome);
    document.getElementById('cardIncomeCount').textContent = `${incomeCount} i≈ülem`;
    
    document.getElementById('cardTotalExpense').textContent = formatCurrency(totalExpense);
    document.getElementById('cardExpenseCount').textContent = `${expenseCount} i≈ülem`;
    
    document.getElementById('cardTotalInvoices').textContent = formatCurrency(totalInvoices);
    document.getElementById('cardInvoiceCount').textContent = `${invoiceCount} fatura`;
    
    const netBalanceColor = netBalance >= 0 ? 'var(--success)' : 'var(--danger)';
    document.getElementById('cardNetBalance').innerHTML = `<span style="color: ${netBalanceColor}">${formatCurrency(netBalance)}</span>`;
}

function clearAccountCardFilters() {
    document.getElementById('cardFilterYear').value = '';
    document.getElementById('cardFilterStartDate').value = '';
    document.getElementById('cardFilterEndDate').value = '';
    document.getElementById('cardFilterType').value = '';
    filterAccountCard();
}

function viewPaymentDetail(paymentId) {
    const payment = payments.find(p => p.id === paymentId);
    if (!payment) {
        alert('‚ùå √ñdeme kaydƒ± bulunamadƒ±!');
        return;
    }
    
    const account = accounts.find(a => a.id === payment.accountId);
    const invoice = payment.invoiceId ? invoices.find(inv => inv.id === payment.invoiceId) : null;
    const company = companies.find(c => c.id === payment.companyId);
    
    const details = `
üìã √ñDEME DETAYI

Tarih: ${formatDate(payment.date)}
Cari: ${account ? account.name : 'Bilinmiyor'}
Firma: ${company ? company.name : 'Bilinmiyor'}
Tutar: ${formatCurrency(payment.amount)}
Tip: ${payment.type === 'income' ? 'üí∞ Tahsilat (Gelen)' : 'üí∏ √ñdeme (Giden)'}
${invoice ? `Fatura: ${invoice.invoiceNo}` : 'Fatura: Genel √ñdeme'}
Kaynak: ${payment.source === 'manual' ? '‚úçÔ∏è Manuel' : 'üè¶ Banka'}
A√ßƒ±klama: ${payment.description || '-'}
Kayƒ±t Tarihi: ${new Date(payment.createdAt).toLocaleString('tr-TR')}
    `;
    
    alert(details);
}

function exportAccountCard() {
    const account = accounts.find(a => a.id === currentAccountCardId);
    if (!account) return;
    
    const year = document.getElementById('cardFilterYear').value;
    const startDate = document.getElementById('cardFilterStartDate').value;
    const endDate = document.getElementById('cardFilterEndDate').value;
    
    // Filtered transactions al
    let filtered = [...accountCardTransactions];
    
    if (year) {
        filtered = filtered.filter(t => new Date(t.date).getFullYear().toString() === year);
    }
    if (startDate) {
        filtered = filtered.filter(t => t.date >= startDate);
    }
    if (endDate) {
        filtered = filtered.filter(t => t.date <= endDate);
    }
    
    // CSV olu≈ütur
    let csv = 'Tarih,ƒ∞≈ülem Tipi,Referans,A√ßƒ±klama,Bor√ß,Alacak,Bakiye\n';
    
    let balance = 0;
    filtered.forEach(t => {
        balance += (t.debit - t.credit);
        
        const typeText = t.type === 'invoice' ? 'Fatura' : '√ñdeme';
        const debitText = t.debit > 0 ? t.debit.toFixed(2) : '';
        const creditText = t.credit > 0 ? t.credit.toFixed(2) : '';
        
        csv += `${t.date},${typeText},${t.reference},"${t.description.replace(/"/g, '""')}",${debitText},${creditText},${balance.toFixed(2)}\n`;
    });
    
    // Download
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `cari-hesap-${account.name}-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    
    alert('‚úÖ Cari hesap kartƒ± Excel\'e aktarƒ±ldƒ±!');
}

// ========================================
// Fƒ∞RMA D√ñK√úMAN Y√ñNETƒ∞Mƒ∞
// ========================================

function addCompanyDocument() {
    const docId = Date.now() + Math.random();
    
    companyDocuments.push({
        id: docId,
        name: '',
        file: null,
        fileName: '',
        fileSize: 0,
        fileType: '',
        uploadDate: new Date().toISOString()
    });
    
    renderCompanyDocuments();
}

function renderCompanyDocuments() {
    const container = document.getElementById('companyDocumentsList');
    container.innerHTML = '';
    
    if (companyDocuments.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; font-style: italic;">Hen√ºz d√∂k√ºman eklenmedi.</p>';
        return;
    }
    
    companyDocuments.forEach((doc, index) => {
        const div = document.createElement('div');
        div.style.cssText = 'border: 2px solid #e5e7eb; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f9fafb;';
        
        div.innerHTML = `
            <div class="grid-2" style="align-items: end;">
                <div class="form-group" style="margin: 0;">
                    <label>D√∂k√ºman Adƒ±</label>
                    <input type="text" 
                           value="${doc.name}" 
                           onchange="updateCompanyDocName(${index}, this.value)" 
                           placeholder="√ñrn: Ticaret Sicil Gazetesi"
                           style="margin: 0;">
                </div>
                <div class="form-group" style="margin: 0;">
                    <label>Dosya Se√ß</label>
                    <input type="file" 
                           onchange="handleCompanyDocFile(${index}, this.files[0])"
                           accept=".pdf,.jpg,.jpeg,.png,.doc,.docx"
                           style="margin: 0;">
                </div>
            </div>
            ${doc.fileName ? `
                <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 0.9em;">
                    üìÑ <strong>${doc.fileName}</strong> 
                    (${formatFileSize(doc.fileSize)})
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeCompanyDocument(${index})" style="float: right;">
                        üóëÔ∏è Kaldƒ±r
                    </button>
                </div>
            ` : ''}
        `;
        
        container.appendChild(div);
    });
}

function updateCompanyDocName(index, name) {
    companyDocuments[index].name = name;
}

function handleCompanyDocFile(index, file) {
    if (!file) return;
    
    // Dosya boyut kontrol√º (max 10MB per file)
    if (file.size > 10 * 1024 * 1024) {
        alert('‚ö†Ô∏è Dosya boyutu 10 MB\'dan k√º√ß√ºk olmalƒ±dƒ±r!');
        return;
    }
    
    // Dosya tipini kontrol et
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg', 
                          'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    
    if (!allowedTypes.includes(file.type)) {
        alert('‚ö†Ô∏è Sadece PDF, JPG, PNG, DOC, DOCX dosyalarƒ± y√ºklenebilir!');
        return;
    }
    
    // FileReader ile base64'e √ßevir
    const reader = new FileReader();
    reader.onload = function(e) {
        companyDocuments[index].file = e.target.result; // base64
        companyDocuments[index].fileName = file.name;
        companyDocuments[index].fileSize = file.size;
        companyDocuments[index].fileType = file.type;
        
        renderCompanyDocuments();
    };
    reader.readAsDataURL(file);
}

function removeCompanyDocument(index) {
    if (confirm('Bu d√∂k√ºmanƒ± kaldƒ±rmak istediƒüinizden emin misiniz?')) {
        companyDocuments.splice(index, 1);
        renderCompanyDocuments();
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

// ========================================
// CARƒ∞ D√ñK√úMAN Y√ñNETƒ∞Mƒ∞
// ========================================

function addAccountDocument() {
    if (accountDocuments.length >= MAX_ACCOUNT_DOCS) {
        alert('‚ö†Ô∏è Maksimum 5 d√∂k√ºman ekleyebilirsiniz!');
        return;
    }
    
    const totalSize = accountDocuments.reduce((sum, doc) => sum + doc.fileSize, 0);
    if (totalSize >= MAX_ACCOUNT_SIZE) {
        alert('‚ö†Ô∏è Toplam d√∂k√ºman boyutu 3 MB\'ƒ± a≈üamaz!');
        return;
    }
    
    const docId = Date.now() + Math.random();
    
    accountDocuments.push({
        id: docId,
        name: '',
        file: null,
        fileName: '',
        fileSize: 0,
        fileType: '',
        uploadDate: new Date().toISOString()
    });
    
    renderAccountDocuments();
}

function renderAccountDocuments() {
    const container = document.getElementById('accountDocumentsList');
    container.innerHTML = '';
    
    if (accountDocuments.length === 0) {
        container.innerHTML = '<p style="color: #6b7280; font-style: italic;">Hen√ºz d√∂k√ºman eklenmedi.</p>';
    } else {
        accountDocuments.forEach((doc, index) => {
            const div = document.createElement('div');
            div.style.cssText = 'border: 2px solid #e5e7eb; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f9fafb;';
            
            div.innerHTML = `
                <div class="grid-2" style="align-items: end;">
                    <div class="form-group" style="margin: 0;">
                        <label>D√∂k√ºman Adƒ±</label>
                        <input type="text" 
                               value="${doc.name}" 
                               onchange="updateAccountDocName(${index}, this.value)" 
                               placeholder="√ñrn: S√∂zle≈üme"
                               style="margin: 0;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label>Dosya Se√ß</label>
                        <input type="file" 
                               onchange="handleAccountDocFile(${index}, this.files[0])"
                               accept=".pdf,.jpg,.jpeg,.png"
                               style="margin: 0;">
                    </div>
                </div>
                ${doc.fileName ? `
                    <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 4px; font-size: 0.9em;">
                        üìÑ <strong>${doc.fileName}</strong> 
                        (${formatFileSize(doc.fileSize)})
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeAccountDocument(${index})" style="float: right;">
                            üóëÔ∏è Kaldƒ±r
                        </button>
                    </div>
                ` : ''}
            `;
            
            container.appendChild(div);
        });
    }
    
    // Buton g√ºncelle
    const totalSize = accountDocuments.reduce((sum, doc) => sum + doc.fileSize, 0);
    document.getElementById('addAccountDocBtn').textContent = `‚ûï D√∂k√ºman Ekle (${accountDocuments.length}/${MAX_ACCOUNT_DOCS})`;
    document.getElementById('addAccountDocBtn').disabled = accountDocuments.length >= MAX_ACCOUNT_DOCS || totalSize >= MAX_ACCOUNT_SIZE;
    document.getElementById('accountDocSize').textContent = formatFileSize(totalSize);
    
    // Boyut uyarƒ±sƒ±
    const sizeInfo = document.getElementById('accountDocSizeInfo');
    if (totalSize > MAX_ACCOUNT_SIZE * 0.9) {
        sizeInfo.style.color = 'var(--danger)';
    } else if (totalSize > MAX_ACCOUNT_SIZE * 0.7) {
        sizeInfo.style.color = 'var(--warning)';
    } else {
        sizeInfo.style.color = '#6b7280';
    }
}

function updateAccountDocName(index, name) {
    accountDocuments[index].name = name;
}

function handleAccountDocFile(index, file) {
    if (!file) return;
    
    // Mevcut toplam boyut
    const currentTotalSize = accountDocuments.reduce((sum, doc, idx) => {
        return idx === index ? sum : sum + doc.fileSize;
    }, 0);
    
    // Yeni dosya ile birlikte toplam boyut kontrol√º
    if (currentTotalSize + file.size > MAX_ACCOUNT_SIZE) {
        alert(`‚ö†Ô∏è Toplam d√∂k√ºman boyutu ${formatFileSize(MAX_ACCOUNT_SIZE)} sƒ±nƒ±rƒ±nƒ± a≈üƒ±yor!\n\nMevcut: ${formatFileSize(currentTotalSize)}\nYeni dosya: ${formatFileSize(file.size)}`);
        return;
    }
    
    // Dosya boyut kontrol√º (max 2MB per file)
    if (file.size > 2 * 1024 * 1024) {
        alert('‚ö†Ô∏è Tek dosya boyutu 2 MB\'dan k√º√ß√ºk olmalƒ±dƒ±r!');
        return;
    }
    
    // Dosya tipini kontrol et (sadece PDF ve resim)
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg'];
    
    if (!allowedTypes.includes(file.type)) {
        alert('‚ö†Ô∏è Sadece PDF, JPG, PNG dosyalarƒ± y√ºklenebilir!');
        return;
    }
    
    // FileReader ile base64'e √ßevir
    const reader = new FileReader();
    reader.onload = function(e) {
        accountDocuments[index].file = e.target.result; // base64
        accountDocuments[index].fileName = file.name;
        accountDocuments[index].fileSize = file.size;
        accountDocuments[index].fileType = file.type;
        
        renderAccountDocuments();
    };
    reader.readAsDataURL(file);
}

function removeAccountDocument(index) {
    if (confirm('Bu d√∂k√ºmanƒ± kaldƒ±rmak istediƒüinizden emin misiniz?')) {
        accountDocuments.splice(index, 1);
        renderAccountDocuments();
    }
}

// ========================================
// D√ñK√úMAN G√ñR√úNT√úLEME
// ========================================

let currentDocuments = [];
let currentDocumentData = null;

function viewCompanyDocuments(companyId) {
    const company = companies.find(c => c.id === companyId);
    if (!company || !company.documents || company.documents.length === 0) {
        alert('‚ùå Bu firmaya ait d√∂k√ºman bulunamadƒ±!');
        return;
    }
    
    currentDocuments = company.documents;
    
    document.getElementById('documentsModalTitle').textContent = `üìé ${company.name} - D√∂k√ºmanlar`;
    
    renderDocumentsList();
    
    document.getElementById('documentsModal').classList.add('active');
}

function viewAccountDocuments(accountId) {
    const account = accounts.find(a => a.id === accountId);
    if (!account || !account.documents || account.documents.length === 0) {
        alert('‚ùå Bu cari hesaba ait d√∂k√ºman bulunamadƒ±!');
        return;
    }
    
    currentDocuments = account.documents;
    
    document.getElementById('documentsModalTitle').textContent = `üìé ${account.name} - D√∂k√ºmanlar`;
    
    renderDocumentsList();
    
    document.getElementById('documentsModal').classList.add('active');
}

function renderDocumentsList() {
    const container = document.getElementById('documentsListView');
    container.innerHTML = '';
    
    if (currentDocuments.length === 0) {
        container.innerHTML = '<p style="text-align:center; color:#6b7280;">D√∂k√ºman bulunamadƒ±.</p>';
        return;
    }
    
    currentDocuments.forEach((doc, index) => {
        const card = document.createElement('div');
        card.style.cssText = `
            border: 2px solid #e5e7eb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        `;
        
        card.onmouseover = function() {
            this.style.borderColor = '#2563eb';
            this.style.boxShadow = '0 4px 12px rgba(37, 99, 235, 0.2)';
        };
        
        card.onmouseout = function() {
            this.style.borderColor = '#e5e7eb';
            this.style.boxShadow = 'none';
        };
        
        const fileIcon = getFileIcon(doc.fileType);
        const uploadDate = new Date(doc.uploadDate).toLocaleDateString('tr-TR');
        
        card.innerHTML = `
            <div style="flex: 1;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="font-size: 2.5em;">${fileIcon}</div>
                    <div>
                        <h4 style="margin: 0; color: var(--primary);">${doc.name || 'ƒ∞simsiz D√∂k√ºman'}</h4>
                        <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">
                            üìÑ ${doc.fileName} ‚Ä¢ ${formatFileSize(doc.fileSize)} ‚Ä¢ ${uploadDate}
                        </p>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-info btn-sm" onclick="viewDocument(${index})" title="G√∂r√ºnt√ºle">
                    üëÅÔ∏è G√∂r√ºnt√ºle
                </button>
                <button class="btn btn-success btn-sm" onclick="downloadDocument(${index})" title="ƒ∞ndir">
                    üì• ƒ∞ndir
                </button>
            </div>
        `;
        
        container.appendChild(card);
    });
}

function getFileIcon(fileType) {
    if (fileType.includes('pdf')) return 'üìï';
    if (fileType.includes('image')) return 'üñºÔ∏è';
    if (fileType.includes('word') || fileType.includes('doc')) return 'üìÑ';
    return 'üìé';
}

function viewDocument(index) {
    const doc = currentDocuments[index];
    currentDocumentData = doc;
    
    document.getElementById('documentViewerTitle').textContent = `üìÑ ${doc.name}`;
    
    const content = document.getElementById('documentViewerContent');
    content.innerHTML = '';
    
    if (doc.fileType.includes('image')) {
        // Resim g√∂ster
        const img = document.createElement('img');
        img.src = doc.file;
        img.style.maxWidth = '100%';
        img.style.borderRadius = '8px';
        img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        content.appendChild(img);
    } else if (doc.fileType.includes('pdf')) {
        // PDF g√∂ster
        const iframe = document.createElement('iframe');
        iframe.src = doc.file;
        iframe.style.width = '100%';
        iframe.style.height = '600px';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        content.appendChild(iframe);
    } else {
        // Diƒüer dosya tipleri i√ßin download butonu
        content.innerHTML = `
            <div style="padding: 40px; text-align: center;">
                <div style="font-size: 4em; margin-bottom: 20px;">üìÑ</div>
                <h3>${doc.fileName}</h3>
                <p style="color: #6b7280; margin: 20px 0;">Bu dosya t√ºr√º √∂nizlenemez.</p>
                <button class="btn btn-success" onclick="downloadDocument(${index})">
                    üì• Dosyayƒ± ƒ∞ndir
                </button>
            </div>
        `;
    }
    
    document.getElementById('documentViewerModal').classList.add('active');
}

function downloadDocument(index) {
    const doc = currentDocuments[index];
    
    // Base64'ten blob olu≈ütur
    const byteString = atob(doc.file.split(',')[1]);
    const mimeString = doc.file.split(',')[0].split(':')[1].split(';')[0];
    const ab = new ArrayBuffer(byteString.length);
    const ia = new Uint8Array(ab);
    
    for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
    }
    
    const blob = new Blob([ab], { type: mimeString });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.href = url;
    link.download = doc.fileName;
    link.click();
    
    URL.revokeObjectURL(url);
}

function downloadCurrentDocument() {
    if (currentDocumentData) {
        const index = currentDocuments.indexOf(currentDocumentData);
        downloadDocument(index);
    }
}

function closeDocumentsModal() {
    document.getElementById('documentsModal').classList.remove('active');
    currentDocuments = [];
}

function closeDocumentViewer() {
    document.getElementById('documentViewerModal').classList.remove('active');
    currentDocumentData = null;
}

// ========================================
// Fƒ∞RMA DETAY MODAL
// ========================================

let currentDetailCompanyId = null;

function viewCompanyDetail(companyId) {
    const company = companies.find(c => c.id === companyId);
    
    if (!company) {
        alert('‚ùå Firma bulunamadƒ±!');
        return;
    }
    
    currentDetailCompanyId = companyId;
    
    // Ba≈ülƒ±k
    document.getElementById('companyDetailTitle').textContent = `üè¢ ${company.name}`;
    
    // Temel Bilgiler
    document.getElementById('detailCompanyName').textContent = company.name;
    document.getElementById('detailCompanySector').textContent = company.sector || 'Sekt√∂r belirtilmemi≈ü';
    document.getElementById('detailCompanyNameFull').textContent = company.name;
    document.getElementById('detailCompanySectorFull').innerHTML = company.sector 
        ? `<span class="badge badge-info" style="font-size: 1em;">${company.sector}</span>` 
        : '<span style="color: #6b7280;">Belirtilmemi≈ü</span>';
    
    // Vergi Bilgileri
    document.getElementById('detailCompanyTaxNo').textContent = company.taxNo || '-';
    document.getElementById('detailCompanyTaxOffice').textContent = company.taxOffice || '-';
    
    // ƒ∞leti≈üim Bilgileri
    document.getElementById('detailCompanyPhone').textContent = company.phone || '-';
    
    const emailEl = document.getElementById('detailCompanyEmail');
    if (company.email) {
        emailEl.innerHTML = `<a href="mailto:${company.email}" style="color: var(--primary);">${company.email}</a>`;
    } else {
        emailEl.textContent = '-';
    }
    
    const websiteEl = document.getElementById('detailCompanyWebsite');
    if (company.website) {
        websiteEl.innerHTML = `<a href="${company.website}" target="_blank" style="color: var(--primary);">${company.website}</a>`;
    } else {
        websiteEl.textContent = '-';
    }
    
    document.getElementById('detailCompanyAddress').textContent = company.address || '-';
    
    // D√∂k√ºmanlar
    if (company.documents && company.documents.length > 0) {
        document.getElementById('detailCompanyDocumentsCard').style.display = 'block';
        document.getElementById('detailViewDocsBtn').style.display = 'inline-block';
        
        const docsContainer = document.getElementById('detailCompanyDocuments');
        docsContainer.innerHTML = '';
        
        company.documents.forEach((doc, index) => {
            const docDiv = document.createElement('div');
            docDiv.style.cssText = 'display: flex; align-items: center; padding: 12px; background: white; border-radius: 6px; margin-bottom: 10px; border: 1px solid #e5e7eb;';
            
            const fileIcon = getFileIcon(doc.fileType);
            
            docDiv.innerHTML = `
                <div style="font-size: 2em; margin-right: 15px;">${fileIcon}</div>
                <div style="flex: 1;">
                    <strong>${doc.name || 'ƒ∞simsiz D√∂k√ºman'}</strong>
                    <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        ${doc.fileName} ‚Ä¢ ${formatFileSize(doc.fileSize)}
                    </p>
                </div>
                <span class="badge badge-info">${index + 1}</span>
            `;
            
            docsContainer.appendChild(docDiv);
        });
    } else {
        document.getElementById('detailCompanyDocumentsCard').style.display = 'none';
        document.getElementById('detailViewDocsBtn').style.display = 'none';
    }
    
    // Kayƒ±t Loglarƒ±
    if (company.createdAt) {
        const createdDate = new Date(company.createdAt).toLocaleString('tr-TR');
        const createdBy = company.createdBy || 'Bilinmiyor';
        document.getElementById('detailCompanyCreated').innerHTML = `
            <span style="color: var(--success); font-weight: 600;">${createdDate}</span><br>
            <span style="font-size: 0.9em; color: #6b7280;">Olu≈üturan: ${createdBy}</span>
        `;
    } else {
        document.getElementById('detailCompanyCreated').textContent = '-';
    }
    
    if (company.updatedAt && company.updatedAt !== company.createdAt) {
        const updatedDate = new Date(company.updatedAt).toLocaleString('tr-TR');
        const updatedBy = company.updatedBy || 'Bilinmiyor';
        document.getElementById('detailCompanyUpdated').innerHTML = `
            <span style="color: var(--warning); font-weight: 600;">${updatedDate}</span><br>
            <span style="font-size: 0.9em; color: #6b7280;">G√ºncelleyen: ${updatedBy}</span>
        `;
    } else {
        document.getElementById('detailCompanyUpdated').innerHTML = '<span style="color: #6b7280;">G√ºncelleme yapƒ±lmamƒ±≈ü</span>';
    }
    
    // Cari Hesap Sayƒ±sƒ±
    const companyAccounts = accounts.filter(a => a.companyId === companyId);
    document.getElementById('detailAccountCount').textContent = companyAccounts.length;
    
    // Finansal √ñzet
    calculateCompanyFinancials(companyId);
    
    // Cari Hesaplar Listesi
    renderCompanyAccountsList(companyAccounts);
    
    // Modal'ƒ± a√ß
    document.getElementById('companyDetailModal').classList.add('active');
}

function calculateCompanyFinancials(companyId) {
    const companyInvoices = invoices.filter(inv => inv.companyId === companyId);
    const companyPayments = payments.filter(p => p.companyId === companyId);
    
    const salesInvoices = companyInvoices.filter(inv => inv.type === 'sales');
    const purchaseInvoices = companyInvoices.filter(inv => inv.type === 'purchase');
    
    const totalIncome = salesInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
    const totalExpense = purchaseInvoices.reduce((sum, inv) => sum + inv.subtotal, 0);
    const netProfit = totalIncome - totalExpense;
    
    const totalPaymentsAmount = companyPayments.reduce((sum, p) => sum + p.amount, 0);
    
    document.getElementById('detailTotalIncome').textContent = formatCurrency(totalIncome);
    document.getElementById('detailIncomeInvoices').textContent = `${salesInvoices.length} fatura`;
    
    document.getElementById('detailTotalExpense').textContent = formatCurrency(totalExpense);
    document.getElementById('detailExpenseInvoices').textContent = `${purchaseInvoices.length} fatura`;
    
    const netProfitEl = document.getElementById('detailNetProfit');
    netProfitEl.textContent = formatCurrency(netProfit);
    netProfitEl.style.color = netProfit >= 0 ? 'var(--success)' : 'var(--danger)';
    
    document.getElementById('detailTotalPayments').textContent = formatCurrency(totalPaymentsAmount);
    document.getElementById('detailPaymentCount').textContent = `${companyPayments.length} √∂deme`;
}

function renderCompanyAccountsList(companyAccounts) {
    const container = document.getElementById('detailCompanyAccountsList');
    
    if (companyAccounts.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">Bu firmaya ait cari hesap bulunmuyor.</p>';
        return;
    }
    
    container.innerHTML = '';
    
    companyAccounts.forEach(account => {
        const accountDiv = document.createElement('div');
        accountDiv.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 12px;
            transition: all 0.3s;
        `;
        
        accountDiv.onmouseover = function() {
            this.style.borderColor = '#2563eb';
            this.style.boxShadow = '0 4px 12px rgba(37, 99, 235, 0.2)';
        };
        
        accountDiv.onmouseout = function() {
            this.style.borderColor = '#e5e7eb';
            this.style.boxShadow = 'none';
        };
        
const typeText = account.type === 'customer'
    ? 'M√º≈üteri'
    : account.type === 'supplier'
    ? 'Tedarik√ßi'
    : 'Personel';

const typeBadge = account.type === 'customer'
    ? 'success'
    : account.type === 'supplier'
    ? 'warning'
    : 'info';

        const balanceColor = account.balance >= 0 ? 'var(--success)' : 'var(--danger)';
        
        accountDiv.innerHTML = `
            <div style="flex: 1;">
                <h4 style="margin: 0 0 5px 0; color: var(--primary);">${account.name}</h4>
                <div style="display: flex; gap: 10px; font-size: 0.9em; color: #6b7280;">
                    <span class="badge badge-${typeBadge}">${typeText}</span>
                    ${account.phone ? `<span>üì± ${account.phone}</span>` : ''}
                </div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: 1.5em; font-weight: 700; color: ${balanceColor}; margin-bottom: 5px;">
                    ${formatCurrency(account.balance)}
                </div>
                <button class="btn btn-info btn-sm" onclick="viewAccountCardFromCompanyDetail('${account.id}')">
                    üìä Hesap Kartƒ±
                </button>
            </div>
        `;
        
        container.appendChild(accountDiv);
    });
}

function editCompanyFromDetail() {
    closeCompanyDetailModal();
    showTab('companies');
    document.querySelector('.tab[onclick*="companies"]').click();
    setTimeout(() => {
        editCompany(currentDetailCompanyId);
    }, 300);
}

function viewCompanyAccountsFromDetail() {
    closeCompanyDetailModal();
    viewCompanyAccounts(currentDetailCompanyId);
}

function viewCompanyDocumentsFromDetail() {
    viewCompanyDocuments(currentDetailCompanyId);
}

function viewAccountCardFromCompanyDetail(accountId) {
    viewAccountCard(accountId);
}

function closeCompanyDetailModal() {
    document.getElementById('companyDetailModal').classList.remove('active');
    currentDetailCompanyId = null;
}

// ========================================
// E-FATURA ƒ∞MPORT Sƒ∞STEMƒ∞
// ========================================

let parsedInvoices = [];
let currentInvoiceType = 'sales';


// MODAL A√áMA - HER SEFERƒ∞NDE TEMƒ∞ZLENƒ∞R
function openImportInvoiceModal() {
    // Eski modal varsa kapat ve inputu sƒ±fƒ±rla
    closeImportInvoiceModal();

    if (!activeCompanyId) {
        alert('‚ö†Ô∏è L√ºtfen √∂nce bir firma se√ßin!');
        return;
    }
    document.getElementById('importInvoiceModal').classList.add('active');
    // Dosya inputunu sƒ±fƒ±rla
    const input = document.getElementById('invoiceExcelFile');
    if (input) input.value = '';
}

// MODAL KAPATMA - HER SEFERƒ∞NDE TEMƒ∞ZLENƒ∞R
function closeImportInvoiceModal() {
    const modal = document.getElementById('importInvoiceModal');
    if (modal) modal.classList.remove('active');
    const input = document.getElementById('invoiceExcelFile');
    if (input) input.value = '';
}

function updateInvoiceTypeSelection() {
    const selectedType = document.querySelector('input[name="invoiceImportType"]:checked').value;
    currentInvoiceType = selectedType;
    console.log('Fatura t√ºr√º se√ßildi:', selectedType === 'sales' ? 'Giden (Satƒ±≈ü)' : 'Gelen (Alƒ±≈ü)');
}

function handleInvoiceExcelDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        processInvoiceFile(files[0]);
    }
}

// Dosya Y√ºkleme Handler
function importInvoiceExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    processInvoiceFile(file);
}

// Dosya ƒ∞√ßeriƒüini Okuma ve Parse Etme
function processInvoiceFile(file) {
    // Modal inputu var mƒ± kontrol et
    if (!file) {
        alert("Dosya se√ßilmedi!");
        return;
    }
    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const content = e.target.result;
            if (file.name.endsWith('.csv')) {
                parseEInvoiceCSV(content);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                alert('‚ö†Ô∏è Excel dosyalarƒ± i√ßin l√ºtfen CSV formatƒ±na √ßevirip y√ºkleyin.\n\nExcel\'de: Dosya ‚Üí Farklƒ± Kaydet ‚Üí "CSV UTF-8 (Virg√ºlle ayrƒ±lmƒ±≈ü)" se√ßin.');
            } else {
                alert('‚ùå Desteklenmeyen dosya formatƒ±!\n\nDesteklenen: .csv');
            }
        } catch (error) {
            console.error('‚ùå Hata:', error);
            alert('‚ùå Dosya okunamadƒ±: ' + error.message);
        }
    };

    reader.onerror = function() {
        console.error('‚ùå FileReader hatasƒ±');
        alert('‚ùå Dosya okuma hatasƒ±!');
    };

    reader.readAsText(file, 'UTF-8');
}

// Dosya inputu resetlemek i√ßin (drag-drop veya tekrar y√ºklemede)
function resetInvoiceExcelInput() {
    const input = document.getElementById('invoiceExcelFile');
    if (input) input.value = '';
}

function parseEInvoiceCSV(content) {
    console.log('üìä E-Fatura CSV Parse ba≈ülƒ±yor...');

    // Satƒ±r sonlarƒ±nƒ± normalize et
    content = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);

    console.log('Toplam satƒ±r:', lines.length);
    console.log('ƒ∞lk satƒ±r (header):', lines[0]);

    // Delimiter algƒ±la
    let delimiter = ';';
    if (lines[0].includes(',')) delimiter = ',';

    // Header kontrol√º
    const header = lines[0].toLowerCase();
    if (!header.includes('fatura') || !header.includes('tutar')) {
        alert('‚ö†Ô∏è Bu dosya E-Fatura formatƒ±nda g√∂r√ºnm√ºyor!\n\nBeklenen s√ºtunlar: Alƒ±cƒ± Adƒ±, Fatura Numarasƒ±, Fatura Tarihi, Tutar');
        return;
    }

    parsedInvoices = [];

    // Satƒ±rlarƒ± parse et (Header'ƒ± atla)
    for (let i = 1; i < lines.length; i++) {
        const line = lines[i];
        const parts = line.split(delimiter);
        console.log(`Satƒ±r ${i}:`, parts);

        if (parts.length < 7) {
            console.log(`‚ö†Ô∏è Satƒ±r ${i} atlandƒ±: Yeterli s√ºtun yok (${parts.length})`);
            continue;
        }

        const aliciAdi = parts[0]?.trim() || '';
        const faturaNo = parts[1]?.trim() || '';
        const faturaTarihi = parts[2]?.trim() || '';
        const olusturmaTarihi = parts[3]?.trim() || '';
        const senaryo = parts[4]?.trim() || '';
        const durum = parts[5]?.trim() || '';
        const tutarStr = parts[6]?.trim() || '';

        // Tutar parse (T√ºrk√ße format: 10737,6)
        const tutar = parseTurkishNumber(tutarStr);

        if (!aliciAdi || !faturaNo || !faturaTarihi || tutar === 0) {
            console.log(`‚ö†Ô∏è Satƒ±r ${i} atlandƒ±: Eksik veri`);
            continue;
        }

        const standardDate = parseEInvoiceDate(faturaTarihi);

        if (!standardDate) {
            console.log(`‚ö†Ô∏è Satƒ±r ${i} atlandƒ±: Ge√ßersiz tarih formatƒ±`);
            continue;
        }

        // Cari hesap e≈üle≈ütirme
        const matchedAccount = findMatchingAccount(aliciAdi);

        parsedInvoices.push({
            aliciAdi: aliciAdi,
            faturaNo: faturaNo,
            faturaTarihi: standardDate,
            olusturmaTarihi: parseEInvoiceDate(olusturmaTarihi),
            senaryo: senaryo,
            durum: durum,
            tutar: tutar,
            matchedAccount: matchedAccount,
            confidence: matchedAccount ? calculateMatchConfidence(aliciAdi, matchedAccount) : 0
        });

        console.log(`‚úÖ Fatura ${i} parse edildi:`, parsedInvoices[parsedInvoices.length - 1]);
    }

    console.log(`\nüìä Toplam ${parsedInvoices.length} fatura ba≈üarƒ±yla okundu!`);

    if (parsedInvoices.length === 0) {
        alert('‚ùå Dosyada ge√ßerli fatura bulunamadƒ±!');
        return;
    }

    // E≈üle≈ütirme modal'ƒ±nƒ± a√ß
    closeImportInvoiceModal();
    showInvoiceMatchModal();
}

function parseEInvoiceDate(dateStr) {
    // Format: 30.09.2025 veya 19.09.2025
    const match = dateStr.match(/(\d{1,2})\.(\d{1,2})\.(\d{4})/);
    
    if (match) {
        const day = match[1].padStart(2, '0');
        const month = match[2].padStart(2, '0');
        const year = match[3];
        return `${year}-${month}-${day}`;
    }
    
    return null;
}

function findMatchingAccount(companyName) {
    const companyAccounts = accounts.filter(a => a.companyId === activeCompanyId);
    
    if (companyAccounts.length === 0) return null;

    // Arama i√ßin temizleme
    const cleanName = (name) => {
        return name.toUpperCase()
            .replace(/\s+/g, ' ') // √áoklu bo≈üluklarƒ± tek bo≈üluƒüa
            .replace(/\./g, '') // Noktalarƒ± kaldƒ±r
            .replace(/LTD\.?\s*≈ûTƒ∞\.?/gi, '')
            .replace(/Lƒ∞Mƒ∞TED\s*≈ûƒ∞RKETƒ∞/gi, '')
            .replace(/A\.?\s*≈û\.?/gi, '')
            .replace(/ANONƒ∞M\s*≈ûƒ∞RKETƒ∞/gi, '')
            .replace(/SANAYƒ∞/gi, '')
            .replace(/SANAYƒ∞ƒ∞/gi, '')
            .replace(/Tƒ∞CARET/gi, '')
            .replace(/VE/gi, '')
            .replace(/ƒ∞N≈ûAAT/gi, '')
            .replace(/PAZARLAMA/gi, '')
            .replace(/√úRETƒ∞M/gi, '')
            .replace(/√úNVAN\s*:/gi, '')
            .trim();
    };

    const searchName = cleanName(companyName);
    console.log('üîç Aranan firma (temizlenmi≈ü):', searchName);

    // 1. TAM E≈ûLE≈ûME
    for (let account of companyAccounts) {
        const accountName = cleanName(account.name);
        
        if (accountName === searchName) {
            console.log(`‚úÖ TAM E≈ûLE≈ûME (100%): "${companyName}" ‚Üí "${account.name}"`);
            return account;
        }
    }

    // 2. TAM ƒ∞√áERME (Biri diƒüerini tamamen i√ßeriyor)
    for (let account of companyAccounts) {
        const accountName = cleanName(account.name);
        
        if (accountName.includes(searchName) || searchName.includes(accountName)) {
            console.log(`‚úÖ TAM ƒ∞√áERME (95%): "${companyName}" ‚Üí "${account.name}"`);
            return account;
        }
    }

    // 3. ƒ∞LK KELƒ∞ME E≈ûLE≈ûME (Firma adƒ±nƒ±n ilk kelimesi benzersizse)
    const searchFirstWord = searchName.split(/\s+/)[0];
    if (searchFirstWord.length >= 4) {
        let matches = [];
        
        for (let account of companyAccounts) {
            const accountName = cleanName(account.name);
            const accountFirstWord = accountName.split(/\s+/)[0];
            
            if (searchFirstWord === accountFirstWord) {
                matches.push(account);
            }
        }
        
        // Eƒüer tek bir e≈üle≈üme varsa, g√ºvenli
        if (matches.length === 1) {
            console.log(`‚úÖ ƒ∞LK KELƒ∞ME E≈ûLE≈ûME (90%): "${companyName}" ‚Üí "${matches[0].name}"`);
            return matches[0];
        }
    }

    // 4. √áOK KELƒ∞MELƒ∞ E≈ûLE≈ûME (ƒ∞lk 3 kelimenin 2'si e≈üle≈ümeli)
    const searchWords = searchName.split(/\s+/).filter(w => w.length > 2).slice(0, 3);
    
    if (searchWords.length >= 2) {
        let bestMatch = null;
        let bestScore = 0;
        
        for (let account of companyAccounts) {
            const accountName = cleanName(account.name);
            let matchCount = 0;
            
            for (let word of searchWords) {
                if (accountName.includes(word)) {
                    matchCount++;
                }
            }
            
            const score = matchCount / searchWords.length;
            
            if (score >= 0.66 && score > bestScore) { // En az %66 e≈üle≈üme
                bestScore = score;
                bestMatch = account;
            }
        }
        
        if (bestMatch) {
            console.log(`‚úÖ √áOK KELƒ∞MELƒ∞ E≈ûLE≈ûME (${Math.round(bestScore * 100)}%): "${companyName}" ‚Üí "${bestMatch.name}"`);
            return bestMatch;
        }
    }

    // 5. FUZZY E≈ûLE≈ûME (En az 5 karakterlik kelimeler)
    const searchLongWords = searchName.split(/\s+/).filter(w => w.length >= 5);
    
    if (searchLongWords.length > 0) {
        for (let account of companyAccounts) {
            const accountName = cleanName(account.name);
            
            for (let word of searchLongWords) {
                if (accountName.includes(word)) {
                    console.log(`‚ö†Ô∏è FUZZY E≈ûLE≈ûME (70%): "${companyName}" ‚Üí "${account.name}" (Kelime: "${word}")`);
                    return account;
                }
            }
        }
    }

    console.log(`‚ùå E≈ûLE≈ûME YOK: "${companyName}"`);
    return null;
}

function calculateMatchConfidence(companyName, account) {
    const cleanName = (name) => {
        return name.toUpperCase()
            .replace(/\s+/g, ' ')
            .replace(/\./g, '')
            .replace(/LTD\.?\s*≈ûTƒ∞\.?/gi, '')
            .replace(/Lƒ∞Mƒ∞TED\s*≈ûƒ∞RKETƒ∞/gi, '')
            .replace(/A\.?\s*≈û\.?/gi, '')
            .replace(/ANONƒ∞M\s*≈ûƒ∞RKETƒ∞/gi, '')
            .replace(/SANAYƒ∞/gi, '')
            .replace(/Tƒ∞CARET/gi, '')
            .replace(/VE/gi, '')
            .trim();
    };

    const searchName = cleanName(companyName);
    const accountName = cleanName(account.name);
    
    // Tam e≈üle≈üme
    if (accountName === searchName) return 100;
    
    // Tam i√ßerme
    if (accountName.includes(searchName) || searchName.includes(accountName)) return 95;
    
    // ƒ∞lk kelime e≈üle≈ümesi
    const searchFirstWord = searchName.split(/\s+/)[0];
    const accountFirstWord = accountName.split(/\s+/)[0];
    if (searchFirstWord === accountFirstWord && searchFirstWord.length >= 4) return 90;
    
    // Kelime e≈üle≈üme oranƒ±
    const searchWords = searchName.split(/\s+/).filter(w => w.length > 2);
    let matchCount = 0;
    
    for (let word of searchWords) {
        if (accountName.includes(word)) {
            matchCount++;
        }
    }
    
    if (searchWords.length > 0) {
        return Math.round((matchCount / searchWords.length) * 85);
    }
    
    return 50; // Fuzzy e≈üle≈üme
}

function showInvoiceMatchModal() {
    const typeText = currentInvoiceType === 'sales' ? 'Giden (Satƒ±≈ü)' : 'Gelen (Alƒ±≈ü)';
    document.getElementById('invoiceMatchTitle').textContent = `üîÑ ${typeText} Fatura E≈üle≈ütirme`;
    
    // ‚úÖ E≈ûLE≈ûME ƒ∞STATƒ∞STƒ∞KLERƒ∞
    const totalCount = parsedInvoices.length;
    const matchedCount = parsedInvoices.filter(inv => inv.matchedAccount).length;
    const unmatchedCount = totalCount - matchedCount;
    const matchPercentage = Math.round((matchedCount / totalCount) * 100);

    document.getElementById('matchedInvoiceCount').textContent = totalCount;
    document.getElementById('saveInvoiceCount').textContent = totalCount;

    // √ñzet bilgiyi g√ºncelle
    const summaryHtml = `
        <strong>‚úÖ ${totalCount} fatura ba≈üarƒ±yla okundu!</strong><br>
        <div style="margin-top: 10px; display: flex; gap: 20px; font-size: 0.95em;">
            <span style="color: var(--success);">‚úÖ ${matchedCount} otomatik e≈üle≈üti (%${matchPercentage})</span>
            ${unmatchedCount > 0 ? `<span style="color: var(--warning);">‚ö†Ô∏è ${unmatchedCount} manuel se√ßim gerekli</span>` : ''}
        </div>
    `;
    document.getElementById('invoiceMatchSummary').innerHTML = summaryHtml;

    const matchList = document.getElementById('invoiceMatchList');
    matchList.innerHTML = '';

    parsedInvoices.forEach((invoice, index) => {
        // ‚úÖ OTOMATIK VADE TARƒ∞Hƒ∞ HESAPLA (Fatura tarihinden 7 g√ºn sonra)
        const invoiceDate = new Date(invoice.faturaTarihi);
        const dueDate = new Date(invoiceDate);
        dueDate.setDate(dueDate.getDate() + 7);
        const dueDateStr = dueDate.toISOString().split('T')[0]; // YYYY-MM-DD format

        const card = document.createElement('div');
        card.style.cssText = `
            border: 2px solid ${invoice.matchedAccount ? '#10b981' : '#f59e0b'};
            background: ${invoice.matchedAccount ? 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)' : 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)'};
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
        `;

        const confidenceBadge = invoice.matchedAccount 
            ? `<span class="badge badge-${invoice.confidence >= 90 ? 'success' : invoice.confidence >= 70 ? 'warning' : 'danger'}" style="font-size: 0.9em;">
                ${invoice.confidence}% E≈üle≈üme
               </span>`
            : '<span class="badge badge-danger" style="font-size: 0.9em;">Manuel Se√ßim Gerekli</span>';

        card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <strong style="font-size: 1.2em; color: var(--primary);">${invoice.faturaNo}</strong>
                        <span class="badge badge-info">${invoice.durum}</span>
                        ${confidenceBadge}
                    </div>
                    <div style="font-size: 0.95em; color: #1f2937; margin-bottom: 5px;">
                        <strong>üìÖ Fatura Tarihi:</strong> ${formatDate(invoice.faturaTarihi)}
                        <span style="margin-left: 15px; color: var(--warning);"><strong>‚è∞ Vade:</strong> ${formatDate(dueDateStr)}</span>
                    </div>
                    <div style="font-size: 0.95em; color: #1f2937; margin-bottom: 5px;">
                        <strong>üè¢ Firma (E-Fatura):</strong> ${invoice.aliciAdi}
                    </div>
                    ${invoice.matchedAccount ? `
                        <div style="font-size: 0.9em; color: var(--success); margin-top: 8px; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;">
                            ‚úÖ <strong>Otomatik E≈üle≈üti:</strong> ${invoice.matchedAccount.name}
                        </div>
                    ` : `
                        <div style="font-size: 0.9em; color: var(--danger); margin-top: 8px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px;">
                            ‚ö†Ô∏è Cari hesap bulunamadƒ± - L√ºtfen manuel se√ßin
                        </div>
                    `}
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 2em; font-weight: 700; color: ${currentInvoiceType === 'sales' ? 'var(--success)' : 'var(--danger)'}; margin-bottom: 5px;">
                        ${formatCurrency(invoice.tutar)}
                    </div>
                    <div style="font-size: 0.85em; color: #6b7280;">KDV Dahil</div>
                </div>
            </div>

            <div class="grid-2" style="margin-top: 15px;">
                <div class="form-group" style="margin: 0;">
                    <label>Cari Hesap ${invoice.matchedAccount ? '(‚úÖ Otomatik E≈üle≈üti)' : '(‚ö†Ô∏è Manuel Se√ßin)'}</label>
                    <select id="invoiceAccount_${index}" style="font-weight: ${invoice.matchedAccount ? '600' : 'normal'}; background: white; border-color: ${invoice.matchedAccount ? 'var(--success)' : 'var(--danger)'};">
                        <option value="">Cari Hesap Se√ßin</option>
                        ${accounts.filter(a => a.companyId === activeCompanyId).map(a => 
                            `<option value="${a.id}" ${invoice.matchedAccount && invoice.matchedAccount.id === a.id ? 'selected' : ''}>
                                ${a.name} (${a.type === 'customer' ? 'M√º≈üteri' : 'Tedarik√ßi'})
                            </option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group" style="margin: 0;">
                    <label>‚è∞ Vade Tarihi (Otomatik: +7 g√ºn)</label>
                    <input type="date" id="invoiceDueDate_${index}" value="${dueDateStr}" style="background: white;">
                </div>
            </div>

            <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
                <label>A√ßƒ±klama/Notlar (Opsiyonel)</label>
                <textarea id="invoiceDescription_${index}" rows="2" placeholder="Fatura ile ilgili notlar..." style="background: white;"></textarea>
            </div>
        `;

        matchList.appendChild(card);
    });

    document.getElementById('invoiceMatchModal').classList.add('active');
}

function closeInvoiceMatchModal() {
    document.getElementById('invoiceMatchModal').classList.remove('active');
    parsedInvoices = [];
}

function saveAllInvoices() {
    if (!activeCompanyId) {
        alert('‚ö†Ô∏è L√ºtfen √∂nce bir firma se√ßin!');
        return;
    }

    let savedCount = 0;
    let skippedCount = 0;

    parsedInvoices.forEach((invoice, index) => {
        const accountId = document.getElementById(`invoiceAccount_${index}`).value;
        const dueDate = document.getElementById(`invoiceDueDate_${index}`).value;
        const description = document.getElementById(`invoiceDescription_${index}`).value;

        if (!accountId) {
            console.log(`‚ö†Ô∏è Fatura ${invoice.faturaNo} atlandƒ±: Cari hesap se√ßilmedi`);
            skippedCount++;
            return;
        }

        // KDV hesaplama (Tutar KDV dahil, %20 KDV varsayƒ±mƒ±)
        const totalWithVAT = invoice.tutar;
        const subtotal = totalWithVAT / 1.20; // KDV hari√ß tutar
        const vatAmount = totalWithVAT - subtotal; // KDV tutarƒ±

        // Fatura olu≈ütur
        const newInvoice = {
            id: Date.now().toString() + '_' + index + '_' + Math.random(),
            companyId: activeCompanyId,
            type: currentInvoiceType, // 'sales' veya 'purchase'
            invoiceNo: invoice.faturaNo,
            date: invoice.faturaTarihi,
            dueDate: dueDate || null,
            accountId: accountId,
            description: description || `E-Fatura Import - ${invoice.durum}`,
            items: [
                {
                    id: Date.now() + Math.random(),
                    description: `${invoice.aliciAdi} - ${invoice.senaryo}`,
                    quantity: 1,
                    unitPrice: subtotal,
                    vatRate: 20,
                    amount: subtotal,
                    vatAmount: vatAmount
                }
            ],
            subtotal: subtotal,
            vatAmount: vatAmount,
            total: totalWithVAT,
            paidAmount: 0,
            status: 'unpaid',
            source: 'e-fatura-import',
            createdAt: new Date().toISOString(),
            createdBy: currentUser
        };

        invoices.push(newInvoice);

        // Cari hesap bakiyesini g√ºncelle
        const account = accounts.find(a => a.id === accountId);
        if (account) {
            if (currentInvoiceType === 'sales') {
                account.balance += totalWithVAT; // Satƒ±≈ü ‚Üí Bor√ß artƒ±≈üƒ±
            } else {
                account.balance -= totalWithVAT; // Alƒ±≈ü ‚Üí Alacak artƒ±≈üƒ±
            }
        }

        savedCount++;
        console.log(`‚úÖ Fatura kaydedildi: ${invoice.faturaNo}`);
    });

    // LocalStorage'a kaydet
    localStorage.setItem('invoices', JSON.stringify(invoices));
    localStorage.setItem('accounts', JSON.stringify(accounts));

    // Modal'larƒ± kapat
    closeInvoiceMatchModal();

    // Verileri yenile
    loadInvoices();
    loadAccounts();
    updateDashboard();

    // Bilgilendirme
    const message = `‚úÖ ${savedCount} fatura ba≈üarƒ±yla kaydedildi!${skippedCount > 0 ? `\n‚ö†Ô∏è ${skippedCount} fatura atlandƒ± (cari hesap se√ßilmedi)` : ''}`;
    alert(message);
}

function scrollToInvoiceForm() {
    document.getElementById('invoiceFormCard').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
    });
    
    // Formu vurgula (1 saniye)
    const formCard = document.getElementById('invoiceFormCard');
    const originalBorder = formCard.style.border;
    formCard.style.border = '3px solid var(--primary)';
    formCard.style.boxShadow = '0 0 20px rgba(37, 99, 235, 0.4)';
    
    setTimeout(() => {
        formCard.style.border = originalBorder;
        formCard.style.boxShadow = '';
    }, 1500);
}

// ========================================
// PURCHASES (ALI≈ûLAR) FONKSƒ∞YONLARI
// ========================================

let purchases = JSON.parse(localStorage.getItem('purchases')) || [];
let currentPurchaseReceipt = null;

function calculatePurchaseTotal() {
    const amount = parseFloat(document.getElementById('purchaseAmount').value) || 0;
    const vatRate = parseFloat(document.getElementById('purchaseVATRate').value) || 0;
    
    const vatAmount = amount * (vatRate / 100);
    const total = amount + vatAmount;
    
    document.getElementById('purchaseVATAmount').value = vatAmount.toFixed(2);
    document.getElementById('purchaseTotalDisplay').textContent = formatCurrency(total);
}

function handlePurchaseReceipt(input) {
    const file = input.files[0];
    if (!file) {
        currentPurchaseReceipt = null;
        document.getElementById('purchaseReceiptPreview').innerHTML = '';
        return;
    }
    
    // Boyut kontrol√º (5 MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('‚ö†Ô∏è Fi≈ü boyutu 5 MB\'dan k√º√ß√ºk olmalƒ±dƒ±r!');
        input.value = '';
        return;
    }
    
    // ‚úÖ Artƒ±k dosyayƒ± direkt saklƒ±yoruz (Base64'e √ßevirmeye gerek yok)
    currentPurchaseReceipt = file;
    
    // √ñnizleme
    const preview = document.getElementById('purchaseReceiptPreview');
    
    if (file.type.includes('image')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <div style="border: 2px solid var(--success); padding: 10px; border-radius: 8px; background: white;">
                    <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        üìÑ ${file.name} (${formatFileSize(file.size)})
                    </p>
                    <button type="button" onclick="clearPurchaseReceipt()" class="btn btn-danger btn-sm" style="margin-top:5px;">‚úñ Kaldƒ±r</button>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = `
            <div style="border: 2px solid var(--success); padding: 15px; border-radius: 8px; background: white; text-align:center;">
                <div style="font-size: 3em;">üìÑ</div>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                    ${file.name} (${formatFileSize(file.size)})
                </p>
                <button type="button" onclick="clearPurchaseReceipt()" class="btn btn-danger btn-sm" style="margin-top:5px;">‚úñ Kaldƒ±r</button>
            </div>
        `;
    }
}

function clearPurchaseReceipt() {
    currentPurchaseReceipt = null;
    document.getElementById('purchaseReceipt').value = '';
    document.getElementById('purchaseReceiptPreview').innerHTML = '';
}

async function savePurchase(e) {
    e.preventDefault();
    
    if (!activeCompanyId) {
        alert('‚ö†Ô∏è L√ºtfen √∂nce bir firma se√ßin!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('‚ö†Ô∏è L√ºtfen √∂nce giri≈ü yapƒ±n!');
        return;
    }
    
    const purchaseId = document.getElementById('purchaseId').value;
    const now = new Date().toISOString();
    
    const amount = parseFloat(document.getElementById('purchaseAmount').value);
    const vatRate = parseFloat(document.getElementById('purchaseVATRate').value);
    const vatAmount = amount * (vatRate / 100);
    const total = amount + vatAmount;
    
    try {
        let receiptUrl = null;
        
        // ‚úÖ Eƒüer yeni fi≈ü y√ºklendiyse Storage'a y√ºkle
        if (currentPurchaseReceipt && currentPurchaseReceipt instanceof File) {
            const tempId = purchaseId || Date.now().toString();
            const fileName = `${Date.now()}_${currentPurchaseReceipt.name}`;
            const storageRef = storage.ref(`companies/${activeCompanyId}/purchases/${tempId}/${fileName}`);
            
            const snapshot = await storageRef.put(currentPurchaseReceipt);
            receiptUrl = await snapshot.ref.getDownloadURL();
            
            console.log('‚úÖ Fi≈ü y√ºklendi:', receiptUrl);
        }
        
        if (purchaseId) {
            // Update existing
            const purchase = purchases.find(p => p.id === purchaseId);
            purchase.date = document.getElementById('purchaseDate').value;
            purchase.category = document.getElementById('purchaseCategory').value;
            purchase.description = document.getElementById('purchaseDescription').value;
            purchase.supplier = document.getElementById('purchaseSupplier').value;
            purchase.amount = amount;
            purchase.vatRate = vatRate;
            purchase.vatAmount = vatAmount;
            purchase.total = total;
            purchase.paymentMethod = document.getElementById('purchasePaymentMethod').value;
            purchase.receiptUrl = receiptUrl || purchase.receiptUrl; // ‚úÖ URL ekle/g√ºncelle
            purchase.receipt = null; // ‚úÖ Eski Base64'√º temizle
            purchase.updatedAt = now;
        } else {
            // Create new
            const purchase = {
                id: Date.now().toString(),
                companyId: activeCompanyId,
                date: document.getElementById('purchaseDate').value,
                category: document.getElementById('purchaseCategory').value,
                description: document.getElementById('purchaseDescription').value,
                supplier: document.getElementById('purchaseSupplier').value || '',
                amount: amount,
                vatRate: vatRate,
                vatAmount: vatAmount,
                total: total,
                paymentMethod: document.getElementById('purchasePaymentMethod').value,
                receiptUrl: receiptUrl, // ‚úÖ URL ekle
                receipt: null, // ‚úÖ Base64 artƒ±k yok
                createdAt: now,
                createdBy: auth.currentUser.uid
            };
            
            purchases.push(purchase);
        }
        
        // ‚úÖ Firestore'a da kaydet
        const purchaseToSave = purchases.find(p => p.id === (purchaseId || purchases[purchases.length - 1].id));
        await db.collection('companies').doc(activeCompanyId)
            .collection('purchases').doc(purchaseToSave.id).set(purchaseToSave);
        
        localStorage.setItem('purchases', JSON.stringify(purchases));
        
        document.getElementById('purchaseForm').reset();
        document.getElementById('purchaseId').value = '';
        document.getElementById('purchaseDate').valueAsDate = new Date();
        currentPurchaseReceipt = null;
        document.getElementById('purchaseReceiptPreview').innerHTML = '';
        cancelPurchaseEdit();
        loadPurchases();
        updateDashboard();
        
        alert('‚úÖ Alƒ±≈ü ba≈üarƒ±yla kaydedildi!');
        
    } catch (error) {
        console.error('Kayƒ±t hatasƒ±:', error);
        alert('‚ùå Hata: ' + error.message);
    }
}

async function loadPurchases() {
    if (!activeCompanyId || !auth.currentUser) {
        purchases = [];
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('purchases').orderBy('date', 'desc').get();
        
        purchases = [];
        snapshot.forEach(doc => {
            purchases.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('‚úÖ Alƒ±≈ülar y√ºklendi:', purchases.length);
        
    } catch (error) {
        console.error('‚ùå Alƒ±≈ü y√ºkleme hatasƒ±:', error);
        purchases = [];
    }
    
    renderPurchasesTable();
}

function updatePurchaseStats(purchaseList) {
    const totalAmount = purchaseList.reduce((sum, p) => sum + p.total, 0);
    const subtotal = purchaseList.reduce((sum, p) => sum + p.amount, 0);
    const totalVAT = purchaseList.reduce((sum, p) => sum + p.vatAmount, 0);
    const average = purchaseList.length > 0 ? totalAmount / purchaseList.length : 0;
    
    document.getElementById('purchasesTotalAmount').textContent = formatCurrency(totalAmount);
    document.getElementById('purchasesCount').textContent = `${purchaseList.length} kayƒ±t`;
    document.getElementById('purchasesSubtotal').textContent = formatCurrency(subtotal);
    document.getElementById('purchasesTotalVAT').textContent = formatCurrency(totalVAT);
    document.getElementById('purchasesAverage').textContent = formatCurrency(average);
}

function editPurchase(id) {
    const purchase = purchases.find(p => p.id === id);
    if (!purchase) return;
    
    document.getElementById('purchaseId').value = purchase.id;
    document.getElementById('purchaseDate').value = purchase.date;
    document.getElementById('purchaseCategory').value = purchase.category;
    document.getElementById('purchaseDescription').value = purchase.description;
    document.getElementById('purchaseSupplier').value = purchase.supplier || '';
    document.getElementById('purchaseAmount').value = purchase.amount;
    document.getElementById('purchaseVATRate').value = purchase.vatRate;
    document.getElementById('purchasePaymentMethod').value = purchase.paymentMethod;
    
    // ‚úÖ Mevcut fi≈üi g√∂ster (URL veya Base64)
    const preview = document.getElementById('purchaseReceiptPreview');
    
    if (purchase.receiptUrl) {
        // Yeni sistem: Firebase Storage URL
        const isPDF = purchase.receiptUrl.toLowerCase().includes('.pdf');
        
        if (isPDF) {
            preview.innerHTML = `
                <div style="border: 2px solid var(--info); padding: 15px; border-radius: 8px; background: white; text-align:center;">
                    <div style="font-size: 3em;">üìÑ</div>
                    <p style="margin: 10px 0; font-size: 0.9em; color: #6b7280;">Mevcut PDF Fi≈ü</p>
                    <button type="button" onclick="viewPurchaseReceipt('${purchase.id}')" class="btn btn-sm">üëÅÔ∏è G√∂r√ºnt√ºle</button>
                    <p style="margin-top:10px; font-size:0.85em; color:#6b7280;">Yeni fi≈ü y√ºklerseniz eski fi≈ü silinir.</p>
                </div>
            `;
        } else {
            preview.innerHTML = `
                <div style="border: 2px solid var(--info); padding: 10px; border-radius: 8px; background: white;">
                    <img src="${purchase.receiptUrl}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">Mevcut Fi≈ü</p>
                    <p style="margin-top:5px; font-size:0.85em; color:#6b7280;">Yeni fi≈ü y√ºklerseniz eski fi≈ü silinir.</p>
                </div>
            `;
        }
        
        // Not: Eski fi≈üi sakla (deƒüi≈ütirmezse aynƒ± kalacak)
        currentPurchaseReceipt = null;
        
    } else if (purchase.receipt && purchase.receipt.file) {
        // Eski sistem: Base64
        if (purchase.receipt.fileType.includes('image')) {
            preview.innerHTML = `
                <div style="border: 2px solid var(--warning); padding: 10px; border-radius: 8px; background: white;">
                    <img src="${purchase.receipt.file}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        üìÑ ${purchase.receipt.fileName} (${formatFileSize(purchase.receipt.fileSize)})
                    </p>
                    <p style="margin-top:5px; font-size:0.85em; color:#f59e0b;">‚ö†Ô∏è Eski format (Base64)</p>
                </div>
            `;
        }
        currentPurchaseReceipt = null;
    } else {
        preview.innerHTML = '<p style="color:#6b7280;">Fi≈ü yok</p>';
        currentPurchaseReceipt = null;
    }
    
    calculatePurchaseTotal();
    
    document.getElementById('savePurchaseBtn').textContent = 'üíæ G√ºncelle';
    document.getElementById('cancelPurchaseBtn').style.display = 'inline-block';
    
    scrollToPurchaseForm();
}

function deletePurchase(id) {
    if (!confirm('Bu alƒ±≈ü kaydƒ±nƒ± silmek istediƒüinizden emin misiniz?')) return;
    
    purchases = purchases.filter(p => p.id !== id);
    localStorage.setItem('purchases', JSON.stringify(purchases));
    
    loadPurchases();
    updateDashboard();
    
    alert('‚úÖ Alƒ±≈ü kaydƒ± silindi!');
}

function cancelPurchaseEdit() {
    document.getElementById('purchaseForm').reset();
    document.getElementById('purchaseId').value = '';
    document.getElementById('purchaseDate').valueAsDate = new Date();
    document.getElementById('savePurchaseBtn').textContent = 'üíæ Alƒ±≈üƒ± Kaydet';
    document.getElementById('cancelPurchaseBtn').style.display = 'none';
    currentPurchaseReceipt = null;
    document.getElementById('purchaseReceiptPreview').innerHTML = '';
    calculatePurchaseTotal();
}

function scrollToPurchaseForm() {
    document.getElementById('purchaseFormCard').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
    });
    
    const formCard = document.getElementById('purchaseFormCard');
    const originalBorder = formCard.style.border;
    formCard.style.border = '3px solid var(--primary)';
    formCard.style.boxShadow = '0 0 20px rgba(37, 99, 235, 0.4)';
    
    setTimeout(() => {
        formCard.style.border = originalBorder;
        formCard.style.boxShadow = '';
    }, 1500);
}

function filterPurchases() {
    const startDate = document.getElementById('filterPurchaseStartDate').value;
    const endDate = document.getElementById('filterPurchaseEndDate').value;
    const category = document.getElementById('filterPurchaseCategory').value;
    const paymentMethod = document.getElementById('filterPurchasePayment').value;
    
    let filtered = purchases.filter(p => !activeCompanyId || p.companyId === activeCompanyId);
    
    if (startDate) filtered = filtered.filter(p => p.date >= startDate);
    if (endDate) filtered = filtered.filter(p => p.date <= endDate);
    if (category) filtered = filtered.filter(p => p.category === category);
    if (paymentMethod) filtered = filtered.filter(p => p.paymentMethod === paymentMethod);
    
    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const tbody = document.querySelector('#purchasesTable tbody');
    tbody.innerHTML = '';
    
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center; padding:20px;">Sonu√ß bulunamadƒ±.</td></tr>';
        updatePurchaseStats([]);
        return;
    }
    
    filtered.forEach(purchase => {
        const paymentMethodText = {
            'cash': 'üíµ Nakit',
            'card': 'üí≥ Kart',
            'transfer': 'üè¶ Havale'
        }[purchase.paymentMethod] || purchase.paymentMethod;
        
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${formatDate(purchase.date)}</td>
            <td><span class="badge badge-info">${purchase.category}</span></td>
            <td><strong>${purchase.description}</strong></td>
            <td>${purchase.supplier || '-'}</td>
            <td>${formatCurrency(purchase.amount)}</td>
            <td>${formatCurrency(purchase.vatAmount)} <small>(%${purchase.vatRate})</small></td>
            <td style="font-weight: 700; color: var(--danger);">${formatCurrency(purchase.total)}</td>
            <td>${paymentMethodText}</td>
            <td>
                ${purchase.receipt ? `
                    <button class="btn btn-info btn-sm" onclick="viewPurchaseReceipt('${purchase.id}')">üìÑ</button>
                ` : '<span style="color:#6b7280;">-</span>'}
            </td>
            <td>
                <button class="btn btn-warning btn-sm" onclick="editPurchase('${purchase.id}')">‚úèÔ∏è</button>
                <button class="btn btn-danger btn-sm" onclick="deletePurchase('${purchase.id}')">üóëÔ∏è</button>
            </td>
        `;
    });
    
    updatePurchaseStats(filtered);
}

function clearPurchaseFilters() {
    document.getElementById('filterPurchaseStartDate').value = '';
    document.getElementById('filterPurchaseEndDate').value = '';
    document.getElementById('filterPurchaseCategory').value = '';
    document.getElementById('filterPurchasePayment').value = '';
    loadPurchases();
}

function viewPurchaseReceipt(id) {
    const purchase = purchases.find(p => p.id === id);
    
    if (!purchase) {
        alert('‚ö†Ô∏è Alƒ±≈ü kaydƒ± bulunamadƒ±!');
        return;
    }
    
    // ‚úÖ √ñnce yeni sistem (receiptUrl), yoksa eski sistem (receipt.file)
    let receiptSource = null;
    let isPDF = false;
    
    if (purchase.receiptUrl) {
        // Yeni sistem: Firebase Storage URL
        receiptSource = purchase.receiptUrl;
        isPDF = purchase.receiptUrl.toLowerCase().includes('.pdf');
    } else if (purchase.receipt && purchase.receipt.file) {
        // Eski sistem: Base64
        receiptSource = purchase.receipt.file;
        isPDF = purchase.receipt.fileType && purchase.receipt.fileType.includes('pdf');
    } else {
        alert('‚ö†Ô∏è Bu alƒ±≈üa ait fi≈ü yok!');
        return;
    }
    
    document.getElementById('documentViewerTitle').textContent = `üìÑ Fi≈ü - ${purchase.description}`;
    
    const content = document.getElementById('documentViewerContent');
    content.innerHTML = '';
    
    if (isPDF) {
        const iframe = document.createElement('iframe');
        iframe.src = receiptSource;
        iframe.style.width = '100%';
        iframe.style.height = '600px';
        iframe.style.border = 'none';
        iframe.style.borderRadius = '8px';
        content.appendChild(iframe);
    } else {
        const img = document.createElement('img');
        img.src = receiptSource;
        img.style.maxWidth = '100%';
        img.style.borderRadius = '8px';
        img.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        content.appendChild(img);
        
        // ƒ∞ndirme butonu ekle
        const downloadBtn = document.createElement('a');
        downloadBtn.href = receiptSource;
        downloadBtn.download = `fis_${purchase.id}.jpg`;
        downloadBtn.target = '_blank';
        downloadBtn.className = 'btn btn-primary';
        downloadBtn.style.marginTop = '20px';
        downloadBtn.innerHTML = 'üì• ƒ∞ndir';
        content.appendChild(downloadBtn);
    }
    
    currentDocumentData = { file: receiptSource, fileName: purchase.description };
    document.getElementById('documentViewerModal').classList.add('active');
}

// ========================================
// ALI≈û EXCEL ƒ∞MPORT FONKSƒ∞YONLARI
// ========================================

// ========================================
// ALI≈û EXCEL ƒ∞MPORT Sƒ∞STEMƒ∞
// ========================================

function openImportPurchasesModal() {
    if (!activeCompanyId) {
        alert('‚ö†Ô∏è L√ºtfen √∂nce bir firma se√ßin!');
        return;
    }
    
    const modalHtml = `
        <div class="modal active" id="purchasesImportModal" style="display: flex;">
            <div class="modal-content" style="max-width: 900px;">
                <div class="modal-header">
                    <h3>üì§ Alƒ±≈ü Listesi ƒ∞√ße Aktar (Excel/CSV)</h3>
                    <button class="close-modal" onclick="closePurchasesImportModal()">‚úñ</button>
                </div>
                
                <div style="padding: 30px;">
                    <!-- √ñrnek Format -->
                    <div class="alert alert-info">
                        <strong>üìã Excel/CSV Formatƒ±</strong>
                        <p style="margin: 10px 0 5px 0; font-size: 0.95em;">
                            A≈üaƒüƒ±daki s√ºtun sƒ±rasƒ±nƒ± kullanƒ±n (ba≈ülƒ±k satƒ±rƒ± olmalƒ±):
                        </p>
                    </div>
                    
                    <div style="overflow-x: auto; margin-bottom: 20px;">
                        <table style="font-size: 0.85em; width: 100%; border: 2px solid var(--primary);">
                            <thead style="background: var(--primary); color: white;">
                                <tr>
                                    <th>Tarih</th>
                                    <th>Kategori</th>
                                    <th>A√ßƒ±klama</th>
                                    <th>Tedarik√ßi</th>
                                    <th>Tutar</th>
                                    <th>KDV%</th>
                                    <th>√ñdeme</th>
                                </tr>
                            </thead>
                            <tbody style="background: white;">
                                <tr>
                                    <td>2025-01-15</td>
                                    <td>Kƒ±rtasiye</td>
                                    <td>A4 Kaƒüƒ±t</td>
                                    <td>Migros</td>
                                    <td>250.00</td>
                                    <td>20</td>
                                    <td>Nakit</td>
                                </tr>
                                <tr>
                                    <td>2025-01-16</td>
                                    <td>Yakƒ±t</td>
                                    <td>Motorin 50L</td>
                                    <td>Shell</td>
                                    <td>1850.50</td>
                                    <td>20</td>
                                    <td>Kart</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Kategoriler Rehberi -->
                    <div class="card" style="background: #f9fafb; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">üè∑Ô∏è Kullanƒ±labilir Kategoriler</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; font-size: 0.9em;">
                            <div>üìé Kƒ±rtasiye</div>
                            <div>‚õΩ Yakƒ±t</div>
                            <div>üçΩÔ∏è Yemek</div>
                            <div>üßπ Temizlik</div>
                            <div>üì¶ Kargo</div>
                            <div>üí° Elektrik</div>
                            <div>üíß Su</div>
                            <div>üåê ƒ∞nternet</div>
                            <div>üì± Telefon</div>
                            <div>üîß Bakƒ±m-Onarƒ±m</div>
                            <div>üöó Ula≈üƒ±m</div>
                            <div>üìã Diƒüer</div>
                        </div>
                    </div>

                    <!-- √ñdeme Y√∂ntemleri -->
                    <div class="card" style="background: #f9fafb; margin-bottom: 20px;">
                        <h4 style="color: var(--primary); margin-bottom: 10px;">üí≥ √ñdeme Y√∂ntemleri</h4>
                        <div style="display: flex; gap: 20px; font-size: 0.9em;">
                            <div>üíµ <strong>Nakit</strong></div>
                            <div>üí≥ <strong>Kart</strong></div>
                            <div>üè¶ <strong>Havale</strong></div>
                        </div>
                    </div>

                    <!-- Dosya Y√ºkleme -->
                    <div class="file-upload-area" 
                         onclick="document.getElementById('purchasesExcelFile').click()" 
                         style="cursor: pointer; margin-bottom: 20px;">
                        <h3>üìÇ CSV/Excel Dosyasƒ±nƒ± Y√ºkle</h3>
                        <p style="margin: 10px 0; color: #6b7280;">Dosyanƒ±zƒ± s√ºr√ºkleyin veya tƒ±klayƒ±n</p>
                        <p style="font-size: 0.9em; color: #9ca3af;">Desteklenen format: .csv</p>
                        <input type="file" 
                               id="purchasesExcelFile" 
                               accept=".csv" 
                               style="display:none;" 
                               onchange="processPurchasesExcel(event)">
                    </div>

                    <!-- √ñrnek Dosya ƒ∞ndir -->
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="downloadPurchaseTemplate()">
                            üì• √ñrnek CSV ≈ûablonunu ƒ∞ndir
                        </button>
                        <button class="btn btn-secondary" onclick="closePurchasesImportModal()">
                            ‚úñÔ∏è ƒ∞ptal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Modal'ƒ± sayfaya ekle
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closePurchasesImportModal() {
    const modal = document.getElementById('purchasesImportModal');
    if (modal) {
        modal.remove();
    }
}

function downloadPurchaseTemplate() {
    const csv = `Tarih,Kategori,A√ßƒ±klama,Tedarik√ßi,Tutar,KDV%,√ñdeme
2025-01-15,Kƒ±rtasiye,A4 Kaƒüƒ±t 5 paket,Migros,250.00,20,Nakit
2025-01-16,Yakƒ±t,Motorin 50L,Shell,1850.50,20,Kart
2025-01-17,Yemek,Personel yemeƒüi,Yemek Sepeti,450.00,10,Kart
2025-01-18,Elektrik,Ocak faturasƒ±,BEDA≈û,980.00,20,Havale
2025-01-19,Temizlik,Temizlik malzemesi,Bƒ∞M,125.75,20,Nakit
2025-01-20,Kargo,Kargo √∂demesi,MNG,85.00,20,Kart`;
    
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `alislar-sablonu-${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
    URL.revokeObjectURL(url);
    
    alert('‚úÖ √ñrnek CSV ≈üablonu indirildi!\n\nDosyayƒ± a√ßƒ±p d√ºzenleyebilir, ardƒ±ndan tekrar y√ºkleyebilirsiniz.');
}

function processPurchasesExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    console.log('üìÇ Alƒ±≈ülar CSV dosyasƒ± y√ºkleniyor:', file.name);
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            console.log('‚úÖ Dosya okundu');
            
            parsePurchasesCSV(content);
        } catch (error) {
            console.error('‚ùå Hata:', error);
            alert('‚ùå Dosya okunamadƒ±: ' + error.message);
        }
    };

    reader.onerror = function() {
        console.error('‚ùå FileReader hatasƒ±');
        alert('‚ùå Dosya okuma hatasƒ±!');
    };

    reader.readAsText(file, 'UTF-8');
}

function parsePurchasesCSV(content) {
    const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);

    // Noktalƒ± virg√ºl veya virg√ºl ayra√ß desteƒüi!
    // Otomatik algƒ±la: ilk satƒ±rda ";" varsa split(";"), yoksa split(",")
    const delimiter = lines[0].includes(';') ? ';' : ',';

    // Ba≈ülƒ±k kontrol√º (dilersen delimiter ile split ederek de kontrol edebilirsin)
    const header = lines[0].toLowerCase();
    if (!header.includes('tarih') || !header.includes('kategori') || !header.includes('a√ßƒ±klama')) {
        alert('‚ö†Ô∏è CSV ba≈ülƒ±k satƒ±rƒ± hatalƒ±!');
        return;
    }

    let importedPurchases = [];
    let errorCount = 0;

    for (let i = 1; i < lines.length; i++) {
        // Satƒ±rƒ± s√ºtunlara b√∂l
        const parts = lines[i].split(delimiter);
        if (parts.length < 7) { // S√ºtun sayƒ±sƒ± kontrol√º
            errorCount++;
            continue;
        }

        // S√ºtunlar: Tarih;Kategori;A√ßƒ±klama;Tedarik√ßi;Tutar;KDV%;√ñdeme
        const tarih = parts[0].trim();
        const kategori = parts[1].trim();
        const aciklama = parts[2].trim();
        const tedarikci = parts[3].trim();
        const tutar = parseFloat(parts[4].replace(',', '.'));
        const kdvOrani = parseFloat(parts[5].replace(',', '.'));
        const odeme = parts[6].trim();

        // Validasyon
        if (!tarih || !kategori || !aciklama || isNaN(tutar) || isNaN(kdvOrani)) {
            errorCount++;
            continue;
        }

        // KDV ve toplam otomatik hesaplanƒ±r
        const kdvTutari = tutar * (kdvOrani / 100);
        const toplamTutar = tutar + kdvTutari;

        // √ñdeme t√ºr√º
        let paymentMethod = 'cash';
        const odemeUpper = odeme.toUpperCase();
        if (odemeUpper.includes('KART')) paymentMethod = 'card';
        else if (odemeUpper.includes('HAVALE') || odemeUpper.includes('EFT') || odemeUpper.includes('TRANSFER')) paymentMethod = 'transfer';

        importedPurchases.push({
            date: tarih,
            category: kategori,
            description: aciklama,
            supplier: tedarikci,
            amount: tutar,
            vatRate: kdvOrani,
            vatAmount: kdvTutari,
            total: toplamTutar,
            paymentMethod: paymentMethod
        });
    }

    showPurchasesConfirmModal(importedPurchases, errorCount);
}

function showPurchasesConfirmModal(importedPurchases, errorCount) {
    closePurchasesImportModal();
    
    const totalAmount = importedPurchases.reduce((sum, p) => sum + p.total, 0);
    const totalVAT = importedPurchases.reduce((sum, p) => sum + p.vatAmount, 0);
    
    const summaryHtml = errorCount > 0 
        ? `<div class="alert alert-warning">
            <strong>‚ö†Ô∏è ${errorCount} satƒ±r hatalƒ± olduƒüu i√ßin atlandƒ±!</strong>
           </div>`
        : '';
    
    const modalHtml = `
        <div class="modal active" id="purchasesConfirmModal" style="display: flex;">
            <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
                <div class="modal-header">
                    <h3>‚úÖ Alƒ±≈ülarƒ± Onaylayƒ±n (${importedPurchases.length} Kayƒ±t)</h3>
                    <button class="close-modal" onclick="closePurchasesConfirmModal()">‚úñ</button>
                </div>
                
                <div style="padding: 20px;">
                    ${summaryHtml}
                    
                    <div class="alert alert-success">
                        <strong>üìä √ñzet ƒ∞statistikler</strong>
                        <div style="margin-top: 10px; display: flex; gap: 30px; font-size: 1.1em;">
                            <span>üí∞ Toplam Harcama: <strong>${formatCurrency(totalAmount)}</strong></span>
                            <span>üìã KDV Toplamƒ±: <strong>${formatCurrency(totalVAT)}</strong></span>
                            <span>üìù Kayƒ±t Sayƒ±sƒ±: <strong>${importedPurchases.length}</strong></span>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Kategori</th>
                                    <th>A√ßƒ±klama</th>
                                    <th>Tedarik√ßi</th>
                                    <th>KDV Hari√ß</th>
                                    <th>KDV</th>
                                    <th>Toplam</th>
                                    <th>√ñdeme</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${importedPurchases.map((p, index) => {
                                    const paymentIcon = {
                                        'cash': 'üíµ Nakit',
                                        'card': 'üí≥ Kart',
                                        'transfer': 'üè¶ Havale'
                                    }[p.paymentMethod];
                                    
                                    return `
                                        <tr style="background: ${index % 2 === 0 ? 'white' : '#f9fafb'};">
                                            <td>${formatDate(p.date)}</td>
                                            <td><span class="badge badge-info">${p.category}</span></td>
                                            <td><strong>${p.description}</strong></td>
                                            <td>${p.supplier || '-'}</td>
                                            <td>${formatCurrency(p.amount)}</td>
                                            <td>${formatCurrency(p.vatAmount)} <small>(%${p.vatRate})</small></td>
                                            <td style="font-weight: 700; color: var(--danger);">${formatCurrency(p.total)}</td>
                                            <td>${paymentIcon}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                        <button class="btn btn-secondary" onclick="closePurchasesConfirmModal()">
                            ‚úñÔ∏è ƒ∞ptal
                        </button>
                        <button class="btn btn-success" onclick="saveImportedPurchases()" style="font-size: 16px; padding: 12px 30px;">
                            üíæ ${importedPurchases.length} Alƒ±≈üƒ± Kaydet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
    
    // Global'e kaydet
    window.tempImportedPurchases = importedPurchases;
}

function closePurchasesConfirmModal() {
    const modal = document.getElementById('purchasesConfirmModal');
    if (modal) {
        modal.remove();
    }
    window.tempImportedPurchases = null;
}

function saveImportedPurchases() {
    if (!window.tempImportedPurchases || window.tempImportedPurchases.length === 0) {
        alert('‚ùå Kaydedilecek alƒ±≈ü bulunamadƒ±!');
        return;
    }
    
    const now = new Date().toISOString();
    let savedCount = 0;
    
    window.tempImportedPurchases.forEach((p, index) => {
        const purchase = {
            id: Date.now().toString() + '_' + index + '_' + Math.random(),
            companyId: activeCompanyId,
            date: p.date,
            category: p.category,
            description: p.description,
            supplier: p.supplier || '',
            amount: p.amount,
            vatRate: p.vatRate,
            vatAmount: p.vatAmount,
            total: p.total,
            paymentMethod: p.paymentMethod,
            receipt: null,
            createdAt: now,
            createdBy: currentUser
        };
        
        purchases.push(purchase);
        savedCount++;
    });
    
    // LocalStorage'a kaydet
    localStorage.setItem('purchases', JSON.stringify(purchases));
    
    // Modal'ƒ± kapat
    closePurchasesConfirmModal();
    
    // Verileri yenile
    loadPurchases();
    updateDashboard();
    
    alert(`‚úÖ ${savedCount} alƒ±≈ü kaydƒ± ba≈üarƒ±yla eklendi!`);
}

// ========================================
// CARƒ∞ HESAP EXCEL/CSV IMPORT FONKSƒ∞YONLARI
// ========================================

function openImportAccountsModal() {
    if (!activeCompanyId) {
        alert('‚ö†Ô∏è L√ºtfen √∂nce bir firma se√ßin!');
        return;
    }

    const modalHtml = `
        <div class="modal active" id="accountsImportModal" style="display: flex;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>üì§ Cari Hesaplarƒ± Excel/CSV'den Ekle</h3>
                    <button class="close-modal" onclick="closeImportAccountsModal()">‚úñ</button>
                </div>
                <div style="padding: 30px;">
                    <div class="alert alert-info">
                        <strong>üìã Format:</strong> Sadece 1 s√ºtun yeterli!
                        <p style="margin: 10px 0 0 0; font-size: 0.95em;">
                            <b>Ba≈ülƒ±k:</b> Cari Adƒ± veya Alƒ±cƒ± Adƒ±<br>
                            <b>√ñrnek:</b>
                            <br>
                            <code>
Cari Adƒ±<br>
BORAY PLASTƒ∞K VE AMBALAJ SAN.LTD.≈ûTƒ∞.<br>
YILPLAST PLASTƒ∞K SANAYƒ∞ VE DI≈û Tƒ∞C.LTD.≈ûTƒ∞.<br>
ZET LOJƒ∞STƒ∞K HAZIR BETON SANAYƒ∞ VE Tƒ∞CARET ANONƒ∞M ≈ûƒ∞RKETƒ∞
                            </code>
                        </p>
                    </div>
                    <div class="file-upload-area" 
                         onclick="document.getElementById('accountsExcelFile').click()" 
                         style="cursor: pointer; margin-bottom: 20px;">
                        <h3>üìÇ CSV/Excel Dosyasƒ±nƒ± Y√ºkle</h3>
                        <p style="margin: 10px 0; color: #6b7280;">Dosyanƒ±zƒ± s√ºr√ºkleyin veya tƒ±klayƒ±n</p>
                        <input type="file" 
                               id="accountsExcelFile" 
                               accept=".csv" 
                               style="display:none;" 
                               onchange="processAccountsExcel(event)">
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="closeImportAccountsModal()">
                            ‚úñÔ∏è ƒ∞ptal
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closeImportAccountsModal() {
    const modal = document.getElementById('accountsImportModal');
    if (modal) {
        modal.remove();
    }
}

function processAccountsExcel(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const content = e.target.result;
            parseAccountsCSV(content);
        } catch (error) {
            alert('‚ùå Dosya okunamadƒ±: ' + error.message);
        }
    };

    reader.readAsText(file, 'UTF-8');
}

function parseAccountsCSV(content) {
    const lines = content.split('\n').map(line => line.trim()).filter(line => line.length > 0);

    // Ayra√ß algƒ±la (virg√ºl veya noktalƒ± virg√ºl veya tab)
    let delimiter = ',';
    if (lines[0].includes(';')) delimiter = ';';
    if (lines[0].includes('\t')) delimiter = '\t';

    // Ba≈ülƒ±k kontrol√º
    const header = lines[0].toLowerCase();
    if (!header.includes('cari') && !header.includes('alƒ±cƒ±')) {
        alert('‚ö†Ô∏è ƒ∞lk satƒ±r ba≈ülƒ±k olmalƒ±: "Cari Adƒ±" veya "Alƒ±cƒ± Adƒ±"');
        return;
    }

    let importedAccounts = [];
    let errorCount = 0;

    for (let i = 1; i < lines.length; i++) {
        let name = lines[i].split(delimiter)[0]?.trim();
        if (!name || name.length < 3) { errorCount++; continue; }
        // Aynƒ± isim varsa atla
        if (accounts.some(acc => acc.name.trim().toLowerCase() === name.toLowerCase() && acc.companyId === activeCompanyId)) {
            errorCount++;
            continue;
        }
        importedAccounts.push({
            id: Date.now().toString() + '_' + i + '_' + Math.random(),
            companyId: activeCompanyId,
            name: name,
            type: 'customer', // default: m√º≈üteri, istenirse se√ßilebilir!
            balance: 0,
            createdAt: new Date().toISOString(),
            createdBy: currentUser
        });
    }

    showAccountsConfirmModal(importedAccounts, errorCount);
}

function showAccountsConfirmModal(importedAccounts, errorCount) {
    closeImportAccountsModal();
    const summaryHtml = errorCount > 0 
        ? `<div class="alert alert-warning">
            <strong>‚ö†Ô∏è ${errorCount} satƒ±r hatalƒ± veya tekrar olduƒüu i√ßin atlandƒ±!</strong>
           </div>`
        : '';
    const modalHtml = `
        <div class="modal active" id="accountsConfirmModal" style="display: flex;">
            <div class="modal-content" style="max-width: 600px;">
                <div class="modal-header">
                    <h3>‚úÖ Cari Hesaplarƒ± Onaylayƒ±n (${importedAccounts.length} Kayƒ±t)</h3>
                    <button class="close-modal" onclick="closeAccountsConfirmModal()">‚úñ</button>
                </div>
                <div style="padding: 20px;">
                    ${summaryHtml}
                    <div class="alert alert-success">
                        <strong>üìä Toplam ${importedAccounts.length} cari hesap eklenecek</strong>
                    </div>
                    <ul style="max-height:300px;overflow:auto;">
                        ${importedAccounts.map(acc => `<li>${acc.name}</li>`).join('')}
                    </ul>
                    <div style="margin-top: 30px; text-align: right; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                        <button class="btn btn-secondary" onclick="closeAccountsConfirmModal()">
                            ‚úñÔ∏è ƒ∞ptal
                        </button>
                        <button class="btn btn-success" onclick="saveImportedAccounts()" style="font-size: 16px; padding: 12px 30px;">
                            üíæ Cari Hesaplarƒ± Kaydet
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);

    window.tempImportedAccounts = importedAccounts;
}

function closeAccountsConfirmModal() {
    const modal = document.getElementById('accountsConfirmModal');
    if (modal) {
        modal.remove();
    }
    window.tempImportedAccounts = null;
}

async function saveImportedAccounts() {
    console.log('üíæ Kaydetme i≈ülemi ba≈ülatƒ±ldƒ±');
    console.log('tempImportedAccounts:', window.tempImportedAccounts);
    
    // NULL KONTROL
    if (!window.tempImportedAccounts || window.tempImportedAccounts.length === 0) {
        alert('‚ùå Kaydedilecek cari hesap yok! L√ºtfen √∂nce bir CSV dosyasƒ± y√ºkleyin.');
        return;
    }
    
    if (!activeCompanyId) {
        alert('‚ùå L√ºtfen bir firma se√ßin!');
        return;
    }
    
    if (!auth.currentUser) {
        alert('‚ùå L√ºtfen giri≈ü yapƒ±n!');
        return;
    }
    
    const now = new Date().toISOString();
    let savedCount = 0;
    
    try {
        console.log(`üîÑ ${window.tempImportedAccounts.length} hesap kaydediliyor...`);
        
        // Batch i≈ülemi ile Firebase'e kaydet
        const batch = db.batch();
        
        for (const acc of window.tempImportedAccounts) {
            const accountData = {
                companyId: activeCompanyId,
                name: acc.name,
                type: acc.type || 'customer',
                balance: acc.balance || 0,
                taxNumber: acc.taxNumber || '',
                taxOffice: acc.taxOffice || '',
                address: acc.address || '',
                phone: acc.phone || '',
                email: acc.email || '',
                notes: acc.notes || '',
                createdAt: now,
                createdBy: auth.currentUser.uid
            };
            
            // Firestore'a ekle
            const docRef = db.collection('companies').doc(activeCompanyId)
                .collection('accounts').doc();
            
            batch.set(docRef, accountData);
            
            // Local array'e de ekle
            accounts.push({
                id: docRef.id,
                ...accountData
            });
            
            savedCount++;
        }
        
        // Batch'i kaydet
        await batch.commit();
        
        console.log(`‚úÖ ${savedCount} hesap Firebase'e kaydedildi`);
        
        // Modal'ƒ± kapat
        closeAccountsConfirmModal();
        
        // Tabloyu yenile
        await loadAccounts();
        updateDashboard();
        
        alert(`‚úÖ ${savedCount} cari hesap ba≈üarƒ±yla eklendi!`);
        
    } catch (error) {
        console.error('‚ùå Kaydetme hatasƒ±:', error);
        alert('‚ùå Kaydetme hatasƒ±: ' + error.message);
    }
}

// Y√∂netici panelinde izin taleplerini listele
function loadLeaveRequestsAdminPanel() {
    const tbody = document.getElementById('adminLeaveRequestsTableBody');
    tbody.innerHTML = '';
    if (!leaveRequests || leaveRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Hen√ºz izin talebi yok.</td></tr>';
        return;
    }
    leaveRequests.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    leaveRequests.forEach(lr => {
        const person = personnel.find(p => p.id === lr.personnelId);
        const statusColor =
            lr.status === "approved" ? "success" :
            lr.status === "rejected" ? "danger" : "warning";
        const statusLabel =
            lr.status === "approved" ? "Onaylandƒ±" :
            lr.status === "rejected" ? "Reddedildi" : "Beklemede";
        tbody.innerHTML += `
            <tr>
                <td>${person ? person.name : 'Bilinmiyor'}</td>
                <td>${formatDate(lr.startDate)} - ${formatDate(lr.endDate)}</td>
                <td>${getLeaveTypeLabel(lr.type)}</td>
                <td>${lr.description || '-'}</td>
                <td><span class="badge badge-${statusColor}">${statusLabel}</span></td>
                <td>${lr.approvedBy || lr.rejectedBy || '-'}</td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="showLeaveDetailModal('${lr.id}')">Detay/√áƒ±ktƒ±</button>
                </td>
                <td>
                    ${lr.status === "pending"
                        ? `<button class="btn btn-success btn-sm" onclick="approveLeaveRequest('${lr.id}')">Onayla</button>
                           <button class="btn btn-danger btn-sm" onclick="rejectLeaveRequest('${lr.id}')">Reddet</button>`
                        : ''
                    }
                </td>
            </tr>
        `;
    });
}
function getLeaveTypeLabel(type) {
    switch(type) {
        case "annual": return "Yƒ±llƒ±k ƒ∞zin";
        case "sick": return "Hastalƒ±k ƒ∞zni";
        case "unpaid": return "√úcretsiz ƒ∞zin";
        default: return "Diƒüer";
    }
}
function approveLeaveRequest(id) {
    const lr = leaveRequests.find(l => l.id === id);
    if (!lr || lr.status !== "pending") return;
    lr.status = "approved";
    lr.approvedBy = currentUser;
    lr.approvedAt = new Date().toISOString();
    localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
    loadLeaveRequestsAdminPanel();
    updatePersonnelStats();
    alert("ƒ∞zin talebi onaylandƒ±.");
}
function rejectLeaveRequest(id) {
    const lr = leaveRequests.find(l => l.id === id);
    if (!lr || lr.status !== "pending") return;
    lr.status = "rejected";
    lr.rejectedBy = currentUser;
    lr.rejectedAt = new Date().toISOString();
    localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
    loadLeaveRequestsAdminPanel();
    updatePersonnelStats();
    alert("ƒ∞zin talebi reddedildi.");
}

// ƒ∞zin detay modalƒ± ve √ßƒ±ktƒ± alma
function showLeaveDetailModal(id) {
    const lr = leaveRequests.find(l => l.id === id);
    if (!lr) return;
    const person = personnel.find(p => p.id === lr.personnelId);
    const statusLabel = lr.status === "approved" ? "Onaylandƒ±" : lr.status === "rejected" ? "Reddedildi" : "Beklemede";
    const approveInfo = lr.status === "approved"
        ? `<strong>Onaylayan:</strong> ${lr.approvedBy}<br><strong>Onay Tarihi:</strong> ${formatDate(lr.approvedAt)}`
        : lr.status === "rejected"
        ? `<strong>Reddeden:</strong> ${lr.rejectedBy}<br><strong>Red Tarihi:</strong> ${formatDate(lr.rejectedAt)}`
        : '';
    const modalHtml = `
        <div id="leaveDetailModal" class="modal active" style="display:flex;">
            <div class="modal-content" style="max-width:600px;">
                <div class="modal-header">
                    <h3>ƒ∞zin Talebi Detayƒ± ve √áƒ±ktƒ±sƒ±</h3>
                    <button class="close-modal" onclick="closeLeaveDetailModal()">‚úñ</button>
                </div>
                <div style="padding:20px;">
                    <table style="width:100%;margin-bottom:15px;">
                        <tr><td><strong>Personel:</strong></td><td>${person ? person.name : 'Bilinmiyor'}</td></tr>
                        <tr><td><strong>ƒ∞zin Tipi:</strong></td><td>${getLeaveTypeLabel(lr.type)}</td></tr>
                        <tr><td><strong>Ba≈ülangƒ±√ß Tarihi:</strong></td><td>${formatDate(lr.startDate)}</td></tr>
                        <tr><td><strong>Biti≈ü Tarihi:</strong></td><td>${formatDate(lr.endDate)}</td></tr>
                        <tr><td><strong>A√ßƒ±klama:</strong></td><td>${lr.description || '-'}</td></tr>
                        <tr><td><strong>Durum:</strong></td><td>${statusLabel}</td></tr>
                        <tr><td colspan="2">${approveInfo}</td></tr>
                    </table>
                    <div style="margin:30px 0 10px 0;text-align:center;">
                        <strong>ƒ∞mza:</strong>
                        <div style="border-bottom:1px solid #888;width:220px;margin:12px auto 0 auto;height:32px;"></div>
                    </div>
                    <div style="text-align:center;">
                        <button class="btn btn-success" onclick="printLeaveDetail('${lr.id}')">üñ®Ô∏è √áƒ±ktƒ± Al</button>
                        <button class="btn btn-secondary" onclick="closeLeaveDetailModal()">Kapat</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    // Modal ekle
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}
function closeLeaveDetailModal() {
    const modal = document.getElementById('leaveDetailModal');
    if (modal) modal.remove();
}
function printLeaveDetail(id) {
    const lr = leaveRequests.find(l => l.id === id);
    if (!lr) return;
    const person = personnel.find(p => p.id === lr.personnelId);
    const statusLabel = lr.status === "approved" ? "Onaylandƒ±" : lr.status === "rejected" ? "Reddedildi" : "Beklemede";
    const approveInfo = lr.status === "approved"
        ? `Onaylayan: ${lr.approvedBy}\nOnay Tarihi: ${formatDate(lr.approvedAt)}`
        : lr.status === "rejected"
        ? `Reddeden: ${lr.rejectedBy}\nRed Tarihi: ${formatDate(lr.rejectedAt)}`
        : '';
    const printHtml = `
        <html>
        <head>
            <title>ƒ∞zin Talebi √áƒ±ktƒ±sƒ±</title>
            <meta charset="UTF-8">
            <style>
                body {font-family:Arial;padding:40px;}
                .header {font-size:1.6em;font-weight:700;margin-bottom:20px;}
                table {width:100%;margin-bottom:20px;}
                td {padding:6px;}
                .imza {margin-top:30px;}
                @media print {button {display:none !important;}}
            </style>
        </head>
        <body>
            <div class="header">ƒ∞zin Talebi Formu</div>
            <table>
                <tr><td><strong>Personel:</strong></td><td>${person ? person.name : 'Bilinmiyor'}</td></tr>
                <tr><td><strong>ƒ∞zin Tipi:</strong></td><td>${getLeaveTypeLabel(lr.type)}</td></tr>
                <tr><td><strong>Ba≈ülangƒ±√ß Tarihi:</strong></td><td>${formatDate(lr.startDate)}</td></tr>
                <tr><td><strong>Biti≈ü Tarihi:</strong></td><td>${formatDate(lr.endDate)}</td></tr>
                <tr><td><strong>A√ßƒ±klama:</strong></td><td>${lr.description || '-'}</td></tr>
                <tr><td><strong>Durum:</strong></td><td>${statusLabel}</td></tr>
                <tr><td colspan="2">${approveInfo}</td></tr>
            </table>
            <div class="imza">
                <strong>ƒ∞mza:</strong>
                <div style="border-bottom:1.5px solid #444;width:240px;height:32px;margin-top:20px;"></div>
            </div>
            <div style="text-align:center;margin-top:24px;">
                <button onclick="window.print()" style="padding:12px 40px;font-size:1.2em;">üñ®Ô∏è Yazdƒ±r</button>
                <button onclick="window.close()" style="padding:12px 40px;font-size:1.2em;margin-left:12px;">Kapat</button>
            </div>
        </body>
        </html>
    `;
    const win = window.open('', 'ƒ∞zinTalebi', 'width=800,height=600');
    win.document.write(printHtml);
}

// Personel paneli i√ßin eri≈üim (√∂rnek, sistemde oturum yoksa basit bir modal ile a√ßƒ±labilir)
function openPersonnelLeavePanel(personnelId) {
    // Sadece kendi izinleri ve talep formu g√∂sterilecek
    const myLeaves = leaveRequests.filter(lr => lr.personnelId === personnelId);
    let leavesHtml = myLeaves.length === 0
        ? '<tr><td colspan="6" style="text-align:center;">Hen√ºz talep yok.</td></tr>'
        : myLeaves.map(lr => `
            <tr>
                <td>${getLeaveTypeLabel(lr.type)}</td>
                <td>${formatDate(lr.startDate)} - ${formatDate(lr.endDate)}</td>
                <td>${lr.description || '-'}</td>
                <td><span class="badge badge-${lr.status === "approved" ? "success" : lr.status === "rejected" ? "danger" : "warning"}">
                    ${lr.status === "approved" ? "Onaylandƒ±" : lr.status === "rejected" ? "Reddedildi" : "Beklemede"}
                </span></td>
                <td>${lr.approvedBy || lr.rejectedBy || '-'}</td>
                <td>
                    <button class="btn btn-info btn-sm" onclick="showLeaveDetailModal('${lr.id}')">Detay/√áƒ±ktƒ±</button>
                </td>
            </tr>
        `).join('');
    const modalHtml = `
        <div id="personnelLeavePanelModal" class="modal active" style="display:flex;">
            <div class="modal-content" style="max-width:700px;">
                <div class="modal-header">
                    <h3>üë§ Personel ƒ∞zin Paneli</h3>
                    <button class="close-modal" onclick="closePersonnelLeavePanelModal()">‚úñ</button>
                </div>
                <div style="padding:20px;">
                    <h4>ƒ∞zin Taleplerim</h4>
                    <table style="width:100%;margin-bottom:15px;">
                        <tr>
                            <th>Tip</th><th>Tarih</th><th>A√ßƒ±klama</th><th>Durum</th><th>Onaylayan</th><th>Detay</th>
                        </tr>
                        ${leavesHtml}
                    </table>
                    <hr>
                    <h4>Yeni ƒ∞zin Talebi Olu≈ütur</h4>
                    <form onsubmit="submitPersonnelLeaveRequest(event, '${personnelId}')">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                            <div>
                                <label>Tip</label>
                                <select name="leaveType" required>
                                    <option value="">Se√ßiniz</option>
                                    <option value="annual">Yƒ±llƒ±k</option>
                                    <option value="sick">Hastalƒ±k</option>
                                    <option value="unpaid">√úcretsiz</option>
                                    <option value="other">Diƒüer</option>
                                </select>
                            </div>
                            <div>
                                <label>Ba≈ülangƒ±√ß</label>
                                <input type="date" name="leaveStartDate" required>
                            </div>
                            <div>
                                <label>Biti≈ü</label>
                                <input type="date" name="leaveEndDate" required>
                            </div>
                            <div>
                                <label>A√ßƒ±klama</label>
                                <input type="text" name="leaveDescription">
                            </div>
                        </div>
                        <div style="margin-top:20px;text-align:right;">
                            <button type="submit" class="btn btn-primary">Talep Olu≈ütur</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}
function closePersonnelLeavePanelModal() {
    const modal = document.getElementById('personnelLeavePanelModal');
    if (modal) modal.remove();
}
function submitPersonnelLeaveRequest(event, personnelId) {
    event.preventDefault();
    const form = event.target;
    const leaveType = form.leaveType.value;
    const leaveStartDate = form.leaveStartDate.value;
    const leaveEndDate = form.leaveEndDate.value;
    const leaveDescription = form.leaveDescription.value;
    if (!leaveType || !leaveStartDate || !leaveEndDate) {
        alert("Eksik bilgi!");
        return;
    }
    leaveRequests.push({
        id: Date.now().toString(),
        personnelId: personnelId,
        type: leaveType,
        startDate: leaveStartDate,
        endDate: leaveEndDate,
        description: leaveDescription,
        status: "pending",
        approvedBy: "",
        approvedAt: "",
        rejectedBy: "",
        rejectedAt: "",
        createdAt: new Date().toISOString()
    });
    localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
    closePersonnelLeavePanelModal();
    alert("ƒ∞zin talebi olu≈üturuldu. Y√∂netici onayƒ±nƒ± bekleyin.");
}


// ========================================
// PERSONEL Y√ñNETƒ∞Mƒ∞ - GLOBAL DEƒûƒ∞≈ûKENLER
// ========================================
let personnel = JSON.parse(localStorage.getItem('personnel')) || [];
let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
let leaveRequests = JSON.parse(localStorage.getItem('leaveRequests')) || [];
let salaryPayments = JSON.parse(localStorage.getItem('salaryPayments')) || [];

// ========================================
// PERSONEL FONKSƒ∞YONLARI
// ========================================

function openAddPersonnelModal() {
    document.getElementById('personnelForm').reset();
    document.getElementById('personnelId').value = '';
    document.getElementById('personnelFormModalTitle').textContent = '‚ûï Yeni Personel Ekle';
    document.getElementById('personnelFormModal').classList.add('active');
}

function closePersonnelFormModal() {
    document.getElementById('personnelFormModal').classList.remove('active');
}

function savePersonnel(e) {
    e.preventDefault();
    
    const personnelId = document.getElementById('personnelId').value;
    const now = new Date().toISOString();
    
    const personnelData = {
        id: personnelId || Date.now().toString(),
        name: document.getElementById('personnelName').value,
        tcNo: document.getElementById('personnelTCNo').value,
        position: document.getElementById('personnelPosition').value,
        phone: document.getElementById('personnelPhone').value,
        salary: parseFloat(document.getElementById('personnelSalary').value),
        sgkRate: parseFloat(document.getElementById('personnelSGKRate').value),
        startDate: document.getElementById('personnelStartDate').value,
        status: document.getElementById('personnelStatus').value,
        address: document.getElementById('personnelAddress').value,
        createdAt: personnelId ? undefined : now,
        updatedAt: now
    };
    
    if (personnelId) {
        const index = personnel.findIndex(p => p.id === personnelId);
        personnel[index] = { ...personnel[index], ...personnelData };
    } else {
        personnel.push(personnelData);
    }
    
    localStorage.setItem('personnel', JSON.stringify(personnel));
    closePersonnelFormModal();
    loadPersonnel();
    populatePersonnelSelects();
    updatePersonnelStats();
    
    alert('‚úÖ Personel kaydedildi!');
}

async function loadPersonnel() {
    if (!activeCompanyId || !auth.currentUser) {
        personnel = [];
        return;
    }
    
    try {
        const snapshot = await db.collection('companies').doc(activeCompanyId)
            .collection('personnel').get();
        
        personnel = [];
        snapshot.forEach(doc => {
            personnel.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('‚úÖ Personel y√ºklendi:', personnel.length);
        
    } catch (error) {
        console.error('‚ùå Personel y√ºkleme hatasƒ±:', error);
        personnel = [];
    }
    
    renderPersonnelTable();
}

function editPersonnel(id) {
    const person = personnel.find(p => p.id === id);
    if (!person) return;
    
    document.getElementById('personnelId').value = person.id;
    document.getElementById('personnelName').value = person.name;
    document.getElementById('personnelTCNo').value = person.tcNo;
    document.getElementById('personnelPosition').value = person.position;
    document.getElementById('personnelPhone').value = person.phone || '';
    document.getElementById('personnelSalary').value = person.salary;
    document.getElementById('personnelSGKRate').value = person.sgkRate;
    document.getElementById('personnelStartDate').value = person.startDate;
    document.getElementById('personnelStatus').value = person.status;
    document.getElementById('personnelAddress').value = person.address || '';
    
    document.getElementById('personnelFormModalTitle').textContent = '‚úèÔ∏è Personel D√ºzenle';
    document.getElementById('personnelFormModal').classList.add('active');
}

function deletePersonnel(id) {
    if (!confirm('Bu personeli silmek istediƒüinizden emin misiniz?')) return;
    
    personnel = personnel.filter(p => p.id !== id);
    localStorage.setItem('personnel', JSON.stringify(personnel));
    
    loadPersonnel();
    populatePersonnelSelects();
    updatePersonnelStats();
    
    alert('‚úÖ Personel silindi!');
}

// Personel select'i doldur (mevcut koddan alƒ±nabilir)
function populatePersonnelSelects() {
    const selects = ['salaryPersonnelSelect'];
    selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;
        const firstOption = select.querySelector('option:first-child').outerHTML;
        select.innerHTML = firstOption;
        personnel.filter(p => p.status === 'active').forEach(person => {
            const option = new Option(person.name, person.id);
            select.add(option);
        });
    });
}

// Ay adƒ±nƒ± bulmak i√ßin yardƒ±mcƒ± fonksiyon
function getMonthName(monthNum) {
    const months = ["Ocak","≈ûubat","Mart","Nisan","Mayƒ±s","Haziran","Temmuz","Aƒüustos","Eyl√ºl","Ekim","Kasƒ±m","Aralƒ±k"];
    return months[parseInt(monthNum,10)-1];
}

// Toplam maliyeti hesapla ve g√∂ster
function updateSalaryTotalCost() {
    const ayVal = document.getElementById('salaryMonth').value; // YYYY-MM
    if (!ayVal) return;
    const ayAd = getMonthName(ayVal.split('-')[1]);
    const netMaas = parseFloat(document.getElementById('salaryNetInput').value) || 0;
    const ekKazanc = parseFloat(document.getElementById('salaryExtraInput').value) || 0;
    if (!salaryTableData[ayAd]) {
        document.getElementById('salaryTotalCostDisplay').value = 'CSV tablo yok!';
        return;
    }
    const hesap = hesaplaIsverenMaliyetiCSV(ayAd, netMaas, ekKazanc);
    if (hesap) {
        document.getElementById('salaryTotalCostDisplay').value = hesap.toplamIsveren.toFixed(2) + ' ‚Ç∫';
    } else {
        document.getElementById('salaryTotalCostDisplay').value = 'Hesaplama yok!';
    }
}

function updatePersonnelStats() {
    const activeCount = personnel.filter(p => p.status === 'active').length;
    const monthlySalary = personnel
        .filter(p => p.status === 'active')
        .reduce((sum, p) => sum + p.salary, 0);
    const monthlySGK = personnel
        .filter(p => p.status === 'active')
        .reduce((sum, p) => sum + (p.salary * p.sgkRate / 100), 0);
    
    // Bu ay izin g√ºn√º hesabƒ±
    const today = new Date();
    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    const monthlyLeaves = leaveRequests.filter(leave => {
        const leaveMonth = leave.startDate.substring(0, 7);
        return leaveMonth === currentMonth;
    });
    const totalLeaveDays = monthlyLeaves.reduce((sum, leave) => {
        const start = new Date(leave.startDate);
        const end = new Date(leave.endDate);
        const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
        return sum + days;
    }, 0);
    
    document.getElementById('activePersonnelCount').textContent = activeCount;
    document.getElementById('monthlySalaryTotal').textContent = formatCurrency(monthlySalary);
    document.getElementById('monthlySGKTotal').textContent = formatCurrency(monthlySGK);
    document.getElementById('monthlyLeaveCount').textContent = totalLeaveDays;
}

// ========================================
// DEVAMSIZLIK TAKƒ∞Bƒ∞
// ========================================

function loadPersonnelAttendance() {
    const personnelId = document.getElementById('attendancePersonnelSelect').value;
    
    if (!personnelId) {
        document.getElementById('attendanceSection').style.display = 'none';
        return;
    }
    
    document.getElementById('attendanceSection').style.display = 'block';
    
    const today = new Date();
    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    
    const records = attendanceRecords.filter(r => 
        r.personnelId === personnelId && r.date.startsWith(currentMonth)
    );
    
    const recordsDiv = document.getElementById('attendanceRecords');
    recordsDiv.innerHTML = '';
    
    if (records.length === 0) {
        recordsDiv.innerHTML = '<p style="color:#6b7280;">Bu ay hen√ºz kayƒ±t yok.</p>';
        return;
    }
    
    records.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    records.forEach(record => {
        const div = document.createElement('div');
        div.style.cssText = 'padding:10px; margin:5px 0; border-radius:6px; background:#f9fafb; border-left:4px solid ' + (record.status === 'present' ? 'var(--success)' : 'var(--danger)');
        div.innerHTML = `
            <strong>${formatDate(record.date)}</strong> - 
            <span style="color:${record.status === 'present' ? 'var(--success)' : 'var(--danger)'};">
                ${record.status === 'present' ? '‚úÖ Geldi' : '‚ùå Gelmedi'}
            </span>
        `;
        recordsDiv.appendChild(div);
    });
}

function markAttendance(status) {
    const personnelId = document.getElementById('attendancePersonnelSelect').value;
    if (!personnelId) return;
    
    const today = new Date().toISOString().split('T')[0];
    
    // Bug√ºn i√ßin kayƒ±t var mƒ± kontrol et
    const existingIndex = attendanceRecords.findIndex(r => 
        r.personnelId === personnelId && r.date === today
    );
    
    if (existingIndex >= 0) {
        attendanceRecords[existingIndex].status = status;
    } else {
        attendanceRecords.push({
            id: Date.now().toString(),
            personnelId: personnelId,
            date: today,
            status: status,
            createdAt: new Date().toISOString()
        });
    }
    
    localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
    loadPersonnelAttendance();
    
    alert(`‚úÖ Devamsƒ±zlƒ±k kaydedildi: ${status === 'present' ? 'Geldi' : 'Gelmedi'}`);
}

// ========================================
// ƒ∞Zƒ∞N TALEPLERƒ∞
// ========================================

function openLeaveRequestModal() {
    const personnelId = document.getElementById('attendancePersonnelSelect').value;
    if (!personnelId) {
        alert('‚ö†Ô∏è L√ºtfen √∂nce personel se√ßin!');
        return;
    }
    
    document.getElementById('leaveRequestForm').reset();
    document.getElementById('leaveRequestModal').classList.add('active');
}

function closeLeaveRequestModal() {
    document.getElementById('leaveRequestModal').classList.remove('active');
}

function saveLeaveRequest(e) {
    e.preventDefault();
    
    const personnelId = document.getElementById('attendancePersonnelSelect').value;
    
    const leaveRequest = {
        id: Date.now().toString(),
        personnelId: personnelId,
        type: document.getElementById('leaveType').value,
        startDate: document.getElementById('leaveStartDate').value,
        endDate: document.getElementById('leaveEndDate').value,
        description: document.getElementById('leaveDescription').value,
        createdAt: new Date().toISOString()
    };
    
    leaveRequests.push(leaveRequest);
    localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
    
    closeLeaveRequestModal();
    updatePersonnelStats();
    
    alert('‚úÖ ƒ∞zin talebi olu≈üturuldu!');
}

// ========================================
// MAA≈û √ñDEMELERƒ∞
// ========================================

// Maa≈ü √∂deme i≈üleminde yeni mantƒ±k
function processSalaryPayments() {
    const monthVal = document.getElementById('salaryMonth').value; // YYYY-MM
    if (!monthVal) {
        alert('‚ö†Ô∏è L√ºtfen ay se√ßin!');
        return;
    }
    const ayAd = getMonthName(monthVal.split('-')[1]);
    const personnelId = document.getElementById('salaryPersonnelSelect').value;
    let personnelToProcess = personnel.filter(p => p.status === 'active');
    if (personnelId) {
        personnelToProcess = personnelToProcess.filter(p => p.id === personnelId);
    }
    if (personnelToProcess.length === 0) {
        alert('‚ö†Ô∏è ƒ∞≈ülenecek personel yok!');
        return;
    }
    // Net maa≈ü ve ek kazan√ß inputlarƒ±nƒ± al
    const netMaas = parseFloat(document.getElementById('salaryNetInput').value) || 0;
    const ekKazanc = parseFloat(document.getElementById('salaryExtraInput').value) || 0;
    if (!netMaas || !salaryTableData[ayAd]) {
        alert('‚ö†Ô∏è Net maa≈ü ve CSV tablo gerekli!');
        return;
    }
    let processedCount = 0;
    personnelToProcess.forEach(person => {
        // Bu ay i√ßin √∂deme yapƒ±lmƒ±≈ü mƒ± kontrol et
        const existingPayment = salaryPayments.find(sp =>
            sp.personnelId === person.id && sp.month === monthVal
        );
        if (existingPayment) return;
        const hesap = hesaplaIsverenMaliyetiCSV(ayAd, netMaas, ekKazanc);
        salaryPayments.push({
            id: Date.now().toString() + '_' + person.id,
            personnelId: person.id,
            month: monthVal,
            netSalary: netMaas,
            extraIncome: ekKazanc,
            totalEmployerCost: hesap.toplamIsveren,
            paidDate: new Date().toISOString().split('T')[0],
            createdAt: new Date().toISOString()
        });
        processedCount++;
    });
    localStorage.setItem('salaryPayments', JSON.stringify(salaryPayments));
    loadSalaryPayments();
    alert(`‚úÖ ${processedCount} personelin maa≈üƒ± i≈ülendi!`);
}

// Maa≈ü √∂deme tablosu (rapor)
function loadSalaryPayments() {
    const tbody = document.querySelector('#salaryPaymentsTable tbody');
    tbody.innerHTML = '';
    if (salaryPayments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:20px;">Hen√ºz maa≈ü √∂demesi yok.</td></tr>';
        return;
    }
    const sorted = [...salaryPayments].sort((a, b) => new Date(b.paidDate) - new Date(a.paidDate));
    sorted.forEach(payment => {
        const person = personnel.find(p => p.id === payment.personnelId);
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${formatDate(payment.paidDate)}</td>
            <td><strong>${person ? person.name : 'Silinmi≈ü'}</strong></td>
            <td>${formatCurrency(payment.netSalary)}</td>
            <td>${formatCurrency(payment.extraIncome)}</td>
            <td style="color:var(--success); font-weight:700;">${formatCurrency(payment.totalEmployerCost)}</td>
            <td><span class="badge badge-success">√ñdendi</span></td>
        `;
    });
}

// Maa≈ü tablosu CSV upload ve i≈üleme
let salaryTableData = {}; // ay -> { net, isveren, ... } ≈üeklinde doldurulacak

function handleSalaryCSVUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const content = e.target.result;
        salaryTableData = parseSalaryCSV(content);
        localStorage.setItem('salaryTableData', JSON.stringify(salaryTableData));
        document.getElementById('salaryTableStatus').textContent = 'CSV ba≈üarƒ±yla y√ºklendi!';
    };
    reader.readAsText(file, 'UTF-8');
}

// CSV √∂rneƒüi indirme
function downloadSalaryExample() {
    const csv = `Ay;Br√ºt;SSK ƒ∞≈ü√ßi;ƒ∞≈üsizlik ƒ∞≈ü√ßi;Aylƒ±k Gelir Vergisi;Damga Vergisi;K√ºm√ºlatif Toplam;Net;AGƒ∞;Toplam Net Ele Ge√ßen;SSK ƒ∞≈üveren;ƒ∞≈üsizlik ƒ∞≈üveren;Toplam Maliyet;Asgari √úcret Gelir Vergisi ƒ∞stisnasƒ±;Asgari √úcret Damga Vergisi ƒ∞stisnasƒ±
Ocak;45000;6300;450;5737,5;341,55;38250;32170,95;0;35684,03;9337,5;900;55237,5;3315,7;197,38
≈ûubat;45000;6300;450;5737,5;341,55;76500;32170,95;0;35684,03;9337,5;900;55237,5;3315,7;197,38
Mart;45000;6300;450;5737,5;341,55;114750;32170,95;0;35684,03;9337,5;900;55237,5;3315,7;197,38
...`; // T√ºm aylar i√ßin doldurabilirsin
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `maas-tablosu-ornegi.csv`;
    link.click();
    URL.revokeObjectURL(url);
}

function normalizeMonthName(raw) {
    const map = {
        "ÔøΩubat": "≈ûubat",
        "Mart": "Mart",
        "Nisan": "Nisan",
        "MayÔøΩs": "Mayƒ±s",
        "Haziran": "Haziran",
        "Temmuz": "Temmuz",
        "AÔøΩustos": "Aƒüustos",
        "EylÔøΩl": "Eyl√ºl",
        "Ekim": "Ekim",
        "KasÔøΩm": "Kasƒ±m",
        "AralÔøΩk": "Aralƒ±k",
        "Ocak": "Ocak"
    };
    let clean = raw.trim();
    return map[clean] || clean;
}

// CSV parsing fonksiyonu
function parseSalaryCSV(content) {
    const lines = content.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
    let header = null;
    let result = {};
    for (let i = 0; i < lines.length; i++) {
        const line = lines[i].trim();
        if (!line) continue;
        const parts = line.split(';');
        // Header satƒ±rƒ±nƒ± bul
        if (!header && parts[0].match(/Ay|Ocak|≈ûubat|Mart|Nisan|Mayƒ±s|Haziran|Temmuz|Aƒüustos|Eyl√ºl|Ekim|Kasƒ±m|Aralƒ±k|ÔøΩubat|MayÔøΩs|AÔøΩustos|EylÔøΩl|KasÔøΩm|AralÔøΩk/)) {
            header = parts;
            continue;
        }
        // Data satƒ±rƒ±
        if (header && parts.length === header.length) {
            const ayRaw = parts[0];
            const ay = normalizeMonthName(ayRaw);
            result[ay] = {};
            for (let j = 1; j < header.length; j++) {
                const key = header[j].replace(/\s+/g, '_').toLowerCase();
                const val = parts[j].replace(',', '.');
                result[ay][key] = parseFloat(val) || 0;
            }
        }
    }
    return result;
}

// Maa≈ü √∂deme/hesaplama fonksiyonu (ay, net maa≈ü, ek kazan√ß)
function hesaplaIsverenMaliyetiCSV(ay, netMaas, ekKazanc) {
    if (!salaryTableData[ay]) return null;
    // CSV'den tablodaki net ve i≈üveren maliyeti
    const data = salaryTableData[ay];
    const tablonet = data.net;
    const tabloisveren = data.toplam_maliyet || data['toplam_maliyet'];
    // Oranla: Net maa≈ü farklƒ±ysa, i≈üveren maliyetini orantƒ±la
    const oran = netMaas / tablonet;
    const toplamIsveren = tabloisveren * oran + (ekKazanc || 0);
    return {
        netMaas: netMaas,
        ekKazanc: ekKazanc || 0,
        toplamIsveren: toplamIsveren,
        tabloSatir: data
    };
}

// Personel select'i doldur
function populateYearPersonnelSelect() {
    const select = document.getElementById('yearPersonnelSelect');
    select.innerHTML = '';
    personnel.forEach(p => {
        const option = new Option(p.name, p.id);
        select.add(option);
    });
}

// Maa≈ü deƒüi≈üiklikleri √∂rnek veri (personel objesinde salaryHistory alanƒ± olmalƒ±!)
/*
personnel = [{
    id: "123",
    name: "Ali Veli",
    startDate: "2025-03-15",
    salaryHistory: [
        { from: "2025-03", net: 32000 },
        { from: "2025-07", net: 35000 }
    ],
    // ...
}]
*/

// Yƒ±llƒ±k tablo render fonksiyonu
function renderYearlySalaryTable() {
    const year = document.getElementById('yearSalarySelect').value;
    const personnelId = document.getElementById('yearPersonnelSelect').value;
    const person = personnel.find(p => p.id === personnelId);
    if (!person || !salaryTableData) {
        document.getElementById('yearlySalaryTableSection').innerHTML = '<div class="alert alert-danger">Personel veya maa≈ü tablosu eksik!</div>';
        return;
    }

    // ƒ∞≈üe ba≈ülama tarihi
    const startDate = new Date(person.startDate);
    const startYear = startDate.getFullYear();
    const startMonth = startDate.getMonth() + 1;

    // Maa≈ü deƒüi≈üikliklerini sƒ±rala
    const salaryHistory = person.salaryHistory || [{ from: `${startYear}-${String(startMonth).padStart(2, '0')}`, net: person.salary }];
    salaryHistory.sort((a, b) => a.from.localeCompare(b.from));

    // Aylar
    const aylar = ['01','02','03','04','05','06','07','08','09','10','11','12'];
    let rows = '';
    let currentNet = null;
    let historyIdx = 0;

    for (let i = 0; i < aylar.length; i++) {
        const ayNum = aylar[i];
        const ayAd = getMonthName(ayNum);
        const ayLabel = `${ayAd} ${year}`;
        const monthStr = `${year}-${ayNum}`;
        const ayStartDate = new Date(`${year}-${ayNum}-01`);

        // ƒ∞≈üe ba≈ülama √∂ncesi aylar
        if (ayStartDate < startDate) {
            rows += `<tr style="background:#f3f4f6;color:#888;">
                <td>${ayLabel}</td>
                <td colspan="6" style="text-align:center;">√áalƒ±≈ümadƒ±</td>
            </tr>`;
            continue;
        }

        // Maa≈ü deƒüi≈üikliƒüi kontrol√º
        while (historyIdx < salaryHistory.length && salaryHistory[historyIdx].from <= monthStr) {
            currentNet = salaryHistory[historyIdx].net;
            historyIdx++;
        }

        // Ek kazan√ß ve dekontlar localStorage'da
        const dekontKey = `salaryReceipt_${person.id}_${monthStr}`;
        const dekontData = JSON.parse(localStorage.getItem(dekontKey) || 'null');
        const ekKazancKey = `salaryExtra_${person.id}_${monthStr}`;
        const ekKazanc = parseFloat(localStorage.getItem(ekKazancKey) || '0');

        // Toplam maliyet hesapla
        const ayCSV = salaryTableData[ayAd];
        let toplamMaaliyet = ayCSV && ayCSV.net ? (ayCSV.toplam_maliyet * (currentNet / ayCSV.net) + ekKazanc) : 0;

        // Durum ve √∂deme tarihi
        const durum = dekontData ? '<span class="badge badge-success">√ñdendi</span>' : '<span class="badge badge-danger">√ñdenmedi</span>';
        const odemeTarihi = dekontData ? formatDate(dekontData.uploadDate) : '-';

        // Dekont alanƒ±
        const dekontHtml = dekontData
            ? `<button class="btn btn-info btn-sm" onclick="viewSalaryReceipt('${person.id}','${monthStr}')">G√∂r√ºnt√ºle</button>`
            : `<input type="file" onchange="uploadSalaryReceipt(event,'${person.id}','${monthStr}')">`;

        rows += `<tr>
            <td>${ayLabel}</td>
            <td>${currentNet ? formatCurrency(currentNet) : '-'}</td>
            <td>
                <input type="number" min="0" step="0.01" style="width:90px;" value="${ekKazanc}" onchange="saveSalaryExtra(this.value,'${person.id}','${monthStr}')">
            </td>
            <td>${toplamMaaliyet ? formatCurrency(toplamMaaliyet) : '-'}</td>
            <td>${durum}</td>
            <td>${dekontHtml}</td>
            <td>${odemeTarihi}</td>
        </tr>`;
    }

    // Tablo template
    const html = `
        <table>
            <thead>
                <tr>
                    <th>Ay</th>
                    <th>Net Maa≈ü</th>
                    <th>Ek Kazan√ß</th>
                    <th>Toplam Maliyet</th>
                    <th>Durum</th>
                    <th>Dekont</th>
                    <th>√ñdeme Tarihi</th>
                </tr>
            </thead>
            <tbody>${rows}</tbody>
        </table>
    `;
    document.getElementById('yearlySalaryTableSection').innerHTML = html;
}

// Ek kazancƒ± kaydet
function saveSalaryExtra(val, personId, monthStr) {
    localStorage.setItem(`salaryExtra_${personId}_${monthStr}`, val);
    renderYearlySalaryTable();
}

// Dekont y√ºkleme
function uploadSalaryReceipt(event, personId, monthStr) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = {
            base64: e.target.result,
            uploadDate: new Date().toISOString()
        };
        localStorage.setItem(`salaryReceipt_${personId}_${monthStr}`, JSON.stringify(data));
        renderYearlySalaryTable();
    };
    reader.readAsDataURL(file);
}

// Dekont g√∂r√ºnt√ºleme
function viewSalaryReceipt(personId, monthStr) {
    const key = `salaryReceipt_${personId}_${monthStr}`;
    const data = JSON.parse(localStorage.getItem(key));
    if (!data) return;
    const modalHtml = `
        <div id="salaryReceiptModal" class="modal active" style="display:flex;">
            <div class="modal-content" style="max-width:700px;">
                <div class="modal-header">
                    <h3>Dekont G√∂r√ºnt√ºle</h3>
                    <button class="close-modal" onclick="closeSalaryReceiptModal()">‚úñ</button>
                </div>
                <div style="padding:20px;text-align:center;">
                    <img src="${data.base64}" style="max-width:100%;border-radius:8px;">
                    <div style="margin-top:18px;color:#888;">Y√ºkleme tarihi: ${formatDate(data.uploadDate)}</div>
                </div>
            </div>
        </div>
    `;
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closeSalaryReceiptModal() {
    const modal = document.getElementById('salaryReceiptModal');
    if (modal) modal.remove();
}

// Sayfa y√ºklendiƒüinde kullanƒ±cƒ± kontrol√º
auth.onAuthStateChanged((user) => {
    if (user) {
        // Kullanƒ±cƒ± giri≈ü yapmƒ±≈ü
        document.getElementById('authModal').style.display = 'none';
        initializeApp(user);
    } else {
        // Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü
        document.getElementById('authModal').style.display = 'flex';
    }
});

// Kayƒ±t olma
async function registerUser() {
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    
    if (!name || !email || !password) {
        alert('‚ö†Ô∏è T√ºm alanlarƒ± doldurun!');
        return;
    }
    
    if (password.length < 6) {
        alert('‚ö†Ô∏è ≈ûifre en az 6 karakter olmalƒ±!');
        return;
    }
    
    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Kullanƒ±cƒ± profilini Firestore'a kaydet
        await db.collection('users').doc(user.uid).set({
            name: name,
            email: email,
            role: 'admin', // ƒ∞lk kullanƒ±cƒ± admin
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            companies: []
        });
        
        alert('‚úÖ Kayƒ±t ba≈üarƒ±lƒ±! Ho≈ü geldiniz.');
    } catch (error) {
        console.error('Kayƒ±t hatasƒ±:', error);
        if (error.code === 'auth/email-already-in-use') {
            alert('‚ö†Ô∏è Bu email zaten kullanƒ±mda!');
        } else {
            alert('‚ùå Kayƒ±t hatasƒ±: ' + error.message);
        }
    }
}

// Giri≈ü yapma
async function loginUser() {
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        alert('‚ö†Ô∏è Email ve ≈üifre gerekli!');
        return;
    }
    
    try {
        await auth.signInWithEmailAndPassword(email, password);
        alert('‚úÖ Giri≈ü ba≈üarƒ±lƒ±!');
    } catch (error) {
        console.error('Giri≈ü hatasƒ±:', error);
        if (error.code === 'auth/user-not-found') {
            alert('‚ö†Ô∏è Kullanƒ±cƒ± bulunamadƒ±!');
        } else if (error.code === 'auth/wrong-password') {
            alert('‚ö†Ô∏è Yanlƒ±≈ü ≈üifre!');
        } else {
            alert('‚ùå Giri≈ü hatasƒ±: ' + error.message);
        }
    }
}

// Google ile giri≈ü
async function loginWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });
    
    try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;
        
        // ƒ∞lk giri≈üse Firestore'a kaydet
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (!userDoc.exists) {
            await db.collection('users').doc(user.uid).set({
                name: user.displayName,
                email: user.email,
                role: 'admin',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                companies: []
            });
        }
        
        alert('‚úÖ Google giri≈üi ba≈üarƒ±lƒ±!');
    } catch (error) {
        console.error('Google giri≈ü hatasƒ±:', error);
        alert('‚ùå Google giri≈ü hatasƒ±: ' + error.message);
    }
}

// √áƒ±kƒ±≈ü yapma
async function logoutUser() {
    if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinize emin misiniz?')) {
        await auth.signOut();
        location.reload();
    }
}

// Form deƒüi≈ütirme
function toggleAuthMode() {
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const title = document.getElementById('authTitle');
    
    if (loginForm.style.display === 'none') {
        loginForm.style.display = 'block';
        registerForm.style.display = 'none';
        title.textContent = 'üîê Giri≈ü Yap';
    } else {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        title.textContent = 'üìù Kayƒ±t Ol';
    }
}

async function initializeApp(user) {
    if (!user) {
        console.error('User undefined!');
        return;
    }
    
    console.log('üîÑ Veriler Firebase\'den y√ºkleniyor...');
    
    try {
        // ‚úÖ 1. Kullanƒ±cƒ± profilini y√ºkle
        await loadUserData(user.uid);
        
        // ‚úÖ 2. Kullanƒ±cƒ±nƒ±n firmalarƒ±nƒ± y√ºkle
        await loadCompanies();
        
        // ‚úÖ 3. Aktif firma yoksa ve firma varsa, ilkini aktif yap
        if (!activeCompanyId && companies.length > 0) {
            activeCompanyId = companies[0].id;
        }
        
        // ‚úÖ 4. Aktif firma varsa diƒüer verileri y√ºkle
        if (activeCompanyId) {
            await Promise.all([
                loadAccounts(),
                loadInvoices(),
                loadPayments(),
                loadPurchases(),
                loadPersonnel()
            ]);
        }
        
        // ‚úÖ 5. UI'ƒ± g√ºncelle
        updateDashboard();
        populateSelects();
        populatePersonnelSelects();
        
        console.log('‚úÖ T√ºm veriler y√ºklendi!');
        
    } catch (error) {
        console.error('‚ùå Ba≈ülatma hatasƒ±:', error);
        throw error;
    }
}

// Kullanƒ±cƒ± verilerini y√ºkle
async function loadUserData(userId) {
    try {
        const userDoc = await db.collection('users').doc(userId).get();
        const userData = userDoc.data();
        
        if (!userData) {
            console.warn('Kullanƒ±cƒ± verisi bulunamadƒ±!');
            return;
        }
        
        console.log('Kullanƒ±cƒ± bilgileri:', userData);
        
        // Header'a kullanƒ±cƒ± adƒ± ekle
        const header = document.querySelector('.header');
        
        // √ñnceki kullanƒ±cƒ± info'yu temizle
        const existingUserInfo = header.querySelector('.user-info');
        if (existingUserInfo) {
            existingUserInfo.remove();
        }
        
        const userInfo = document.createElement('div');
        userInfo.className = 'user-info';
        userInfo.style.cssText = 'position:absolute; top:20px; right:20px; display:flex; align-items:center; gap:10px;';
        userInfo.innerHTML = `
            <span style="color:#6b7280;">üë§ ${userData.name}</span>
            <button class="btn btn-sm" onclick="logoutUser()">√áƒ±kƒ±≈ü</button>
        `;
        header.style.position = 'relative';
        header.appendChild(userInfo);
        
    } catch (error) {
        console.error('Kullanƒ±cƒ± verisi y√ºkleme hatasƒ±:', error);
    }
}

function handleInvoiceReceipt(input) {
    const file = input.files[0];
    if (!file) {
        currentInvoiceReceipt = null;
        document.getElementById('invoiceReceiptPreview').innerHTML = '';
        return;
    }
    
    // Boyut kontrol√º (5 MB)
    if (file.size > 5 * 1024 * 1024) {
        alert('‚ö†Ô∏è Dekont boyutu 5 MB\'dan k√º√ß√ºk olmalƒ±dƒ±r!');
        input.value = '';
        return;
    }
    
    currentInvoiceReceipt = file;
    
    const preview = document.getElementById('invoiceReceiptPreview');
    
    if (file.type.includes('image')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.innerHTML = `
                <div style="border: 2px solid var(--success); padding: 10px; border-radius: 8px; background: white;">
                    <img src="${e.target.result}" style="max-width: 200px; max-height: 200px; border-radius: 4px;">
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                        üìÑ ${file.name} (${formatFileSize(file.size)})
                    </p>
                    <button type="button" onclick="clearInvoiceReceipt()" class="btn btn-danger btn-sm" style="margin-top:5px;">‚úñ Kaldƒ±r</button>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    } else {
        preview.innerHTML = `
            <div style="border: 2px solid var(--success); padding: 15px; border-radius: 8px; background: white; text-align:center;">
                <div style="font-size: 3em;">üìÑ</div>
                <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #6b7280;">
                    ${file.name} (${formatFileSize(file.size)})
                </p>
                <button type="button" onclick="clearInvoiceReceipt()" class="btn btn-danger btn-sm" style="margin-top:5px;">‚úñ Kaldƒ±r</button>
            </div>
        `;
    }
}

function clearInvoiceReceipt() {
    currentInvoiceReceipt = null;
    document.getElementById('invoiceReceipt').value = '';
    document.getElementById('invoiceReceiptPreview').innerHTML = '';
}

function viewInvoiceReceipt(invoiceId) {
    const invoice = invoices.find(inv => inv.id === invoiceId);
    
    if (!invoice || !invoice.receiptUrl) {
        alert('‚ö†Ô∏è Bu faturaya ait dekont yok!');
        return;
    }
    
    const isPDF = invoice.receiptUrl.toLowerCase().includes('.pdf');
    
    const modalHtml = `
        <div id="invoiceReceiptModal" class="modal active" style="display:flex;">
            <div class="modal-content" style="max-width:900px;">
                <div class="modal-header">
                    <h3>üìé Fatura Dekont - ${invoice.invoiceNo}</h3>
                    <button class="close-modal" onclick="closeInvoiceReceiptModal()">‚úñ</button>
                </div>
                <div style="padding:20px; text-align:center;">
                    ${isPDF 
                        ? `<iframe src="${invoice.receiptUrl}" style="width:100%; height:600px; border:none; border-radius:8px;"></iframe>`
                        : `<img src="${invoice.receiptUrl}" style="max-width:100%; border-radius:8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">`
                    }
                    <div style="margin-top:20px;">
                        <a href="${invoice.receiptUrl}" target="_blank" class="btn btn-primary" download>
                            üì• ƒ∞ndir
                        </a>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = modalHtml;
    document.body.appendChild(tempDiv.firstElementChild);
}

function closeInvoiceReceiptModal() {
    const modal = document.getElementById('invoiceReceiptModal');
    if (modal) modal.remove();
}

function populateCompanySelects() {
    // Firma se√ßim dropdown'larƒ±nƒ± doldur
    const selects = document.querySelectorAll('select[id*="ompany"]');
    
    selects.forEach(select => {
        if (!select) return;
        
        // Mevcut se√ßimi sakla
        const currentValue = select.value;
        
        // Sadece firma se√ßim select'lerini g√ºncelle (account company deƒüil)
        if (select.id === 'accountCompany' || select.id === 'filterAccountCompany') {
            select.innerHTML = '<option value="">T√ºm Firmalar</option>';
            
            companies.forEach(company => {
                const option = new Option(company.name, company.id);
                select.add(option);
            });
            
            // Aktif firma varsa se√ß
            if (activeCompanyId) {
                select.value = activeCompanyId;
            } else if (currentValue) {
                select.value = currentValue;
            }
        }
    });
    
    // Aktif firma dropdown'ƒ±nƒ± g√ºncelle
    const activeCompanySelect = document.getElementById('activeCompanySelect');
    if (activeCompanySelect) {
        activeCompanySelect.innerHTML = '<option value="">Firma Se√ßiniz</option>';
        
        companies.forEach(company => {
            const option = new Option(company.name, company.id);
            activeCompanySelect.add(option);
        });
        
        if (activeCompanyId) {
            activeCompanySelect.value = activeCompanyId;
        }
    }
}

function closeCompanyModal() {
    const modal = document.getElementById('companyModal');
    if (modal) {
        modal.classList.remove('active');
    }
    
    // Formu temizle
    document.getElementById('companyForm').reset();
    document.getElementById('companyId').value = '';
    companyDocuments = [];
    
    // D√∂k√ºman √∂nizlemesini temizle
    const docContainer = document.getElementById('companyDocumentsContainer');
    if (docContainer) {
        docContainer.innerHTML = '';
    }
}

function renderCompanyDocuments() {
    const container = document.getElementById('companyDocumentsContainer');
    if (!container) return;
    
    container.innerHTML = '';
    
    if (companyDocuments.length === 0) {
        container.innerHTML = '<p style="color:#6b7280; text-align:center; padding:20px;">Hen√ºz d√∂k√ºman eklenmedi</p>';
        return;
    }
    
    companyDocuments.forEach((doc, index) => {
        const docDiv = document.createElement('div');
        docDiv.style.cssText = 'border:1px solid #e5e7eb; padding:10px; border-radius:5px; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;';
        docDiv.innerHTML = `
            <div>
                <strong>${doc.name}</strong>
                <div style="font-size:0.85em; color:#6b7280;">${formatFileSize(doc.fileSize)}</div>
            </div>
            <button type="button" class="btn btn-danger btn-sm" onclick="removeCompanyDocument(${index})">üóëÔ∏è</button>
        `;
        container.appendChild(docDiv);
    });
}

function removeCompanyDocument(index) {
    companyDocuments.splice(index, 1);
    renderCompanyDocuments();
}

function setupFormHandlers() {
    const companyForm = document.getElementById('companyForm');
    if (companyForm) {
        companyForm.addEventListener('submit', saveCompany);
    }
    
    const accountForm = document.getElementById('accountForm');
    if (accountForm) {
        accountForm.addEventListener('submit', saveAccount);
    }
    
    const invoiceForm = document.getElementById('invoiceForm');
    if (invoiceForm) {
        invoiceForm.addEventListener('submit', saveInvoice);
    }
    
    const paymentForm = document.getElementById('paymentForm');
    if (paymentForm) {
        paymentForm.addEventListener('submit', savePayment);
    }
    
    const purchaseForm = document.getElementById('purchaseForm');
    if (purchaseForm) {
        purchaseForm.addEventListener('submit', savePurchase);
    }
    
    const personnelForm = document.getElementById('personnelForm');
    if (personnelForm) {
        personnelForm.addEventListener('submit', savePersonnel);
    }
}

// Firebase Authentication State Listener
auth.onAuthStateChanged(async (user) => {
    if (user) {
        // ‚úÖ Kullanƒ±cƒ± giri≈ü yapmƒ±≈ü
        console.log('‚úÖ Kullanƒ±cƒ± giri≈ü yaptƒ±:', user.email);
        
        document.getElementById('authModal').style.display = 'none';
        
        try {
            // ‚úÖ T√ºm verileri Firebase'den y√ºkle
            await initializeApp(user);
        } catch (error) {
            console.error('Ba≈ülatma hatasƒ±:', error);
            alert('‚ùå Veri y√ºkleme hatasƒ±. L√ºtfen sayfayƒ± yenileyin.');
        }
        
    } else {
        // ‚ùå Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü
        console.log('‚ö†Ô∏è Kullanƒ±cƒ± giri≈ü yapmamƒ±≈ü');
        document.getElementById('authModal').style.display = 'flex';
        
        // ‚úÖ Global deƒüi≈ükenleri temizle
        companies = [];
        accounts = [];
        invoices = [];
        payments = [];
        purchases = [];
        personnel = [];
        activeCompanyId = null;
    }
});

// ========================================
// EVENT LISTENERS
// ========================================

document.getElementById('personnelForm').addEventListener('submit', savePersonnel);
document.getElementById('leaveRequestForm').addEventListener('submit', saveLeaveRequest);

// Inputlarda deƒüi≈üiklik olunca otomatik hesapla
document.getElementById('salaryNetInput').addEventListener('input', updateSalaryTotalCost);
document.getElementById('salaryExtraInput').addEventListener('input', updateSalaryTotalCost);
document.getElementById('salaryMonth').addEventListener('change', updateSalaryTotalCost);

// Sayfa y√ºklendiƒüinde bu ayƒ± otomatik se√ß
// Sayfa y√ºklendiƒüinde
document.addEventListener('DOMContentLoaded', function() {
    // ‚úÖ Sadece UI hazƒ±rlama i≈üleri
    // Veri y√ºkleme tamamen Firebase auth'dan sonra yapƒ±lacak
    
    // Tarih inputlarƒ±nƒ± bug√ºne ayarla
    const today = new Date();
    
    const invoiceDateInput = document.getElementById('invoiceDate');
    if (invoiceDateInput) {
        invoiceDateInput.valueAsDate = today;
    }
    
    const paymentDateInput = document.getElementById('paymentDate');
    if (paymentDateInput) {
        paymentDateInput.valueAsDate = today;
    }
    
    const purchaseDateInput = document.getElementById('purchaseDate');
    if (purchaseDateInput) {
        purchaseDateInput.valueAsDate = today;
    }
    
    // ‚úÖ Maa≈ü ayƒ± otomatik se√ß
    const currentMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
    const salaryMonthInput = document.getElementById('salaryMonth');
    if (salaryMonthInput) {
        salaryMonthInput.value = currentMonth;
    }
    
    // ‚úÖ Form handlers'ƒ± kur
    setupFormHandlers();
    
    console.log('‚úÖ UI hazƒ±rlandƒ±, Firebase auth bekleniyor...');
});

</script>
</body>
</html>